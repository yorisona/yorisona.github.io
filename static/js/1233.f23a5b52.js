"use strict";(self["webpackChunkgoumee_star_temp"]=self["webpackChunkgoumee_star_temp"]||[]).push([[1233],{64598:function(e,t,a){a.r(t),a.d(t,{default:function(){return ct}});var i=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"finance-invoice-page"},[a("tg-block",{staticClass:"flex-none",staticStyle:{height:"48px"},attrs:{bodyStyle:{padding:"0"}}},[a("tg-tabs",{attrs:{tabs:e.tabs,bottom:""},on:{change:e.onTabChange},model:{value:e.checkedTab,callback:function(t){e.checkedTab=t},expression:"checkedTab"}})],1),a(e.tabPane,{tag:"component",staticClass:"flex-auto"})],1)},n=[],o=a(97434),l=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"finance-invoice flex-auto"},[a("tg-card",{staticClass:"flex-none",attrs:{padding:[18,24,0,18]},on:{"rect:update":e.onTopCardRectUpdate}},[a("el-form",{attrs:{model:e.QueryForm,size:"small","label-width":"70px"}},[a("div",{staticClass:"filter-form-div"},[a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"购买方："}},[a("el-input",{attrs:{placeholder:"请输入购买方"},model:{value:e.QueryForm.buyer_name,callback:function(t){e.$set(e.QueryForm,"buyer_name",t)},expression:"QueryForm.buyer_name"}})],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"销售方："}},[a("el-input",{attrs:{placeholder:"请输入销售方"},model:{value:e.QueryForm.seller_name,callback:function(t){e.$set(e.QueryForm,"seller_name",t)},expression:"QueryForm.seller_name"}})],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"发票号码："}},[a("el-input",{attrs:{placeholder:"请输入关键字"},model:{value:e.QueryForm.invoice_number,callback:function(t){e.$set(e.QueryForm,"invoice_number",t)},expression:"QueryForm.invoice_number"}})],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"发票日期："}},[a("el-date-picker",{attrs:{type:"month",placeholder:"请选择日期"},model:{value:e.QueryForm.invoice_month,callback:function(t){e.$set(e.QueryForm,"invoice_month",t)},expression:"QueryForm.invoice_month"}})],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"发票类型："}},[a("el-select",{model:{value:e.QueryForm.invoice_type,callback:function(t){e.$set(e.QueryForm,"invoice_type",t)},expression:"QueryForm.invoice_type"}},[a("el-option",{attrs:{label:"全部",value:""}}),a("el-option",{attrs:{label:"销售发票",value:"1"}}),a("el-option",{attrs:{label:"采购发票",value:"2"}})],1)],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"发票状态："}},[a("el-select",{model:{value:e.QueryForm.invoice_status,callback:function(t){e.$set(e.QueryForm,"invoice_status",t)},expression:"QueryForm.invoice_status"}},[a("el-option",{attrs:{label:"全部",value:""}}),a("el-option",{attrs:{label:"正常",value:"1"}}),a("el-option",{attrs:{label:"作废",value:"2"}}),a("el-option",{attrs:{label:"作废审批",value:"3"}}),a("el-option",{attrs:{label:"红冲审批",value:"4"}}),a("el-option",{attrs:{label:"红冲",value:"5"}})],1)],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"验真状态："}},[a("el-select",{model:{value:e.QueryForm.is_real,callback:function(t){e.$set(e.QueryForm,"is_real",t)},expression:"QueryForm.is_real"}},[a("el-option",{attrs:{label:"全部",value:""}}),a("el-option",{attrs:{label:"已验真",value:1}}),a("el-option",{attrs:{label:"未验真",value:0}}),a("el-option",{attrs:{label:"验真失败",value:-1}})],1)],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"核销状态："}},[a("el-select",{model:{value:e.QueryForm.write_off_status,callback:function(t){e.$set(e.QueryForm,"write_off_status",t)},expression:"QueryForm.write_off_status"}},[a("el-option",{attrs:{label:"全部",value:""}}),a("el-option",{attrs:{label:"已核销",value:"2"}}),a("el-option",{attrs:{label:"未核销",value:"0"}}),a("el-option",{attrs:{label:"部分核销",value:"1"}})],1)],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"业务类型："}},[a("el-select",{model:{value:e.QueryForm.business_type,callback:function(t){e.$set(e.QueryForm,"business_type",t)},expression:"QueryForm.business_type"}},[a("el-option",{attrs:{label:"全部",value:""}}),e._l(e.BusinessTypeOptions,(function(e,t){return a("el-option",{key:t,attrs:{label:e.label,value:e.value}})}))],2)],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"所属部门："}},[a("el-popover",{attrs:{placement:"bottom-start",width:"304",trigger:"click","popper-class":"user-serch-popper"},model:{value:e.treeData.show,callback:function(t){e.$set(e.treeData,"show",t)},expression:"treeData.show"}},[a("div",{staticClass:"repain-select250",attrs:{slot:"reference"},slot:"reference"},[a("el-input",{staticStyle:{color:"#999"},attrs:{placeholder:"请选择部门",readonly:"",value:e.treeData.input}},[a("i",{staticClass:"select-icon el-icon-arrow-down",attrs:{slot:"suffix"},slot:"suffix"})])],1),a("el-tree",{ref:"treeRef",attrs:{"show-checkbox":!0,"check-strictly":!0,data:e.treeData.data,"node-key":"department_id",props:{label:"name",children:"sons"}},on:{check:e.treeData.check}})],1)],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"所属项目："}},[a("el-input",{attrs:{placeholder:"请输入项目"},model:{value:e.QueryForm.project_name,callback:function(t){e.$set(e.QueryForm,"project_name",t)},expression:"QueryForm.project_name"}})],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"结算单号："}},[a("el-input",{attrs:{placeholder:"请输入结算单编号"},model:{value:e.QueryForm.settlement_uid,callback:function(t){e.$set(e.QueryForm,"settlement_uid",t)},expression:"QueryForm.settlement_uid"}})],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{label:"结算周期："}},[a("el-date-picker",{attrs:{type:"month",placeholder:"请选择日期"},model:{value:e.QueryForm.settlement_month,callback:function(t){e.$set(e.QueryForm,"settlement_month",t)},expression:"QueryForm.settlement_month"}})],1)],1),a("div",{staticClass:"filter-form-item"},[a("el-form-item",{attrs:{"label-width":"0"}},[a("div",{staticClass:"filter-form-item-btn"},[a("tg-button",{attrs:{type:"primary"},on:{click:e.reload}},[e._v("查询")]),a("tg-button",{staticClass:"mgl-12",on:{click:e.reset}},[e._v("重置")])],1)])],1)])])],1),a("tg-card",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"mgt-12",staticStyle:{"flex-grow":"1"},attrs:{padding:[0,18,0,18]},on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("div",{staticClass:"mgt-12",staticStyle:{position:"relative",height:"21px"}},[a("div",{staticStyle:{"line-height":"21px",left:"0px",top:"-6px","margin-top":"0px",height:"20px",width:"100%",position:"absolute",display:"grid","grid-template-columns":"auto 1fr auto auto","align-items":"center"}},[a("tg-button",{attrs:{size:"small",disabled:e.isDisabled},on:{click:e.exportData}},[e._v("导出")]),a("span"),a("tg-icon",{staticStyle:{"margin-right":"8px","font-size":"16px"},attrs:{name:"ico-weibiaoti-11"}}),a("span",{staticStyle:{color:"rgb(153, 153, 153)","font-size":"13px"}},[e._v("开票日期为当月的发票如需作废，请走作废流程；开票日期早于当月的发票如需作废，请走开红票流程")])],1)]),a("el-table",e._b({staticClass:"mgt-12",attrs:{stripe:"",border:"",data:e.DataList},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无记录"}})]},proxy:!0}])},"el-table",e.tableProps,!1),e._l(e.columns,(function(t,i){return a("el-table-column",e._b({key:i},"el-table-column",t,!1))})),1),e.DataList.length?a("el-pagination",{staticStyle:{margin:"8px 0"},attrs:{"current-page":e.QueryForm.page_num,"page-sizes":[10,20,50,100],"page-size":e.QueryForm.num,layout:"total, prev, pager, next, sizes, jumper",total:e.total_count},on:{"update:currentPage":function(t){return e.$set(e.QueryForm,"page_num",t)},"update:current-page":function(t){return e.$set(e.QueryForm,"page_num",t)},"current-change":e.handleCurrentChange,"size-change":e.handlePageSizeChange}}):e._e()],1),a("invoice-reverse-dialog",{attrs:{visible:e.invoiceReverseDialogVisible,invoice:e.currentInvoice},on:{"update:visible":function(t){e.invoiceReverseDialogVisible=t},success:e.reverseSuccess}}),a("tg-mask-loading",{attrs:{visible:e.uploadLoading,content:"正在上传发票，请稍候..."}}),e.showViewer?a("el-image-viewer",{attrs:{cctv:"sdfsdfsdf","on-close":e.closeViewer,"url-list":e.ImageUrlList}}):e._e(),a("invoice-void-dialog",{ref:"invoiceVoidDialogRef",attrs:{invoice:e.currentInvoice},on:{success:e.reload}}),a("invoice-red-dialog",{ref:"invoiceRedDialogRef",attrs:{invoice:e.currentInvoice},on:{success:e.reload}})],1)},s=[],r=a(82741),c=a(87843),u=a(61282),d=a(85937),m=a.n(d),p=a(74750),v=a(8136),_=a(67910);const f=(0,p.LP)(),h=(e,t)=>{const a=(e,t)=>{const a=(0,u.SJ)(new(m())(e.total_amount??0));return t?a:(0,o.h)("span",{class:5===e.invoice_status?"red":""},[a])},i=(e,t)=>{const a=(0,u.SJ)(new(m())(e.not_write_off_amount??0));return t?a:(0,o.h)("span",{},[a])},n=(e,t)=>{const a=e.buyer_name||"--",{is_folded:i,folded_text:n}=(0,u.zb)(a,16);return t||!i?n:(0,o.h)("el-popover",{props:{placement:"right",trigger:"hover",content:a}},[(0,o.h)("span",{slot:"reference"},[n])])},l=(e,t)=>{const a=e.seller_name||"--",{is_folded:i,folded_text:n}=(0,u.zb)(a,16);return t||!i?n:(0,o.h)("el-popover",{props:{placement:"right",trigger:"hover",content:a}},[(0,o.h)("span",{slot:"reference"},[n])])},s=(e,t)=>{const a=(0,u.SJ)(new(m())(e.tax_amount));return t?a:(0,o.h)("span",{class:5===e.invoice_status?"red":""},[a])},r=(e,t)=>{const a=(0,u.SJ)(new(m())(e.tax_excluded_amount));return t?a:(0,o.h)("span",{class:5===e.invoice_status?"red":""},[a])},d=(0,o.computed)((()=>({label:"购买方",minWidth:(0,_.zY)(e,"购买方",n).value+0,formatter:e=>n(e,!1)}))),p=(0,o.computed)((()=>({label:"销售方",minWidth:(0,_.zY)(e,"销售方",l).value+0,formatter:e=>l(e,!1)}))),h=(0,o.computed)((()=>({label:"发票号码",minWidth:90,align:"center",formatter:e=>(0,o.h)("span",{class:5===e.invoice_status?"red":""},e.invoice_number)}))),g=(0,o.computed)((()=>({label:"发票日期",property:"invoice_date",minWidth:90,align:"center",formatter:e=>(0,v.xF)(1e3*e.invoice_date,"YYYY.MM.DD")}))),y=(0,o.computed)((()=>({label:"开票金额 (元)",property:"total_amount",align:"right",minWidth:(0,_.zY)(e,"开票金额 (元)",a).value,formatter:e=>a(e,!1)}))),b=(0,o.computed)((()=>({label:"未核销金额 (元)",property:"not_write_off_amount",align:"right",minWidth:(0,_.zY)(e,"未核销金额 (元)",i).value,formatter:e=>i(e,!1)}))),w=(0,o.computed)((()=>({label:"税率",property:"tax_rate",minWidth:55,align:"right",formatter:e=>e.tax_rate+"%"}))),x=(0,o.computed)((()=>({label:"税额 (元)",property:"tax_amount",align:"right",minWidth:(0,_.zY)(e,"税额 (元)",s).value,formatter:e=>s(e,!1)}))),k=(0,o.computed)((()=>({label:"不含税金额 (元)",property:"tax_excluded_amount",align:"right",minWidth:(0,_.zY)(e,"不含税金额 (元)",r).value,formatter:e=>r(e,!1)}))),C=(0,o.computed)((()=>({label:"发票类型",property:"invoice_type",align:"center",minWidth:80,formatter:e=>1===e.invoice_type?"销售发票":"采购发票"}))),D=(0,o.computed)((()=>({label:"验真状态",property:"is_verified",align:"center",minWidth:120,formatter:e=>{const t=(0,o.h)("el-popover",{props:{trigger:"hover",placement:"bottom-end",offset:30,popperClass:"finance-invoice-status-popper",openDelay:300}},[(0,o.h)("tg-icon",{style:"font-size: 16px",props:{name:"ico-a-yulaneye2x"},slot:"reference"}),(0,o.h)("div",{},[e.verified_desc||""])]),a=new Map([[0,"#FF955F"],[1,"#33BA5D"],[-1,"#F04B4B"]]).get(Number(e.is_verified)),i="padding: 0 5px; display: inline-block; color:"+a;return(0,o.h)("div",{style:"display: inline-block"},[(0,o.h)("div",{style:i},[1===e.is_verified?"已验真":0===e.is_verified?"未验真":"验真失败"]),-1===e.is_verified&&e.verified_desc?t:""])}}))),$=(0,o.computed)((()=>({label:"发票状态",property:"invoice_status",align:"center",minWidth:80,formatter:e=>{let t="--";switch(e.invoice_status){case 1:t="正常";break;case 2:t="作废";break;case 3:t="作废审批";break;case 4:t="红冲审批";break;case 5:t="红冲";break}return t}}))),F=(0,o.computed)((()=>({label:"核销状态",property:"write_off_status",align:"center",minWidth:124,formatter:e=>{const t=c.vC.get(e.write_off_status),a=new Map([[0,"#F04B4B"],[1,"#FF955F"],[2,"#33BA5D"]]).get(e.write_off_status),i=`display: inline-block; border-radius: 50%;margin-top:7px; width: 6px;height: 6px;background: ${a};`,n=[(0,o.h)("div",{class:"finance-invoice-popper-header"},[(0,o.h)("div",{style:"width:169px"},"结算单号"),(0,o.h)("div",{style:"width:304px"},"所属项目"),(0,o.h)("div",{style:"width:159px; border-right: 1px solid #e3e8ec;"},"核销发票金额 (元)")])];e.write_off_infos.forEach((e=>{const t=(0,o.h)("div",{class:"finance-invoice-popper-row"},[(0,o.h)("div",{style:"width:169px"},e.settlement_uid),(0,o.h)("div",{style:"width:304px",class:"line-clamp-1"},e.project_name),(0,o.h)("div",{style:"width:159px; border-right: 1px solid #e3e8ec;text-align:right"},""+e.write_off_amount)]);n.push(t)})),0===e.write_off_infos.length&&n.push((0,o.h)("div",{class:"finance-invoice-popper-row",style:"border-right: 1px solid #e3e8ec"},[(0,o.h)("div",{style:"width: 493px;"},["暂无数据"])]));const l=(0,o.h)("div",{},n),s=0===e.write_off_infos.length?"":(0,o.h)("el-popover",{props:{trigger:"hover",placement:"bottom-end",offset:30,popperClass:"finance-invoice-status-popper",openDelay:300}},[(0,o.h)("tg-icon",{style:"font-size: 16px",props:{name:"ico-a-yulaneye2x"},slot:"reference"}),(0,o.h)("div",{},[l])]);return(0,o.h)("div",{style:"display: flex;justify-content: center;"},[(0,o.h)("div",{style:i}),(0,o.h)("div",{style:"padding: 0 5px; display: inline-block;width:60px;text-align:left"},[t]),s||(0,o.h)("div",{style:"padding: 0 5px; display: inline-block;width:16px;"})])}}))),S=(0,o.computed)((()=>({label:"发票",property:"invoice_pic_url",minWidth:54,align:"center",formatter:e=>{const a=`${e.invoice_pic_url}?Authorization=${f}`;return(0,o.h)("tg-icon",{class:"invoiceImageView",on:{click:()=>{const e=/\.pdf\?.+$|\.pdf\??$/.test(a);e?window.open(a):t([a])}},props:{name:"ico-fapiao"}})}})));return{invoice_number_column:h,invoice_date_column:g,invoice_not_amount_column:b,invoice_amount_column:y,tax_rate_column:w,buyer_name_column:d,seller_name_column:p,tax_amount_column:x,tax_excluded_amount_column:k,invoice_type_column:C,invoice_real_type_column:D,invoice_status_column:$,writeoff_status_column:F,invoice_picture_column:S}};var g=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-invoice-reverse-dislog"},[a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",attrs:{title:"发票核销",visible:e.visible,width:"1294px",height:"685px","destroy-on-close":"","close-on-click-modal":!1},on:{close:e.cancel}},[a("div",{staticClass:"tg-invoice-reverse-content"},[a("div",{staticClass:"invoice-amount-container"},[a("div",{staticClass:"amount-item"},[a("div",[e._v("发票金额：")]),a("div",[e._v(e._s(e.decimal2String(e.default_invoice?e.default_invoice.total_amount:"0")))])]),a("div",{staticClass:"amount-item"},[a("div",[e._v("未核销金额：")]),a("div",[e._v(e._s(e.decimal2String(e.not_reverse_amount)))])]),a("div",{staticClass:"amount-item"},[a("div",[e._v("发票类型：")]),a("div",[e._v(e._s(e.invoce_type))])])]),a("div",{staticClass:"amount-project"},[a("div",[a("el-select",{staticClass:"mgr-12",staticStyle:{width:"150px"},attrs:{slot:"prepend",placeholder:"选择项目类型",size:"small"},on:{change:e.projectTypeChanged},slot:"prepend",model:{value:e.project_type,callback:function(t){e.project_type=t},expression:"project_type"}},e._l(e.ProjectTypes,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1),a("el-select",{staticStyle:{width:"200px"},attrs:{slot:"prepend",placeholder:"请输入并选择项目",size:"small",filterable:"",remote:"",clearable:"","reserve-keyword":"","remote-method":e.queryProjectUIDList,loading:e.project_query_loading},on:{change:e.projectUidChange},slot:"prepend",model:{value:e.project_uid,callback:function(t){e.project_uid=t},expression:"project_uid"}},[e._l(e.project_uid_list,(function(e){return a("el-option",{key:e.project_uid,attrs:{label:e.project_name,value:e.project_uid}})})),e.project_type?e._e():a("template",{slot:"empty"},[a("div",{staticStyle:{padding:"9px 15px",color:"#a4b2c2"}},[e._v("请先选择项目类型")])])],2)],1)]),a("div",{staticClass:"settlement-list-container"},[a("el-table",{attrs:{height:"200px",stripe:"",border:"",data:e.settlement_list,"header-cell-style":{fontWeight:"500",lineHeight:"17px"},"cell-style":{paddingTop:"11px",paddingBottom:"11px"},"row-class-name":e.settlement_list_class_name},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无数据"}})]},proxy:!0}])},e._l(e.settlementColumns,(function(t,i){return a("el-table-column",e._b({key:i},"el-table-column",t,!1))})),1)],1),a("div",{staticClass:"invoice-reverse-list-container"},[a("div",{staticClass:"list-container-title"},[e._v("发票核销列表：")]),a("el-table",{attrs:{height:"200px",border:"",stripe:"",data:e.write_off_list,"header-cell-style":{fontWeight:"500",lineHeight:"17px"},"cell-style":{paddingTop:"4px",paddingBottom:"4px"}},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无数据"}})]},proxy:!0}])},[e._l(e.invoiceReverseColumns,(function(t,i){return a("el-table-column",e._b({key:i},"el-table-column",t,!1))})),a("el-table-column",{attrs:{label:"核销发票金额 (元)","min-width":"147"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-input",{staticClass:"reverse-amount",attrs:{size:"small",value:e.write_off_list[t.$index].typein_write_off_amount},on:{input:function(a){return e.writeOffAmountInput(a,t.$index)}}})]}}])}),a("el-table-column",{attrs:{label:"操作","min-width":"52",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("tg-icon",{staticClass:"invoice-reverse-delete",attrs:{name:"ico-btn-delete"},on:{click:function(){return e.invoice_reverse_delete_action(t.$index)}}})]}}])})],2)],1)]),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("tg-button",{staticClass:"mgr-18",attrs:{size:"small"},on:{click:e.cancel}},[e._v("取 消")]),a("tg-button",{attrs:{type:"primary",size:"small"},on:{click:e.sure}},[e._v("确 定")])],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在核销发票，请稍候..."}})],1)},y=[],b=a(76771),w=a(28348),x=a(6933),k=a.n(x),C=a(41572),D=a(67578),$=(0,o.defineComponent)({props:{visible:{type:Boolean},invoice:{type:Object}},setup(e,t){const a=(0,o.ref)(!1),i=(0,o.ref)([]),n=(0,o.ref)(void 0),l=(0,o.ref)(void 0),s=(0,o.computed)((()=>e.invoice)),d=(0,o.computed)((()=>new(m())(s.value?.total_amount??0).sub(new(m())(s.value?.write_off_amount??0)))),p=(0,o.computed)((()=>1===s.value?.invoice_type?"销售发票":"采购发票")),v=(0,o.ref)(void 0),_=(0,o.ref)([]),f=(0,o.ref)(!1),h=(0,o.ref)([]),g=(0,o.computed)((()=>{const t=e.invoice?.total_amount?e.invoice?.total_amount:0;return t<0})),y=(0,o.computed)((()=>[{label:"结算编号",minWidth:160,formatter:e=>e.settlement_uid},{label:"结算周期",minWidth:197,formatter:e=>[e.start_date,e.end_date].map((e=>k()(1e3*e).format("YYYY.MM.DD"))).join(" ~ ")},{label:"结算公司",minWidth:221,formatter:e=>e.company_name?e.company_name:"--"},{label:"含税结算金额 (元)",minWidth:140,align:"right",formatter:e=>$.decimal2String(e.tax_included_amount,"")},{label:"税率",minWidth:55,align:"center",formatter:e=>`${e.tax_rate??0}%`},{label:"税额 (元)",minWidth:128,align:"right",formatter:e=>$.decimal2String(e.tax_amount,"")},{label:"不含税金额 (元)",minWidth:138,align:"right",formatter:e=>$.decimal2String(e.tax_excluded_amount,"")},{label:"未开票金额 (元)",minWidth:138,align:"right",formatter:e=>$.decimal2String($.not_write_off_amount(e),"")},{label:"操作",minWidth:62,align:"center",formatter:e=>(0,o.h)("tg-button",{props:{type:"link"},class:"settlement-add",on:{click:()=>{$.settlement_add_action(e)}}},["添加"])}])),x=(0,o.computed)((()=>[{label:"结算编号",minWidth:160,formatter:e=>e.settlement_uid},{label:"结算公司",minWidth:220,formatter:e=>e.company_name?e.company_name:"--"},{label:"结算金额 (元)",minWidth:134,align:"right",formatter:e=>$.decimal2String(e.tax_included_amount,"")},{label:"税率",minWidth:55,align:"center",formatter:e=>`${e.tax_rate??0}%`},{label:"税额 (元)",minWidth:125,align:"right",formatter:e=>$.decimal2String(e.tax_amount,"")},{label:"不含税金额 (元)",minWidth:125,align:"right",formatter:e=>$.decimal2String(e.tax_excluded_amount,"")},{label:g.value?"已开票金额 (元)":"未开票金额 (元)",minWidth:125,align:"right",formatter:e=>$.decimal2String($.not_write_off_amount(e),"")}])),$={cancel:()=>{t.emit("update:visible",!1)},sure:async()=>{if(0!==i.value.length)if($.is_all_typein())if($.is_typein_zero())t.root.$message.warning("输入的核销发票金额不能为0");else if($.validateAllWriteOffAmount()){const e=await(0,r.I)(t,{title:"确认发票核销吗？",content:"发票一旦核销后不可以进行修改，是否确定核销？",confirmText:"确认",cancelText:"取消"});e&&$.write_off_amount_request()}else g?t.root.$message.error("所有结算单的核销发票金额合计小于等于发票未核销金额"):t.root.$message.error("所有结算单的核销发票金额合计不能小于发票未核销金额");else t.root.$message.warning("请先完善所有核销发票金额的填写");else t.root.$message.warning("请添加需核销的结算编号")},is_all_typein:()=>{const e=i.value.find((e=>void 0===e.typein_write_off_amount||null===e.typein_write_off_amount||""===e.typein_write_off_amount));return!e},is_typein_zero:()=>{const e=i.value.find((e=>"0"===e.typein_write_off_amount||0===e.typein_write_off_amount));return!!e},settlement_add_action:e=>{const t=i.value.find((t=>t.settlement_uid===e.settlement_uid));t||i.value.push({...e,typein_write_off_amount:void 0})},invoice_reverse_delete_action:e=>{i.value.splice(e,1)},decimal2String:(e,t="￥")=>`${t}${(0,u.SJ)(new(m())(e??"0"))}`,queryProjectUIDList:async e=>{if(n.value)if(e){f.value=!0;const a=await(0,b.DG)({project_type:n.value??"",project_uid:void 0,project_name:e});f.value=!1,a.data.success?_.value=a.data.data:t.root.$message.error(a.data.message??"查询失败，请稍后重试")}else _.value=[]},querySettlementList:async a=>{const i=await(0,b.W_)(1===e.invoice?.invoice_type?"income":"cost",{num:1e3,page_num:1,settlement_kind:s.value?.invoice_type??0,project_type:n.value??"",search_type:"2",search_value:a??"",is_confirmed:1,no_confirmed_reverse:1,invoice_write_off_type:g.value?2:1,is_tmp:0,is_estimate:0});i.data.success?(h.value=i.data.data.data.filter((e=>(!e.reverse_id||e.reverse_id&&e.reverse_status!==D.h0.confirmed)&&!e.reversed_id&&!e.is_tmp&&!e.is_estimate&&e.status===w.ne.confirmed&&!$.not_write_off_amount(e).equals(new(m())(0)))),t.root.$message.success(i.data.message??"核销结算成功")):t.root.$message.error(i.data.message??"查询失败，请稍后重试")},not_write_off_amount:e=>g.value?new(m())(e.write_off_amount):new(m())(e.tax_included_amount??0).sub(new(m())(e.write_off_amount??0)),projectUidChange:e=>{e?$.querySettlementList(e):h.value=[]},projectTypeChanged:()=>{v.value&&(v.value=void 0),_.value=[],h.value=[]},writeOffAmountInput:(e,t)=>{if(g.value){const a=(/^-(0|[1-9]\d{0,11})?(?:\.\d{0,2})?/u.exec(e.replace(C.Pj,""))??[""])[0],n=i.value[t],o=new(m())(a?"-"===a?"0":a:0),l=new(m())(n.write_off_amount?n.write_off_amount:0);Math.abs(o.toNumber())<=$.not_write_off_amount(n).toNumber()&&o.lessThanOrEqualTo(l)&&(n.typein_write_off_amount=a)}else{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(e.replace(C.Pj,""))??[""])[0],n=new(m())(a||0),o=i.value[t],l=$.not_write_off_amount(o);n.lessThanOrEqualTo(d.value)&&n.lessThanOrEqualTo(l)&&(o.typein_write_off_amount=a)}},validateAllWriteOffAmount:()=>{let e=new(m())(0);return i.value.forEach((t=>{e=new(m())(t.typein_write_off_amount?t.typein_write_off_amount:0).add(e)})),g.value?e.greaterThanOrEqualTo(d.value):e.lessThanOrEqualTo(d.value)},write_off_amount_request:async()=>{if(!e.invoice?.id)return;const n=i.value.map((e=>({settlement_id:e.id,write_off_amount:e.typein_write_off_amount})));a.value=!0;const o=await(0,b.PQ)(e.invoice?.id,n);a.value=!1,o.data.success?(t.root.$message.success(o.data.message??"核销发票成功"),t.emit("success")):t.root.$message.error(o.data.message??"核销失败，请稍后重试")},settlement_list_class_name:({row:e,rowIndex:t})=>{const a=h.value[t],n=i.value.find((e=>e.id===a.id));return n?"table-row-hidden":"tbale-row-show"}};return(0,o.watch)([()=>e.visible],(([e])=>{e&&(i.value=[],h.value=[],_.value=[],n.value=void 0,v.value=void 0)})),{saveLoading:a,write_off_list:i,select_project:l,project_type:n,settlement_list:h,settlementColumns:y,invoiceReverseColumns:x,...$,default_invoice:s,not_reverse_amount:d,invoce_type:p,ProjectTypes:c.sX,project_uid:v,project_uid_list:_,project_query_loading:f}}}),F=$,S=a(1001),I=(0,S.Z)(F,g,y,!1,null,null,null),z=I.exports,L=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"invoice-void-dialog"},[a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",attrs:{title:"发票作废申请",visible:e.visible,width:"624px","destroy-on-close":"","close-on-click-modal":!1},on:{close:e.cancel}},[e.visible?a("invoice-base",{attrs:{info:e.invoice}}):e._e(),a("div",{staticClass:"reason-box"},[a("el-form",{ref:"formRef",attrs:{model:e.form,size:"small","label-position":"top"}},[a("el-form-item",{attrs:{label:"发票作废原因：",prop:"reason",rules:{required:!0,message:"请输入作废原因",trigger:"blur"}}},[a("el-input",{attrs:{type:"textarea",rows:4,placeholder:"请输入原因"},model:{value:e.form.reason,callback:function(t){e.$set(e.form,"reason",t)},expression:"form.reason"}})],1)],1)],1),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("tg-button",{staticClass:"mgr-18",attrs:{size:"small"},on:{click:e.cancel}},[e._v("取 消")]),a("tg-button",{attrs:{type:"primary",size:"small"},on:{click:e.submit}},[e._v("提 交")])],1)],1),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})],1)},R=[],T=a(63546),j=a(64236),M=(0,o.defineComponent)({props:{invoice:{type:Object,default:()=>({})}},components:{InvoiceBase:T.Z},setup(e,t){const a=(0,o.ref)(!1),i=(0,o.ref)(!1),n=(0,o.ref)(null),l=(0,o.ref)(null),s=(0,o.reactive)({reason:""});function c(){s.reason=""}(0,o.watch)(i,(t=>{t&&(l.value=e.invoice.id)}));const u=()=>{i.value=!0};function d(){i.value=!1,c()}async function m(){const e=await new Promise((e=>n.value?.validate((t=>e(t)))));if(!e)return;const o=await(0,r.I)(t,{title:"确认发票作废吗？",content:"提交后将在飞书中进行审核",confirmText:"确认",cancelText:"取消"});if(o){a.value=!0;const[{data:e}]=await(0,j.Dc)(500,(0,b.lj)({id:l.value,remark:s.reason}));a.value=!1,e.success?(i.value=!1,t.root.$message.success("作废成功"),t.emit("success"),c()):t.root.$message({type:"warning",message:e.message??"作废失败，稍后重试",duration:2e3,showClose:!0})}}return{visible:i,show:u,saveLoading:a,form:s,formRef:n,cancel:d,submit:m}}}),W=M,E=(0,S.Z)(W,L,R,!1,null,null,null),q=E.exports,A=a(79261),P=a(21757),O=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("transition",{attrs:{name:"viewer-fade"}},[a("div",{ref:"el-image-viewer__wrapper",staticClass:"el-image-viewer__wrapper",style:{"z-index":e.viewerZIndex},attrs:{tabindex:"-1"}},[a("div",{staticClass:"el-image-viewer__mask",on:{click:function(t){return t.target!==t.currentTarget?null:e.handleMaskClick.apply(null,arguments)}}}),a("span",{staticClass:"el-image-viewer__btn el-image-viewer__close",on:{click:e.hide}},[a("i",{staticClass:"el-icon-close"})]),e.isSingle?e._e():[a("span",{staticClass:"el-image-viewer__btn el-image-viewer__prev",class:{"is-disabled":!e.infinite&&e.isFirst},on:{click:e.prev}},[a("i",{staticClass:"el-icon-arrow-left"})]),a("span",{staticClass:"el-image-viewer__btn el-image-viewer__next",class:{"is-disabled":!e.infinite&&e.isLast},on:{click:e.next}},[a("i",{staticClass:"el-icon-arrow-right"})])],a("div",{staticClass:"el-image-viewer__btn el-image-viewer__actions"},[a("div",{staticClass:"el-image-viewer__actions__inner"},[a("i",{staticClass:"el-icon-zoom-out",on:{click:function(t){return e.handleActions("zoomOut")}}}),a("i",{staticClass:"el-icon-zoom-in",on:{click:function(t){return e.handleActions("zoomIn")}}}),a("i",{staticClass:"el-image-viewer__actions__divider"}),a("i",{class:e.mode.icon,on:{click:e.toggleMode}}),a("i",{staticClass:"el-image-viewer__actions__divider"}),a("i",{staticClass:"el-icon-refresh-left",on:{click:function(t){return e.handleActions("anticlocelise")}}}),a("i",{staticClass:"el-icon-refresh-right",on:{click:function(t){return e.handleActions("clocelise")}}})])]),a("div",{staticClass:"el-image-viewer__canvas"},e._l(e.urlList,(function(t,i){return i===e.index?a("img",{key:t,ref:"img",refInFor:!0,staticClass:"el-image-viewer__img",style:e.imgStyle,attrs:{src:e.currentImg},on:{load:e.handleImgLoad,error:e.handleImgError,mousedown:e.handleMouseDown}}):e._e()})),0)],2)])},Q=[],Y=a(64923);const N=Y["default"].prototype.$isServer,Z=/([\:\-\_]+(.))/g,U=/^moz([A-Z])/,B=N?0:Number(document.documentMode),H=function(e){return(e||"").replace(/^[\s\uFEFF]+|[\s\uFEFF]+$/g,"")},V=function(e){return e.replace(Z,(function(e,t,a,i){return i?a.toUpperCase():a})).replace(U,"Moz$1")},J=function(){return!N&&document.addEventListener?function(e,t,a){e&&t&&a&&e.addEventListener(t,a,!1)}:function(e,t,a){e&&t&&a&&e.attachEvent("on"+t,a)}}(),X=function(){return!N&&document.removeEventListener?function(e,t,a){e&&t&&e.removeEventListener(t,a,!1)}:function(e,t,a){e&&t&&e.detachEvent("on"+t,a)}}();function G(e,t){if(!e||!t)return!1;if(-1!==t.indexOf(" "))throw new Error("className should not contain space.");return e.classList?e.classList.contains(t):(" "+e.className+" ").indexOf(" "+t+" ")>-1}function K(e,t){if(e){for(var a=e.className,i=(t||"").split(" "),n=0,o=i.length;n<o;n++){var l=i[n];l&&(e.classList?e.classList.add(l):G(e,l)||(a+=" "+l))}e.classList||e.setAttribute("class",a)}}function ee(e,t){if(e&&t){for(var a=t.split(" "),i=" "+e.className+" ",n=0,o=a.length;n<o;n++){var l=a[n];l&&(e.classList?e.classList.remove(l):G(e,l)&&(i=i.replace(" "+l+" "," ")))}e.classList||e.setAttribute("class",H(i))}}const te=B<9?function(e,t){if(!N){if(!e||!t)return null;t=V(t),"float"===t&&(t="styleFloat");try{switch(t){case"opacity":try{return e.filters.item("alpha").opacity/100}catch(a){return 1}default:return e.style[t]||e.currentStyle?e.currentStyle[t]:null}}catch(a){return e.style[t]}}}:function(e,t){if(!N){if(!e||!t)return null;t=V(t),"float"===t&&(t="cssFloat");try{var a=document.defaultView.getComputedStyle(e,"");return e.style[t]||a?a[t]:null}catch(i){return e.style[t]}}};let ae=e=>{var t={};return e&&"[object Function]"===t.toString.call(e)};"object"===typeof Int8Array||!Y["default"].prototype.$isServer&&"function"===typeof document.childNodes||(ae=function(e){return"function"===typeof e||!1});Object.prototype.hasOwnProperty;const ie=function(){return!Y["default"].prototype.$isServer&&!!window.navigator.userAgent.match(/firefox/i)};function ne(e){let t=!1;return function(...a){t||(t=!0,window.requestAnimationFrame((i=>{e.apply(this,a),t=!1})))}}function oe(e){for(let t=1,a=arguments.length;t<a;t++){let a=arguments[t]||{};for(let t in a)if(a.hasOwnProperty(t)){let i=a[t];void 0!==i&&(e[t]=i)}}return e}let le,se=!1,re=!1;const ce=function(){if(Y["default"].prototype.$isServer)return;let e=de.modalDom;return e?se=!0:(se=!1,e=document.createElement("div"),de.modalDom=e,e.addEventListener("touchmove",(function(e){e.preventDefault(),e.stopPropagation()})),e.addEventListener("click",(function(){de.doOnModalClick&&de.doOnModalClick()}))),e},ue={},de={modalFade:!0,getInstance:function(e){return ue[e]},register:function(e,t){e&&t&&(ue[e]=t)},deregister:function(e){e&&(ue[e]=null,delete ue[e])},nextZIndex:function(){return de.zIndex++},modalStack:[],doOnModalClick:function(){const e=de.modalStack[de.modalStack.length-1];if(!e)return;const t=de.getInstance(e.id);t&&t.closeOnClickModal&&t.close()},openModal:function(e,t,a,i,n){if(Y["default"].prototype.$isServer)return;if(!e||void 0===t)return;this.modalFade=n;const o=this.modalStack;for(let s=0,r=o.length;s<r;s++){const t=o[s];if(t.id===e)return}const l=ce();if(K(l,"v-modal"),this.modalFade&&!se&&K(l,"v-modal-enter"),i){let e=i.trim().split(/\s+/);e.forEach((e=>K(l,e)))}setTimeout((()=>{ee(l,"v-modal-enter")}),200),a&&a.parentNode&&11!==a.parentNode.nodeType?a.parentNode.appendChild(l):document.body.appendChild(l),t&&(l.style.zIndex=t),l.tabIndex=0,l.style.display="",this.modalStack.push({id:e,zIndex:t,modalClass:i})},closeModal:function(e){const t=this.modalStack,a=ce();if(t.length>0){const i=t[t.length-1];if(i.id===e){if(i.modalClass){let e=i.modalClass.trim().split(/\s+/);e.forEach((e=>ee(a,e)))}t.pop(),t.length>0&&(a.style.zIndex=t[t.length-1].zIndex)}else for(let a=t.length-1;a>=0;a--)if(t[a].id===e){t.splice(a,1);break}}0===t.length&&(this.modalFade&&K(a,"v-modal-leave"),setTimeout((()=>{0===t.length&&(a.parentNode&&a.parentNode.removeChild(a),a.style.display="none",de.modalDom=void 0),ee(a,"v-modal-leave")}),200))}};Object.defineProperty(de,"zIndex",{configurable:!0,get(){return re||(le=le||(Y["default"].prototype.$ELEMENT||{}).zIndex||2e3,re=!0),le},set(e){le=e}});const me=function(){if(!Y["default"].prototype.$isServer&&de.modalStack.length>0){const e=de.modalStack[de.modalStack.length-1];if(!e)return;const t=de.getInstance(e.id);return t}};Y["default"].prototype.$isServer||window.addEventListener("keydown",(function(e){if(27===e.keyCode){const e=me();e&&e.closeOnPressEscape&&(e.handleClose?e.handleClose():e.handleAction?e.handleAction("cancel"):e.close())}}));var pe=de;let ve;function _e(){if(Y["default"].prototype.$isServer)return 0;if(void 0!==ve)return ve;const e=document.createElement("div");e.className="el-scrollbar__wrap",e.style.visibility="hidden",e.style.width="100px",e.style.position="absolute",e.style.top="-9999px",document.body.appendChild(e);const t=e.offsetWidth;e.style.overflow="scroll";const a=document.createElement("div");a.style.width="100%",e.appendChild(a);const i=a.offsetWidth;return e.parentNode.removeChild(e),ve=t-i,ve}let fe,he=1;Boolean,Boolean,Boolean,Boolean,Boolean,Boolean,Boolean;const ge={CONTAIN:{name:"contain",icon:"el-icon-full-screen"},ORIGINAL:{name:"original",icon:"el-icon-c-scale-to-original"}},ye=ie()?"DOMMouseScroll":"mousewheel";var be={name:"elImageViewer",props:{urlList:{type:Array,default:()=>[]},zIndex:{type:Number,default:2e3},onSwitch:{type:Function,default:()=>{}},onClose:{type:Function,default:()=>{}},initialIndex:{type:Number,default:0},appendToBody:{type:Boolean,default:!0},maskClosable:{type:Boolean,default:!0}},data(){return{index:this.initialIndex,isShow:!1,infinite:!0,loading:!1,mode:ge.CONTAIN,transform:{scale:1,deg:0,offsetX:0,offsetY:0,enableTransition:!1}}},computed:{isSingle(){return this.urlList.length<=1},isFirst(){return 0===this.index},isLast(){return this.index===this.urlList.length-1},currentImg(){return this.urlList[this.index]},imgStyle(){const{scale:e,deg:t,offsetX:a,offsetY:i,enableTransition:n}=this.transform,o={transform:`scale(${e}) rotate(${t}deg)`,transition:n?"transform .3s":"","margin-left":`${a}px`,"margin-top":`${i}px`};return this.mode===ge.CONTAIN&&(o.maxWidth=o.maxHeight="100%"),o},viewerZIndex(){const e=pe.nextZIndex();return this.zIndex>e?this.zIndex:e}},watch:{index:{handler:function(e){this.reset(),this.onSwitch(e)}},currentImg(e){this.$nextTick((e=>{const t=this.$refs.img[0];t.complete||(this.loading=!0)}))}},methods:{hide(){this.deviceSupportUninstall(),this.onClose()},deviceSupportInstall(){this._keyDownHandler=e=>{e.stopPropagation();const t=e.keyCode;switch(t){case 27:this.hide();break;case 32:this.toggleMode();break;case 37:this.prev();break;case 38:this.handleActions("zoomIn");break;case 39:this.next();break;case 40:this.handleActions("zoomOut");break}},this._mouseWheelHandler=ne((e=>{const t=e.wheelDelta?e.wheelDelta:-e.detail;t>0?this.handleActions("zoomIn",{zoomRate:.015,enableTransition:!1}):this.handleActions("zoomOut",{zoomRate:.015,enableTransition:!1})})),J(document,"keydown",this._keyDownHandler),J(document,ye,this._mouseWheelHandler)},deviceSupportUninstall(){X(document,"keydown",this._keyDownHandler),X(document,ye,this._mouseWheelHandler),this._keyDownHandler=null,this._mouseWheelHandler=null},handleImgLoad(e){this.loading=!1},handleImgError(e){this.loading=!1,e.target.alt="加载失败"},handleMouseDown(e){if(this.loading||0!==e.button)return;const{offsetX:t,offsetY:a}=this.transform,i=e.pageX,n=e.pageY;this._dragHandler=ne((e=>{this.transform.offsetX=t+e.pageX-i,this.transform.offsetY=a+e.pageY-n})),J(document,"mousemove",this._dragHandler),J(document,"mouseup",(e=>{X(document,"mousemove",this._dragHandler)})),e.preventDefault()},handleMaskClick(){this.maskClosable&&this.hide()},reset(){this.transform={scale:1,deg:0,offsetX:0,offsetY:0,enableTransition:!1}},toggleMode(){if(this.loading)return;const e=Object.keys(ge),t=Object.values(ge),a=t.indexOf(this.mode),i=(a+1)%e.length;this.mode=ge[e[i]],this.reset()},prev(){if(this.isFirst&&!this.infinite)return;const e=this.urlList.length;this.index=(this.index-1+e)%e},next(){if(this.isLast&&!this.infinite)return;const e=this.urlList.length;this.index=(this.index+1)%e},handleActions(e,t={}){if(this.loading)return;const{zoomRate:a,rotateDeg:i,enableTransition:n}={zoomRate:.2,rotateDeg:90,enableTransition:!0,...t},{transform:o}=this;switch(e){case"zoomOut":o.scale>.2&&(o.scale=parseFloat((o.scale-a).toFixed(3)));break;case"zoomIn":o.scale=parseFloat((o.scale+a).toFixed(3));break;case"clocelise":o.deg+=i;break;case"anticlocelise":o.deg-=i;break}o.enableTransition=n}},mounted(){this.deviceSupportInstall(),this.appendToBody&&document.body.appendChild(this.$el),this.$refs["el-image-viewer__wrapper"].focus()},destroyed(){this.appendToBody&&this.$el&&this.$el.parentNode&&this.$el.parentNode.removeChild(this.$el)}},we=be,xe=(0,S.Z)(we,O,Q,!1,null,null,null),ke=xe.exports,Ce=a(20809),De=a(29625),$e=a(3293),Fe=a(26895),Se=a(29416);const Ie=(0,p.LP)(),ze=e=>{const t=(0,o.ref)([]),a=(0,o.ref)(0),i=(0,o.ref)(!1),n=async n=>{i.value=!0;const[{data:o}]=await(0,j.Dc)(500,(0,b.nW)(n));i.value=!1,o.success?(t.value=o.data.data,a.value=o.data.total):e.root.$message({type:"warning",message:o.message??"查询失败，稍后重试",duration:2e3,showClose:!0})};return{DataList:t,total_count:a,loadDataList:n,loading:i}};var Le=(0,o.defineComponent)({components:{InvoiceReverseDialog:z,ElImageViewer:ke,InvoiceVoidDialog:q,InvoiceRedDialog:A.Z},data(){const e="/api/financial/save_invoice",t={Authorization:Ie};return{InvoiceUploadAPIURL:e,InvoiceUploadHeaders:t}},setup(e,t){const{tableHeightLogic:a,onTopCardRectUpdate:i}=(0,Ce.Z)(),n=(0,o.ref)(!1),l=(0,o.ref)(null),s=(0,o.ref)(null),c=(0,P.gI)(),u=(0,o.ref)(!1),d=k()().format("YYYY.MM"),m=()=>{u.value=!0},p=async(e,a)=>{u.value=!1,e.success?(t.root.$message.success(e.message),await L()):t.root.$message.error(e.message)},v=(0,o.ref)({page_num:1,num:20,write_off_status:"",invoice_status:"",invoice_type:"",invoice_number:"",buyer_name:"",seller_name:"",is_special:"",settlement_uid:"",project_name:"",is_real:"",invoice_month:"",business_type:"",feishu_department_id:"",settlement_month:""}),_=(0,o.ref)({}),f=()=>{n.value=!0},{DataList:g,total_count:y,loadDataList:w,loading:x}=ze(t),C=(0,o.ref)(void 0),D=(e,t,a,i)=>{const{invoice_number_column:n,invoice_date_column:u,invoice_amount_column:m,seller_name_column:p,buyer_name_column:v,tax_rate_column:_,tax_amount_column:f,tax_excluded_amount_column:g,invoice_type_column:y,invoice_status_column:w,invoice_real_type_column:x,writeoff_status_column:D,invoice_picture_column:$}=h(t,i),F=async(e,t)=>{const a=await(0,r.I)(e,{title:"确认发票作废吗？",content:"发票作废后相关发票核销记录将被冲销。"});if(a){const[{data:a}]=await(0,j.Dc)(500,(0,b.lj)({id:t.id}));a.success?(e.root.$message.success("作废成功"),await L()):e.root.$message({type:"warning",message:a.message??"作废失败，稍后重试",duration:2e3,showClose:!0})}};function S(e){C.value=e,s.value?.show()}function I(e){C.value=e,l.value?.show()}const z=(0,o.computed)((()=>[v.value,p.value,n.value,u.value,m.value,_.value,f.value,g.value,y.value,w.value,x.value,D.value,$.value,c.write_off_invoice||c.void_invoice?{label:c.write_off_invoice||c.void_invoice?"操作":"",fixed:!(!c.write_off_invoice&&!c.void_invoice)&&"right",width:c.write_off_invoice||c.void_invoice?110:1,formatter:t=>{const i=k()(1e3*t.invoice_date).format("YYYY.MM");if(2===t.invoice_status)return;const n=[],l=2!==t.write_off_status?"visibility: visible":"visibility: hidden";return c.write_off_invoice&&1===t.invoice_status&&n.push((0,o.h)("a",{style:l,on:{click:()=>{2!==t.write_off_status&&(C.value=t,a())}}},["核销"])),c.void_invoice&&1===t.invoice_status&&1!==t.invoice_type&&n.push((0,o.h)("a",{on:{click:()=>{F(e,t)}}},["作废"])),c.void_invoice&&1===t.invoice_status&&1===t.invoice_type&&d===i&&n.push((0,o.h)("a",{on:{click:()=>{S(t)}}},["作废"])),c.void_invoice&&1===t.invoice_type&&1===t.invoice_status&&d!==i&&n.push((0,o.h)("a",{on:{click:()=>{I(t)}}},["开红票"])),(0,o.h)("div",{class:"operation"},n)}}:{label:"操作",fixed:"right",width:50}]));return z},$=(0,o.ref)(!1),F=(0,o.ref)([]),S=()=>{$.value=!1},I=e=>{$.value=!0,F.value=e},z=D(t,g,f,I),L=async(e=!0,t=!1)=>{let a;if(e&&(v.value.page_num=1),t?a=JSON.parse(JSON.stringify(_.value)):(a=JSON.parse(JSON.stringify(v.value)),_.value={...a}),a.invoice_month){const e=k()(a.invoice_month).startOf("month");a.invoice_month=e.format("YYYY-MM")}if(a.settlement_month){const e=k()(a.settlement_month).startOf("month");a.settlement_month=e.format("YYYY-MM")}if(t)return a.num=4e3,void(0,Se.Hy)(a,"/api/financial/export_invoice");await w(a)},R=()=>{v.value.write_off_status="",v.value.invoice_status="",v.value.invoice_type="",v.value.invoice_number="",v.value.is_special="",v.value.buyer_name="",v.value.seller_name="",v.value.settlement_uid="",v.value.invoice_month="",v.value.invoice_status="",v.value.is_real="",v.value.business_type="",v.value.feishu_department_id="",v.value.project_name="",v.value.settlement_month="",O.input=""},T=async()=>{R(),await L()};(0,o.onMounted)((()=>{L()}));const M=async()=>{n.value=!1,await L()},W=async e=>{v.value.page_num=e,await L(!1)},E=async e=>{v.value.num=e,await L()},q=async()=>{const e=await(0,$e.o1)(),t=e.data.data.data;(0,Fe.$S)(t,!1,3),O.data=t},A=(0,o.ref)(),O=(0,o.reactive)({data:[],show:!1,input:"",check:e=>{A.value?.setCheckedKeys([e.department_id]),v.value.feishu_department_id=e.id,O.input=e.name,O.show=!1}});q();const Q=()=>{L(!1,!0)},Y=(0,o.computed)((()=>!_.value.write_off_status&&(!_.value.buyer_name&&(!_.value.seller_name&&(!_.value.invoice_number&&(!_.value.invoice_month&&(!_.value.invoice_type&&(!_.value.invoice_status&&(!_.value.is_real&&(!_.value.business_type&&(!_.value.feishu_department_id&&(!_.value.settlement_uid&&!_.value.settlement_month))))))))))));return{exportData:Q,treeData:O,treeRef:A,isDisabled:Y,BusinessTypeOptions:De.Yh.filter((e=>e.value!==De.WD.douyinsh)),permission:c,closeViewer:S,showViewer:$,ImageUrlList:F,uploadLoading:u,handleCurrentChange:W,handlePageSizeChange:E,BeforeInvoiceUploadHandler:m,InvoiceUploadResponseHandler:p,invoiceReverseDialogVisible:n,invoiceVoidDialogRef:s,invoiceRedDialogRef:l,QueryForm:v,loading:x,resetQueryForm:R,currentInvoice:C,reload:L,reset:T,DataList:g,columns:z,total_count:y,...a,onTopCardRectUpdate:i,reverseSuccess:M}}}),Re=Le,Te=(0,S.Z)(Re,l,s,!1,null,"e68118c0",null),je=Te.exports,Me=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"finance-invoice-application flex-auto"},[a("tg-card",{attrs:{padding:[18,24,0,18]},on:{"rect:update":e.onTopCardRectUpdate}},[a("el-form",{attrs:{model:e.queryForm,size:"small","label-width":"70px"}},[a("el-form-item",{attrs:{label:"项目名称："}},[a("el-input",{staticStyle:{width:"245px"},attrs:{placeholder:"请输入项目名称"},model:{value:e.queryForm.project_name,callback:function(t){e.$set(e.queryForm,"project_name",t)},expression:"queryForm.project_name"}})],1),a("el-form-item",{attrs:{label:"公司名称："}},[a("el-input",{staticStyle:{width:"245px"},attrs:{placeholder:"请输入公司名称"},model:{value:e.queryForm.company_name,callback:function(t){e.$set(e.queryForm,"company_name",t)},expression:"queryForm.company_name"}})],1),a("el-form-item",{attrs:{label:"审批编号："}},[a("el-input",{staticStyle:{width:"245px"},attrs:{placeholder:"请输入审批编号"},model:{value:e.queryForm.approval_num,callback:function(t){e.$set(e.queryForm,"approval_num",t)},expression:"queryForm.approval_num"}})],1),a("el-form-item",{attrs:{label:"发起时间："}},[a("el-date-picker",{staticClass:"time-select-box",staticStyle:{width:"245px"},attrs:{type:"daterange","range-separator":"~","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"yyyy-MM-dd"},model:{value:e.queryForm.start_time,callback:function(t){e.$set(e.queryForm,"start_time",t)},expression:"queryForm.start_time"}})],1),a("el-form-item",{attrs:{label:"发起人："}},[a("el-input",{staticStyle:{width:"245px"},attrs:{placeholder:"请输入发起人"},model:{value:e.queryForm.add_by_name,callback:function(t){e.$set(e.queryForm,"add_by_name",t)},expression:"queryForm.add_by_name"}})],1),a("el-form-item",{attrs:{label:"审批状态："}},[a("el-select",{staticStyle:{width:"245px"},model:{value:e.queryForm.approval_status,callback:function(t){e.$set(e.queryForm,"approval_status",t)},expression:"queryForm.approval_status"}},[a("el-option",{attrs:{label:"全部",value:""}}),a("el-option",{attrs:{label:"审批中",value:1}}),a("el-option",{attrs:{label:"审批成功",value:2}}),a("el-option",{attrs:{label:"审批失败",value:3}}),a("el-option",{attrs:{label:"已撤销",value:4}})],1)],1),a("el-form-item",{attrs:{label:"开票状态："}},[a("el-select",{staticStyle:{width:"245px"},model:{value:e.queryForm.invoiced,callback:function(t){e.$set(e.queryForm,"invoiced",t)},expression:"queryForm.invoiced"}},[a("el-option",{attrs:{label:"全部",value:""}}),a("el-option",{attrs:{label:"已开票",value:1}}),a("el-option",{attrs:{label:"未开票",value:0}})],1)],1),a("el-form-item",{attrs:{"label-width":"0"}},[a("div",{staticClass:"filter-form-item-btn"},[a("tg-button",{attrs:{type:"primary"},on:{click:e.reload}},[e._v("查询")]),a("tg-button",{staticClass:"mgl-12",on:{click:e.reset}},[e._v("重置")])],1)])],1)],1),a("tg-card",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"mgt-12",staticStyle:{"flex-grow":"1"},attrs:{padding:[12,18,0,18]},on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("div",[a("tg-button",{attrs:{type:"primary",icon:"ico-fapiao"},on:{click:e.showMakeInvoiceDailog}},[e._v("开票申请")])],1),a("el-table",e._b({staticClass:"mgt-12",attrs:{stripe:"",border:"",data:e.list},on:{"row-click":function(t){return t.target!==t.currentTarget?null:e.onRowClick.apply(null,arguments)}},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无记录"}})]},proxy:!0}])},"el-table",e.tableProps,!1),e._l(e.invoiceColumns,(function(t,i){return a("el-table-column",e._b({key:i},"el-table-column",t,!1))})),1),e.list.length?a("el-pagination",{staticStyle:{margin:"8px 0"},attrs:{"current-page":e.queryForm.page_num,"page-sizes":[10,20,50,100],"page-size":e.queryForm.num,layout:"total, prev, pager, next, sizes, jumper",total:e.queryForm.total},on:{"update:currentPage":function(t){return e.$set(e.queryForm,"page_num",t)},"update:current-page":function(t){return e.$set(e.queryForm,"page_num",t)},"current-change":e.currentPageChange,"size-change":e.pageSizeChange}}):e._e()],1),a("MakeInvoiceDialog",{ref:"MakeInvoiceDialogRef",attrs:{reload:!0},on:{success:e.reload}}),a("invoice-upload",{ref:"InvoiceUploadRef",on:{success:e.reload}}),a("invoices-detail",{ref:"InvoiceDetailDialogRef"}),a("tg-mask-loading",{attrs:{visible:e.detailLoading,content:"努力加载中..."}}),a("invoice-red-dialog",{ref:"invoiceRedDialogRef",attrs:{invoice:e.invoiceRed,isEdit:!0},on:{success:e.reload}}),e.showViewer?a("el-image-viewer",{attrs:{"on-close":e.closeViewer,"url-list":e.ImageUrlList}}):e._e(),a("red-detail",{ref:"RedDetailDialogRef",on:{success:e.reload}})],1)},We=[],Ee=a(80972),qe=a(28645),Ae=a(33018),Pe=a(63995),Oe=a(51351);const Qe=(e,t,a,i)=>{const n=e[t]||"--",{is_folded:l,folded_text:s}=(0,u.zb)(n,a);return i||!l?s:(0,o.h)("el-popover",{props:{placement:"right",trigger:"hover",content:n}},[(0,o.h)("span",{slot:"reference"},[s]),(0,o.h)("DefText",{props:{content:e[t]}})])},Ye=e=>{const t=e=>(0,o.h)("div",{class:"number-div"},[(0,o.h)("span",{class:"number-span"},e.approval_uid)]),a=(e,t)=>Qe(e,"collecting_company",14,t),i=(0,_.zY)(e,"公司名称",a),n=(e,t)=>{const a=(0,u.SJ)(new(m())(e.approval_content.invoice_amount));return t?a:(0,o.h)("span",{},[a])},l=(0,o.computed)((()=>({label:"审批编号",minWidth:230,formatter:e=>t(e)}))),s=(0,o.computed)((()=>({label:"公司名称",minWidth:i.value+20,formatter:e=>a(e,!1)}))),r=(0,o.computed)((()=>({label:"开票金额 (元)",minWidth:140,align:"right",formatter:e=>n(e,!1)}))),c=(0,o.computed)((()=>({label:"发起人",minWidth:120,align:"center",formatter:e=>e.approval_content.username}))),d=(0,o.computed)((()=>({label:"发起时间",property:"start_time",align:"center",minWidth:120}))),p=(0,o.computed)((()=>({label:"审批状态",minWidth:120,align:"center",formatter:e=>{let t="--",a="";switch(e.approval_status){case 1:t="审批中",a="waiting";break;case 2:t="审批成功",a="success";break;case 3:t="审批失败",a="failure";break;case 4:t="已撤销",a="cancel";break}return(0,o.h)("span",{class:"status-box"},[(0,o.h)("span",{class:`point ${a}`}),(0,o.h)("span",{class:"text"},t)])}}))),v=(0,o.computed)((()=>({label:"开票状态",minWidth:120,align:"center",formatter:e=>{let t="--";return 0===e.invoiced?t="未开票":1===e.invoiced&&(t="已开票"),(0,o.h)("span",{style:{color:0===e.invoiced?"#f04b4b":"#33ba5d"}},t)}})));return{approve_code_column:l,company_name_column:s,invoice_amount_column:r,username_column:c,start_time_column:d,approval_status_column:p,invoiced_column:v}};var Ne,Ze,Ue=a(77944),Be=(0,o.defineComponent)({props:{"url-list":Array},setup(){const e=(0,o.ref)([]),t=(0,o.ref)(0),a=t=>{e.value=t.map((e=>{const t=/\.pdf\?.+$|\.pdf\??$/.test(e);return{hasPDF:t,url:e}}))},i=(0,o.computed)((()=>0===e.value.length?{}:e.value[t.value])),n=()=>{0===t.value?t.value=e.value.length-1:t.value--},l=()=>{t.value===e.value.length-1?t.value=0:t.value++};return{show:a,list:e,current:i,index:t,nextHandler:l,prevHandler:n}},render(){const e=arguments[0];let t;if(this.current.hasPDF){const a=this.list[this.index].url,i=a.split("?")[0].split("/");t=e("div",{class:"pdf-preview",style:"width:150px;height:150px;text-align:center"},[e("tg-icon",{attrs:{name:"ico-pdf"},style:"position:relative;z-index:100;cursor:pointer",on:{click:()=>{window.open(a)}}}),e("span",{style:"color:white"},[i[i.length-1]])])}else t=e("img",{attrs:{src:this.current.url},class:"el-image-viewer__img",style:"transform: scale(1) rotate(0deg); margin-left: 0px; margin-top: 0px; max-height: 100%; max-width: 100%;"});return e("transition",[e("div",{attrs:{tabindex:"-1"},class:"el-image-viewer__wrapper",style:"z-index: 2000;"},[e("span",{class:"el-image-viewer__btn el-image-viewer__close",style:"z-index: 2000;",on:{click:()=>{this.$emit("close")}}},[e("i",{class:"el-icon-close"})]),e("div",[e("span",{style:"z-index:102;",class:"el-image-viewer__btn el-image-viewer__prev",on:{click:this.prevHandler}},[e("i",{class:"el-icon-arrow-left"})]),e("span",{style:"z-index:102;",class:"el-image-viewer__btn el-image-viewer__next",on:{click:this.nextHandler}},[e("i",{class:"el-icon-arrow-right"})])]),e("div",{class:"el-image-viewer__canvas",style:"position:relative;z-index:100;"},[t]),e("div",{class:"el-image-viewer__mask"})])])}}),He=Be,Ve=(0,S.Z)(He,Ne,Ze,!1,null,"118eeee3",null),Je=Ve.exports,Xe={show(e){const t=document.createElement("div");t.className="ImageViewRoot",document.body.appendChild(t);const a=new Y["default"](Je);a.$on("close",(()=>{document.body.removeChild(a.$el),a.$destroy()})),a.$mount(t),a.show(e)}};const Ge=(0,p.LP)();var Ke=(0,o.defineComponent)({components:{MakeInvoiceDialog:Ee.Z,InvoiceUpload:qe.Z,InvoicesDetail:Ae.Z,RedDetail:Pe.Z,InvoiceRedDialog:A.Z,ElImageViewer:ke},setup(e,t){const a=(0,P.gI)(),{tableHeightLogic:i,onTopCardRectUpdate:n}=(0,Ce.Z)(),l=(0,o.ref)(!1),s=(0,o.ref)(!1),c=(0,o.ref)(null),u=(0,o.ref)(null),d=(0,o.ref)(null),m=(0,o.ref)(null),p=(0,o.ref)(null),v=(0,o.ref)(null),_=(0,o.ref)(!1),f=(0,o.ref)([]),h=(0,o.computed)((()=>Ue.Z.getters["user/getUserInfo"])),g=(0,o.reactive)({total:0,page_num:1,num:20,project_name:"",approval_num:"",company_name:"",add_by_name:"",start_time:"",approval_status:"",invoiced:""}),y=(0,o.ref)([]);async function b(e){l.value=!0;const[{data:a}]=await(0,j.Dc)(500,(0,Oe.kX)(e));l.value=!1,a.success?(y.value=a.data.data,g.total=a.data.total):t.root.$message({type:"warning",message:a.message??"查询失败，稍后重试",duration:2e3,showClose:!0})}async function w(e=!0){e&&(g.page_num=1);const t={approval_search_type:4,approval_type:4,invoiced:g.invoiced,add_by_name:g.add_by_name,approval_uid:g.approval_num,approval_status:g.approval_status,page_num:g.page_num,num:g.num,company_name:g.company_name,project_name:g.project_name,start_time_min:g.start_time?g.start_time[0]:"",start_time_max:g.start_time?g.start_time[1]:""};await b(t)}async function x(){g.page_num=1,g.num=20,g.project_name="",g.approval_num="",g.company_name="",g.add_by_name="",g.start_time="",g.approval_status="",g.invoiced="",await w()}const k=async e=>{g.page_num=e,await w(!1)},C=async e=>{g.num=e,await w()},D=()=>{_.value=!1},$=e=>{const{approve_code_column:i,company_name_column:n,invoice_amount_column:l,username_column:s,start_time_column:c,approval_status_column:m,invoiced_column:g}=Ye(e),y=e=>{d.value.show({id:e.approval_id,company:e.collecting_company,total_amount:e.approval_content.invoice_amount})},b=e=>{_.value=!0,f.value=e},x=async(e,a)=>{const{data:i}=await(0,Oe.OC)({approval_id:e});i.success?12===a?(v.value=i.data.approval_detail,p.value.show()):u.value.show(i.data):t.root.$message.error(i.message??"获取审批详情失败")},k=async e=>{const a=await(0,r.I)(t,"你确定删除吗?");if(a){const{data:a}=await(0,Oe.t)(e);a.success?(t.root.$message.success("删除成功"),await w(!1)):t.root.$message.error(a.message??"操作失败")}},C=(0,o.computed)((()=>[i.value,n.value,l.value,s.value,c.value,m.value,g.value,{label:"操作",width:160,formatter:e=>{if(a.upload_invoice&&2===e.approval_status&&0===e.invoiced){const t=[];return t.push((0,o.h)("a",{style:{marginRight:"12px"},on:{click:t=>{t.stopPropagation(),y(e)}}},"上传发票")),e.invoice_pic_url_list.length>0&&t.push((0,o.h)("a",{style:{marginRight:"12px"},on:{click:t=>{t.stopPropagation();const a=e.invoice_pic_url_list.map((e=>`${e}?Authorization=${Ge}`));Xe.show(a),location.href||b(a)}}},"查看发票")),(0,o.h)("div",{class:"table-column-edit"},t)}return 2===e.approval_status&&1===e.invoiced?(0,o.h)("div",{class:"table-column-edit"},[(0,o.h)("a",{style:{marginRight:"12px"},on:{click:t=>{t.stopPropagation();const a=e.invoice_pic_url_list.map((e=>`${e}?Authorization=${Ge}`));b(a)}}},"查看发票")]):3===e.approval_status?(0,o.h)("div",{class:"table-column-edit"},[h.value.id===e.approval_content.create_id&&(0,o.h)("a",{style:{marginRight:"12px"},on:{click:t=>{t.stopPropagation(),x(e.approval_id,e.approval_type)}}},"重新编辑提交"),(0,o.h)("a",{style:{marginRight:"12px"},on:{click:t=>{t.stopPropagation(),k(e.approval_id)}}},"删除")]):void 0}}]));return C},F=$(y),S=()=>{c.value?.show()},I=async e=>{const{data:a}=await(0,Oe.OC)({approval_id:e.approval_id});a.success?4===e.approval_type?u.value.show(a.data):m.value.show(a.data):t.root.$message.error(a.message??"获取审批详情失败")};return(0,o.onMounted)((()=>{w()})),{...i,onTopCardRectUpdate:n,queryForm:g,loading:l,reload:w,reset:x,list:y,invoiceColumns:F,currentPageChange:k,pageSizeChange:C,showMakeInvoiceDailog:S,MakeInvoiceDialogRef:c,InvoiceDetailDialogRef:u,InvoiceUploadRef:d,detailLoading:s,onRowClick:I,RedDetailDialogRef:m,invoiceRedDialogRef:p,invoiceRed:v,showViewer:_,closeViewer:D,ImageUrlList:f}}}),et=Ke,tt=(0,S.Z)(et,Me,We,!1,null,"519d46cf",null),at=tt.exports,it=a(23812),nt=a(1763);const ot=new Map([["manager","InvoiceManager"],["application","InvoiceApplication"]]);var lt=(0,o.defineComponent)({props:{tab:{type:String,default:"manager"}},components:{InvoiceManager:je,InvoiceApplication:at},setup(e,t){const a=(0,it.YE)([{label:"发票管理",value:"manager"},{label:"开票管理",value:"application"}],e.tab),i=e=>{a.checkedTab.value=e.value;const i=a.tabs[0].value===e.value?{name:nt.B_.invoice_manager}:{name:nt.B_.invoice_application,params:{tab:e.value}};t.root.$router.push(i)},n=(0,o.computed)((()=>ot.get(a.checkedTab.value)??"InvoiceManager"));return{...a,tabPane:n,onTabChange:i}}}),st=lt,rt=(0,S.Z)(st,i,n,!1,null,null,null),ct=rt.exports},17660:function(e,t,a){a.d(t,{Z:function(){return u}});var i=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-steps",{staticClass:"invoice-steps",attrs:{direction:"vertical",active:e.items.length}},[e._l(e.items,(function(t,i){return a("el-step",{key:t.nodeId+i},[3===e.stepStatus&&i===e.items.length-1?a("div",{staticClass:"my-icon error",attrs:{slot:"icon"},slot:"icon"},[a("tg-icon",{attrs:{name:"ico-cross-red"}})],1):a("div",{staticClass:"my-icon success",attrs:{slot:"icon"},slot:"icon"},[a("tg-icon",{attrs:{name:"ico-a-chenggong2x"}})],1),a("div",{staticClass:"step-title",attrs:{slot:"title"},slot:"title"},[a("span",[e._v(e._s(t.nodeName))])]),a("div",{staticClass:"description",attrs:{slot:"description"},slot:"description"},[a("div",{staticClass:"operator"},[a("span",[e._v("审批人：")]),a("span",[e._v(e._s(t.operatorName))])]),t.remark?a("div",{staticClass:"remark",class:3===e.stepStatus&&e.items.length-1===i&&"error-text"},[a("span",[e._v("理由：")]),a("span",[e._v(e._s(t.remark))])]):e._e(),a("div",{staticClass:"timestamp"},[a("span",[e._v(e._s(t.approval_date))])])])])})),1===e.stepStatus&&e.items[e.items.length-1].receivedPersons?a("el-step",[a("div",{staticClass:"my-icon",attrs:{slot:"icon"},slot:"icon"},[a("span",{staticClass:"num received"},[e._v(e._s(e.items.length+1))])]),a("div",{staticClass:"step-title",attrs:{slot:"title"},slot:"title"},[a("span",{staticStyle:{color:"#a4b2c2"}},[e._v(e._s(e.items[e.items.length-1].receivedPersons))])]),a("div",{staticClass:"operator received",attrs:{slot:"description"},slot:"description"},[a("span",{staticStyle:{color:"#a4b2c2"}},[e._v("待处理")])])]):e._e()],2)},n=[],o=a(97434),l=(0,o.defineComponent)({props:{items:{type:Array,default:()=>[]},stepStatus:{type:Number,default:0}}}),s=l,r=a(1001),c=(0,r.Z)(s,i,n,!1,null,null,null),u=c.exports},33018:function(e,t,a){a.d(t,{Z:function(){return w}});var i=a(97434),n=a(61282),o=a(17660),l=a(17496),s=a(64236),r=a(82741),c=a(74750),u=a(51351),d=a(79703),m=a(80972);const p=new Map([[1,"审批中"],[2,"审批成功"],[3,"审批失败"],[4,"已撤销"]]),v=e=>{const t=(0,i.ref)(!1);return{revokeLoading:t}};var _,f,h=(0,i.defineComponent)({components:{Appendix:d.Z,workbenchTimeLine:o.Z,invoiceDialog:m.Z},setup(e,t){const a=(0,i.ref)(null),o=(0,i.ref)(!1),d=(0,i.ref)(!1),m=v(t),_=(0,i.ref)({}),f=(0,i.computed)((()=>t.root.$store.getters["user/getUserInfo"])),h=()=>{t.emit("close"),d.value=!1},g=e=>{_.value=e,d.value=!0},y=e=>(0,u.qL)(e).then((e=>e&&e.data&&e.data.success?(t.root.$message.success("保存成功"),h(),t.emit("reload:invoices"),e):(t.root.$message.error("保存失败"),e.data.message))),b=async()=>{const e=await(0,r.I)(t,"你确定撤销吗?");if(e){const e={approval_id:_.value.approval_id,update_code:4};y(e)}},w=e=>{if(!e)return!1;const a={headers:{Authorization:(0,c.LP)()??""}};fetch(e,a).then((async a=>{const i=a.clone();try{const e=await i.json();t.root.$message.error(e.message)}catch{if(200===a.status){const t=await a.blob(),i=decodeURIComponent(e.split("/")[e.split("/").length-1]);(0,s.uA)(t,i)}else t.root.$message.error("下载失败")}}))},x=e=>{if(!e)return"ico-picture";switch(e.toLowerCase()){case"docx":case"doc":return"ico-word";case"xlsx":case"xls":return"ico-excel";case"pdf":return"ico-pdf";case"mp4":return"ico-picture2";default:return"ico-picture"}},k=()=>{if(_.value.attachment){const e=_.value.attachment.map((e=>{const t=e.split("/"),a=t[t.length-1],n=a.split("."),o=n[n.length-1];return(0,i.h)("span",{class:"value",on:{click(){w(e)}}},[(0,i.h)("tg-icon",{attrs:{name:x(o)}},o),a])}));return(0,i.h)("div",{class:"load"},[e])}return(0,i.h)("span",{class:"value"},"--")},C=(0,i.computed)((()=>f&&f.value.id===_.value.now_id)),D=(0,i.computed)((()=>f&&f.value.id===_.value.add_by)),$=()=>{a.value?.show()},F=async()=>{const e=await(0,r.I)(t,"你确定重新提交吗?");e&&Promise.resolve().then((()=>{o.value=!0})).then((()=>{$()}))},S=()=>{o.value=!1,h(),t.emit("reload:invoices")};return{show:g,hide:h,revoke:b,visible:d,btnVisiable:C,invoiceDetail:_,contractStatus:p,Decimal2String:n.SJ,...m,renderAttachment:k,enumLevelTwoTypes:l.rw,revocationVisiable:D,reApply:F,invoiceDialogRef:a,confirmInvoiceDialog:S,invoiceDialogVisible:o}},render(){const e=arguments[0];return e("div",[e("el-dialog",{class:"tg-dialog-classic tg-dialog-vcenter-new new-invoice-detail-dialog",attrs:{width:"948px",visible:this.visible,"close-on-click-modal":!1,"close-on-press-escape":!1,wrapperClosable:!1},on:{close:this.hide}},[e("template",{slot:"title"},["开票申请详情"]),e("div",{class:"new-invoice-detail"},[e("div",{class:"invoice-detail"},[e("div",{class:"invoice-detail-info"},[e("div",{class:"detail-row"},[e("span",{class:"label"},["申请人："]),e("span",{class:"value"},[this.invoiceDetail.username])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["申请部门："]),e("span",{class:"value"},[this.invoiceDetail.create_department])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["发起时间："]),e("span",{class:"value"},[this.invoiceDetail.gmt_create])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["审批编号："]),e("span",{class:"value"},[this.invoiceDetail.approval_uid]),e("span",{class:"contract-status status-"+this.invoiceDetail.approval_status},[this.contractStatus.get(this.invoiceDetail.approval_status)])]),e("div",{class:"line"}),e("div",{class:"detail-row",style:"margin-top: 22px"},[e("span",{class:"label"},["开票金额："]),e("span",{class:"value"},[this.invoiceDetail.invoice_amount_str])]),e("div",{class:"detail-row",style:"margin-top: 22px"},[e("span",{class:"label"},["开票类型："]),e("span",{class:"value"},[this.enumLevelTwoTypes(this.invoiceDetail.level_two_types)])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["寄送方式："]),e("span",{class:"value"},[1===this.invoiceDetail.invoice_send_type?"快递寄送":"自行送达"])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["是否收到款项："]),e("span",{class:"value"},[this.invoiceDetail.is_received?"是":"否"])]),e("div",{class:"detail-row"},[e("span",{class:"label"},[this.invoiceDetail.is_received?"":"预计","收款时间："]),e("span",{class:"value"},[this.invoiceDetail.received_date])]),1===this.invoiceDetail.is_received&&e("div",{class:"detail-row"},[e("span",{class:"label"},["收款编号："]),e("span",{class:"value"},[this.invoiceDetail.achievement_uid])])]),e("div",{class:"invoice-detail-table"},[e("div",{class:"detail-table-head"},[e("span",{class:"table-head-td"},["项目"]),e("span",{class:"table-head-td"},["结算单编号"]),e("span",{class:"table-head-td text-r"},["结算金额 (元)"]),e("span",{class:"table-head-td text-r"},["本次开票金额 (元)"])]),e("div",{class:"detail-table-body"},[this.invoiceDetail.details&&this.invoiceDetail.details.map((t=>e("div",{class:"table-body-tr"},[e("span",{class:"table-body-td"},[t.project_name]),e("span",{class:"table-body-td"},[t.settlement_no]),e("span",{class:"table-body-td text-r"},[this.Decimal2String(t.settlement_amount)]),e("span",{class:"table-body-td text-r"},[this.Decimal2String(t.invoice_amount)])])))])]),e("div",{class:"line2",style:"margin-top: 32px;"}),e("div",{class:"invoice-detail-info"},[e("div",{class:"detail-row"},[e("span",{class:"label"},["公司名称："]),e("span",{class:"value"},[this.invoiceDetail.collecting_company||"--"])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["纳税人识别号："]),e("span",{class:"value"},[this.invoiceDetail.tax_number||"--"])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["地址|电话："]),e("span",{class:"value block"},[this.invoiceDetail.address||"--"," ",this.invoiceDetail.phone||"--"])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["开户行|账号："]),e("span",{class:"value block"},[this.invoiceDetail.bank_of_deposit||"--","  ",this.invoiceDetail.bank_card_number||"--"])])]),e("div",{class:"line2"}),e("div",{class:"invoice-detail-info"},[e("div",{class:"detail-row"},[e("span",{class:"label"},["备注："]),e("span",{class:"value block"},[this.invoiceDetail.remark||"--"])]),e("div",{class:"detail-row"},[e("span",{class:"label"},["附件："]),this.invoiceDetail?.attachment?.length?e("appendix",{attrs:{list:this.invoiceDetail.attachment}}):e("span",{class:"value"},["--"])])])]),e("div",{class:"invoice-press"},[e("h5",{class:"title"},["审批进度"]),e(o.Z,{attrs:{"step-status":this.invoiceDetail.approval_status,items:this.invoiceDetail.approval_flow_detail}})])]),e("template",{slot:"footer"},[e("tg-button",{on:{click:this.hide}},["取消"]),1===this.invoiceDetail.approval_status&&this.revocationVisiable&&e("div",{class:"div-default-btn",on:{click:this.revoke},directives:[{name:"loading",value:this.saveLoading}]},["撤销"]),3===this.invoiceDetail.approval_status&&e("div",{class:"div-default-btn",on:{click:this.reApply},directives:[{name:"loading",value:this.saveLoading}]},["重新编辑提交"])])]),this.invoiceDialogVisible&&e(m.Z,{ref:"invoiceDialogRef",attrs:{confirm:this.confirmInvoiceDialog,data:this.invoiceDetail,edit:!0}})])}}),g=h,y=a(1001),b=(0,y.Z)(g,_,f,!1,null,null,null),w=b.exports},82741:function(e,t,a){a.d(t,{I:function(){return n},u:function(){return o}});var i=a(71340);const n=(e,t)=>{const a="string"===typeof t?{title:t}:t;return new Promise((t=>{e.root.$TDialog({...a,onConfirm:()=>t(!0),onCancel:()=>t(!1)})}))},o=e=>{const t="string"===typeof e?{title:e}:e;return new Promise(((e,a)=>{(0,i.t)({...t,onConfirm:()=>e(!0),onCancel:()=>a()})}))}},58302:function(e,t,a){var i=a(97434),n=a(77944),o=a(52140);const l=e=>{const t=(0,i.computed)((()=>n.Z.getters["global/scrollbarSetting"])),a=(0,i.computed)((()=>void 0!==e.pagename?!0!==t.value.find((t=>t.key===e.pagename))?.value:e.disable??!1)),l=(0,i.computed)((()=>{const t=(e.fixedBlockHeightRefs??[]).map((e=>(0,i.unref)(e))).reduce(((e,t)=>(0,i.unref)(e)+(0,i.unref)(t)),0);return a.value?"max-content":`calc(100vh - ${(0,i.unref)(t)+56+36}px)`})),s=(0,i.computed)((()=>(a.value,"flex-auto"))),r=(0,i.computed)((()=>({height:l.value,overflowInBody:!a.value}))),c=(0,i.ref)(0),u=(0,i.computed)((()=>a.value?{}:{height:Math.max(c.value-(0,i.unref)((0,i.unref)(e.compensation)),e.tableMinHeight??0)})),d=a.value?()=>{}:e=>{c.value!==e&&(c.value=e,(0,o.S)())},m=a.value?()=>{}:t=>{0===c.value?setTimeout((()=>{d(t.height)}),e.delay??1200):d(t.height)};return{cardHeight:l,tableProps:u,onRectUpdate:m,rectHeight:c,cardFlexClass:s,cardProps:r}};t["Z"]=l},20809:function(e,t,a){var i=a(97434),n=a(58302);t["Z"]=()=>{const e=32,t=34,a=36,o=31,l=(0,i.ref)(0),s=e=>{l.value=e.height},r=(0,n.Z)({compensation:(0,i.computed)((()=>e+t+a+o)),fixedBlockHeightRefs:[l,25],tableMinHeight:100});return{tableHeightLogic:r,onTopCardRectUpdate:s}}},52140:function(e,t,a){a.d(t,{S:function(){return i},n:function(){return n}});const i=()=>{const e=document.createEvent("Event");e.initEvent("resize",!0,!0),window.dispatchEvent(e)},n=()=>{const{width:e,height:t}=document.body.getBoundingClientRect();return{width:e,height:t}}}}]);
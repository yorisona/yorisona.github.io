(self["webpackChunkgoumee_star_temp"]=self["webpackChunkgoumee_star_temp"]||[]).push([[4951],{9397:function(t,e,a){"use strict";a.d(e,{Z:function(){return u}});var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",attrs:{visible:t.visible,width:"440px","close-on-click-modal":!1,"destroy-on-close":!0},on:{close:t.close},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("不通过原因")]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{on:{click:t.close}},[t._v("取消")]),a("tg-button",{attrs:{disabled:""===t.refuse_reason,type:"primary"},on:{click:t.onConfirmClick}},[t._v("确定")])]},proxy:!0}])},[a("div",{staticStyle:{padding:"24px"}},[a("div",{staticClass:"textarea"},[a("el-input",{attrs:{type:"textarea",rows:3,maxLength:50,placeholder:"请输入不通过原因"},model:{value:t.refuse_reason,callback:function(e){t.refuse_reason="string"===typeof e?e.trim():e},expression:"refuse_reason"}})],1)])])},o=[],s=a(97434),i=(0,s.defineComponent)({setup(t,e){const a=(0,s.ref)(!1),n=(0,s.ref)(""),o=()=>{a.value=!1,n.value=""},i=()=>{a.value=!0},l=()=>{a.value=!1,e.emit("refuse",n.value)};return{visible:a,refuse_reason:n,open:i,close:o,onConfirmClick:l}}}),l=i,r=a(1001),c=(0,r.Z)(l,n,o,!1,null,null,null),u=c.exports},26037:function(t,e,a){"use strict";a.d(e,{Z:function(){return p}});var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tg-income-settlement-component-settlement-detail-other-income"},[a("div",{staticClass:"other-income-content"},t._l(t.dataFromCompanyList,(function(e,n){return a("div",{key:n,staticClass:"customer-list-row",class:6===t.dataForm.type||2===t.feeType?2===t.feeType?"cost-col-4":"col-4":"col-3"},[a("el-select",{ref:n===t.dataFromCompanyList.length-1?"companySelectRef":void 0,refInFor:!0,attrs:{value:e.company_name,size:"small",placeholder:2===t.feeType?"请输入并选择供应商":"请输入并选择客户","remote-method":t.getCompanyList,loading:t.companyLoading,filterable:"",remote:"","reserve-keyword":""},on:{change:function(e){return t.onCompanyChanged(e,n)}}},t._l(t.company_list,(function(e){return a("el-option",{key:e.id,attrs:{value:e.company_name,label:e.company_name,disabled:t.isOptionDisabled(e.id)}})})),1),a("el-input",{attrs:{placeholder:2===t.feeType?"填写成本":"填写收入",value:e.income_amount,size:"small"},on:{input:function(e){return t.onIncomeAmountChanged(e,n)}}},[a("template",{slot:"append"},[t._v("元")])],2),6===t.dataForm.type||2===t.feeType?a("el-input",{attrs:{placeholder:2===t.feeType?"填写成本说明":"填写收入说明",size:"small",maxlength:50},model:{value:e.remark,callback:function(a){t.$set(e,"remark",a)},expression:"company.remark"}}):t._e(),a("div",{staticClass:"del-btn-container"},[a("tg-icon",{staticClass:"del-btn",attrs:{name:"ico-btn-delete",disabled:1===t.dataFromCompanyList.length&&0===n},on:{click:function(e){return t.delCompany(n)}}})],1)],1)})),0),a("div",{staticClass:"bottom-content"},[a("tg-button",{attrs:{icon:"ico-btn-add",type:"default",size:"mini"},on:{click:t.onAdd}},[t._v(t._s(2===t.feeType?"添加供应商":"添加客户"))])],1)])},o=[],s=a(41572),i=a(79443),l=a(318),r=a(97434),c=(0,r.defineComponent)({props:{feeDetail:{type:Object},feeType:{type:Number,default:1}},setup(t,e){const a=(0,r.ref)(void 0),n=(0,r.computed)((()=>t.feeDetail)),o=(0,r.computed)((()=>((n.value?.company_list??[]).length||d.onAdd(),n.value?.company_list))),c=(0,r.ref)([]),u=(0,r.ref)(!1),d={onAdd:()=>{n.value?.company_list?.push({company_id:"",company_name:"",income_amount:"",remark:""}),(0,r.nextTick)((()=>{const t=a.value;if(t instanceof Array){const e=t[0];"focus"in e&&e.focus()}else"focus"in t&&t.focus()}))},delCompany:t=>{n.value?.company_list?.splice(t,1)},getCompanyList:async e=>{if(e){if(u.value=!0,2===t.feeType){const t=await(0,l.kg)({company_name:e,verify_status:1});t.data.success?c.value=(t.data.data??[]).map((t=>({id:t.company_id,company_name:t.company_name}))):c.value=[]}else{const t=await(0,i.sK)({company_name:e,page_num:1,num:1e4});t.data.success?c.value=t.data.data.data??[]:c.value=[]}u.value=!1}else c.value=[]},onCompanyChanged:(t,e)=>{if(n.value?.company_list){const a=n.value.company_list[e];a.company_name=t;const o=c.value.find((e=>e.company_name===t));a.company_id=o?.id}},reset:()=>{n.value&&(n.value.company_list=[])},isOptionDisabled:t=>{const e=n.value?.company_list?.find((e=>{if(t&&e.company_id)return`${e.company_id}`===`${t}`}));return!!e},onIncomeAmountChanged:(t,e)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(s.Pj,""))??[""])[0];n.value?.company_list&&(n.value.company_list[e].income_amount=a)}};return{dataFromCompanyList:o,company_list:c,companyLoading:u,dataForm:n,companySelectRef:a,...d}}}),u=c,d=a(1001),m=(0,d.Z)(u,n,o,!1,null,null,null),p=m.exports},34418:function(t,e,a){"use strict";a.d(e,{Z:function(){return f}});var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tg-income-settlement-component-settlement-detail-pit-fee"},[a("div",{staticClass:"pit-fee-content"},t._l(t.company_list,(function(e,n){return a("div",{key:n,staticClass:"customer-list-row"},[1===t.feeType?a("div",{staticClass:"row-label line-clamp-1"},[t._v(t._s(e.company_name))]):a("el-select",{ref:n===t.company_list.length-1?"companySelectRef":void 0,refInFor:!0,staticStyle:{"margin-right":"8px",width:"233px"},attrs:{value:e.company_name,size:"small",placeholder:"请输入并选择供应商","remote-method":t.getCompanyList,loading:t.companyLoading,filterable:"",remote:"","reserve-keyword":""},on:{change:function(e){return t.onCompanyChanged(e,n)}}},t._l(t.company_options,(function(e){return a("el-option",{key:e.company_id,attrs:{value:e.company_name,label:e.company_name,disabled:t.isOptionDisabled(e.company_id)}})})),1),a("el-input",{staticStyle:{width:"240px"},attrs:{placeholder:2===t.feeType?"填写成本":"填写收入",value:e.income_amount,size:"small"},on:{input:function(e){return t.onPitFeeChanged(e,n)}}},[a("template",{slot:"append"},[t._v("元")])],2),2===t.feeType?a("div",{staticClass:"del-btn-container"},[a("tg-icon",{staticClass:"del-btn",attrs:{name:"ico-btn-delete",disabled:1===t.company_list.length&&0===n},on:{click:function(e){return t.delCompany(n)}}})],1):t._e()],1)})),0),a("div",{class:1===t.feeType?"bottom-content":"cost-bottom-content"},[2===t.feeType?a("tg-button",{staticStyle:{"margin-right":"16px"},attrs:{icon:"ico-btn-add",type:"default",size:"mini"},on:{click:t.onAdd}},[t._v("添加供应商")]):t._e(),a("tg-button",{attrs:{type:"link",disabled:!t.company_list.length},on:{click:t.onDownloadDetail}},[t._v("下载商品明细")])],1)])},o=[],s=a(41572),i=a(79443),l=a(67957),r=a(97434),c=a(318),u=a(85937),d=a.n(u),m=(0,r.defineComponent)({props:{feeDetail:{type:Object},feeType:{type:Number,default:1}},setup(t,e){const a=(0,r.ref)(void 0),n=(0,r.computed)((()=>t.feeDetail)),o=(0,r.inject)("settlement")??(0,r.ref)(void 0),u=(0,r.computed)((()=>((n.value?.company_list??[]).length||2!==t.feeType||_.onAdd(),n.value?.company_list))),m=(0,r.ref)(!1),p=(0,r.ref)([]),_={onAdd:()=>{n.value?.company_list?.push({company_id:"",company_name:"",income_amount:"",remark:""}),(0,r.nextTick)((()=>{const t=a.value;if(t instanceof Array){const e=t[0];"focus"in e&&e.focus()}else"focus"in t&&t.focus()}))},onPitFeeChanged:(t,e)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(s.Pj,""))??[""])[0];u.value&&(u.value[e].income_amount=a)},getPitFee:async()=>{const a=await(0,i.HX)({project_id:o.value?.project_id??0,start_date:o.value?.start_date??0,end_date:o.value?.end_date??0,fee_type:t.feeType});if(a.data.success){if(n.value?.company_list)if(1===t.feeType)n.value.company_list=a.data.data.data.map((t=>({company_id:t.company_id,company_name:t.company_name,income_amount:t.sum_fee,remark:void 0})))??[];else if(2===t.feeType&&1===n.value?.company_list.length){const t=n.value.company_list[0],e=a.data.data?.data??[];e.length?t.income_amount=e.reduce(((t,e)=>t.add(e.sum_fee?e.sum_fee:0)),new(d())(0)).toFixed(2):t.income_amount=""}0===(n.value?.company_list??[]).length?e.root.$message.warning("该场次未归档或商品未维护坑位费，请先进行归档或坑位费维护哦"):e.root.$message.success(a.data.message??"获取坑位费成功")}else e.root.$message.error(a.data.message??"获取坑位费失败")},onDownloadDetail:()=>{u.value?.length&&window.open((0,l.e2)(o.value?.id,void 0,t.feeType))},reset:()=>{n.value&&(n.value.company_list=[])},getCompanyList:async t=>{if(!t)return void(p.value=[]);m.value=!0;const e=await(0,c.kg)({company_name:t,verify_status:1});e.data.success?p.value=e.data.data??[]:p.value=[],m.value=!1},onCompanyChanged:(t,e)=>{if(n.value?.company_list){const a=n.value.company_list[e];a.company_name=t;const o=p.value.find((e=>e.company_name===t));a.company_id=o?.company_id,1===n.value?.company_list.length&&_.getPitFee()}},isOptionDisabled:t=>{const e=n.value?.company_list?.find((e=>{if(t&&e.company_id)return`${e.company_id}`===`${t}`}));return!!e},delCompany:t=>{n.value?.company_list?.splice(t,1)}};return(0,r.onMounted)((()=>{n.value?.company_list?.length||1!==t.feeType||_.getPitFee()})),{dataForm:n,company_list:u,companyLoading:m,company_options:p,companySelectRef:a,..._}}}),p=m,_=a(1001),v=(0,_.Z)(p,n,o,!1,null,null,null),f=v.exports},10114:function(t,e,a){"use strict";a.d(e,{Z:function(){return d}});var n=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new tg-write-off-confirm-dialog",attrs:{visible:t.visible,"close-on-click-modal":!1,width:"440px"},on:{close:t.close},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("单据冲销")]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{on:{click:t.close}},[t._v("取消")]),a("tg-button",{attrs:{type:"primary",disabled:t.isConfirmButtonDisabled},on:{click:t.onConfirm}},[t._v("保存")])]},proxy:!0}])},[a("div",{staticStyle:{padding:"24px"}},[a("div",{staticClass:"star"},[t._v("冲销原因")]),a("div",{staticStyle:{"margin-top":"7px"}},[a("el-input",{attrs:{type:"textarea",placeholder:"请输入冲销原因",clearable:"",maxlength:100,"show-word-limit":""},model:{value:t.reverse_reason,callback:function(e){t.reverse_reason=e},expression:"reverse_reason"}})],1)])])},o=[],s=a(97434),i=a(58861),l=(0,s.defineComponent)({setup(t,e){const a=(0,s.ref)(""),n=(0,s.ref)(null),{visible:o,setVisible:l}=(0,i.Z)(),r=()=>{a.value="",l()},c=(0,s.computed)((()=>""===a.value.trim())),u=async()=>{if(""===a.value.trim())return void e.root.$message.warning("请填写冲销原因");const t=await(n.value?.(a.value));t&&(a.value="",l())},d=(t,e="")=>{a.value=e,n.value=t,l(!0)};return{visible:o,open:d,reverse_reason:a,close:r,onConfirm:u,isConfirmButtonDisabled:c}}}),r=l,c=a(1001),u=(0,c.Z)(r,n,o,!1,null,null,null),d=u.exports},5648:function(t,e,a){"use strict";a.d(e,{DC:function(){return m},JM:function(){return _},MK:function(){return v},OH:function(){return d},WC:function(){return x},WW:function(){return f},cT:function(){return s},dD:function(){return u},fd:function(){return g},h9:function(){return y},j1:function(){return l},lQ:function(){return i},oR:function(){return c},vx:function(){return p},xH:function(){return r}});var n=a(76012),o=a(74750);function s(t){return(0,n.ZP)({url:"/api/medium/upload_file",method:"post",data:t,timeout:36e5})}function i(t){return(0,n.ZP)({url:"/api/medium/add_company",method:"post",data:t})}function l(t){return(0,n.ZP)({url:"/api/medium/update_company",method:"post",data:t})}function r(t){return(0,n.ZP)({url:"/api/medium/query_company_list",method:"get",params:t})}function c(t){return(0,n.ZP)({url:"/api/medium/delete_company",method:"post",data:t})}function u(t){return(0,n.ZP)({url:"/api/medium/company_detail",method:"get",params:t})}function d(t){const e=(0,o.LP)();window.open(`https://data.goumee.com/api/medium/export_company?ids=${t.ids}&Authorization=${e}`)}function m(t){return(0,n.ZP)({url:"/api/kol/save_kol",method:"post",data:t})}function p(t){return(0,n.ZP)({url:"/api/kol/query_kol",method:"get",params:t})}function _(t){return(0,n.ZP)({url:"/api/kol/delete_kol",method:"post",data:t})}function v(t){const e=(0,o.LP)();let a="";for(const n in t)t[n]&&(a+=`&${n}=${t[n]}`);a=a.substr(1,a.length),window.open(`https://data.goumee.com/api/kol/export_kols?${a}&Authorization=${e}`)}function f(t){return(0,n.ZP)({url:"/api/kol/upload_case",method:"post",data:t})}function y(t){return(0,n.ZP)({url:"/api/kol/upload_photo",method:"post",data:t})}function g(t){return(0,n.ZP)({url:"/api/medium/get_company_name_and_id",method:"get",params:t})}function x(t){return(0,n.ZP)({url:"/api/kol/approval_kol",method:"post",data:t})}},42413:function(t,e,a){"use strict";a.d(e,{Ut:function(){return c},XX:function(){return d},fv:function(){return u},kN:function(){return m},r7:function(){return p},sO:function(){return r}});a(26699);var n=a(64236),o=a(74750),s=a(85937),i=a.n(s);const l={headers:{Authorization:(0,o.LP)()??""}},r=t=>{const e=t||[],a=(e.length>0?e.reduce(((t,e)=>new(i())(e.adjust_amount&&!["","-",".","-."].includes(e.adjust_amount)?e.adjust_amount:"0").add(t)),new(i())("0")):new(i())("0")).toString();return a},c=(t,e)=>{const a=r(e),n=t.reduce(((t,e)=>new(i())(e||0).add(t)),new(i())("0"));return n.add(a)},u=(t,e)=>{const a=new(i())(e&&""!==e?e:"0"),n=new(i())(t&&""!==t?t:"0.00");return n.mul(a).toFixed(2).toString()},d=(t,e,a)=>{const n=new(i())(a&&""!==a?a:"0").div(100),o=new(i())(e&&""!==e?e:"0.00").mul(n),s=new(i())(t&&""!==t?t:"0.00");return o.greaterThan(s)?o.toFixed(2).toString():s.toFixed(2).toString()},m=(t,e,a)=>{const n=new(i())(a&&""!==a?a:0).div(100),o=new(i())(e&&""!==e?e:"0.00").mul(n),s=new(i())(t&&""!==t?t:"0.00");return o.add(s).toFixed(2).toString()},p=t=>{const e=(e,a="")=>{fetch(e,l).then((async o=>{const s=o.clone();try{const e=await s.json();t.root.$message.error(e.message)}catch{if(200===o.status){const t=await o.blob();let s=e.split("/")[e.split("/").length-1];try{s=decodeURI(s)}catch(i){}const l=""!==a?a:s;(0,n.uA)(t,l)}else t.root.$message.error("下载失败")}}))};return{downloadFileHandler:e}}},64951:function(t,e,a){"use strict";a.d(e,{Z:function(){return Lo}});a(26699);var n=a(97434),o=a(28348),s=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",class:[t.dialogClass],attrs:{visible:t.dialogVisible,width:t.dialogWidth,height:"760px","before-close":t.beforeClose,"lock-scroll":"","close-on-click-modal":!1,"close-on-press-escape":!1,"destroy-on-close":""},on:{close:t.close},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本结算")]},proxy:!0}])},[a("div",{staticClass:"settlement-dialog-content"},[a("div",{staticClass:"steps-line"},[a("div",{staticClass:"steps",class:t.is_virtual_receipt?"plus":"normal"},[t._l(t.steps,(function(e,n){return[a("div",{key:n,staticClass:"step",class:{finish:n<t.activeNumber,process:n===t.activeNumber,wait:n>t.activeNumber}},[n<t.activeNumber?a("div",{staticClass:"step-icon"},[a("tg-icon",{attrs:{name:"ico-right"}})],1):a("div",{staticClass:"step-icon"},[t._v(t._s(n+1))]),a("div",{staticClass:"step-title"},[t._v(t._s(e.title))])]),n<2?[a("div",{key:"line-"+n,staticClass:"step-line"})]:t._e()]}))],2)]),a(t.formComponent,{ref:"stepCompRef",tag:"component",staticClass:"settlement-dialog-content-main",on:{cancel:t.close,prev:t.prev,next:t.next,setDialogVisible:t.setDialogVisible,"submit:success":t.onSubmitSuccess}})],1)])},i=[],l=a(89852),r=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"settlement-cost-basic-info"},[a("div",{staticClass:"settlement-cost-basic-info-content"},[t.settlement||1===t.is_estimate_mode?a("div",{staticClass:"top"},[a("span",{staticClass:"big-tips"},[t._v(t._s(t.toptext))]),a("span",{staticClass:"tips mgl-12"},[t._v(t._s(t.tips))])]):a("el-form",{staticStyle:{"font-size":"14px","padding-top":"20px"}},[a("el-form-item",{attrs:{label:"结算方式："}},[a("el-radio-group",{staticStyle:{display:"inline-block"},model:{value:t.Step1Frm.settlement_way,callback:function(e){t.$set(t.Step1Frm,"settlement_way",e)},expression:"Step1Frm.settlement_way"}},t._l([{label:"普通结算",value:"1"},{label:"替换暂估结算",value:"2"}],(function(e){return a("el-radio",{key:e.value,attrs:{label:e.value}},[t._v(t._s(e.label))])})),1)],1),"1"===t.Step1Frm.settlement_way?a("el-form-item",{staticStyle:{color:"#a4b2c2"},attrs:{label:"收入结算："}},[a("span",[t._v("请选择对应的收入结算（如果没有可选择的收入结算，请先发起对应的收入结算并填写结算数据保存）")])]):t._e(),"2"===t.Step1Frm.settlement_way?a("el-form-item",{staticStyle:{color:"#a4b2c2"},attrs:{label:"成本结算："}},["2"===t.Step1Frm.settlement_way?a("span",[t._v("被替换的周期内的暂估结算未确认，会被删除；如已确认，会被冲销")]):t._e()]):t._e(),"2"===t.Step1Frm.settlement_way?a("el-form-item",{attrs:{label:"替换方式："}},[a("el-radio-group",{staticStyle:{"line-height":"32px",height:"32px"},model:{value:t.settlement_replace_way,callback:function(e){t.settlement_replace_way=e},expression:"settlement_replace_way"}},[a("el-radio",{attrs:{label:0}},[t._v("替换结算周期")]),a("el-radio",{attrs:{label:1}},[t._v("替换结算单")])],1)],1):t._e()],1),"1"===t.Step1Frm.settlement_way?a("el-table",{style:"width: "+t.table_width+"px",attrs:{stripe:"",data:t.data,height:410},on:{"row-click":t.onRowClick},scopedSlots:t._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"请先创建收入结算，再进行成本结算"}})]},proxy:!0}],null,!1,781471746)},t._l(t.columns,(function(e,n){return a("el-table-column",t._b({key:n},"el-table-column",e,!1))})),1):t._e(),"2"===t.Step1Frm.settlement_way?a("div",[0===t.settlement_replace_way&&0===t.ReplaceSettlementDateList.length?a("div",{staticStyle:{width:"235px",margin:"0 auto","margin-top":"60px"}},[a("empty-common",{attrs:{"detial-text":"暂无结算周期"}})],1):t._e(),1===t.settlement_replace_way&&0===t.ReplaceIdsSettlementDateList.length?a("div",{staticStyle:{width:"235px",margin:"0 auto","margin-top":"60px"}},[a("empty-common",{attrs:{"detial-text":"暂无暂估结算单"}})],1):a("div",{staticStyle:{margin:"0 78px"}},[a("el-radio-group",{staticStyle:{display:"grid","grid-template-columns":"100%","max-height":"350px","overflow-y":"scroll"},model:{value:t.replace_settlement_date_str,callback:function(e){t.replace_settlement_date_str=e},expression:"replace_settlement_date_str"}},[t._l(0===t.settlement_replace_way?t.ReplaceSettlementDateList:t.ReplaceIdsSettlementDateList,(function(e){return[e.settlement_type!==t.SettlementType.s2b2c_douyin_cps?a("el-radio",{key:e.value,staticStyle:{height:"35px","line-height":"35px","padding-right":"73px",display:"block"},attrs:{label:e.value}},[t._v(t._s(e.label))]):t._e()]}))],2)],1)]):t._e()],1),a("div",{staticClass:"bottom-button-line"},[a("tg-button",{on:{click:t.prev}},[t._v("取消")]),a("tg-button",{attrs:{type:"primary",disabled:0===t.data.length},on:{click:t.next}},[t._v("下一步")])],1),a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})],1)},c=[],u=a(32662),d=a(6933),m=a.n(d),p=a(85937),_=a.n(p),v=a(61282),f=a(64236),y=a(79443),g=a(8136),x=a(29625);const h=t=>""+(0,v.SJ)(new(_())(t.tax_included_amount??0));var b=(0,n.defineComponent)({data(){return{toptext:"请选择对应的收入结算",tips:"如果没有可选择的收入结算，请先发起对应的收入结算并填写结算数据保存"}},setup(t,e){const a=(0,n.inject)("settlement")??(0,n.ref)(void 0),s=JSON.stringify((0,n.inject)("project3in1",{cooperation_type:0})),i=JSON.parse(s),r=2===i.value?.cooperation_type,{isFromMarketing:c,project_id:d,project_type:p}=(0,l.L)(e),_=(0,n.inject)("project3in1")??(0,n.ref)(void 0),{loading:v,data:b,total:k,loadDataAll:C}=(0,u.W)(p),S=(0,n.ref)(void 0),w=(0,n.ref)(void 0),j=(0,n.ref)(void 0),D=(0,n.computed)((()=>void 0!==S.value)),F=(0,n.computed)((()=>D.value&&S.value!==j.value)),$=(0,n.ref)(0),A=(0,n.ref)({settlement_way:"1",business_type:x.WD.marketing}),I=(0,n.ref)(""),L=(0,n.ref)([]),N=(0,n.ref)([]),T=async t=>{const[{data:a}]=await(0,f.Dc)(200,(0,y.fO)((0,n.unref)(p),t));if(a&&a.success){const t=new Map;N.value=[],a.data.data.forEach((e=>{const a=(0,g.xF)(1e3*e.start_date,"YYYY.MM.DD")+" ~ "+(0,g.xF)(1e3*e.end_date,"YYYY.MM.DD");t.has(a)||(t.set(a,!0),L.value.push({label:a,value:a,settlement_type:e.settlement_type})),0===e.is_tmp&&N.value.push({label:`${e.settlement_uid} ${e.company_name} ${a} ${"￥"+(e.tax_included_amount||"0")} `,value:e.id.toString()+":"+a,settlement_type:e.settlement_type})}))}else e.root.$message.warning(a.message)},z=()=>{const t=A.value.business_type,e={project_id:d.value,settlement_kind:o.Qn.cost,no_reverse:1,is_estimate:1,business_type:t};return e};(0,n.watch)((()=>A.value.settlement_way),(t=>{if(t&&"2"===A.value.settlement_way){L.value=[];const t=z();T(t)}}));const B=async(t,e)=>{await C({project_id:d.value,no_reverse:1,is_tmp:0}),"live"===_.value?.project__type?_.value.business_type===x.WD.douyin?A.value.business_type=x.WD.douyin:_.value.business_type===x.WD.taobao&&(A.value.business_type=x.WD.taobao):"marketing"===_.value?.project__type?A.value.business_type=x.WD.marketing:"common"===_.value?.project__type&&(A.value.business_type=x.WD.mcn),void 0===t?(S.value=void 0,j.value=void 0,w.value=void 0,1===e&&($.value=1)):($.value=t.is_estimate,S.value=t.related_income_settlement_id,j.value=t.related_income_settlement_id,w.value=b.value.find((e=>e.id===t.related_income_settlement_id)))},P=(0,n.computed)((()=>b.value)),O=(0,n.computed)((()=>void 0!==a.value&&null!==a.value.super_settlement_id)),R=t=>{console.log(a),O.value||(S.value=t.id,w.value={...t})},M=(0,n.ref)(c.value||r),Z=(0,n.computed)((()=>[{label:"选择",align:"center",width:60,formatter:t=>(0,n.h)("el-radio",{props:{value:S.value,label:t.id,size:"mini",disabled:O.value},nativeOn:{click:()=>{O.value||R(t)}}})},{label:"结算编号",property:"settlement_uid",align:"left",width:M.value?180:284},{label:"结算周期",property:"start_date",align:"center",width:M.value?230:286,formatter:t=>[t.start_date,t.end_date].map((t=>m()(1e3*t).format("YYYY.MM.DD"))).join(" ~ ")},{label:"结算金额 (元)",property:"total_settle_amount",align:"right",width:170,formatter:h},{width:134},{label:"结算状态",property:"status",align:"center",width:118,formatter:t=>{const{status:e}=t,a=e===o.ne.unsubmit?"fg-cancel":e===o.ne.wait_confirm?"fg-waiting":e===o.ne.confirmed?"fg-success":"fg-failure";return(0,n.h)("span",{class:a},o.D_.get(e)??"--")}}])),G=async()=>{e.emit("cancel")},E=(0,n.ref)(!1),J=async()=>{if("finance"===p.value||"finance_cost"===p.value)return;if(void 0===S.value||void 0===w.value)return void e.root.$message.warning("请选择收入结算");const t={id:a.value?.id,settlement_type:w.value.settlement_type,related_income_settlement_id:S.value};1===$.value&&(t.is_estimate=1),E.value=!0;const[{data:n}]=await(0,f.Dc)(400,(0,y.vb)(p.value,t));if(n&&n.success){const t=Y(n.data.id);return t}return E.value=!1,n},Y=async t=>{const[{data:e}]=await(0,f.Dc)(400,(0,y.S_)(p.value,{id:t}));return E.value=!1,e},H=t=>t&&t.success?(e.root.$message.success("保存成功"),e.emit("next",t.data),!0):!(!t||!1!==t.success)&&(e.root.$message.error(t.message??"保存失败"),!1),q=async()=>{if(""===I.value)return void e.root.$message.warning(1===Q.value?"请选择暂估结算单":"请选择暂估结算周期");let t={};if(0===Q.value){const[e,a]=I.value.split(" ~ ");t={project_id:d.value.toString(),start_date:e.replace(/\./g,"-"),end_date:a.replace(/\./g,"-")}}else{const[e,a]=I.value.split(":"),[n,o]=a.split(" ~ ");t={project_id:d.value.toString(),start_date:n.replace(/\./g,"-"),end_date:o.replace(/\./g,"-"),settlement_id:Number(e)}}const a=A.value.business_type===x.WD.marketing?y.z1:[x.WD.taobao,x.WD.douyin].includes(A.value.business_type)?y.cE:y.Kz;E.value=!0;const[{data:n}]=await Promise.all([await a(t),await(0,f._v)(500)]);if(n.success){const t=Y(n.data.id);return t}return E.value=!1,n},U=async()=>{if("1"===A.value.settlement_way){const t=await J();return H(t)}{const t=await q();return H(t)}},K=async()=>{!D.value||F.value?await U():e.emit("next")},W=async()=>await U(),V=async()=>F.value,X=(0,n.computed)((()=>M.value?894:1052)),Q=(0,n.ref)(0);return{settlement_replace_way:Q,is_estimate_mode:$,ReplaceIdsSettlementDateList:N,ReplaceSettlementDateList:L,replace_settlement_date_str:I,Step1Frm:A,settlement:a,columns:Z,project_id:d,project:_,loading:v,data:P,onRowClick:R,total:k,loadDataAll:C,fillForm:B,saveLoading:E,prev:G,next:K,saveBeforeClose:W,confirmBeforeClose:V,table_width:X,SettlementType:o.kX}}}),k=b,C=a(1001),S=(0,C.Z)(k,r,c,!1,null,"58ffed69",null),w=S.exports,j=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("Step2Layout",{attrs:{amount:t.total_settle_amount},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_settle_amount,taxed:t.TaxDataForm.is_include_tax,type:"value1",tax_rate_disabled:!1,tax_rate:t.TaxDataForm.tax_rate},on:{taxedChanged:t.taxedChanged,taxRateChanged:t.taxRateChanged,valueChange:t.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本信息")]},proxy:!0}])},[a("div",{staticClass:"marketing-cost-form"},[a("el-form",{ref:"step2FrmRef",attrs:{model:t.step2Frm,rules:t.step2FrmRules,size:"small","label-width":"62px"}},[a("el-form-item",{attrs:{prop:"company_id",label:"供应商"}},[a("el-select",{attrs:{filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入并选择公司名称","remote-method":t.getAllCompanyName,size:"small","popper-class":"markting-cost-step2-supplierSelect"},on:{change:t.onCompanyIdChange},model:{value:t.company_name,callback:function(e){t.company_name=e},expression:"company_name"}},t._l(t.allCompanyName,(function(e,n){return a("el-option",{key:n,attrs:{label:e.company_name,value:e.company_id}},[a("span",[t._v(t._s(e.company_name))])])})),1)],1),a("el-form-item",{attrs:{label:"支出"}},[a("div",[t._v(t._s(t.spend_amount)+" 元")])]),a("el-form-item",{attrs:{label:"支出",prop:"spend_amount"}},[a("el-input",{attrs:{size:"small",placeholder:"0.00"},on:{input:t.inputSpendAmount},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("元")]},proxy:!0}]),model:{value:t.step2Frm.spend_amount,callback:function(e){t.$set(t.step2Frm,"spend_amount",e)},expression:"step2Frm.spend_amount"}})],1)],1)],1)])]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"}},[t.ShowAdjustInfo?a("AdjustAccount",{attrs:{height:350,adjust_info:t.step2Frm.adjust_info},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},D=[],F=(a(21703),a(32851)),$=a(99048),A=a(97457),I=a(41572),L=a(44542),N=a(94559),T=a(5648);const z=t=>[null,void 0,"undefined","null","","-","-."].includes(t)?"0.00":t;var B=(0,n.defineComponent)({components:{Step2Layout:F.Z,CardLayout:$.Z,AdjustAccount:A.Z,TopCard:N.Z},setup(t,e){const a=(0,n.inject)("settlement")??(0,n.ref)(void 0),{isFromMarketing:s}=(0,l.L)(e),i=(0,n.ref)(null),r=(0,n.ref)({spend_amount:"",adjust_info:[],company_id:""}),c=(0,n.ref)(""),u=(0,n.ref)({is_include_tax:1,tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",tax_amount:""}),d=(0,n.computed)((()=>""===r.value.spend_amount?"0.00":(0,v.SJ)(new p.Decimal(z(r.value.spend_amount))))),m=(0,n.computed)((()=>r.value.adjust_info.filter((t=>""!==t.adjust_reason&&""!==t.adjust_amount)).reduce(((t,e)=>t.add(new p.Decimal(z(e.adjust_amount)))),new p.Decimal(0)))),_=(0,n.ref)({company_id:[{required:!0,message:"请选择供应商",trigger:"change"}],spend_amount:[{validator:(t,e,a)=>{""===e?a():/^\d+(?:\.\d{0,2})?$/u.test(e)?new p.Decimal(e).eq(0)&&m.value.eq(0)?a(new Error("请填写支出或者手工调账")):a():a(new Error("请输入正确的数字"))},trigger:"blur"}]}),g=(0,n.ref)({spend_amount:"",adjust_info:[],company_id:""}),x=()=>{r.value.spend_amount="",r.value.adjust_info=[]},h=()=>{g.value.spend_amount="",g.value.adjust_info=[]},b=(0,n.ref)({is_include_tax:1,tax_rate:"",tax_included_amount:"",tax_excluded_amount:"",tax_amount:""}),k=(0,n.computed)((()=>JSON.stringify(g.value)!==JSON.stringify(r.value))),C=(0,n.ref)(!1),S=async t=>{x(),h(),C.value=!0;const{spend_amount:e,adjust_info:a}=t;u.value.is_include_tax=0===t.is_include_tax?0:1,u.value.tax_rate=t.tax_rate?t.tax_rate.toString():"0",u.value.tax_included_amount=t.tax_included_amount?.toString(),u.value.tax_excluded_amount=t.tax_excluded_amount?.toString(),u.value.tax_amount=new p.Decimal(z(t.tax_amount?.toString()??"0")).toFixed(2),b.value.is_include_tax=0===t.is_include_tax?0:1,b.value.tax_rate=t.tax_rate?t.tax_rate.toString():"0",b.value.tax_included_amount=t.tax_included_amount?.toString(),b.value.tax_excluded_amount=t.tax_excluded_amount?.toString(),b.value.tax_amount=new p.Decimal(z(t.tax_amount?.toString()??"0")).toFixed(2),r.value.spend_amount=`${e??0}`,r.value.adjust_info=a.map((t=>({...t}))),r.value.company_id=t.company_id?t.company_id.toString():"",g.value.company_id=t.company_id?t.company_id.toString():"",g.value.spend_amount=`${e??0}`,g.value.adjust_info=a.map((t=>({...t}))),t.company_name&&(c.value=t.company_name,await K(t.company_name))},w=(0,n.computed)((()=>JSON.stringify({tax_amount:u.value.tax_amount,tax_rate:u.value.tax_rate,is_include_tax:u.value.is_include_tax})!==JSON.stringify({tax_amount:b.value.tax_amount,tax_rate:b.value.tax_rate,is_include_tax:b.value.is_include_tax}))),j=(0,n.computed)((()=>p.Decimal.add(new p.Decimal(z(r.value.spend_amount??"0")),r.value.adjust_info.map((t=>new p.Decimal(z(t.adjust_amount??"0")))).reduce(((t,e)=>t.add(e)),new p.Decimal(0))))),D=(0,n.computed)((()=>j.value.toString())),F=t=>{const e=/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(I.Pj,""))??[""];r.value.spend_amount=e[0]},$=t=>{r.value.adjust_info=t.map((t=>({...t})))},A=(0,n.ref)(!1),N=(0,n.computed)((()=>""!==r.value.spend_amount||r.value.adjust_info.filter((t=>""!==t.adjust_amount&&""!==t.adjust_reason)).length>0)),B=async()=>{if(!N.value)return e.root.$message.warning("请填写至少一项结算项"),!1;const t=await(0,L.G)(i);if(!t)return!1;const{adjust_info:a}=r.value,n=a.filter((t=>!(""===t.adjust_amount&&""===t.adjust_reason)));return void 0!==n.find((t=>""!==t.adjust_reason&&""===t.adjust_amount))?(e.root.$message.warning("请输入调整金额"),!1):void 0!==n.find((t=>""!==t.adjust_reason&&new p.Decimal(z(t.adjust_amount)??"0").eq(0)))?(e.root.$message.warning("调整金额不能为0"),!1):void 0!==n.find((t=>""!==t.adjust_amount&&""===t.adjust_reason))?(e.root.$message.warning("请输入调整原因"),!1):!j.value.lte(0)||(e.root.$message.warning("总结算金额不能小于等于0"),!1)},P=(0,n.inject)("project3in1")??(0,n.ref)(void 0),O=async t=>{if(A.value)return;if(!P.value)return;const a=Number(P.value.business_type);A.value=!0;const[{data:n}]=await(0,f.Dc)(500,(0,y.bp)(t,a));return A.value=!1,n.success?e.emit("next",n.data):e.root.$message.error(n.message??"保存失败"),n},R=async t=>{if(void 0===a.value)return void console.warn("不存在结算数据");if(!N.value&&t)return void e.root.$message.warning("请填写至少一项结算项");const n=await(0,L.G)(i);if(!n&&t)return;const{adjust_info:l,spend_amount:c}=r.value,d=l.filter((t=>!(""===t.adjust_amount&&""===t.adjust_reason)));if(void 0!==d.find((t=>""!==t.adjust_reason&&""===t.adjust_amount))&&t)return void e.root.$message.warning("请输入调整金额");if(void 0!==d.find((t=>""!==t.adjust_reason&&new p.Decimal(z(t.adjust_amount)??"0").eq(0)))&&t)return void e.root.$message.warning("调整金额不能为0");if(void 0!==d.find((t=>""!==t.adjust_amount&&""===t.adjust_reason))&&t)return void e.root.$message.warning("请输入调整原因");if(j.value.lte(0))return void e.root.$message.warning("总结算金额不能小于等于0");const m=j.value.toString(),_={id:a.value.id,spend_amount:""===c?"0":c,total_settle_amount:m,adjust_info:d,step:t?o.br.step_three:a.value.step,company_id:r.value.company_id,is_include_tax:u.value.is_include_tax,tax_rate:""===u.value.tax_rate?"0":u.value.tax_rate??"0",tax_included_amount:u.value.tax_included_amount,tax_excluded_amount:u.value.tax_excluded_amount,tax_amount:u.value.tax_amount};if(s.value){A.value=!0;const[{data:t}]=await(0,f.Dc)(500,(0,y.a9)(_));return A.value=!1,t}O(_)},M=async()=>{if(!w.value&&!k.value&&N.value)return void e.emit("prev");const t=await R(!1);return!!t?.success&&(e.root.$message.success("保存成功"),e.emit("prev",t.data),!0)},Z=async()=>{const t=await B();if(!t)return;if(!w.value&&!k.value&&N.value)return void e.emit("next");const a=await R(!0);a?.success?(e.root.$message.success("保存成功"),e.emit("next",a.data)):!1===a?.success&&e.root.$message.error(a.message??"保存失败")},G=async()=>{const t=await R(!1);return!!t?.success&&(e.root.$message.success("保存成功"),e.emit("next",t.data),!0)},E=async()=>w.value||k.value,J=t=>{u.value.is_include_tax=t},Y=t=>{u.value.tax_included_amount=t.tax_included_amount,u.value.tax_excluded_amount=t.tax_excluded_amount,u.value.tax_amount=t.tax_amount},H=t=>{u.value.tax_rate=t},q=(0,n.ref)([]),U=t=>{r.value.company_id=t},K=async t=>{const{data:e}=await(0,T.fd)({company_name:t,verify_status:1});q.value=e.success?e.data:[]};return{allCompanyName:q,getAllCompanyName:K,onCompanyIdChange:U,taxRateChanged:H,taxValueChangeHandler:Y,amount:j,ShowAdjustInfo:C,total_settle_amount:D,step2FrmRef:i,step2Frm:r,step2FrmRules:_,originalFrmData:g,spend_amount:d,inputSpendAmount:F,onAdjustAccountDataChange:$,prev:M,next:Z,confirmBeforeClose:E,saveBeforeClose:G,saveLoading:A,saveStep2Data:R,fillForm:S,TaxDataForm:u,taxedChanged:J,company_name:c}}}),P=B,O=(0,C.Z)(P,j,D,!1,null,"47741272",null),R=O.exports,M=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"settlement-step3-marketing",class:1===t.settlement.is_estimate?"is_estimate":"",attrs:{amount:t.total_settle_amount},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_settle_amount,taxed:t.DataForm.is_include_tax,tax_rate:t.DataForm.tax_rate,name:t.DataForm.company_name,name_desc:"供应商：",type:"value2"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本信息")]},proxy:!0}])},[a("div",{staticClass:"income-amount"},[a("span",[t._v("支出")]),a("span",{staticStyle:{margin:"0 4px","font-weight":"600"}},[t._v(t._s(t.spend_amount))]),a("span",{staticStyle:{"font-weight":"600"}},[t._v("元")])])])]},proxy:!0},{key:"right",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("手工调账")]},proxy:!0}])},[a("div",{staticClass:"adjust-info-content"},[a("div",{staticClass:"adjust-info-total"},[a("div",{staticClass:"adjust-info-total-lbl"},[t._v("调账 "+t._s(t.adjust_info.length)+" 笔")]),a("div",{staticClass:"adjust-info-total-amount"},[a("strong",[t._v("共 "+t._s(t.adjust_info_amount_total)+" 元")])])]),a("div",{staticClass:"adjust-info-line"}),a("div",{staticClass:"adjust-info-list"},[t._l(t.adjust_info,(function(e,n){return[a("div",{key:n,staticClass:"adjust-info-item"},[a("span",[t._v(t._s(n+1)+". ")]),a("span",[t._v("调整金额：")]),a("span",[t._v(t._s(e.adjust_amount)+" 元")]),a("span",[t._v("；调整原因：")]),a("span",[t._v(t._s(e.adjust_reason))])])]}))],2)])])]},proxy:!0},1!==t.settlement.is_estimate?{key:"files",fn:function(){return[t.readonly?t._e():a("el-form",{ref:"step3FrmRef",attrs:{model:t.step3Frm,rules:t.step3FrmRules}},[a("el-form-item",{staticClass:"form-item-settlement-files",staticStyle:{"margin-bottom":"12px"},attrs:{label:"结算单：",prop:"settlement_files","label-width":"70px"}},[a("div",{staticClass:"form-item-content"},[a("el-upload",{staticStyle:{height:"32px"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"before-upload":t.beforeUpload,"http-request":t.uploadFileHandler,accept:".docx,.pdf,.jpg,.jpeg,.png,.xlsx,.xls",disabled:t.isFileUploaderDisabled},model:{value:t.step3Frm.settlement_files,callback:function(e){t.$set(t.step3Frm,"settlement_files",e)},expression:"step3Frm.settlement_files"}},[a("tg-button",{attrs:{size:"medium",icon:"ico-btn-upload",disabled:t.isFileUploaderDisabled}},[t._v("上传文件")])],1),a("div",{staticClass:"upload-tips"},[t._v(" 支持 .docx .pdf .jpg .png .xlsx .xls,最多上传5个文件(单个文件大小不超过30M) ")])],1)])],1),a("div",{staticClass:"settlement-uploaded-files-container",style:t.readonly?"":"margin-left: 66px"},[t.step3Frm.settlement_files&&t.step3Frm.settlement_files.length>0?a("div",{staticClass:"settlement-uploaded-lbl",staticStyle:{color:"#6a7b92"},style:{paddingRight:t.readonly?"0px":"0",marginBottom:t.readonly?"10px":"0px"}},[t._v(" "+t._s(t.readonly?"结算单：":" ")+" ")]):t._e(),a("div",{staticClass:"settlement-uploaded-files",style:{marginBottom:t.step3Frm.settlement_files&&t.step3Frm.settlement_files.length>0?"5px":"0px"}},[t._l(t.step3Frm.settlement_files,(function(e,n){return[a("FileItem",{key:n,attrs:{showPreview:0!==t.settlement.status,filepath:e,readonly:t.readonly},on:{remove:function(e){return t.onRemoveFile(n)}}})]}))],2)]),a("el-form",{staticStyle:{"margin-top":"10px"},attrs:{size:"mini"}},[a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"关联合同："}},[t.readonly?a("div",{staticStyle:{display:"flex","align-items":"center",color:"#3c5269"}},[t.step3Frm.contract_id&&t.contract_info.sign_type_name?a("div",[t._v(" "+t._s(t.contract_info.sign_type_name+": "+t.contract_info.contract_uid+" ("+t.contract_info.coop_start_date+"-"+t.contract_info.coop_end_date+")")+" ")]):a("div",[t._v("--")])]):a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},style:{marginLeft:t.readonly&&!t.isFromMarketing?"10px":"0px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:t.readonly?"--":"请输入合同编码","remote-method":t.getContract,size:"medium",disabled:t.readonly},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.step3Frm.contract_id,callback:function(e){t.$set(t.step3Frm,"contract_id",e)},expression:"step3Frm.contract_id"}},t._l(t.contract_uids,(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.sign_type_name+":  "+t.contract_uid+"  ("+t.coop_start_date+"-"+t.coop_end_date+")",value:t.contract_id}})})),1)],1)])],1)]},proxy:!0}:null,t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.submit}},[t._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},Z=[],G=a(28966),E=a(80391),J=a(82741),Y=a(25300),H=a(48606),q=a(83005),U=(0,n.defineComponent)({props:{readonly:{type:Boolean,default:!1}},components:{SettlementStep3Layout:G.Z,CardLayout:$.Z,TopCard:N.Z},setup(t,e){const a=(0,n.inject)("settlement")??(0,n.ref)(void 0);let s;const i=()=>{s=H.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},{isFromMarketing:r}=(0,l.L)(e),c=(0,n.ref)(null),u=(0,n.ref)({settlement_files:[],contract_id:void 0}),d=(0,n.ref)({contract_uid:void 0,coop_start_date:void 0,coop_end_date:void 0,sign_type_name:void 0}),m=(0,n.computed)((()=>({settlement_files:t.readonly?[]:[{required:!0,message:"请上传结算单",trigger:"blur"}]}))),p=(0,n.ref)({settlement_files:[],contract_id:void 0}),g=(0,n.ref)({company_name:"",tax_rate:"",is_include_tax:1}),x=()=>{u.value.settlement_files=[],u.value.contract_id=void 0},h=()=>{p.value.settlement_files=[],p.value.contract_id=void 0},b=(0,n.computed)((()=>JSON.stringify((0,Y.get)(p))!==JSON.stringify((0,Y.get)(u)))),k=t=>{x(),h();const{settlement_files:e}=t;g.value.company_name=t.company_name,g.value.tax_rate=t.tax_rate?.toString()??"",g.value.is_include_tax=0===t.is_include_tax?0:1,u.value.settlement_files=e.map((t=>t)),u.value.contract_id=t.contract_id||void 0,p.value.settlement_files=e.map((t=>t)),p.value.contract_id=t.contract_id||void 0,d.value.contract_uid=t.contract_uid||void 0,d.value.sign_type_name=t.sign_type_name||void 0,d.value.coop_start_date=t.coop_start_date||void 0,d.value.coop_end_date=t.coop_end_date||void 0},C=(0,n.computed)((()=>new(_())(a.value?.total_settle_amount??"0"))),S=(0,n.computed)((()=>(0,Y.get)(C).toString())),w=(0,n.ref)(!1),j=async t=>{if(void 0===a.value)return void console.warn("不存在结算数据");const e=await(0,L.G)(c);if(!e)return;const{settlement_files:n}=(0,Y.get)(u),s={id:a.value.id,settlement_files:n,contract_id:u.value.contract_id||0,step:t?o.br.step_three:a.value.step};(0,Y.set)(w,!0);const[{data:i}]=await(0,f.Dc)(500,(0,y.gO)(s));return(0,Y.set)(w,!1),i},D=async()=>{if(!(0,Y.get)(b))return void e.emit("prev");const t=await j(!1);return!!t?.success&&(e.root.$message.success("保存成功"),e.emit("prev",t.data),!0)},F=async t=>{if(void 0===a.value)return;w.value=!0;const[{data:n}]=await(0,f.Dc)(500,(0,y.FX)(t));w.value=!1,n.success?(e.root.$message.success("提交成功"),e.emit("submit:success")):e.root.$message.error(n.message??"提交失败")},$=async()=>{if(void 0===a.value)return;if(0===a.value.is_estimate&&0===u.value.settlement_files.length)return void e.root.$message.warning("请上传结算单");const t=await(0,J.I)(e,{title:"确定提交结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,n.h)("div","提交给财务确认吗?")])});if(!t)return;const o={id:a.value.id,contract_id:u.value.contract_id||0};if(0===a.value.is_estimate&&(o.settlement_files=u.value.settlement_files),r.value){(0,Y.set)(w,!0);const[{data:t}]=await(0,f.Dc)(500,(0,y.X2)(o));(0,Y.set)(w,!1),t?.success?(e.root.$message.success("提交成功"),e.emit("submit:success")):!1===t?.success&&e.root.$message.error(t.message??"提交失败")}else F(o)},A=async()=>{if(r.value){const t=await j(!1);return!!t?.success&&(e.root.$message.success("保存成功"),e.emit("next",t.data),!0)}{const t=await I();return!!t?.success&&(e.root.$message.success("保存成功"),e.emit("next",t.data),!0)}},I=async()=>{if(void 0===a.value)return;const t={id:a.value.id,contract_id:u.value.contract_id||0};0===a.value.is_estimate&&(t.settlement_files=u.value.settlement_files);const{business_type:e}=a.value;(0,Y.set)(w,!0);const[{data:n}]=await(0,f.Dc)(500,(0,y.bp)(t,e));return(0,Y.set)(w,!1),n},N=async()=>(0,Y.get)(b),T=(0,n.computed)((()=>(0,v.SJ)(new(_())(a.value?.spend_amount??0)))),z=(0,n.computed)((()=>(a.value?.adjust_info??[]).map((t=>({adjust_amount:(0,v.SJ)(new(_())(t.adjust_amount)),adjust_reason:t.adjust_reason}))))),B=(0,n.computed)((()=>{const t=(a.value?.adjust_info??[]).reduce(((t,e)=>_().add(t,new(_())(e.adjust_amount))),new(_())(0));return(0,v.SJ)(t)})),P=(0,n.computed)((()=>u.value.settlement_files.length>=5)),O=31457280,R=async t=>{if(t.size>O)return e.root.$message.error(`${t.name} ${(t.size/O).toFixed(2)}MB 请限制在30MB以内`),Promise.reject()},M=async t=>{const a=t.file;if(a.size>31457280)return void e.root.$message.error("上传文件大小不能超过 30MB!");i();const n=new FormData,o=t.file.name;n.append("file",t.file,o),n.append("type","settlement");const l=await(0,E.$)(n);s.close(),l.data.success?(u.value.settlement_files.push(l.data.data.source),e.root.$message.success("上传成功"),c.value?.clearValidate()):e.root.$message.error(l.data.message??"上传失败，稍后重试")},Z=t=>{u.value.settlement_files.splice(t,1)},G=(0,n.ref)([]),{project_id:U}=(0,l.L)(e),K=async t=>{const e=await(0,q.z0)({search:t,only_main:0,project_id:r.value?void 0:U.value,cooperation_id:r.value?U.value:void 0,contract_status:2,partner_type:2,exclude_sign_types:-3});e.data.success?G.value=e.data.data.data:G.value=[]};!1===t.readonly&&K("");const W=t=>{u.value.contract_id=t};return{contract_info:d,isFromMarketing:r,contract_uids:G,getContract:K,selectContractUidChange:W,DataForm:g,settlement:a,total_settle_amount:S,amount:C,step3Frm:u,step3FrmRef:c,step3FrmRules:m,resetFrm:x,prev:D,submit:$,confirmBeforeClose:N,saveBeforeClose:A,saveLoading:w,fillForm:k,spend_amount:T,adjust_info:z,adjust_info_amount_total:B,beforeUpload:R,isFileUploaderDisabled:P,uploadFileHandler:M,onRemoveFile:Z}}}),K=U,W=(0,C.Z)(K,M,Z,!1,null,"ec6bd496",null),V=W.exports,X=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("Step2Layout",{staticClass:"settlement-step2-shoplive-before settlement-step2-selfdouyin-live-before",attrs:{topHeightType:"default",amount:t.total_amount_str},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{directives:[{name:"loading",rawName:"v-loading",value:t.fill_form_loading,expression:"fill_form_loading"}],staticClass:"settlement-left-block",attrs:{"element-loading-text":t.loadingKolText,"element-loading-background":"rgba(0, 0, 0, 0.25)",padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("主播工资")]},proxy:!0},{key:"desc",fn:function(){return[a("div",{staticStyle:{cursor:"pointer","line-height":"14px",height:"14px","margin-left":"-6px"}},[a("el-popover",{attrs:{offset:130,"popper-class":"kol-tips-popper",placement:"bottom",trigger:"hover"}},[a("div",[a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("时薪工资")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 单价 * 时长")]),a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("底薪/提成（取高的）")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 底薪和（净销额）*提成比例取高的")]),a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("底薪+提成")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 底薪 + （净销额）*提成比例")])]),a("template",{slot:"reference"},[a("tg-icon",{staticStyle:{"font-size":"16px"},attrs:{name:"ico-question"}})],1)],2)],1)]},proxy:!0},{key:"refresh",fn:function(){return[a("div",{staticStyle:{cursor:"pointer"},on:{click:t.reloadRelationship}},[a("i",{staticClass:"el-icon-refresh",staticStyle:{color:"#2877ff",height:"22px","line-height":"22px","font-size":"16px","margin-right":"4px"}}),t._v("刷新数据 ")])]},proxy:!0}])},[a("div",{ref:"root",staticClass:"AnchorListBlock"},[a("el-form",{ref:"formRef",attrs:{model:t.DataForm,size:"small","label-width":"68px"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.DataForm.json_data.company_info_list&&0!==t.DataForm.json_data.company_info_list.length?t._l(t.DataForm.json_data.company_info_list,(function(e,n){return a("div",{key:n,staticStyle:{margin:"0 18px"},style:n>0?"border-top: 1px solid rgba(164,178,194,0.30);":""},[a("div",{staticClass:"company-list",staticStyle:{height:"68px"}},[a("div",{staticClass:"company-list-summary"},[a("head-lines",{attrs:{title:e.company_name}}),a("div",[t._v(" "+t._s("总结算金额 "+t.formatAmountWithoutPrefix(t.ComputedCompanyData[n].jszje)+" 元")+" ")])],1),1===e.fwfsqfs?a("el-input",{staticStyle:{"margin-top":"8px"},attrs:{placeholder:"0.00"},on:{input:function(e){return t.fwRateInput(e,n)}},model:{value:e.fwfbfb,callback:function(a){t.$set(e,"fwfbfb",a)},expression:"company.fwfbfb"}},[a("template",{slot:"prepend"},[a("el-select",{model:{value:e.fwfsqfs,callback:function(a){t.$set(e,"fwfsqfs",a)},expression:"company.fwfsqfs"}},[a("el-option",{attrs:{label:"请选择",value:0}}),a("el-option",{attrs:{label:"抽成服务费",value:1}}),a("el-option",{attrs:{label:"固定服务费",value:2}})],1)],1),a("template",{slot:"append"},[t._v("%")])],2):a("el-input",{staticStyle:{"margin-top":"8px"},attrs:{placeholder:"0.00"},on:{input:function(e){return t.fwfInput(e,n)}},model:{value:e.fwf,callback:function(a){t.$set(e,"fwf",a)},expression:"company.fwf"}},[a("template",{slot:"prepend"},[a("el-select",{model:{value:e.fwfsqfs,callback:function(a){t.$set(e,"fwfsqfs",a)},expression:"company.fwfsqfs"}},[a("el-option",{attrs:{label:"请选择",value:0}}),a("el-option",{attrs:{label:"抽成服务费",value:1}}),a("el-option",{attrs:{label:"固定服务费",value:2}})],1)],1),a("template",{slot:"append"},[t._v("元")])],2)],1),t._l(e.kol_salary_infos,(function(o,s){return a("div",{key:s,ref:"target",refInFor:!0,staticStyle:{height:"195px"},attrs:{"data-index":s}},[[a("div",{staticClass:"OneItem"},[a("div",{staticStyle:{height:"32px","line-height":"32px","margin-top":"12px"}},[a("div",{staticStyle:{display:"inline-block"}},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[t._v(t._s("主播"+(s+1)))]),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(o.kol_name)+" ")]),t.hasDianBo&&o.real_name?[a("span",{staticStyle:{color:"#3c5269"}},[t._v("("+t._s(o.real_name)+")")])]:t._e(),a("span",{staticStyle:{color:"#2877ff","margin-left":"12px",cursor:"pointer"},on:{click:function(a){return t.dialogCompany.show(e,n,o,s)}}},[t._v("更换结算公司")])],2),t._e()]),a("div",{staticStyle:{"margin-top":"12px",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[t._v("结算方式")]),a("el-select",{staticClass:"select",staticStyle:{width:"164px"},attrs:{placeholder:"",size:"small"},model:{value:o.salary_type,callback:function(e){t.$set(o,"salary_type",e)},expression:"item.salary_type"}},t._l(t.SettlementTypeOptions,(function(t,e){return a("el-option",{key:e,attrs:{label:t.label,value:t.value}})})),1)],1),1===o.salary_type?a("div",{staticStyle:{"margin-top":"18px",height:"32px","line-height":"32px",display:"flex"}},[a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("开播时长 ")]),a("el-form-item",{attrs:{rules:t.formRules.live_duration,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].live_duration"}},[a("el-input",{staticStyle:{width:"164px"},attrs:{size:"small",placeholder:"0.0",maxlength:"6"},on:{input:function(e){return t.LiveDurationInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("小时")]},proxy:!0}],null,!0),model:{value:o.live_duration,callback:function(e){t.$set(o,"live_duration",e)},expression:"item.live_duration"}})],1)],1),a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("单价 ")]),a("el-form-item",{attrs:{rules:t.formRules.unit_price,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].unit_price"}},[a("el-input",{staticStyle:{width:"164px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.UnitPriceInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("时/元")]},proxy:!0}],null,!0),model:{value:o.unit_price,callback:function(e){t.$set(o,"unit_price",e)},expression:"item.unit_price"}})],1)],1)]):t._e(),1!==o.salary_type?a("div",{staticStyle:{"margin-top":"18px",height:"32px","line-height":"32px",display:"flex"}},[a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("底薪 ")]),a("el-form-item",{attrs:{rules:t.formRules.base_salary,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].base_salary"}},[a("el-input",{staticStyle:{width:"164px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.BaseSalaryInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("元")]},proxy:!0}],null,!0),model:{value:o.base_salary,callback:function(e){t.$set(o,"base_salary",e)},expression:"item.base_salary"}})],1)],1),a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"68px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("净销额 ")]),a("el-form-item",{attrs:{rules:t.formRules.sale_amount,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].sale_amount"}},[a("el-input",{staticStyle:{width:"164px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.SaleAmountInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("元")]},proxy:!0}],null,!0),model:{value:o.sale_amount,callback:function(e){t.$set(o,"sale_amount",e)},expression:"item.sale_amount"}})],1)],1),a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"82px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("提成比例 ")]),a("el-form-item",{attrs:{rules:t.formRules.commission_rate,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].commission_rate"}},[a("el-input",{staticStyle:{width:"100px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.CommissionRateInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("%")]},proxy:!0}],null,!0),model:{value:o.commission_rate,callback:function(e){t.$set(o,"commission_rate",e)},expression:"item.commission_rate"}})],1)],1)]):t._e(),a("div",{staticStyle:{display:"inline-block","margin-top":"18px",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[t._v("合计")]),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(t.ComputedCompanyData[n].calc_kol_salary_infos[s].salary_str))])])]),s+1<e.kol_salary_infos.length&&0!==e.kol_salary_infos.length?a("div",{staticStyle:{"border-top":"1px dashed rgba(164, 178, 194, 0.3)",margin:"0 18px 18px 0"}}):t._e()]],2)}))],2)})):a("div",[a("div",{staticClass:"tg-page-empty",staticStyle:{"margin-top":"62px"}},[a("empty-common",{attrs:{"detial-text":"暂无数据，请先完善主播排班信息"}})],1)])],2),t.DataForm.json_data.nofind&&t.DataForm.json_data.nofind.length?a("div",{staticClass:"kol-company-no-relation-list"},[a("div",[a("span",[t._v(t._s("还有"+t.DataForm.json_data.nofind.length+"名主播没有对应机构"))]),a("el-popover",{ref:"popover",attrs:{"popper-class":"kol-company-map",placement:"top",trigger:"click"},on:{show:t.startShow,hide:t.endShow}},[a("div",{staticStyle:{"max-height":"150px",overflow:"overlay"}},t._l(t.DataForm.json_data.nofind,(function(e,n){return a("div",{key:n,style:0===n?"color: #3C5269;":"margin-top: 4px; color: #3C5269;"},[t._v(" "+t._s(e)+" ")])})),0),a("tg-button",{staticClass:"mgl-6 mgr-12",staticStyle:{"font-size":"14px"},attrs:{slot:"reference",type:"link"},slot:"reference"},[t._v("查看明细 ")])],1),a("span",[t._v("请到主播管理中维护主播和主播的结算公司")])],1)]):t._e(),a("el-dialog",{staticClass:"tg-dialog-classic el-dialog-center-rewrite",attrs:{width:"300px",visible:t.dialogCompany.visible,"append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,wrapperClosable:!1,title:"更换公司"},on:{close:t.dialogCompany.close}},[a("el-form",{attrs:{size:"small","label-width":"86px",model:t.dialogCompany.form}},[a("div",{staticClass:"dialog_change_company"},[a("el-form-item",{attrs:{label:"选择公司"}},[a("el-select",{attrs:{filterable:"",remote:"","remote-method":t.dialogCompany.remoteMethod,placeholder:"请输入公司名"},model:{value:t.dialogCompany.form.company,callback:function(e){t.$set(t.dialogCompany.form,"company",e)},expression:"dialogCompany.form.company"}},t._l(t.dialogCompany.options,(function(t){return a("el-option",{key:t.id,attrs:{label:t.company_name,value:t.id}})})),1)],1)],1)]),a("template",{staticStyle:{height:"50px"},slot:"footer"},[a("tg-button",{attrs:{size:"small"},on:{click:t.dialogCompany.close}},[t._v(" 取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:t.dialogCompany.submit}},[t._v(" 确定 ")])],1)],2)],1)])]},proxy:!0},{key:"right",fn:function(){return[a("div",[a("el-form",{attrs:{size:"small","label-width":"68px"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{height:470,adjust_info:t.DataForm.adjust_info,ExtendItem:"anchor",ExtendItemSelectOptions:t.KolSelectOptions},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading||t.relocationshipLoading,content:t.saveLoading?"正在保存，请稍候...":"正在刷新，请稍候..."}})]},proxy:!0}])})},Q=[];const tt=(0,n.defineComponent)({props:{amount:{type:[String,Object]},topHeightType:{type:String,default:"value1"},leftItemWidth:{type:Number},douyinLiveSelf:{type:Boolean,default:!1},douyinS2b2cSelf:{type:Boolean,default:!1}},setup(t){const e=(0,n.computed)((()=>"string"===typeof t.amount?t.amount:(0,v.SJ)(t.amount??new(_())(0)))),a=(0,n.computed)((()=>t.douyinLiveSelf));return{douyin_live_self:a,final_amount:e}},render(){const t=arguments[0],e=[];let a=0,n=0,o=0,s=0;const i=this.leftItemWidth??0;void 0!==this.$slots.top&&e.push(t("div",{class:"step2-cost-layout-content-top"},this.$slots.top)),void 0!==this.$slots.left&&(e.push(t("div",{class:"step2-cost-layout-content-left"},this.$slots.left)),s+=1),void 0!==this.$slots.right&&(e.push(t("div",{class:"step2-cost-layout-content-right"},this.$slots.right)),s+=1),void 0!==this.$slots.bottom&&e.push(t("div",{class:"step2-cost-layout-content-bottom"},this.$slots.bottom)),void 0!==this.$slots.files&&e.push(t("div",{class:"step2-layout-content-files"},this.$slots.files)),"default"===this.$props.topHeightType?void 0===this.$slots.bottom?(a=24,n=470,o=0):(a=24,n=376,o=20):void 0===this.$slots.bottom?(a=118,n=380,this.douyinS2b2cSelf&&(n=420),o=0):(a=118,n=290,o=20),!0===this.douyin_live_self&&(n=n<370?370:n);const l={gridTemplateRows:o>0?`${a}px ${n}px ${o}px`:`${a}px ${n}px`,gridTemplateColumns:1===s?i?`${i}px`:"1fr":i?`${i}px 320px`:"714px 320px",columnGap:1===s?"0":"18px",justifyContent:1===s?"center":void 0};return t("div",{class:"step2-cost-layout"},[t("div",{class:void 0!==this.$slots.bottom&&void 0!==this.$slots.file?"container-contact-bottom step2-cost-layout-content":void 0!==this.$slots.bottom?"container-bottom step2-cost-layout-content":void 0!==this.$slots.file?"container-contact step2-cost-layout-content":"step2-cost-layout-content",style:l},[e]),t("div",{class:"bottom-button-line"},[this.$slots.button]),this.$slots.mask])}});var et,at,nt=tt,ot=nt,st=(0,C.Z)(ot,et,at,!1,null,null,null),it=st.exports,lt=a(42413),rt=a(74750),ct=a(57046),ut=a(318);const dt=20,mt=t=>{const e=e=>{fetch(e).then((async e=>{const a=e.clone();try{const e=await a.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob(),a="kol_schedule.xlsx";(0,f.uA)(t,a)}else t.root.$message.error("下载失败")}}))};return{downloadFileHandler:e}},pt=t=>{if(t.adjust_info&&t.adjust_info?.length>=1){const e=t.adjust_info.filter((t=>t.adjust_reason||t.adjust_amount));if(e.length>0)return e}return[]},_t=t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],vt=(t,e=8)=>{const a=new RegExp(`(?:0|[1-9]\\d{0,${e-1}})(?:\\.\\d{0,2})?`,"u"),n=(a.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];return n};var ft=(0,n.defineComponent)({name:"TgCostSettmentDataForm",components:{Step2Layout:it,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},props:{},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.ref)(!1),i=(0,n.inject)("project")??(0,n.ref)(void 0),{downloadFileHandler:l}=mt(e),r=[{label:"时薪",value:1},{label:"底薪/提成(取高的)",value:2},{label:"底薪+提成",value:3}],c=(0,n.ref)({sale_amount:[{required:!0,message:"请输入净销额",trigger:"change"}],base_salary:[{required:!0,message:"请输入底薪",trigger:"change"}],commission_rate:[{required:!0,message:"请输入提成比例",trigger:"change"}],unit_price:[{required:!0,message:"请输入单价",trigger:"change"}],live_duration:[{required:!0,message:"请输入开播时长",trigger:"change"}]}),u=(0,n.ref)(null),d=(0,n.inject)("settlement")??(0,n.ref)(void 0),m=(0,n.ref)({adjust_info:[],json_data:{company_info_list:[],nofind:[]}}),p=t=>{let e="0";t.salary_type===o.$m.Hourly?e=(0,lt.fv)(t.unit_price,t.live_duration):t.salary_type===o.$m.Basic_or_commision?e=(0,lt.XX)(t.base_salary,t.sale_amount,t.commission_rate):t.salary_type===o.$m.Basic_and_commision&&(e=(0,lt.kN)(t.base_salary,t.sale_amount,t.commission_rate)),t.salary=e;const a=(0,v.FU)(e)+" 元";return{...t,salary:e,salary_str:a}},g=t=>{let e=new(_())("0");for(const a of m.value.adjust_info)if(t.kol_salary_infos.find((t=>t.kol_name===a.kol_name))){let t=a.adjust_amount;isNaN(Number(t))&&(t="0"),e=e.add(new(_())(t||"0"))}return e},x=t=>{const e=t.kol_salary_infos.map((t=>p(t))),a=e.reduce(((t,e)=>new(_())(e.salary?e.salary:0).add(t)),new(_())("0")),n=g(t);let o=new(_())(t.fwf?t.fwf:0);return"1"===`${t.fwfsqfs}`&&(isNaN(Number(t.fwfbfb))?o=new(_())("0"):(o=new(_())(Number(t.fwfbfb)).div(new(_())(100)).mul(a.add(n)),t.fwf=o.toFixed(2))),t.jszje=n.add(a).add(o).toFixed(2),t.zbfwf=a.add(n).toFixed(2),{...t,calc_kol_salary_infos:e}},h=(0,n.computed)((()=>m.value.json_data.company_info_list?m.value.json_data.company_info_list.map((t=>x(t))):[])),b=(0,n.computed)((()=>{const t=(0,lt.Ut)(h.value.map((t=>t.jszje)),void 0);return t.toFixed(2)})),k=(0,n.computed)((()=>(0,v.SJ)(new(_())(b.value)))),C=t=>{const e=`/api/settlement/download_kol_schedule?settlement_id=${d.value?.id}&company_id=${t}&Authorization=${(0,rt.LP)()}`;l(e)},S=(t,e)=>{const a=_t(t);m.value.json_data.company_info_list[e].fwfbfb=a},w=(t,e)=>{const a=vt(t,6);m.value.json_data.company_info_list[e].fwf=a},j=(t,e,a)=>{const n=_t(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].commission_rate=n},D=(t,e,a)=>{const n=vt(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].unit_price=n},F=(t,e,a)=>{const n=vt(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].base_salary=n},$=(t,e,a)=>{const n=vt(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].sale_amount=n},A=(t,e,a)=>{const n=(/(?:0|[1-9]\d{0,5})(?:\.[05]{0,1})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];m.value.json_data.company_info_list[e].kol_salary_infos[a].live_duration=n},L=(0,n.ref)(void 0),N=(0,n.ref)({adjust_info:[],json_data:{nofind:[],company_info_list:[]}}),T=(0,n.computed)((()=>2===i.value?.business_type||3===i.value?.business_type||7===i.value?.business_type)),z=(0,n.computed)((()=>m.value.json_data.company_info_list?m.value.json_data.company_info_list.map((t=>{const e=t.kol_salary_infos.map((t=>T.value&&t.real_name?{id:t.kol_id,name:t.kol_name,real_name:`${t.kol_name}(${t.real_name})`}:{id:t.kol_id,name:`${t.kol_name}`}));return e})).flat():[]));(0,n.ref)([]);const B=(0,n.ref)(!1),P=t=>{if(m.value.adjust_info=(0,ct.I8)(t.adjust_info),m.value.json_data=(0,ct.I8)(t.json_data),t.json_data?.company_info_list&&t.json_data?.company_info_list.length>0){const e=t.json_data.company_info_list[0];e.type?(m.value.settlement_info_list=JSON.parse(JSON.stringify(t.json_data.company_info_list)),m.value.json_data={company_info_list:e.company_list||[],nofind:t.json_data.nofind}):m.value.json_data=(0,ct.I8)(t.json_data)}N.value.adjust_info=(0,ct.I8)(t.adjust_info),N.value.json_data=JSON.parse(JSON.stringify(m.value.json_data)),m.value.json_data.company_info_list&&0!==m.value.json_data.company_info_list.length||it()},O=(0,n.ref)([]),R=(0,n.ref)([]),M=(0,n.ref)([]);(0,n.watch)((()=>O.value),(t=>{R.value.forEach((t=>{t()})),t.length>dt?O.value.forEach(((t,e)=>{window.setTimeout((()=>{const{stop:e}=(0,Y.useIntersectionObserver)((0,n.computed)((()=>t)),((t,e)=>{M.value.push(!0)}));R.value.push(e)}),17)})):(0,Y.set)(B,!1)}));const Z=(0,n.computed)((()=>`正在加载主播数据(${M.value.length}/${O.value.length})`));(0,n.watch)((()=>M.value.length),(t=>{O.value.length===t&&(0,Y.set)(B,!1)}));const G=(0,n.ref)(!1),E=t=>{L.value=t,G.value=!0,t.kol_salary_infos.length>10?((0,Y.set)(B,!0),setTimeout((()=>{P(t)}),300)):P(t)},J=t=>{m.value.adjust_info=t},q=t=>{const e=L.value?.id??-1,a=[{type:9,company_list:m.value.json_data.company_info_list}],n={id:e,total_settle_amount:b.value,adjust_info:t.adjust_info,json_data:{company_info_list:a}};return n},U=(t=!0)=>{if(m.value.json_data.company_info_list.some((t=>t.kol_salary_infos.some((t=>![o.$m.Hourly,o.$m.Basic_or_commision,o.$m.Basic_and_commision].includes(t.salary_type))))))return"请选择结算方式";const a=(0,n.ref)([]);if(m.value.adjust_info&&m.value.adjust_info?.length>=1){const t=m.value.adjust_info.filter((t=>t.kol_name||t.adjust_reason||t.adjust_amount));if(t.some((t=>/^(?:\+|-)?0?(?:\.0{0,2})?$/u.test(t.adjust_amount))))return"请输入正确的调整金额";if(t.some((t=>"0"===t.adjust_amount)))return e.root.$message.error("调整金额不能为0"),"调整金额不能为0";if(!t.every((t=>t.kol_name&&""!==t.kol_name&&t.adjust_amount&&""!==t.adjust_amount&&"-"!==t.adjust_amount&&t.adjust_reason)))return"请完善手工调账信息";t.length>0&&(a.value=t)}return t&&a.value&&0===a.value.length&&["0","0.0","0.00"].includes(b.value??"0")?"至少填写一项结算项":t&&new(_())(b.value).lte("0")?"总结算金额必须大于0":void 0},K=()=>{setTimeout((()=>{u.value?.clearValidate?.()}),100)},W=async(t=!0,n=!1)=>{if(a.value)return;if(!i.value)return;const s=i.value.business_type;if(t){const a=await new Promise((t=>{u.value?.validate((e=>t(e)))}));if(!a)return;if(!n){const a=U(t);if(a)return void e.root.$message.error(a)}}const l=q(m.value);l.step=t?o.br.step_three:o.br.step_two,l.adjust_info=pt(m.value),a.value=!0;const[{data:r}]=await(0,f.Dc)(500,(0,y.bp)(l,s));return a.value=!1,r.success?(t&&e.emit("next",r.data),K()):e.root.$message.error(r.message??"保存失败"),r},V=(0,Y.useDebounceFn)(W,200),X=async()=>{if(tt.value){const t=!1,a=!0,n=await W(t,a);n&&(n.success?e.emit("prev",n.data):e.root.$message.warning(n.message))}else e.emit("prev")},Q=()=>{(m.value.json_data?.nofind??[]).length?e.root.$message.warning(`有${m.value.json_data?.nofind?.length??0}名主播没有对应机构，点击“查看明细”可以查看没有对应关系的主播列表`):V()},tt=(0,n.computed)((()=>JSON.stringify(N.value)!==JSON.stringify(m.value))),et=async()=>tt.value,at=async()=>{const t=!1,e=!0,a=await W(t,e);return!!a&&a.success},nt=(0,n.ref)([{class:"a1"},{class:"b1"},{class:"c1"},{class:"c2"},{class:"c3"},{class:"d1"}]),ot=(t,e)=>(e?.company_info_list.forEach((e=>{const a=t.company_info_list.find((t=>t.company_id===e.company_id));a&&(e.kol_salary_infos.forEach((t=>{const e=a.kol_salary_infos.find((e=>t.kol_id===e.kol_id));e&&(t.salary_type=e.salary_type,t.unit_price=e.unit_price,t.salary=e.salary,t.base_salary=e.base_salary,t.sale_amount=e.sale_amount,t.commission_rate=e.commission_rate)})),e.fwf=a.fwf,e.fwfbfb=a.fwfbfb,e.jszje=a.jszje,e.zbfwf=a.zbfwf,e.fwfsqfs=a.fwfsqfs)})),e??{company_info_list:[],nofind:[]}),st=async()=>{if(!d.value?.id)return;const t={id:d.value.id};s.value=!0;const a=await(0,y.S_)("live",t);if(s.value=!1,a.data.success){const t=a.data.data;m.value.json_data=ot(m.value.json_data,t?.json_data)}else e.root.$message.warning(a.data.message??"获取结算详情失败，稍后重试")},it=async()=>{if(!d.value?.id)return;s.value=!0;const t=await(0,y.ix)(`${d.value.id}`);if(s.value=!1,t.data.success){const e=t.data.data;m.value.json_data=ot(m.value.json_data,e?.json_data)}else e.root.$message.error(t?.data.message??"刷新失败，稍后重试")},ft=(0,n.reactive)({form:{},options:[],visible:!1,company:{},salary_info:{},companyIndex:0,salary_index:0,show(t,e,a,n){ft.company=t,ft.companyIndex=e,ft.salary_index=n,ft.salary_info=a,ft.form={company:t.company_id},ft.options=[{id:t.company_id,company_name:t.company_name}],ft.visible=!0},submit(){const t=ft.form;if(!t.company)return void H.Message.error("请选择公司");const e=ft.options.find((e=>e.id===t.company)),a=m.value.json_data.company_info_list.find((t=>t.company_id===e.id));if(e.id!==ft.company.company_id){if(ft.company.kol_salary_infos.splice(ft.salary_index,1),0===ft.company.kol_salary_infos.length&&m.value.json_data.company_info_list.splice(ft.companyIndex,1),void 0===a){const t={...ft.company};t.kol_salary_infos=[ft.salary_info],t.company_id=e.id,t.company_name=e.company_name,m.value.json_data.company_info_list.splice(ft.companyIndex,0,t)}else a.kol_salary_infos.push(ft.salary_info);(0,Y.set)(m.value.json_data,"company_info_list",[...m.value.json_data.company_info_list]),ft.visible=!1}else ft.visible=!1},close:()=>{ft.visible=!1},remoteMethod:t=>{""!==t?(0,ut.K)(t,1).then((t=>{ft.options=t})):ft.options=[]}}),yt=(0,n.ref)(null),gt=(0,n.ref)(0),xt=(0,n.ref)(0),ht=(0,n.ref)(!1),bt=()=>{ht.value=!0,window.addEventListener("scroll",Ct,!0)},kt=()=>{ht.value=!1,window.removeEventListener("scroll",Ct,!0)},Ct=t=>{gt.value=t.target.scrollTop||0,ht.value&&(ht.value=!1,xt.value=t.target.scrollTop||0);const e=Math.abs(Number(xt.value)-Number(gt.value));e>50&&e>50&&(yt.value instanceof Array?yt.value[0].showPopper=!1:yt.value.showPopper=!1,window.removeEventListener("scroll",Ct,!0))};return{popover:yt,startShow:bt,endShow:kt,getSettlementDetail:st,hasDianBo:T,project:i,dialogCompany:ft,formRules:c,formRef:u,total_amount_str:k,ShowAdjustInfo:G,fwRateInput:S,downloadKolScheduleFile:C,skeletonItems:nt,loadingKolText:Z,target:O,KolSelectOptions:z,ComputedCompanyData:h,total_amount:b,LiveDurationInput:A,fwfInput:w,BaseSalaryInput:F,SaleAmountInput:$,CommissionRateInput:j,UnitPriceInput:D,SettlementTypeOptions:r,DataForm:m,saveLoading:a,fill_form_loading:B,onAdjustAccountDataChange:J,onSaveHandler:V,fillForm:E,prev:X,next:Q,confirmBeforeClose:et,saveBeforeClose:at,reloadRelationship:it,relocationshipLoading:s,formatAmountWithoutPrefix:v.FU}}}),yt=ft,gt=(0,C.Z)(yt,X,Q,!1,null,"54567caf",null),xt=gt.exports,ht=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("Step2Layout",{staticClass:"settlement-step2-shoplive-before settlement-step2-shoplive-before",attrs:{topHeightType:"default",isSelfdouyinLive:!0,amount:t.total_amount_str},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("div",{staticClass:"left-content"},[a("div",[a("div",{staticClass:"add-settlement-detail-container"},[a("tg-button",{attrs:{icon:"ico-btn-add",type:"primary",size:"mini",disabled:t.DataForm.settlement_info_list.length>=6},on:{click:t.addSettlementDetail}},[t._v("新增结算明细")])],1),a("div",{staticStyle:{"margin-top":"2px"}},t._l(t.DataForm.settlement_info_list,(function(e,n){return a("CostDetail",{key:n,staticStyle:{"margin-bottom":"16px"},attrs:{feeDetail:e,isLiveDouyin:!0,disabledTypeList:t.selectedIncomeTypeList},on:{delSettlementDetail:function(e){return t.delSettlementDetail(n)}}},[a("div",{attrs:{slot:"anchor"},slot:"anchor"},[a("CardLayout",{directives:[{name:"loading",rawName:"v-loading",value:t.fill_form_loading,expression:"fill_form_loading"}],staticClass:"settlement-left-block",attrs:{"element-loading-text":t.loadingKolText,"element-loading-background":"rgba(0, 0, 0, 0.25)",padding:[0],isLiveDouyin:!0},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("主播工资")]},proxy:!0},{key:"desc",fn:function(){return[a("div",{staticStyle:{cursor:"pointer","line-height":"14px",height:"14px","margin-left":"-6px"}},[a("el-popover",{attrs:{offset:130,"popper-class":"kol-tips-popper",placement:"bottom",trigger:"hover"}},[a("div",[a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("时薪工资")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 单价 * 时长")]),a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("底薪/提成（取高的）")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v(" 主播工资 = 底薪和（净销额）*提成比例取高的 ")]),a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("底薪+提成")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 底薪 + （净销额）*提成比例")])]),a("template",{slot:"reference"},[a("tg-icon",{staticStyle:{"font-size":"16px"},attrs:{name:"ico-question"}})],1)],2)],1)]},proxy:!0},{key:"refresh",fn:function(){return[a("div",{staticStyle:{cursor:"pointer"},on:{click:t.reloadRelationship}},[a("i",{staticClass:"el-icon-refresh",staticStyle:{color:"#2877ff",height:"22px","line-height":"22px","font-size":"16px","margin-right":"4px"}}),t._v("刷新数据 ")])]},proxy:!0}],null,!0)},[a("div",{ref:"root",refInFor:!0,staticClass:"AnchorListBlock"},[a("el-form",{ref:"formRef",refInFor:!0,attrs:{model:t.DataForm,size:"small","label-width":"68px"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.DataForm.json_data.company_info_list&&0!==t.DataForm.json_data.company_info_list.length?t._l(t.DataForm.json_data.company_info_list,(function(e,n){return a("div",{key:n,staticStyle:{margin:"0 12px"},style:n>0?"border-top: 1px solid rgba(164,178,194,0.30);":""},[a("div",{staticClass:"company-list",staticStyle:{height:"68px"}},[a("div",{staticClass:"company-list-summary"},[a("div",[a("span"),t._v(t._s(e.company_name))]),a("div",[t._v(" "+t._s("总结算金额 "+t.formatAmountWithoutPrefix(t.ComputedCompanyData[n].jszje)+" 元")+" ")])]),1===e.fwfsqfs?a("el-input",{staticStyle:{"margin-top":"8px"},attrs:{placeholder:"0.00"},on:{input:function(e){return t.fwRateInput(e,n)}},model:{value:e.fwfbfb,callback:function(a){t.$set(e,"fwfbfb",a)},expression:"company.fwfbfb"}},[a("template",{slot:"prepend"},[a("el-select",{model:{value:e.fwfsqfs,callback:function(a){t.$set(e,"fwfsqfs",a)},expression:"company.fwfsqfs"}},[a("el-option",{attrs:{label:"请选择",value:0}}),a("el-option",{attrs:{label:"抽成服务费",value:1}}),a("el-option",{attrs:{label:"固定服务费",value:2}})],1)],1),a("template",{slot:"append"},[t._v("%")])],2):a("el-input",{staticStyle:{"margin-top":"8px"},attrs:{placeholder:"0.00"},on:{input:function(e){return t.fwfInput(e,n)}},model:{value:e.fwf,callback:function(a){t.$set(e,"fwf",a)},expression:"company.fwf"}},[a("template",{slot:"prepend"},[a("el-select",{model:{value:e.fwfsqfs,callback:function(a){t.$set(e,"fwfsqfs",a)},expression:"company.fwfsqfs"}},[a("el-option",{attrs:{label:"请选择",value:0}}),a("el-option",{attrs:{label:"抽成服务费",value:1}}),a("el-option",{attrs:{label:"固定服务费",value:2}})],1)],1),a("template",{slot:"append"},[t._v("元")])],2)],1),t._l(e.kol_salary_infos,(function(o,s){return a("div",{key:s,ref:"target",refInFor:!0,staticStyle:{height:"195px"},attrs:{"data-index":s}},[[a("div",{staticClass:"OneItem",style:s>0?"margin-top: 18px":""},[a("div",{staticStyle:{height:"32px","line-height":"32px","margin-top":"12px"}},[a("div",{staticStyle:{display:"inline-block"}},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[t._v(" "+t._s("主播"+(s+1))+" ")]),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(o.kol_name)+" ")]),t.hasDianBo&&o.real_name?[a("span",{staticStyle:{color:"#3c5269"}},[t._v("("+t._s(o.real_name)+")")])]:t._e(),a("span",{staticStyle:{color:"#2877ff","margin-left":"12px",cursor:"pointer"},on:{click:function(a){return t.dialogCompany.show(e,n,o,s)}}},[t._v("更换结算公司")])],2),t._e()]),a("div",{staticStyle:{"margin-top":"12px",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[t._v("结算方式")]),a("el-select",{staticClass:"select",staticStyle:{width:"164px"},attrs:{placeholder:"",size:"small"},model:{value:o.salary_type,callback:function(e){t.$set(o,"salary_type",e)},expression:"item.salary_type"}},t._l(t.SettlementTypeOptions,(function(t,e){return a("el-option",{key:e,attrs:{label:t.label,value:t.value}})})),1)],1),1===o.salary_type?a("div",{staticStyle:{"margin-top":"18px",height:"32px","line-height":"32px",display:"flex"}},[a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("开播时长 ")]),a("el-form-item",{attrs:{rules:t.formRules.live_duration,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].live_duration"}},[a("el-input",{staticStyle:{width:"164px"},attrs:{size:"small",placeholder:"0.0",maxlength:"6"},on:{input:function(e){return t.LiveDurationInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("小时")]},proxy:!0}],null,!0),model:{value:o.live_duration,callback:function(e){t.$set(o,"live_duration",e)},expression:"item.live_duration"}})],1)],1),a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("单价 ")]),a("el-form-item",{attrs:{rules:t.formRules.unit_price,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].unit_price"}},[a("el-input",{staticStyle:{width:"164px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.UnitPriceInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("时/元")]},proxy:!0}],null,!0),model:{value:o.unit_price,callback:function(e){t.$set(o,"unit_price",e)},expression:"item.unit_price"}})],1)],1)]):t._e(),1!==o.salary_type?a("div",{staticStyle:{"margin-top":"18px",height:"32px","line-height":"32px",display:"flex"}},[a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("底薪 ")]),a("el-form-item",{attrs:{rules:t.formRules.base_salary,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].base_salary"}},[a("el-input",{staticStyle:{width:"154px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.BaseSalaryInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("元")]},proxy:!0}],null,!0),model:{value:o.base_salary,callback:function(e){t.$set(o,"base_salary",e)},expression:"item.base_salary"}})],1)],1),a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"58px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("净销额 ")]),a("el-form-item",{attrs:{rules:t.formRules.sale_amount,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].sale_amount"}},[a("el-input",{staticStyle:{width:"154px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.SaleAmountInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("元")]},proxy:!0}],null,!0),model:{value:o.sale_amount,callback:function(e){t.$set(o,"sale_amount",e)},expression:"item.sale_amount"}})],1)],1),a("div",{staticClass:"shoplive-form-item"},[a("div",{staticClass:"label",staticStyle:{width:"72px"}},[a("span",{staticStyle:{color:"#ec1e1e"}},[t._v("*")]),t._v("提成比例 ")]),a("el-form-item",{attrs:{rules:t.formRules.commission_rate,prop:"json_data.company_info_list["+n+"].kol_salary_infos["+s+"].commission_rate"}},[a("el-input",{staticStyle:{width:"100px"},attrs:{size:"small",placeholder:"0.00",maxlength:"13"},on:{input:function(e){return t.CommissionRateInput(e,n,s)}},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("%")]},proxy:!0}],null,!0),model:{value:o.commission_rate,callback:function(e){t.$set(o,"commission_rate",e)},expression:"item.commission_rate"}})],1)],1)]):t._e(),a("div",{staticStyle:{display:"inline-block","margin-top":"18px",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"64px"}},[t._v("合计")]),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(t.ComputedCompanyData[n].calc_kol_salary_infos[s].salary_str))])])]),s+1<e.kol_salary_infos.length&&0!==e.kol_salary_infos.length?a("div",{staticStyle:{"border-top":"1px dashed rgba(164, 178, 194, 0.3)",margin:"0 18px 18px 0"}}):t._e()]],2)}))],2)})):a("div",[a("div",{staticClass:"tg-page-empty",staticStyle:{"margin-top":"52px","margin-bottom":"40px"}},[a("empty-common",{attrs:{"detial-text":"暂无数据，请先完善主播排班信息"}})],1)])],2),t.DataForm.json_data.nofind&&t.DataForm.json_data.nofind.length?a("div",{staticClass:"kol-company-no-relation-list"},[a("div",[a("span",[t._v(t._s("还有"+t.DataForm.json_data.nofind.length+"名主播没有对应机构"))]),a("el-popover",{ref:"popover",refInFor:!0,attrs:{"popper-class":"kol-company-map",placement:"top",trigger:"click"},on:{show:t.startShow,hide:t.endShow}},[a("div",{staticStyle:{"max-height":"150px",overflow:"overlay"}},t._l(t.DataForm.json_data.nofind,(function(e,n){return a("div",{key:n,style:0===n?"color: #3C5269;":"margin-top: 4px; color: #3C5269;"},[t._v(" "+t._s(e)+" ")])})),0),a("tg-button",{staticClass:"mgl-6 mgr-12",staticStyle:{"font-size":"14px"},attrs:{slot:"reference",type:"link"},slot:"reference"},[t._v("查看明细 ")])],1),a("span",[t._v("请到主播管理中维护主播和主播的结算公司")])],1)]):t._e(),a("el-dialog",{staticClass:"tg-dialog-classic el-dialog-center-rewrite",attrs:{width:"300px",visible:t.dialogCompany.visible,"append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,wrapperClosable:!1,title:"更换公司"},on:{close:t.dialogCompany.close}},[a("el-form",{attrs:{size:"small","label-width":"86px",model:t.dialogCompany.form}},[a("div",{staticClass:"dialog_change_company"},[a("el-form-item",{attrs:{label:"选择公司"}},[a("el-select",{attrs:{filterable:"",remote:"","remote-method":t.dialogCompany.remoteMethod,placeholder:"请输入公司名"},model:{value:t.dialogCompany.form.company,callback:function(e){t.$set(t.dialogCompany.form,"company",e)},expression:"dialogCompany.form.company"}},t._l(t.dialogCompany.options,(function(t){return a("el-option",{key:t.id,attrs:{label:t.company_name,value:t.id}})})),1)],1)],1)]),a("template",{staticStyle:{height:"50px"},slot:"footer"},[a("tg-button",{attrs:{size:"small"},on:{click:t.dialogCompany.close}},[t._v(" 取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:t.dialogCompany.submit}},[t._v(" 确定 ")])],1)],2)],1)])],1)])})),1)])])]},proxy:!0},{key:"right",fn:function(){return[a("div",[a("el-form",{attrs:{size:"small","label-width":"68px"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{height:470,adjust_info:t.DataForm.adjust_info,ExtendItem:"livedouyinself",ExtendItemSelectOptions:t.selectedallCompanyList,ExtendItemkolSelectOptions:t.kolSelectOptions,ExtendItemcompanySelectOptions:t.selectedCompanyList,ExtendItemOtherSelectOptions:t.selectedOtherCompanyList},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading||t.relocationshipLoading,content:t.saveLoading?"正在保存，请稍候...":"正在刷新，请稍候..."}})]},proxy:!0}])})},bt=[],kt=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tg-component-cost-detail",style:{border:9===t.dataForm.type?"1px solid rgba(164,178,194,.3)":"0px solid rgba(164,178,194,.3)"}},[a("div",{staticClass:"tg-component-cost-detail-header"},[a("el-select",{staticStyle:{width:"146px"},attrs:{value:t.dataForm.type,clearable:"",placeholder:"选择结算方式",size:"mini"},on:{change:t.costTypeChanged}},t._l(t.costOptions,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value,disabled:t.itemDisabled(e.value)}})})),1),a("div",{staticClass:"desc"},[t._v(t._s(t.desc))])],1),t.current?a("div",{staticClass:"tg-component-cost-detail-content"},[t.dataForm.type===t.SettlementIncomeType.anchor?t._t("anchor"):a(t.current,{ref:"currentRef",tag:"component",attrs:{feeDetail:t.dataForm,feeType:2,isLiveDouyin:t.isLiveDouyinNew}})],2):t._e(),a("tg-icon",{staticClass:"del-button",attrs:{name:"ico-frm-delete",hoverName:"ico-frm-delete-active"},on:{click:t.delSettlementDetail}})],1)},Ct=[],St=a(34418),wt=a(26037),jt=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tg-cost-settlement-component-settlement-detail-talent-cost"},[a("div",{staticClass:"talent-cost-content"},t._l(t.dataFromCompanyList,(function(e,n){return a("div",{key:n,staticClass:"customer-list-row"},[a("el-select",{ref:n===t.dataFromCompanyList.length-1?"companySelectRef":void 0,refInFor:!0,attrs:{value:e.kol_name,size:"small",placeholder:"请选择达人","remote-method":t.queryKolList,loading:t.kolLoading,filterable:"",remote:"","reserve-keyword":""},on:{change:function(e){return t.onKolChanged(e,n)}}},t._l(t.kol_list,(function(n){return a("el-option",{key:n.kol_id,attrs:{value:n.kol_name,label:n.kol_name,disabled:t.isKolOptionDisabled(n.kol_id,e.company_id)}})})),1),a("el-select",{attrs:{value:e.company_name,size:"small",placeholder:"请输入并选择供应商","remote-method":t.getCompanyList,loading:t.companyLoading,filterable:"",remote:"","reserve-keyword":"",disabled:!e.kol_id},on:{change:function(e){return t.onCompanyChanged(e,n)}}},t._l(t.company_list,(function(n){return a("el-option",{key:n.company_id,attrs:{value:n.company_name,label:n.company_name,disabled:t.isCompanyOptionDisabled(n.company_id,e.kol_id)}})})),1),a("el-input",{attrs:{placeholder:"填写成本",value:e.income_amount,size:"small"},on:{input:function(e){return t.onCostAmountChanged(e,n)}}},[a("template",{slot:"append"},[t._v("元")])],2),a("div",{staticClass:"del-btn-container"},[a("tg-icon",{staticClass:"del-btn",attrs:{name:"ico-btn-delete",disabled:1===t.dataFromCompanyList.length&&0===n},on:{click:function(e){return t.delCompany(n)}}})],1)],1)})),0),a("div",{staticClass:"bottom-content"},[a("tg-button",{attrs:{icon:"ico-btn-add",type:"default",size:"mini"},on:{click:t.onAdd}},[t._v("添加达人")])],1)])},Dt=[],Ft=a(3293),$t=(0,n.defineComponent)({props:{feeDetail:{type:Object}},setup(t,e){const a=(0,n.ref)(void 0),o=(0,n.computed)((()=>t.feeDetail)),s=(0,n.computed)((()=>((o.value?.company_list??[]).length||u.onAdd(),o.value?.company_list))),i=(0,n.ref)([]),l=(0,n.ref)([]),r=(0,n.ref)(!1),c=(0,n.ref)(!1),u={onAdd:()=>{o.value?.company_list?.push({company_id:"",company_name:"",income_amount:"",remark:"",kol_id:"",kol_name:""}),(0,n.nextTick)((()=>{const t=a.value;if(t instanceof Array){const e=t[0];"focus"in e&&e.focus()}else"focus"in t&&t.focus()}))},delCompany:t=>{o.value?.company_list?.splice(t,1)},getCompanyList:async t=>{if(!t)return void(i.value=[]);r.value=!0;const e=await(0,ut.kg)({company_name:t,verify_status:1});r.value=!1,e.data.success?i.value=e.data.data??[]:i.value=[]},queryKolList:async t=>{if(!t)return void(l.value=[]);c.value=!0;const e=await(0,Ft.Sx)({kol_name:t});c.value=!1,e.data.success?l.value=e.data.data??[]:l.value=[]},onCompanyChanged:(t,e)=>{if(o.value?.company_list){const a=o.value.company_list[e];a.company_name=t;const n=i.value.find((e=>e.company_name===t));a.company_id=n?.company_id}},onKolChanged:(t,e)=>{if(o.value?.company_list){const a=o.value.company_list[e];a.kol_name=t;const n=l.value.find((e=>e.kol_name===t));if(a.kol_id=n?.kol_id,n?.kol_company_id&&n?.kol_id&&!u.isCompanyOptionDisabled(n.kol_company_id,n.kol_id))return a.company_name=n?.kol_company_name,void(a.company_id=n?.kol_company_id);a.company_name=void 0,a.company_id=void 0}},reset:()=>{o.value&&(o.value.company_list=[])},isCompanyOptionDisabled:(t,e)=>{const a=o.value?.company_list?.find((a=>{if(t&&a.company_id&&e&&a.kol_id)return`${a.company_id}`===`${t}`&&`${a.kol_id}`===`${e}`}));return!!a},isKolOptionDisabled:(t,e)=>{const a=o.value?.company_list?.find((a=>{if(t&&a.company_id&&e&&a.kol_id)return`${a.company_id}`===`${e}`&&`${a.kol_id}`===`${t}`}));return!!a},onCostAmountChanged:(t,e)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];o.value?.company_list&&(o.value.company_list[e].income_amount=a)}};return{dataFromCompanyList:s,company_list:i,kol_list:l,companyLoading:r,kolLoading:c,dataForm:o,companySelectRef:a,...u}}}),At=$t,It=(0,C.Z)(At,jt,Dt,!1,null,"1bc0819c",null),Lt=It.exports,Nt=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"tg-cost-settlement-component-settlement-detail-put-cost"},[a("div",{staticStyle:{border:"1px solid rgba(255, 122, 54, 0.5)","border-radius":"2px","background-color":"rgba(255, 122, 54, 0.06)",margin:"12px 12px 0",padding:"9px 12px",display:"flex","align-items":"center"}},[a("tg-icon",{staticStyle:{width:"20px",height:"20px"},attrs:{name:"ico-warn"}}),a("span",{staticStyle:{"margin-left":"4px",color:"rgb(255, 122, 54)"}},[t._v(t._s(t.isLiveDouyinNew?"项目如果没有维护抖音直播帐号或者不是在煜丰进行的投放，将无法自动获取投放金额":"达人如果没有维护抖音帐号或者不是在煜丰进行的投放，将无法自动获取投放金额"))])],1),a("div",{staticClass:"put-cost-content"},t._l(t.dataFromCompanyList,(function(e,n){return a("div",{key:n,staticClass:"customer-list-row",style:t.isLiveDouyinNew?" grid-template-columns: 216px 192px 199px ":" grid-template-columns: 216px 163px 163px 88px;"},[a("el-select",{ref:n===t.dataFromCompanyList.length-1?"companySelectRef":void 0,refInFor:!0,attrs:{value:e.company_name,size:"small",placeholder:"请输入并选择供应商","remote-method":t.getCompanyList,loading:t.companyLoading,filterable:"",remote:"","reserve-keyword":""},on:{change:function(e){return t.onCompanyChanged(e,n)}}},t._l(t.company_list,(function(n){return a("el-option",{key:n.company_id,attrs:{value:n.company_name,label:n.company_name,disabled:t.isCompanyOptionDisabled(n.company_id,e.kol_id)}})})),1),t.isLiveDouyinNew?t._e():a("el-select",{attrs:{value:e.kol_name,size:"small",placeholder:"请输入并选择达人","remote-method":t.queryKolList,loading:t.kolLoading,filterable:"",remote:"","reserve-keyword":""},on:{change:function(e){return t.onKolChanged(e,n)}}},t._l(t.kol_list,(function(n){return a("el-option",{key:n.kol_id,attrs:{value:n.kol_name,label:n.kol_name,disabled:t.isKolOptionDisabled(n.kol_id,e.company_id)}})})),1),a("el-input",{directives:[{name:"loading",rawName:"v-loading",value:t.isYufengCompany(e.company_name)&&t.yufengloading,expression:"isYufengCompany(company.company_name) && yufengloading"}],attrs:{placeholder:"填写成本",value:e.income_amount,size:"small",disabled:t.isYufengCompany(e.company_name)},on:{input:function(e){return t.onCostAmountChanged(e,n)}}},[a("template",{slot:"append"},[t._v("元")])],2),a("div",{staticClass:"del-btn-container"},[a("tg-icon",{staticClass:"del-btn",attrs:{name:"ico-btn-delete",disabled:1===t.dataFromCompanyList.length&&0===n},on:{click:function(e){return t.delCompany(n)}}}),t.isYufengCompany(e.company_name)?a("tg-button",{staticStyle:{"margin-left":"6px"},attrs:{type:"link",disabled:t.isLiveDouyinNew?!e.income_amount:!(e.income_amount&&e.kol_name)},on:{click:function(a){return t.onDownloadDetail(e)}}},[t._v("下载明细")]):t._e()],1)],1)})),0),a("div",{staticClass:"bottom-content"},[a("tg-button",{attrs:{icon:"ico-btn-add",type:"default",size:"mini"},on:{click:function(){return t.onAdd()}}},[t._v("添加投放")])],1)])},Tt=[],zt=a(67957),Bt=a(44928),Pt=(0,n.defineComponent)({props:{feeDetail:{type:Object},isLiveDouyin:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.inject)("settlement")??(0,n.ref)(void 0),o=(0,n.ref)(void 0),s=(0,n.computed)((()=>t.feeDetail));let i=!0;const l=(0,n.computed)((()=>((s.value?.company_list??[]).length||(_.onAdd(),i&&(i=!1,_.getCompanyList(zt.QN))),s.value?.company_list))),r=(0,n.computed)((()=>t.isLiveDouyin)),c=(0,n.ref)([]),u=(0,n.ref)([]),d=(0,n.ref)(!1),m=(0,n.ref)(!1),p=(0,n.computed)((()=>{const t=[];return l.value?.forEach((e=>{e.company_name===zt.QN&&e.kol_id&&t.push(e.kol_id)})),t.length?t.join(","):""})),_={onAdd:()=>{if(s.value?.company_list?.push({company_id:"",company_name:"",income_amount:"",remark:"",kol_id:"",kol_name:""}),(0,n.nextTick)((()=>{const t=o.value;if(t instanceof Array){const e=t[0];"focus"in e&&e.focus()}else"focus"in t&&t.focus()})),r.value&&s.value?.company_list&&1===s.value?.company_list.length){const t=s.value.company_list.find((t=>v(t.company_name)));t&&(t.income_amount||_.getYFAdCost(t))}},delCompany:t=>{s.value?.company_list?.splice(t,1)},getCompanyList:async t=>{if(!t)return void(c.value=[]);d.value=!0;const e=await(0,ut.kg)({company_name:t,verify_status:1});d.value=!1,e.data.success?c.value=e.data.data??[]:c.value=[]},getAdCost:async(t,n)=>{f.value=!0;const o=await(0,y.W2)({kol_id:t,start_date:a.value?.start_date,end_date:a.value?.end_date});f.value=!1,o.data.success?(n.income_amount=String(o.data.data?.sum_cost||0),e.root.$message.success(o.data.message)):(n.income_amount="0",e.root.$message.error(o.data.message))},getYFAdCost:async t=>{f.value=!0;const n=(0,Bt.t)(),o=n.currentRoute.params.id,s=await(0,y.DW)({project_id:o,start_date:a.value?.start_date,end_date:a.value?.end_date});f.value=!1,s.data.success?(t.income_amount=String(s.data.data?.sum_cost||0),e.root.$message.success(s.data.message)):(t.income_amount="0",e.root.$message.error(s.data.message))},queryKolList:async t=>{if(!t)return void(u.value=[]);m.value=!0;const e=await(0,Ft.Sx)({kol_name:t});m.value=!1,e.data.success?u.value=e.data.data??[]:u.value=[]},onCompanyChanged:(t,e)=>{if(s.value?.company_list){const a=s.value.company_list[e];a.company_name=t;const n=c.value.find((e=>e.company_name===t));a.company_id=n?.company_id,r.value&&v(a.company_name)?_.getYFAdCost(a):r.value?a.income_amount="":(a.income_amount="",a.kol_id="",a.kol_name="")}},onKolChanged:(t,e)=>{if(s.value?.company_list){const a=s.value.company_list[e];a.kol_name=t;const n=u.value.find((e=>e.kol_name===t));a.kol_id=n?.kol_id,a.company_name===zt.QN&&_.getAdCost(a.kol_id,a)}},reset:()=>{s.value&&(s.value.company_list=[])},isCompanyOptionDisabled:(t,e)=>{const a=l.value?.find((a=>r.value&&t&&a.company_id?`${a.company_id}`===`${t}`:t&&a.company_id&&e&&a.kol_id?`${a.company_id}`===`${t}`&&`${a.kol_id}`===`${e}`:void 0));return!!a},isKolOptionDisabled:(t,e)=>{const a=s.value?.company_list?.find((a=>{if(e&&a.company_id&&t&&a.kol_id)return`${a.company_id}`===`${e}`&&`${a.kol_id}`===`${t}`}));return!!a},onCostAmountChanged:(t,e)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];s.value?.company_list&&(s.value.company_list[e].income_amount=a)},onDownloadDetail:t=>{if(r.value){if(t.income_amount){const t=(0,Bt.t)(),e=t.currentRoute.params.id;window.open((0,zt.uE)(e,a.value?.start_date??0,a.value?.end_date??0))}}else p.value.length&&t.income_amount&&window.open((0,zt.RD)(p.value,a.value?.start_date??0,a.value?.end_date??0))}},v=t=>t===zt.QN,f=(0,n.ref)(!1);return{yufengloading:f,isYufengCompany:v,isLiveDouyinNew:r,kol_ids_str:p,kol_list:u,dataFromCompanyList:l,company_list:c,companyLoading:d,kolLoading:m,dataForm:s,companySelectRef:o,..._}}}),Ot=Pt,Rt=(0,C.Z)(Ot,Nt,Tt,!1,null,"420bde33",null),Mt=Rt.exports,Zt=(0,n.defineComponent)({emits:["delSettlementDetail"],props:{isLiveDouyin:{type:Boolean,default:!1},disabledTypeList:{type:Array},feeDetail:{type:Object}},components:{PitFee:St.Z,OtherIncome:wt.Z,TalentCost:Lt,PutCost:Mt},setup(t,e){const a=(0,n.computed)((()=>{const e=[];return t.isLiveDouyin?o.mR.forEach(((t,a)=>{e.push({label:t,value:a})})):o.gf.forEach(((t,a)=>{e.push({label:t,value:a})})),e})),s=(0,n.ref)(void 0),i=(0,n.computed)((()=>t.feeDetail)),l=(0,n.computed)((()=>t.isLiveDouyin)),r=(0,n.computed)((()=>{if(i.value)switch(i.value.type){case o.eY.pit_fee:return St.Z;case o.eY.put:return Mt;case o.eY.shangguang:case o.eY.xingtu:case o.eY.other:return wt.Z;case o.eY.talent_cost:return Lt;case o.eY.anchor:return"anchor"}})),c=(0,n.computed)((()=>{if(i.value)switch(i.value.type){case o.eY.pit_fee:return"坑位费 = 结算周期内全部场次商品支出坑位费总和";case o.eY.talent_cost:return"投放成本 = 填写的所有成本金额合计";case o.eY.put:return"投放成本 = 接口获取对应投放帐号的消耗金额";case o.eY.xingtu:return"星图成本 = 填写的所有成本金额合计";case o.eY.shangguang:return"商广成本 = 填写的所有成本金额合计";case o.eY.other:return"其他成本 = 填写的所有成本金额合计";case o.eY.anchor:return"主播成本 = 填写的所有主播成本金额合计"}})),u={costTypeChanged:t=>{s.value?.reset(),i.value&&(i.value.type=t,i.value.company_list=[])},delSettlementDetail:()=>{e.emit("delSettlementDetail")},itemDisabled:e=>(t.disabledTypeList??[]).includes(e)};return{isLiveDouyinNew:l,SettlementIncomeType:o.eY,currentRef:s,desc:c,costOptions:a,current:r,dataForm:i,...u}}}),Gt=Zt,Et=(0,C.Z)(Gt,kt,Ct,!1,null,null,null),Jt=Et.exports;const Yt=20,Ht=t=>{const e=e=>{fetch(e).then((async e=>{const a=e.clone();try{const e=await a.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob(),a="kol_schedule.xlsx";(0,f.uA)(t,a)}else t.root.$message.error("下载失败")}}))};return{downloadFileHandler:e}},qt=t=>{if(t.adjust_info&&t.adjust_info?.length>=1){const e=t.adjust_info.filter((t=>t.type||t.adjust_reason||t.adjust_amount));if(e.length>0)return e}return[]},Ut=t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],Kt=(t,e=8)=>{const a=new RegExp(`(?:0|[1-9]\\d{0,${e-1}})(?:\\.\\d{0,2})?`,"u"),n=(a.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];return n},Wt=()=>({company_id:"",company_name:"",file:void 0,income_amount:"",type:void 0,company_list:[],company_info_list:[]});var Vt=(0,n.defineComponent)({name:"TgCostSettmentDataForm",components:{Step2Layout:it,TgAdjustAccountForm:A.Z,TopCard:N.Z,CostDetail:Jt,CardLayout:$.Z},props:{},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.ref)(!1),i=(0,n.inject)("project")??(0,n.ref)(void 0),{downloadFileHandler:l}=Ht(e),r=[{label:"时薪",value:1},{label:"底薪/提成(取高的)",value:2},{label:"底薪+提成",value:3}],c=(0,n.ref)({sale_amount:[{required:!0,message:"请输入净销额",trigger:"change"}],base_salary:[{required:!0,message:"请输入底薪",trigger:"change"}],commission_rate:[{required:!0,message:"请输入提成比例",trigger:"change"}],unit_price:[{required:!0,message:"请输入单价",trigger:"change"}],live_duration:[{required:!0,message:"请输入开播时长",trigger:"change"}]}),u=(0,n.ref)(void 0),d=(0,n.inject)("settlement")??(0,n.ref)(void 0),m=(0,n.ref)({adjust_info:[],json_data:{company_info_list:[],nofind:[]},settlement_info_list:[Wt()]}),p=t=>{let e="0";t.salary_type===o.$m.Hourly?e=(0,lt.fv)(t.unit_price,t.live_duration):t.salary_type===o.$m.Basic_or_commision?e=(0,lt.XX)(t.base_salary,t.sale_amount,t.commission_rate):t.salary_type===o.$m.Basic_and_commision&&(e=(0,lt.kN)(t.base_salary,t.sale_amount,t.commission_rate)),t.salary=e;const a=(0,v.FU)(e)+" 元";return{...t,salary:e,salary_str:a}},g=t=>{let e=new(_())("0");for(const a of m.value.adjust_info)if(t.kol_salary_infos.find((t=>t.kol_name===a.kol_name))){let t=a.adjust_amount;isNaN(Number(t))&&(t="0"),e=e.add(new(_())(t||"0"))}return e},x=t=>{const e=t.kol_salary_infos.map((t=>p(t))),a=e.reduce(((t,e)=>new(_())(e.salary?e.salary:0).add(t)),new(_())("0")),n=g(t);let o=new(_())(t.fwf?t.fwf:0);return"1"===`${t.fwfsqfs}`&&(isNaN(Number(t.fwfbfb))?o=new(_())("0"):(o=new(_())(Number(t.fwfbfb)).div(new(_())(100)).mul(a.add(n)),t.fwf=o.toFixed(2))),t.jszje=n.add(a).add(o).toFixed(2),t.zbfwf=a.add(n).toFixed(2),{...t,calc_kol_salary_infos:e}},h=(0,n.computed)((()=>m.value.json_data.company_info_list?m.value.json_data.company_info_list.map((t=>x(t))):[])),b=(0,n.computed)((()=>{let t=0;const e=m.value.settlement_info_list||[];for(let a=0;a<e.length;a++){const n=e[a];if(n.type===o.eY.anchor){const e=(0,lt.Ut)(h.value.map((t=>t.jszje)),void 0);t+=Number(e)}else{let e=n.income_amount?n.income_amount:"0";e=isNaN(Number(e))?"0":e,t=Number(new(_())(e).add(t)),n.company_list?.forEach((e=>{let a=e.income_amount?e.income_amount:"0";a=isNaN(Number(a))?"0":a,t=Number(new(_())(a).add(t))}))}}if(m.value.adjust_info&&m.value.adjust_info?.length>=1){const e=m.value.adjust_info.filter((t=>(t.kol_name||t.company_name)&&t.adjust_amount));e.forEach((e=>{if(9!==e.type){let a=e.adjust_amount?e.adjust_amount:"0";a=isNaN(Number(a))?"0":a,t=Number(new(_())(a).add(t))}}))}return t.toFixed(2)})),k=(0,n.computed)((()=>(0,v.SJ)(new(_())(b.value)))),C=t=>{const e=`/api/settlement/download_kol_schedule?settlement_id=${d.value?.id}&company_id=${t}&Authorization=${(0,rt.LP)()}`;l(e)},S=(t,e)=>{const a=Ut(t);m.value.json_data.company_info_list[e].fwfbfb=a},w=(t,e)=>{const a=Kt(t,6);m.value.json_data.company_info_list[e].fwf=a},j=(t,e,a)=>{const n=Ut(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].commission_rate=n},D=(t,e,a)=>{const n=Kt(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].unit_price=n},F=(t,e,a)=>{const n=Kt(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].base_salary=n},$=(t,e,a)=>{const n=Kt(t);m.value.json_data.company_info_list[e].kol_salary_infos[a].sale_amount=n},A=(t,e,a)=>{const n=(/(?:0|[1-9]\d{0,5})(?:\.[05]{0,1})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];m.value.json_data.company_info_list[e].kol_salary_infos[a].live_duration=n},L=(0,n.ref)(void 0),N=(0,n.ref)({adjust_info:[],json_data:{nofind:[],company_info_list:[]},settlement_info_list:[Wt()]}),T=(0,n.computed)((()=>2===i.value?.business_type||3===i.value?.business_type||7===i.value?.business_type)),z=(0,n.computed)((()=>m.value.json_data.company_info_list.map((t=>{const e=t.kol_salary_infos.map((t=>T.value&&t.real_name?{id:t.kol_id,name:t.kol_name,real_name:`${t.kol_name}(${t.real_name})`}:{id:t.kol_id,name:`${t.kol_name}`}));return e})).flat()));(0,n.ref)([]);const B=(0,n.ref)(!1),P=t=>{const e=(0,ct.I8)(t.adjust_info),a=[];if(e.map((t=>{t.type=t.type||9,a.push(t)})),m.value.adjust_info=a,t.json_data?.company_info_list&&t.json_data?.company_info_list.length>0){const e=t.json_data.company_info_list[0];if(e.type){m.value.settlement_info_list=JSON.parse(JSON.stringify(t.json_data.company_info_list));const e=dt(9);e&&(m.value.json_data={company_info_list:e.company_list,nofind:e.nofind||t.json_data.nofind})}else m.value.json_data=(0,ct.I8)(t.json_data),t.json_data&&(m.value.settlement_info_list=[{type:9,company_list:[],...t.json_data}])}else m.value.json_data={company_info_list:[],nofind:t.json_data?.nofind||[]};N.value.adjust_info=a,N.value.settlement_info_list=JSON.parse(JSON.stringify(m.value.settlement_info_list)),N.value.json_data=JSON.parse(JSON.stringify(m.value.json_data))},O=(0,n.ref)([]),R=(0,n.ref)([]),M=(0,n.ref)([]);(0,n.watch)((()=>O.value),(t=>{R.value.forEach((t=>{t()})),t.length>Yt?O.value.forEach(((t,e)=>{window.setTimeout((()=>{const{stop:e}=(0,Y.useIntersectionObserver)((0,n.computed)((()=>t)),((t,e)=>{M.value.push(!0)}));R.value.push(e)}),17)})):(0,Y.set)(B,!1)}));const Z=(0,n.computed)((()=>`正在加载主播数据(${M.value.length}/${O.value.length})`));(0,n.watch)((()=>M.value.length),(t=>{O.value.length===t&&(0,Y.set)(B,!1)}));const G=(0,n.ref)(!1),E=t=>{L.value=t,G.value=!0,t.kol_salary_infos.length>10?((0,Y.set)(B,!0),setTimeout((()=>{P(t)}),300)):P(t)},q=t=>{m.value.adjust_info=t},U=t=>{const e=L.value?.id??-1,a=[];m.value.settlement_info_list?.map((t=>{let e=t.company_list;9===t.type&&(e=m.value.json_data.company_info_list);const n={type:t.type,company_list:e};a.push(n)}));const n={id:e,total_settle_amount:b.value,adjust_info:t.adjust_info,json_data:{company_info_list:a}};return n},K=(t=!0)=>{const a=dt(9);if(a&&m.value.json_data.company_info_list.some((t=>t.kol_salary_infos.some((t=>![o.$m.Hourly,o.$m.Basic_or_commision,o.$m.Basic_and_commision].includes(t.salary_type))))))return"请选择主播成本结算方式";const s=(0,n.ref)([]);if(m.value.adjust_info&&m.value.adjust_info?.length>=1){const t=m.value.adjust_info.filter((t=>t.kol_name||t.company_name||t.adjust_reason||t.adjust_amount));if(t.some((t=>/^(?:\+|-)?0?(?:\.0{0,2})?$/u.test(t.adjust_amount))))return"请输入正确的调整金额";if(t.some((t=>"0"===t.adjust_amount)))return e.root.$message.error("调整金额不能为0"),"调整金额不能为0";if(!t.every((t=>(t.kol_name&&""!==t.kol_name||t.company_name&&""!==t.company_name)&&t.adjust_amount&&""!==t.adjust_amount&&"-"!==t.adjust_amount&&t.adjust_reason)))return"请完善手工调账信息";t.length>0&&(s.value=t)}return t&&s.value&&0===s.value.length&&["0","0.0","0.00"].includes(b.value??"0")?"至少填写一项结算项":t&&new(_())(b.value).lte("0")?"总结算金额必须大于0":void 0},W=()=>{setTimeout((()=>{u.value?.clearValidate?.()}),100)},V=async(t=!0,s=!1)=>{if(!a.value&&i.value){if(t){let a=!0,i="";if(m.value.settlement_info_list?.forEach((t=>{switch(t.type){case o.eY.put:{const e=t.company_list?.find((t=>!t.company_id||!t.income_amount));e&&(a=!1,i="请完善投放成本数据信息");break}case o.eY.other:{const e=t.company_list?.find((t=>!t.company_name&&t.income_amount||t.company_name&&!t.income_amount||!t.company_name&&!t.income_amount));e&&(a=!1,i="请完善其他成本数据信息");break}case o.eY.anchor:if((m.value.json_data?.nofind??[]).length)a=!1,i=`有${m.value.json_data?.nofind?.length??0}名主播没有对应机构，点击“查看明细”可以查看没有对应关系的主播列表`;else{let t=!1;m.value.json_data.company_info_list.filter((e=>{const a=e.kol_salary_infos.find((t=>1===t.salary_type?!t.live_duration||!t.unit_price:(t.salary_type,!t.base_salary||!t.sale_amount||!t.commission_rate)));a&&(t=!0)})),t&&(a=!1,i="请完善主播成本数据信息")}break;default:break}})),!a)return e.root.$message.warning(i),!1;if(!s){const a=K(t);if(a)return void e.root.$message.error(a)}const l=qt(m.value);if(l.length>0){const e=(0,n.ref)(!0);if(l.map((t=>{let a=!1;kt.value.map((e=>{e.name!==t.company_name&&e.name!==t.kol_name&&e.name!==t.hidden_name||(a=!0)})),!1===a&&(e.value=!1)})),!1===e.value){const e=await At(t);return e}{const e=await X(t);return e}}{const e=await X(t);return e}}{const e=await X(t);return e}}},X=async(t=!0,n=!1)=>{const s=i.value?.business_type||3,l=U(m.value);l.step=t?o.br.step_three:o.br.step_two,l.adjust_info=qt(m.value),a.value=!0;const[{data:r}]=await(0,f.Dc)(500,(0,y.bp)(l,s));return a.value=!1,r.success?(t?e.emit("next",r.data):n&&e.emit("setDialogVisible"),W()):e.root.$message.error(r.message??"保存失败"),r},Q=(0,Y.useDebounceFn)(V,200),tt=async()=>{if(at.value){const t=!1,a=!0,n=await V(t,a);n&&(n.success?e.emit("prev",n.data):e.root.$message.warning(n.message))}else e.emit("prev")},et=()=>{Q()},at=(0,n.computed)((()=>JSON.stringify(N.value)!==JSON.stringify(m.value))),nt=async()=>at.value,ot=async()=>{const t=!1,e=!0,a=await V(t,e);return!!a&&a.success},st=(0,n.ref)([{class:"a1"},{class:"b1"},{class:"c1"},{class:"c2"},{class:"c3"},{class:"d1"}]),it=(t,e)=>(e?.company_info_list.forEach((e=>{const a=t.company_info_list.find((t=>t.company_id===e.company_id));a&&(e.kol_salary_infos.forEach((t=>{const e=a.kol_salary_infos.find((e=>t.kol_id===e.kol_id));e&&(t.salary_type=e.salary_type,t.unit_price=e.unit_price,t.salary=e.salary,t.base_salary=e.base_salary,t.sale_amount=e.sale_amount,t.commission_rate=e.commission_rate)})),e.fwf=a.fwf,e.fwfbfb=a.fwfbfb,e.jszje=a.jszje,e.zbfwf=a.zbfwf,e.fwfsqfs=a.fwfsqfs)})),e??{company_info_list:[],nofind:[]}),dt=t=>m.value.settlement_info_list?.find((e=>e.type===t)),mt=async()=>{if(!d.value?.id)return;const t={id:d.value.id};s.value=!0;const a=await(0,y.S_)("live",t);if(s.value=!1,a.data.success){const t=a.data.data;m.value.json_data=it(m.value.json_data,t?.json_data)}else e.root.$message.warning(a.data.message??"获取结算详情失败，稍后重试")},pt=(0,n.ref)(!0);(0,n.watch)((()=>m.value.settlement_info_list),(()=>{if(pt.value){const t=dt(9);t&&(pt.value=!1,m.value.json_data.company_info_list&&0!==m.value.json_data.company_info_list.length||(t.company_info_list&&0!==t.company_info_list.length?(m.value.json_data.company_info_list=t.company_info_list,m.value.json_data.nofind=t.nofind||m.value.json_data.nofind||[]):_t()))}}),{deep:!0});const _t=async()=>{if(!d.value?.id)return;s.value=!0;const t=await(0,y.ix)(`${d.value.id}`);if(s.value=!1,t.data.success){const e=t.data.data;m.value.json_data=it(m.value.json_data,e?.json_data)}else e.root.$message.error(t?.data.message??"刷新失败，稍后重试")},vt=(0,n.reactive)({form:{},options:[],visible:!1,company:{},salary_info:{},companyIndex:0,salary_index:0,show(t,e,a,n){vt.company=t,vt.companyIndex=e,vt.salary_index=n,vt.salary_info=a,vt.form={company:t.company_id},vt.options=[{id:t.company_id,company_name:t.company_name}],vt.visible=!0},submit(){const t=vt.form;if(!t.company)return void H.Message.error("请选择公司");const e=vt.options.find((e=>e.id===t.company)),a=m.value.json_data.company_info_list.find((t=>t.company_id===e.id));if(e.id!==vt.company.company_id){if(vt.company.kol_salary_infos.splice(vt.salary_index,1),0===vt.company.kol_salary_infos.length&&m.value.json_data.company_info_list.splice(vt.companyIndex,1),void 0===a){const t={...vt.company};t.kol_salary_infos=[vt.salary_info],t.company_id=e.id,t.company_name=e.company_name,m.value.json_data.company_info_list.splice(vt.companyIndex,0,t)}else a.kol_salary_infos.push(vt.salary_info);(0,Y.set)(m.value.json_data,"company_info_list",[...m.value.json_data.company_info_list]),vt.visible=!1}else vt.visible=!1},close:()=>{vt.visible=!1},remoteMethod:t=>{""!==t?(0,ut.K)(t,1).then((t=>{vt.options=t})):vt.options=[]}}),ft=()=>{m.value.settlement_info_list?.unshift(Wt())},yt=t=>{m.value.settlement_info_list?.splice(t,1)},gt=(0,n.computed)((()=>m.value.settlement_info_list?.map((t=>t.type))??[])),xt=(0,n.computed)((()=>{const t=[],e=e=>!!t.find((t=>t.name===e)),a=m.value.settlement_info_list||[];for(let n=0;n<a.length;n++){const s=a[n];s.type===o.eY.put&&(s.company_name&&!e(s.company_name)&&t.push({id:s.company_id,name:s.company_name}),s.company_list?.forEach((a=>{a.company_name&&!e(a.company_name)&&t.push({id:a.company_id,name:a.company_name})})))}return t})),ht=(0,n.computed)((()=>{const t=[],e=e=>!!t.find((t=>t.name===e)),a=m.value.settlement_info_list||[];for(let n=0;n<a.length;n++){const s=a[n];s.type===o.eY.other&&(s.company_name&&!e(s.company_name)&&t.push({id:s.company_id,name:s.company_name}),s.company_list?.forEach((a=>{a.company_name&&!e(a.company_name)&&t.push({id:a.company_id,name:a.company_name})})))}return t})),bt=(0,n.computed)((()=>{const t=[],e=m.value.settlement_info_list||[];for(let a=0;a<e.length;a++){const n=e[a];if(n.type===o.eY.anchor){const e=m.value.json_data.company_info_list?m.value.json_data.company_info_list.map((t=>{const e=t.kol_salary_infos.map((t=>T.value?{id:t.kol_id,name:t.kol_name,real_name:`${t.kol_name}(${t.real_name})`}:{id:t.kol_id,name:`${t.kol_name}`}));return e})).flat():[];t.push(...e)}}return t})),kt=(0,n.computed)((()=>{const t=[],e=e=>!!t.find((t=>t.name===e)),a=m.value.settlement_info_list||[];for(let n=0;n<a.length;n++){const s=a[n];if(s.type===o.eY.anchor){const e=m.value.json_data.company_info_list?m.value.json_data.company_info_list.map((t=>{const e=t.kol_salary_infos.map((t=>T.value?{id:t.kol_id,name:t.kol_name,real_name:`${t.kol_name}(${t.real_name})`}:{id:t.kol_id,name:`${t.kol_name}`}));return e})).flat():[];t.push(...e)}else s.company_name&&!e(s.company_name)&&t.push({id:s.company_id,name:s.company_name}),s.company_list?.forEach((a=>{a.company_name&&!e(a.company_name)&&t.push({id:a.company_id,name:a.company_name})}))}return t})),Ct=(0,n.ref)(null),St=(0,n.ref)(0),wt=(0,n.ref)(0),jt=(0,n.ref)(!1),Dt=()=>{jt.value=!0,window.addEventListener("scroll",$t,!0)},Ft=()=>{jt.value=!1,window.removeEventListener("scroll",$t,!0)},$t=t=>{St.value=t.target.scrollTop||0,jt.value&&(jt.value=!1,wt.value=t.target.scrollTop||0);const e=Math.abs(Number(wt.value)-Number(St.value));e>50&&(Ct.value instanceof Array?Ct.value[0].showPopper=!1:Ct.value.showPopper=!1,window.removeEventListener("scroll",$t,!0))},At=async(t,a="手工调账中部分公司没有对应结算数据，点击确定将自动删除进入下一步，是否继续？")=>{const n=await(0,J.I)(e,{title:a,content:""});if(!n)return!1;let o=!1;const s=[],i=qt(m.value);i.map((t=>{kt.value.map((e=>{e.name!==t.company_name&&e.name!==t.kol_name&&e.name!==t.hidden_name||(o=!0)})),!0===o&&(s.push(t),o=!1)})),m.value.adjust_info=s;const l=X(t,!0);return l};return{onDeleteBtnClick:At,popover:Ct,startShow:Dt,endShow:Ft,getSettlementDetail:mt,getDetailbyType:dt,selectedallCompanyList:kt,selectedOtherCompanyList:ht,kolSelectOptions:bt,selectedIncomeTypeList:gt,selectedCompanyList:xt,addSettlementDetail:ft,delSettlementDetail:yt,hasDianBo:T,project:i,dialogCompany:vt,formRules:c,formRef:u,total_amount_str:k,ShowAdjustInfo:G,fwRateInput:S,downloadKolScheduleFile:C,skeletonItems:st,loadingKolText:Z,target:O,KolSelectOptions:z,ComputedCompanyData:h,total_amount:b,LiveDurationInput:A,fwfInput:w,BaseSalaryInput:F,SaleAmountInput:$,CommissionRateInput:j,UnitPriceInput:D,SettlementTypeOptions:r,DataForm:m,saveLoading:a,fill_form_loading:B,onAdjustAccountDataChange:q,onSaveHandler:Q,fillForm:E,prev:tt,next:et,confirmBeforeClose:nt,saveBeforeClose:ot,reloadRelationship:_t,relocationshipLoading:s,formatAmountWithoutPrefix:v.FU}}}),Xt=Vt,Qt=(0,C.Z)(Xt,ht,bt,!1,null,"c32a3202",null),te=Qt.exports,ee=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"settlement-step3-shoplive-before",attrs:{topHeightType:"default"},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount,type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("section",{staticClass:"company-list before-customer-list"},t._l(t.companyarr,(function(e,n){return a("div",{key:n,staticClass:"before-customer"},[a("div",{staticClass:"before-customer-name",staticStyle:{"margin-bottom":"4px","margin-top":"10px","font-weight":"600"}},[t._v(" "+t._s(e)+" ")]),t._l(t.feeNameTypes,(function(n,o){return a("div",{directives:[{name:"show",rawName:"v-show",value:t.getDetailByCompany(e),expression:"getDetailByCompany(companyName)"}],key:o,staticClass:"before-income-row mgt-12"},[9!==n.type&&t.getDetailByCompany(e)&&t.amountDetail(n.type,t.getDetailByCompany(e))?a("div",{staticClass:"before-income-row-detail"},[a("span",{staticClass:"label"},[t._v(t._s(n.name)+"：")]),a("span",{staticClass:"value"},[t._v(t._s(t.income_amount(n.type,t.getDetailByCompany(e)))+" 元")]),8===n.type&&t.isYufengCompany(e)?a("tg-button",{staticClass:"downerload",attrs:{type:"link"},on:{click:function(){return t.onDownloadPutDetail(n.type,t.getDetailByCompany(e))}}},[t._v("下载明细")]):t._e()],1):t._e(),1!==n.type&&t.remark(n.type,t.getDetailByCompany(e))?a("div",{staticClass:"other-desc"},[t._v(" "+t._s(t.remark(n.type,t.getDetailByCompany(e)))+" ")]):t._e(),9===n.type&&t.getDetailByCompany(e)&&t.amountDetail(9,t.getDetailByCompany(e))?a("div",{staticClass:"before-income-row-detail"},[a("div",{staticClass:"company-total-cost-info"},[a("div",{staticStyle:{width:"84px","text-align":"right",color:"#6a7b92"}},[t._v("主播成本：")]),a("div",[a("div",{staticClass:"cost-summary"},[t._v(" "+t._s(t.Decimal2String(new t.Decimal(t.amountDetail(9,t.getDetailByCompany(e)).jszje?t.amountDetail(9,t.getDetailByCompany(e)).jszje:0)))+" 元 "),a("span",{staticClass:"company-tag",staticStyle:{"margin-left":"10px"}},[t._v(t._s(t.getTagName(t.amountDetail(9,t.getDetailByCompany(e)).fwfsqfs)))])]),a("div",{staticClass:"cost-detail"},[t._v(" "+t._s(t.cost_desc(t.amountDetail(9,t.getDetailByCompany(e))))+" ")]),a("div",{staticClass:"company-kol-num-info",staticStyle:{"margin-top":"4px"}},[a("div",{staticClass:"company-label"},[t._v("主播数量：")]),a("div",{staticStyle:{display:"flex","justify-content":"flex-start"}},[a("div",{staticClass:"num-summary"},[t._v(" "+t._s(t.amountDetail(9,t.getDetailByCompany(e)).kol_salary_infos.length)+" 名 ")]),a("div",{staticClass:"num-list",staticStyle:{"margin-top":"0px","margin-left":"30px",color:"#606266"}},[a("span",[a("tg-button",{attrs:{type:"link"},on:{click:function(a){t.getKolCostFile(t.getDetailByCompany(e)[0].company_id,e)}}},[t._v("下载")]),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播费用清单")])],1),a("span",{staticClass:"mgl-16"},[a("tg-button",{attrs:{type:"link"},on:{click:function(a){t.getKolscheduleFile(t.getDetailByCompany(e)[0].company_id,e)}}},[t._v("下载")]),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播排班明细")])],1)])])])])])]):t._e()])})),t.getAdjustByCompany(e)&&t.getAdjustByCompany(e).length>0?a("div",{staticClass:"before-adjust-info mgt-12"},[a("div",{staticClass:"mgt-12"},[a("span",{staticClass:"label"},[t._v("手工调账：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(t.getAdjustAmountByCompany(e)))+" 元")])]),t._l(t.getAdjustByCompany(e),(function(e,n){return a("div",{key:n,staticStyle:{"margin-left":"80px","margin-top":"4px"}},[a("div",[a("span",{staticClass:"other-desc",staticStyle:{"margin-left":"0px"}},[t._v(" "+t._s(8===e.type?"投放成本:":"其他成本:"))]),a("span",{staticClass:"value",staticStyle:{width:"300px","margin-left":"10px"}},[t._v(t._s(t.formatAmountWithoutPrefix(e.adjust_amount))+" 元 ")])]),a("div",{staticClass:"other-desc",staticStyle:{"margin-left":"70px"}},[t._v(t._s(e.adjust_reason))])])}))],2):t._e()],2)})),0)]},proxy:!0},t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("生成结算单")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在生成结算单，请稍候..."}})]},proxy:!0}],null,!0)})},ae=[];const ne=t=>{const e=(e,a)=>{fetch(e).then((async e=>{const n=e.clone();try{const e=await n.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob();(0,f.uA)(t,a)}else t.root.$message.error("下载失败")}}))};return{downloadAPIFileHandler:e}};var oe=(0,n.defineComponent)({name:"TgShopLiveCostSettmentSubmitForm",components:{SettlementStep3Layout:it,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("settlement")??(0,n.ref)(void 0),i=(0,n.computed)((()=>{if(s.value?.json_data&&s.value?.json_data.company_info_list.length>0){const t=s.value?.json_data.company_info_list[0],e=[];if(t.type)return s.value?.json_data.company_info_list.map((t=>{t.company_list&&t.company_list.map((a=>{a.type=t.type,e.push(a)}))})),e;{const t=[];return s.value?.json_data.company_info_list.map((e=>{const a=JSON.parse(JSON.stringify(e));a.type=9,t.push(a)})),t}}return[]})),l=(0,n.computed)((()=>s.value?.adjust_info?s.value.adjust_info:[])),r=(0,n.computed)((()=>{if(s.value?.json_data&&s.value?.json_data.company_info_list.length>0){const t=s.value?.json_data.company_info_list[0],e=[];if(t.type)return s.value?.json_data.company_info_list.map((t=>{t.company_list&&t.company_list.map((t=>{const a=e.find((e=>e===t.company_name));a||e.push(t.company_name)}))})),e;{const t=[];return s.value?.json_data.company_info_list.map((e=>{const a=t.find((t=>t===e.company_name));a||t.push(e.company_name)})),t}}return[]})),{downloadAPIFileHandler:c}=ne(e),{downloadFileHandler:u}=(0,lt.r7)(e),d=(0,n.ref)({detail_file:"",adjust_info:[],kol_salary_infos:[],new_json_data:[],settlement_files:[]}),m=(0,n.ref)([]),p=(0,n.ref)([]),f=(t,e)=>{const a=`/api/settlement/download_kol_schedule?settlement_id=${s.value?.id}&company_id=${t}&Authorization=${(0,rt.LP)()}`;x(a,`${e}的主播排班明细`)},g=(t,e)=>{const a=`/api/settlement/download_company_salary?settlement_id=${s.value?.id}&company_id=${t}&Authorization=${(0,rt.LP)()}`;x(a,`${e}的主播费用清单`)},x=(t,e)=>{c(t,e)},h=async()=>{e.emit("prev")},b=async()=>{const t=await(0,J.I)(e,{title:"确定生成结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","将对本次结算生成对应的结算单"),(0,n.h)("div","是否需要生成？")]),confirmText:"确定",cancelText:"取消"});t&&S()},k=async()=>!1,C=async()=>!1,S=async()=>{if(!s.value?.id)return;a.value=!0;const t=await(0,y.PK)({settlement_id:s.value?.id});a.value=!1,t.data.success?(e.root.$message.success(t.data.message??"生成结算单成功"),e.emit("submit:success")):e.root.$message.error(t.data.message??"生成结算单失败")},w=t=>{const e=`${t}`;return"1"===e?"抽成服务费":"2"===e?"固定服务费":""},j=t=>{let e=`主播服务费 ${t.zbfwf} 元，机构服务费 ${t.fwf||"0"} 元`;return"1"===t.fwfsqfs&&(e=`${e}(${t.fwfbfb||"0"}%)`),e},D=(0,n.computed)((()=>{const t=[];return o.mR.forEach(((e,a)=>{t.push({type:a,name:e})})),t})),F=(t,e)=>e.find((e=>e.type===t)),$=(t,e)=>(0,v.FU)(F(t,e).income_amount??0),A=()=>{const t=(0,Bt.t)(),e=t.currentRoute.params.id;window.open((0,zt.uE)(e,s.value?.start_date??0,s.value?.end_date??0))},I=t=>{window.open((0,zt.e2)(s.value?.id,t.company_id,2))},L=t=>t===zt.QN,N=(t,e)=>F(t,e)?.remark,T=t=>i.value.filter((e=>e.company_name===t)),z=t=>l.value.filter((e=>e.company_name===t)),B=t=>{const e=l.value.filter((e=>e.company_name===t));let a=0;return e.map((t=>{let e=t.adjust_amount?t.adjust_amount:"0";e=isNaN(Number(e))?"0":e,a=Number(new(_())(e).add(a))})),a};return{getAdjustAmountByCompany:B,getAdjustByCompany:z,getDetailByCompany:T,adjust_data:l,companyarr:r,company_data:i,remark:N,feeNameTypes:D,onDownloadPutDetail:A,isYufengCompany:L,onDownloadPitFeeDetail:I,amountDetail:F,income_amount:$,getKolscheduleFile:f,getKolCostFile:g,downloadKolAPIFile:x,settlement:s,DataForm:d,saveLoading:a,schedule_file_list:m,uploadedFileList:p,formatAmountWithoutPrefix:v.FU,downloadFileHandler:u,prev:h,next:b,getTagName:w,cost_desc:j,saveBeforeClose:k,confirmBeforeClose:C,Decimal2String:v.SJ,Decimal:_()}}}),se=oe,ie=(0,C.Z)(se,ee,ae,!1,null,"2ffb1b32",null),le=ie.exports,re=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"settlement-step3-shoplive-before",attrs:{topHeightType:"default"},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount,type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{attrs:{padding:18},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("主播工资")]},proxy:!0},{key:"desc",fn:function(){return[a("div",{staticStyle:{cursor:"pointer","line-height":"14px",height:"14px","margin-left":"-6px"}},[a("el-popover",{attrs:{offset:130,"popper-class":"kol-tips-popper",placement:"bottom",trigger:"hover"}},[a("div",[a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("时薪工资")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 单价 * 时长")]),a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("底薪/提成（取高的）")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 底薪和（净销额）*提成比例取高的")]),a("div",{staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v("底薪+提成")]),a("div",{staticStyle:{color:"#6a7b92"}},[t._v("主播工资 = 底薪 + （净销额）*提成比例")])]),a("template",{slot:"reference"},[a("tg-icon",{staticStyle:{"font-size":"14px"},attrs:{name:"ico-question"}})],1)],2)],1)]},proxy:!0}])},[a("section",{staticClass:"company-list"},t._l(t.company_data,(function(e,n){return a("div",{key:n},[a("div",{staticClass:"company"},[a("span",{staticClass:"company-name"},[t._v(t._s(e.company_name))]),a("span",{staticClass:"company-tag"},[t._v(t._s(t.getTagName(e.fwfsqfs)))])]),a("div",{staticClass:"company-total-cost-info"},[a("div",{staticClass:"company-label"},[t._v("总费用：")]),a("div",[a("div",{staticClass:"cost-summary"},[t._v(" "+t._s(t.Decimal2String(new t.Decimal(e.jszje?e.jszje:0)))+" 元 ")]),a("div",{staticClass:"cost-detail"},[t._v(t._s(t.cost_desc(e)))])])]),a("div",{staticClass:"company-kol-num-info"},[a("div",{staticClass:"company-label"},[t._v("主播数量：")]),a("div",[a("div",{staticClass:"num-summary"},[t._v(t._s(e.kol_salary_infos.length)+" 名")]),a("div",{staticClass:"num-list"},[a("span",[a("tg-button",{attrs:{type:"link"},on:{click:function(a){return t.getKolCostFile(e.company_id,e.company_name)}}},[t._v("下载")]),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播费用清单")])],1),a("span",{staticClass:"mgl-16"},[a("tg-button",{attrs:{type:"link"},on:{click:function(a){return t.getKolscheduleFile(e.company_id,e.company_name)}}},[t._v("下载")]),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播排班明细")])],1)])])])])})),0)])]},proxy:!0},t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("生成结算单")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在生成结算单，请稍候..."}})]},proxy:!0}],null,!0)})},ce=[];const ue=t=>{const e=(e,a)=>{fetch(e).then((async e=>{const n=e.clone();try{const e=await n.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob();(0,f.uA)(t,a)}else t.root.$message.error("下载失败")}}))};return{downloadAPIFileHandler:e}};var de=(0,n.defineComponent)({name:"TgShopLiveCostSettmentSubmitForm",components:{SettlementStep3Layout:it,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.ref)(!1),o=(0,n.inject)("settlement")??(0,n.ref)(void 0),s=(0,n.computed)((()=>{if(o.value?.json_data&&o.value?.json_data?.company_info_list&&o.value?.json_data?.company_info_list.length>0){const t=o.value?.json_data.company_info_list[0];return t.type?t.company_list:o.value.json_data.company_info_list}return[]})),{downloadAPIFileHandler:i}=ue(e),{downloadFileHandler:l}=(0,lt.r7)(e),r=(0,n.ref)({detail_file:"",adjust_info:[],kol_salary_infos:[],settlement_files:[]}),c=(0,n.ref)([]),u=(0,n.ref)([]),d=(t,e)=>{const a=`/api/settlement/download_kol_schedule?settlement_id=${o.value?.id}&company_id=${t}&Authorization=${(0,rt.LP)()}`;p(a,`${e}的主播排班明细`)},m=(t,e)=>{const a=`/api/settlement/download_company_salary?settlement_id=${o.value?.id}&company_id=${t}&Authorization=${(0,rt.LP)()}`;p(a,`${e}的主播费用清单`)},p=(t,e)=>{i(t,e)},f=async()=>{e.emit("prev")},g=async()=>{const t=await(0,J.I)(e,{title:"确定生成结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","将对本次结算生成对应的结算单"),(0,n.h)("div","是否需要生成？")]),confirmText:"确定",cancelText:"取消"});t&&b()},x=async()=>!1,h=async()=>!1,b=async()=>{if(!o.value?.id)return;a.value=!0;const t=await(0,y.PK)({settlement_id:o.value?.id});a.value=!1,t.data.success?(e.root.$message.success(t.data.message??"生成结算单成功"),e.emit("submit:success")):e.root.$message.error(t.data.message??"生成结算单失败")},k=t=>{const e=`${t}`;return"1"===e?"抽成服务费":"2"===e?"固定服务费":""},C=t=>{let e=`主播服务费 ${t.zbfwf||""} 元，机构服务费 ${t.fwf||"0"} 元`;return"1"===t.fwfsqfs&&(e=`${e}(${t.fwfbfb||"0"}%)`),e};return{company_data:s,getKolscheduleFile:d,getKolCostFile:m,downloadKolAPIFile:p,settlement:o,DataForm:r,saveLoading:a,schedule_file_list:c,uploadedFileList:u,formatAmountWithoutPrefix:v.FU,downloadFileHandler:l,prev:f,next:g,getTagName:k,cost_desc:C,saveBeforeClose:x,confirmBeforeClose:h,Decimal2String:v.SJ,Decimal:_()}}}),me=de,pe=(0,C.Z)(me,re,ce,!1,null,null,null),_e=pe.exports,ve=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("Step2Layout",{staticClass:"settlement-step2-shoplive-after",attrs:{amount:t.total_amount_str},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,taxed:t.DataForm.is_include_tax,type:"value1",tax_rate_disabled:!1,tax_rate:t.DataForm.tax_rate},on:{taxRateChanged:t.taxRateChanged,taxedChanged:t.taxedChangedHandler,valueChange:t.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{directives:[{name:"loading",rawName:"v-loading",value:t.fill_form_loading,expression:"fill_form_loading"}],staticClass:"settlement-left-block",attrs:{"element-loading-background":"rgba(0, 0, 0, 0.25)"},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本信息")]},proxy:!0}])},[a("div",{ref:"root",staticClass:"AnchorListBlock"},[a("el-form",{ref:"formRef",attrs:{model:t.DataForm,size:"small","label-width":"76px"},nativeOn:{submit:function(t){t.preventDefault()}}},[a("div",{staticStyle:{height:"195px"}},[[a("div",{staticClass:"OneItem"},[a("div",{staticStyle:{height:"32px","line-height":"32px"}},[a("div",{staticStyle:{display:"inline-block"}},[a("div",{staticClass:"label",staticStyle:{width:"100px"}},[t._v("机构")]),a("span",{staticStyle:{"font-weight":"600"}},[t._v(t._s(t.DataForm.company_name))])]),a("div",{staticStyle:{display:"inline-block",float:"right"}},[a("tg-button",{attrs:{type:"link"},on:{click:function(e){return t.downloadKolServiceFeeFile("主播费用清单.xlsx")}}},[t._v("下载"),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播费用清单")])]),t._v("   "),a("tg-button",{attrs:{type:"link"},on:{click:function(e){return t.downloadKolScheduleFile("主播排班明细.xlsx")}}},[t._v("下载"),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播排班明细")])])],1)]),a("div",{staticStyle:{"margin-top":"12px",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px"}},[t._v("主播服务费")]),a("span",{staticStyle:{"font-weight":"600"}},[t._v(t._s(t.kol_service_amount_str)+" 元")])]),a("div",{staticStyle:{"margin-top":"12px",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px"}},[t._v("服务费收取方式")]),a("el-input",{staticClass:"input-with-select",staticStyle:{width:"280px"},attrs:{placeholder:"",size:"small"},on:{input:t.CompanyServiceRateInput},model:{value:t.service_fee_value,callback:function(e){t.service_fee_value=e},expression:"service_fee_value"}},[a("el-select",{staticStyle:{width:"120px"},attrs:{slot:"prepend",placeholder:"请选择",size:"small"},slot:"prepend",model:{value:t.DataForm.company_service_type,callback:function(e){t.$set(t.DataForm,"company_service_type",e)},expression:"DataForm.company_service_type"}},[a("el-option",{attrs:{label:"抽成服务费",value:"1"}}),a("el-option",{attrs:{label:"固定费用",value:"2"}})],1),a("div",{attrs:{slot:"append"},slot:"append"},["1"===t.DataForm.company_service_type?a("span",[t._v("%")]):a("span",[t._v("元")])])],1)],1),a("div",{staticStyle:{display:"inline-block","margin-top":"12px",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px"}},[t._v("机构服务费")]),a("span",{staticStyle:{"font-weight":"600"}},[t._v(t._s(t.company_service_amount_str))])])])]],2)])],1)])]},proxy:!0},{key:"right",fn:function(){return[a("div",[a("el-form",{attrs:{size:"small","label-width":"68px"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{height:380,adjust_info:t.DataForm.adjust_info},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},fe=[];const ye=(0,rt.LP)(),ge=t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],xe=t=>{const e=(/(?:0|[1-9]\d{0,5})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];return e},he=t=>{const e=(e,a="")=>{fetch(e).then((async e=>{const n=e.clone();try{const e=await n.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob(),n="kol_schedule.xlsx",o=""!==a?a:n;(0,f.uA)(t,o)}else t.root.$message.error("下载失败")}}))};return{downloadFileHandler:e}},be=t=>{if(t.adjust_info&&t.adjust_info?.length>=1){const e=t.adjust_info.filter((t=>t.adjust_reason||t.adjust_amount));if(e.length>0)return e}return[]},ke=(t,e,a)=>{const n=(0,lt.sO)(a),o=new(_())(""!==t?t:"0").add(""!==e?e:"0");return o.add(n).toFixed(2).toString()};var Ce=(0,n.defineComponent)({name:"TgCostSettmentDataForm",components:{Step2Layout:it,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},props:{},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("project")??(0,n.ref)(void 0),{downloadFileHandler:i}=he(e),l=(0,n.ref)(null),r=(0,n.ref)({kol_name:"",company_name:"",adjust_info:[],is_include_tax:1,company_service_type:"1",company_service_rate:"",company_service_amount:"",kol_service_amount:"",tax_amount:"",tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",json_data:{amount_info_list:[]}}),c=t=>r.value.json_data?r.value.json_data.amount_info_list?.find((e=>e.type===t)):null,u=(0,n.ref)(""),d=(0,n.computed)((()=>"1"===r.value.company_service_type?new(_())(u.value||0).div(100).mul(r.value.kol_service_amount||0).toFixed(2):u.value||0)),m=(0,n.computed)((()=>(0,v.SJ)(new(_())(r.value.company_service_amount||0)))),p=(0,n.computed)((()=>(0,v.SJ)(new(_())(r.value.kol_service_amount||0))));let g=r.value.company_service_amount;(0,n.watch)((()=>r.value.company_service_type),(()=>{"1"===r.value.company_service_type?(g=r.value.company_service_amount,u.value=r.value.company_service_rate):"2"===r.value.company_service_type&&(u.value=g||"",r.value.company_service_amount=g||"0")})),(0,n.watch)((()=>[u.value]),(t=>{t&&("1"===r.value.company_service_type?r.value.company_service_rate=u.value:g=u.value,r.value.company_service_amount=d.value.toString())}));const x=(0,n.computed)((()=>ke(r.value.kol_service_amount,r.value.company_service_amount,r.value.adjust_info))),h=(0,n.computed)((()=>(0,v.SJ)(new(_())(x.value)))),b=(0,n.inject)("settlement")??(0,n.ref)(void 0),k=(t,e)=>{const a=`/api/settlement/download_kol_schedule?company_id=${e}&settlement_id=${t}&Authorization=${ye}`;return a},C=t=>{const e=b.value?b.value.id.toString():"-1",a=k(e,w.value?.company_id.toString()??"-1");i(a,t)},S=t=>{const e=b.value?b.value.id.toString():"-1",a=w.value?.company_id.toString()??"-1",n=""!==r.value.company_service_amount?r.value.company_service_amount:0,o=(0,lt.sO)(r.value.adjust_info),s=`/api/settlement/download_company_salary?adjust_sum=${o}&fwf=${n}&company_id=${a}&settlement_id=${e}&Authorization=${ye}`;i(s,t)},w=(0,n.ref)(void 0),j=(0,n.ref)({kol_name:"",company_name:"",adjust_info:[],is_include_tax:1,company_service_type:"1",company_service_rate:"",company_service_amount:"",kol_service_amount:"",tax_amount:"",tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",json_data:{amount_info_list:[]}}),D=t=>t&&""!==t?"0"===t?"0.00":new(_())(t.toString()).toFixed(2).toString():"0.00",F=t=>"0"===t||0===t?"0.00":t&&""!==t?new(_())(t?.toString()).toFixed(2).toString():"",$=(0,n.ref)(!1),A=(0,n.ref)([]),I=t=>{if(r.value.company_name=t.company_name||"",t.json_data&&t.json_data.amount_info_list&&t.json_data.amount_info_list.length>0){r.value.json_data=JSON.parse(JSON.stringify(t.json_data));const e=c(9);e&&(r.value.company_service_amount=D(e.company_service_amount?.toString()||"0"),r.value.kol_service_amount=e.kol_service_amount?.toString()||"0",r.value.company_service_type=2===Number(e.company_service_type)?"2":"1",r.value.company_service_rate=e.company_service_rate?.toString()??"")}else r.value.company_service_amount=D(t.company_service_amount?.toString()||"0"),r.value.kol_service_amount=t.kol_service_amount?.toString()||"0",r.value.company_service_type=Number(2===t.company_service_type)?"2":"1",r.value.company_service_rate=t.company_service_rate?.toString()??"",r.value.json_data={amount_info_list:[{type:9}]};r.value.kol_salary_infos=t.kol_salary_infos||[],r.value.tax_amount=D(t.tax_amount??0),r.value.is_include_tax=t.is_include_tax?1:0,r.value.tax_rate=`${t.tax_rate?t.tax_rate:"0"}`,r.value.tax_excluded_amount=F(t.tax_excluded_amount??""),r.value.tax_included_amount=F(t.tax_included_amount??""),r.value.adjust_info=JSON.parse(JSON.stringify(t.adjust_info)),j.value.adjust_info=JSON.parse(JSON.stringify(t.adjust_info)),u.value="2"===r.value.company_service_type?String(r.value.company_service_amount):String(r.value.company_service_rate),j.value=JSON.parse(JSON.stringify(r.value))},L=(0,n.ref)(!1),N=t=>{w.value=t,L.value=!0,I(t)},T=t=>{r.value.adjust_info=t},z=t=>{const e=w.value?.id??-1,a=[],n="1"===t.company_service_type?t.company_service_rate:null;r.value.json_data?.amount_info_list.map((e=>{9===e.type?(e={type:9,company_service_amount:t.company_service_amount,company_service_type:t.company_service_type,company_service_rate:n,kol_service_amount:t.kol_service_amount},a.push(e)):a.push(e)}));const o={id:e,total_settle_amount:x.value,is_include_tax:t.is_include_tax,tax_amount:t.tax_amount,tax_rate:""===t.tax_rate?"0":t.tax_rate??"0",tax_included_amount:t.tax_included_amount,tax_excluded_amount:t.tax_excluded_amount,json_data:{amount_info_list:a}};return o},B=(t=!0)=>{const a=(0,n.ref)([]);if(r.value.adjust_info&&r.value.adjust_info?.length>=1){const t=r.value.adjust_info.filter((t=>t.adjust_reason||t.adjust_amount));if(t.some((t=>/^(?:\+|-)?0?(?:\.0{0,2})?$/u.test(t.adjust_amount))))return"请输入正确的调整金额";if(t.some((t=>"0"===t.adjust_amount)))return e.root.$message.error("调整金额不能为0"),"调整金额不能为0";if(!t.every((t=>""!==t.adjust_amount&&"-"!==t.adjust_amount&&t.adjust_reason)))return"请完善手工调账信息";t.length>0&&(a.value=t)}return t&&a.value&&0===a.value.length&&["0","0.0","0.00"].includes(x.value??"0")?"至少填写一项结算项":t&&new(_())(x.value??"0").lte("0")?"总结算金额必须大于0":void 0},P=()=>{setTimeout((()=>{l.value?.clearValidate?.()}),100)},O=async(t=!0,n=!1)=>{if(a.value)return;if(!s.value)return;const i=s.value.business_type,c=await new Promise((t=>{l.value?.validate((e=>t(e)))}));if(!c)return;if(!n){const a=B(t);if(a)return void e.root.$message.error(a)}const u=z(r.value);u.step=t?o.br.step_three:o.br.step_two,u.adjust_info=be(r.value),a.value=!0;const[{data:d}]=await(0,f.Dc)(500,(0,y.bp)(u,i));return a.value=!1,d.success?(t&&e.emit("next",d.data),P()):e.root.$message.error(d.message??"保存失败"),d},R=(0,Y.useDebounceFn)(O,200),M=async()=>{if(G.value){const t=!1,a=!0,n=await O(t,a);n&&(n.success?e.emit("prev",n.data):e.root.$message.warning(n.message))}else e.emit("prev")},Z=()=>{if(G.value)R();else{const t=!0,a=B(t);if(a)return void e.root.$message.error(a);e.emit("next",w.value)}},G=(0,n.computed)((()=>JSON.stringify(j.value)!==JSON.stringify(r.value))),E=async()=>G.value,J=async()=>{const t=!1,e=!0,a=await O(t,e);return!!a&&a.success},H=t=>{r.value.is_include_tax=t?1:0},q=t=>{const e="1"===r.value.company_service_type?ge(t):xe(t);u.value=e},U=t=>{r.value.is_include_tax=0===t.is_include_tax?0:1,r.value.tax_included_amount=t.tax_included_amount?.toString()??"",r.value.tax_excluded_amount=t.tax_excluded_amount?.toString()??"",r.value.tax_amount=t.tax_amount?.toString()??""},K=t=>{r.value.tax_rate=t};return{formRef:l,schedule_file_list:A,total_amount_str:h,ShowAdjustInfo:L,service_fee_value:u,company_service_amount_value:d,company_service_amount_str:m,kol_service_amount_str:p,CompanyServiceRateInput:q,taxRateChanged:K,taxedChangedHandler:H,taxValueChangeHandler:U,downloadKolScheduleFile:C,downloadKolServiceFeeFile:S,total_amount:x,DataForm:r,saveLoading:a,fill_form_loading:$,onAdjustAccountDataChange:T,onSaveHandler:R,fillForm:N,prev:M,next:Z,confirmBeforeClose:E,saveBeforeClose:J}}}),Se=Ce,we=(0,C.Z)(Se,ve,fe,!1,null,null,null),je=we.exports,De=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("Step2Layout",{staticClass:"settlement-step2-shoplive-after",attrs:{amount:t.total_amount_str,douyinLiveSelf:!0},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,taxed:t.DataForm.is_include_tax,type:"value1",tax_rate_disabled:!1,tax_rate:t.DataForm.tax_rate},on:{taxRateChanged:t.taxRateChanged,taxedChanged:t.taxedChangedHandler,valueChange:t.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{staticClass:"cost-info",attrs:{padding:[0,20]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v(t._s(t.DataForm.company_name))])]},proxy:!0}])},[[a("div",{staticClass:"amount-info-list",staticStyle:{"padding-top":"0px"}},t._l(t.feeNameTypes,(function(e,n){return a("div",{key:n},[9!==e.type&&t.amountDetail(e.type)?a("div",[a("div",{staticClass:"input-row mgt-24"},[a("span",{staticClass:"label"},[t._v(t._s(e.name))]),a("el-input",{staticStyle:{width:"240px",margin:"0 32px 0 12px"},attrs:{placeholder:"填写成本",value:t.income_amount(e.type),size:"small",disabled:8===e.type&&t.isYufengCompany},on:{input:function(a){return t.onIncomeAmountChanged(a,e.type)}}},[a("template",{slot:"append"},[t._v("元")])],2),8===e.type&&t.isYufengCompany?a("tg-button",{attrs:{type:"link"},on:{click:function(e){return t.downDetail()}}},[t._v("下载明细")]):t._e()],1),a("div",[t.remark(e.type)||6===e.type?a("el-input",{staticStyle:{width:"360px",height:"80px","margin-left":"68px","margin-top":"12px"},attrs:{value:t.remark(e.type),type:"textarea",placeholder:"请输入其他收入说明",maxlength:50,resize:"none"},on:{input:function(a){return t.remarkChanged(a,e.type)}}}):t._e()],1)]):t._e(),9===e.type&&t.amountDetail(e.type)?a("div",[a("div",{staticClass:"input-row mgt-18"},[a("div",{staticClass:"label",staticStyle:{height:"32px","line-height":"32px","align-self":"flex-start"}},[t._v(" "+t._s(e.name)+" ")]),a("div",{ref:"root",refInFor:!0,staticClass:"AnchorListBlock",staticStyle:{width:"600px"}},[a("el-form",{ref:"formRef",refInFor:!0,attrs:{model:t.DataForm,size:"small","label-width":"76px"},nativeOn:{submit:function(t){t.preventDefault()}}},[a("div",{staticStyle:{height:"145px"}},[[a("div",{staticClass:"OneItem"},[a("div",{staticStyle:{height:"32px","line-height":"32px"}},[a("div",{staticStyle:{display:"inline-block","margin-left":"12px"}},[a("span",{staticStyle:{"font-weight":"600"}},[t._v(t._s(t.company_kol_service_amount_str)+" 元")])])]),a("div",{staticStyle:{height:"32px","line-height":"32px",display:"flex","justify-content":"space-between"}},[a("div",[a("div",{staticClass:"label",staticStyle:{width:"82px"}},[t._v("主播服务费")]),a("span",{staticStyle:{"font-weight":"600"}},[t._v(t._s(t.kol_service_amount_str)+" 元")])]),a("div",{staticStyle:{display:"inline-block",float:"right"}},[a("tg-button",{attrs:{type:"link"},on:{click:function(e){return t.downloadKolServiceFeeFile("主播费用清单.xlsx")}}},[t._v("下载"),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播费用清单")])]),t._v("   "),a("tg-button",{attrs:{type:"link"},on:{click:function(e){return t.downloadKolScheduleFile("主播排班明细.xlsx")}}},[t._v("下载"),a("span",{staticStyle:{color:"#6a7b92"}},[t._v("主播排班明细")])])],1)]),a("div",{staticStyle:{height:"32px","line-height":"32px","margin-left":"10px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px"}},[t._v("服务费收取方式")]),a("el-input",{staticClass:"input-with-select",staticStyle:{width:"280px"},attrs:{placeholder:"",size:"small"},on:{input:t.CompanyServiceRateInput},model:{value:t.service_fee_value,callback:function(e){t.service_fee_value=e},expression:"service_fee_value"}},[a("el-select",{staticStyle:{width:"120px"},attrs:{slot:"prepend",placeholder:"请选择",size:"small"},slot:"prepend",model:{value:t.DataForm.company_service_type,callback:function(e){t.$set(t.DataForm,"company_service_type",e)},expression:"DataForm.company_service_type"}},[a("el-option",{attrs:{label:"抽成服务费",value:"1"}}),a("el-option",{attrs:{label:"固定费用",value:"2"}})],1),a("div",{attrs:{slot:"append"},slot:"append"},["1"===t.DataForm.company_service_type?a("span",[t._v("%")]):a("span",[t._v("元")])])],1)],1),a("div",{staticStyle:{display:"inline-block",height:"32px","line-height":"32px"}},[a("div",{staticClass:"label",staticStyle:{width:"82px"}},[t._v("机构服务费")]),a("span",{staticStyle:{"font-weight":"600"}},[t._v(t._s(t.company_service_amount_str||"0.00"))])])])]],2)])],1)])]):t._e()])})),0)]],2)]},proxy:!0},{key:"right",fn:function(){return[a("div",[a("el-form",{attrs:{size:"small","label-width":"68px"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{ExtendItem:"livedouyinselfAfter",ExtendItemSelectOptions:t.selectedallCompanyList,adjust_info:t.DataForm.adjust_info,height:380},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},Fe=[];const $e=(0,rt.LP)(),Ae=t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],Ie=t=>{const e=(/(?:0|[1-9]\d{0,5})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];return e},Le=t=>{const e=(e,a="")=>{fetch(e).then((async e=>{const n=e.clone();try{const e=await n.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob(),n="kol_schedule.xlsx",o=""!==a?a:n;(0,f.uA)(t,o)}else t.root.$message.error("下载失败")}}))};return{downloadFileHandler:e}},Ne=t=>{if(t.adjust_info&&t.adjust_info?.length>=1){const e=t.adjust_info.filter((t=>t.type||t.adjust_reason||t.adjust_amount));if(e.length>0)return e}return[]},Te=(t,e,a,n=0,o=0)=>{const s=(0,lt.sO)(a),i=Number(t||0)+Number(n)+Number(o),l=new(_())(String(i)).add(""!==e?e:"0");return l.add(s).toFixed(2).toString()};var ze=(0,n.defineComponent)({name:"TgCostSettmentDataForm",components:{Step2Layout:it,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},props:{},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("project")??(0,n.ref)(void 0),{downloadFileHandler:i}=Le(e),l=(0,n.ref)(null),r=(0,n.ref)({kol_name:"",company_name:"",adjust_info:[],is_include_tax:1,company_service_type:"1",company_service_rate:"",company_service_amount:"",kol_service_amount:"",tax_amount:"",tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",kol_salary_infos:[],json_data:{amount_info_list:[]}}),c=(0,n.ref)(""),u=(0,n.computed)((()=>"1"===r.value.company_service_type?new(_())(c.value||0).div(100).mul(Number(r.value.kol_service_amount||0)).toFixed(2):c.value||0)),d=(0,n.computed)((()=>(0,v.SJ)(new(_())(r.value.company_service_amount||0)))),m=(0,n.computed)((()=>(0,v.SJ)(new(_())(Number(r.value.kol_service_amount||0))))),p=(0,n.computed)((()=>{const t=Number(r.value.kol_service_amount)||0,e=Number(r.value.company_service_amount)||0;return(0,v.SJ)(new(_())(t+e||0))}));let g=r.value.company_service_amount;(0,n.watch)((()=>r.value.company_service_type),(()=>{"1"===r.value.company_service_type?(g=r.value.company_service_amount,c.value=r.value.company_service_rate):"2"===r.value.company_service_type&&(c.value=g||"",r.value.company_service_amount=g||"0")})),(0,n.watch)((()=>[c.value,r.value.adjust_info]),(t=>{t&&("1"===r.value.company_service_type?r.value.company_service_rate=c.value:g=c.value,r.value.company_service_amount=u.value.toString())}),{deep:!0});const x=(0,n.computed)((()=>Te(r.value.kol_service_amount,r.value.company_service_amount,r.value.adjust_info,X(6)?.amount||0,X(8)?.amount||0))),h=(0,n.computed)((()=>(0,v.SJ)(new(_())(x.value)))),b=(0,n.inject)("settlement")??(0,n.ref)(void 0),k=(t,e)=>{const a=`/api/settlement/download_kol_schedule?company_id=${e}&settlement_id=${t}&Authorization=${$e}`;return a},C=t=>{const e=b.value?b.value.id.toString():"-1",a=k(e,w.value?.company_id.toString()??"-1");i(a,t)},S=t=>{const e=b.value?b.value.id.toString():"-1",a=w.value?.company_id.toString()??"-1",n=""!==r.value.kol_service_amount?r.value.kol_service_amount:0,o=""!==r.value.company_service_amount?r.value.company_service_amount:0,s=(0,lt.sO)(r.value.adjust_info),l=`/api/settlement/download_company_salary?zbfwf=${n}&adjust_sum=${s}&fwf=${o}&company_id=${a}&settlement_id=${e}&Authorization=${$e}`;i(l,t)},w=(0,n.ref)(void 0),j=(0,n.ref)({kol_name:"",company_name:"",adjust_info:[],is_include_tax:1,company_service_type:"1",company_service_rate:"",company_service_amount:"",kol_service_amount:"",tax_amount:"",tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",json_data:{amount_info_list:[]}}),D=t=>t&&""!==t?"0"===t?"0.00":new(_())(t.toString()).toFixed(2).toString():"0.00",F=t=>"0"===t||0===t?"0.00":t&&""!==t?new(_())(t?.toString()).toFixed(2).toString():"",$=(0,n.ref)(!1),A=(0,n.ref)([]),L=t=>{if(r.value.company_name=t.company_name||"",t.json_data&&t.json_data.amount_info_list&&t.json_data.amount_info_list.length>0){r.value.json_data=JSON.parse(JSON.stringify(t.json_data));const e=X(9);e&&(g=D(e.company_service_amount?.toString()||"0"),r.value.company_service_amount=D(e.company_service_amount?.toString()||"0"),r.value.kol_service_amount=e.kol_service_amount?.toString()||"0",r.value.company_service_type=2===Number(e.company_service_type)?"2":"1",r.value.company_service_rate=e.company_service_rate?.toString()??""),r.value.adjust_info=JSON.parse(JSON.stringify(t.adjust_info))}else{g=D(t.company_service_amount?.toString()||"0"),r.value.company_service_amount=D(t.company_service_amount?.toString()||"0"),r.value.kol_service_amount=t.kol_service_amount?.toString()||"0",r.value.company_service_type=Number(2===t.company_service_type)?"2":"1",r.value.company_service_rate=t.company_service_rate?.toString()??"",r.value.json_data={amount_info_list:[{type:9}]};const e=[];t.adjust_info&&t.adjust_info.map((t=>{t.type=9,e.push(t)})),r.value.adjust_info=e}r.value.kol_salary_infos=t.kol_salary_infos||[],r.value.tax_amount=D(t.tax_amount??0),r.value.is_include_tax=t.is_include_tax?1:0,r.value.tax_rate=`${t.tax_rate?t.tax_rate:"0"}`,r.value.tax_excluded_amount=F(t.tax_excluded_amount??""),r.value.tax_included_amount=F(t.tax_included_amount??""),c.value="2"===r.value.company_service_type?String(r.value.company_service_amount):String(r.value.company_service_rate),j.value=JSON.parse(JSON.stringify(r.value))},N=(0,n.ref)(!1),T=t=>{w.value=t,N.value=!0,L(t)},z=t=>{r.value.adjust_info=t},B=t=>{const e=w.value?.id??-1,a="1"===t.company_service_type?t.company_service_rate:null;let n=0;n=Number(r.value.kol_service_amount||0);const o=[];r.value.json_data?.amount_info_list.map((e=>{9===e.type?(e={type:9,company_service_amount:t.company_service_amount,company_service_type:t.company_service_type,company_service_rate:a,kol_service_amount:n},o.push(e)):o.push(e)}));const s={id:e,total_settle_amount:x.value,is_include_tax:t.is_include_tax,tax_amount:t.tax_amount,tax_rate:""===t.tax_rate?"0":t.tax_rate??"0",tax_included_amount:t.tax_included_amount,tax_excluded_amount:t.tax_excluded_amount,json_data:{amount_info_list:o}};return s},P=(t=!0)=>{const a=(0,n.ref)([]);if(r.value.adjust_info&&r.value.adjust_info?.length>=1){const t=r.value.adjust_info.filter((t=>t.type||t.adjust_reason||t.adjust_amount));if(t.some((t=>/^(?:\+|-)?0?(?:\.0{0,2})?$/u.test(t.adjust_amount))))return"请输入正确的调整金额";if(t.some((t=>"0"===t.adjust_amount)))return e.root.$message.error("调整金额不能为0"),"调整金额不能为0";if(!t.every((t=>t.type&&""!==t.adjust_amount&&"-"!==t.adjust_amount&&t.adjust_reason)))return"请完善手工调账信息";t.length>0&&(a.value=t)}return t&&a.value&&0===a.value.length&&["0","0.0","0.00"].includes(x.value??"0")?"至少填写一项结算项":t&&new(_())(x.value??"0").lte("0")?"总结算金额必须大于0":void 0},O=()=>{setTimeout((()=>{l.value?.clearValidate?.()}),100)},R=async(t=!0,n=!1)=>{if(a.value)return;if(!s.value)return;const i=s.value.business_type;if(!n){const a=P(t);if(a)return void e.root.$message.error(a)}const l=B(r.value);l.step=t?o.br.step_three:o.br.step_two,l.adjust_info=Ne(r.value),a.value=!0;const[{data:c}]=await(0,f.Dc)(500,(0,y.bp)(l,i));return a.value=!1,c.success?(t&&e.emit("next",c.data),O()):e.root.$message.error(c.message??"保存失败"),c},M=(0,Y.useDebounceFn)(R,200),Z=async()=>{if(E.value){const t=!1,a=!0,n=await R(t,a);n&&(n.success?e.emit("prev",n.data):e.root.$message.warning(n.message))}else e.emit("prev")},G=()=>{if(E.value)M();else{const t=!0,a=P(t);if(a)return void e.root.$message.error(a);e.emit("next",w.value)}},E=(0,n.computed)((()=>JSON.stringify(j.value)!==JSON.stringify(r.value))),J=async()=>E.value,H=async()=>{const t=!1,e=!0,a=await R(t,e);return!!a&&a.success},q=t=>{r.value.is_include_tax=t?1:0},U=t=>{const e="1"===r.value.company_service_type?Ae(t):Ie(t);c.value=e},K=t=>{r.value.is_include_tax=0===t.is_include_tax?0:1,r.value.tax_included_amount=t.tax_included_amount?.toString()??"",r.value.tax_excluded_amount=t.tax_excluded_amount?.toString()??"",r.value.tax_amount=t.tax_amount?.toString()??""},W=t=>{r.value.tax_rate=t},V=(0,n.computed)((()=>{const t=[];return o.mR.forEach(((e,a)=>{t.push({type:a,name:e})})),t})),X=t=>r.value.json_data?r.value.json_data.amount_info_list?.find((e=>e.type===t)):null,Q=t=>X(t)?.remark,tt=t=>X(t)?.amount,et=(t,e)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],n=X(e);n&&(n.amount=a)},at=(0,n.computed)((()=>b.value?.company_name===zt.QN)),nt=()=>{const t=(0,Bt.t)(),e=t.currentRoute.params.id;window.open((0,zt.uE)(e,b.value?.start_date??0,b.value?.end_date??0))},ot=(t,e)=>{const a=X(e);a&&(a.remark=t)},st=(0,n.computed)((()=>{const t=[];return r.value.kol_salary_infos?.map((e=>{e.kol_name&&t.push({id:e.kol_id,name:e.kol_name})})),t}));return{selectedallCompanyList:st,company_kol_service_amount_str:p,remarkChanged:ot,downDetail:nt,isYufengCompany:at,onIncomeAmountChanged:et,income_amount:tt,remark:Q,amountDetail:X,feeNameTypes:V,formRef:l,schedule_file_list:A,total_amount_str:h,ShowAdjustInfo:N,service_fee_value:c,company_service_amount_value:u,company_service_amount_str:d,kol_service_amount_str:m,CompanyServiceRateInput:U,taxRateChanged:W,taxedChangedHandler:q,taxValueChangeHandler:K,downloadKolScheduleFile:C,downloadKolServiceFeeFile:S,total_amount:x,DataForm:r,saveLoading:a,fill_form_loading:$,onAdjustAccountDataChange:z,onSaveHandler:M,fillForm:T,prev:Z,next:G,confirmBeforeClose:J,saveBeforeClose:H}}}),Be=ze,Pe=(0,C.Z)(Be,De,Fe,!1,null,null,null),Oe=Pe.exports,Re=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"settlement-step3-shoplive-after",class:1===t.settlement.is_estimate?"is_estimate":"",scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,taxed:t.DataForm.is_include_tax,tax_rate:t.DataForm.tax_rate,name:t.settlement.company_name,name_desc:"供应商：",type:"value2"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本信息")]},proxy:!0}])},[a("div",[a("div",{staticClass:"one-item-block"},[a("div",{staticClass:"oneblock"},[a("div",{staticClass:"label",staticStyle:{width:"100px",color:"#6a7b92"}},[t._v("主播服务费：")]),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(t.kol_service_amount_str)+" 元")])]),a("div",{staticClass:"oneblock"},[a("div",{staticClass:"label",staticStyle:{width:"100px",color:"#6a7b92"}},[t._v("机构服务费：")]),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},["1"===t.DataForm.company_service_type?a("span",[t._v("抽成服务费 "+t._s(t.company_service_amount_str)+" 元 比率 "+t._s(t.DataForm.company_service_rate)+" %")]):a("span",[t._v("固定费用 "+t._s(t.company_service_amount_str)+" 元")])])]),t.DataForm.adjust_info.length>0?a("div",{staticClass:"oneblock"},[a("div",{staticClass:"label",staticStyle:{width:"100px",color:"#6a7b92","flex-shrink":"0"}},[t._v(" 手工调账： ")]),a("div",t._l(t.DataForm.adjust_info,(function(e,n){return a("div",{key:n,staticStyle:{display:"flex"}},[a("div",{staticStyle:{display:"inline-block","text-align":"center",padding:"0"}},[t._v(" "+t._s(n+1)+".  ")]),a("div",[a("span",{staticStyle:{color:"#3c5269","font-family":"PingFangSC-Regular"}},[t._v("调整金额："+t._s(t.formatAmountWithoutPrefix(e.adjust_amount))+" 元")]),a("div",{staticStyle:{color:"#a4b2c2"}},[t._v("调整原因："+t._s(e.adjust_reason))])])])})),0)]):t._e()])])])]},proxy:!0},{key:"right",fn:function(){return[a("CardLayout",{staticClass:"tg-files-container",attrs:{padding:[0,0,0,0]},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("文件")]},proxy:!0}])},[a("div",{staticStyle:{padding:"17px 0 12px 0",height:"187px","overflow-y":"auto"}},[a("div",{staticClass:"file-block-content"},[a("div",{staticStyle:{height:"18px","font-size":"12px",color:"#6a7b92"}},[t._v("主播工资明细")]),a("div",{staticStyle:{"margin-top":"12px","font-size":"14px",color:"#3c5269"}},[t.kolSalaryDataUrl&&""!==t.kolSalaryDataUrl?a("div",{staticClass:"fileItem"},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-excel"},slot:"icon"}),a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"190px"}},[t._v(" 主播费用明细.xlsx ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex"},attrs:{type:"link"},on:{click:function(e){return t.downloadKolServiceFeeFile("主播费用明细.xlsx")}}},[t._v("下载")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex","margin-left":"8px"},attrs:{type:"link"},on:{click:function(e){return t.previewKolServiceFeeFile("主播费用明细.xlsx")}}},[t._v("预览")])],1):t._e()])]),a("div",{staticClass:"file-block-content",staticStyle:{"margin-top":"18px"}},[a("div",{staticStyle:{height:"18px","font-size":"12px",color:"#6a7b92"}},[t._v("主播排班信息")]),a("div",{staticStyle:{"margin-top":"12px","font-size":"14px",color:"#3c5269"}},t._l(t.schedule_file_list,(function(e,n){return a("div",{key:n,staticClass:"fileItem"},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-excel"},slot:"icon"}),a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"190px"}},[t._v(" "+t._s(e.name)+"直播排班.xlsx ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex"},attrs:{type:"link"},on:{click:function(a){return t.downloadKolScheduleFile(e.name+"直播排班.xlsx")}}},[t._v("下载")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex","margin-left":"8px"},attrs:{type:"link"},on:{click:function(a){return t.previewKolScheduleFile(e.name+"直播排班.xlsx")}}},[t._v("预览")])],1)})),0)])]),a("div",{staticStyle:{"border-bottom":"1px solid rgba(164, 178, 194, 0.3)",margin:"0px 8px 0px 18px"}}),a("div",{staticClass:"file-block-content"},[1!==t.settlement.is_estimate?a("div",{staticClass:"statements-file-block",style:t.readonly?"height: 130px;":"height: 129px"},[a("div",{staticClass:"statements-file",style:t.readonly?"padding: 18px 18px 12px 0":"padding: 18px 0 12px 0"},[a("div",[a("div",{staticStyle:{"font-size":"12px","line-height":"16px",height:"16px","margin-bottom":"6px"}},[t.readonly?t._e():a("span",{staticStyle:{color:"red"}},[t._v("*")]),t._v("结算文件 ")]),t.readonly?t._e():a("div",{staticStyle:{display:"flex","line-height":"32px",height:"32px",width:"100%","font-size":"14px"}},[t.uploadedFileList.length<50?a("el-upload",{attrs:{action:"/",accept:".docx,.pdf,.jpg,.jpeg,.xlsx,.png,.xls",multiple:!1,"show-file-list":!1,"http-request":t.uploadFileHandler}},[a("tg-button",{attrs:{size:"small",icon:"ico-btn-upload"}},[t._v("上传文件")])],1):a("tg-button",{attrs:{size:"small",disabled:!0,icon:"ico-btn-upload"}},[t._v("上传文件")]),a("div",{staticStyle:{display:"inline-block","margin-left":"6px","font-size":"12px",width:"166px",color:"#a4b2c2","line-height":"16px",height:"32px","font-weight":"400"}},[t._v(" 支持.docx .pdf .jpg .png .xlsx .xls(单个文件大小不超过30M) ")])],1)]),a("div",{staticClass:"fileList mgr-18",staticStyle:{"margin-top":"12px"}},t._l(t.uploadedFileList,(function(e,n){return a("div",{key:n,staticClass:"fileItem"},[a("FileItem",{key:n,attrs:{filepath:e.path,readonly:t.readonly},on:{remove:function(e){return t.handleRemoveFileClick(n)}}})],1)})),0)])]):t._e()])])]},proxy:!0},1!==t.settlement.is_estimate?{key:"files",fn:function(){return[a("div",[a("el-form",{staticStyle:{"margin-top":"5px"}},[a("el-form-item",{attrs:{label:"关联合同："}},[t.readonly?a("div",{staticStyle:{display:"flex","align-items":"center",color:"#3c5269"}},[t.cooperation_link_contract_ID&&t.contract_info.sign_type_name?a("div",{staticStyle:{"margin-left":"10px"}},[t._v(" "+t._s(t.contract_info.sign_type_name+": "+t.contract_info.contract_uid+" ("+t.contract_info.coop_start_date+"-"+t.contract_info.coop_end_date+")")+" ")]):a("div",[t._v("--")])]):a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:t.readonly?"--":"请输入合同编码","remote-method":t.getContract,size:"medium",disabled:t.readonly},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.cooperation_link_contract_ID,callback:function(e){t.cooperation_link_contract_ID=e},expression:"cooperation_link_contract_ID"}},t._l(t.contract_uids,(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.sign_type_name+":  "+t.contract_uid+"  ("+t.coop_start_date+"-"+t.coop_end_date+")",value:t.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:null,t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},Me=[],Ze=a(57412);const Ge=(0,rt.LP)(),Ee=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]),Je=t=>{const e=t.split("/")[t.split("/").length-1],a=e.split(".")[e.split(".").length-1],n=Ee.get(a)??"picture";return{name:e,icon:n,type:n,path:t}};var Ye=(0,n.defineComponent)({name:"TgShopLiveCostSettmentSubmitForm",components:{SettlementStep3Layout:it,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.ref)(!1);let s;const i=()=>{s=H.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},r=(0,n.ref)("0"),c=(0,n.inject)("settlement")??(0,n.ref)(void 0),{downloadFileHandler:u}=(0,lt.r7)(e),d=(0,n.ref)({detail_file:"",adjust_info:[],settlement_files:[],is_include_tax:0,company_service_type:"1",company_service_rate:"",company_service_amount:"",kol_service_amount:"",tax_amount:"",tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",json_data:{amount_info_list:[]}}),m=(0,n.ref)([]),p=(0,n.ref)(void 0),g=(0,n.ref)([]),x=(0,n.ref)([]),h=(t,e)=>{const a=`/api/settlement/download_kol_schedule?company_id=${e}&settlement_id=${t}&Authorization=${Ge}`;return a},b=t=>{const e=c.value?c.value.id.toString():"-1",a=h(e,p.value?.company_id.toString()??"-1");u(a,t)},k=t=>{const e=c.value?c.value.id.toString():"-1",a=p.value?.company_id.toString()??"-1",n=""!==d.value.company_service_amount?d.value.company_service_amount:0,o=(0,lt.sO)(d.value.adjust_info),s=`/api/settlement/download_company_salary?adjust_sum=${o}&fwf=${n}&company_id=${a}&settlement_id=${e}&Authorization=${Ge}`;u(s,t)},C=t=>{const e=location.origin,a=e+t;t.includes(".png")||t.includes(".jpg")||t.includes(".jpeg")||t.includes(".pdf")?window.open(a):window.open("https://view.officeapps.live.com/op/view.aspx?src="+encodeURIComponent(a))},S=()=>{const t=c.value?c.value.id.toString():"-1",e=p.value?.company_id.toString()??"-1",a=""!==d.value.company_service_amount?d.value.company_service_amount:0,n=(0,lt.sO)(d.value.adjust_info),o=`/api/settlement/download_company_salary?adjust_sum=${n}&fwf=${a}&company_id=${e}&settlement_id=${t}&Authorization=${Ge}`;C(o)},w=()=>{const t=c.value?c.value.id.toString():"-1",e=h(t,p.value?.company_id.toString()??"-1");C(e)},j=(0,n.ref)(void 0),D=(0,n.ref)({contract_uid:void 0,coop_start_date:void 0,coop_end_date:void 0,sign_type_name:void 0}),F=t=>d.value.json_data?d.value.json_data.amount_info_list?.find((e=>e.type===t)):null,$=t=>{if(p.value=t,m.value=[{name:t.kol_name??"--",url:""}],t.json_data&&t.json_data.amount_info_list&&t.json_data.amount_info_list.length>0){d.value.json_data=JSON.parse(JSON.stringify(t.json_data));const e=F(9);e&&(d.value.company_service_amount=e.company_service_amount?.toString()??"0",d.value.kol_service_amount=e.kol_service_amount?.toString()||"0",d.value.company_service_type=2===Number(e.company_service_type)?"2":"1",d.value.company_service_rate=e.company_service_rate?.toString()??"")}else d.value.company_service_amount=t.company_service_amount?.toString()??"0",d.value.kol_service_amount=t.kol_service_amount?.toString()||"0",d.value.company_service_type=Number(2===t.company_service_type)?"2":"1",d.value.company_service_rate=t.company_service_rate?.toString()??"";d.value.detail_file=t.detail_file,d.value.adjust_info=t.adjust_info,d.value.tax_rate=t.tax_rate?.toString()??"",d.value.is_include_tax=0===t.is_include_tax?0:1,x.value=t.settlement_files,d.value.settlement_files=t.settlement_files,V.value=t.contract_id||void 0,j.value=t.contract_id||void 0,D.value.contract_uid=t.contract_uid||void 0,D.value.sign_type_name=t.sign_type_name||void 0,D.value.coop_start_date=t.coop_start_date||void 0,D.value.coop_end_date=t.coop_end_date||void 0,t.settlement_files&&(g.value=t.settlement_files.map((t=>Je(t)))),r.value=new(_())(t.total_settle_amount).toString()},A=async()=>{if(void 0===c.value)return;const t={id:p.value?.id??-1,step:o.br.step_three,contract_id:V.value||0},n=d.value.settlement_files?d.value.settlement_files:[];t.settlement_files=n;const{business_type:s}=c.value;a.value=!0;const[{data:i}]=await(0,f.Dc)(500,(0,y.bp)(t,s));return a.value=!1,!!i.success||(e.root.$message.error(i.message),!1)},I=async()=>{if(void 0===c.value)return;const t=d.value.settlement_files?d.value.settlement_files:[];if(0===c.value.is_estimate&&0===t.length)return void e.root.$message.warning("请上传结算单扫描件");const o=await(0,J.I)(e,{title:"确定提交结算单吗？",content:()=>(0,n.h)("div",[(0,n.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,n.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});if(!o)return;const s={id:p.value?.id??-1,contract_id:V.value||0};0===c.value.is_estimate&&(s.settlement_files=t),a.value=!0;const[{data:i}]=await(0,f.Dc)(500,(0,y.FX)(s));a.value=!1,i.success?(e.root.$message.success("提交成功"),e.emit("submit:success")):e.root.$message.error(i.message??"提交失败")},L=(0,Y.useDebounceFn)(I,200),N=async()=>await A(),T=(0,n.computed)((()=>j.value!==V.value||JSON.stringify(x.value)!==JSON.stringify(d.value.settlement_files))),z=async()=>{if(void 0!==c.value)if(T.value){const t={id:p.value?.id??-1,step:o.br.step_three,contract_id:V.value||0},n=d.value.settlement_files?d.value.settlement_files:[];t.settlement_files=n;const{business_type:s}=c.value;a.value=!0;const[{data:i}]=await(0,f.Dc)(500,(0,y.bp)(t,s));a.value=!1,i.success?e.emit("prev",i.data):e.root.$message.error(i.message)}else e.emit("prev")},B=async()=>{L()},P=async()=>T.value,O=async t=>{const a=t.file;if(a.size>31457280)return void e.root.$message.error("上传文件大小不能超过 30MB!");i();const n=new FormData,o=t.file.name;n.append("file",t.file,o),n.append("type","settlement");const l=await(0,E.$)(n),r=l.data;if(s.close(),r.success){const a=o.split(".")[o.split(".").length-1],n=""!==t.file.type?t.file.type:a,s={name:t.file.name,type:t.file.type,icon:Ee.get(n)??"picture",size:t.file.size,path:r.data.source};e.root.$message.success("上传成功"),g.value.push(s)}else e.root.$message.error(r.message??"上传失败，稍后重试")};(0,n.watch)((()=>g.value),(t=>{t&&(d.value.settlement_files=g.value.map((t=>t.path)))}));const R=t=>{g.value.splice(t,1)},M=(0,n.computed)((()=>{const t=`/api/settlement/download_kol_salary?settlement_id=${c.value?.id}&Authorization=${(0,rt.LP)()}`;return t})),Z=(0,n.computed)((()=>(0,v.SJ)(new(_())(d.value.company_service_amount||0)))),G=(0,n.computed)((()=>(0,v.SJ)(new(_())(d.value.kol_service_amount||0)))),U=(0,n.ref)([]),{project_id:K}=(0,l.L)(e),W=async t=>{const e=await(0,q.z0)({search:t,only_main:0,project_id:K.value,contract_status:2,partner_type:2,exclude_sign_types:-3});e.data.success?U.value=e.data.data.data:U.value=[]};!1===t.readonly&&W("");const V=(0,n.ref)(void 0),X=t=>{V.value=t},Q=t=>Ze.Z.basename(t);return{contract_info:D,basename:Q,contract_uids:U,getContract:W,cooperation_link_contract_ID:V,selectContractUidChange:X,kolSalaryDataUrl:M,downloadKolServiceFeeFile:k,previewKolServiceFeeFile:S,previewKolScheduleFile:w,downloadKolScheduleFile:b,company_service_amount_str:Z,kol_service_amount_str:G,settlement:c,DataForm:d,saveLoading:a,total_amount:r,schedule_file_list:m,uploadedFileList:g,uploadFileHandler:O,fillForm:$,formatAmountWithoutPrefix:v.FU,downloadFileHandler:u,handleRemoveFileClick:R,prev:z,next:B,confirmBeforeClose:P,saveBeforeClose:N}}}),He=Ye,qe=(0,C.Z)(He,Re,Me,!1,null,"b670c5aa",null),Ue=qe.exports,Ke=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"settlement-step3-live-douyin-after",class:1===t.settlement.is_estimate?"is_estimate":"",attrs:{douyinLiveSelf:t.isYufengCompany(t.settlement.company_name)},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,taxed:t.DataForm.is_include_tax,tax_rate:t.DataForm.tax_rate,name:t.settlement.company_name,name_desc:"供应商：",type:"value2"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本信息")]},proxy:!0}])},[a("div",[a("div",{staticClass:"one-item-block"},[t.amountDetail(9)?a("div",{staticClass:"oneblock",staticStyle:{"margin-bottom":"12px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px",color:"#6a7b92",float:"left"}},[t._v("主播成本：")]),a("div",{staticClass:"oneblock",staticStyle:{display:"inline-block",float:"left","line-height":"30px"}},[a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(t.kol_service_all_amount_str)+" 元")]),a("div",{staticClass:"onelabel",staticStyle:{color:"#6a7b92",display:"block",width:"490px","line-height":"24px",height:"24px"}},[t._v(" 主播服务费："),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(t.kol_service_amount_str)+" 元")])]),a("div",{staticStyle:{display:"block"}},[a("div",{staticClass:"onelabel",staticStyle:{width:"490px",color:"#6a7b92","line-height":"24px",height:"24px"}},[t._v(" 机构服务费："),a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},["1"===t.DataForm.company_service_type?a("span",[t._v("抽成服务费 "+t._s(t.company_service_amount_str)+" 元 比率 "+t._s(t.DataForm.company_service_rate)+" %")]):a("span",[t._v("固定费用 "+t._s(t.company_service_amount_str)+" 元")])])])])])]):t._e(),t.amountDetail(8)?a("div",{staticClass:"oneblock",staticStyle:{"margin-bottom":"12px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px",color:"#6a7b92",float:"left"}},[t._v("投放成本：")]),a("div",{staticClass:"oneblock",staticStyle:{display:"inline-block","line-height":"30px",float:"left",width:"580px"}},[a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(t.Decimal2String(t.amountDetail(8).amount))+" 元")])])]):t._e(),t.amountDetail(6)?a("div",{staticClass:"oneblock",staticStyle:{"margin-bottom":"12px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px",color:"#6a7b92",float:"left"}},[t._v("其他成本：")]),a("div",{staticClass:"oneblock",staticStyle:{display:"inline-block","line-height":"30px",float:"left",width:"580px"}},[a("span",{staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(t._s(t.Decimal2String(t.amountDetail(6).amount))+" 元")]),a("div",{staticStyle:{display:"block","line-height":"20px","margin-right":"100px"}},[a("span",{staticStyle:{color:"#a4b2c2"}},[t._v(t._s(t.amountDetail(6).remark)+" ")])])])]):t._e(),t.DataForm.adjust_info.length>0?a("div",{staticClass:"oneblock",staticStyle:{"margin-bottom":"12px"}},[a("div",{staticClass:"label",staticStyle:{width:"100px",color:"#6a7b92"}},[t._v("手工调账：")]),a("div",{staticStyle:{"line-height":"30px"}},[a("div",{staticClass:"value",staticStyle:{"font-weight":"600",color:"#3c5269"}},[t._v(" "+t._s(t.getAdjustAmount)+" 元 ")]),t._l(t.DataForm.adjust_info,(function(e,n){return a("div",{key:n},[e.type?a("div",{staticStyle:{display:"inline-block",width:"70px",padding:"0",color:"#6a7b92",float:"left","line-height":"20px"}},[t._v(" "+t._s(8===e.type?"投放成本:":6===e.type?"其他成本:":9===e.type?"主播成本:":"")+" ")]):t._e(),a("div",{staticStyle:{display:"inline-block",width:"400px",padding:"0",color:"#6a7b92",float:"left","line-height":"20px","margin-bottom":"4px"}},[a("div",{staticStyle:{color:"#3c5269","font-family":"PingFangSC-Regular"}},[t._v(" 调整金额："+t._s(t.formatAmountWithoutPrefix(e.adjust_amount))+" 元 ")]),a("div",{staticStyle:{color:"#a4b2c2"}},[t._v("调整原因："+t._s(e.adjust_reason))])])])}))],2)]):t._e()])])])]},proxy:!0},{key:"right",fn:function(){return[a("CardLayout",{staticClass:"tg-files-container",style:{height:1===t.settlement.is_estimate?"380px":t.isYufengCompany(t.settlement.company_name)?"350px":"320px"},attrs:{padding:[0,12,0,0]},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("文件")]},proxy:!0}])},[a("div",{staticStyle:{padding:"17px 12px 12px 0",height:"217px"},style:{height:t.isYufengCompany(t.settlement.company_name)?"217px":"157px"}},[t.amountDetail(9)?a("div",{staticClass:"file-block-content"},[a("div",{staticStyle:{height:"18px","font-size":"12px",color:"#6a7b92"}},[t._v("主播工资明细")]),a("div",{staticStyle:{"margin-top":"12px","font-size":"14px",color:"#3c5269"}},[t.kolSalaryDataUrl&&""!==t.kolSalaryDataUrl?a("div",{staticClass:"fileItem"},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-excel"},slot:"icon"}),a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"170px"}},[t._v(" 主播费用明细.xlsx ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex"},attrs:{type:"link"},on:{click:function(e){return t.downloadKolServiceFeeFile("主播费用明细.xlsx")}}},[t._v("下载")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex","margin-left":"8px"},attrs:{type:"link"},on:{click:function(e){return t.previewKolServiceFeeFile("主播费用明细.xlsx")}}},[t._v("预览")])],1):t._e()])]):t._e(),t.amountDetail(9)?a("div",{staticClass:"file-block-content",staticStyle:{"margin-top":"18px"}},[a("div",{staticStyle:{height:"18px","font-size":"12px",color:"#6a7b92"}},[t._v("主播排班信息")]),a("div",{staticStyle:{"margin-top":"12px","font-size":"14px",color:"#3c5269"}},t._l(t.schedule_file_list,(function(e,n){return a("div",{key:n,staticClass:"fileItem"},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-excel"},slot:"icon"}),a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"170px"}},[t._v(" "+t._s(e.name)+"直播排班.xlsx ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex"},attrs:{type:"link"},on:{click:function(a){return t.downloadKolScheduleFile(e.name+"直播排班.xlsx")}}},[t._v("下载")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex","margin-left":"8px"},attrs:{type:"link"},on:{click:function(a){return t.previewKolScheduleFile(e.name+"直播排班.xlsx")}}},[t._v("预览")])],1)})),0)]):t._e(),t.isYufengCompany(t.settlement.company_name)?a("div",{staticClass:"file-block-content",staticStyle:{"margin-top":"18px"}},[a("div",{staticStyle:{height:"18px","font-size":"12px",color:"#6a7b92"}},[t._v("投放明细")]),a("div",{staticStyle:{"margin-top":"12px","font-size":"14px",color:"#3c5269"}},[a("div",{staticClass:"fileItem"},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-excel"},slot:"icon"}),a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"170px"}},[t._v(" 投放明细 ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex"},attrs:{type:"link"},on:{click:function(e){return t.downloadPutServiceFeeFile()}}},[t._v("下载")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex","margin-left":"8px"},attrs:{type:"link"},on:{click:function(e){return t.previewPutServiceFeeFile("投放明细.xlsx")}}},[t._v("预览")])],1)])]):t._e()]),a("div",{staticStyle:{"border-bottom":"1px solid rgba(164, 178, 194, 0.3)",margin:"0px 8px 0px 18px"}}),a("div",{staticClass:"file-block-content"},[1!==t.settlement.is_estimate?a("div",{staticClass:"statements-file-block"},[a("div",{staticClass:"statements-file",style:t.readonly?"padding: 18px 18px 12px 0":"padding: 18px 0 12px 0"},[a("div",[a("div",{staticStyle:{"font-size":"12px","line-height":"16px",height:"16px","margin-bottom":"6px"}},[t.readonly?t._e():a("span",{staticStyle:{color:"red"}},[t._v("*")]),t._v("结算文件 ")]),t.readonly?t._e():a("div",{staticStyle:{display:"flex","line-height":"32px",height:"32px",width:"100%","font-size":"14px"}},[t.uploadedFileList.length<50?a("el-upload",{attrs:{action:"/",accept:".docx,.pdf,.jpg,.jpeg,.xlsx,.png,.xls",multiple:!1,"show-file-list":!1,"http-request":t.uploadFileHandler}},[a("tg-button",{staticClass:"settlement-upload-btn",attrs:{size:"small",icon:"ico-btn-upload"}},[t._v("上传文件")])],1):a("tg-button",{staticClass:"settlement-upload-btn",attrs:{size:"small",disabled:!0,icon:"ico-btn-upload"}},[t._v("上传文件")]),a("div",{staticStyle:{display:"inline-block","margin-left":"6px","font-size":"12px",width:"166px",color:"#a4b2c2","line-height":"16px",height:"32px","font-weight":"400"}},[t._v(" 支持.docx .pdf .jpg .png .xlsx .xls(单个文件大小不超过30M) ")])],1)]),a("div",{staticClass:"fileList",staticStyle:{"margin-top":"12px"}},t._l(t.uploadedFileList,(function(e,n){return a("div",{key:n,staticClass:"fileItem"},[a("FileItem",{key:n,attrs:{filepath:e.path,readonly:t.readonly},on:{remove:function(e){return t.handleRemoveFileClick(n)}}})],1)})),0)])]):t._e()])])]},proxy:!0},1!==t.settlement.is_estimate?{key:"files",fn:function(){return[a("div",[a("el-form",{staticStyle:{"margin-top":"10px"}},[a("el-form-item",{attrs:{label:"关联合同："}},[t.readonly?a("div",{staticStyle:{display:"flex","align-items":"center",color:"#3c5269"}},[t.cooperation_link_contract_ID&&t.contract_info.sign_type_name?a("div",[t._v(" "+t._s(t.contract_info.sign_type_name+": "+t.contract_info.contract_uid+" ("+t.contract_info.coop_start_date+"-"+t.contract_info.coop_end_date+")")+" ")]):a("div",[t._v("--")])]):a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:t.readonly?"--":"请输入合同编码","remote-method":t.getContract,size:"medium",disabled:t.readonly},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.cooperation_link_contract_ID,callback:function(e){t.cooperation_link_contract_ID=e},expression:"cooperation_link_contract_ID"}},t._l(t.contract_uids,(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.sign_type_name+":  "+t.contract_uid+"  ("+t.coop_start_date+"-"+t.coop_end_date+")",value:t.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:null,t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},We=[];const Ve=(0,rt.LP)(),Xe=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]),Qe=t=>{const e=t.split("/")[t.split("/").length-1],a=e.split(".")[e.split(".").length-1],n=Xe.get(a)??"picture";return{name:e,icon:n,type:n,path:t}};var ta=(0,n.defineComponent)({name:"TgShopLiveCostSettmentSubmitForm",components:{SettlementStep3Layout:it,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.ref)(!1);let s;const i=()=>{s=H.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},r=(0,n.ref)("0"),c=(0,n.inject)("settlement")??(0,n.ref)(void 0),{downloadFileHandler:u}=(0,lt.r7)(e),d=(0,n.ref)({detail_file:"",adjust_info:[],settlement_files:[],is_include_tax:0,company_service_type:"1",company_service_rate:"",company_service_amount:"",kol_service_amount:"",tax_amount:"",tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",json_data:{amount_info_list:[]}}),m=(0,n.ref)([]),p=(0,n.ref)(void 0),g=(0,n.ref)([]),x=(0,n.ref)([]),h=(t,e)=>{const a=`/api/settlement/download_kol_schedule?company_id=${e}&settlement_id=${t}&Authorization=${Ve}`;return a},b=t=>{const e=c.value?c.value.id.toString():"-1",a=h(e,p.value?.company_id.toString()??"-1");u(a,t)},k=t=>{const e=c.value?c.value.id.toString():"-1",a=p.value?.company_id.toString()??"-1",n=""!==d.value.kol_service_amount?d.value.kol_service_amount:0,o=""!==d.value.company_service_amount?d.value.company_service_amount:0,s=(0,lt.sO)(d.value.adjust_info),i=`/api/settlement/download_company_salary?zbfwf=${n}&adjust_sum=${s}&fwf=${o}&company_id=${a}&settlement_id=${e}&Authorization=${Ve}`;u(i,t)},C=()=>{const t=c.value?.project_id;window.open((0,zt.uE)(`${t}`,c.value?.start_date??0,c.value?.end_date??0))},S=t=>{const e=location.origin,a=e+t;t.includes(".png")||t.includes(".jpg")||t.includes(".jpeg")||t.includes(".pdf")?window.open(a):window.open("https://view.officeapps.live.com/op/view.aspx?src="+encodeURIComponent(a))},w=()=>{const t=c.value?c.value.id.toString():"-1",e=(0,Bt.t)(),a=e.currentRoute.params.id,n=c.value?.start_date??0,o=c.value?.end_date??0,s=`/api/oceanengine/ad_plan/download_ad_cost/yufeng?project_id=${a}&start_date=${n}&end_date=${o}&settlement_id=${t}&Authorization=${Ve}`;S(s)},j=()=>{const t=c.value?c.value.id.toString():"-1",e=p.value?.company_id.toString()??"-1",a=""!==d.value.company_service_amount?d.value.company_service_amount:0,n=(0,lt.sO)(d.value.adjust_info),o=`/api/settlement/download_company_salary?adjust_sum=${n}&fwf=${a}&company_id=${e}&settlement_id=${t}&Authorization=${Ve}`;S(o)},D=()=>{const t=c.value?c.value.id.toString():"-1",e=h(t,p.value?.company_id.toString()??"-1");S(e)},F=(0,n.ref)(void 0),$=(0,n.ref)({contract_uid:void 0,coop_start_date:void 0,coop_end_date:void 0,sign_type_name:void 0}),A=t=>d.value.json_data?d.value.json_data.amount_info_list?.find((e=>e.type===t)):null,I=t=>{p.value=t,m.value=[{name:t.kol_name??"--",url:""}],d.value.detail_file=t.detail_file;const e=[];if(t.adjust_info&&t.adjust_info.map((t=>{t.type=t.type||9,e.push(t)})),d.value.adjust_info=e,t.json_data&&t.json_data.amount_info_list&&t.json_data.amount_info_list.length>0){d.value.json_data=JSON.parse(JSON.stringify(t.json_data));const e=A(9);e&&(d.value.company_service_amount=e.company_service_amount?.toString()??"0",d.value.kol_service_amount=e.kol_service_amount?.toString()||"0",d.value.company_service_type=2===Number(e.company_service_type)?"2":"1",d.value.company_service_rate=e.company_service_rate?.toString()??"")}else d.value.company_service_amount=t.company_service_amount?.toString()??"0",d.value.kol_service_amount=t.kol_service_amount?.toString()||"0",d.value.company_service_type=Number(2===t.company_service_type)?"2":"1",d.value.company_service_rate=t.company_service_rate?.toString()??"",d.value.json_data={amount_info_list:[{type:9}]};d.value.tax_rate=t.tax_rate?.toString()??"",d.value.is_include_tax=0===t.is_include_tax?0:1,x.value=t.settlement_files,d.value.settlement_files=t.settlement_files,tt.value=t.contract_id||void 0,F.value=t.contract_id||void 0,$.value.contract_uid=t.contract_uid||void 0,$.value.sign_type_name=t.sign_type_name||void 0,$.value.coop_start_date=t.coop_start_date||void 0,$.value.coop_end_date=t.coop_end_date||void 0,t.settlement_files&&(g.value=t.settlement_files.map((t=>Qe(t)))),r.value=new(_())(t.total_settle_amount).toString()},L=async()=>{if(void 0===c.value)return;const t={id:p.value?.id??-1,step:o.br.step_three,contract_id:tt.value||0},n=d.value.settlement_files?d.value.settlement_files:[];t.settlement_files=n;const{business_type:s}=c.value;a.value=!0;const[{data:i}]=await(0,f.Dc)(500,(0,y.bp)(t,s));return a.value=!1,!!i.success||(e.root.$message.error(i.message),!1)},N=async()=>{if(void 0===c.value)return;const t=d.value.settlement_files?d.value.settlement_files:[];if(0===c.value.is_estimate&&0===t.length)return void e.root.$message.warning("请上传结算单扫描件");const o=await(0,J.I)(e,{title:"确定提交结算单吗？",content:()=>(0,n.h)("div",[(0,n.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,n.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});if(!o)return;const s={id:p.value?.id??-1,contract_id:tt.value||0};0===c.value.is_estimate&&(s.settlement_files=t),a.value=!0;const[{data:i}]=await(0,f.Dc)(500,(0,y.FX)(s));a.value=!1,i.success?(e.root.$message.success("提交成功"),e.emit("submit:success")):e.root.$message.error(i.message??"提交失败")},T=(0,Y.useDebounceFn)(N,200),z=async()=>await L(),B=(0,n.computed)((()=>F.value!==tt.value||JSON.stringify(x.value)!==JSON.stringify(d.value.settlement_files))),P=async()=>{if(void 0!==c.value)if(B.value){const t={id:p.value?.id??-1,step:o.br.step_three,contract_id:tt.value||0},n=d.value.settlement_files?d.value.settlement_files:[];t.settlement_files=n;const{business_type:s}=c.value;a.value=!0;const[{data:i}]=await(0,f.Dc)(500,(0,y.bp)(t,s));a.value=!1,i.success?e.emit("prev",i.data):e.root.$message.error(i.message)}else e.emit("prev")},O=async()=>{T()},R=async()=>B.value,M=async t=>{const a=t.file;if(a.size>31457280)return void e.root.$message.error("上传文件大小不能超过 30MB!");i();const n=new FormData,o=t.file.name;n.append("file",t.file,o),n.append("type","settlement");const l=await(0,E.$)(n),r=l.data;if(s.close(),r.success){const a=o.split(".")[o.split(".").length-1],n=""!==t.file.type?t.file.type:a,s={name:t.file.name,type:t.file.type,icon:Xe.get(n)??"picture",size:t.file.size,path:r.data.source};e.root.$message.success("上传成功"),g.value.push(s)}else e.root.$message.error(r.message??"上传失败，稍后重试")};(0,n.watch)((()=>g.value),(t=>{t&&(d.value.settlement_files=g.value.map((t=>t.path)))}));const Z=t=>{g.value.splice(t,1)},G=(0,n.computed)((()=>{const t=`/api/settlement/download_kol_salary?settlement_id=${c.value?.id}&Authorization=${(0,rt.LP)()}`;return t})),U=(0,n.computed)((()=>(0,v.SJ)(new(_())(d.value.company_service_amount||0)))),K=(0,n.computed)((()=>(0,v.SJ)(new(_())(d.value.kol_service_amount||0)))),W=(0,n.computed)((()=>(0,v.SJ)(new(_())(Number(d.value.kol_service_amount||0)+Number(d.value.company_service_amount||0))))),V=(0,n.ref)([]),{project_id:X}=(0,l.L)(e),Q=async t=>{const e=await(0,q.z0)({search:t,only_main:0,project_id:X.value,contract_status:2,partner_type:2,exclude_sign_types:-3});e.data.success?V.value=e.data.data.data:V.value=[]};!1===t.readonly&&Q("");const tt=(0,n.ref)(void 0),et=t=>{tt.value=t},at=t=>Ze.Z.basename(t),nt=t=>t===zt.QN,ot=(0,n.computed)((()=>{if(d.value.adjust_info&&d.value.adjust_info.length>0){let t=0;return d.value.adjust_info.map((e=>{let a=e.adjust_amount?e.adjust_amount:"0";a=isNaN(Number(a))?"0":a,t=Number(new(_())(a).add(t))})),(0,v.SJ)(new(_())(t||0))}return 0})),st=t=>d.value.adjust_info.filter((e=>e.type===t));return{Decimal2String:v.SJ,amountDetail:A,kol_service_all_amount_str:W,getDetailBytype:st,getAdjustAmount:ot,isYufengCompany:nt,contract_info:$,basename:at,contract_uids:V,getContract:Q,cooperation_link_contract_ID:tt,selectContractUidChange:et,kolSalaryDataUrl:G,downloadKolServiceFeeFile:k,previewKolServiceFeeFile:j,downloadPutServiceFeeFile:C,previewPutServiceFeeFile:w,previewKolScheduleFile:D,downloadKolScheduleFile:b,company_service_amount_str:U,kol_service_amount_str:K,settlement:c,DataForm:d,saveLoading:a,total_amount:r,schedule_file_list:m,uploadedFileList:g,uploadFileHandler:M,fillForm:I,formatAmountWithoutPrefix:v.FU,downloadFileHandler:u,handleRemoveFileClick:Z,prev:P,next:O,confirmBeforeClose:R,saveBeforeClose:z}}}),ea=ta,aa=(0,C.Z)(ea,Ke,We,!1,null,"303ed070",null),na=aa.exports,oa=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-taobao-step2-before-container",attrs:{topHeightType:"default"},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.total_settlement_amount.toString(),type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("div",{staticClass:"expenditure-cost-info"},[a("div",{staticClass:"expenditure-cost-info-list"},[t.dataForm.companyData.company_info_list.length?a("div",t._l(t.dataForm.companyData.company_info_list?t.dataForm.companyData.company_info_list:[],(function(e,n){return a("div",{key:n,staticClass:"expenditure-cost-info-list-row"},[a("div",{staticClass:"cost-list-company"},[a("div",[a("span",{staticClass:"label"},[t._v("机构")]),a("span",{staticClass:"value"},[t._v(t._s(e.company_name))])]),a("div",{staticClass:"cost-list-company-operator"},[a("tg-button",{attrs:{type:"link"},on:{click:function(a){return t.downKolDataFile(e)}}},[t._v("下载")]),a("span",{staticClass:"kol-data"},[t._v(t._s("主播数据(共"+(e.excel_data?e.excel_data.length:0)+"人)"))])],1)]),a("div",{staticClass:"commission"},[a("span",{staticClass:"label"},[t._v("提成比例")]),a("el-input",{attrs:{size:"small",placeholder:"0.00"},on:{input:function(e){return t.commissionInput(e,n)}},model:{value:e.tcbl,callback:function(a){t.$set(e,"tcbl",a)},expression:"company.tcbl"}},[a("template",{slot:"append"},[t._v("%")])],2),a("span",{staticClass:"label"},[t._v("原始收入")]),a("span",{staticClass:"origin-income"},[t._v(t._s(t.formatAmount(e.yssr)+" 元"))])],1),a("div",{staticClass:"expenditure-cost-summary"},[a("span",{staticClass:"label"},[t._v("支出成本")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmount(e.zccb)+" 元"))])])])})),0):a("div",{staticClass:"tg-page-empty"},[a("empty-common",{attrs:{"detial-text":"请先上传主播和机构对应关系"}})],1)]),t.dataForm.companyData.nofind.length?a("div",{staticClass:"expenditure-cost-info-operator"},[a("div",[a("span",{staticStyle:{color:"#ec1e1e"}},[a("span",[t._v("还有")]),a("span",[t._v(t._s(""+t.dataForm.companyData.nofind.length))]),a("span",[t._v("名达人没有所属公司")])]),a("el-popover",{attrs:{"popper-class":"kol-company-map",placement:"top",trigger:"click"}},[a("div",{staticStyle:{"max-height":"150px",overflow:"overlay"}},t._l(t.dataForm.companyData.nofind,(function(e,n){return a("div",{key:n,style:0===n?"color: #3C5269;":"margin-top: 4px; color: #3C5269;"},[t._v(" "+t._s(e)+" ")])})),0),a("tg-button",{attrs:{slot:"reference",type:"link"},slot:"reference"},[t._v(" 查看明细")])],1),a("span",{staticClass:"mgl-12",staticStyle:{color:"#6a7b92"}},[t._v("请到达人管理中维护达人和达人所属公司")])],1),a("tg-button",{attrs:{type:"link"},on:{click:t.reloadRelationClick}},[a("tg-icon",{attrs:{name:"ico-loading"}}),a("span",{staticStyle:{"margin-left":"4px"}},[t._v("刷新数据")])],1)],1):t._e()])]],2)]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{height:470,ExtendItem:"company",adjust_info:t.dataForm.adjustInfo,ExtendItemSelectOptions:t.companyOptions},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.loading,content:t.loadingText}})]},proxy:!0}])})},sa=[],ia=(0,n.defineComponent)({name:"Step2MCNTaoBaoBefore",components:{CardLayout:$.Z,SettlementStep2Layout:it,TgAdjustAccountForm:A.Z,TopCard:N.Z},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.ref)(""),i=(0,n.inject)("settlement")??(0,n.ref)(void 0),l=(0,n.computed)((()=>{const t=(0,ct.I8)(i.value);return t})),r=(0,n.ref)({adjustInfo:l.value?.adjust_info?l.value?.adjust_info:[],companyData:l.value?.json_data??{company_info_list:[],nofind:[]}}),c=(0,n.ref)((0,ct.I8)(r.value)),u=(0,n.computed)((()=>{let t=new(_())(0);return r.value.adjustInfo?.forEach((e=>{let a=e.adjust_amount?e.adjust_amount:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),r.value.companyData?.company_info_list.forEach((e=>{let a=e.zccb?e.zccb:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),t.toFixed(2)})),d=(0,n.computed)((()=>`/api/settlement/download_kol_company_file?kol_type=1&Authorization=${(0,rt.LP)()}`)),m=(0,n.computed)((()=>r.value.companyData?.company_info_list.map((t=>({id:t.company_id,name:t.company_name})))??[])),p=(0,n.ref)(!1),g={prev:()=>{g.isModified()?g.saveSettlementRequest(o.GG.prev):e.emit("prev")},next:()=>{g.saveSettlementRequest(o.GG.next)},setLoadingAndText:t=>{switch(t){case"save":a.value=!0,s.value="正在保存，请稍候...";break;case"upload":a.value=!0,s.value="正在上传，请稍候...";break;case"detail":a.value=!0,s.value="正在获取详情，请稍候...";break;case"reload":a.value=!0,s.value="正在刷新，请稍候...";break;case"none":a.value=!1,s.value="";break}},checkDataForSave:()=>!!g.checkIncomeFile()&&(!!l.value?.id&&((r.value.companyData?.nofind??[]).length?(e.root.$message.warning(`有${r.value.companyData?.nofind?.length??0}名主播没有对应机构，点击“查看明细”可以查看没有对应关系的主播列表`),!1):r.value.adjustInfo?.find((t=>isNaN(Number(t.adjust_amount))))?(e.root.$message.warning("请输入正确的调整金额"),!1):r.value.adjustInfo?.find((t=>0===Number(t.adjust_amount)&&t.adjust_amount))?(e.root.$message.warning("调整金额不能为0"),!1):r.value.adjustInfo?.find((t=>(t.adjust_amount||t.adjust_reason||t.company_name)&&(!t.adjust_amount||!t.adjust_reason||!t.company_name)))?(e.root.$message.warning("请完善手工调账信息"),!1):Number(u.value)<=0?(e.root.$message.warning("总结算金额不能小于等于0"),!1):!!g.isModified()||(e.emit("next"),!1))),commissionInput:(t,e)=>{const a=g.getPositiveRateNumber(t),n=r.value.companyData?.company_info_list[e];n&&(n.tcbl=a,n.zccb=new(_())(a||0).mul(new(_())(n.yssr?n.yssr:0)).div(new(_())(100)).toFixed(2))},checkIncomeFile:()=>!!l.value?.income_file||(e.root.$message.warning("请先在收入结算中上传原始收入文件"),!1),kolDataUrl:t=>`/api/settlement/download_settlement_kol_data?settlement_id=${l.value?.id}&company_name=${t.company_name}&Authorization=${(0,rt.LP)()}`,isModified:()=>{const t=JSON.stringify(c.value),e=JSON.stringify(r.value);return t!==e},confirmBeforeClose:async()=>g.isModified(),saveBeforeClose:()=>g.saveSettlementRequest(o.GG.close),fillForm:()=>{p.value=!0},onAdjustAccountDataChange:t=>{r.value.adjustInfo=t},getPositiveRateNumber:t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],formatAmount:t=>(0,v.dN)(t,"None"),uploadFileHandler:async t=>{if(!g.checkIncomeFile())return;const a=new FormData,n=t.file.name;a.append("file",t.file,n),a.append("settlement_id",String(l.value?.id)),g.setLoadingAndText("upload");const o=await(0,y._9)(a);g.setLoadingAndText("none"),o?.data.success?g.getSettlementDetail():e.root.$message.error(o?.data.message??"上传失败，稍后重试")},downloadAPIFileHandler:(t,a)=>{fetch(t).then((async t=>{const n=t.clone();try{const t=await n.json();e.root.$message.error(t.message)}catch{if(200===t.status){const e=await t.blob();(0,f.uA)(e,a)}else e.root.$message.error("下载失败")}}))},downloadKolCompanyMapFile:()=>{g.downloadAPIFileHandler(d.value,"机构达人对应关系.xlsx")},downKolDataFile:t=>{g.downloadAPIFileHandler(g.kolDataUrl(t),`${t.company_name}的主播详情 .xlsx`)},getSettlementDetail:async()=>{if(!l.value?.id)return;const t={id:l.value.id};g.setLoadingAndText("detail");const a=await(0,y.S_)("common",t);if(g.setLoadingAndText("none"),a.data.success){const t=a.data.data;r.value.companyData=t?.json_data??{company_info_list:[],nofind:[]}}else e.root.$message.warning(a.data.message??"获取结算详情失败，请重新上传文件")},saveSettlementRequest:async t=>{if(t===o.GG.next&&!g.checkDataForSave())return;const a={id:l.value.id,step:t===o.GG.next?o.br.step_three:o.br.step_two,total_settle_amount:u.value,adjust_info:r.value.adjustInfo.filter((t=>t.adjust_amount||t.adjust_reason)),json_data:{nofind:r.value.companyData?.nofind??[],company_info_list:(0,ct.I8)(r.value).companyData?.company_info_list.map((t=>(""===t.tcbl&&(t.tcbl="0"),t)))??[]}};g.setLoadingAndText("save");const n=await(0,y.RB)(a);if(g.setLoadingAndText("none"),n.data.success)switch(t){case o.GG.prev:e.emit("prev",n.data.data);break;case o.GG.next:e.emit("next",n.data.data),e.root.$message.success(n.data.message??"保存成功");break;case o.GG.close:return e.root.$message.success("保存成功"),!0;default:break}else e.root.$message.error(n.data.message??"保存失败");return!1},reloadRelationClick:async()=>{if(!i.value?.id)return;g.setLoadingAndText("reload");const t=await(0,y.ix)(`${i.value.id}`);g.setLoadingAndText("none"),t.data.success?await g.getSettlementDetail():e.root.$message.error(t?.data.message??"刷新失败，稍后重试")}};return(0,n.onMounted)((()=>{c.value=(0,ct.I8)(r.value),(0,n.nextTick)((()=>{g.checkIncomeFile()}))})),{ShowAdjustInfo:p,total_settlement_amount:u,kolCompanyMapUrl:d,loading:a,loadingText:s,...g,dataForm:r,companyOptions:m}}}),la=ia,ra=(0,C.Z)(la,oa,sa,!1,null,null,null),ca=ra.exports,ua=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-taobao-step3-before-container",attrs:{topHeightType:"default"},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount.toString(),type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("card-layout",{attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("section",{staticClass:"expenditure-cost-list"},t._l(t.settlement.json_data.company_info_list,(function(e,n){return a("section",{key:n,staticClass:"expenditure-cost-list-row"},[a("div",{staticClass:"cost-company-name"},[t._v(t._s(e.company_name))]),a("section",{staticClass:"commission-info"},[a("span",{staticClass:"label"},[t._v("提成：")]),a("div",{staticClass:"commission-info-detail"},[a("div",{staticClass:"commission-amount"},[t._v(t._s(t.formatAmount(e.zccb)+" 元"))]),a("div",{staticClass:"commission-amount-desc"},[t._v(" "+t._s("总收入 "+e.yssr+" 元，提成比例 "+e.tcbl+"%")+" ")])])]),t.adjustInfo(e.company_name).length?a("section",{staticClass:"adjust-info"},[a("div",{staticClass:"adjust-info-flex"},[a("span",{staticClass:"label"},[t._v("手工调账：")]),a("div",{staticClass:"adjust-info-list"},t._l(t.adjustInfo(e.company_name),(function(e,n){return a("div",{key:n,staticClass:"adjust-info-list-row"},[a("span",[t._v(t._s(n+1+".")+" ")]),a("div",{staticClass:"adjust-row-detail"},[a("div",[t._v(t._s("调整金额："+t.formatAmount(e.adjust_amount)+" 元"))]),a("div",{staticClass:"line-clamp-1"},[t._v(t._s("调整原因："+e.adjust_reason))])])])})),0)])]):t._e()])})),0)]],2)]},proxy:!0},{key:"right",fn:function(){return[a("card-layout",{scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("文件")])]},proxy:!0}])},[[a("section",{staticClass:"tg-cost-mcn-taobao-files"},[a("span",{staticClass:"titles"},[t._v("淘宝CPS收入文件下载")]),a("div",{staticClass:"mgt-12"},[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{"flex-shrink":"0"}},[a("tg-button",{staticClass:"uploaded-file-btn",attrs:{type:"link"}},[a("tg-icon",{staticClass:"uploaded-file-btn-icon",attrs:{name:t.getFileIcon(t.settlement.income_file)}}),a("span",{staticClass:"line-clamp-1",staticStyle:{"max-width":"300px"}},[t._v(t._s(t.basename(t.getFileName(t.settlement.income_file))))])],1),a("tg-button",{staticClass:"uploaded-file-download",staticStyle:{"flex-shrink":"0"},attrs:{target:"_blank",type:"link"},on:{click:function(e){return t.downloadFile(t.settlement.income_file)}}},[t._v("下载")])],1)])])]],2)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("生成结算单")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在生成结算单，请稍候..."}})]},proxy:!0}])})},da=[];const ma=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]);var pa=(0,n.defineComponent)({name:"Step3MCNTaoBaoBefore",components:{CardLayout:$.Z,SettlementStep2Layout:it,TgAdjustAccountForm:A.Z,TopCard:N.Z},setup(t,e){const a=(0,n.inject)("settlement")??(0,n.ref)(void 0),o=(0,n.ref)(!1),s={prev:()=>{e.emit("prev")},next:async()=>{const t=await(0,J.I)(e,{title:"确定生成结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","将对本次结算生成对应的结算单"),(0,n.h)("div","是否需要生成？")]),confirmText:"确定",cancelText:"取消"});t&&s.getSubCostSettlement()},confirmBeforeClose:async()=>!1,saveBeforeClose:()=>!1,fillForm:()=>{},adjustInfo:t=>a.value?.adjust_info.filter((e=>e.company_name===t))??[],formatAmount:t=>(0,v.dN)(t,"None"),getFileName:t=>{if(t&&t.length){const e=t.split("/");return e[e.length-1]??"--"}return"--"},getFileIcon:t=>{const e=t.split("."),a=e[e.length-1],n=ma.get(a)??"picture";return`ico-${n}`},downloadFile:t=>{const a={headers:{Authorization:(0,rt.LP)()??""}};fetch(t,a).then((async a=>{const n=a.clone();try{const t=await n.json();e.root.$message.error(t.message)}catch{if(200===a.status){const e=await a.blob(),n=decodeURIComponent(t.split("/")[t.split("/").length-1]);(0,f.uA)(e,n)}else e.root.$message.error("下载失败")}}))},getSubCostSettlement:async()=>{if(!a.value?.id)return;o.value=!0;const t=await(0,y.PK)({settlement_id:a.value?.id});o.value=!1,t.data.success?(e.root.$message.success((await t).data.message??"生成结算单成功"),e.emit("submit:success")):e.root.$message.error((await t).data.message??"生成结算单失败")}},i=t=>Ze.Z.basename(t);return{basename:i,settlement:a,saveLoading:o,...s}}}),_a=pa,va=(0,C.Z)(_a,ua,da,!1,null,null,null),fa=va.exports,ya=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-taobao-step2-after-container",attrs:{amount:t.formatAmount(t.total_settlement_amount)},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_settlement_amount,taxed:t.dataForm.is_include_tax,name:t.dataForm.companyInfo.company_name,type:"value1",tax_rate_disabled:!1,tax_rate:t.dataForm.tax_rate},on:{taxRateChanged:t.taxRateChanged,taxedChanged:t.taxedChanged,valueChange:t.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("div",{staticClass:"expenditure-cost-info"},[a("div",{staticClass:"expenditure-cost-info-list"},[a("div",{staticClass:"expenditure-cost-info-list-row"},[a("div",{staticClass:"cost-list-company"},[a("div",[a("span",{staticClass:"label"},[t._v("机构")]),a("span",{staticClass:"value"},[t._v(t._s(t.dataForm.companyInfo.company_name))])]),a("div",{staticClass:"cost-list-company-operator"},[a("tg-button",{attrs:{type:"link"},on:{click:t.downKolDataFile}},[t._v("下载")]),a("span",{staticClass:"kol-data"},[t._v(t._s("主播数据(共"+t.cloneSettlement.kol_count+"人)"))])],1)]),a("div",{staticClass:"commission"},[a("span",{staticClass:"label"},[t._v("提成比例")]),a("el-input",{attrs:{size:"small",placeholder:"0.00"},on:{input:t.commissionInput},model:{value:t.dataForm.companyInfo.tcbl,callback:function(e){t.$set(t.dataForm.companyInfo,"tcbl",e)},expression:"dataForm.companyInfo.tcbl"}},[a("template",{slot:"append"},[t._v("%")])],2),a("span",{staticClass:"label"},[t._v("原始收入")]),a("span",{staticClass:"origin-income"},[t._v(t._s(t.formatAmount(t.dataForm.companyInfo.yssr)+" 元"))])],1),a("div",{staticClass:"expenditure-cost-summary"},[a("span",{staticClass:"label"},[t._v("提成")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmount(t.dataForm.companyInfo.zccb)+" 元"))])])])])])]],2)]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{adjust_info:t.dataForm.adjustInfo},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},ga=[],xa=(0,n.defineComponent)({name:"Step2MCNTaoBaoAfter",components:{CardLayout:$.Z,SettlementStep2Layout:it,TgAdjustAccountForm:A.Z,TopCard:N.Z},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("settlement")??(0,n.ref)(void 0),i=(0,n.computed)((()=>{const t=(0,ct.I8)(s.value);return t})),l=(0,n.ref)({adjustInfo:i.value?.adjust_info?i.value?.adjust_info:[],companyInfo:{company_id:i.value?.company_id?String(i.value?.company_id):"",company_name:i.value?.company_name?String(i.value?.company_name):"",tcbl:i?String(i.value?.commission_rate):"",zccb:i?String(i.value?.commission):"0",yssr:i.value?.original_income_amount?String(i.value?.original_income_amount):"0"},is_include_tax:1,tax_amount:"",tax_rate:"",tax_included_amount:"",tax_excluded_amount:""}),r=(0,n.ref)((0,ct.I8)(l.value)),c=(0,n.computed)((()=>{let t=new(_())(0);return l.value.adjustInfo?.forEach((e=>{let a=e.adjust_amount?e.adjust_amount:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),t=new(_())(l.value.companyInfo.zccb?l.value.companyInfo.zccb:0).add(t),t.toFixed(2)})),u=t=>"0"===t||0===t?"0.00":t&&""!==t?new(_())(t?.toString()).toFixed(2).toString():"",d=(0,n.computed)((()=>`/api/settlement/download_settlement_kol_data?settlement_id=${i.value?.id}&company_name=${i.value?.company_name}&Authorization=${(0,rt.LP)()}`)),m=(0,n.ref)(!1),p={prev:()=>{p.isModified()?p.saveSettlementRequest(o.GG.prev):e.emit("prev")},next:()=>{p.saveSettlementRequest(o.GG.next)},isModified:()=>{const t=JSON.stringify(r.value),e=JSON.stringify(l.value);return t!==e},commissionInput:t=>{const e=p.getPositiveRateNumber(t);l.value.companyInfo.tcbl=e,l.value.companyInfo.zccb=new(_())(e||0).mul(new(_())(l.value.companyInfo.yssr?l.value.companyInfo.yssr:0)).div(new(_())(100)).toFixed(2)},checkDataForSave:()=>!!i.value?.id&&(l.value.adjustInfo?.find((t=>isNaN(Number(t.adjust_amount))))?(e.root.$message.warning("请输入正确的调整金额"),!1):l.value.adjustInfo?.find((t=>0===Number(t.adjust_amount)&&t.adjust_amount))?(e.root.$message.warning("调整金额不能为0"),!1):l.value.adjustInfo?.find((t=>(t.adjust_amount||t.adjust_reason)&&(!t.adjust_amount||!t.adjust_reason)))?(e.root.$message.warning("请完善手工调账信息"),!1):Number(c.value)<=0?(e.root.$message.warning("总结算金额不能小于等于0"),!1):!!p.isModified()||(e.emit("next"),!1)),confirmBeforeClose:async()=>p.isModified(),saveBeforeClose:()=>p.saveSettlementRequest(o.GG.close),fillForm:t=>{m.value=!0,l.value.tax_amount=u(t.tax_amount??""),l.value.tax_rate=t.tax_rate?t.tax_rate?.toString():"0",l.value.tax_excluded_amount=u(t.tax_excluded_amount??""),l.value.tax_included_amount=u(t.tax_included_amount??""),r.value.tax_amount=u(t.tax_amount??""),r.value.tax_rate=t.tax_rate?t.tax_rate?.toString():"0",r.value.tax_excluded_amount=u(t.tax_excluded_amount??""),r.value.tax_included_amount=u(t.tax_included_amount??"")},onAdjustAccountDataChange:t=>{l.value.adjustInfo=t},getPositiveRateNumber:t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],formatAmount:t=>(0,v.dN)(t,"None"),downloadAPIFileHandler:(t,a)=>{fetch(t).then((async t=>{const n=t.clone();try{const t=await n.json();e.root.$message.error(t.message)}catch{if(200===t.status){const e=await t.blob();(0,f.uA)(e,a)}else e.root.$message.error("下载失败")}}))},downKolDataFile:()=>{p.downloadAPIFileHandler(d.value,`${i.value?.company_name}的主播详情.xlsx`)},saveSettlementRequest:async t=>{if(t===o.GG.next&&!p.checkDataForSave())return;const n={id:i.value.id,step:t===o.GG.next?o.br.step_three:o.br.step_two,total_settle_amount:c.value,adjust_info:l.value.adjustInfo.filter((t=>t.adjust_amount||t.adjust_reason)),commission:l.value.companyInfo.zccb,commission_rate:""!==l.value.companyInfo.tcbl?l.value.companyInfo.tcbl:"0",is_include_tax:l.value.is_include_tax,tax_amount:l.value.tax_amount,tax_rate:""===l.value.tax_rate?"0":l.value.tax_rate??"0",tax_included_amount:l.value.tax_included_amount,tax_excluded_amount:l.value.tax_excluded_amount};a.value=!0;const s=await(0,y.uC)(n);if(a.value=!1,s.data.success)switch(t){case o.GG.prev:e.emit("prev",s.data.data);break;case o.GG.next:e.emit("next",s.data.data),e.root.$message.success(s.data.message??"保存成功");break;case o.GG.close:return e.root.$message.success("保存成功"),!0;default:break}else e.root.$message.error(s.data.message??"保存失败");return!1}};(0,n.onMounted)((()=>{r.value=(0,ct.I8)(l.value)}));const g=t=>{l.value.is_include_tax=t},x=t=>{l.value.tax_included_amount=t.tax_included_amount?.toString()??"",l.value.tax_excluded_amount=t.tax_excluded_amount?.toString()??"",l.value.tax_amount=t.tax_amount?.toString()??""},h=t=>{l.value.tax_rate=t};return{taxRateChanged:h,taxedChanged:g,taxValueChangeHandler:x,ShowAdjustInfo:m,total_settlement_amount:c,saveLoading:a,...p,dataForm:l,cloneSettlement:i,kolDataUrl:d}}}),ha=xa,ba=(0,C.Z)(ha,ya,ga,!1,null,null,null),ka=ba.exports,Ca=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-taobao-step3-after-container",class:1===t.settlement.is_estimate?"is_estimate":"",scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount.toString(),taxed:t.cloneSettlement.is_include_tax,name:t.cloneSettlement.company_name,name_desc:"供应商：",tax_rate:""+(t.cloneSettlement.tax_rate?t.cloneSettlement.tax_rate.toString():""),type:"value2",tax_rate_disabled:!0}})]},proxy:!0},{key:"left",fn:function(){return[a("card-layout",{attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("section",{staticClass:"expenditure-cost-list"},[a("section",{staticClass:"expenditure-cost-list-row"},[a("div",{staticClass:"cost-company-name"},[t._v(t._s(t.cloneSettlement.company_name))]),a("section",{staticClass:"commission-info"},[a("span",{staticClass:"label"},[t._v("提成：")]),a("div",{staticClass:"commission-info-detail"},[a("div",{staticClass:"commission-amount"},[t._v(" "+t._s(t.formatAmount(t.cloneSettlement.commission)+" 元")+" ")]),a("div",{staticClass:"commission-amount-desc"},[t._v(" "+t._s("总收入 "+t.cloneSettlement.original_income_amount+" 元，提成比例 "+t.cloneSettlement.commission_rate+"%")+" ")])])]),(t.cloneSettlement.adjust_info?t.cloneSettlement.adjust_info:[]).length?a("section",{staticClass:"adjust-info"},[a("div",{staticClass:"adjust-info-flex"},[a("span",{staticClass:"label"},[t._v("手工调账：")]),a("div",{staticClass:"adjust-info-list"},t._l(t.cloneSettlement.adjust_info,(function(e,n){return a("div",{key:n,staticClass:"adjust-info-list-row"},[a("span",[t._v(t._s(n+1+".")+" ")]),a("div",{staticClass:"adjust-row-detail"},[a("div",[t._v(t._s("调整金额："+t.formatAmount(e.adjust_amount)+" 元"))]),a("div",[t._v(t._s("调整原因："+e.adjust_reason))])])])})),0)])]):t._e()])])]],2)]},proxy:!0},{key:"right",fn:function(){return[a("card-layout",{staticClass:"card-layout-right",attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("文件")])]},proxy:!0}])},[[a("section",{staticClass:"tg-cost-mcn-taobao-files"},[a("section",{staticClass:"income-files"},[a("div",[a("span",{staticClass:"titles"},[t._v(t._s("下载主播数据（共"+t.cloneSettlement.kol_count+"人）"))]),a("div",{staticClass:"mgt-12"},[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{"flex-shrink":"0"}},[a("tg-button",{staticClass:"uploaded-file-btn",attrs:{type:"link"}},[a("tg-icon",{staticClass:"uploaded-file-btn-icon",attrs:{name:"ico-excel"}}),a("span",{staticClass:"line-clamp-1",staticStyle:{"max-width":"300px"}},[t._v(t._s(t.cloneSettlement.company_name+"的主播详情.xlsx"))])],1),a("tg-button",{staticClass:"uploaded-file-download",staticStyle:{"flex-shrink":"0"},attrs:{type:"link"},on:{click:t.downKolDataFile}},[t._v("下载")]),a("tg-button",{staticClass:"uploaded-file-download",staticStyle:{"flex-shrink":"0"},attrs:{type:"link"},on:{click:t.previewKolDataFile}},[t._v("预览")])],1)])]),a("div",{staticClass:"mgt-18"},[a("span",{staticClass:"titles"},[t._v("淘宝CPS收入文件下载")]),a("div",{staticClass:"mgt-12"},[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{"flex-shrink":"0"}},[a("tg-button",{staticClass:"uploaded-file-btn",attrs:{type:"link"}},[a("tg-icon",{staticClass:"uploaded-file-btn-icon",attrs:{name:t.getFileIcon(t.cloneSettlement.income_file)}}),a("span",{staticClass:"line-clamp-1",staticStyle:{"max-width":"300px"}},[t._v(t._s(t.basename(t.getFileName(t.cloneSettlement.income_file))))])],1),a("tg-button",{staticClass:"uploaded-file-download",staticStyle:{"flex-shrink":"0"},attrs:{target:"_blank",type:"link"},on:{click:function(e){return t.downloadFile(t.cloneSettlement.income_file)}}},[t._v("下载")]),a("tg-button",{staticClass:"uploaded-file-download",staticStyle:{"flex-shrink":"0"},attrs:{target:"_blank",type:"link"},on:{click:function(e){return t.tbcpsPreviewFile(t.cloneSettlement.income_file)}}},[t._v("预览")])],1)])])]),1!==t.settlement.is_estimate?a("section",{staticClass:"settlement-files"},[a("div",{class:t.readonly?"title":"title title-before"},[t._v("结算文件")]),t.readonly?t._e():a("div",{staticStyle:{display:"flex",height:"32px","align-items":"center"}},[a("div",{staticStyle:{"flex-shrink":"0"}},[a("el-upload",{attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":t.uploadFileHandler,accept:".docx,.pdf,.jpg,.jpeg,.png,.xlsx,.xls",disabled:t.settlementFiles.length>=5},model:{value:t.settlementFiles,callback:function(e){t.settlementFiles=e},expression:"settlementFiles"}},[a("tg-button",{staticClass:"upload-btn",attrs:{icon:"ico-btn-upload",disabled:t.settlementFiles.length>=5}},[t._v("上传文件")])],1)],1),a("div",{staticStyle:{"font-size":"12px","margin-left":"6px",color:"#a4b2c2"}},[a("div",[t._v("支持 .docx .pdf .jpg .png .xlsx")]),a("div",[t._v(".xls (单个文件大小不超过30M)")])])]),a("div",{directives:[{name:"show",rawName:"v-show",value:t.settlementFiles.length,expression:"settlementFiles.length"}],staticClass:"fileList",staticStyle:{"padding-right":"18px"}},t._l(t.settlementFiles,(function(e,n){return a("div",{key:n,staticStyle:{height:"20px","line-height":"20px","margin-top":"12px"}},[a("div",{staticClass:"line-clamp-1 uploaded-file"},[a("tg-button",{staticClass:"uploaded-file-btn",attrs:{type:"link"}},[a("tg-icon",{staticClass:"uploaded-file-btn-icon",attrs:{name:t.getFileIcon(e)}}),a("span",{staticClass:"line-clamp-1",staticStyle:{"max-width":"300px"}},[t._v(t._s(t.basename(t.getFileName(e))))])],1),a("tg-button",{staticClass:"uploaded-file-download",staticStyle:{"flex-shrink":"0"},attrs:{target:"_blank",type:"link"},on:{click:function(a){return t.downloadFile(e)}}},[t._v("下载")]),a("tg-button",{staticClass:"uploaded-file-download",staticStyle:{"flex-shrink":"0"},attrs:{target:"_blank",type:"link"},on:{click:function(a){return t.tbcpsPreviewFile(e)}}},[t._v("预览")]),t.readonly?t._e():a("tg-button",{staticClass:"mgl-12 uploaded-file-del",attrs:{type:"link"},on:{click:function(e){return t.handleRemoveFileClick(n)}}},[a("tg-icon",{staticStyle:{width:"16px",height:"16px"},attrs:{name:"ico-frm-delete",hoverName:"ico-frm-delete-active"}})],1)],1)])})),0)]):t._e()])]],2)]},proxy:!0},1!==t.settlement.is_estimate?{key:"files",fn:function(){return[a("div",[a("el-form",{staticStyle:{"margin-top":"5px"},attrs:{size:"mini"}},[a("el-form-item",{attrs:{label:"关联合同："}},[t.readonly?a("div",{staticStyle:{display:"flex","align-items":"center",color:"#3c5269"}},[t.cooperation_link_contract_ID&&t.contract_info.sign_type_name?a("div",[t._v(" "+t._s(t.contract_info.sign_type_name+": "+t.contract_info.contract_uid+" ("+t.contract_info.coop_start_date+"-"+t.contract_info.coop_end_date+")")+" ")]):a("div",[t._v("--")])]):a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:t.readonly?"--":"请输入合同编码","remote-method":t.getContract,size:"medium"},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.cooperation_link_contract_ID,callback:function(e){t.cooperation_link_contract_ID=e},expression:"cooperation_link_contract_ID"}},t._l(t.contract_uids,(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.sign_type_name+":  "+t.contract_uid+"  ("+t.coop_start_date+"-"+t.coop_end_date+")",value:t.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:null,t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},Sa=[];const wa=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]);var ja=(0,n.defineComponent)({name:"Step3MCNTaoBaoAfter",components:{CardLayout:$.Z,SettlementStep2Layout:it,TgAdjustAccountForm:A.Z,TopCard:N.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.ref)(!1);let s;const i=()=>{s=H.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},r=(0,n.inject)("settlement")??(0,n.ref)(void 0),c=(0,n.computed)((()=>{const t=(0,ct.I8)(r.value);return t})),u=(0,n.ref)(c.value?.settlement_files??[]),d=(0,n.ref)([...u.value]),m=(0,n.ref)(void 0),p=(0,n.ref)({contract_uid:void 0,coop_start_date:void 0,coop_end_date:void 0,sign_type_name:void 0}),_=(0,n.computed)((()=>`/api/settlement/download_settlement_kol_data?settlement_id=${c.value?.id}&company_name=${c.value?.company_name}&Authorization=${(0,rt.LP)()}`)),g={prev:()=>{g.isModified()?g.saveSettlementDataRequest(!1):e.emit("prev")},next:async()=>{if(0===r.value?.is_estimate&&!u.value.length)return void e.root.$message.warning("请上传结算单扫描件");const t=await(0,J.I)(e,{title:"确定提交结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,n.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});t&&g.submitSettlementDataRequest()},isModified:()=>{const t=JSON.stringify(d.value),e=JSON.stringify(u.value);return m.value!==j.value||t!==e},confirmBeforeClose:async()=>g.isModified(),saveBeforeClose:()=>g.saveSettlementDataRequest(!0),fillForm:t=>{t&&(u.value=t.settlement_files?[...t.settlement_files]:[],j.value=t.contract_id||void 0,m.value=t.contract_id||void 0,p.value.contract_uid=t.contract_uid||void 0,p.value.sign_type_name=t.sign_type_name||void 0,p.value.coop_start_date=t.coop_start_date||void 0,p.value.coop_end_date=t.coop_end_date||void 0)},getPositiveRateNumber:t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],formatAmount:t=>(0,v.dN)(t,"None"),getFileName:t=>{if(t&&t.length){const e=t.split("/");return e[e.length-1]??"--"}return"--"},getFileIcon:t=>{const e=t.split("."),a=e[e.length-1],n=wa.get(a)??"picture";return`ico-${n}`},handleRemoveFileClick:t=>{u.value.splice(t,1)},uploadFileHandler:async t=>{const a=t.file;if(a.size>31457280)return void e.root.$message.error("上传文件大小不能超过 30MB!");i();const n=new FormData,o=t.file.name;n.append("file",t.file,o),n.append("type","settlement");const l=await(0,E.$)(n);s.close(),l.data.success?(u.value.push(l.data.data.source),e.root.$message.success("上传成功")):e.root.$message.error(l.data.message??"上传失败，稍后重试")},downloadFile:(t,a)=>{const n={headers:{Authorization:(0,rt.LP)()??""}};fetch(t,n).then((async n=>{const o=n.clone();try{const t=await o.json();e.root.$message.error(t.message)}catch{if(200===n.status){const e=await n.blob(),o=a??decodeURIComponent(t.split("/")[t.split("/").length-1]);(0,f.uA)(e,o)}else e.root.$message.error("下载失败")}}))},downKolDataFile:()=>{g.downloadFile(_.value,`${c.value?.company_name}的主播详情.xlsx`)},saveSettlementDataRequest:async t=>{if(!c.value?.id)return;const n={id:c.value?.id,step:o.br.step_three,contract_id:j.value||0,settlement_files:u.value};a.value=!0;const s=await(0,y.Ys)(n,x.WD.mcn);return a.value=!1,s.data.success?(t?e.root.$message.success(s.data.message??"保存成功"):e.emit("prev",s.data.data),!0):(e.root.$message.error(s.data.message??"保存失败"),!1)},submitSettlementDataRequest:async()=>{if(!c.value?.id)return;if(0===r.value?.is_estimate&&!u.value.length)return void e.root.$message.warning("请上传结算单扫描件");const t={id:c.value?.id,contract_id:j.value||0};0===r.value?.is_estimate&&(t.settlement_files=u.value),a.value=!0;const n=await(0,y.FX)(t);a.value=!1,n.data.success?(e.root.$message.success(n.data.message??"提交结算成功"),e.emit("submit:success")):e.root.$message.error(n.data.message??"提交失败")}},h=(t,e)=>{t.includes(".png")||t.includes(".jpg")||t.includes(".jpeg")||t.includes(".pdf")?window.open(e):window.open("https://view.officeapps.live.com/op/view.aspx?src="+encodeURIComponent(e))},b=()=>{const t=_.value,e=location.origin,a=e+t;h(t,a)},k=t=>{const e=`${t}?Authorization=${(0,rt.LP)()}`;h(t,e)};(0,n.onMounted)((()=>{d.value=(0,ct.I8)(u.value)}));const C=(0,n.ref)([]),{project_id:S}=(0,l.L)(e),w=async t=>{const e=await(0,q.z0)({search:t,only_main:0,project_id:S.value,contract_status:2,partner_type:2,exclude_sign_types:-3});e.data.success?C.value=e.data.data.data:C.value=[]};!1===t.readonly&&w("");const j=(0,n.ref)(void 0),D=t=>{j.value=t},F=t=>Ze.Z.basename(t);return{contract_info:p,basename:F,contract_uids:C,getContract:w,cooperation_link_contract_ID:j,selectContractUidChange:D,settlement:r,saveLoading:a,kolDataUrl:_,...g,cloneSettlement:c,settlementFiles:u,previewKolDataFile:b,tbcpsPreviewFile:k}}}),Da=ja,Fa=(0,C.Z)(Da,Ca,Sa,!1,null,"ad6888d4",null),$a=Fa.exports,Aa=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-vtask-step2-before-container",attrs:{topHeightType:"default"},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.total_settlement_amount.toString(),type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("div",{staticClass:"expenditure-cost-info"},[a("div",{staticClass:"expenditure-cost-info-list"},[t.dataForm.companyData.company_info_list.length?a("div",t._l(t.dataForm.companyData.company_info_list?t.dataForm.companyData.company_info_list:[],(function(e,n){return a("div",{key:n,staticClass:"expenditure-cost-info-list-row"},[a("div",{staticClass:"cost-list-company"},[a("div",[a("span",{staticClass:"value"},[t._v(t._s(e.company_name))]),a("span",{staticClass:"company-cost"},[t._v(t._s("机构成本 "+t.formatAmount(e.zccb)+" 元"))])]),a("div",{staticClass:"cost-list-company-operator"},[a("tg-button",{attrs:{type:"link"},on:{click:function(a){return t.downKolDataFile(e)}}},[t._v("下载")]),e.excel_data?a("span",[a("span",{staticClass:"kol-data"},[t._v(t._s("达人数据(共"+(e.excel_data?e.excel_data.length:0)+"人)"))])]):t._e()],1)]),t._l(e.excel_data,(function(o,s){return a("div",{key:s,staticClass:"cost-list-company-kol"},[a("div",{staticClass:"origin-amount-info"},[a("div",{staticClass:"origin-amount-info-detail"},[a("span",{staticClass:"label"},[t._v(t._s("达人"+(s+1)))]),a("el-popover",{attrs:{placement:"top-start",trigger:"hover",content:o.kol_name,"open-delay":300,disabled:o.kol_name.length<10}},[a("span",{staticClass:"line-clamp-1",staticStyle:{width:"90px"},attrs:{slot:"reference"},slot:"reference"},[t._v(t._s(o.kol_name))])]),a("span",{staticStyle:{color:"#2877ff","margin-left":"12px",cursor:"pointer"},on:{click:function(a){return t.dialogCompany.show(e,n,o,s)}}},[t._v("更换结算公司")])],1),a("div",{staticClass:"origin-amount-info-detail"},[a("span",{staticClass:"label"},[t._v("原始收入")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmount(o.income_amount)+" 元"))])]),a("div",{staticClass:"origin-amount-info-detail"},[a("span",{staticClass:"label"},[t._v("原始支出")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmount(o.spend_amount)+" 元"))])]),a("div",{staticClass:"origin-amount-info-detail"},[a("tg-icon",{staticStyle:{width:"16px",height:"16px","font-size":"16px"},attrs:{className:"icon-delete",name:"ico-a-quseguanbiicon2x"},on:{click:function(a){return t.deleteClick(e,o,s,n)}}})],1)]),a("div",{staticClass:"commission"},[a("div",{staticClass:"commission-item"},[a("span",{staticClass:"label"},[t._v("退款金额")]),a("el-input",{attrs:{size:"small",placeholder:"0.00"},on:{input:function(a){return t.refundAmountInput(a,e,o)}},model:{value:o.tkje,callback:function(e){t.$set(o,"tkje",e)},expression:"kol.tkje"}},[a("template",{slot:"append"},[t._v("元")])],2)],1),a("div",{staticClass:"commission-item"},[a("span",{staticClass:"label"},[t._v("机构扣点")]),a("el-input",{attrs:{size:"small",placeholder:"0.00"},on:{input:function(a){return t.bucklePointInput(a,e,o)}},model:{value:o.jgkd,callback:function(e){t.$set(o,"jgkd",e)},expression:"kol.jgkd"}},[a("template",{slot:"append"},[t._v("%")])],2)],1),a("div",{staticClass:"commission-item"},[a("span",{staticClass:"label"},[t._v("税点")]),a("el-input",{attrs:{size:"small",placeholder:"0.00"},on:{input:function(a){return t.taxPointInput(a,e,o)}},model:{value:o.sd,callback:function(e){t.$set(o,"sd",e)},expression:"kol.sd"}},[a("template",{slot:"append"},[t._v("%")])],2)],1)])])}))],2)})),0):a("div",{staticClass:"tg-page-empty"},[a("empty-common",{attrs:{"detial-text":"请先上传达人和机构对应关系"}})],1)]),t.dataForm.companyData.nofind.length?a("div",{staticClass:"expenditure-cost-info-operator"},[a("div",[a("span",{staticStyle:{color:"#ec1e1e"}},[a("span",[t._v("还有")]),a("span",[t._v(t._s(""+t.dataForm.companyData.nofind.length))]),a("span",[t._v("名达人没有所属公司")])]),a("el-popover",{attrs:{"popper-class":"kol-company-map",placement:"top",trigger:"click"}},[a("div",{staticStyle:{"max-height":"150px",overflow:"overlay"}},t._l(t.dataForm.companyData.nofind,(function(e,n){return a("div",{key:n,style:0===n?"color: #3C5269;":"margin-top: 4px; color: #3C5269;"},[t._v(" "+t._s(e)+" ")])})),0),a("tg-button",{attrs:{slot:"reference",type:"link"},slot:"reference"},[t._v(" 查看明细")])],1),a("span",{staticClass:"mgl-12",staticStyle:{color:"#6a7b92"}},[t._v("请到达人管理中维护达人和达人所属公司")])],1),a("tg-button",{attrs:{type:"link"},on:{click:t.reloadRelationClick}},[a("tg-icon",{attrs:{name:"ico-loading"}}),a("span",{staticStyle:{"margin-left":"4px"}},[t._v("刷新数据")])],1)],1):t._e(),a("el-dialog",{staticClass:"tg-dialog-classic el-dialog-center-rewrite",attrs:{width:"300px",visible:t.dialogCompany.visible,"append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,wrapperClosable:!1,title:"更换公司"},on:{close:t.dialogCompany.close}},[a("el-form",{attrs:{size:"small","label-width":"86px",model:t.dialogCompany.form}},[a("div",{staticClass:"dialog_change_company"},[a("el-form-item",{attrs:{label:"选择公司"}},[a("el-select",{attrs:{filterable:"",remote:"","remote-method":t.dialogCompany.remoteMethod,placeholder:"请输入公司名"},model:{value:t.dialogCompany.form.company,callback:function(e){t.$set(t.dialogCompany.form,"company",e)},expression:"dialogCompany.form.company"}},t._l(t.dialogCompany.options,(function(t){return a("el-option",{key:t.id,attrs:{label:t.company_name,value:t.id}})})),1)],1)],1)]),a("template",{staticStyle:{height:"50px"},slot:"footer"},[a("tg-button",{attrs:{size:"small"},on:{click:t.dialogCompany.close}},[t._v(" 取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:t.dialogCompany.submit}},[t._v(" 确定 ")])],1)],2)],1)]],2)]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{height:470,ExtendItem:"company",adjust_info:t.dataForm.adjustInfo,ExtendItemSelectOptions:t.companyOptions},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.loading,content:t.loadingText}})]},proxy:!0}])})},Ia=[],La=(0,n.defineComponent)({name:"Step2MCNVTaskBefore",components:{CardLayout:$.Z,SettlementStep2Layout:it,TgAdjustAccountForm:A.Z,TopCard:N.Z},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.ref)(""),i=(0,n.inject)("settlement")??(0,n.ref)(void 0),l=(0,n.computed)((()=>{const t=(0,ct.I8)(i.value);return t})),r=(0,n.ref)({adjustInfo:l.value?.adjust_info?l.value?.adjust_info:[],companyData:{company_info_list:l.value.json_data?.company_info_list?(0,ct.I8)(l.value.json_data?.company_info_list):[],nofind:l.value.json_data?.nofind?(0,ct.I8)(l.value.json_data?.nofind):[]}}),c=(0,n.ref)((0,ct.I8)(r.value)),u=(0,n.computed)((()=>{let t=new(_())(0);return r.value.adjustInfo?.forEach((e=>{let a=e.adjust_amount?e.adjust_amount:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),r.value.companyData?.company_info_list?.forEach((e=>{let a=e.zccb?e.zccb:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),t.toFixed(2)})),d=(0,n.computed)((()=>`/api/settlement/download_kol_company_file?kol_type=2&Authorization=${(0,rt.LP)()}`)),m=(0,n.computed)((()=>r.value.companyData?.company_info_list.map((t=>({id:t.company_id,name:t.company_name})))??[])),p=(0,n.ref)(!1),g={prev:()=>{g.isModified()?x(o.GG.prev):e.emit("prev")},next:()=>{(r.value.companyData?.nofind??[]).length?k():x(o.GG.next)},setLoadingAndText:t=>{switch(t){case"save":a.value=!0,s.value="正在保存，请稍候...";break;case"upload":a.value=!0,s.value="正在上传，请稍候...";break;case"detail":a.value=!0,s.value="正在获取详情，请稍候...";break;case"reload":a.value=!0,s.value="正在刷新，请稍候...";break;case"none":a.value=!1,s.value="";break}},checkDataForSave:()=>!!g.checkIncomeFile()&&(!!l.value?.id&&(r.value.adjustInfo?.find((t=>isNaN(Number(t.adjust_amount))))?(e.root.$message.warning("请输入正确的调整金额"),!1):r.value.adjustInfo?.find((t=>0===Number(t.adjust_amount)&&t.adjust_amount))?(e.root.$message.warning("调整金额不能为0"),!1):r.value.adjustInfo?.find((t=>(t.adjust_amount||t.adjust_reason||t.company_name)&&(!t.adjust_amount||!t.adjust_reason||!t.company_name)))?(e.root.$message.warning("请完善手工调账信息"),!1):!(Number(u.value)<=0)||(e.root.$message.warning("总结算金额不能小于等于0"),!1))),checkIncomeFile:()=>!!l.value?.income_file||(e.root.$message.warning("请先在收入结算中上传原始收入文件"),!1),refundAmountInput:(t,e,a)=>{const n=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(I.Pj,""))??[""])[0];e&&a&&(a.tkje=n,e.zccb=g.companySpendAmount(e))},bucklePointInput:(t,e,a)=>{const n=g.getPositiveRateNumber(t);e&&a&&(a.jgkd=n,e.zccb=g.companySpendAmount(e))},taxPointInput:(t,e,a)=>{const n=g.getPositiveRateNumber(t);e&&a&&(a.sd=n,e.zccb=g.companySpendAmount(e))},companySpendAmount:t=>{let e=new(_())(0);return t.excel_data?.forEach((t=>{const a=new(_())(t.income_amount?t.income_amount:0).sub(new(_())(t.spend_amount?t.spend_amount:0)).sub(new(_())(t.tkje?t.tkje:0)),n=new(_())(100).sub(new(_())(t.jgkd?t.jgkd:0)).add(t.sd?t.sd:0).div(new(_())(100));e=e.add(a.mul(n).toFixed(2))})),e.toFixed(2)},kolDataUrl:t=>`/api/settlement/download_settlement_kol_data?settlement_id=${l.value?.id}&company_name=${t.company_name}&Authorization=${(0,rt.LP)()}`,isModified:()=>{const t=JSON.stringify(c.value),e=JSON.stringify(r.value);return t!==e},confirmBeforeClose:async()=>g.isModified(),saveBeforeClose:async()=>{const t=await x(o.GG.close);return t},fillForm:()=>{p.value=!0},onAdjustAccountDataChange:t=>{r.value.adjustInfo=t},getPositiveRateNumber:t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],formatAmount:t=>(0,v.dN)(t||0,"None"),uploadFileHandler:async t=>{if(!g.checkIncomeFile())return;const a=new FormData,n=t.file.name;a.append("file",t.file,n),a.append("settlement_id",String(l.value?.id)),g.setLoadingAndText("upload");const o=await(0,y._9)(a);g.setLoadingAndText("none"),o?.data.success?g.getSettlementDetail():e.root.$message.error(o?.data.message??"上传失败，稍后重试")},downloadAPIFileHandler:(t,a)=>{fetch(t).then((async t=>{const n=t.clone();try{const t=await n.json();e.root.$message.error(t.message)}catch{if(200===t.status){const e=await t.blob();(0,f.uA)(e,a)}else e.root.$message.error("下载失败")}}))},downloadKolCompanyMapFile:()=>{g.downloadAPIFileHandler(d.value,"机构达人对应关系.xlsx")},downKolDataFile:t=>{g.downloadAPIFileHandler(g.kolDataUrl(t),`${t.company_name}的达人详情.xlsx`)},getSettlementDetail:async()=>{if(!l.value?.id)return;const t={id:l.value.id};g.setLoadingAndText("detail");const a=await(0,y.S_)("common",t);if(g.setLoadingAndText("none"),a.data.success){const t=a.data.data;r.value.companyData=t?.json_data??{company_info_list:[],nofind:[]}}else e.root.$message.warning(a.data.message??"获取结算详情失败，请重新上传文件")},reloadRelationClick:async()=>{if(!i.value?.id)return;g.setLoadingAndText("reload");const t=await(0,y.ix)(`${i.value.id}`);g.setLoadingAndText("none"),t.data.success?await g.getSettlementDetail():e.root.$message.error(t?.data.message??"刷新失败，稍后重试")}},x=async t=>{if(t!==o.GG.next||g.checkDataForSave()){if(t===o.GG.next){const e=r.value.adjustInfo.filter((t=>t.adjust_amount||t.adjust_reason));if(e.length>0){const a=(0,n.ref)(!0);if(e.map((t=>{let e=!1;r.value.companyData.company_info_list.map((a=>{a.company_name===t.company_name&&(e=!0)})),!1===e&&(a.value=!1)})),!1===a.value){const e=C(t);return e}{const e=await h(t);return e}}{const e=await h(t);return e}}{const e=await h(t);return e}}},h=async(t,a=!1)=>{if(t!==o.GG.next&&!g.isModified())return!1;const n={id:l.value.id,step:t===o.GG.next?o.br.step_three:o.br.step_two,total_settle_amount:u.value,adjust_info:r.value.adjustInfo.filter((t=>t.adjust_amount||t.adjust_reason)),json_data:{nofind:r.value.companyData.nofind??[],company_info_list:(0,ct.I8)(r.value).companyData?.company_info_list.map((t=>(""===t.tkje&&(t.tkje="0"),""===t.jgkd&&(t.jgkd="0"),""===t.sd&&(t.sd="0"),t)))??[]}};g.setLoadingAndText("save");const[{data:s}]=await(0,f.Dc)(500,(0,y.RB)(n));if(g.setLoadingAndText("none"),s.success)switch(t){case o.GG.prev:e.emit("prev",s.data);break;case o.GG.next:e.emit("next",s.data),e.root.$message.success(s.message??"保存成功");break;case o.GG.close:return a&&e.emit("setDialogVisible"),e.root.$message.success("保存成功"),!0;default:break}else e.root.$message.error(s.message??"保存失败");return!1};(0,n.onMounted)((()=>{c.value=(0,ct.I8)(r.value),(0,n.nextTick)((()=>{g.checkIncomeFile()}))}));const b=(0,n.reactive)({form:{},options:[],visible:!1,company:{},salary_info:{},companyIndex:0,salary_index:0,show(t,e,a,n){b.company=t,b.companyIndex=e,b.salary_index=n,b.salary_info=a,b.form={company:t.company_id},b.options=[{id:t.company_id,company_name:t.company_name}],b.visible=!0},submit(){const t=b.form;if(!t.company)return void H.Message.error("请选择公司");const e=b.options.find((e=>e.id===t.company)),a=r.value.companyData.company_info_list.find((t=>t.company_id===e.id));if(e.id!==b.company.company_id){if(b.company.excel_data.splice(b.salary_index,1),0===b.company.excel_data.length&&r.value.companyData.company_info_list.splice(b.companyIndex,1),void 0===a){const t={...b.company};t.excel_data=[b.salary_info],t.excel_data[0].company_id=e.id,t.excel_data[0].company_name=e.company_name,t.company_id=e.id,t.company_name=e.company_name,r.value.companyData?.company_info_list.splice(b.companyIndex,0,t)}else{const t=b.salary_info||{};t.company_id=e.id,t.company_name=e.company_name,a.excel_data.push(t)}(0,Y.set)(r.value.companyData,"company_info_list",[...r.value.companyData.company_info_list]),r.value.companyData.company_info_list.map((t=>{t.zccb=g.companySpendAmount(t)})),b.visible=!1}else b.visible=!1},close:()=>{b.visible=!1},remoteMethod:t=>{""!==t?(0,ut.K)(t,1).then((t=>{b.options=t})):b.options=[]}}),k=async(t="部分达人尚未维护所属公司，继续将不结算其成本，请问是否继续？")=>{const a=await(0,J.I)(e,{title:t,content:""});if(!a)return!1;x(o.GG.next)},C=async(t,a="手工调账中部分公司没有对应结算数据，点击确定将自动删除进入下一步，是否继续？")=>{const n=await(0,J.I)(e,{title:a,content:""});if(!n)return!1;const o=r.value.adjustInfo.filter((t=>t.adjust_amount||t.adjust_reason));let s=!1;const i=[];o.map((t=>{r.value.companyData.company_info_list.map((e=>{e.company_name===t.company_name&&(s=!0)})),!0===s&&(i.push(t),s=!1)})),r.value.adjustInfo=i;const l=h(t,!0);return l},S=async(t,e,a,n)=>{t.excel_data.splice(a,1),0===t.excel_data.length&&r.value.companyData.company_info_list.splice(n,1),(0,Y.set)(r.value.companyData,"company_info_list",[...r.value.companyData.company_info_list]),r.value.companyData.company_info_list.map((t=>{t.zccb=g.companySpendAmount(t)}))};return{deleteClick:S,onShowNoFindCompanyClick:k,onDeleteBtnClick:C,dialogCompany:b,ShowAdjustInfo:p,dataForm:r,loading:a,loadingText:s,kolCompanyMapUrl:d,total_settlement_amount:u,...g,companyOptions:m}}}),Na=La,Ta=(0,C.Z)(Na,Aa,Ia,!1,null,"81005bce",null),za=Ta.exports,Ba=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-vtask-step3-before-container",attrs:{topHeightType:"default"},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount.toString(),type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("card-layout",{attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("section",{staticClass:"expenditure-cost-list"},t._l(t.settlement.json_data.company_info_list,(function(e,n){return a("section",{key:n,staticClass:"expenditure-cost-list-row"},[a("div",{staticClass:"cost-company-info"},[a("div",{staticClass:"cost-company-name"},[t._v(t._s(e.company_name))]),a("div",{staticClass:"cost-list-company-operator"},[a("tg-button",{attrs:{type:"link"},on:{click:function(a){return t.downKolDataFile(e)}}},[t._v("下载")]),a("span",{staticClass:"kol-data"},[t._v("达人数据")])],1)]),a("section",{staticClass:"settlement-amount-info"},[a("span",{staticClass:"label"},[t._v("结算金额：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmount(t.settlementAmount(e))+" 元"))])]),a("section",{staticClass:"commission-info"},[a("span",{staticClass:"label"},[t._v("机构成本：")]),a("div",{staticClass:"commission-info-detail"},[a("div",{staticClass:"commission-amount"},[t._v(t._s(t.formatAmount(e.zccb)+" 元"))])])]),t.adjustInfo(e.company_name).length?a("section",{staticClass:"adjust-info"},[a("div",{staticClass:"adjust-info-flex"},[a("span",{staticClass:"label"},[t._v("手工调账：")]),a("div",{staticClass:"adjust-info-list"},t._l(t.adjustInfo(e.company_name),(function(e,n){return a("div",{key:n,staticClass:"adjust-info-list-row"},[a("span",[t._v(t._s(n+1+".")+" ")]),a("div",{staticClass:"adjust-row-detail"},[a("div",[t._v(t._s("调整金额："+t.formatAmount(e.adjust_amount)+" 元"))]),a("div",{staticClass:"line-clamp-1"},[t._v(t._s("调整原因："+e.adjust_reason))])])])})),0)])]):t._e()])})),0)]],2)]},proxy:!0},{key:"bottom",fn:function(){return[a("section",{staticClass:"tg-cost-mcn-taobao-files"},[a("span",{staticClass:"titles"},[t._v("V任务收入文件下载：")]),a("div",[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{"flex-shrink":"0"}},[a("FileItem",{key:10001,attrs:{showPreview:!1,filepath:t.settlement.income_file,readonly:!0},on:{remove:function(e){return t.onRemoveFile(t.index)}}})],1)])])]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("生成结算单")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在生成结算单，请稍候..."}})]},proxy:!0}])})},Pa=[],Oa=(0,n.defineComponent)({name:"Step3MCNVTaskBefore",components:{CardLayout:$.Z,SettlementStep2Layout:it,TgAdjustAccountForm:A.Z,TopCard:N.Z},setup(t,e){const a=(0,n.inject)("settlement")??(0,n.ref)(void 0),o=(0,n.ref)(!1),s={prev:()=>{e.emit("prev")},next:async()=>{const t=await(0,J.I)(e,{title:"确定生成结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","将对本次结算生成对应的结算单"),(0,n.h)("div","是否需要生成？")]),confirmText:"确定",cancelText:"取消"});t&&s.getSubCostSettlement()},confirmBeforeClose:async()=>!1,saveBeforeClose:()=>!1,fillForm:()=>{},adjustInfo:t=>a.value?.adjust_info.filter((e=>e.company_name===t))??[],settlementAmount:t=>{let e=new(_())(t.zccb);const a=s.adjustInfo(t.company_name);return a.forEach((t=>{e=new(_())(t.adjust_amount).add(e)})),e.toFixed(2)},formatAmount:t=>(0,v.dN)(t,"None"),kolDataUrl:t=>`/api/settlement/download_settlement_kol_data?settlement_id=${a.value?.id}&company_name=${t.company_name}&Authorization=${(0,rt.LP)()}`,downloadAPIFileHandler:(t,a)=>{fetch(t).then((async t=>{const n=t.clone();try{const t=await n.json();e.root.$message.error(t.message)}catch{if(200===t.status){const e=await t.blob();(0,f.uA)(e,a)}else e.root.$message.error("下载失败")}}))},downKolDataFile:t=>{s.downloadAPIFileHandler(s.kolDataUrl(t),`${t.company_name}的达人详情.xlsx`)},getSubCostSettlement:async()=>{if(!a.value?.id)return;o.value=!0;const t=await(0,y.PK)({settlement_id:a.value?.id});o.value=!1,t.data.success?(e.root.$message.success((await t).data.message??"生成结算单成功"),e.emit("submit:success")):e.root.$message.error((await t).data.message??"生成结算单失败")}};return{saveLoading:o,settlement:a,...s}}}),Ra=Oa,Ma=(0,C.Z)(Ra,Ba,Pa,!1,null,null,null),Za=Ma.exports,Ga=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-vtask-step2-after-container",attrs:{amount:t.total_amount_str},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount_str,taxed:t.DataForm.is_include_tax,type:"value1",tax_rate_disabled:!1,tax_rate:t.DataForm.tax_rate},on:{taxRateChanged:t.taxRateChanged,taxedChanged:t.taxedChanged,valueChange:t.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{staticClass:"cost-info",attrs:{padding:[0,20]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("el-form",{staticClass:"tg-cost-vtask-form",attrs:{"label-width":"70px",size:"small"},model:{value:t.DataForm,callback:function(e){t.DataForm=e},expression:"DataForm"}},[a("div",{staticClass:"inline-form-items",staticStyle:{height:"50px","align-items":"center","border-bottom":"1px dashed rgba(164, 178, 194, 0.3)"}},[a("el-form-item",{staticStyle:{width:"538px"},attrs:{label:"","label-width":"0"}},[a("span",{staticClass:"item-value",staticStyle:{color:"#3c5269","font-weight":"600"}},[t._v(t._s(t.DataForm.company_name))]),a("span",{staticClass:"mgl-18",staticStyle:{color:"#ff7a36","font-weight":"600"}},[t._v("机构成本 "+t._s(t.formatAmount(t.total_cost_amount,"None"))+" 元")])]),a("div",{staticStyle:{height:"32px","line-height":"32px"}},[t.kolDataUrl?a("tg-button",{attrs:{type:"link",href:t.kolDataUrl,download:""}},[t._v("下载")]):t._e(),a("span",{staticClass:"kol-data",staticStyle:{color:"#a4b2c2"}},[t._v("达人数据(共"+t._s(t.DataForm.kol_list?t.DataForm.kol_list.length:0)+"人)")])],1)],1),t._l(t.DataForm.kol_list,(function(e,n){return a("div",{key:n,staticStyle:{"border-bottom":"1px dashed rgba(164, 178, 194, 0.3)","padding-bottom":"24px","padding-top":"8px"}},[a("div",{staticClass:"inline-form-items",staticStyle:{margin:"0 0 18px 0"}},[a("el-form-item",{attrs:{label:"达人"+(n+1)}},[a("el-popover",{attrs:{placement:"top-start",trigger:"hover",content:e.kol_name,"open-delay":300,disabled:e.kol_name.length<10}},[a("span",{staticClass:"item-value line-clamp-1",staticStyle:{width:"158px"},attrs:{slot:"reference"},slot:"reference"},[t._v(t._s(e.kol_name)+" ")])])],1),a("el-form-item",{attrs:{label:"原始收入"}},[a("span",{staticClass:"item-value",staticStyle:{width:"125px",display:"inline-block"}},[t._v(t._s(t.formatAmount(e.income_amount,"None"))+" 元")])]),a("el-form-item",{attrs:{label:"原始支出"}},[a("span",{staticClass:"item-value"},[t._v(t._s(t.formatAmount(e.spend_amount,"None"))+" 元")])])],1),a("div",{staticClass:"inline-form-items"},[a("el-form-item",{attrs:{label:"退款金额"}},[a("el-input",{attrs:{placeholder:"0.00"},on:{input:function(a){return t.RefundAmountInput(a,e)}},model:{value:e.tkje,callback:function(a){t.$set(e,"tkje",a)},expression:"kol.tkje"}},[a("template",{slot:"append"},[t._v("元")])],2)],1),a("el-form-item",{staticClass:"mgl-12",attrs:{label:"机构税点"}},[a("el-input",{attrs:{placeholder:"0.00",maxlength:"6"},on:{input:function(a){return t.CompanyTaxRateInput(a,e)}},model:{value:e.jgkd,callback:function(a){t.$set(e,"jgkd","string"===typeof a?a.trim():a)},expression:"kol.jgkd"}},[a("template",{slot:"append"},[t._v("%")])],2)],1),a("el-form-item",{staticStyle:{"margin-left":"8px"},attrs:{label:"税点","label-width":"40px"}},[a("el-input",{attrs:{maxlength:"6",placeholder:"0.00"},on:{input:function(a){return t.TaxRateInput(a,e)}},model:{value:e.sd,callback:function(a){t.$set(e,"sd","string"===typeof a?a.trim():a)},expression:"kol.sd"}},[a("template",{slot:"append"},[t._v("%")])],2)],1)],1)])}))],2)]],2)]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(t){t.preventDefault()}}},[t.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{adjust_info:t.DataForm.adjust_info},on:{DataChange:t.onAdjustAccountDataChange}}):t._e()],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},Ea=[];const Ja=(0,n.defineComponent)({props:{amount:{type:[String,Object]},topHeightType:{type:String,default:"value1"},leftItemWidth:{type:Number},douyinLiveSelf:{type:Boolean,default:!1},douyinS2b2cSelf:{type:Boolean,default:!1}},setup(t){const e=(0,n.computed)((()=>"string"===typeof t.amount?t.amount:(0,v.SJ)(t.amount??new(_())(0)))),a=(0,n.computed)((()=>t.douyinLiveSelf));return{douyin_live_self:a,final_amount:e}},render(){const t=arguments[0],e=[];let a=0,n=0,o=0,s=0;const i=this.leftItemWidth??0;void 0!==this.$slots.top&&e.push(t("div",{class:"step2-cost-layout-content-top"},this.$slots.top)),void 0!==this.$slots.left&&(e.push(t("div",{class:"step2-cost-layout-content-left"},this.$slots.left)),s+=1),void 0!==this.$slots.right&&(e.push(t("div",{class:"step2-cost-layout-content-right"},this.$slots.right)),s+=1),void 0!==this.$slots.bottom&&e.push(t("div",{class:"step2-cost-layout-content-bottom"},this.$slots.bottom)),void 0!==this.$slots.files&&e.push(t("div",{class:"step2-layout-content-files"},this.$slots.files)),"default"===this.$props.topHeightType?void 0===this.$slots.bottom?(a=24,n=470,o=0):(a=24,n=376,o=20):void 0===this.$slots.bottom?(a=118,n=380,this.douyinS2b2cSelf&&(n=420),o=0):(a=118,n=290,o=20),!0===this.douyin_live_self&&(n=n<370?370:n);const l={gridTemplateRows:o>0?`${a}px ${n}px ${o}px`:`${a}px ${n}px`,gridTemplateColumns:1===s?i?`${i}px`:"1fr":i?`${i}px 320px`:"714px 320px",columnGap:1===s?"0":"18px",justifyContent:1===s?"center":void 0};return t("div",{class:"step2-cost-layout"},[t("div",{class:void 0!==this.$slots.bottom&&void 0!==this.$slots.file?"container-contact-bottom step2-cost-layout-content":void 0!==this.$slots.bottom?"container-bottom step2-cost-layout-content":void 0!==this.$slots.file?"container-contact step2-cost-layout-content":"step2-cost-layout-content",style:l},[e]),t("div",{class:"bottom-button-line"},[this.$slots.button]),this.$slots.mask])}});var Ya=Ja;const Ha=t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],qa=t=>{const e=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];return e},Ua=t=>{const e=t||[],a=(e.length>0?e.reduce(((t,e)=>new(_())(e.adjust_amount&&!["","-",".","-."].includes(e.adjust_amount)?e.adjust_amount:"0").add(t)),new(_())("0")):new(_())("0")).toString();return a},Ka=(t,e)=>{const a=Ua(t);return new(_())(e&&""!==e?e:"0.00").add(a).toFixed(2).toString()};var Wa=(0,n.defineComponent)({name:"Step2MCNVTask",components:{SettlementStep2Layout:Ya,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("settlement")??(0,n.ref)(void 0),i=(0,n.ref)({original_income_amount:"0",original_spend_amount:"0",company_name:"",adjust_info:[],kol_list:[],is_include_tax:1,tax_amount:"",tax_rate:"",tax_included_amount:"",tax_excluded_amount:""}),l=(0,n.ref)([{adjust_amount:"",adjust_reason:""}]),r=(0,n.computed)((()=>{let t=new(_())(0);return i.value.kol_list.forEach((e=>{const a=new(_())(e.income_amount?e.income_amount:0).sub(e.spend_amount?e.spend_amount:0).sub(e.tkje?e.tkje:0),n=new(_())(100).sub(new(_())(e.jgkd?e.jgkd:0)).add(new(_())(e.sd?e.sd:0)).div(new(_())(100));t=t.add(a.mul(n))})),t.toString()})),c=(0,n.computed)((()=>Ka(i.value.adjust_info,r.value))),u=(0,n.computed)((()=>new(_())(c.value).toString())),d={onAdjustAccountDataChange:t=>{i.value.adjust_info=t},formatAmount:v.dN},m=(t,e)=>{const a=Ha(t);e.sd=a},p=(t,e)=>{const a=Ha(t);e.jgkd=a},g=(t,e)=>{const a=qa(t);e.tkje=a},h=(0,n.ref)(void 0),b=(0,n.ref)(0),k=(0,n.ref)({original_income_amount:"0",original_spend_amount:"0",company_name:"",adjust_info:[],kol_list:[],is_include_tax:1,tax_amount:"",tax_rate:"",tax_included_amount:"",tax_excluded_amount:""}),C=(0,n.computed)((()=>JSON.stringify(k.value)!==JSON.stringify(i.value))),S=t=>"0"===t||0===t?"0.00":t&&""!==t?new(_())(t?.toString()).toFixed(2).toString():"",w=(0,n.ref)(!1),j=t=>{h.value=t,w.value=!0,b.value=t.kol_count??0,i.value.original_income_amount=t.original_income_amount,i.value.original_spend_amount=t.original_spend_amount,i.value.company_name=t.company_name,i.value.adjust_info=t.adjust_info,i.value.kol_list=(0,ct.I8)(t.formal_json_data),i.value.tax_amount=D(t.tax_amount??0),i.value.is_include_tax=0===t.is_include_tax?0:1,i.value.tax_rate=`${t.tax_rate?t.tax_rate:"0"}`,i.value.tax_excluded_amount=S(t.tax_excluded_amount??""),i.value.tax_included_amount=S(t.tax_included_amount??""),k.value.original_income_amount=t.original_income_amount,k.value.original_spend_amount=t.original_spend_amount,k.value.company_name=t.company_name,k.value.adjust_info=(0,f.Qc)(t.adjust_info),k.value.kol_list=(0,ct.I8)(t.formal_json_data),k.value.tax_amount=D(t.tax_amount??0),k.value.is_include_tax=0===t.is_include_tax?0:1,k.value.tax_rate=`${t.tax_rate?t.tax_rate:"0"}`,k.value.tax_excluded_amount=S(t.tax_excluded_amount??""),k.value.tax_included_amount=S(t.tax_included_amount??"")},D=t=>t&&""!==t?"0"===t?"0.00":new(_())(t.toString()).toFixed(2).toString():"0.00",F=t=>{const e=h.value?.id??-1,a={id:e,total_settle_amount:c.value,adjust_info:t.adjust_info,company_id:h.value?.company_id??-1,formal_json_data:t.kol_list,is_include_tax:t.is_include_tax,tax_amount:t.tax_amount,tax_rate:t.tax_rate,tax_included_amount:t.tax_included_amount,tax_excluded_amount:t.tax_excluded_amount,spend_amount:r.value};return a},$=(0,n.computed)((()=>h.value?.company_name)),A=t=>{if(t.adjust_info&&t.adjust_info?.length>=1){const e=t.adjust_info.filter((t=>t.adjust_reason||t.adjust_amount));if(e.length>0)return e.map((t=>t))}return[]},I=(t=!0)=>{if(new(_())(r.value).lessThan(0))return"支出成本错误";const a=(0,n.ref)([]);if(i.value.adjust_info&&i.value.adjust_info?.length>=1){const t=i.value.adjust_info.filter((t=>t.kol_name||t.adjust_reason||t.adjust_amount));if(t.some((t=>/^(?:\+|-)?0?(?:\.0{0,2})?$/u.test(t.adjust_amount))))return"请输入正确的调整金额";if(t.some((t=>"0"===t.adjust_amount)))return e.root.$message.error("调整金额不能为0"),"调整金额不能为0";if(!t.every((t=>t.adjust_amount&&""!==t.adjust_amount&&"-"!==t.adjust_amount&&t.adjust_reason)))return"请完善手工调账信息";t.length>0&&(a.value=t)}return t&&a.value&&0===a.value.length&&["0","0.0","0.00"].includes(c.value??"0")?"至少填写一项结算项":t&&new(_())(c.value??"0").lte("0")?"总结算金额必须大于0":void 0},L=async t=>{a.value=!0;const[{data:e}]=await(0,f.Dc)(500,(0,y.bp)(t,x.WD.mcn));return a.value=!1,e},N=(0,n.computed)((()=>{if($.value){const t=`/api/settlement/download_settlement_kol_data?settlement_id=${s.value?.id}&company_name=${i.value.company_name}&Authorization=${(0,rt.LP)()}`;return t}return""})),T=async(t=!0)=>{if(a.value)return;const n=I(t);if(n)return void e.root.$message.error(n);const s=F(i.value);s.step=t?o.br.step_three:o.br.step_two,s.adjust_info=A(i.value);const l=await L(s);return l.success?t&&e.emit("next",l.data):e.root.$message.error(l.message??"保存失败"),l},z=(0,Y.useDebounceFn)(T,200),B=async()=>C.value,P=async()=>{const t=!1,e=await T(t);return!!e&&e.success},O=async()=>{if(C.value){const t=!1,a=await T(t);a&&(a.success?e.emit("prev",a.data):e.root.$message.warning(a.message))}else e.emit("prev")},R=()=>{z()},M=t=>{i.value.is_include_tax=t},Z=t=>{i.value.tax_included_amount=t.tax_included_amount?.toString()??"",i.value.tax_excluded_amount=t.tax_excluded_amount?.toString()??"",i.value.tax_amount=t.tax_amount?.toString()??""},G=t=>{i.value.tax_rate=t};return{taxedChanged:M,taxRateChanged:G,taxValueChangeHandler:Z,kolDataUrl:N,DataForm:i,adjustInfo:l,...d,ShowAdjustInfo:w,total_cost_amount:r,total_amount:c,total_amount_str:u,kol_user_count:b,saveLoading:a,next:R,prev:O,saveBeforeClose:P,onSaveHandler:z,fillForm:j,CompanyTaxRateInput:p,TaxRateInput:m,RefundAmountInput:g,confirmBeforeClose:B}}}),Va=Wa,Xa=(0,C.Z)(Va,Ga,Ea,!1,null,null,null),Qa=Xa.exports,tn=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"tg-cost-mcn-vtask-step3-after-container",class:1===t.settlement.is_estimate?"is_estimate":"",scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,taxed:t.DataForm.is_include_tax,tax_rate:t.DataForm.tax_rate,name:t.DataForm.company_name,name_desc:"供应商：",type:"value2"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本信息")]},proxy:!0}])},[a("div",[a("div",{staticStyle:{display:"inline-block"}},[a("div",{staticClass:"oneblock"},[a("div",{staticClass:"label"},[t._v("结算金额：")]),a("div",{staticStyle:{width:"608px"}},[a("span",{staticStyle:{color:"#3c5269","font-weight":"600","font-family":"PingFangSC-Regular"}},[t._v(" "+t._s(t.formatAmountStr(t.settlement.total_settle_amount))+" 元 ")])])]),a("div",{staticClass:"oneblock"},[a("div",{staticClass:"label"},[t._v("机构成本：")]),a("div",{staticStyle:{width:"608px"}},[a("span",{staticStyle:{color:"#3c5269","font-weight":"600","font-family":"PingFangSC-Regular"}},[t._v(" "+t._s(t.formatAmountStr(t.DataForm.spend_amount))+" 元 ")])])]),t.DataForm.adjust_info.length>0?a("div",{staticClass:"oneblock"},[a("div",{staticClass:"label"},[t._v("手工调账：")]),a("div",t._l(t.DataForm.adjust_info,(function(e,n){return a("div",{key:n,staticStyle:{"margin-bottom":"12px"}},[a("div",{staticStyle:{display:"flex"}},[a("div",{staticStyle:{display:"inline-block","text-align":"center",padding:"0"}},[t._v(" "+t._s(n+1)+".  ")]),a("div",[a("div",{staticStyle:{color:"#3c5269","font-family":"PingFangSC-Regular"}},[t._v(" 调整金额："+t._s(t.formatAmountStr(e.adjust_amount))+" 元 ")]),a("div",{staticStyle:{color:"#a4b2c2"}},[t._v("调整原因："+t._s(e.adjust_reason))])])])])})),0)]):t._e()])])])]},proxy:!0},{key:"right",fn:function(){return[a("CardLayout",{staticClass:"tg-files-container",attrs:{padding:[0,0,0,0]},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("文件")]},proxy:!0}])},[a("div",{staticStyle:{"padding-top":"18px",height:"149.5px"}},[a("div",{staticClass:"file-block-content"},[a("div",{staticStyle:{height:"18px","font-size":"12px",color:"#6a7b92"}},[t._v(" 下载达人数据（共"+t._s(t.kol_user_count)+"人） ")]),a("div",{staticStyle:{"margin-top":"12px","font-size":"14px",color:"#3c5269"}},[t.kolDataUrl?a("div",{staticClass:"fileItem"},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-excel"},slot:"icon"}),a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"222px"}},[t._v(" "+t._s(t.DataForm.company_name)+"的达人详情.xlsx ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex"},attrs:{type:"link",href:t.kolDataUrl,download:""}},[t._v("下载")])],1):t._e()])]),a("div",{staticClass:"file-block-content",staticStyle:{"margin-top":"18px"}},[a("div",{staticStyle:{height:"18px","font-size":"12px",color:"#6a7b92"}},[t._v("V任务收入文件下载")]),a("div",{staticStyle:{"margin-top":"12px","font-size":"14px",color:"#3c5269"}},[t.vtask_income_file?a("div",{staticClass:"fileItem"},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-excel"},slot:"icon"}),a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"222px"}},[t._v(" "+t._s(t.basename(t.getFileName(t.vtask_income_file)))+" ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex"},attrs:{type:"link"},on:{click:function(e){return t.downloadFileHandler(t.vtask_income_file)}}},[t._v("下载")])],1):t._e()])])]),a("div",{staticStyle:{"border-bottom":"1px solid rgba(164, 178, 194, 0.3)",margin:"0px 8px 0px 18px"}}),a("div",{staticClass:"file-block-content"},[1!==t.settlement.is_estimate?a("div",{staticClass:"statements-file-block-new"},[a("div",{staticClass:"statements-file"},[a("div",[a("div",{staticStyle:{"margin-bottom":"6px","font-size":"12px","line-height":"16px",height:"16px"}},[t.readonly?t._e():a("span",{staticStyle:{color:"red"}},[t._v("*")]),t._v("结算文件 ")]),t.readonly?t._e():a("div",{staticStyle:{display:"flex","line-height":"32px",height:"32px",width:"100%","margin-bottom":"6px","font-size":"14px"}},[t.uploadedFileList.length<5?a("el-upload",{attrs:{action:"/",accept:".docx,.pdf,.jpg,.jpeg,.xlsx,.png,.xls",multiple:!1,"show-file-list":!1,"http-request":t.uploadFileHandler}},[a("tg-button",{attrs:{size:"small",icon:"ico-btn-upload"}},[t._v("上传文件")])],1):a("tg-button",{attrs:{size:"small",disabled:!0,icon:"ico-btn-upload"}},[t._v("上传文件")]),a("div",{staticStyle:{display:"inline-block","margin-left":"6px","font-size":"12px",width:"166px",color:"#a4b2c2","line-height":"16px",height:"32px","font-weight":"400"}},[t._v(" 支持.docx .pdf .jpg .png .xlsx .xls(单个文件大小不超过30M) ")])],1)]),a("div",{staticClass:"fileList",staticStyle:{"margin-top":"12px"}},t._l(t.uploadedFileList,(function(e,n){return a("div",{key:n,staticClass:"fileItem"},[a("div",{staticStyle:{display:"flex"}},[a("tg-icon",{staticStyle:{width:"20px",height:"20px","line-height":"20px"},attrs:{slot:"icon",name:"ico-"+e.icon},slot:"icon"}),t.readonly?a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"220px"}},[t._v(" "+t._s(t.basename(e.name))+" ")]):a("div",{staticClass:"line-clamp-1",staticStyle:{"margin-left":"2px","margin-right":"12px",height:"18px","line-height":"20px",width:"194px"}},[t._v(" "+t._s(t.basename(e.name))+" ")]),a("tg-button",{staticStyle:{"line-height":"20px",height:"18px",display:"flex","flex-shrink":"0"},attrs:{type:"link"},on:{click:function(a){return t.downloadFileHandler(e.path)}}},[t._v("下载")])],1),t.readonly?t._e():a("div",{staticClass:"file-delete-icon"},[a("tg-icon",{staticStyle:{"margin-left":"13px","font-size":"16px",width:"16px",height:"16px","line-height":"20px",cursor:"pointer"},attrs:{slot:"icon",name:"ico-frm-delete","hover-name":"ico-frm-delete-active"},on:{click:function(e){return t.handleRemoveFileClick(n)}},slot:"icon"})],1)])})),0)])]):t._e()])])]},proxy:!0},1!==t.settlement.is_estimate?{key:"files",fn:function(){return[a("div",[a("el-form",{staticStyle:{"margin-top":"5px"},attrs:{size:"mini"}},[a("el-form-item",{attrs:{label:"关联合同："}},[t.readonly?a("div",{staticStyle:{display:"flex","align-items":"center",color:"#3c5269"}},[t.cooperation_link_contract_ID&&t.contract_info.sign_type_name?a("div",[t._v(" "+t._s(t.contract_info.sign_type_name+": "+t.contract_info.contract_uid+" ("+t.contract_info.coop_start_date+"-"+t.contract_info.coop_end_date+")")+" ")]):a("div",[t._v("--")])]):a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:t.readonly?"--":"请输入合同编码","remote-method":t.getContract,size:"medium"},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.cooperation_link_contract_ID,callback:function(e){t.cooperation_link_contract_ID=e},expression:"cooperation_link_contract_ID"}},t._l(t.contract_uids,(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.sign_type_name+":  "+t.contract_uid+"  ("+t.coop_start_date+"-"+t.coop_end_date+")",value:t.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:null,t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},en=[];const an={headers:{Authorization:(0,rt.LP)()??""}},nn=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]),on=t=>{const e=e=>{fetch(e,an).then((async a=>{const n=a.clone();try{const e=await n.json();t.root.$message.error(e.message)}catch{if(200===a.status){const t=await a.blob(),n=decodeURIComponent(e.split("/")[e.split("/").length-1]);(0,f.uA)(t,n)}else t.root.$message.error("下载失败")}}))};return{downloadFileHandler:e}},sn=t=>{const e=t.split("/")[t.split("/").length-1],a=e.split(".")[e.split(".").length-1],n=nn.get(a)??"picture";return{name:e,icon:n,type:n,path:t}};var ln=(0,n.defineComponent)({name:"Step3MCNVTask",components:{SettlementStep3Layout:Ya,CardLayout:$.Z,TopCard:N.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a={formatAmount:v.dN,getFileName:t=>{if(t&&t.length){const e=t.split("/");return e[e.length-1]??"--"}return"--"}},s=(0,n.ref)("0"),i=(0,n.ref)(!1);let r;const c=()=>{r=H.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},u=(0,n.inject)("settlement")??(0,n.ref)(void 0),d=(0,n.ref)([]),m=(0,n.ref)(void 0),p=(0,n.ref)({contract_uid:void 0,coop_start_date:void 0,coop_end_date:void 0,sign_type_name:void 0}),g=(0,n.ref)({adjust_info:[{adjust_amount:"",adjust_reason:""}],settlement_files:[]}),{downloadFileHandler:x}=on(e),h=(0,n.ref)(""),b=(0,n.ref)([]),k=async t=>{const a=t.file;if(a.size>31457280)return void e.root.$message.error("上传文件大小不能超过 30MB!");c();const n=new FormData,o=t.file.name;n.append("file",t.file,o),n.append("type","settlement");const s=await(0,E.$)(n),i=s.data;if(r.close(),i.success){const a=o.split(".")[o.split(".").length-1],n=""!==t.file.type?t.file.type:a,s={name:t.file.name,type:t.file.type,icon:nn.get(n)??"picture",size:t.file.size,path:i.data.source};e.root.$message.success("上传成功"),b.value.push(s)}else e.root.$message.error(i.message??"上传失败，稍后重试")},C=(0,n.ref)(0),S=(0,n.ref)(void 0),w=t=>{S.value=t,C.value=t.kol_count??0,s.value=new(_())(t.total_settle_amount).toString(),h.value=t.income_file,g.value.settlement_files=t.settlement_files,d.value=t.settlement_files,g.value.tax_rate=t.tax_rate?.toString()??"",g.value.is_include_tax=0===t.is_include_tax?0:1,g.value.company_name=t.company_name,g.value.spend_amount=t.spend_amount,g.value.adjust_info=t.adjust_info,g.value.spend_description=`总收入 ${t.original_income_amount}元，总支出 ${t.original_spend_amount}元，退款金额 ${t.refund_amount}元，机构扣点\n      ${t.buckle_point}%， 税点 ${t.tax_point}%`,Z.value=t.contract_id||void 0,m.value=t.contract_id||void 0,p.value.contract_uid=t.contract_uid||void 0,p.value.sign_type_name=t.sign_type_name||void 0,p.value.coop_start_date=t.coop_start_date||void 0,p.value.coop_end_date=t.coop_end_date||void 0,t.settlement_files&&(b.value=t.settlement_files.map((t=>sn(t))))},j=(0,n.computed)((()=>S.value?.company_name)),D=(0,n.computed)((()=>{if(j.value){const t=`/api/settlement/download_settlement_kol_data?settlement_id=${u.value?.id}&company_name=${g.value.company_name}&Authorization=${(0,rt.LP)()}`;return t}return""})),F=async()=>{if(void 0===u.value)return;const t={id:S.value?.id??-1,step:o.br.step_three,contract_id:Z.value||0},a=g.value.settlement_files?g.value.settlement_files:[];t.settlement_files=a;const{business_type:n}=u.value;i.value=!0;const[{data:s}]=await(0,f.Dc)(500,(0,y.bp)(t,n));return i.value=!1,!!s.success||(e.root.$message.error(s.message),!1)},$=async()=>{if(void 0===u.value)return;const t=g.value.settlement_files?g.value.settlement_files:[];if(0===u.value.is_estimate&&0===t.length)return void e.root.$message.warning("请上传结算单扫描件");const a=await(0,J.I)(e,{title:"确定提交结算单吗？",content:()=>(0,n.h)("div",[(0,n.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,n.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});if(!a)return;const o={id:S.value?.id??-1,contract_id:Z.value||0};0===u.value.is_estimate&&(o.settlement_files=t),i.value=!0;const[{data:s}]=await(0,f.Dc)(500,(0,y.FX)(o));i.value=!1,s.success?(e.root.$message.success("提交成功"),e.emit("submit:success")):e.root.$message.error(s.message??"提交失败")},A=(0,Y.useDebounceFn)($,200),I=async()=>await F(),L=(0,n.computed)((()=>m.value!==Z.value||JSON.stringify(d.value)!==JSON.stringify(g.value.settlement_files))),N=async()=>{if(void 0!==u.value)if(L.value){const t={id:S.value?.id??-1,step:o.br.step_three,contract_id:Z.value||0},a=g.value.settlement_files?g.value.settlement_files:[];t.settlement_files=a;const{business_type:n}=u.value;i.value=!0;const[{data:s}]=await(0,f.Dc)(500,(0,y.bp)(t,n));i.value=!1,s.success?e.emit("prev",s.data):e.root.$message.error(s.message)}else e.emit("prev")};(0,n.watch)((()=>b.value),(t=>{t&&(g.value.settlement_files=b.value.map((t=>t.path)))}));const T=t=>{b.value.splice(t,1)},z=async()=>{A()},B=async()=>L.value,P=t=>t&&""!==t?(0,v.FU)(t):"0",O=(0,n.ref)([]),{project_id:R}=(0,l.L)(e),M=async t=>{const e=await(0,q.z0)({search:t,only_main:0,project_id:R.value,contract_status:2,partner_type:2,exclude_sign_types:-3});e.data.success?O.value=e.data.data.data:O.value=[]};!1===t.readonly&&M("");const Z=(0,n.ref)(void 0),G=t=>{Z.value=t},U=t=>Ze.Z.basename(t);return{contract_info:p,basename:U,contract_uids:O,getContract:M,cooperation_link_contract_ID:Z,selectContractUidChange:G,settlement:u,...a,formatAmountStr:P,kol_user_count:C,handleRemoveFileClick:T,DataForm:g,vtask_income_file:h,uploadedFileList:b,total_amount:s,saveLoading:i,kolDataUrl:D,saveBeforeClose:I,fillForm:w,prev:N,next:z,uploadFileHandler:k,downloadFileHandler:x,confirmBeforeClose:B}}}),rn=ln,cn=(0,C.Z)(rn,tn,en,!1,null,"dea0a6ca",null),un=cn.exports,dn=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-douyin-step2-before-container",attrs:{topHeightType:"default"},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.total_settlement_amount.toString(),type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("div",{staticClass:"left-content"},[a("div",[a("div",{staticClass:"add-settlement-detail-container"},[a("tg-button",{attrs:{icon:"ico-btn-add",type:"primary",size:"mini",disabled:t.dataForm.company_info_list.length>=6},on:{click:t.addSettlementDetail}},[t._v("新增结算明细")])],1),a("div",{staticStyle:{"margin-top":"2px"}},t._l(t.dataForm.company_info_list,(function(e,n){return a("CostDetail",{key:n,staticStyle:{"margin-bottom":"16px"},attrs:{feeDetail:e,disabledTypeList:t.selectedIncomeTypeList},on:{delSettlementDetail:function(e){return t.delSettlementDetail(n)}}})})),1)])])]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(t){t.preventDefault()}}},[a("TgAdjustAccountForm",{attrs:{height:470,ExtendItem:"supplier",adjust_info:t.dataForm.adjustInfo,ExtendItemSelectOptions:t.selectedCompanyList},on:{DataChange:t.onAdjustAccountDataChange}})],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.loading,content:t.loadingText}})]},proxy:!0}])})},mn=[];const pn=()=>({company_id:"",company_name:"",file:void 0,income_amount:"",type:void 0,company_list:[]});var _n=(0,n.defineComponent)({props:{},components:{TopCard:N.Z,TgAdjustAccountForm:A.Z,CardLayout:$.Z,SettlementStep2Layout:it,CostDetail:Jt},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.ref)(""),i=(0,n.inject)("settlement")??(0,n.ref)(void 0),l=(0,n.computed)((()=>{const t=(0,ct.I8)(i.value);return t})),r=(0,n.ref)({adjustInfo:l.value?.adjust_info??[],company_info_list:l.value.json_data?.company_info_list??[pn()]}),c=(0,n.computed)((()=>r.value.company_info_list?.map((t=>t.type))??[])),u=(0,n.computed)((()=>{const t=[],e=e=>!!t.find((t=>t.name===e));return r.value.company_info_list?.forEach((a=>{a.company_name&&!e(a.company_name)&&t.push({id:a.company_id,name:a.company_name}),a.company_list?.forEach((a=>{a.company_name&&!e(a.company_name)&&t.push({id:a.company_id,name:a.company_name})}))})),t})),d=(0,n.ref)((0,ct.I8)(r.value)),m=(0,n.computed)((()=>{let t=new(_())(0);return r.value.adjustInfo?.forEach((e=>{let a=e.adjust_amount?e.adjust_amount:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),r.value.company_info_list?.forEach((e=>{let a=e.income_amount?e.income_amount:"0";a=isNaN(Number(a))?"0":a,t=new(_())(a).add(t),e.company_list?.forEach((e=>{let a=e.income_amount?e.income_amount:"0";a=isNaN(Number(a))?"0":a,t=new(_())(a).add(t)}))})),t.toFixed(2)})),p={prev:()=>{p.isModified()?p.saveSettlementRequest(o.GG.prev):e.emit("prev")},next:()=>{p.saveSettlementRequest(o.GG.next)},setLoadingAndText:t=>{switch(t){case"save":a.value=!0,s.value="正在保存，请稍候...";break;case"upload":a.value=!0,s.value="正在上传，请稍候...";break;case"detail":a.value=!0,s.value="正在获取详情，请稍候...";break;case"reload":a.value=!0,s.value="正在刷新，请稍候...";break;case"none":a.value=!1,s.value="";break}},checkDataForSave:()=>{if(!l.value?.id)return!1;let t=!0,a="";return r.value.company_info_list?.forEach((e=>{switch(e.type){case o.eY.put:case o.eY.talent_cost:{const n=e.company_list?.find((t=>!t.company_id||!t.kol_id||!t.income_amount));n&&(t=!1,e.type===o.eY.put?a="请完善投放成本数据信息":e.type===o.eY.talent_cost&&(a="请完善达人成本数据信息"));break}case o.eY.pit_fee:case o.eY.shangguang:case o.eY.xingtu:case o.eY.other:{const n=e.company_list?.find((t=>!t.company_name&&t.income_amount||t.company_name&&!t.income_amount||!t.company_name&&!t.income_amount));(n||e.type===o.eY.pit_fee&&0===(e.company_list??[]).length)&&(t=!1,e.type===o.eY.pit_fee?a="请完善坑位费数据信息":e.type===o.eY.shangguang?a="请完善商广成本数据信息":e.type===o.eY.other?a="请完善其他成本数据信息":e.type===o.eY.xingtu&&(a="请完善星图成本数据信息"));break}default:break}})),t?r.value.adjustInfo?.find((t=>isNaN(Number(t.adjust_amount))))?(e.root.$message.warning("请输入正确的调整金额"),!1):r.value.adjustInfo?.find((t=>0===Number(t.adjust_amount)&&t.adjust_amount))?(e.root.$message.warning("调整金额不能为0"),!1):r.value.adjustInfo?.find((t=>(t.adjust_amount||t.adjust_reason||t.company_name)&&(!t.adjust_amount||!t.adjust_reason||!t.company_name)))?(e.root.$message.warning("请完善手工调账信息"),!1):Number(m.value)<=0?(e.root.$message.warning("总结算金额不能小于等于0"),!1):p.settlementDetailToAdjustCompanyValidate()?!!p.isModified()||(e.emit("next"),!1):(g(),!1):(e.root.$message.warning(a),!1)},isModified:()=>{const t=JSON.stringify(d.value),e=JSON.stringify(r.value);return t!==e},confirmBeforeClose:async()=>p.isModified(),saveBeforeClose:()=>p.saveSettlementRequest(o.GG.close),onAdjustAccountDataChange:t=>{r.value.adjustInfo=t},getPositiveRateNumber:t=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],formatAmount:t=>(0,v.dN)(t,"None"),downloadAPIFileHandler:(t,a)=>{fetch(t).then((async t=>{const n=t.clone();try{const t=await n.json();e.root.$message.error(t.message)}catch{if(200===t.status){const e=await t.blob();(0,f.uA)(e,a)}else e.root.$message.error("下载失败")}}))},saveSettlementRequest:async t=>{if(t===o.GG.next&&!p.checkDataForSave())return;const a={id:l.value.id,step:t===o.GG.next?o.br.step_three:o.br.step_two,total_settle_amount:m.value,adjust_info:r.value.adjustInfo.filter((t=>t.adjust_amount||t.adjust_reason)),json_data:{company_info_list:(r.value.company_info_list??[]).filter((t=>t.type&&(t.type!==o.eY.pit_fee||t.type===o.eY.pit_fee&&(t.company_list??[]).length>0))),nofind:[]}};p.setLoadingAndText("save");const n=await(0,y.bp)(a,x.WD.mcn);if(p.setLoadingAndText("none"),n.data.success)switch(t){case o.GG.prev:e.emit("prev",n.data.data);break;case o.GG.next:e.emit("next",n.data.data),e.root.$message.success(n.data.message??"保存成功");break;case o.GG.close:return e.root.$message.success("保存成功"),!0;default:break}else e.root.$message.error(n.data.message??"保存失败");return!1},addSettlementDetail:()=>{r.value.company_info_list?.unshift(pn())},delSettlementDetail:t=>{r.value.company_info_list?.splice(t,1)},settlementDetailToAdjustCompanyValidate:()=>{let t=r.value.adjustInfo.map((t=>t.company_name)).filter((t=>void 0!==t&&""!==t));if(t.length){t=Array.from(new Set(t));let e=0;return t.forEach(((t,a)=>{r.value.company_info_list?.forEach((n=>{if(e===a)if(n.company_name)t===n.company_name&&(e+=1);else{const a=n.company_list?.find((e=>e.company_name===t));a&&(e+=1)}}))})),e===t.length}return!0}};(0,n.onMounted)((()=>{d.value=(0,ct.I8)(r.value)}));const g=async(t="手工调账中部分公司没有对应结算数据，点击确定将自动删除进入下一步，是否继续？")=>{const a=await(0,J.I)(e,{title:t,content:""});if(!a)return!1;const n=r.value.adjustInfo.filter((t=>t.adjust_amount||t.adjust_reason));let s=!1;const i=[];return n.map((t=>{r.value.company_info_list?.forEach((e=>{if(e.company_name)t.company_name===e.company_name&&(s=!0);else{const a=e.company_list?.find((e=>e.company_name===t.company_name));a&&(s=!0)}})),!0===s&&(i.push(t),s=!1)})),r.value.adjustInfo=i,p.saveSettlementRequest(o.GG.next),!1};return{onDeleteBtnClick:g,selectedCompanyList:u,total_settlement_amount:m,loading:a,loadingText:s,dataForm:r,selectedIncomeTypeList:c,...p}}}),vn=_n,fn=(0,C.Z)(vn,dn,mn,!1,null,null,null),yn=fn.exports,gn=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-douyin-step3-before-container",attrs:{topHeightType:"default",leftItemWidth:600},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount.toString(),type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("div",{staticClass:"before-customer-list"},t._l(t.company_info,(function(e,n){return a("div",{key:n,staticClass:"before-customer"},[n>0?a("div",{staticClass:"hr"}):t._e(),a("div",{staticClass:"before-customer-name",staticStyle:{"margin-bottom":"4px"}},[t._v(" "+t._s(e.company_name)+" ")]),t._l(t.feeNameTypes,(function(n,o){return a("div",{directives:[{name:"show",rawName:"v-show",value:t.amountDetail(n.type,e.amount_info_list),expression:"amountDetail(item.type, company.amount_info_list)"}],key:o,staticClass:"before-income-row mgt-12"},[a("div",{staticClass:"before-income-row-detail"},[a("span",{staticClass:"label"},[t._v(t._s(n.name)+"：")]),a("span",{staticClass:"value"},[t._v(t._s(t.income_amount(n.type,e.amount_info_list))+" 元")]),1===n.type?a("tg-button",{staticClass:"downerload",attrs:{type:"link"},on:{click:function(){return t.onDownloadPitFeeDetail(e)}}},[t._v("下载明细")]):t._e(),8===n.type&&t.isYufengCompany(e.company_name)?a("tg-button",{staticClass:"downerload",attrs:{type:"link"},on:{click:function(){return t.onDownloadPutDetail(n.type,e.amount_info_list)}}},[t._v("下载明细")]):t._e()],1),1!==n.type&&t.remark(n.type,e.amount_info_list)?a("div",{staticClass:"other-desc"},[t._v(" "+t._s(t.remark(n.type,e.amount_info_list))+" ")]):t._e()])})),e.adjust_info&&e.adjust_info.length?a("div",{staticClass:"before-adjust-info mgt-12"},t._l(e.adjust_info,(function(e,n){return a("div",{key:n},[a("div",{staticClass:"mgt-12"},[a("span",{staticClass:"label"},[t._v("手工调账：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(e.adjust_amount))+" 元")])]),a("div",{staticClass:"other-desc"},[t._v(t._s(e.adjust_reason))])])})),0):t._e()],2)})),0)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("生成结算单")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在生成结算单，请稍候..."}})]},proxy:!0}])})},xn=[],hn=(0,n.defineComponent)({components:{SettlementStep2Layout:it,TopCard:N.Z},setup(t,e){const a=(0,n.computed)((()=>{const t=[];return o.gf.forEach(((e,a)=>{t.push({type:a,name:e})})),t})),s=(0,n.ref)(!1),i=(0,n.inject)("settlement")??(0,n.ref)(void 0),l=(0,n.computed)((()=>i.value?.company_info_json??[])),r={prev:async()=>{e.emit("prev")},next:async()=>{const t=await(0,J.I)(e,{title:"确定生成结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","将对本次结算生成对应的结算单"),(0,n.h)("div","是否需要生成？")]),confirmText:"确定",cancelText:"取消"});t&&r.getSubCostSettlement()},saveBeforeClose:async()=>!1,confirmBeforeClose:async()=>!1,getSubCostSettlement:async()=>{if(!i.value?.id)return;s.value=!0;const t=await(0,y.PK)({settlement_id:i.value?.id});s.value=!1,t.data.success?(e.root.$message.success(t.data.message??"生成结算单成功"),e.emit("submit:success")):e.root.$message.error(t.data.message??"生成结算单失败")},amountDetail:(t,e)=>e.find((e=>e.type===t)),income_amount:(t,e)=>(0,v.FU)(r.amountDetail(t,e)?.amount??0),remark:(t,e)=>r.amountDetail(t,e)?.remark,onDownloadPutDetail:(t,e)=>{const a=r.amountDetail(t,e),n=(a?.kol_ids??[]).join(",");window.open((0,zt.RD)(n,i.value?.start_date??0,i.value?.end_date??0))},onDownloadPitFeeDetail:t=>{window.open((0,zt.e2)(i.value?.id,t.company_id,2))},isYufengCompany:t=>t===zt.QN,formatAmountWithoutPrefix:v.FU};return{company_info:l,feeNameTypes:a,saveLoading:s,settlement:i,...r}}}),bn=hn,kn=(0,C.Z)(bn,gn,xn,!1,null,null,null),Cn=kn.exports,Sn=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-mcn-douyin-step2-after-container",attrs:{amount:t.total_amount_str},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount,taxed:t.DataForm.is_include_tax,type:"value1",tax_rate_disabled:!1,tax_rate:t.DataForm.tax_rate},on:{taxRateChanged:t.taxRateChanged,taxedChanged:t.taxedChanged,valueChange:t.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{staticClass:"cost-info",attrs:{padding:[0,20]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v(t._s(t.settlement.company_name))])]},proxy:!0}])},[[a("div",{staticClass:"amount-info-list"},t._l(t.feeNameTypes,(function(e,n){return a("div",{key:n},[t.amountDetail(e.type)?a("div",[a("div",{staticClass:"input-row mgt-16"},[a("span",{staticClass:"label"},[t._v(t._s(e.name))]),a("el-input",{staticStyle:{width:"240px",margin:"0 32px 0 12px"},attrs:{placeholder:"填写成本",value:t.income_amount(e.type),size:"small",disabled:8===e.type&&t.isYufengCompany},on:{input:function(a){return t.onIncomeAmountChanged(a,e.type)}}},[a("template",{slot:"append"},[t._v("元")])],2),1===e.type||8===e.type&&t.isYufengCompany?a("tg-button",{attrs:{type:"link"},on:{click:function(a){return t.downDetail(e.type)}}},[t._v("下载明细")]):t._e()],1),a("div",[t.remark(e.type)?a("el-input",{staticStyle:{width:"360px",height:"80px","margin-left":"68px","margin-top":"12px"},attrs:{value:t.remark(e.type),type:"textarea",placeholder:"请输入其他收入说明",maxlength:50,resize:"none"},on:{input:function(a){return t.remarkChanged(a,e.type)}}}):t._e()],1)]):t._e()])})),0)]],2)]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(t){t.preventDefault()}}},[a("TgAdjustAccountForm",{attrs:{adjust_info:t.DataForm.adjust_info},on:{DataChange:t.onAdjustAccountDataChange}})],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},wn=[],jn=(0,n.defineComponent)({components:{SettlementStep2Layout:Ya,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("settlement")??(0,n.ref)(void 0),i=(0,n.computed)((()=>{const t=[];return o.gf.forEach(((e,a)=>{t.push({type:a,name:e})})),t})),l=(0,n.ref)({adjust_info:s.value?.adjust_info??[],is_include_tax:void 0!==s.value?.is_include_tax&&null!==s.value?.is_include_tax?s.value.is_include_tax:1,tax_amount:s.value?.tax_amount?`${s.value.tax_amount}`:"",tax_rate:void 0===s.value?.tax_rate||null===s.value?.tax_rate?"0":`${s.value.tax_rate}`,tax_included_amount:s.value?.tax_included_amount?`${s.value.tax_included_amount}`:"",tax_excluded_amount:s.value?.tax_excluded_amount?`${s.value.tax_excluded_amount}`:"",amount_info_list:s.value?.json_data?.amount_info_list??[]}),r=(0,n.ref)((0,ct.I8)(l.value)),c=(0,n.computed)((()=>{let t=new(_())(0);return l.value.adjust_info?.forEach((e=>{let a=e.adjust_amount?e.adjust_amount:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),l.value.amount_info_list?.forEach((e=>{let a=e.amount?e.amount:0;a=isNaN(Number(a))?0:a,t=new(_())(a).add(t)})),t.toFixed(2)})),u=(0,n.computed)((()=>(0,v.SJ)(new(_())(c.value)))),d=(0,n.computed)((()=>s.value?.company_name===zt.QN)),m={prev:()=>{m.isModified()?m.saveSettlementDataRequest(o.GG.prev):e.emit("prev")},next:()=>{m.saveSettlementDataRequest()},isTypeIn:()=>!!l.value.adjust_info?.find((t=>t.adjust_amount||t.adjust_reason)),checkDataForSave:()=>{let t=!0,a="";return l.value.amount_info_list?.forEach((e=>{const n=!e.amount;if(n)switch(t=!1,e.type){case o.eY.put:a="请完善投放成本数据信息";break;case o.eY.talent_cost:a="请完善达人成本数据信息";break;case o.eY.pit_fee:a="请完善坑位费数据信息";break;case o.eY.shangguang:a="请完善商广成本数据信息";break;case o.eY.xingtu:a="请完善星图成本数据信息";break;case o.eY.other:a="请完善其他成本数据信息";break;default:break}})),t?l.value.adjust_info?.find((t=>isNaN(Number(t.adjust_amount))))?(e.root.$message.warning("请输入正确的调整金额"),!1):l.value.adjust_info?.find((t=>0===Number(t.adjust_amount)&&t.adjust_amount))?(e.root.$message.warning("调整金额不能为0"),!1):l.value.adjust_info?.find((t=>!t.adjust_amount&&t.adjust_reason||t.adjust_amount&&!t.adjust_reason))?(e.root.$message.warning("请完善手工调账信息"),!1):!(Number(c.value)<=0)||(e.root.$message.warning("总结算金额不能小于等于0"),!1):(e.root.$message.warning(a),!1)},taxRateChanged:t=>{l.value.tax_rate=t},taxedChanged:t=>{l.value.is_include_tax=t?1:0},taxValueChangeHandler:t=>{l.value.is_include_tax=0===t.is_include_tax?0:1,l.value.tax_included_amount=t.tax_included_amount?.toString()??"",l.value.tax_excluded_amount=t.tax_excluded_amount?.toString()??"",l.value.tax_amount=t.tax_amount?.toString()??""},onAdjustAccountDataChange:t=>{l.value.adjust_info=t},isModified:()=>{const t=JSON.stringify(r.value),e=JSON.stringify(l.value);return t!==e},confirmBeforeClose:async()=>m.isModified(),saveBeforeClose:()=>m.saveSettlementDataRequest(o.GG.close),saveSettlementDataRequest:async(t=o.GG.next)=>{if(t===o.GG.next){if(!m.checkDataForSave())return;if(!m.isModified()&&(0===s.value?.is_include_tax||1===s.value?.is_include_tax))return void e.emit("next")}const n={id:s.value?.id,step:t===o.GG.next?o.br.step_three:o.br.step_two,total_settle_amount:c.value,adjust_info:l.value.adjust_info?.filter((t=>t.adjust_amount||t.adjust_reason)),is_include_tax:l.value.is_include_tax,tax_amount:l.value.tax_amount,tax_rate:""===l.value.tax_rate?"0":l.value.tax_rate??"0",tax_included_amount:l.value.tax_included_amount,tax_excluded_amount:l.value.tax_excluded_amount,json_data:{amount_info_list:l.value.amount_info_list}};a.value=!0;const i=await(0,y.bp)(n,x.WD.mcn);if(a.value=!1,i.data.success){switch(t){case o.GG.next:e.emit("next",i.data.data),e.root.$message.success("保存成功");break;case o.GG.prev:e.emit("prev",i.data.data);break;default:e.root.$message.success("保存成功");break}return!0}return e.root.$message.error(i.data.message??"保存失败"),!1},amountDetail:t=>l.value.amount_info_list.find((e=>e.type===t)),downDetail:t=>{if(t===o.eY.pit_fee)window.open((0,zt.e2)(s.value?.id,s.value?.company_id,2));else if(t===o.eY.put){const e=m.amountDetail(t),a=(e?.kol_ids??[]).join(",");window.open((0,zt.RD)(a,s.value?.start_date??0,s.value?.end_date??0))}},income_amount:t=>m.amountDetail(t)?.amount,remark:t=>m.amountDetail(t)?.remark,file:t=>m.amountDetail(t)?.file,onIncomeAmountChanged:(t,e)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],n=m.amountDetail(e);n&&(n.amount=a)},remarkChanged:(t,e)=>{const a=m.amountDetail(e);a&&(a.remark=t)},formatAmountWithoutPrefix:v.FU};return(0,n.onMounted)((()=>{r.value=(0,ct.I8)(l.value)})),{feeNameTypes:i,saveLoading:a,DataForm:l,total_amount:c,settlement:s,total_amount_str:u,isYufengCompany:d,...m}}}),Dn=jn,Fn=(0,C.Z)(Dn,Sn,wn,!1,null,null,null),$n=Fn.exports,An=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"tg-cost-mcn-douyin-step3-after-container",class:1===t.settlement.is_estimate?"is_estimate":"",scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount.toString(),taxed:t.cloneSettlement.is_include_tax,name:t.cloneSettlement.company_name,name_desc:"供应商：",tax_rate:""+(t.cloneSettlement.tax_rate?t.cloneSettlement.tax_rate.toString():""),type:"value2",tax_rate_disabled:!0}})]},proxy:!0},{key:"left",fn:function(){return[a("card-layout",{attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[a("div",{staticClass:"settlement-step3-detail",staticStyle:{"margin-top":"18px"}},[t.DataForm.length>0?t._l(t.DataForm,(function(e,n){return a("div",{key:n,staticClass:"item"},[a("p",{staticClass:"label"},[t._v(" "+t._s(10===e.type?"CPS收入":11===e.type?"佣金":12===e.type?"佣金(服务费)":13===e.type?"技术服务费":t.settlementTypeFun(e.type))+"： ")]),a("div",{staticClass:"detail"},[a("div",{staticClass:"amount"},[a("p",{staticClass:"fee"},[t._v(" "+t._s(e.amount?t.formatAmount(e.amount,"None")+" 元":"--")+" ")]),1===e.type||8===e.type&&t.isYufengCompany?a("tg-button",{staticClass:"download",attrs:{type:"link"},on:{click:function(a){return t.downDetail(e.type)}}},[t._v("下载明细")]):t._e()],1),e.remark?a("p",{staticClass:"text"},[t._v(t._s(e.remark))]):t._e()])])})):a("div",{staticClass:"empty"},[a("empty-common",{attrs:{"detial-text":"暂无数据"}})],1)],2)])]},proxy:!0},{key:"right",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("手工调账")]},proxy:!0}])},[a("div",{staticClass:"adjust-info-content"},[a("div",{staticClass:"adjust-info-total"},[a("div",{staticClass:"adjust-info-total-lbl"},[t._v("调账 "+t._s(t.adjust_info.length)+" 笔")]),a("div",{staticClass:"adjust-info-total-amount"},[a("strong",[t._v("共 "+t._s(t.adjust_info_amount_total)+" 元")])])]),a("div",{staticClass:"adjust-info-line"}),a("div",{staticClass:"adjust-info-list"},[t._l(t.adjust_info,(function(e,n){return[a("div",{key:n,staticClass:"adjust-info-item"},[a("span",[t._v(t._s(n+1)+". ")]),a("span",[t._v("调整金额：")]),a("span",[t._v(t._s(e.adjust_amount)+" 元")]),a("span",[t._v("；调整原因：")]),a("span",[t._v(t._s(e.adjust_reason))])])]}))],2)])])]},proxy:!0},1!==t.settlement.is_estimate?{key:"files",fn:function(){return[a("div",{staticClass:"upload-form"},[t.readonly?t._e():a("div",{staticClass:"upload-box"},[a("p",{staticClass:"upload-title",staticStyle:{color:"#6a7b92",width:"70px","text-align":"right"}},[a("span",{staticClass:"star"},[t._v("*")]),t._v("结算单： ")]),a("tg-upload",{attrs:{action:"/api/resources/upload_file",data:{type:"settlement"},beforeUpload:t.beforeUpload,success:t.successHandle,disabled:t.isFileUploaderDisabled,"show-file-list":!1}},[a("tg-button",{attrs:{size:"medium",icon:"ico-btn-upload",disabled:t.isFileUploaderDisabled}},[t._v("上传文件")])],1),a("span",{staticClass:"file-tips"},[t._v(" 支持 .docx .pdf .jpg .png .xlsx, 最多上传5个文件(单个文件大小不超过30M) ")])],1),t.settlementFiles&&t.settlementFiles.length>0?a("div",{staticClass:"file-list-box"},[t.readonly?a("div",{staticStyle:{width:"100%","min-height":"20px"},style:{height:26*t.settlementFiles.length+"px"}},[t.settlementFiles&&t.settlementFiles.length>0?a("div",{staticClass:"settlement-uploaded-lbl",staticStyle:{float:"left",color:"#6a7b92","text-align":"right"}},[t._v(" 结算单： ")]):t._e(),a("Appendix",{staticStyle:{width:"680px",float:"left"},attrs:{list:t.settlementFiles}})],1):a("upload-file-list",{staticStyle:{"line-height":"25px","padding-left":"68px"},model:{value:t.settlementFiles,callback:function(e){t.settlementFiles=e},expression:"settlementFiles"}})],1):t._e(),a("el-form",{staticStyle:{"margin-top":"15px",width:"100%"},style:{marginTop:t.readonly?"5px":"15px"}},[a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"关联合同："}},[t.readonly?a("div",{staticStyle:{display:"flex","align-items":"center",color:"#3c5269"}},[t.cooperation_link_contract_ID&&t.contract_info.sign_type_name?a("div",[t._v(" "+t._s(t.contract_info.sign_type_name+": "+t.contract_info.contract_uid+" ("+t.contract_info.coop_start_date+"-"+t.contract_info.coop_end_date+")")+" ")]):a("div",[t._v("--")])]):a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:t.readonly?"--":"请输入合同编码","remote-method":t.getContract,size:"medium",disabled:t.readonly},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.cooperation_link_contract_ID,callback:function(e){t.cooperation_link_contract_ID=e},expression:"cooperation_link_contract_ID"}},t._l(t.contract_uids,(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.sign_type_name+":  "+t.contract_uid+"  ("+t.coop_start_date+"-"+t.coop_end_date+")",value:t.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:null,t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},In=[],Ln=a(79703),Nn=a(11676),Tn=(0,n.defineComponent)({name:"Step3MCNDouYinAfter",components:{CardLayout:$.Z,SettlementStep3Layout:G.Z,TgAdjustAccountForm:A.Z,TopCard:N.Z,Appendix:Ln.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("settlement")??(0,n.ref)(void 0),i=(0,n.computed)((()=>{const t=(0,ct.I8)(s.value);return t})),r=(0,n.ref)(i.value?.settlement_files??[]),c=(0,n.ref)([...r.value]),u=(0,n.ref)(void 0),d=(0,n.ref)({contract_uid:void 0,coop_start_date:void 0,coop_end_date:void 0,sign_type_name:void 0}),m=(0,n.computed)((()=>(s.value?.adjust_info??[]).map((t=>({adjust_amount:(0,v.SJ)(new(_())(t.adjust_amount)),adjust_reason:t.adjust_reason}))))),p=(0,n.computed)((()=>{const t=(s.value?.adjust_info??[]).reduce(((t,e)=>_().add(t,new(_())(e.adjust_amount))),new(_())(0));return(0,v.SJ)(t)})),f=(0,n.computed)((()=>s.value?.json_data?.amount_info_list??[])),g={amountDetail:t=>f.value.find((e=>e.type===t)),downDetail:t=>{if(t===o.eY.pit_fee)window.open((0,zt.e2)(s.value?.id,s.value?.company_id,2));else if(t===o.eY.put){const e=g.amountDetail(t),a=(e?.kol_ids??[]).join(",");window.open((0,zt.RD)(a,s.value?.start_date??0,s.value?.end_date??0))}},prev:()=>{g.isModified()?g.saveSettlementDataRequest(!1):e.emit("prev")},next:async()=>{if(0===s.value?.is_estimate&&!r.value.length)return void e.root.$message.warning("请上传结算单扫描件");const t=await(0,J.I)(e,{title:"确定提交结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,n.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});t&&g.submitSettlementDataRequest()},isModified:()=>{const t=JSON.stringify(c.value),e=JSON.stringify(r.value);return u.value!==A.value||t!==e},confirmBeforeClose:async()=>g.isModified(),saveBeforeClose:()=>g.saveSettlementDataRequest(!0),fillForm:t=>{if(t){r.value=t.settlement_files?[...t.settlement_files]:[];const e=t.contract_id?t.contract_id:void 0;A.value=e,u.value=e,d.value.contract_uid=t.contract_uid||void 0,d.value.sign_type_name=t.sign_type_name||void 0,d.value.coop_start_date=t.coop_start_date||void 0,d.value.coop_end_date=t.coop_end_date||void 0}},formatAmount:t=>(0,v.dN)(t,"None"),saveSettlementDataRequest:async t=>{if(!i.value?.id)return;const n={id:i.value?.id,contract_id:A.value||0,step:o.br.step_three,settlement_files:r.value};a.value=!0;const s=await(0,y.Ys)(n,x.WD.mcn);return a.value=!1,s.data.success?(t?e.root.$message.success(s.data.message??"保存成功"):e.emit("prev",s.data.data),!0):(e.root.$message.error(s.data.message??"保存失败"),!1)},submitSettlementDataRequest:async()=>{if(!i.value?.id)return;if(0===s.value?.is_estimate&&!r.value.length)return void e.root.$message.warning("请上传结算单扫描件");const t={id:i.value?.id,contract_id:A.value||0};0===s.value?.is_estimate&&(t.settlement_files=r.value),a.value=!0;const n=await(0,y.FX)(t);a.value=!1,n.data.success?(e.root.$message.success(n.data.message??"提交结算成功"),e.emit("submit:success")):e.root.$message.error(n.data.message??"提交失败")}},h=(0,n.computed)((()=>r.value.length>=5)),b=t=>(0,Nn.K)({pdf:!0,image:!0,excel:!0,doc:!0,fileSize:30})(t),k=t=>{r.value.push(t.data.source)},C=(0,n.computed)((()=>{const t=[];return o.gf.forEach(((e,a)=>{t.push({label:e,value:a})})),t})),S=(0,n.computed)((()=>{const t=[];return o.gf.forEach(((e,a)=>{t.push(a)})),t}));f.value.sort(((t,e)=>C.value.indexOf(t.type)-S.value.indexOf(e.type)));const w=t=>{for(let e=0;e<C.value.length;e++)if(C.value[e].value===t)return C.value[e].label},j=(0,n.computed)((()=>s.value?.company_name===zt.QN));(0,n.onMounted)((()=>{c.value=(0,ct.I8)(r.value)}));const D=(0,n.ref)([]),{project_id:F}=(0,l.L)(e),$=async t=>{const e=await(0,q.z0)({search:t,only_main:0,project_id:F.value,contract_status:2,partner_type:2,exclude_sign_types:-3});e.data.success?D.value=e.data.data.data:D.value=[]};!1===t.readonly&&$("");const A=(0,n.ref)(void 0),I=t=>{A.value=t};return{contract_info:d,contract_uids:D,getContract:$,cooperation_link_contract_ID:A,selectContractUidChange:I,saveLoading:a,settlement:s,cloneSettlement:i,isYufengCompany:j,costOptions:C,settlementFiles:r,settlementTypeFun:w,DataForm:f,adjust_info:m,adjust_info_amount_total:p,beforeUpload:b,successHandle:k,isFileUploaderDisabled:h,...g}}}),zn=Tn,Bn=(0,C.Z)(zn,An,In,!1,null,"c66ec194",null),Pn=Bn.exports,On=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep2Layout",{staticClass:"tg-cost-s2b2c-douyin-step2-after-container",attrs:{amount:t.total_amount_str,douyinS2b2cSelf:!0},scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:t.total_amount+"",taxed:t.DataForm.is_include_tax,type:"value1",tax_rate_disabled:!1,tax_rate:t.DataForm.tax_rate},on:{taxRateChanged:t.taxRateChanged,taxedChanged:t.taxedChanged,valueChange:t.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{staticClass:"cost-info",attrs:{padding:[0,20]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[[a("div",{staticClass:"amount-info-list"},[a("div",{staticClass:"company"},[a("span",{staticClass:"label"},[t._v("达人：")]),a("b",{staticClass:"liver"},[t._v(t._s(t.dataJson.kol_name))]),a("span",{staticClass:"company-name"},[t._v(t._s(t.dataJson.company_name))]),a("tg-icon",{staticClass:"edit",attrs:{name:"ico-icon_bianji"},on:{click:function(e){return t.dialogCompany.show()}}})],1),a("div",{staticClass:"fee-description"},[t._v("达人收入")]),a("div",{staticClass:"kol-form"},[a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("机构佣金：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(t.dataJson.institution_commission_amount))+"元")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("退货率：")]),a("span",{staticClass:"value"},[t._v(t._s(null===t.dataJson.refund_rate?"--":t.dataJson.refund_rate+"%"))])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("达人分成比例：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(t.dataJson.kol_divide))+"%")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("达人佣金：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(t.dataJson.commission_amount))+"元")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("其他收入：")]),a("el-input",{staticStyle:{width:"166px"},attrs:{size:"small",placeholder:"请输入金额"},on:{input:function(e){return t.getIncomeAmountNumber(e)}},model:{value:t.dataJson.other_income_amount,callback:function(e){t.$set(t.dataJson,"other_income_amount",e)},expression:"dataJson.other_income_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[t._v("元")])])],1),a("div",{staticClass:"form-item",staticStyle:{display:"flex","justify-content":"flex-start"}},[a("span",{staticClass:"label"},[t._v("账单文件：")]),a("div",{staticClass:"down-file",staticStyle:{"line-height":"24px"}},[a("tg-icon",{staticClass:"icon",attrs:{name:"ico-excel"}}),a("div",{staticClass:"name"},[t._v(t._s(t.fileName))]),a("tg-icon",{staticClass:"down-icon",attrs:{name:"ico-xiazai"},on:{click:function(e){return t.downFile(t.dataJson.file)}}})],1)])]),a("div",{staticClass:"fee-description"},[t._v("扣除项")]),a("div",{staticClass:"kol-form"},t._l(t.dataJson.kol_cost_share,(function(e,n){return a("div",{key:e.expense_type_name+n,staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v(t._s(e.expense_type_name)+"：")]),a("el-input",{staticStyle:{width:"166px"},attrs:{size:"small",maxlength:"13",placeholder:"请输入金额"},on:{input:function(e){return t.getAdjustAmountNumber(e,n)}},model:{value:e.amount,callback:function(a){t.$set(e,"amount",a)},expression:"item.amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[t._v("元")])])],1)})),0),a("div",{staticClass:"fee-description"},[t._v("扣税调整")]),a("div",{staticClass:"kol-form",staticStyle:{"margin-bottom":"32px"}},[a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("发票税率：")]),a("span",{staticClass:"value"},[t._v(t._s(t.dataJson.invoice_tax_rate)+"%")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("调整金额：")]),a("span",{staticClass:"value"},[t._v(t._s(t.adjustmentAmount)+"元")])])])])],a("el-dialog",{staticClass:"tg-dialog-classic el-dialog-center-rewrite",attrs:{width:"300px",visible:t.dialogCompany.visible,"append-to-body":!0,"close-on-click-modal":!1,"close-on-press-escape":!1,wrapperClosable:!1,title:"更换公司"},on:{close:t.dialogCompany.close}},[a("el-form",{attrs:{size:"small","label-width":"76px",model:t.dialogCompany.form}},[a("div",{staticClass:"dialog_change_company"},[a("el-form-item",{attrs:{label:"选择公司"}},[a("el-select",{staticStyle:{"margin-left":"12px"},attrs:{filterable:"",remote:"","remote-method":t.dialogCompany.remoteMethod,placeholder:"请输入公司名"},model:{value:t.dialogCompany.form.company,callback:function(e){t.$set(t.dialogCompany.form,"company",e)},expression:"dialogCompany.form.company"}},t._l(t.dialogCompany.options,(function(t){return a("el-option",{key:t.id,attrs:{label:t.company_name,value:t.id}})})),1)],1)],1)]),a("template",{staticStyle:{height:"50px"},slot:"footer"},[a("tg-button",{attrs:{size:"small"},on:{click:t.dialogCompany.close}},[t._v(" 取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:t.dialogCompany.submit}},[t._v(" 确定 ")])],1)],2)],2)]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(t){t.preventDefault()}}},[a("TgAdjustAccountForm",{attrs:{adjust_info:t.DataForm.adjust_info},on:{DataChange:t.onAdjustAccountDataChange}})],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},Rn=[],Mn=(0,n.defineComponent)({components:{SettlementStep2Layout:Ya,TgAdjustAccountForm:A.Z,CardLayout:$.Z,TopCard:N.Z},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("settlement")??(0,n.ref)(void 0),i=(0,n.computed)((()=>{const t=[];return o.gf.forEach(((e,a)=>{t.push({type:a,name:e})})),t})),l=(0,n.ref)({adjust_info:s.value?.adjust_info??[],is_include_tax:void 0!==s.value?.is_include_tax&&null!==s.value?.is_include_tax?s.value.is_include_tax:1,tax_amount:s.value?.tax_amount?`${s.value.tax_amount}`:"",tax_rate:void 0===s.value?.tax_rate||null===s.value?.tax_rate?"0":`${s.value.tax_rate}`,tax_included_amount:s.value?.tax_included_amount?`${s.value.tax_included_amount}`:"",tax_excluded_amount:s.value?.tax_excluded_amount?`${s.value.tax_excluded_amount}`:"",amount_info_list:s.value?.json_data?.amount_info_list??[]}),r=(0,n.computed)((()=>l.value.amount_info_list[0])),c=(0,n.computed)((()=>{const t=r.value.file;return t.split("/").pop()})),u=(0,n.ref)((0,ct.I8)(l.value)),d=(0,n.computed)((()=>(0,v.SJ)(new(_())(f.value)))),m=(0,n.computed)((()=>s.value?.company_name===zt.QN)),p=(0,n.computed)((()=>{const t=r.value.kol_cost_share.map((t=>1*t.amount)),e=t.reduce(((t,e)=>t+e),0),a=l.value.adjust_info.map((t=>1*t.adjust_amount)),n=a.reduce(((t,e)=>t+e),0),o=1*r.value.commission_amount+1*r.value.other_income_amount,s=o-e+n;return r.value.invoice_enable?Math.round(100*(s-s/1.06*(1+r.value.invoice_tax_rate/100)+Number.EPSILON))/100:1===r.value.invoice_platform?Math.round(100*(s-s/1.06+Number.EPSILON))/100:2===r.value.invoice_platform?Math.round(100*(s-s/1.06*.75+Number.EPSILON))/100:0})),f=(0,n.computed)((()=>{const t=r.value.kol_cost_share.map((t=>1*t.amount)),e=t.reduce(((t,e)=>t+e),0),a=l.value.adjust_info.map((t=>1*t.adjust_amount)),n=a.reduce(((t,e)=>t+e),0),o=1*r.value.commission_amount+1*r.value.other_income_amount,s=o-e+n;return Math.round(100*(s-p.value+Number.EPSILON))/100})),g=t=>(/-?(?:(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?)?/u.exec(t.replace(/[^-.\d]+/gu,"").replace(I.Pj,""))??[""])[0],h=(t,e)=>{const a=g(t),n=l.value.amount_info_list[0];n.kol_cost_share[e].amount=a},b=t=>{const e=g(t),a=l.value.amount_info_list[0];a.other_income_amount=e},k=(0,n.reactive)({form:{},options:[],visible:!1,company:{},salary_info:{},companyIndex:0,salary_index:0,show(){const t={company_name:r.value.company_name,company_id:r.value.company_id,kol_salary_infos:[]};k.company=t,k.options=[{id:t.company_id,company_name:t.company_name}],k.visible=!0},submit(){const t=k.form,e=k.options.find((e=>e.id===t.company));l.value.amount_info_list[0].company_name=e.company_name,l.value.amount_info_list[0].company_id=e.company,k.visible=!1},close:()=>{k.visible=!1},remoteMethod:t=>{""!==t?(0,ut.K)(t,1).then((t=>{k.options=t})):k.options=[]}}),C={prev:()=>{C.isModified()?C.saveSettlementDataRequest(o.GG.prev):e.emit("prev")},next:()=>{C.saveSettlementDataRequest()},isTypeIn:()=>!!l.value.adjust_info?.find((t=>t.adjust_amount||t.adjust_reason)),checkDataForSave:()=>{let t=!0,a="";return l.value.amount_info_list?.forEach((e=>{const n=!e.amount;if(n)switch(t=!1,e.type){case o.eY.put:a="请完善投放成本数据信息";break;case o.eY.talent_cost:a="请完善达人成本数据信息";break;case o.eY.pit_fee:a="请完善坑位费数据信息";break;case o.eY.shangguang:a="请完善商广成本数据信息";break;case o.eY.xingtu:a="请完善星图成本数据信息";break;case o.eY.other:a="请完善其他成本数据信息";break;default:break}})),t?l.value.adjust_info?.find((t=>isNaN(Number(t.adjust_amount))))?(e.root.$message.warning("请输入正确的调整金额"),!1):l.value.adjust_info?.find((t=>0===Number(t.adjust_amount)&&t.adjust_amount))?(e.root.$message.warning("调整金额不能为0"),!1):l.value.adjust_info?.find((t=>!t.adjust_amount&&t.adjust_reason||t.adjust_amount&&!t.adjust_reason))?(e.root.$message.warning("请完善手工调账信息"),!1):!(Number(f.value)<=0)||(e.root.$message.warning("总结算金额不能小于等于0"),!1):(e.root.$message.warning(a),!1)},taxRateChanged:t=>{l.value.tax_rate=t},taxedChanged:t=>{l.value.is_include_tax=t?1:0},taxValueChangeHandler:t=>{l.value.is_include_tax=0===t.is_include_tax?0:1,l.value.tax_included_amount=t.tax_included_amount?.toString()??"",l.value.tax_excluded_amount=t.tax_excluded_amount?.toString()??"",l.value.tax_amount=t.tax_amount?.toString()??""},onAdjustAccountDataChange:t=>{l.value.adjust_info=t},isModified:()=>{const t=JSON.stringify(u.value),e=JSON.stringify(l.value);return t!==e},confirmBeforeClose:async()=>C.isModified(),saveBeforeClose:()=>C.saveSettlementDataRequest(o.GG.close),saveSettlementDataRequest:async(t=o.GG.next)=>{if(l.value.amount_info_list[0].tax_balance=p.value,t===o.GG.next&&!C.isModified()&&(0===s.value?.is_include_tax||1===s.value?.is_include_tax))return void e.emit("next");const n={id:s.value?.id,step:t===o.GG.next?o.br.step_three:o.br.step_two,total_settle_amount:f.value,adjust_info:l.value.adjust_info?.filter((t=>t.adjust_amount||t.adjust_reason)),is_include_tax:l.value.is_include_tax,tax_amount:l.value.tax_amount,tax_rate:""===l.value.tax_rate?"0":l.value.tax_rate??"0",tax_included_amount:l.value.tax_included_amount,tax_excluded_amount:l.value.tax_excluded_amount,json_data:{amount_info_list:l.value.amount_info_list}};if(n.tax_included_amount<0)return void H.Message.error("总结算金额不能小于0");a.value=!0;const i=await(0,y.bp)(n,x.WD.mcn);if(a.value=!1,i.data.success){switch(t){case o.GG.next:e.emit("next",i.data.data),e.root.$message.success("保存成功");break;case o.GG.prev:e.emit("prev",i.data.data);break;default:e.root.$message.success("保存成功");break}return!0}return e.root.$message.error(i.data.message??"保存失败"),!1},amountDetail:t=>l.value.amount_info_list.find((e=>e.type===t)),income_amount:t=>C.amountDetail(t)?.amount,remark:t=>C.amountDetail(t)?.remark,file:t=>C.amountDetail(t)?.file,onIncomeAmountChanged:(t,e)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(t.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],n=C.amountDetail(e);n&&(n.amount=a)},remarkChanged:(t,e)=>{const a=C.amountDetail(e);a&&(a.remark=t)},formatAmountWithoutPrefix:v.FU,getAdjustAmountNumber:h},S=t=>{window.open(t+`?Authorization=${(0,rt.LP)()}`)};return(0,n.onMounted)((()=>{u.value=(0,ct.I8)(l.value)})),{feeNameTypes:i,saveLoading:a,DataForm:l,dataJson:r,fileName:c,downFile:S,getIncomeAmountNumber:b,adjustmentAmount:p,dialogCompany:k,total_amount:f,settlement:s,total_amount_str:d,isYufengCompany:m,...C}}}),Zn=Mn,Gn=(0,C.Z)(Zn,On,Rn,!1,null,null,null),En=Gn.exports,Jn=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("SettlementStep3Layout",{staticClass:"tg-cost-s2b2c-douyin-step3-after-container",scopedSlots:t._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+t.settlement.total_settle_amount.toString(),taxed:t.cloneSettlement.is_include_tax,name:t.cloneSettlement.company_name,name_desc:"供应商：",tax_rate:""+(t.cloneSettlement.tax_rate?t.cloneSettlement.tax_rate.toString():""),type:"value2",tax_rate_disabled:!0}})]},proxy:!0},{key:"left",fn:function(){return[a("card-layout",{staticClass:"cost-info",attrs:{padding:[0]},scopedSlots:t._u([{key:"title",fn:function(){return[a("span",[t._v("成本信息")])]},proxy:!0}])},[a("div",{staticClass:"settlement-step3-detail"},[t.DataForm.length>0?t._l(t.DataForm,(function(e,n){return a("div",{key:n,staticClass:"item"},[a("div",{staticClass:"amount-info-list"},[a("div",{staticClass:"company"},[a("span",{staticClass:"label"},[t._v("达人：")]),a("b",{staticClass:"liver"},[t._v(t._s(e.kol_name))])]),a("div",{staticClass:"fee-description"},[t._v("达人收入")]),a("div",{staticClass:"kol-form"},[a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("机构佣金：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(e.institution_commission_amount))+"元")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("退货率：")]),a("span",{staticClass:"value"},[t._v(t._s(null===e.refund_rate?"--":e.refund_rate+"%"))])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("达人分成比例：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(e.kol_divide))+"%")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("达人佣金：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(e.commission_amount))+"元")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("其他收入：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(e.other_income_amount))+"元")])])]),a("div",{staticClass:"fee-description"},[t._v("扣除项")]),a("div",{staticClass:"kol-form"},t._l(e.kol_cost_share,(function(e,n){return a("div",{key:e.expense_type_name+n,staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v(t._s(e.expense_type_name)+"：")]),a("span",{staticClass:"value"},[t._v(t._s(t.formatAmountWithoutPrefix(e.amount))+"元")])])})),0),a("div",{staticClass:"fee-description"},[t._v("扣税调整")]),a("div",{staticClass:"kol-form",staticStyle:{"margin-bottom":"32px"}},[a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("发票税率：")]),a("span",{staticClass:"value"},[t._v(t._s(e.invoice_tax_rate)+"%")])]),a("div",{staticClass:"form-item"},[a("span",{staticClass:"label"},[t._v("调整金额：")]),a("span",{staticClass:"value"},[t._v(t._s(e.tax_balance)+"元")])])]),t.settlement.order_file?[a("div",{staticClass:"fee-description"},[t._v("订单明细")]),a("div",{staticStyle:{display:"flex","padding-left":"30px"}},[a("Appendix",{staticStyle:{flex:"1"},attrs:{list:[t.settlement.order_file]}})],1)]:t._e()],2)])})):a("div",{staticClass:"empty"},[a("empty-common",{attrs:{"detial-text":"暂无数据"}})],1)],2)])]},proxy:!0},{key:"right",fn:function(){return[a("CardLayout",{scopedSlots:t._u([{key:"title",fn:function(){return[t._v("手工调账")]},proxy:!0}])},[a("div",{staticClass:"adjust-info-content"},[a("div",{staticClass:"adjust-info-total"},[a("div",{staticClass:"adjust-info-total-lbl"},[t._v("调账 "+t._s(t.adjust_info.length)+" 笔")]),a("div",{staticClass:"adjust-info-total-amount"},[a("strong",[t._v("共 "+t._s(t.adjust_info_amount_total)+" 元")])])]),a("div",{staticClass:"adjust-info-line"}),a("div",{staticClass:"adjust-info-list"},[t._l(t.adjust_info,(function(e,n){return[a("div",{key:n,staticClass:"adjust-info-item"},[a("span",[t._v(t._s(n+1)+". ")]),a("span",[t._v("调整金额：")]),a("span",[t._v(t._s(e.adjust_amount)+" 元")]),a("span",[t._v("；调整原因：")]),a("span",[t._v(t._s(e.adjust_reason))])])]}))],2)])])]},proxy:!0},{key:"files",fn:function(){return[a("div",{staticClass:"upload-form"},[t.readonly?t._e():a("div",{staticClass:"upload-box"},[a("p",{staticClass:"upload-title",staticStyle:{color:"#6a7b92",width:"70px","text-align":"right"}},[a("span",{staticClass:"star"},[t._v("*")]),t._v("结算单： ")]),a("tg-upload",{attrs:{action:"/api/resources/upload_file",data:{type:"settlement"},beforeUpload:t.beforeUpload,success:t.successHandle,disabled:t.isFileUploaderDisabled,"show-file-list":!1}},[a("tg-button",{attrs:{size:"medium",icon:"ico-btn-upload",disabled:t.isFileUploaderDisabled}},[t._v("上传文件")])],1),a("span",{staticClass:"file-tips"},[t._v(" 支持 .docx .pdf .jpg .png .xlsx .csv, 最多上传5个文件(单个文件大小不超过150M) ")])],1),t.settlementFiles&&t.settlementFiles.length>0?a("div",{staticClass:"file-list-box"},[t.readonly?a("div",{staticStyle:{width:"100%","min-height":"20px"},style:{height:26*t.settlementFiles.length+"px"}},[t.settlementFiles&&t.settlementFiles.length>0?a("div",{staticClass:"settlement-uploaded-lbl",staticStyle:{float:"left",color:"#6a7b92","text-align":"right"}},[t._v(" 结算单： ")]):t._e(),a("Appendix",{staticStyle:{width:"680px",float:"left"},attrs:{list:t.settlementFiles}})],1):a("upload-file-list",{staticStyle:{"line-height":"25px","padding-left":"68px"},model:{value:t.settlementFiles,callback:function(e){t.settlementFiles=e},expression:"settlementFiles"}})],1):t._e(),a("el-form",{staticStyle:{"margin-top":"15px",width:"100%"},style:{marginTop:t.readonly?"5px":"15px"}},[a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"关联合同："}},[t.readonly?a("div",{staticStyle:{display:"flex","align-items":"center",color:"#3c5269"}},[t.cooperation_link_contract_ID&&t.contract_info.sign_type_name?a("div",[t._v(" "+t._s(t.contract_info.sign_type_name+": "+t.contract_info.contract_uid+" ("+t.contract_info.coop_start_date+"-"+t.contract_info.coop_end_date+")")+" ")]):a("div",[t._v("--")])]):a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:t.readonly?"--":"请输入合同编码","remote-method":t.getContract,size:"medium",disabled:t.readonly},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.cooperation_link_contract_ID,callback:function(e){t.cooperation_link_contract_ID=e},expression:"cooperation_link_contract_ID"}},t._l(t.contract_uids,(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.sign_type_name+":  "+t.contract_uid+"  ("+t.coop_start_date+"-"+t.coop_end_date+")",value:t.contract_id}})})),1)],1)])],1)],1)]},proxy:!0},t.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:t.prev}},[t._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.next}},[t._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:t.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},Yn=[],Hn=(0,n.defineComponent)({name:"Step3MCNDouYinAfter",components:{CardLayout:$.Z,SettlementStep3Layout:G.Z,TgAdjustAccountForm:A.Z,TopCard:N.Z,Appendix:Ln.Z},props:{readonly:{type:Boolean,default:!1}},setup(t,e){const a=(0,n.ref)(!1),s=(0,n.inject)("settlement")??(0,n.ref)(void 0),i=(0,n.computed)((()=>{const t=(0,ct.I8)(s.value);return t})),r=(0,n.ref)(i.value?.settlement_files??[]),c=(0,n.ref)([...r.value]),u=(0,n.ref)(void 0),d=(0,n.ref)({contract_uid:void 0,coop_start_date:void 0,coop_end_date:void 0,sign_type_name:void 0}),m=(0,n.computed)((()=>(s.value?.adjust_info??[]).map((t=>({adjust_amount:(0,v.SJ)(new(_())(t.adjust_amount)),adjust_reason:t.adjust_reason}))))),p=(0,n.computed)((()=>{const t=(s.value?.adjust_info??[]).reduce(((t,e)=>_().add(t,new(_())(e.adjust_amount))),new(_())(0));return(0,v.SJ)(t)})),f=(0,n.computed)((()=>s.value?.json_data?.amount_info_list??[])),g={amountDetail:t=>f.value.find((e=>e.type===t)),downDetail:t=>{if(t===o.eY.pit_fee)window.open((0,zt.e2)(s.value?.id,s.value?.company_id,2));else if(t===o.eY.put){const e=g.amountDetail(t),a=(e?.kol_ids??[]).join(",");window.open((0,zt.RD)(a,s.value?.start_date??0,s.value?.end_date??0))}},prev:()=>{g.isModified()?g.saveSettlementDataRequest(!1):e.emit("prev")},next:async()=>{if(0===s.value?.is_estimate&&!r.value.length)return void e.root.$message.warning("请上传结算单扫描件");const t=await(0,J.I)(e,{title:"确定提交结算单吗?",content:()=>(0,n.h)("div",[(0,n.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,n.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});t&&g.submitSettlementDataRequest()},isModified:()=>{const t=JSON.stringify(c.value),e=JSON.stringify(r.value);return u.value!==A.value||t!==e},confirmBeforeClose:async()=>g.isModified(),saveBeforeClose:()=>g.saveSettlementDataRequest(!0),fillForm:t=>{if(t){r.value=t.settlement_files?[...t.settlement_files]:[];const e=t.contract_id?t.contract_id:void 0;A.value=e,u.value=e,d.value.contract_uid=t.contract_uid||void 0,d.value.sign_type_name=t.sign_type_name||void 0,d.value.coop_start_date=t.coop_start_date||void 0,d.value.coop_end_date=t.coop_end_date||void 0}},formatAmount:t=>(0,v.dN)(t,"None"),saveSettlementDataRequest:async t=>{if(!i.value?.id)return;const n={id:i.value?.id,contract_id:A.value||0,step:o.br.step_three,settlement_files:r.value};a.value=!0;const s=await(0,y.Ys)(n,x.WD.mcn);return a.value=!1,s.data.success?(t?e.root.$message.success(s.data.message??"保存成功"):e.emit("prev",s.data.data),!0):(e.root.$message.error(s.data.message??"保存失败"),!1)},submitSettlementDataRequest:async()=>{if(!i.value?.id)return;if(0===s.value?.is_estimate&&!r.value.length)return void e.root.$message.warning("请上传结算单扫描件");const t={id:i.value?.id,contract_id:A.value||0};0===s.value?.is_estimate&&(t.settlement_files=r.value),a.value=!0;const n=await(0,y.FX)(t);a.value=!1,n.data.success?(e.root.$message.success(n.data.message??"提交结算成功"),e.emit("submit:success")):e.root.$message.error(n.data.message??"提交失败")}},h=(0,n.computed)((()=>r.value.length>=5)),b=t=>(0,Nn.K)({pdf:!0,image:!0,excel:!0,doc:!0,fileSize:150,csv:!0})(t),k=t=>{r.value.push(t.data.source)},C=(0,n.computed)((()=>{const t=[];return o.gf.forEach(((e,a)=>{t.push({label:e,value:a})})),t})),S=(0,n.computed)((()=>{const t=[];return o.gf.forEach(((e,a)=>{t.push(a)})),t}));f.value.sort(((t,e)=>C.value.indexOf(t.type)-S.value.indexOf(e.type)));const w=t=>{for(let e=0;e<C.value.length;e++)if(C.value[e].value===t)return C.value[e].label},j=(0,n.computed)((()=>s.value?.company_name===zt.QN));(0,n.onMounted)((()=>{c.value=(0,ct.I8)(r.value)}));const D=(0,n.ref)([]),{project_id:F}=(0,l.L)(e),$=async t=>{const e=await(0,q.z0)({search:t,only_main:0,project_id:F.value,contract_status:2,partner_type:2,exclude_sign_types:-3});e.data.success?D.value=e.data.data.data:D.value=[]};!1===t.readonly&&$("");const A=(0,n.ref)(void 0),I=t=>{A.value=t};return{contract_info:d,contract_uids:D,getContract:$,cooperation_link_contract_ID:A,selectContractUidChange:I,formatAmountWithoutPrefix:v.FU,saveLoading:a,settlement:s,cloneSettlement:i,isYufengCompany:j,costOptions:C,settlementFiles:r,settlementTypeFun:w,DataForm:f,adjust_info:m,adjust_info_amount_total:p,beforeUpload:b,successHandle:k,isFileUploaderDisabled:h,...g}}}),qn=Hn,Un=(0,C.Z)(qn,Jn,Yn,!1,null,null,null),Kn=Un.exports,Wn=a(22895),Vn=(0,n.defineComponent)({name:"TgSettlementDialog",components:{Step1:w,Step2Marketing:R,Step3Marketing:V,Step2ShopLiveBefore:xt,Step3ShopLiveBefore:_e,Step2ShopLiveAfter:je,Step3ShopLiveAfter:Ue,Step2MCNTaoBaoBefore:ca,Step3MCNTaoBaoBefore:fa,Step2MCNVTaskBefore:za,Step3MCNVTaskBefore:Za,Step2MCNTaoBaoAfter:ka,Step3MCNTaoBaoAfter:$a,Step2MCNVTaskAfter:Qa,Step3MCNVTaskAfter:un,Step2DouyinBefore:yn,Step3DouyinBefore:Cn,Step2DouyinAfter:$n,Step2S2b2bCost:En,Step2S2b2bCostStep:Kn,Step3DouyinAfter:Pn,Step2DouyinLiveBefore:te,Step3DouyinShopLiveBefore:le,Step2DouyinShopLiveAfter:Oe,Step3DouyinShopLiveAfter:na},setup(t,e){const a=(0,n.inject)("project3in1")??(0,n.ref)(void 0),{project_type:s}=(0,l.L)(e),i=(0,n.ref)(!1),r=(t=!1)=>{i.value=t},c=()=>{r(!i.value)},{project_id:u,isFromMarketing:d,isFromLive:m,isFromCommon:p}=(0,l.L)(e),_=(0,n.ref)(void 0);(0,n.provide)("settlement",_);const v=()=>{C()},f=(0,n.ref)(0),g=(0,n.ref)(0),x=(t,a)=>{C(t),r(!0),b.value=1===a?1:0,e.root.$nextTick((()=>{void 0===t?(D.value=0,f.value++):(D.value=t.step,g.value++)}))},h=(t=!1)=>{e.emit("close"),void 0!==_.value&&t&&e.emit("update",_.value),v(),r()},b=(0,n.ref)(0),k=(0,n.ref)(null),C=t=>{D.value=0,_.value=void 0===t?void 0:{...t}};(0,n.watch)((()=>f.value),((t,a)=>{t!==a&&e.root.$nextTick((()=>{k.value?.fillForm?.(_.value,b.value)}))})),(0,n.watch)((()=>g.value),((t,a)=>{t!==a&&e.root.$nextTick((()=>{k.value?.fillForm?.(_.value)}))}));const S=async t=>{if(void 0===_.value)return void t();const a=await(k.value?.confirmBeforeClose());if(!1===a)return void t();const n=await(0,J.I)(e,{title:"退出前需要保存吗？",content:"选择不保存将丢失当前的改动",confirmText:"保存并退出",cancelText:"不保存，直接退出"});if(n){const t=await(k.value?.saveBeforeClose());if(!t)return;e.emit("outdated",_.value.id)}t()},w=(0,Y.or)((0,Y.and)(p,(0,Y.or)((0,n.computed)((()=>void 0===_.value)),(0,n.computed)((()=>_.value?.is_tmp===Wn.w.YES)))),(0,Y.and)(m,(0,Y.or)((0,n.computed)((()=>void 0===_.value)),(0,n.computed)((()=>_.value?.is_tmp===Wn.w.YES))))),j=(0,n.computed)((()=>[{title:"基本信息"},{title:"结算数据"},w.value?{title:"生成结算单"}:{title:"提交"}])),D=(0,n.ref)(0),F=JSON.stringify((0,n.inject)("project3in1",{cooperation_type:0})),$=JSON.parse(F);let A=2===$.value?.cooperation_type;if((!$.value||!$.value?.cooperation_type||0===$.value?.cooperation_type)&&!1===A&&m.value&&localStorage.getItem("project3inone")){const t=JSON.parse(localStorage.getItem("project3inone")||"{}");A=2===t.value?.cooperation_type}const I=(0,n.computed)((()=>d.value||A?"settlement-dialog settlement-marketing-cost-dialog":"settlement-cost-dialog")),L=(0,n.computed)((()=>A&&m.value||d.value?"942px":"1100px")),N=async t=>{void 0!==t&&(_.value={...t},e.emit("update",t)),D.value=Math.max(D.value-1,0),e.root.$nextTick((()=>{k.value?.fillForm?.(_.value)}))},T=async t=>{void 0!==t&&(_.value={...t},e.emit("update",t)),D.value=Math.min(D.value+1,2),e.root.$nextTick((()=>{k.value?.fillForm?.(_.value)}))},z=async()=>{if(void 0!==_.value){const{data:t}=await(0,y.S_)(s.value,{id:_.value?.id});_.value=t.data}h(!0)},B=(0,n.computed)((()=>{if(0===D.value)return"Step1";if(1===D.value){const t=_.value?.json_data?.amount_info_list?.[0]?.type;if(A&&m.value)return"Step2Marketing";if(d.value)return"Step2Marketing";if(m.value){if(_.value?.settlement_type===o.kX.live_taobao)return _.value?.is_tmp===Wn.w.NO?"Step2ShopLiveAfter":"Step2ShopLiveBefore";if(_.value?.settlement_type===o.kX.live_douyin)return _.value?.is_tmp===Wn.w.NO?"Step2DouyinShopLiveAfter":"Step2DouyinLiveBefore"}else if(p.value){if(_.value?.settlement_type===o.kX.common_mcn_taobao_cps)return _.value.is_tmp===Wn.w.NO?"Step2MCNTaoBaoAfter":"Step2MCNTaoBaoBefore";if(_.value?.settlement_type===o.kX.common_mcn_vtask)return _.value.is_tmp===Wn.w.NO?"Step2MCNVTaskAfter":"Step2MCNVTaskBefore";if(_.value?.settlement_type===o.kX.common_mcn_douyin_cps)return _.value.is_tmp===Wn.w.NO?"Step2DouyinAfter":"Step2DouyinBefore";if(14===t)return"Step2S2b2bCost"}}else if(2===D.value){if(A&&m.value)return"Step3Marketing";if(d.value)return"Step3Marketing";if(m.value){if(_.value?.settlement_type===o.kX.live_taobao)return _.value?.is_tmp===Wn.w.NO?"Step3ShopLiveAfter":"Step3ShopLiveBefore";if(_.value?.settlement_type===o.kX.live_douyin)return _.value?.is_tmp===Wn.w.NO?"Step3DouyinShopLiveAfter":"Step3DouyinShopLiveBefore"}else if(p.value){if(_.value?.settlement_type===o.kX.common_mcn_taobao_cps)return _.value?.super_settlement_id?"Step3MCNTaoBaoAfter":"Step3MCNTaoBaoBefore";if(_.value?.settlement_type===o.kX.common_mcn_vtask)return _.value?.super_settlement_id?"Step3MCNVTaskAfter":"Step3MCNVTaskBefore";if(_.value?.settlement_type===o.kX.common_mcn_douyin_cps)return _.value.is_tmp===Wn.w.NO?"Step3DouyinAfter":"Step3DouyinBefore";if(_.value?.settlement_type===o.kX.s2b2c_douyin_cps)return"Step2S2b2bCostStep"}}return""}));return{setDialogVisible:r,dialogVisible:i,toggleDialogVisible:c,open:x,close:h,beforeClose:S,stepCompRef:k,project_id:u,settlement:_,steps:j,activeNumber:D,formComponent:B,project:a,prev:N,next:T,onSubmitSuccess:z,dialogClass:I,dialogWidth:L,is_virtual_receipt:w}}}),Xn=Vn,Qn=(0,C.Z)(Xn,s,i,!1,null,null,null),to=Qn.exports,eo=a(77944),ao=a(21757),no=a(78902),oo=a(30845),so=a(99166),io=a(58302),lo=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",[a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",class:[t.dialogClass],attrs:{visible:t.dialogVisible,width:t.dialogWidth,height:"660px","lock-scroll":"","close-on-click-modal":!1,"close-on-press-escape":!1},on:{close:t.close},scopedSlots:t._u([{key:"title",fn:function(){return[t._v("成本结算")]},proxy:!0},!t.CanIEdit||t.is_confirmed||t.readonly||t.is_unity_settlement?null:{key:"footer",fn:function(){return[a("tg-button",{on:{click:t.confirmRefuseReason}},[t._v("不通过")]),a("tg-button",{attrs:{type:"primary"},on:{click:t.confirm}},[t._v("确认结算")])]},proxy:!0}],null,!0)},[a("div",{staticClass:"settlement-detail-content"},[a(t.data_component,{ref:"stepCompRef",tag:"component",attrs:{readonly:!0}})],1)]),a("tg-mask-loading",{attrs:{visible:t.confirmLoading,content:"正在提交确认，请稍候..."}}),a("tg-mask-loading",{attrs:{visible:t.refuseLoading,content:"正在提交，请稍候..."}}),a("RefuseDialog",{ref:"refustDialogRef",on:{refuse:t.refuse}})],1)},ro=[],co=a(42386),uo=a(9397);const mo=(0,n.defineComponent)({props:{readonly:{type:Boolean,default:!1}},components:{DataMarketing:V,DataLive:Ue,DataDoyinLive:na,DataMCNTaobao:$a,DataMCNDouyin:Pn,DataMCNVtask:un,Step2S2b2bCostStep:Kn,RefuseDialog:uo.Z},setup(t,e){const a=(0,n.ref)(!1),s=(t=!1)=>{a.value=t},i=()=>{s(!a.value)},l=(0,n.ref)(void 0),r=(0,n.computed)((()=>l.value?.status===o.ne.confirmed));(0,n.provide)("settlement",l);const c=(0,n.ref)(""),u=(0,n.ref)(null),d=(0,n.ref)(!1),m=(0,n.ref)(!1),p=t=>{l.value=t;const{settlement_type:e,isareacost:a}=t;o.kX.marketing_vtask===e||o.kX.marketing_marketing===e?(0,Y.set)(c,"DataMarketing"):o.kX.live_douyin===e||o.kX.live_taobao===e?a?(m.value=!0,(0,Y.set)(c,"DataMarketing")):(m.value=!1,o.kX.live_douyin===e?(0,Y.set)(c,"DataDoyinLive"):(0,Y.set)(c,"DataLive")):o.kX.common_mcn_taobao_cps===e?(0,Y.set)(c,"DataMCNTaobao"):o.kX.common_mcn_vtask===e?(0,Y.set)(c,"DataMCNVtask"):o.kX.common_mcn_douyin_cps===e?(0,Y.set)(c,"DataMCNDouyin"):(0,Y.set)(c,"Step2S2b2bCostStep"),(0,Y.set)(d,!0),s(!0)};(0,Y.whenever)((0,Y.and)(d,void 0!==u.value),(()=>{(0,n.nextTick)((()=>{void 0!==l.value&&u.value?.fillForm(l.value)}))}));const _=()=>{(0,Y.set)(d,!1),e.emit("close"),s()},v=(0,n.computed)((()=>l.value?.business_type===x.WD.marketing)),y=(0,n.computed)((()=>v.value?"settlement-dialog":"settlement-cost-dialog")),g=(0,n.computed)((()=>v.value||m.value?"942px":"1100px")),h=(0,n.computed)((()=>o.v$.get(l.value?.settlement_type??o.kX.live_taobao)??"--")),b=(0,n.ref)(null),k=()=>{b.value?.open()},C=(0,n.ref)(!1),S=async t=>{if(void 0===l.value)return;(0,Y.set)(C,!0);const[{data:a}]=await(0,f.Dc)(500,(0,co.XV)({id:l.value.id,refuse_reason:t}));(0,Y.set)(C,!1),a.data?(e.root.$message.success(a.message??"提交成功"),e.emit("success:refuse"),_()):e.root.$message.error(a.message??"提交失败")},w=(0,n.ref)(!1),j=async()=>{if(void 0===l.value)return;const t=await(0,J.I)(e,"确定通过这条结算吗？");if(!t)return;w.value=!0;const[{data:a}]=await(0,f.Dc)(500,(0,co.V$)(l.value.id));w.value=!1,a.data?(e.root.$message.success(a.message??"确认结算成功"),e.emit("success:confirm",l.value.id),_()):e.root.$message.error(a.message??"确认结算失败")},D=(0,n.computed)((()=>(0,ao.gI)().settlement_cost_update)),F=(0,n.computed)((()=>5===l.value?.settlement_type&&l.value?.unity_settlement_id));return{dialogVisible:a,toggleDialogVisible:i,is_unity_settlement:F,open:p,close:_,stepCompRef:u,data_component:c,dialogClass:y,dialogWidth:g,settlement:l,"结算类型":h,refustDialogRef:b,confirmRefuseReason:k,refuseLoading:C,refuse:S,confirm:j,confirmLoading:w,CanIEdit:D,is_confirmed:r}}});var po=mo,_o=po,vo=(0,C.Z)(_o,lo,ro,!1,null,null,null),fo=vo.exports,yo=a(10114),go=a(58861),xo=a(22770),ho=a(10079),bo=a(67578),ko=a(67910),Co=a(65475),So=a(35049),wo=a(28645),jo=a(87843);const Do=t=>void 0===t||""===t||Array.isArray(t)&&0===t.length?"":t,Fo=(t,e)=>void 0===t||""===t||Array.isArray(t)&&0===t.length?e:parseInt(t,10),$o=t=>o.ne.confirmed===t.status&&!(0,ho.vs)(t),Ao=t=>bo.h0.refused===t.reverse_status&&(0,ho.vs)(t),Io=(t="TgSettlementTab")=>(0,n.defineComponent)({name:t,props:{isareacost:{type:Boolean,defalut:!1,required:!1},cooperationType:{type:Number,defalut:1,required:!1}},data(){return{SettlementTypeOptions:(0,L.p)(o.dw),SettlementStatusOptions:o.FA}},components:{TgSettlementDialog:to,SettlementDetailDialog:fo,reverseOrderDialog:yo.Z,reverseAuditDialog:xo.Z,AddSettlementDialog:Co.Z,PaymentDialog:So.Z,InvoiceUpload:wo.Z},setup(t,e){const{project_id:a,isFromMarketing:s,isFromLive:i,isFromCommon:r,project_type:c,business_type:u}=(0,l.L)(e);(0,n.provide)("cooperationType",t.cooperationType),(0,n.provide)("isareacost_list",t.isareacost);const d=(0,Bt.t)();(0,n.provide)("project_add_id",d.currentRoute.params.id);const m=(0,n.ref)(!1),p=(0,n.ref)(void 0),_=(0,n.ref)(""),v=(0,n.ref)(null),{visible:g,setVisible:h}=(0,go.Z)(),b=async(t,e)=>{h(!0);const[{data:a}]=await(0,f.Dc)(500,(0,y.S_)(c.value,{id:t}));return h(),a.success&&void 0!==a.data?a.data:void 0},k=t=>{console.log(t)},C=(0,n.computed)((()=>i.value?x.kA.live:r.value?x.kA.common_business:s.value?x.kA.marketing:void 0)),S=(0,n.computed)((()=>{if(s.value){const t=(0,n.inject)("MarketingProject")??(0,n.ref)(void 0);return{...t.value,project__type:"marketing"}}if(i.value){const t=(0,n.inject)("live_project")??(0,n.ref)(void 0);return{...t.value,project__type:"live"}}if(r.value){const t=(0,n.inject)("common_project")??(0,n.ref)(void 0);return{...t.value,project__type:"common"}}})),w=(0,n.computed)((()=>eo.Z.getters["user/getUserInfo"])),j=(0,n.computed)((()=>w.value.role_info.map((t=>t.role_code)).includes(1003))),D=(0,ao.gI)(),F=(0,n.ref)({brand_id:S.value?.brand_id,brand_name:S.value?.brand_name,business_type:u.value,project_id:a.value,project_name:"",region:S.value?.region||0}),$=(0,n.computed)((()=>j.value?s.value?{createBtn:D.marketing_project_settlement_save,deleteBtn:D.marketing_project_settlement_delete,uploadInvoiceBtn:D.coop_upload_invoice}:i.value?{createBtn:D.live_project_settlement_save,deleteBtn:D.live_project_settlement_delete,auditBtn:D.live_project_statements_create,uploadInvoiceBtn:D.shop_live_upload_invoice}:r.value?{createBtn:D.common_business_project_settlement_save,deleteBtn:D.common_business_project_settlement_delete,auditBtn:D.common_business_project_contract_statement_create,uploadInvoiceBtn:D.common_upload_invoice}:{createBtn:!1,deleteBtn:!1,uploadInvoiceBtn:!1}:{createBtn:!1,deleteBtn:!1}));"finance"!==c.value&&((0,n.provide)("project_type",c),(0,n.provide)("project_id",a),(0,n.provide)("project3in1",S));const A=(0,n.ref)(null),I=(0,n.computed)((()=>"发起结算")),L=()=>{if(i.value){const t=S.value;if(t.project_status===x.C_.finish)return e.root.$message.warning("项目已完结，不允许进行结算"),!0}else if(s.value){const t=S.value;if(4===t.cooperation_status)return e.root.$message.warning("项目已执行结束，不允许进行结算"),!0}return!1},N=(t=0)=>{L()||A.value?.open(void 0,t)},T=async t=>{const a=await b(t.id,t);void 0!==a?A.value?.open(a):e.root.$message.error("未查询到结算单详情")},z=JSON.stringify((0,n.inject)("project3in1",{cooperation_type:0})),B=JSON.parse(z);let P=2===B.value?.cooperation_type;if((!B.value||!B.value?.cooperation_type||0===B.value.cooperation_type)&&!1===P&&i.value&&localStorage.getItem("project3inone")){const t=JSON.parse(localStorage.getItem("project3inone")||"{}");P=2===t.value?.cooperation_type}const O=async t=>{if(!ue(t)||t.refunded_id)return;if((0,ho.vs)(t))return void st(t);const a=await b(t.id,t);void 0!==a?(!0===P&&(a.isareacost=!0),Nt.value?.open(a)):e.root.$message.error("未查询到结算单详情")},R=(0,n.ref)(!1),M=async(t,a="确认要删除这条结算吗？")=>{const n=await(0,J.I)(e,{title:a,content:void 0});if(!n)return;R.value=!0;const[{data:o}]=await(0,f.Dc)(1200,(0,y.f_)(c.value,t.id));R.value=!1,o.success?(e.root.$message.success("删除成功"),await qt()):e.root.$message.error(o.message??"删除失败")},Z=t=>{1===S.value?.business_type?_.value=S.value?.manager_name?S.value?.manager_name:"":_.value=S.value?.customer_manager?S.value?.customer_manager:"",F.value={brand_id:S.value?.brand_id,brand_name:S.value?.brand_name,business_type:S.value?.business_type,project_id:a.value,project_name:t.project_name,region:S.value?.region||0},p.value=t,m.value=!0},G=(0,n.ref)(null),{visible:E,toggleVisible:H}=(0,go.Z)(),q=async(t,a)=>{H();const[{data:n}]=await(0,f.Dc)(500,(0,co.Tu)({id:t.id,reverse_type:o.Jd.settlement_cost,reverse_reason:a}));return H(),n.success?(e.root.$message.success(n.message??"冲销成功"),qt()):e.root.$message.error(n.message??"冲销失败"),n.success},{visible:U,toggleVisible:K}=(0,go.Z)(),W=async(t,a)=>{K();const[{data:n}]=await(0,f.Dc)(500,(0,co.Xz)({id:t.id,reverse_type:o.Jd.settlement_cost,reverse_reason:a}));return K(),n.success?(e.root.$message.success(n.message??"重新提交成功"),qt()):e.root.$message.error(n.message??"重新提交失败"),n.success},V=(0,n.ref)(!1),X=(0,n.ref)(""),Q=(0,n.ref)(""),tt=t=>{Q.value="退回原因",X.value=t.refuse_reason,V.value=!0},et=()=>{X.value="",V.value=!1},at=t=>{Q.value="退回原因",X.value=t.reverse_back_reason,V.value=!0},nt=t=>{Q.value="退回原因",X.value=t.refund_back_reason||"",V.value=!0},ot=t=>{Q.value="冲销原因",X.value=t.refund_reason||"",V.value=!0},st=t=>{Q.value="冲销原因",X.value=t.reverse_reason,V.value=!0},it=(0,n.ref)(!1),lt=(0,n.ref)([]),rt=(0,n.ref)(0),ct=t=>!(t.status!==o.ne.confirmed||t.is_estimate||t.reverse_id||t.reversed_id||t.reverse_status===bo.h0.wait_confirm||0===t.pending_amount),{settlement_number_column:ut,department_name_colume:dt,settlement_cycle_column:mt,settlement_money_column:pt,settlement_tax_rate_column:_t,settlement_tax_amount_column:vt,settlement_no_tax_amount_column:ft,paid_amount_column:yt,not_paid_amount_column:gt,settlement_status_column:xt,write_off_status_column:ht,settlement_person_column:bt,submit_date_column:kt,confirm_person_column:Ct,confirm_date_column:St,income_settlement_column:wt,project_name_colume:jt,settlement_type_column:Dt,settlement_supplier_column:Ft,settlement_bill_column:$t}=(0,so.S)(lt),At=(t,e)=>{const a=[];if((0,ho.Ep)(t)){const{refund_status:o}=t,s=e?"删除":(0,n.h)("a",{on:{click:e=>{M(t,"是否删除该冲销单"),e.stopPropagation()}}},["删除"]),i=e?"查看":(0,n.h)("a",{on:{click:e=>{ot(t),e.stopPropagation()}}},["查看"]),l=e?"查看原因":(0,n.h)("a",{on:{click:e=>{nt(t),e.stopPropagation()}}},["查看原因"]);switch(o){case 1:break;case 2:a.push(i);break;case 3:a.push(l),a.push(s);break;default:break}}else{if((0,ho.vs)(t)){if(Ao(t)){const o=e?"删除":(0,n.h)("a",{on:{click:e=>{M(t,"是否删除该冲销单"),e.stopPropagation()}}},["删除"]),s=e?"重新提交":(0,n.h)("a",{on:{click:e=>{G.value?.open((e=>W(t,e)),t.reverse_reason),e.stopPropagation()}}},["重新提交"]),i=e?"退回原因":(0,n.h)("a",{on:{click:e=>{at(t),e.stopPropagation()}}},["退回原因"]);a.push(o),a.push(s),a.push(i)}}else{if($.value.createBtn&&[o.ne.unsubmit,o.ne.refused].includes(t.status)){const o=e?"编辑":(0,n.h)("a",{on:{click:e=>{T(t),e.stopPropagation()}}},["编辑"]);a.push(o)}if(t.status===o.ne.refused){const o=e?"查看原因":(0,n.h)("a",{on:{click:e=>{tt(t),e.stopPropagation()}}},["查看原因"]);a.push(o)}if($o(t)&&null===t.reverse_id){const o=e?"冲销":(0,n.h)("a",{class:"reverse-red",on:{click:e=>{G.value?.open((e=>q(t,e))),e.stopPropagation()}}},["冲销"]);1!==t.has_refund_settlement&&a.push(o)}if($.value.deleteBtn&&(t.status===o.ne.unsubmit||t.status===o.ne.refused)){const o=e?"删除":(0,n.h)("a",{on:{click:e=>{M(t),e.stopPropagation()}}},["删除"]);a.push(o)}}if(ct(t)){const o=e?"付款":(0,n.h)("a",{on:{click:e=>{Z(t),e.stopPropagation()}}},["付款"]);a.unshift(o)}const s=t.write_off_status!==jo.iO.write_off_all&&t.status===o.ne.confirmed&&!t.reverse_id&&!t.reversed_id;if(s&&$.value.uploadInvoiceBtn&&0===t.is_estimate){const o=e?"上传发票":(0,n.h)("a",{on:{click:e=>{v.value.show({id:t.id,company:t.company_name},2,C.value),e.stopPropagation()}}},["上传发票"]);a.unshift(o)}}return e?a.join("  "):(0,n.h)("div",{class:"operation"},a)},It=(0,ko.zY)(lt,"操作",At),Lt=(0,n.computed)((()=>[ut.value,mt.value,dt.value,pt.value,_t.value,vt.value,ft.value,yt.value,gt.value,Ft.value,xt.value,ht.value,bt.value,kt.value,Ct.value,St.value,{label:"操作",fixed:"right",width:It.value,formatter:t=>At(t,!1)}])),Nt=(0,n.ref)(null),Tt=async t=>{const a=await b(t.id,t);void 0!==a?Nt.value?.open(a):e.root.$message.error("未查询到结算单详情")},zt=(0,n.ref)(null),{visible:Pt,toggleVisible:Ot}=(0,go.Z)(),Rt=async(t,a,n)=>{Ot();const s={id:t.id,reverse_type:o.Jd.settlement_cost,is_pass:a,reverse_back_reason:n},[{data:i}]=await(0,f.Dc)(500,(0,co.aH)(s));return Ot(),i.success?e.root.$message.success(i.message??"提交成功"):e.root.$message.error(i.message??"提交失败"),qt(),i.success},Mt=(0,n.computed)((()=>[ut.value,wt.value,dt.value,jt.value,Ft.value,Dt.value,mt.value,pt.value,_t.value,vt.value,ft.value,xt.value,ht.value,bt.value,kt.value,Ct.value,St.value,$t.value,{label:"操作",fixed:"right",minWidth:80,formatter:t=>{const e=[];return(0,ho.Ep)(t)?"":((0,ho.vs)(t)?(t.reverse_status!==bo.h0.wait_confirm&&e.push((0,n.h)("a",{on:{click:e=>{X.value=t.reverse_reason,V.value=!0,e.stopPropagation()}}},"查看")),bo.h0.wait_confirm===t.reverse_status&&e.push((0,n.h)("a",{class:"reverse-red",on:{click:e=>{zt.value?.open(t.reverse_reason,((e,a)=>Rt(t,e,a))),e.stopPropagation()}}},"冲销确认"))):[o.ne.confirmed,o.ne.wait_confirm].includes(t.status)&&(0,ao.kG)(no.HN.settlement_income_view)&&e.push((0,n.h)("a",{on:{click:e=>{Tt(t),e.stopPropagation()}}},["查看"])),(0,n.h)("div",{class:"operation"},e))}}])),Zt=async t=>{console.log(t),await qt()},Gt=(0,n.ref)({project_name:"",settlement_type:"",status:"",search_value:"",search_type:"1",settlement_kind:o.Qn.cost,is_confirmed:"",page_num:1,num:20,month:""}),Et=()=>{Gt.value.project_name="",Gt.value.settlement_type="",Gt.value.status="",Gt.value.search_type="1",Gt.value.search_value="",Gt.value.month=""},Jt=(0,Y.useUrlSearchParams)("history");Gt.value.project_name=Do(Jt.project_name),Gt.value.settlement_type=Fo(Jt.settlement_type,""),Gt.value.status=Fo(Jt.status,""),Gt.value.page_num=Fo(Jt.page_num,1),Gt.value.num=Fo(Jt.num,20);const Yt=()=>{const{project_name:t,settlement_type:n,status:o,settlement_kind:s,is_confirmed:i,month:l,...r}=Gt.value;if("finance_cost"!==c.value)return{month:""===l?void 0:l,project_id:a.value,settlement_kind:(0,oo.f)(s),business_type:u.value,...r};{const a=(0,f.jG)({project_name:(0,oo.f)(t),settlement_type:(0,oo.f)(n),status:(0,oo.f)(o),...r}),c=new URL(location.origin+e.root.$route.path+"?"+(0,f.$D)(a));return c.search!==location.search&&e.root.$router.replace({path:c.pathname+c.search}),{month:""===l?void 0:l,project_name:(0,oo.f)(t),settlement_type:(0,oo.f)(n),status:(0,oo.f)(o),settlement_kind:(0,oo.f)(s),is_confirmed:(0,oo.f)(i),is_tmp:Wn.w.NO,...r}}},Ht=async t=>{it.value=!0;const[{data:e}]=await(0,f.Dc)(500,(0,y.fO)(c.value,t));it.value=!1,e.success?(lt.value=e.data.data,rt.value=e.data.total):(lt.value=[],rt.value=0)},qt=async(t=!0)=>{t&&(Gt.value.page_num=1),await Ht(Yt())},Ut=async()=>{await qt()},Kt=t=>{},Wt=async()=>{Et(),await qt()},Vt=async t=>{Gt.value.page_num=t,await qt(!1)},Xt=async t=>{Gt.value.num=t,await qt()},Qt=(0,n.ref)(null),te=()=>{Qt.value?.show()},ee=()=>{qt()};(0,n.onMounted)((()=>{qt()}));const ae=0,ne=34,oe=36,se=12,ie=(0,n.ref)(0),le=t=>{ie.value=t.height},re=(0,io.Z)({compensation:(0,n.computed)((()=>ae+ne+oe+se)),fixedBlockHeightRefs:[0===ie.value?6:ie,120],tableMinHeight:100,pagename:"finance_settlementc_cost",delay:100}),ce=()=>{qt()},ue=t=>{if(!t.reversed_id&&(t.status===o.ne.confirmed||t.status===o.ne.wait_confirm)||bo.h0.wait_confirm===t.reverse_status||bo.h0.confirmed===t.reverse_status)return{cursor:"pointer"}},de=()=>{qt()};return{isDev:!1,isFromMarketing:s,isFromLive:i,isFromCommon:r,CanIUse:$,dialogRef:A,buttonContent:I,onCreateBtnClick:N,onEditBtnClick:T,columns:Lt,financeColumns:Mt,project:S,loading:it,data:lt,total:rt,loadData:Ht,reload:qt,reset:Wt,filterForm:Gt,onCurrentChange:Vt,onSizeChange:Xt,deleteLoading:R,reasonDialogVisible:V,reason:X,onViewBtnClick:O,onReasonViewBtnClick:tt,onReasonDialogClose:et,onTopCardRectUpdate:le,...re,settlementDetailDialogRef:Nt,onDialogClose:Ut,onCacheOutdated:k,onCacheShouldUpdate:Kt,onConfirmSuccuss:Zt,reverseOrderDialogRef:G,reverseLoading:E,reverseAgainLoading:U,reasonDialogTitle:Q,reverseAuditLoading:Pt,reverseAuditDialogRef:zt,isFetchingDetail:g,onApproveBtnClick:te,onSettlementAdded:ee,addSettlementDialog:Qt,paymentDialogVisible:m,paymentData:F,paySettlement:p,onPaymentSave:ce,customerManager:_,rowStyle:ue,InvoiceUploadRef:v,onInvoiceUploadSuccess:de,projectType:C}}});var Lo=Io},32662:function(t,e,a){"use strict";a.d(e,{W:function(){return c}});var n=a(97434),o=a(79443),s=a(64236);const i=async(t,e)=>Promise.all(t.map((t=>e(t)))),l=async(t,e,a)=>{const n=JSON.parse(JSON.stringify(t)),o=[],s=a??8;for(let l=0;l<n.length;l+=s){const t=await i(n.slice(l,l+s),e);o.push(...t)}return o};async function r(t,e,a){const n=a??200,o={...t,page_num:1,num:n},s=await e(o),i={total:0,data:[]};if(0===s.data.error_code){i.total=s.data.data.total,i.data.push(...s.data.data.data);const t=Math.max(Math.ceil(i.total/n)-1,0),a=new Array(t).fill(0).map(((t,e)=>({...o,page_num:2+e}))),r=await l(a,e).then((t=>t.map((t=>t.data.data.data)).flat()));i.data.push(...r)}return i}const c=(t,e=500)=>{const a=(0,n.ref)(!1),i=(0,n.ref)([]),l=(0,n.ref)(0),c=async r=>{a.value=!0;const[{data:c}]=await(0,s.Dc)(e,(0,o.fO)((0,n.unref)((0,n.unref)(t)),r));a.value=!1,c.success?(i.value=c.data.data,l.value=c.data.total):(i.value=[],l.value=0)},u=async e=>{const a=await r(e,(async e=>(0,o.fO)((0,n.unref)((0,n.unref)(t)),e)));i.value=a.data,l.value=a.total};return{loading:a,data:i,total:l,loadData:c,loadDataAll:u}}},80391:function(t,e,a){"use strict";a.d(e,{$:function(){return s}});const n="/api/resources/upload_file";var o=a(76012);const s=async t=>(0,o.SO)(n,t)},318:function(t,e,a){"use strict";a.d(e,{Zn:function(){return E},Qv:function(){return G},F9:function(){return H},aw:function(){return q},aI:function(){return z},kg:function(){return Z},K:function(){return B},j5:function(){return R},wu:function(){return h},yz:function(){return M},Mj:function(){return J},id:function(){return Y},UK:function(){return x},ZP:function(){return W}});a(21703);var n=a(76012),o=a(64236);const s="/api/medium/get_company_name_and_id",i="/api/model/del_model",l="/api/anchor/del_anchor",r="/api/auth/query_anchor_maintainer",c="/api/anchor/save_anchor_maintainer",u="/api/anchor/get_anchor_key_info",d="/api/anchor/get_anchor_key_info_log",m="/api/medium/add_tmp_company",p="/api/anchor/contract/associate_project",_=t=>{if(!0!==t.data.success)throw new Error(t.data.message);return t.data.data},v=async()=>(0,n.dX)("/api/anchor/good_at_categories"),f=async()=>(0,n.dX)("/api/anchor/anchor_tags"),y=async t=>(0,n.dX)(`/api/anchor/delete_anchor/${t}`),g=async t=>(0,n.SO)("/api/anchor/verify_anchor",(0,o.jG)(t)),x=async t=>(0,n.SO)(m,(0,o.jG)(t)),h=async t=>(0,n.SO)("/api/medium/add_company",(0,o.jG)(t)),b=async t=>(0,n.SO)("/api/anchor/save_anchor_basic",t).then(_),k=async t=>(0,n.SO)("/api/anchor/save_anchor_other",(0,o.jG)(t)).then(_),C=async t=>(0,n.dX)("/api/anchor/list_anchors",{params:(0,o.jG)(t)}).then(_),S=async t=>(0,n.dX)(`/api/anchor/get_anchor_detail/${t}/`).then(_),w=async t=>(0,n.dX)("/api/anchor/apply/list",{params:(0,o.jG)(t)}).then(_),j=async t=>(0,n.dX)(`/api/anchor/apply/list/${t.anchor_id}`,{params:(0,o.jG)(t)}).then(_),D=async t=>(0,n.dX)("/api/shop_live/query_uncompleted_projects",{params:(0,o.jG)(t)}).then(_),F=async t=>(0,n.dX)("/api/shop_live/query_shop_live_project",{params:(0,o.jG)(t)}).then(_),$=async t=>(0,n.SO)("/api/anchor/apply/schedule",{apply_id:t}).then(_),A=async t=>(0,n.SO)("/api/anchor/apply/cancel",{apply_id:t}).then(_),I=async t=>(0,n.SO)("/api/anchor/apply/feedback",(0,o.jG)(t)).then(_),L=async t=>(0,n.SO)("/api/anchor/save_anchor_cooperation",(0,o.jG)(t)).then(_),N=async t=>(0,n.SO)("/api/anchor/apply/pilot",(0,o.jG)(t)).then(_),T=async t=>(0,n.SO)("/api/anchor/apply/audition",(0,o.jG)(t)).then(_),z=async t=>(0,n.dX)("/api/auth/query_user_v2",{params:(0,o.jG)(t)}).then(_),B=async(t,e)=>(0,n.dX)("/api/anchor/list_settlement_companies",{params:{company_name:t,verify_status:e}}).then(_),P=async t=>(0,n.dX)(`/api/anchor/delete_anchor_cooperation/${t}/`).then(_),O=async t=>(0,n.dX)(`/api/anchor/list_anchor_cooperations/${t}/`).then(_),R=async t=>(0,n.dX)("/api/model/model_list",{params:(0,o.jG)(t)}).then(_),M=async t=>(0,n.SO)("/api/model/save_model",(0,o.jG)(t)).then(_),Z=async t=>(0,n.dX)(s,{params:{...(0,o.jG)(t)}}),G=async t=>(0,n.SO)(i,{id:t}),E=async t=>(0,n.SO)(l,{id:t}),J=async t=>(0,n.dX)(r,{params:{...(0,o.jG)({search_value:t})}}),Y=async t=>(0,n.SO)(c,{...(0,o.jG)(t)}),H=async t=>(0,n.dX)(u,{params:{...(0,o.jG)(t)}}),q=async t=>(0,n.dX)(d,{params:{...(0,o.jG)(t)}}),U=async(t,e)=>(0,n.dX)("/api/anchor/check_anchor_wechat",{params:{wechat:t,anchor_id:e}}),K=async t=>(0,n.SO)(p,{...(0,o.jG)(t)});var W={GetCheckAnchorWechat:U,GetAnchorGoodAtCategories:v,GetAnchorApplyCancel:A,PostSaveModel:M,GetAnchorApplyList:w,GetModelList:R,GetAnchorApplyDetail:j,PostAnchorOther:k,GetAnchorTags:f,PostAnchorBasic:b,GetAnchorList:C,GetAnchorDetail:S,GetAnchorDelete:y,PostAnchorVerify:g,GetListSettlementCompanies:B,GetAnchorApplySchedule:$,PostAnchorApplyFedback:I,GetListAnchorCooperations:O,GetUnCompletedProjects:D,PostAnchorCooperation:L,GetAuthQueryUser:z,PostAnchorApplyPilot:N,PostAnchorApplyAudition:T,GetShopLiveProject:F,GetDeleteAnchorCooperation:P,PostModifyCompany:h,SaveAnchorProjectContract:K}},44542:function(t,e,a){"use strict";a.d(e,{G:function(){return n},p:function(){return o}});const n=async t=>new Promise((e=>{t.value?.validate((t=>e(t)))})),o=t=>{const e=[];return t.forEach((t=>{const{label:a,value:n,group:o}=t,s=e.find((e=>e.label===t.group));void 0!==s?s.options.push({label:a,value:n}):e.push({label:o,options:[{label:a,value:n}]})})),e}},8136:function(t,e,a){"use strict";a.d(e,{AR:function(){return j},BG:function(){return C},Cl:function(){return b},D$:function(){return l},EI:function(){return d},Hx:function(){return s},LY:function(){return c},Nv:function(){return r},Ps:function(){return A},Rd:function(){return w},ZC:function(){return p},_t:function(){return y},bI:function(){return h},g9:function(){return f},hy:function(){return m},jh:function(){return F},mB:function(){return g},mx:function(){return $},nA:function(){return D},q0:function(){return S},sc:function(){return k},ug:function(){return x},us:function(){return v},vJ:function(){return _},wA:function(){return i},xF:function(){return u}});var n=a(20713),o=a.n(n);function s(t,e){const a=t.display_type;switch(a){case 0:return"混播";case 1:return"专场"}}const i=["综合","美妆","生活","服饰","美食","母婴","数码","家装","健康","宠物","时尚","配饰","家电","测评","旅行","运动","摄影","情感","汽车","搞笑","教育","财经","萌娃","文化","影视","娱乐","游戏","海外","才艺","二次元","高颜值"],l=["美妆","生活","服饰","美食","母婴","数码","家装","健康","宠物","时尚","配饰","家电","测评","旅行","运动","摄影","情感","汽车","搞笑","教育","财经","萌娃","文化","影视","娱乐","游戏","海外","才艺","二次元","高颜值","行政采购"];function r({category:t}){return 0===t?"无":i[t]}function c(t,e){const a=t.sales_price_period;switch(a){case 0:return"0 ~ 100";case 1:return"100 ~ 200";case 2:return"200以上"}}function u(t,e="YYYY-MM-DD"){return o()(t).format(e)}function d(t,e="YYYY-MM-DD hh:mm:ss"){return o()(t+"+0800").format(e)}function m(t,e){return o()(t+"+0800").format(e||"YYYY-MM-DD")}function p(t){let e=parseInt(t,10),a=0,n=0;e>=60&&(a=parseInt(e/60,10),e=parseInt(e%60,10),a>=60&&(n=parseInt(a/60,10),a=parseInt(a%60,10)));let o=""+(parseInt(e,10)<10?"0"+parseInt(e,10):parseInt(e,10));return o=(parseInt(a,10)<10?"0"+parseInt(a,10):parseInt(a,10))+":"+o,o=(parseInt(n,10)<10?"0"+parseInt(n,10):parseInt(n,10))+":"+o,o}function _(t){const e=t.is_presell;switch(e){case-1:return"未录入";case 1:return"预售";case 0:return"非预售";case 2:return"预热"}}function v(t){const e=t.is_display;switch(e){case-1:return"未录入";case 2:return"已出单";case 1:return"未出单"}}function f(t){const e=t.duration;switch(e){case-1:return"未录入";case 0:return"5 ~ 10分钟";case 1:return"10 ~ 15分钟";case 2:return"15 ~ 20分钟";case 3:return"0 ~ 5分钟";case 4:return"20分钟以上"}}function y(t){const e=t.display_period;switch(e){case-1:return"未录入";case 0:return"白天";case 1:return"晚上"}}function g(t){const e=t.shop_type;switch(e){case 0:return"无";case 1:return"淘宝店";case 2:return"天猫店";case 3:return"抖音店";default:return"--"}}function x(t){const e=t.company_type;switch(e){case 0:return"无";case 1:return"同行机构";case 2:return"广告公司";case 3:return"品牌TP";case 4:return"直客"}}function h(t,e){const a=/[^\x00-\xff]/g;let n;if(t.replace(a,"**").length>e){n=Math.floor(e/2);for(let o=n,s=t.length;o<s;o++)if(t.substr(0,o).replace(a,"**").length>=e)return t.substr(0,o)}return t}const b=[{type:0,value:"全部"},{type:1,value:"普通客户"},{type:2,value:"重点客户"},{type:3,value:"战略客户"},{type:4,value:"KA客户"}],k=[{value:"全部",type:0},{value:"淘宝图文",type:9},{value:"小红书",type:1},{value:"微信公众号",type:2},{value:"新浪微博",type:3},{value:"淘宝短视频",type:10},{value:"抖音",type:4},{value:"快手",type:5},{value:"哔哩哔哩",type:6},{value:"淘宝直播",type:7},{value:"一直播",type:8},{value:"线下场地搭建",type:11},{value:"线下视觉设计",type:12},{value:"活动策划执行",type:13}],C=[{value:"淘宝图文",type:9},{value:"小红书",type:1},{value:"微信公众号",type:2},{value:"新浪微博",type:3},{value:"淘宝短视频",type:10},{value:"抖音",type:4},{value:"快手",type:5},{value:"哔哩哔哩",type:6},{value:"淘宝直播",type:7},{value:"一直播",type:8},{value:"线下场地搭建",type:11},{value:"线下视觉设计",type:12},{value:"活动策划执行",type:13},{value:"行政采购",type:14}],S=[{value:3,text:"抖音店"},{value:1,text:"淘宝店"},{value:2,text:"天猫店"}],w=[{value:1,text:"同行机构"},{value:2,text:"广告公司"},{value:3,text:"品牌TP"},{value:4,text:"直客"}],j=[{type:0,value:"--"},{type:1,value:"同行机构"},{type:2,value:"广告公司"},{type:3,value:"品牌TP"},{type:4,value:"直客"}],D=["#D15CB4","#6090F0","#FF9C69","#59B6DF","#C673F0","#52CCC2","#F0737F","#6FCC66","#DBD26A","#9D73F0","#FAB36E","#A2D160","#D15CB4","#58B89F","#E06C9C","#8873F0","#FA9384","#C251A6","#486DB5","#C77A52","#4185A3","#9557B5","#3C968F","#B55760","#4F9149","#A19A4D","#7657B5","#BF8954","#759645","#964282","#3C7D6C","#A65073","#6556B3","#BF7065","#873874"],F=["#6090F0","#FF9C69","#52CCC2","#59B6DF","#C673F0","#D15CB4","#F0737F","#DBD26A","#FAB36E","#A2D160","#6FCC66","#58B89F","#8873F0","#FA9384","#9D73F0","#E06C9C","#C251A6"],$=["#1E8DFF","#FFBF00","#10C0D3","#9273F8","#FE9C25","#00B942","#FFCD39","#FF829D","#00A3FF","#3AD08E","#F1DC2F","#845EF7","#FF7F00","#B3DC12","#009999","#2877FF","#D977F2","#FFC073","#768FF3","#81E5B1","#BAC8FF","#E599F8","#E7E275","#FF7E7E","#F7A0B8","#49C6F1","#B197FC","#53D66F","#FF97AD","#FDD866"];function A(t){for(const e of t)if("一"<=e&&e<="龥")return e;return t[0]}},30845:function(t,e,a){"use strict";a.d(e,{f:function(){return n}});const n=t=>""===t?void 0:t},25300:function(t,e,a){t.exports=a(70680)(34002)},20713:function(t,e,a){t.exports=a(70680)(52703)}}]);
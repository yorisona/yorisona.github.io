"use strict";(self["webpackChunkgoumee_star_temp"]=self["webpackChunkgoumee_star_temp"]||[]).push([[2284],{46673:function(t,e,a){a.d(e,{Z:function(){return g}});var s=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"sty-radio sty-input sty-dialog",attrs:{id:"addAttachmentDialog"}},[a("el-dialog",{attrs:{visible:t.dialogVisible,width:"990px","close-on-click-modal":!1,"close-on-press-escape":!1,"destroy-on-close":!0,"custom-class":"add-attachment-dialog customer-dialog"},on:{close:t.handleDialogClose},scopedSlots:t._u([{key:"title",fn:function(){return[a("div",{staticClass:"title"},[t._v("新增补充协议")])]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{on:{click:t.handleDialogClose}},[t._v("取 消")]),a("tg-button",{class:t.isSubmitForbid?"forbid-btn":"",attrs:{type:"primary",disabled:t.isSubmitForbid},on:{click:t.handleAttachmentSubmitClick}},[t._v("提 交")])]},proxy:!0}])},[a("el-form",{directives:[{name:"loading",rawName:"v-loading.fullscreen",value:t.isLoading,expression:"isLoading",modifiers:{fullscreen:!0}}],ref:"contract_attachment_form",staticClass:"dialog-content",attrs:{model:t.contract_attachment_form,rules:t.contract_attachment_rules,"label-width":"126px"}},[a("div",{staticClass:"box1"},[a("div",{staticClass:"form-block"},[a("el-form-item",{attrs:{label:"关联供应商合同：",prop:"contract_type"}},[a("el-radio-group",{attrs:{disabled:t.editData&&t.editData.isEdit},on:{change:t.changeContract},model:{value:t.contract_attachment_form.contract_type,callback:function(e){t.$set(t.contract_attachment_form,"contract_type",e)},expression:"contract_attachment_form.contract_type"}},[a("el-radio",{attrs:{label:3}},[t._v("采买合同")]),a("el-radio",{attrs:{label:4}},[t._v("框架合同")])],1)],1),a("el-form-item",{staticClass:"contract_num",attrs:{label:"关联合同编号：",prop:"contract_no"}},[a("el-select",{staticStyle:{width:"100%"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入或者搜索合同编号","remote-method":t.getCustmerByContractNo,size:"small",disabled:t.editData&&t.editData.isEdit},on:{change:t.handleSelect},model:{value:t.contract_attachment_form.contract_no,callback:function(e){t.$set(t.contract_attachment_form,"contract_no",e)},expression:"contract_attachment_form.contract_no"}},t._l(t.contractVal?t.custmerOption:[],(function(t){return a("el-option",{key:t.contract_uid,attrs:{label:t.contract_uid,value:t.contract_uid}})})),1)],1),a("el-form-item",{attrs:{label:"供应商名称：",prop:"partner_name"}},[a("el-input",{attrs:{size:"small",placeholder:"请先输入合同编号",disabled:""},model:{value:t.contract_attachment_form.partner_name,callback:function(e){t.$set(t.contract_attachment_form,"partner_name",e)},expression:"contract_attachment_form.partner_name"}})],1),a("el-form-item",{attrs:{label:"审批金额：",prop:"approval_amount"}},[a("el-input",{attrs:{size:"small",placeholder:"请输入审批金额"},on:{input:function(e){return t.contract_attachment_form.approval_amount=t.getPositiveNumberHaveZero(e)}},model:{value:t.contract_attachment_form.approval_amount,callback:function(e){t.$set(t.contract_attachment_form,"approval_amount",e)},expression:"contract_attachment_form.approval_amount"}})],1),a("el-form-item",{attrs:{label:"用章情况：",prop:"seal_type"}},[a("el-radio-group",{model:{value:t.contract_attachment_form.seal_type,callback:function(e){t.$set(t.contract_attachment_form,"seal_type",e)},expression:"contract_attachment_form.seal_type"}},[a("el-radio",{attrs:{label:2}},[t._v("公章")]),a("el-radio",{attrs:{label:3}},[t._v("合同章")]),a("el-radio",{attrs:{label:1}},[t._v("不用印章")])],1)],1),a("el-form-item",{attrs:{label:"附件单：",prop:"attachment_url"}},[a("el-upload",{staticClass:"upload-attachment",attrs:{action:"/",multiple:!1,"show-file-list":!1,accept:".pdf,.docx,.jpg,.xlsx,.xls","http-request":t.uploadAttachmentFile,disabled:5===t.uploadedAttachmentList.length}},[a("el-button",{staticClass:"upload-btn big-button btn-blue",class:5===t.uploadedAttachmentList.length?"upload-forbid":"",attrs:{type:"primary",size:"small"}},[a("i",{staticClass:"iconfont icon-zhongxinshangchuan",staticStyle:{"font-size":"14px",top:"-1px !important",left:"-3px !important"}}),t._v("上传文件")])],1),a("span",{staticClass:"upload-tips"},[t._v(" 最多上传5个文件（单个文件大小不超过30M），支持扩展名：.docx .pdf .jpg .xlsx .xls ")]),a("div",{staticClass:"uploaded-list"},t._l(t.uploadedAttachmentList,(function(e,s){return a("div",{key:s},[a("TgIcon",{staticStyle:{"margin-right":"5px"},attrs:{name:"ico-annex"}}),a("em",[t._v(t._s(e.file))]),e?a("TgIcon",{staticStyle:{"margin-left":"15px"},attrs:{name:"ico-cross"},on:{click:function(e){return t.handleAttachmentClick(s)}}}):t._e()],1)})),0)],1),a("el-form-item",{attrs:{label:"申请内容：",prop:"comment"}},[a("el-input",{attrs:{size:"small","show-word-limit":"",placeholder:"请输入文本",maxlength:"100"},model:{value:t.contract_attachment_form.comment,callback:function(e){t.$set(t.contract_attachment_form,"comment",e)},expression:"contract_attachment_form.comment"}})],1)],1)])])],1),a("tg-mask-loading",{attrs:{visible:t.isSubmitForbid,content:"  正在提交数据，请稍候..."}})],1)},o=[],n=a(86863),i=a(83005),c=a(37808),r=a(61282),l=a(76612),d=a(84731),m=a(48606),p={name:"addAttachmentDialog",inject:["project_add_id"],conponents:{TgIcon:l.Z},props:{editData:{type:Object}},data(){return{loading:null,isSubmitForbid:!1,radio:1,isLoading:!1,isAddingEditing:!1,dialogVisible:!1,contractVal:"",contract_attachment_form:{contract_no:void 0,partner_name:void 0,contract_id:void 0,approval_amount:void 0,comment:"",attachment_url:"",manager_id:void 0,department:void 0,partner_id:void 0,contract_annex_type:2,contract_type:3,seal_type:2},contract_attachment_rules:{contract_type:[{required:!0,message:"请选择关联供应商",trigger:"blur"}],contract_no:[{required:!0,message:"请输入合同编号",trigger:"blur"}],partner_name:[{required:!0,message:"请先输入合同编号",trigger:"blur"}],approval_amount:[{required:!0,message:"请输入审批金额",trigger:"blur"}],seal_type:[{required:!0,message:"请选择用章情况",trigger:"blur"}],attachment_url:[{required:!0,message:"请上传附件",trigger:"blur"}]},custmerOption:[],uploadAttachmentUploading:!1,uploadedAttachmentList:[],breadcrumb:(0,d.f)()}},mounted(){this.editData&&this.editData.isEdit&&(this.contract_attachment_form.contract_type=this.editData.contract_type,this.contract_attachment_form.contract_no=this.editData.contract_uid,this.contract_attachment_form.partner_name=this.editData.partner_name,this.contract_attachment_form.contract_id=this.editData.contract_id,this.contract_attachment_form.partner_id=this.editData.partner_id)},methods:{startLoading(){this.loading=m.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},closeLoading(){this.loading.close()},getPositiveNumberHaveZero:r.aV,changeContract(t){this.contract_attachment_form.contract_no=""},show(){this.dialogVisible=!0},handleAttachmentSubmitClick(){this.isAddingEditing=!0,this.$refs.contract_attachment_form.validate((t=>{if(!t)return!1;0!==this.uploadedAttachmentList.length?(this.contract_attachment_form.attachment_url=this.uploadedAttachmentList.map((t=>t.path)),this.isSubmitForbid=!0,Promise.resolve().then((()=>this.breadcrumb.isLiveDetail?(0,i.XL)(this.contract_attachment_form):this.breadcrumb.isCommonBusinessDetail?(0,i.AE)(this.contract_attachment_form):this.breadcrumb.isCoopDetail?(0,i.fY)(this.contract_attachment_form):(0,n.B9)(this.contract_attachment_form))).then((t=>{t.data.success?(this.$message.success(t.data.message,{showClose:!0,duration:2e3}),this.$emit("added"),this.dialogVisible=!1,this.formResetFun(),this.editData&&this.editData.isEdit&&(location.href.indexOf("activeName")>-1?location.href=location.href.split("&activeName")[0]:location.reload())):this.$message.error(t.data.message,{showClose:!0,duration:2e3}),this.isSubmitForbid=!1})).catch((t=>{this.$message.error("新增合同附件失败，请稍后重试",{showClose:!0,duration:2e3}),console.error(t.message),this.isSubmitForbid=!1}))):this.$message.error("请上传附件",{showClose:!0,duration:2e3})}))},getCustmerManager(){(0,n.Jv)({roles:c.b.customer_manager+","+c.b.major_customer_manager}).then((t=>{t.data.success?this.accountManager=t.data.data:this.$message({type:"warning",message:t.data.message,duration:2e3,showClose:!0})})).catch((t=>{this.$message({type:"error",message:"客户经理获取失败，稍后重试",duration:2e3,showClose:!0}),console.log(t.message)}))},getCustmerByContractNo(t){let e=1;this.breadcrumb.isLiveDetail||this.breadcrumb.isCommonBusinessDetail?e=1:this.breadcrumb.isCoopDetail&&(e=2),this.contractVal=t,""!==t&&void 0!==t&&(0,i.z0)({partner_type:2,contract_status:2,search:t.trim(),contract_type:this.contract_attachment_form.contract_type,project_type:e}).then((t=>{t.data.success&&(this.custmerOption=t.data.data.data)})).catch((()=>{this.$message.error("根据合同编号获取合同客户名称失败，请稍后重试",{showClose:!0,duration:2e3})}))},handleSelect(t){this.contractVal="",this.isAddingEditing=!1;const e=this.custmerOption.find((e=>e.contract_uid===t));return e&&2!==e.contract_status?(this.$message.warning("合同在正常状态下才可以添加合同附件"),!1):!e||4!==e.last_annex_status&&5!==e.last_annex_status?(this.contract_attachment_form.partner_name=e?e.partner_name:void 0,this.contract_attachment_form.contract_id=e?e.contract_id:void 0,void(this.contract_attachment_form.partner_id=e?e.partner_id:void 0)):(this.$message.warning("合同附件在审批中、已作废状态下无法继续添加合同附件"),!1)},uploadAttachmentFile(t){if(5===this.uploadedAttachmentList.length)return void this.$message.error("最多上传5个文件");if(t.file.size>31488e3)return this.$message.error("单个文件大小不超过30M"),void(this.isLoading=!1);this.isAddingEditing=!1;const e=new FormData;e.append("file",t.file,t.file.name),e.append("attachment_type","contract_annex"),this.uploadAttachmentUploading=!0,this.startLoading(),(0,n.w_)(e).then((e=>{if(this.closeLoading(),e.data.success){this.uploadedAttachmentList.push({file:t.file.name,path:e.data.data.source});const a=this.uploadedAttachmentList.map((t=>t.path));this.contract_attachment_form.attachment_url=a,this.$refs.contract_attachment_form.validateField("attachment_url")}else this.$message({type:"warning",message:e.data.message,showClose:!0,duration:2e3});this.uploadAttachmentUploading=!1,this.isLoading=!1})).catch((t=>{this.closeLoading(),this.$message({type:"warning",message:"上传失败，稍后重试",showClose:!0,duration:2e3}),this.isLoading=!1,this.uploadAttachmentUploading=!1,console.log(t.message)}))},handleAttachmentClick(t){this.uploadedAttachmentList.splice(t,1)},handleCustmerManagerChange(t){this.isAddingEditing=!1;const e=this.accountManager.find((e=>e.id===t));this.contract_attachment_form.department=e?e.department:void 0,this.departmentName=e?e.department_str:""},handleDialogClose(){this.formResetFun(),this.dialogVisible=!1,this.custmerOption=[],this.isAddingEditing=!1,Object.assign(this.$data,this.$options.data())},formResetFun(t=3){this.$refs.contract_attachment_form.resetFields(),this.contract_attachment_form.contract_type=t,this.uploadedAttachmentList=[],this.contract_attachment_form.attachment_url="",this.departmentName=""}}},u=p,h=a(1001),_=(0,h.Z)(u,s,o,!1,null,"c9a0d76a",null),g=_.exports},69540:function(t,e,a){a.d(e,{Z:function(){return w}});var s=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"sty-radio sty-dialog",attrs:{id:"add-contract"}},[a("el-dialog",{attrs:{visible:t.visible,"close-on-click-modal":!1,"close-on-press-escape":!1,width:"1006px",top:"70px"},on:{close:function(e){t.visible=!1}},scopedSlots:t._u([{key:"title",fn:function(){return[a("div",{staticClass:"title"},[t._v(" "+t._s("add"===t.type?"新增供应商合同":"编辑供应商合同")+" ")])]},proxy:!0}])},[a("div",{staticClass:"right",attrs:{id:"right"}}),a("div",{staticClass:"dialog-content",attrs:{id:"dialog-content"}},[a("div",{staticClass:"box1"},[a("div",{staticClass:"content-header"},[t._v("合同基础信息")]),a("div",{staticClass:"content-body"},[a("div",{staticClass:"content-lines"},[a("div",{staticClass:"content-label"},[t._v("合同编号：")]),a("div",{staticClass:"content-value"},[t._v(t._s(t.form.contract_uid)+"（系统生成）")])]),a("div",{staticClass:"content-lines"},[a("div",{staticClass:"content-label"},[a("em",[t._v("*")]),t._v("合同类型：")]),a("el-radio-group",{staticStyle:{display:"inline-block"},on:{change:t.changeContract},model:{value:t.form.contract_type,callback:function(e){t.$set(t.form,"contract_type",e)},expression:"form.contract_type"}},[a("el-radio",{attrs:{label:3}},[t._v("采买合同")]),a("el-radio",{attrs:{label:4}},[t._v("框架合同")])],1)],1),3===t.form.contract_type?a("div",{staticClass:"content-lines content-other"},[a("el-popover",{attrs:{placement:"top",trigger:"hover",effect:"light",content:"如与供应商有签订框架合同请关联（非必填）"}},[a("template",{slot:"reference"},[a("i",{staticClass:"el-icon-question",staticStyle:{cursor:"pointer",position:"relative",left:"10px"}})])],2),a("div",{staticClass:"content-label",staticStyle:{width:"84px"}},[t._v("关联合同：")]),a("div",{staticClass:"content-value"},[a("el-select",{staticStyle:{width:"692px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请搜索并选择合同","remote-method":t.getContract,size:"medium"},on:{change:function(e){return t.selectContractUidChange(e)}},model:{value:t.form.frame_contract_uid,callback:function(e){t.$set(t.form,"frame_contract_uid",e)},expression:"form.frame_contract_uid"}},t._l(t.contractVal?t.contract_uids:[],(function(t){return a("el-option",{key:t.contract_id,attrs:{label:t.contract_uid,value:t.contract_uid}})})),1)],1)],1):t._e(),a("div",{staticClass:"content-lines"},[a("div",{staticClass:"content-label positionAdust"},[a("em",[t._v("*")]),t._v("供应商名称：")]),a("div",{staticClass:"content-value"},[a("el-select",{staticStyle:{width:"830px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请搜索并选择供应商","remote-method":t.getPartnerList,size:"medium"},on:{change:t.changePartner},model:{value:t.form.partner_id,callback:function(e){t.$set(t.form,"partner_id",e)},expression:"form.partner_id"}},t._l(t.partnerOptions,(function(t){return a("el-option",{key:t.partner_id,attrs:{label:t.partner_name,value:t.partner_id}})})),1),a("p",{staticClass:"select-partner-tips"},[t._v(" 注：如果找不到相应的供应商名称，请让媒介先到【供应商管理 → 公司库】添加供应商 ")])],1)]),a("div",{staticClass:"content-lines"},[a("div",{staticClass:"content-label positionAdust"},[a("em",[t._v("*")]),t._v("合作期限：")]),a("el-date-picker",{staticStyle:{height:"36px"},attrs:{clearable:!1,type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"yyyy-MM-dd"},model:{value:t.parterDate,callback:function(e){t.parterDate=e},expression:"parterDate"}})],1),a("div",{staticClass:"content-lines"},[a("div",{staticClass:"content-label positionAdust",staticStyle:{top:"5px"}},[a("em",[t._v("*")]),t._v("采买渠道：")]),a("div",{staticClass:"content-value",staticStyle:{width:"820px"}},[a("div",{staticClass:"sale-chance-wrap"},[a("p",[a("el-checkbox",{attrs:{indeterminate:t.saleChance.isIndeterminate},on:{change:t.handleCheckAllChange},model:{value:t.saleChance.checkAll,callback:function(e){t.$set(t.saleChance,"checkAll",e)},expression:"saleChance.checkAll"}},[t._v("全部")])],1),a("el-checkbox-group",{on:{change:t.handleCheckedSaleChanceChange},model:{value:t.form.sale_chance,callback:function(e){t.$set(t.form,"sale_chance",e)},expression:"form.sale_chance"}},t._l(t.saleChances,(function(e,s){return a("el-checkbox",{key:s,staticClass:"chance-checkbox",staticStyle:{color:"#333"},attrs:{label:e.value}},[t._v(t._s(e.label))])})),1)],1)])])])]),a("div",{staticClass:"box2"},[a("div",{staticClass:"content-header"},[t._v("合同明细")]),a("div",{staticClass:"content-body"},[3===t.form.contract_type?a("div",[a("div",{staticClass:"content-line"},[a("div",{staticClass:"content-label"},[t._v("产品(采买渠道)：")]),a("div",{staticClass:"content-value"},[a("div",{staticClass:"selected-sale-chance-wrap"},t._l(t.selectedSaleChances,(function(e,s){return a("span",{key:s,staticClass:"selected-sale-chance"},[t._v(t._s(e.label)+" "),s!==t.selectedSaleChances.length-1?a("label",[t._v("、")]):t._e()])})),0)])]),a("div",{staticClass:"content-line"},[a("div",{staticClass:"content-label",staticStyle:{color:"#666"}},[t._v("数量：")]),a("div",{staticClass:"content-value"},[a("el-input",{staticClass:"short-input",attrs:{type:"number",placeholder:"请输入数量",size:"medium"},on:{input:function(e){return t.onlyPositiveInteger(e)}},nativeOn:{mousewheel:function(t){t.preventDefault()}},model:{value:t.form.num,callback:function(e){t.$set(t.form,"num",e)},expression:"form.num"}}),a("span",{staticClass:"short-label",staticStyle:{color:"#666"}},[t._v("标准单价：")]),a("el-input",{staticClass:"short-input",attrs:{type:"number",placeholder:"请输入标准单价",size:"medium"},on:{input:function(e){return t.form.price=t.getPositiveNumber(e)},blur:function(e){return 0===parseInt(e.target.value,10)?t.form.price="":t.form.price}},nativeOn:{mousewheel:function(t){t.preventDefault()}},model:{value:t.form.price,callback:function(e){t.$set(t.form,"price",e)},expression:"form.price"}})],1)]),a("div",{staticClass:"content-line"},[a("div",{staticClass:"content-label"},[t._v("单位：")]),a("div",{staticClass:"content-value"},[a("el-select",{staticClass:"short-input",attrs:{size:"medium",placeholder:"请选择单位"},model:{value:t.form.unit,callback:function(e){t.$set(t.form,"unit",e)},expression:"form.unit"}},[a("el-option",{attrs:{label:"场",value:1}}),a("el-option",{attrs:{label:"次",value:2}})],1),a("span",{staticClass:"short-label"},[t._v("折扣：")]),a("el-input",{staticClass:"short-input",attrs:{type:"number",placeholder:"请输入1-10之间的数字",size:"medium"},on:{blur:t.discountLimit,input:t.computeContractAmount},nativeOn:{mousewheel:function(t){t.preventDefault()}},model:{value:t.form.discount,callback:function(e){t.$set(t.form,"discount",e)},expression:"form.discount"}})],1)]),a("div",{staticClass:"content-line"},[a("div",{staticClass:"content-label"},[a("em",{directives:[{name:"show",rawName:"v-show",value:2!==this.form.contract_type,expression:"this.form.contract_type !== 2"}]},[t._v("*")]),t._v("合同金额： ")]),a("div",{staticClass:"content-value"},[a("el-input",{staticClass:"short-input",attrs:{type:"number",placeholder:"0.00",size:"medium"},on:{input:function(e){return t.form.contract_amount=t.getPositiveNumber(e)},blur:function(e){return 0===parseInt(e.target.value,10)?t.form.contract_amount="":t.form.contract_amount}},nativeOn:{mousewheel:function(t){t.preventDefault()}},model:{value:t.form.contract_amount,callback:function(e){t.$set(t.form,"contract_amount",e)},expression:"form.contract_amount"}})],1)])]):t._e(),a("div",{staticClass:"content-line"},[a("div",{staticClass:"content-label"},[t._v("合同附件单：")]),a("div",{staticClass:"content-value"},[[a("el-upload",{staticClass:"upload-btn-wrap",attrs:{action:"",disabled:5===t.form.attachment_url.length,"show-file-list":!1,multiple:!1,accept:".pdf,.docx,.doc,.jpg,.png,.jpeg,.xlsx,.xls","http-request":t.uploadAttachmentFile}},[a("el-button",{staticClass:"upload-btn btn-blue big-button",class:5===t.form.attachment_url.length?"upload-forbid":"",attrs:{loading:t.uploadAttachment.uploading,size:"small",type:"primary",disabled:t.no_upload_click}},[a("i",{staticClass:"iconfont icon-zhongxinshangchuan",staticStyle:{"font-size":"14px",top:"9px !important",left:"12px !important"}}),t._v("上传文件 ")])],1)],a("span",{staticClass:"upload-tips"},[t._v("最多上传5个文件（单个文件大小不超过30M），支持扩展名：.docx .doc .pdf .jpg .png .xlsx .xls")]),a("div",{staticClass:"uploaded-list"},t._l(this.form.attachment_url,(function(e,s){return a("p",{key:s,staticStyle:{"margin-right":"10px","line-height":"30px"}},[a("TgIcon",{staticStyle:{"margin-right":"5px"},attrs:{name:"ico-annex"}}),e?a("span",{staticClass:"uploaded-attachment-name"},[t._v(t._s(decodeURIComponent(e.split("/")[e.split("/").length-1]||"--")))]):t._e(),e?a("TgIcon",{staticStyle:{"margin-left":"15px"},attrs:{name:"ico-cross"},on:{click:function(e){return t.clearUploadedFile(s)}}}):t._e()],1)})),0)],2)])])]),3===t.form.contract_type?a("div",{staticClass:"box3"},[a("div",{staticClass:"content-header content-block-header"},[t._v("付款计划")]),a("div",{staticClass:"content-body"},[t._l(t.proceeds_plan,(function(e,s){return a("div",{key:s,staticClass:"line-status"},[a("div",[a("span",{staticClass:"body_label"},[t._v("付款金额：")]),a("el-input",{attrs:{placeholder:"0.00",size:"small"},model:{value:e.proceeds_amount,callback:function(a){t.$set(e,"proceeds_amount",a)},expression:"items.proceeds_amount"}})],1),a("div",[a("span",{staticClass:"body_label"},[t._v("已付金额：")]),a("el-input",{attrs:{placeholder:"0.00",size:"small"},model:{value:e.obtained_amount,callback:function(a){t.$set(e,"obtained_amount",a)},expression:"items.obtained_amount"}})],1),a("div",[a("span",{staticClass:"body_label"},[t._v("待付金额：")]),a("el-input",{attrs:{placeholder:"0.00",size:"small"},model:{value:e.to_obtain_amount,callback:function(a){t.$set(e,"to_obtain_amount",a)},expression:"items.to_obtain_amount"}})],1),a("div",[a("span",{staticClass:"body_label"},[t._v("已收发票金额：")]),a("el-input",{attrs:{placeholder:"0.00",size:"small"},model:{value:e.invoice_amount,callback:function(a){t.$set(e,"invoice_amount",a)},expression:"items.invoice_amount"}})],1),a("div",[a("span",{staticClass:"body_label"},[t._v("计划付款日期：")]),a("el-date-picker",{staticClass:"plan-date",attrs:{"value-format":"yyyy-MM-dd",type:"date",placeholder:"选择日期",size:"small"},model:{value:e.proceeds_plan_date,callback:function(a){t.$set(e,"proceeds_plan_date",a)},expression:"items.proceeds_plan_date"}})],1),a("span",{staticStyle:{color:"#f8fafc"}},[t._v(t._s(t.proceeds_plan.length))]),1!==t.proceeds_plan.length||t.isFirstDelete?a("div",{staticStyle:{position:"relative"}},[a("span",{staticClass:"delete_tr cctv",on:{click:function(e){return t.deleteTr(s)}}},[a("i",{staticClass:"el-icon-error",staticStyle:{color:"#ccc"}})])]):t._e()])})),a("div",{staticClass:"add_tr",on:{click:t.addTr}},[t._v("+ 点击添加")])],2)]):t._e()]),a("div",{staticClass:"footer"},[a("el-button",{staticClass:"close-btn",attrs:{size:"medium"},on:{click:function(e){t.visible=!1}}},[t._v("取消")]),a("el-button",{staticClass:"save-btn btn-blue",class:t.isSubmitForbid?"forbid-btn":"",staticStyle:{"margin-left":"20px"},attrs:{size:"medium",type:"primary",loading:this.uploadAttachment.uploading,disabled:t.isSubmitForbid},on:{click:t.handleSubmitSave}},[t._v(t._s(this.uploadAttachment.uploading?"附件上传中":(t.type,"提交")))])],1)])],1)},o=[],n=(a(26699),a(89935)),i=a(86863),c=a(83005),r=a(97484),l=a(76612),d=a(37808),m=a(62707),p=a(61282),u=a(1763),h=a(84731),_=a(41572),g=a(29625),f=a(93889),v=a(97434),b=a(48606),C={name:"AddContract",inject:["project_add_id","project"],props:{type:{type:String,default:"add"},getType:{type:Number,default:1}},conponents:{TgIcon:l.Z},setup(t,e){const a=(0,v.ref)(f.RJ.Sales),s=(0,v.ref)(g.kA.live),o=(0,h.f)();let n;o.isLegalSupplierContractDetail||o.isLegalCustomerContractDetail||o.isLegalStatisticsCustomerContractDetail||o.isLegalStatisticsSupplierContractDetail?a.value=f.RJ.Framework:o.isCommonBusinessDetail||o.isCommonBusinessCustomerContractDetail||o.isCommonBusinessSupplierContractDetail?(a.value=f.RJ.Purchase,s.value=g.kA.common_business):o.isLiveDetail?(a.value=f.RJ.Purchase,s.value=g.kA.live):o.isCoopSupplierContractDetail&&(a.value=f.RJ.SupplierFramework,s.value=g.kA.marketing);const i=()=>{n=b.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},c=()=>{n.close()};return{startLoading:i,closeLoading:c,project_contract_type:a,project_type:s,ContractType:f.RJ,ProjectTypeEnum:g.kA}},data(){return{isSubmitForbid:!1,parterDate:"",contract_type:1,no_upload_click:!1,CONSTRACT_APPROVER:m.Rs,visible:!1,saleChances:n.KL,planData:[],accountManager:[],department:[],approver:[],contract_uids:[],contractVal:"",saleChance:{checkAll:!1,isIndeterminate:!1},uploadAttachment:[],form:{frame_contract_uid:"",frame_contract_id:"",contract_uid:"",customer_name:"",contract_type:3,sale_chance:[],num:void 0,price:void 0,unit:1,discount:void 0,contract_amount:void 0,attachment_url:[],proceeds_plan:[{proceeds_plan_date:"",proceeds_amount:void 0,obtained_amount:void 0,to_obtain_amount:void 0,invoice_amount:void 0}],department:void 0,manager_id:void 0,company_name:void 0,partner_id:void 0,supplier_name:void 0,coop_start_date:"",coop_end_date:""},proceeds_plan:[{proceeds_plan_date:"",proceeds_amount:void 0,obtained_amount:void 0,to_obtain_amount:void 0,invoice_amount:void 0}],deletedPlans:[],approverList:[{id:6,username:""},{id:61,username:""},{id:74,username:""}],companyNameIsShow:!1,partnerOptions:[],isFirstDelete:!1,breadcrumb:(0,h.f)()}},watch:{proceeds_plan:{handler:function(t){if(1===this.proceeds_plan.length){let e=!1;const a=t[0];for(let t in a)if(a[t]){e=!0;break}this.isFirstDelete=e}},deep:!0}},computed:{selectedSaleChances(){const t=this.saleChances.filter((t=>!!this.form.sale_chance.find((e=>e===t.value))));return t}},methods:{getPositiveNumber:p.nA,addTr(){this.proceeds_plan.push({proceeds_plan_date:"",proceeds_amount:void 0,obtained_amount:void 0,to_obtain_amount:void 0,invoice_amount:void 0}),this.isFirstDelete=!1},deleteTr(t){this.proceeds_plan.splice(t,1),0===this.proceeds_plan.length&&this.addTr()},discountLimit(t){(t.currentTarget.value<1||t.currentTarget.value>10)&&(this.form.discount="")},changeContract(){this.form.frame_contract_uid=""},clearParterDate(){Object.assign(this.$data,this.$options.data())},changePartner(t){for(const e of this.partnerOptions)e.partner_id===t&&(this.form.supplier_name=e.partner_name)},show(t){if(this.no_upload_click=!1,"add"===this.type&&this.getContractNumber(),this.getAccountManager(),this.getApprover(),this.resetForm(),"edit"===this.type){if(!t)return!1;this.saleChance.checkAll=t.contract_info.sale_chance.length===n.KL.length,this.saleChance.isIndeterminate=t.contract_info.sale_chance.length!==n.KL.length&&0!==t.contract_info.sale_chance.length,this.uploadAttachment.file=t.contract_detail.attachment_url?{name:t.contract_detail.attachment_url.split("/")[t.contract_detail.attachment_url.split("/").length-1]}:null,this.getPartnerList(t.contract_info.company_name),this.form={contract_uid:t.contract_info.contract_uid,customer_name:t.contract_info.customer_name,contract_type:t.contract_info.contract_type,sale_chance:t.contract_info.sale_chance.map((t=>t.value)),num:t.contract_detail.num,price:t.contract_detail.price,unit:t.contract_detail.unit,discount:[0,"0","0.0","0.00"].includes(t.contract_detail.discount)?"":t.contract_detail.discount,contract_amount:t.contract_detail.contract_amount,attachment_url:""===t.contract_detail.attachment_url?[]:t.contract_detail.attachment_url.split(","),proceeds_plan:[],department:t.contract_info.department+"",manager_id:t.contract_info.manager_id,id:t.contract_info.id,partner_id:t.contract_info.company_id,project_id:t.contract_info.project_id},this.proceeds_plan=t.proceeds_plan.map((t=>({proceeds_plan_date:t.proceeds_plan_date_str,proceeds_amount:t.proceeds_amount,obtained_amount:t.obtained_amount,to_obtain_amount:t.to_obtain_amount,invoice_amount:t.invoice_amount,id:t.id}))),this.proceeds_plan.length||this.proceeds_plan.push({proceeds_plan_date:"",proceeds_amount:void 0,obtained_amount:void 0,to_obtain_amount:void 0,invoice_amount:void 0}),this.parterDate=[t.contract_info.coop_start_date,t.contract_info.coop_end_date],this.form.frame_contract_uid=t.contract_info.frame_contract_uid}else this.form.project_id=void 0;this.visible=!0,setTimeout((()=>{document.getElementsByClassName("dialog-content")[0]&&(document.getElementsByClassName("dialog-content")[0].scrollTop=0)}),100)},handleCheckAllChange(t){this.form.sale_chance=t?n.KL.map((t=>t.value)):[],this.saleChance.isIndeterminate=!1},handleCheckedSaleChanceChange(t){const e=t.length;this.saleChance.checkAll=e===n.KL.length,this.saleChance.isIndeterminate=e>0&&e<n.KL.length},getContract(t){this.contractVal=t;let e=this.project_type;(0,r.Sw)({partner_type:2,contract_status:2,contract_type:4,search:t,project_type:e}).then((({data:t})=>{this.$set(this,"contract_uids",t.data.data||[])}))},selectContractUidChange(t){this.contractVal="";const e=this.contract_uids.find((e=>e.contract_uid===t));e&&(this.form.frame_contract_uid=e.contract_uid,this.form.frame_contract_id=e.contract_id)},uploadAttachmentFile(t){if(5===this.form.attachment_url.length)return void this.$message.error("最多上传5个文件");if(t.file.size>31488e3)return void this.$message.error("单个文件大小不超过30M");this.startLoading();const e=new FormData;e.append("file",t.file,t.file.name),e.append("attachment_type","contract"),this.uploadAttachment.uploading=!0,this.uploadAttachment.file=t.file,(0,i.w_)(e).then((t=>{this.closeLoading(),t.data.success?(this.form.attachment_url.push(t.data.data.source),5===this.form.attachment_url.length?this.no_upload_click=!0:this.no_upload_click=!1):(this.uploadAttachment.file=null,this.$message({type:"warning",message:t.data.message,showClose:!0,duration:2e3})),this.uploadAttachment.uploading=!1})).catch((t=>{this.closeLoading(),this.$message({type:"warning",message:"上传失败，稍后重试",showClose:!0,duration:2e3}),this.uploadAttachment.uploading=!1,console.log(t.message)}))},clearUploadedFile(t){this.form.attachment_url.splice(t,1),this.no_upload_click=!1},addOnePlan(){this.proceeds_plan.push({proceeds_plan_date:"",proceeds_amount:void 0,obtained_amount:void 0,to_obtain_amount:void 0,invoice_amount:void 0})},handleDeletePlan(t){this.proceeds_plan[t].id&&(this.proceeds_plan[t].is_delete=1,this.deletedPlans.push(this.proceeds_plan[t])),this.proceeds_plan.splice(t,1)},onlyPositiveInteger(t){const e=t=>t.replace(/\D/g,"").replace(_.Pj,"");this.form.num=e(t)},computeContractAmount(){this.form.num<0&&setTimeout((()=>{this.form.num=void 0}),50),this.form.price<0&&setTimeout((()=>{this.form.price=void 0}),50),this.form.discount<0&&(setTimeout((()=>{this.form.discount=void 0}),50),this.$message({type:"warning",message:"折扣不能小于0"})),this.form.discount>10&&(setTimeout((()=>{this.form.discount=void 0}),50),this.$message({type:"warning",message:"折扣不能大于10"})),setTimeout((()=>{let t;this.form.num&&this.form.price&&!this.form.discount?t=this.form.num*this.form.price:this.form.num&&this.form.price&&this.form.discount&&(t=this.form.num*this.form.price*this.form.discount/10),this.form.contract_amount=t?t.toFixed(0):t}),50)},handleContractAmountChange(){this.form.contract_amount<0&&setTimeout((()=>{this.form.contract_amount=void 0}),50),this.form.discount=void 0},getAccountManager(){(0,i.Jv)({roles:d.b.customer_manager+","+d.b.major_customer_manager}).then((t=>{t.data.success?this.accountManager=t.data.data:this.$message({type:"warning",message:t.data.message,duration:2e3,showClose:!0})})).catch((t=>{this.$message({type:"error",message:"客户经理获取失败，稍后重试",duration:2e3,showClose:!0}),console.log(t.message)}))},getDepartment(){(0,i.iI)().then((t=>{if(t.data.success){this.department=[];for(const e in t.data.data)this.department.push({label:t.data.data[e],value:e})}else this.$message({type:"warning",message:t.data.message,duration:2e3,showClose:!0})})).catch((t=>{this.$message({type:"error",message:"部门获取失败，稍后重试",duration:2e3,showClose:!0}),console.log(t.message)}))},getApprover(){(0,i.Fn)().then((t=>{t.data.success?t.data.data.forEach((t=>{this.approverList=this.approverList.map((e=>(e.id===t.id&&(e.username=t.username),e)))})):this.$message({type:"warning",message:t.data.message,duration:2e3,showClose:!0})})).catch((t=>{this.$message({type:"error",message:"审批人获取失败，稍后重试",duration:2e3,showClose:!0}),console.log(t.message)}))},handleSubmitSave(){return this.form.partner_id?this.parterDate?(this.form.coop_start_date=this.parterDate[0],this.form.coop_end_date=this.parterDate[1],0===this.form.sale_chance.length?(this.$message({type:"warning",message:"请至少选择一个采买渠道",duration:2e3,showClose:!0}),document.getElementsByClassName("dialog-content")[0]&&(document.getElementsByClassName("dialog-content")[0].scrollTop=0),!1):this.form.contract_amount||2===this.form.contract_type||4===this.form.contract_type?("edit"===this.type?this.form.proceeds_plan=this.proceeds_plan.concat(this.deletedPlans):this.form.proceeds_plan=this.proceeds_plan,4===this.form.contract_type&&(this.form.frame_contract_uid="",this.form.frame_contract_id=""),this.isSubmitForbid=!0,void Promise.resolve().then((()=>this.project_type===this.ProjectTypeEnum.common_business?(0,c.ZS)({...this.form,project_id:(0,v.unref)(this.project_add_id)}):this.project_type===this.ProjectTypeEnum.marketing?(0,c.TG)({...this.form,cooperation_id:(0,v.unref)(this.project_add_id)}):(0,c.U9)({...this.form,project_id:(0,v.unref)(this.project_add_id)}))).then((t=>{t.data.success?(this.visible=!1,this.proceeds_plan=[{proceeds_plan_date:"",proceeds_amount:void 0,obtained_amount:void 0,to_obtain_amount:void 0,invoice_amount:void 0}],this.deletedPlans=[],this.$message({type:"success",message:t.data.message,duration:2e3,showClose:!0}),"add"===this.type&&this.$emit("added"),"edit"===this.type&&this.$emit("edited"),this.isSubmitForbid=!1):(this.$message({type:"warning",message:t.data.message,duration:2e3,showClose:!0}),this.isSubmitForbid=!1)})).catch((t=>{this.$message({type:"error",message:"合同保存失败，稍后重试",duration:2e3,showClose:!0}),console.log(t.message),this.isSubmitForbid=!1}))):(this.$message({type:"warning",message:"请输入合同金额",duration:2e3,showClose:!0}),!1)):(this.$message({type:"warning",message:"请选择时间",duration:2e3,showClose:!0}),!1):(this.$message({type:"warning",message:"请搜索并选择供应商",duration:2e3,showClose:!0}),document.getElementsByClassName("dialog-content")[0]&&(document.getElementsByClassName("dialog-content")[0].scrollTop=0),!1)},async getContractNumber(){Promise.resolve().then((()=>this.breadcrumb.isLiveDetail||this.breadcrumb.isCommonBusinessDetail?(0,i.LK)({business_type:this.project.value.business_type}):(this.breadcrumb.isCoopDetail,(0,i.XZ)()))).then((t=>{t.data.success?this.form.contract_uid=t.data.data:this.$message({type:"warning",message:t.data.message,duration:2e3,showClose:!0})})).catch((t=>{this.$message({type:"error",message:"合同编号获取失败，稍后重试",duration:2e3,showClose:!0}),console.log(t.message)}))},resetForm(t="",e=3){this.form={contract_uid:t,customer_name:"",contract_type:e,sale_chance:[],num:void 0,price:void 0,unit:1,discount:void 0,contract_amount:void 0,attachment_url:[],proceeds_plan:[{proceeds_plan_date:"",proceeds_amount:void 0,obtained_amount:void 0,to_obtain_amount:void 0,invoice_amount:void 0}],department:void 0,manager_id:void 0,company_name:void 0,partner_id:void 0},this.parterDate="",this.saleChance.checkAll=!1,this.saleChance.isIndeterminate=!1},getApproverUsername(t){return this.approverList.find((e=>e.id===t)).username},handleCustomerManagerSelectFocus(){0===this.accountManager.length&&this.getAccountManager()},handleCustomerManagerSelectChange(t){const e=this.accountManager.find((e=>e.id===t));this.form.department=e?e.department+"":void 0},handleAddCompanyNameClick(){this.visible=!1,this.$router.push({name:u.Z8.customer.list})},getPartnerList(t,e){""!==t&&void 0!==t&&(0,i.cQ)({partner_type:2,partner_name:t}).then((t=>{t.data.success?(this.partnerOptions=t.data.data,"edit"===this.type&&(this.form.supplier_name=this.partnerOptions[0].partner_name)):this.$message({type:"warning",message:t.data.message,duration:2e3,showClose:!0})}))}}},y=C,k=a(1001),x=(0,k.Z)(y,s,o,!1,null,"4e1c7277",null),w=x.exports}}]);
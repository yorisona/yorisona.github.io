"use strict";(self["webpackChunkgoumee_star_temp"]=self["webpackChunkgoumee_star_temp"]||[]).push([[8092],{58543:function(e,t,a){a.r(t),a.d(t,{default:function(){return fr}});var r,i,o=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-page-container tg-marketing-project-detail"},[a("TgBreadcrumbs",{attrs:{routes:e.routes}}),a("tg-card",{staticClass:"project-steps",attrs:{padding:[0,18,0,18]}},[a("tg-steps",{attrs:{steps:e.steps,active:e.stepActiveNumber}})],1),a("tg-card",{staticClass:"project-detail mgt-12",attrs:{padding:[6,0,0,0],overflowInBody:""}},[a("tg-tabs",{staticClass:"flex-none",attrs:{tabs:e.tabs,bottom:""},on:{change:e.onTabChange},model:{value:e.checkedTab,callback:function(t){e.checkedTab=t},expression:"checkedTab"}}),a(e.checkedTab,{tag:"component",staticClass:"component-container"})],1),a("AeDialogModal",{attrs:{visible:e.AeDialogVisible,ProjectAeList:e.ProjectAeList},on:{"dialog:close":e.onAeDialogModalClose}}),a("ProjectExecuteFinishModal",{attrs:{visible:e.ProjectExecuteFinishVisible},on:{"dialog:close":e.onProjectExecuteDialogModalClose}}),a("roll-back-project",{attrs:{visible:e.rollBackProjectVisible,projectInfo:e.rollBackProjectInfo},on:{"update:visible":function(t){e.rollBackProjectVisible=t},save:e.onProjectRollBackSave}})],1)},s=[],l=a(97434),n=a(23812),c=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-marketing-project-detail-info"},[a("div",{staticClass:"amount-stat-block"},[a("div",{staticClass:"amount-block"},[a("span",[e._v("销售金额")]),a("div",{staticClass:"amount"},[e._v(e._s(e.ProjectDetail.sale_amount_str))])]),a("div",{staticClass:"amount-block"},[a("span",{staticStyle:{display:"inline-block"}},[e._v("收款金额")]),a("div",{staticStyle:{display:"inline-block","margin-left":"5px"}},[a("el-popover",{attrs:{"popper-class":"question-tips-popper",placement:"top",trigger:"hover",content:"登记的业绩总金额减去退款金额"}},[a("template",{slot:"reference"},[a("tg-icon",{attrs:{name:"ico-question"}})],1)],2)],1),a("div",{staticClass:"amount"},[e._v(e._s(e.ProjectDetail.gather_amount_str))])]),a("div",{staticClass:"amount-block"},[a("span",{staticStyle:{display:"inline-block"}},[e._v("待收款金额")]),a("div",{staticStyle:{display:"inline-block","margin-left":"5px"}},[a("el-popover",{attrs:{"popper-class":"question-tips-popper",placement:"top",trigger:"hover",content:"销售金额减去收款金额"}},[a("template",{slot:"reference"},[a("tg-icon",{attrs:{name:"ico-question"}})],1)],2)],1),a("div",{staticClass:"amount"},[e._v(e._s(e.ProjectDetail.wait_gather_amount_str))])]),a("div",{staticClass:"amount-block"},[a("span",{staticStyle:{display:"inline-block"}},[e._v("成本安排金额 ")]),a("div",{staticStyle:{display:"inline-block","margin-left":"5px"}},[a("el-popover",{attrs:{"popper-class":"question-tips-popper",placement:"top",trigger:"hover",content:"登记的成本安排总金额"}},[a("template",{slot:"reference"},[a("tg-icon",{attrs:{name:"ico-question"}})],1)],2)],1),a("div",{staticClass:"amount"},[e._v(e._s(e.ProjectDetail.cost_amount_str))])]),a("div",{staticClass:"amount-block"},[a("span",{staticStyle:{display:"inline-block"}},[e._v("退款金额 ")]),a("div",{staticStyle:{display:"inline-block","margin-left":"5px"}},[a("el-popover",{attrs:{"popper-class":"question-tips-popper",placement:"top",trigger:"hover",content:"退款审批通过的退款金额"}},[a("template",{slot:"reference"},[a("tg-icon",{attrs:{name:"ico-question"}})],1)],2)],1),a("div",{staticClass:"amount"},[e._v(e._s(e.ProjectDetail.refund_total_amount_str))])])]),a("hr",{staticClass:"hr-line"}),a("div",{staticClass:"project-info-block"},[a("div",{staticClass:"project-info-title"},[e._v(" 项目名称："),a("DefText",{attrs:{content:e.ProjectDetail.cooperation_name}}),e._v("（"+e._s(e.ProjectDetail.cooperation_uid)+") "),e.Permission.canSaveProject?a("span",{staticStyle:{cursor:"pointer","margin-left":"30px",display:"inline-block"},on:{click:function(t){return e.toggleMarketingProjectModalVisible(!0)}}},[a("el-popover",{attrs:{"popper-class":"edit-btn-popper",placement:"top",trigger:"hover",content:"编辑"}},[a("template",{slot:"reference"},[a("tg-icon",{staticClass:"ico-edit-btn",staticStyle:{"font-size":"20px",width:"16px",height:"16px"},attrs:{name:"ico-edit"}})],1)],2)],1):e._e()],1),a("div",{staticClass:"project-info"},[a("div",{staticClass:"base-grid"},[a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("公司名称：")]),a("div",{staticClass:"base-grid-item-content",staticStyle:{cursor:"pointer"},on:{click:function(t){return e.jumptoCompanyDetailPage(e.ProjectDetail.company_id)}}},[a("el-popover",{attrs:{slot:"",placement:"top",trigger:"hover"},slot:"default"},[e.ProjectDetail.company_name?a("span",[e._v(" "+e._s(e.ProjectDetail.company_name)+" ")]):a("span",[e._v(" 店铺尚未关联到公司，请到"),a("a",{attrs:{href:"/customer/shop/"+e.ProjectDetail.customer_id,target:"_blank"}},[e._v("店铺详情")]),e._v("编辑，并关联到所属的公司 ")]),a("p",{staticClass:"line-clamp-1",staticStyle:{color:"#2877ff",cursor:"pointer"},attrs:{slot:"reference"},slot:"reference"},[e._v(" "+e._s(e.ProjectDetail.company_name||"--")+" ")])])],1)]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("所属部门：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.ProjectDetail.feishu_department_name))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("店铺名称：")]),a("div",{staticClass:"base-grid-item-content"},[a("el-popover",{attrs:{placement:"top",trigger:"hover",content:e.ProjectDetail.shop_name}},[a("p",{staticClass:"line-clamp-1",staticStyle:{cursor:"pointer"},attrs:{slot:"reference"},slot:"reference"},[e._v(" "+e._s(e.ProjectDetail.shop_name)+" ")])])],1)]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("客户经理：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.ProjectDetail.manager_name))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("合作类型：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.ProjectDetail.cooperation_type_str))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("客户类型：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.ProjectDetail.company_type_str))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("店铺类目：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.ProjectDetail.category_str))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("是否收款：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.ProjectDetail.is_gather_str))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("回款日期：")]),a("div",{staticClass:"base-grid-item-content"},[1===e.ProjectDetail.is_gather?a("span",[e._v("--")]):e._e(),0===e.ProjectDetail.is_gather?a("span",[e._v(e._s(e.ProjectDetail.gather_date_str))]):e._e()])])])])]),a("MarketingProjectDialog",{attrs:{title:"编辑项目",isEditForm:"",project:e.currentProject,visible:e.ProjectFormVisible},on:{"dialog:close":e.onProjectFormModalClose}})],1)},d=[],u=a(19397);(function(e){e[e["cooperation_name"]=1]="cooperation_name",e[e["shop_name"]=2]="shop_name",e[e["cooperation_uid"]=3]="cooperation_uid",e[e["customer_manager_name"]=4]="customer_manager_name",e[e["ae_name"]=5]="ae_name"})(r||(r={})),function(e){e[e["peer_org"]=1]="peer_org",e[e["ad_company"]=2]="ad_company",e[e["brand_tp"]=3]="brand_tp",e[e["direct_guest"]=4]="direct_guest"}(i||(i={}));const p=new Map([[i.peer_org,"同行机构"],[i.ad_company,"广告公司"],[i.brand_tp,"品牌TP"],[i.direct_guest,"直客"]]);var m;(function(e){e[e["general_customer"]=1]="general_customer",e[e["import_customer"]=2]="import_customer",e[e["strategic_customer"]=3]="strategic_customer",e[e["ka_customer"]=4]="ka_customer"})(m||(m={}));const _=new Map([[m.general_customer,"普通客户"],[m.import_customer,"重点客户"],[m.strategic_customer,"战略客户"],[m.ka_customer,"KA客户"]]);var v;(function(e){e[e["supplement_live"]=1]="supplement_live",e[e["refund"]=2]="refund",e[e["other"]=3]="other"})(v||(v={}));const f=new Map([[v.supplement_live,"补播"],[v.refund,"退款"],[v.other,"其他"]]);var g;(function(e){e[e["normal"]=1]="normal",e[e["unexpected"]=2]="unexpected"})(g||(g={}));var h=a(6933),y=a.n(h),b=a(76455),k=a(29625),w=a(61282),C=a(64236),x=a(74750),S=a(21757),j=a(78902);const D={headers:{Authorization:(0,x.LP)()??""}};var P,$=(0,l.defineComponent)({name:"MarketingProjectDetailInfo",components:{MarketingProjectDialog:u.Z},setup(e,t){const a=(0,l.ref)(!1),r=(0,l.inject)("MarketingProject")??(0,l.ref)(),i=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]),o=(0,l.computed)((()=>r.value)),s=(0,l.computed)((()=>{const e=(o.value?.plan??[]).map((e=>{const t=e.split("/")[e.split("/").length-1],a=t.split(".")[t.split(".").length-1];return{filename:t,icon:i.get(a)??"picture",filepath:e}}));return{...o.value,roi_str:o.value?.roi_str?o.value?.roi_str:"--",per_uv_str:o.value?.per_uv?o.value?.per_uv+"元/个":"--",per_pv_str:o.value?.per_pv?o.value?.per_pv+"元/个":"--",pv_str:o.value?.pv?o.value?.pv.toLocaleString("en-US"):"--",uv_str:o.value?.uv?o.value?.uv.toLocaleString("en-US"):"--",gmv_str:o.value?.gmv?(0,w.dN)(o.value?.gmv):"--",sale_amount_str:o.value?.sale_amount?(0,w.dN)(o.value?.sale_amount):"--",gather_amount_str:o.value?.gather_amount?(0,w.dN)(o.value?.gather_amount):"--",wait_gather_amount_str:o.value?.wait_gather_amount?(0,w.dN)(o.value?.wait_gather_amount):"--",refund_total_amount_str:o.value?.refund_total_amount?(0,w.dN)(o.value?.refund_total_amount):"--",cost_amount_str:o.value?.cost_amount?(0,w.dN)(o.value?.cost_amount):"--",budget_str:o.value?.budget?(0,w.dN)(o.value?.budget):"--",planList:e,aeList:o.value?.ae??[],manager_name:o.value?.manager_name??"--",cooperation_name:o.value?.cooperation_name,cooperation_uid:o.value?.cooperation_uid,cooperation_type_str:o.value?.cooperation_type.map((e=>b.lk.get(e)??"")).join("/"),shop_name:o.value?.shop_name,customer_class_str:_.get(o.value?.customer_class??0)??"--",category_str:k.Bs.get(o.value?.category??0)??"--",company_type_str:p.get(o.value?.company_type??0)??"--",is_gather_str:o.value?.is_gather?"是":"否",gather_date_str:o.value?.gather_date?y()(1e3*(o.value?.gather_date??0)).format("YYYY.MM.DD"):"--",company_name:o.value?.company_name,customer_id:o.value?.customer_id,note:o.value?.note?o.value?.note:"--",remark:o.value?.remark?o.value?.remark:"--"}})),n=async e=>{a.value=e},c=async e=>{a.value=!1,e&&t.emit("MarketProjectDetailReload")},d=async e=>{const a=decodeURIComponent(e.split("/")[e.split("/").length-1]);fetch(e,D).then((async e=>{const r=e.clone();try{const e=await r.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob();(0,C.uA)(t,a)}else t.root.$message.error("下载失败")}}))},u=e=>{const t="/customer/shop/"+e.toString();window.open(t)},m=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_save);return{canSaveProject:e}})),v=e=>{const t="/customer/company/"+e.toString();window.open(t)};return{Permission:m,jumptoShopDetailPage:u,downloadCaseBtnClick:d,ProjectDetail:s,currentProject:o,ProjectFormVisible:a,toggleMarketingProjectModalVisible:n,onProjectFormModalClose:c,jumptoCompanyDetailPage:v}}}),I=$,V=a(1001),R=(0,V.Z)(I,c,d,!1,null,null,null),M=R.exports,L=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("sub-tabs",[a("comp1",{attrs:{name:"应收"}}),a("comp2",{attrs:{name:"实收"}})],1)},F=[],A=a(58008),E=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-card",e._b({staticClass:"tg-marketing-project-tab-achievement flex-none",on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("div",{staticClass:"btns-line"},[a("label",[e._v("应收金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.moneyFormat(e.statInfo.receivable)))]),a("label",[e._v("已核销金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.moneyFormat(e.statInfo.write_off)))]),a("label",[e._v("未核销金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.moneyFormat(e.statInfo.not_write_off)))]),a("span",[e.isDev?a("tg-button",{on:{click:e.reload}},[e._v("刷新(开发环境)")]):e._e()],1)]),e.Permission.canViewList?a("el-table",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{stripe:"",border:"",data:e.data},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无数据"}})]},proxy:!0}],null,!1,2826547353)},"el-table",e.tableProps,!1),e._l(e.columns,(function(t,r){return a("el-table-column",e._b({key:r},"el-table-column",t,!1))})),1):e._e(),a("el-dialog",{staticClass:"tg-dialog-classic",attrs:{title:"发票详情",width:"440px",height:"600px",visible:e.invoiceDialogVisible},on:{close:e.closeInvoiceDialog}},[a("div",{staticClass:"incoice-dialog-content"},e._l(e.invoices,(function(t,r){return a("div",{key:r,staticClass:"incoice-item"},[a("div",{staticClass:"item-name"},[e._v("凭证"+e._s(r+1))]),a("div",{staticClass:"item-pic",on:{click:function(a){return e.showInvoicePic(t.pic_url)}}},[a("img",{attrs:{src:t.pic_url,alt:t.institution,loading:"lazy"}})]),a("div",{staticClass:"item item-num"},[a("label",[e._v("发票号码：")]),a("span",[e._v(e._s(t.invoice_num||"--"))])]),a("div",{staticClass:"item item-date"},[a("label",[e._v("开票日期：")]),a("span",[e._v(e._s(t.invoice_date||"--"))])]),a("div",{staticClass:"item item-amount"},[a("label",[e._v("开票金额：")]),a("span",[e._v(e._s(t.amount||"--"))])]),a("div",{staticClass:"item item-institution line-clamp-1"},[a("label",[e._v("开票公司：")]),a("span",[e._v(e._s(t.institution||"--"))])])])})),0)]),e.Permission.canChange?a("el-drawer",{attrs:{title:e.drawerTitle,height:"100vh",size:520,visible:e.drawerVisible,wrapperClosable:!1},on:{close:e.closeDrawer}},[a("div",{staticClass:"achievement-drawer-content",staticStyle:{"padding-top":"18px"}},[a("DrawerHeader",{attrs:{title:"客户信息"}}),a("DrawerCustomer",{attrs:{customerName:e.shop_name,customerManager:e.manager_name,companyName:e.company_name}}),a("div",{staticClass:"mgt-18"}),a("DrawerHeader",{attrs:{title:"业绩信息"}}),a("div",{staticStyle:{padding:"0 30px"}},[a("el-form",{ref:"formRef",staticClass:"el-form-vertical",staticStyle:{padding:"0"},attrs:{model:e.archievement_form,rules:e.formRules}},[a("el-form-item",{attrs:{label:"业绩名称",prop:"achievement_name"}},[a("el-input",{attrs:{size:"small",maxlength:15,placeholder:"请输入业绩名称"},model:{value:e.archievement_form.achievement_name,callback:function(t){e.$set(e.archievement_form,"achievement_name","string"===typeof t?t.trim():t)},expression:"archievement_form.achievement_name"}})],1),a("el-form-item",{attrs:{label:"收款类型",prop:"gather_type"}},[a("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:e.archievement_form.gather_type,callback:function(t){e.$set(e.archievement_form,"gather_type",t)},expression:"archievement_form.gather_type"}},e._l(e.gatherTypeOptions,(function(t){return a("el-radio",{key:t.value,attrs:{label:t.value}},[e._v(e._s(t.label))])})),1)],1),a("el-form-item",{attrs:{label:"关联合同",prop:"contract_id"}},[a("el-select",{staticStyle:{width:"100%"},attrs:{size:"small",placeholder:"请输入并选择合同编号",filterable:"",remote:"",clearable:"","remote-method":e.onContractSearch},on:{change:e.onContractChange},model:{value:e.contract_uid,callback:function(t){e.contract_uid="string"===typeof t?t.trim():t},expression:"contract_uid"}},e._l(e.contract_list,(function(e,t){return a("el-option",{key:t,attrs:{value:e.value,label:e.label}})})),1)],1),a("el-form-item",{attrs:{label:"收款金额",prop:"gather_amount"}},[a("el-input",{attrs:{size:"small",placeholder:"请输入收款金额"},on:{input:e.onInputGatherAmount},scopedSlots:e._u([{key:"append",fn:function(){return[e._v("元")]},proxy:!0}],null,!1,2167684048),model:{value:e.archievement_form.gather_amount,callback:function(t){e.$set(e.archievement_form,"gather_amount","string"===typeof t?t.trim():t)},expression:"archievement_form.gather_amount"}})],1),a("el-form-item",{staticStyle:{"margin-bottom":"6px"},attrs:{label:"收款方式",prop:"gather_way"}},[a("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:e.archievement_form.gather_way,callback:function(t){e.$set(e.archievement_form,"gather_way",t)},expression:"archievement_form.gather_way"}},e._l(e.gatherWayOptions,(function(t){return a("el-radio",{key:t.value,attrs:{label:t.value}},[e._v(e._s(t.label))])})),1)],1),1===e.archievement_form.gather_way?[a("div",{staticClass:"form-inner-block"},[a("el-form-item",{attrs:{label:"V任务ID",prop:"task_id"}},[a("el-input",{attrs:{size:"small",maxlength:50,placeholder:"请输入V任务ID"},model:{value:e.archievement_form.task_id,callback:function(t){e.$set(e.archievement_form,"task_id","string"===typeof t?t.trim():t)},expression:"archievement_form.task_id"}})],1),a("el-form-item",{attrs:{label:"下单旺旺名",prop:"order_wangwang_id"}},[a("el-input",{attrs:{size:"small",maxlength:50,placeholder:"请输入下单旺旺名"},model:{value:e.archievement_form.order_wangwang_id,callback:function(t){e.$set(e.archievement_form,"order_wangwang_id","string"===typeof t?t.trim():t)},expression:"archievement_form.order_wangwang_id"}})],1),a("el-form-item",{attrs:{label:"接单日期",prop:"order_date"}},[a("el-date-picker",{staticStyle:{width:"240px"},attrs:{placeholder:"请选择接单日期",type:"date",size:"small","value-format":"yyyy-MM-dd",format:"yyyy.MM.dd"},model:{value:e.archievement_form.order_date,callback:function(t){e.$set(e.archievement_form,"order_date",t)},expression:"archievement_form.order_date"}})],1)],1)]:[a("div",{staticClass:"form-inner-block"},[a("el-form-item",{staticStyle:{"grid-column-start":"1","grid-column-end":"3"},attrs:{label:"打款公司",prop:"pay_company_name"}},[a("el-input",{attrs:{size:"small",maxlength:50,placeholder:"请输入打款公司"},model:{value:e.archievement_form.pay_company_name,callback:function(t){e.$set(e.archievement_form,"pay_company_name","string"===typeof t?t.trim():t)},expression:"archievement_form.pay_company_name"}})],1)],1)],a("el-form-item",{staticStyle:{"margin-top":"18px"},attrs:{label:"收款凭证",prop:"gather_certificate_pic"}},[a("div",{staticClass:"pic-container"},[a("Upp",{attrs:{action:"",value:e.archievement_form.gather_certificate_pic,"http-request":e.uploadAttachmenFile},on:{remove:e.onPicRemove}}),a("span",{staticClass:"tips"},[e._v("支持扩展名：.jpg .jpeg .png")])],1)]),a("el-form-item",{attrs:{label:"是否开票",prop:"is_invoice"}},[a("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:e.archievement_form.is_invoice,callback:function(t){e.$set(e.archievement_form,"is_invoice",t)},expression:"archievement_form.is_invoice"}},[a("el-radio",{attrs:{label:1}},[e._v("是")]),a("el-radio",{attrs:{label:0}},[e._v("否")])],1)],1)],2)],1)],1),a("div",{staticClass:"el-drawer-footer"},[a("tg-button",{on:{click:e.closeDrawer}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.onSubmit}},[e._v("保存")])],1)]):e._e(),a("InvoiceDetail",{ref:"dialogRef"}),a("TgMaskLoading",{attrs:{content:"正在提交业绩，请稍候...",visible:e.submitLoading}}),a("TgMaskLoading",{attrs:{content:"正在删除业绩，请稍候...",visible:e.deleteLoading}}),a("first-step",{ref:"firstStepRef",on:{submit:e.reload}})],1)},N=[],T=a(89935),q=a(29210);a(21703);(function(e){e["AchievementGatherCertificate"]="certificate/achievement_gather_certificate",e["AchievementInvoiceCertificate"]="certificate/achievement_invoice_certificate",e["CostInvoiceCertificate"]="certificate/cost_invoice_certificate",e["CostPayCertificate"]="certificate/cost_pay_certificate",e["RebatePayCertificate"]="certificate/rebate_pay_certificate"})(P||(P={}));var z=a(88355),O=a(17352),W=a(83005),Z=a(41572);const B=e=>{const t=(0,l.ref)(!1),a=(e=!1)=>{t.value=e},r=()=>a(!0),i=(0,l.ref)(null),o=(0,l.ref)({achievement_name:"",gather_type:1,contract_id:"",gather_amount:"",gather_way:1,task_id:"",order_wangwang_id:"",order_date:"",is_invoice:1,gather_certificate_pic:"",pay_company_name:"",achievement_id:void 0,cooperation_id:""}),s=(0,l.computed)((()=>void 0===o.value.achievement_id?"登记业绩":"编辑业绩")),n=(0,l.inject)("MarketingProject");(0,l.watch)((()=>n?.value),(e=>{void 0!==e&&(o.value.cooperation_id=e.cooperation_id,o.value.contract_id=e.contract_id)})),(0,l.watch)((()=>t.value),(e=>{e&&i.value?.clearValidate()}));const c=()=>{o.value.achievement_name="",o.value.gather_type=1,o.value.gather_amount="",o.value.gather_way=1,o.value.task_id="",o.value.order_wangwang_id="",o.value.order_date="",o.value.is_invoice=1,o.value.gather_certificate_pic="",o.value.pay_company_name="",o.value.achievement_id=void 0,void 0!==n?.value?(o.value.cooperation_id=n.value.cooperation_id,o.value.contract_id=n.value.contract_id):(o.value.cooperation_id="",o.value.contract_id=""),_.value=""},d=e=>{o.value.achievement_id=e.achievement_id,o.value.achievement_name=e.achievement_name,o.value.gather_type=e.gather_type??T.hi.ServiceCharge,o.value.gather_amount=`${e.gather_amount}`,o.value.gather_way=e.gather_way,o.value.task_id=e.gather_way_detail.task_id,o.value.order_wangwang_id=e.gather_way_detail.order_wangwang_id,o.value.order_date=e.gather_way_detail.order_date,o.value.is_invoice=e.is_invoice,o.value.gather_certificate_pic=e.gather_certificate_pic,o.value.pay_company_name=e.gather_way_detail.pay_company_name,o.value.achievement_id=e.achievement_id,o.value.contract_id=e.contract_id??"",_.value=e.contract_uid??""},u=()=>{a(),c()};(0,l.watch)((()=>o.value.gather_way),((e,t)=>{e!==t&&i.value?.clearValidate(["task_id","order_wangwang_id","order_date","pay_company_name"])}));const p=(0,l.ref)({achievement_name:[{required:!0,message:"请输入业绩名称",trigger:"blur"}],gather_type:[{required:!0,message:"请选择收款类型",trigger:"blur"}],gather_amount:[{required:!0,message:"请输入收款金额",trigger:"blur"},{validator:(e,t,a)=>{const r=Z.vf.exec(t);null===r?a(new Error("请输入正数")):a()},trigger:"blur"}],gather_way:[{required:!0,message:"请选择收款方式",trigger:"blur"}],task_id:[{required:!0,message:"请输入V任务ID",trigger:"blur"}],order_wangwang_id:[{required:!0,message:"清输入下单旺旺名",trigger:"blur"}],order_date:[{required:!0,message:"请选择接单日期",trigger:"blur"}],pay_company_name:[{required:!0,message:"请输入打款公司",trigger:"blur"}],is_invoice:[{required:!0,message:"请选择是否开票",trigger:"blur"}]}),m=e=>{o.value.gather_amount=(0,w.nA)(e)},_=(0,l.ref)(""),v=(0,l.ref)([]),f=e=>{o.value.contract_id=e},g=async e=>{if(void 0===n?.value)return;const{data:t}=await(0,W.z0)({partner_type:1,contract_status:2,project_type:2,search:e});t.success&&(v.value=t.data.data.map((e=>({label:e.contract_uid,value:e.contract_id}))))},h=async t=>{const a=new FormData;a.append("file",t.file,t.file.name),a.append("type",P.AchievementGatherCertificate);const r=await(0,z.e)(a),{data:i}=r;return i.success?o.value.gather_certificate_pic=i.data.source:e.root.$message.error(i.message),r},y=()=>{o.value.gather_certificate_pic=""},b=(0,l.ref)(0),k=(0,l.ref)(!1),x=async()=>{const t=await new Promise((e=>{i.value?.validate((t=>{e(t)}))}));if(!t)return;const{achievement_id:a,contract_id:r,...s}=o.value;if(void 0===n?.value?.cooperation_id)return;const l={...s,contract_id:""===r?void 0:r,cooperation_id:n?.value?.cooperation_id};k.value=!0;const[{data:c}]=await Promise.all([await(0,O.iY)(void 0!==a?{...l,achievement_id:a}:l),await(0,C._v)(500)]);k.value=!1,c.success?(e.root.$message.success("登记业绩成功"),u(),b.value++):e.root.$message.error(c.message??"登记业绩失败")},S=(0,l.computed)((()=>n?.value?.shop_name??"--")),j=(0,l.computed)((()=>n?.value?.manager_name??"--")),D=(0,l.computed)((()=>n?.value?.company_name??"--"));return{shop_name:S,manager_name:j,company_name:D,drawerVisible:t,openDrawer:r,closeDrawer:u,archievement_form:o,drawerTitle:s,fillForm:d,formRef:i,formRules:p,onInputGatherAmount:m,uploadAttachmenFile:h,onPicRemove:y,onSubmit:x,submitSuccess:b,submitLoading:k,resetForm:c,contract_uid:_,contract_list:v,onContractChange:f,onContractSearch:g}};var Y=B,H=a(36568),U=a.n(H),G=(a(26699),a(49187)),K=a(64519),J=a(2698);const Q=new G.ZP,X=e=>""===e||void 0===e?"--":`￥${Q.format(e,G.WL.Yuan)}`,ee=e=>""===e||void 0===e?"--":`${Q.format(e,G.WL.Yuan)}`,te=e=>{const t=(0,l.inject)("MarketingProject"),a=(0,l.computed)((()=>{const a=e.root.$store.getters["user/getUserInfo"];return[t?.value?.add_by_id,t?.value?.manager_id].includes(a.id)})),r=(0,l.ref)(!1),i=(0,l.ref)([]),o=(0,l.ref)({write_off:0,receivable:0,not_write_off:0}),s=(0,l.ref)(0),n=(0,l.ref)({page_num:1,num:10}),c=(0,l.ref)(!1),d=(0,S.gI)(),u=(0,l.ref)([]),p=()=>{c.value=!1},m=(0,l.ref)(!1),_=(0,l.ref)(-1),v=()=>{_.value=-1},f=e=>null!==e.reversed_id||null!==e.refunded_id?{class:"reverse-red"}:{},g=(0,l.ref)(null),h=(0,l.ref)(void 0),b=e=>ee(e.receivable_amount),k=(0,l.computed)((()=>Math.max(...i.value.map((e=>(0,w.QN)(b(e)))),(0,w.QN)("应收金额 (元)"))+10)),x=(0,l.computed)((()=>[{label:"应收编号",fixed:"left",minWidth:150,formatter:e=>(0,l.h)("div",{class:"number-div"},[(0,l.h)("span",{class:"number-span "+(null!==e.reversed_id||null!==e.refunded_id?"reverse-red":"")},e.receivable_uid)])},{label:"应收金额 (元)",property:"gather_amount",align:"right",minWidth:k.value,formatter:e=>(0,l.h)("span",f(e),[b(e)])},{label:"创建日期",property:"create_date",align:"center",minWidth:110,formatter:e=>y()(e.create_date).format("YYYY.MM.DD")},{label:"结算单编号",property:"settlement_uid",minWidth:150,formatter:e=>(0,l.h)("div",{class:"number-div"},[(0,l.h)("span",{class:"number-span text "+(null!==e.reversed_id||null!==e.refunded_id?"reverse-red":"")},e.settlement_uid)])},{label:"核销状态",property:"write_off_status",align:"left",headerAlign:"left",minWidth:150,formatter:e=>{const t=(e.write_off_infos||[]).map((e=>[e.receipt_uid,e.write_off_amount,e.write_off_user,e.write_off_time]));(e.refund_write_off_infos||[]).forEach((e=>{t.push([e.cost_id,-1*(e.write_off_amount??0),e.write_off_user,e.write_off_time])}));const a=["单据编号","核销金额 (元)","核销人/日期"],r={attrs:{write_off_header:a,write_off_infos:t,write_off_status:e.write_off_status,is_reverse:null!==e.reversed_id}};return(0,l.h)(J.Z,U()([{},r]))}},{label:"操作",fixed:"right",minWidth:100,align:"center",formatter:e=>{const t=[],a=d.marketing_project_write_off_save;return e.refunded_id?"":(null===e.reversed_id&&(1!==e.write_off_status&&0!==e.write_off_status||!a||null!==e.reverse_id||t.push((0,l.h)("a",{on:{click:()=>{h.value?.show({type:"isReceivable",id:e.id,amount:e.not_write_off_amount,leaf:"coop",busType:e.receivable_type,receivable_uid:e.receivable_uid||e.achievement_uid})}}},["核销"]))),(0,l.h)("div",{class:"operation"},[t]))}}])),j=async e=>{r.value=!0;const[{data:t}]=await(0,C.Dc)(500,(0,O.UM)(e));r.value=!1,t.success?(i.value=t.data.data,s.value=t.data.total,o.value={not_write_off:t.data.not_write_off,receivable:t.data.receivable,write_off:t.data.write_off}):(i.value=[],s.value=0,o.value.not_write_off=0,o.value.receivable=0,o.value.write_off=0)},D=async(t=!0)=>{t&&(n.value.page_num=1);const a={receivable_type:1,project_id:parseInt(e.root.$route.params.id,10)};await j(a)};(0,l.onMounted)((()=>{D()}));const P=e=>{n.value.num=e,D()},$=e=>{n.value.page_num=e,D(!1)},I=e=>{K.Z.showDetail(e)};return{hasPermission:a,project:t,loading:r,data:i,statInfo:o,total:s,columns:x,reload:D,moneyFormat:X,deleteLoading:m,onPageSizeChange:P,onPageChange:$,queryForm:n,checkedRowIndex:_,clearCheckedRowIndex:v,invoiceDialogVisible:c,closeInvoiceDialog:p,invoices:u,showInvoicePic:I,dialogRef:g,firstStepRef:h}};var ae=te,re=a(39716),ie=a(31279),oe=a(58302),se=(0,l.defineComponent)({name:"TgMarketingProjectTabAchievement",data(){return{gatherTypeOptions:T.qw,gatherWayOptions:T.Fj,isDev:!1}},components:{Upp:q.Z,InvoiceDetail:re.Z,firstStep:ie.Z},setup(e,t){const{checkedRowIndex:a,clearCheckedRowIndex:r,...i}=ae(t),{submitSuccess:o,...s}=Y(t);(0,l.watch)((()=>o.value),((e,t)=>{e!==t&&i.reload()})),(0,l.watch)((()=>a.value),(e=>{-1===e||(s.fillForm(i.data.value[e]),s.openDrawer())})),(0,l.watch)((()=>s.drawerVisible.value),(e=>{e||r()}));const n=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_achievement_view),t=(0,S.kG)(j.HN.marketing_project_achievement_change);return{canChange:t,canViewList:e}})),c=0,d=0,u=36,p=31,m=(0,l.ref)(251),_=(0,oe.Z)({compensation:(0,l.computed)((()=>c+d+u+p)),fixedBlockHeightRefs:[m],tableMinHeight:100});return{Permission:n,...i,...s,..._}}}),le=se,ne=(0,V.Z)(le,E,N,!1,null,null,null),ce=ne.exports,de=function(){var e=this,t=this,a=t.$createElement,r=t._self._c||a;return r("tg-card",t._b({staticClass:"tg-marketing-project-tab-achievement flex-none",on:{"rect:update":t.onRectUpdate}},"tg-card",t.cardProps,!1),[r("div",{staticClass:"btns-line"},[r("label",[t._v("登记收款：")]),r("span",[t._v(t._s(t.moneyFormat(t.statInfo.total_gather_amount)))]),r("label",{staticClass:"mgl-18"},[t._v("确认收款：")]),r("span",[t._v(t._s(t.moneyFormat(t.statInfo.confirmed_gather_amount)))]),r("label",{staticClass:"mgl-18"},[t._v("等待确认：")]),r("span",[t._v(t._s(t.moneyFormat(t.statInfo.wait_gather_amount)))]),r("label",{staticClass:"mgl-18"},[t._v("已核销金额：")]),r("span",[t._v(t._s(t.moneyFormat(t.statInfo.write_off_amount)))]),r("label",{staticClass:"mgl-18"},[t._v("未核销金额：")]),r("span",[t._v(t._s(t.moneyFormat(t.statInfo.not_write_off_amount)))])]),t.Permission.canViewList?r("el-table",t._b({directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],attrs:{stripe:"",border:"",data:t.data},scopedSlots:t._u([{key:"empty",fn:function(){return[r("empty-common",{attrs:{"detial-text":"暂无数据"}})]},proxy:!0}],null,!1,2826547353)},"el-table",t.tableProps,!1),t._l(t.columns,(function(e,a){return r("el-table-column",t._b({key:a},"el-table-column",e,!1))})),1):t._e(),r("el-dialog",{staticClass:"tg-dialog-classic",attrs:{title:"发票详情",width:"440px",height:"600px",visible:t.invoiceDialogVisible},on:{close:t.closeInvoiceDialog}},[r("div",{staticClass:"incoice-dialog-content"},t._l(t.invoices,(function(e,a){return r("div",{key:a,staticClass:"incoice-item"},[r("div",{staticClass:"item-name"},[t._v("凭证"+t._s(a+1))]),r("div",{staticClass:"item-pic",on:{click:function(a){return t.showInvoicePic(e.pic_url)}}},[r("img",{attrs:{src:e.pic_url,alt:e.institution,loading:"lazy"}})]),r("div",{staticClass:"item item-num"},[r("label",[t._v("发票号码：")]),r("span",[t._v(t._s(e.invoice_num||"--"))])]),r("div",{staticClass:"item item-date"},[r("label",[t._v("开票日期：")]),r("span",[t._v(t._s(e.invoice_date||"--"))])]),r("div",{staticClass:"item item-amount"},[r("label",[t._v("开票金额：")]),r("span",[t._v(t._s(e.amount||"--"))])]),r("div",{staticClass:"item item-institution line-clamp-1"},[r("label",[t._v("开票公司：")]),r("span",[t._v(t._s(e.institution||"--"))])])])})),0)]),t.Permission.canChange?r("el-drawer",{attrs:{title:t.drawerTitle,height:"100vh",size:520,visible:t.drawerVisible,wrapperClosable:!1},on:{close:t.closeDrawer}},[r("div",{staticClass:"achievement-drawer-content",staticStyle:{"padding-top":"18px"}},[r("DrawerHeader",{attrs:{title:"客户信息"}}),r("DrawerCustomer",{attrs:{customerName:t.shop_name,customerManager:t.manager_name,companyName:t.company_name}}),r("div",{staticClass:"mgt-18"}),r("DrawerHeader",{attrs:{title:"业绩信息"}}),r("div",{staticStyle:{padding:"0 30px"}},[r("el-form",{ref:"formRef",staticClass:"el-form-vertical",staticStyle:{padding:"0"},attrs:{model:t.archievement_form,rules:t.formRules}},[r("el-form-item",{attrs:{label:"业绩名称",prop:"achievement_name"}},[r("el-input",{attrs:{size:"small",maxlength:15,placeholder:"请输入业绩名称"},model:{value:t.archievement_form.achievement_name,callback:function(e){t.$set(t.archievement_form,"achievement_name","string"===typeof e?e.trim():e)},expression:"archievement_form.achievement_name"}})],1),r("el-form-item",{attrs:{label:"收款类型",prop:"gather_type"}},[r("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:t.archievement_form.gather_type,callback:function(e){t.$set(t.archievement_form,"gather_type",e)},expression:"archievement_form.gather_type"}},t._l(t.gatherTypeOptions,(function(e){return r("el-radio",{key:e.value,attrs:{label:e.value}},[t._v(t._s(e.label))])})),1)],1),r("el-form-item",{attrs:{label:"关联合同",prop:"contract_id"}},[r("el-select",{staticStyle:{width:"100%"},attrs:{size:"small",placeholder:"请输入并选择合同编号",filterable:"",remote:"",clearable:"","remote-method":t.onContractSearch},on:{change:t.onContractChange},model:{value:t.contract_uid,callback:function(e){t.contract_uid="string"===typeof e?e.trim():e},expression:"contract_uid"}},t._l(t.contract_list,(function(e,t){return r("el-option",{key:t,attrs:{value:e.value,label:e.label}})})),1)],1),r("el-form-item",{attrs:{label:"收款金额",prop:"gather_amount"}},[r("el-input",{attrs:{size:"small",placeholder:"请输入收款金额"},on:{input:t.onInputGatherAmount},scopedSlots:t._u([{key:"append",fn:function(){return[t._v("元")]},proxy:!0}],null,!1,2167684048),model:{value:t.archievement_form.gather_amount,callback:function(e){t.$set(t.archievement_form,"gather_amount","string"===typeof e?e.trim():e)},expression:"archievement_form.gather_amount"}})],1),r("el-form-item",{staticStyle:{"margin-bottom":"6px"},attrs:{label:"收款方式",prop:"gather_way"}},[r("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:t.archievement_form.gather_way,callback:function(e){t.$set(t.archievement_form,"gather_way",e)},expression:"archievement_form.gather_way"}},t._l(t.gatherWayOptions,(function(e){return r("el-radio",{key:e.value,attrs:{label:e.value}},[t._v(t._s(e.label))])})),1)],1),1===t.archievement_form.gather_way?[r("div",{staticClass:"form-inner-block"},[r("el-form-item",{attrs:{label:"V任务ID",prop:"task_id"}},[r("el-input",{attrs:{size:"small",maxlength:50,placeholder:"请输入V任务ID"},model:{value:t.archievement_form.task_id,callback:function(e){t.$set(t.archievement_form,"task_id","string"===typeof e?e.trim():e)},expression:"archievement_form.task_id"}})],1),r("el-form-item",{attrs:{label:"下单旺旺名",prop:"order_wangwang_id"}},[r("el-input",{attrs:{size:"small",maxlength:50,placeholder:"请输入下单旺旺名"},model:{value:t.archievement_form.order_wangwang_id,callback:function(e){t.$set(t.archievement_form,"order_wangwang_id","string"===typeof e?e.trim():e)},expression:"archievement_form.order_wangwang_id"}})],1),r("el-form-item",{attrs:{label:"接单日期",prop:"order_date"}},[r("el-date-picker",{staticStyle:{width:"240px"},attrs:{placeholder:"请选择接单日期",type:"date",size:"small","value-format":"yyyy-MM-dd",format:"yyyy.MM.dd"},model:{value:t.archievement_form.order_date,callback:function(e){t.$set(t.archievement_form,"order_date",e)},expression:"archievement_form.order_date"}})],1)],1)]:[r("div",{staticClass:"form-inner-block"},[r("el-form-item",{staticStyle:{"grid-column-start":"1","grid-column-end":"3"},attrs:{label:"打款公司",prop:"pay_company_name"}},[r("el-input",{attrs:{size:"small",maxlength:50,placeholder:"请输入打款公司"},model:{value:t.archievement_form.pay_company_name,callback:function(e){t.$set(t.archievement_form,"pay_company_name","string"===typeof e?e.trim():e)},expression:"archievement_form.pay_company_name"}})],1)],1)],r("el-form-item",{staticStyle:{"margin-top":"18px"},attrs:{label:"收款凭证",prop:"gather_certificate_pic"}},[r("div",{staticClass:"pic-container"},[r("Upp",{attrs:{action:"",value:t.archievement_form.gather_certificate_pic,"http-request":t.uploadAttachmenFile},on:{remove:t.onPicRemove}}),r("span",{staticClass:"tips"},[t._v("支持扩展名：.jpg .jpeg .png")])],1)]),r("el-form-item",{attrs:{label:"是否开票",prop:"is_invoice"}},[r("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:t.archievement_form.is_invoice,callback:function(e){t.$set(t.archievement_form,"is_invoice",e)},expression:"archievement_form.is_invoice"}},[r("el-radio",{attrs:{label:1}},[t._v("是")]),r("el-radio",{attrs:{label:0}},[t._v("否")])],1)],1)],2)],1)],1),r("div",{staticClass:"el-drawer-footer"},[r("tg-button",{on:{click:t.closeDrawer}},[t._v("取消")]),r("tg-button",{attrs:{type:"primary"},on:{click:t.onSubmit}},[t._v("保存")])],1)]):t._e(),r("TgMaskLoading",{attrs:{content:"正在提交业绩，请稍候...",visible:t.submitLoading}}),r("TgMaskLoading",{attrs:{content:"正在删除业绩，请稍候...",visible:t.deleteLoading}}),r("first-step",{ref:"firstStepRef",on:{submit:t.reload}}),r("reverseOrderDialog",{ref:"reverseOrderDialogRef"}),r("tg-mask-loading",{attrs:{visible:t.reverseLoading,content:"正在提交冲销，请稍候..."}}),r("tg-mask-loading",{attrs:{visible:t.reverseAgainLoading,content:"正在重新提交冲销，请稍候..."}}),r("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",attrs:{visible:t.reasonDialogVisible,width:"440px"},on:{close:t.onReasonDialogClose},scopedSlots:t._u([{key:"title",fn:function(){return[t._v(t._s(t.reasonDialogTitle))]},proxy:!0}])},[r("div",{staticClass:"reason-dialog-content"},[t._v(t._s(t.reason))])]),t.refundDialogVisible?r("refundDialog",{attrs:{visible:t.refundDialogVisible,row:t.refundRow},on:{"dialog:close":t.onRefundDialogClose}}):t._e(),r("InvoicesDetail",{ref:"dialogRef",on:{close:t.onInvoicingDetailClose,"reload:invoices":function(e){return t.triggerReload("invoices")}}}),r("refund-write-off",{attrs:{type:"pay",notWriteOffAmount:t.refundWriteOffAmount,refund_cost_id:t.refundWriteOffId,achievement_id:t.refundWriteOffAchievementId,visible:t.refundWriteOffVisible},on:{cancel:function(){return t.refundWriteOffVisible=!1},save:t.onRefundWriteOffSave}}),r("achievement",{ref:"achievementRef",on:{ok:function(){e.reload()}}})],1)},ue=[],pe=a(57325),me=a(50585),_e=a(82741),ve=a(1763),fe=a(58861),ge=a(42386),he=a(28348),ye=a(85937),be=a.n(ye),ke=a(67578),we=a(51351);const Ce=e=>""===e||void 0===e?"--":`￥${(0,w.SJ)(new(be())(e))}`,xe=e=>""===e||void 0===e?"--":`${(0,w.SJ)(new(be())(e))}`,Se=e=>{const t=(0,l.inject)("MarketingProject"),a=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_achievement_change);return{canChange:e}})),r=(0,l.ref)(void 0),i=(0,l.computed)((()=>e.root.$store.state.workbench)),o=(0,l.computed)((()=>i.value.approval)),s=(0,l.computed)((()=>{const a=e.root.$store.getters["user/getUserInfo"];return[t?.value?.add_by_id,t?.value?.manager_id].includes(a.id)})),n=t=>{const a=e.root.$store.getters["user/getUserInfo"];return[t.add_by_id].includes(a.id)},c=async(t,a)=>{const{data:r}=await(0,we.OC)({approval_id:""===t?void 0:t,approval_uid:a});return r.success?e.root.$store.dispatch("workbench/setApproval",r.data):e.root.$message.error(r.message??"获取审批详情失败"),r.data},d=(0,l.ref)(!1),u=(0,l.ref)([]),p=(0,l.ref)({confirmed_gather_amount:0,total_gather_amount:0,wait_gather_amount:0,write_off_amount:0,not_write_off_amount:0}),m=(0,l.ref)(0),_=(0,l.ref)(void 0),v=(0,l.ref)(void 0),f=(0,l.ref)(void 0),g=(0,l.ref)(!1),h=(0,l.ref)({page_num:1,num:10}),b=e=>{const t=[(0,l.h)("label",["下单旺旺名："]),(0,l.h)("span",[e.gather_way_detail.order_wangwang_id]),(0,l.h)("label",["任务ID："]),(0,l.h)("span",[e.gather_way_detail.task_id]),(0,l.h)("label",["接单日期："]),(0,l.h)("span",[e.gather_way_detail.order_date?y()(e.gather_way_detail.order_date).format("YYYY.MM.DD"):"--"])],a=[(0,l.h)("label",["打款公司名称："]),(0,l.h)("span",[e.gather_way_detail.pay_company_name?e.gather_way_detail.pay_company_name:"--"])];return(0,l.h)("div",{style:"padding-left:10px"},[(0,l.h)("div",{class:"account-info",style:"width:100px;text-align:left"},[(0,l.h)("label",["方式："]),(0,l.h)("span",[(0,me.rN)(e.gather_way)])]),(0,l.h)("div",{class:"account-info",style:"width:100px;text-align:left"},[(0,l.h)("label",["详情："]),(0,l.h)("el-popover",{attrs:{placement:"bottom-start",trigger:"hover","popper-class":"achievement-popover"}},[(0,l.h)("a",{slot:"reference"},["预览"]),(0,l.h)("div",{class:"achievement-popover-content"},[(0,l.h)("div",{class:"account-info-grid"},[(0,l.h)("label",["方式："]),(0,l.h)("span",[(0,me.rN)(e.gather_way)]),1===e.gather_way?t:a])])])])])},k=(0,l.ref)(!1),w=(0,l.ref)(!1),x=(0,l.ref)({achievement_uid:"",achievement_id:"",project_name:"",gather_amount:0,project_id:"",business_type:""}),D=e=>{x.value.achievement_uid=e.achievement_uid,x.value.achievement_id=e.achievement_id,x.value.project_name=e.project_name,x.value.gather_amount=e.gather_amount,x.value.project_id=e.project_id,x.value.business_type=e.business_type,w.value=!0},P=()=>{x.value.achievement_uid="",x.value.achievement_id="",x.value.project_name="",x.value.gather_amount=0,x.value.project_id="",x.value.business_type="",w.value=!1,le()},$=(0,l.ref)([]),I=(0,l.ref)(void 0),V=(0,S.gI)(),R=e=>{$.value=e.invoice_info.map((e=>({...e,pic_url:(0,pe.W)(e.pic_url,!1)}))),k.value=!0},M=()=>{k.value=!1},L=e=>(0,l.h)("div",{style:"padding-left:10px"},[(0,l.h)("div",{class:"account-info",style:"width:100px;text-align:left"},[(0,l.h)("label",["开票："]),(0,l.h)("span",[0===e.is_invoice?"否":1===e.is_invoice?"是":"--"])]),(0,l.h)("div",{class:"account-info",style:"width:100px;text-align:left"},[(0,l.h)("label",["凭证："]),e.invoice_info.length>0?(0,l.h)("tg-button",U()([{attrs:{type:"link"}},{on:{click:()=>{R(e)}}}]),["查看"]):(0,l.h)("span",["--"])])]),F=(0,l.ref)(!1),A=async(t,a="确认删除该业绩？")=>{const r=await(0,_e.I)(e,a);if(!r)return;const{achievement_id:i,achievement_uid:o}=t;F.value=!0;const[{data:s}]=await Promise.all([await(0,O.eV)({achievement_id:i}),await(0,C._v)(500)]);F.value=!1,s.success?(e.root.$message.success(`${o}删除成功`),le()):e.root.$message.error(s.message??`${o}删除失败`)},E=(0,l.ref)(-1),N=()=>{E.value=-1},q=t=>{if(null===t)return;const{href:a}=e.root.$router.resolve({name:ve.l6.contracts.customer.detail,params:{id:`${t}`}});window.open(a)},z=(0,l.ref)(null),W=(0,l.ref)(null),{visible:Z,toggleVisible:B}=(0,fe.Z)(),Y=async(t,a)=>{B();const[{data:r}]=await(0,C.Dc)(500,(0,ge.Tu)({id:t.achievement_id,reverse_type:he.Jd.receive,reverse_reason:a}));return B(),r.success?(e.root.$message.success(r.message??"发起冲销成功"),le()):e.root.$message.error(r.message??"发起冲销失败"),r.success},{visible:H,toggleVisible:G}=(0,fe.Z)(),Q=async(t,a)=>{G();const[{data:r}]=await(0,C.Dc)(500,(0,ge.Xz)({id:t.achievement_id,reverse_type:he.Jd.receive,reverse_reason:a}));return G(),r.success?(e.root.$message.success(r.message??"重新提交成功"),le()):e.root.$message.error(r.message??"重新提交成功"),r.success},X=(0,l.ref)(!1),ee=(0,l.ref)(""),te=(0,l.ref)(""),ae=()=>{ee.value="",X.value=!1},re=e=>{te.value="退回原因",ee.value=e.reverse_back_reason,X.value=!0},ie=e=>{te.value="冲销原因",ee.value=e.reverse_reason,X.value=!0},oe=(0,l.computed)((()=>[{label:"收款编号/名称",property:"achievement_uid",align:"left",headerAlign:"left",fixed:"left",minWidth:150,formatter:e=>(0,l.h)("div",[(0,l.h)("div",{class:["color-primary",null!==e.reversed_id?"reverse-red":""]},[e.achievement_uid]),(0,l.h)("div",{class:"color-secordary",style:"line-height:15px"},[e.achievement_name])])},{label:"收款类型",property:"gather_type",align:"center",width:80,formatter:e=>{if(null===e.gather_type)return"--";{const t=T.bM.get(e.gather_type)??T.bM.get(T.hi.ServiceCharge);return null!==e.reversed_id?(0,l.h)("div",{class:"reverse-red"},["冲销"]):t}}},{label:"收款金额 (元)",property:"gather_amount",align:"right",headerAlign:"right",minWidth:120,labelClassName:"gather_amount-th",renderHeader:()=>(0,l.h)("el-popover",{attrs:{trigger:"hover",placement:"top",content:"如发生退款，该字段为减去退款金额后的实际收款金额","popper-class":"gather_amount-popover",disabled:!1}},[(0,l.h)("div",{slot:"reference",style:"height: 20px;line-height:20px"},[(0,l.h)("span",["收款金额 (元)"])])]),formatter:e=>(0,l.h)("span",{class:null!==e.reversed_id?"reverse-red":""},[xe(e.gather_amount)])},{label:"收款账户",property:"gather_way",align:"center",minWidth:120,formatter:b},{label:"退款金额 (元)",property:"refund_amount",align:"right",headerAlign:"right",minWidth:120,formatter:e=>xe(e.refund_amount)},{label:"登记成本金额 (元)",property:"total_pay_amount",align:"right",headerAlign:"right",minWidth:124,formatter:e=>xe(e.total_pay_amount)},{label:"已付成本金额 (元)",property:"total_paid_amount",align:"right",headerAlign:"right",minWidth:124,formatter:e=>xe(e.total_paid_amount)},{label:"收款凭证",property:"gather_certificate_pic",align:"center",headerAlign:"center",width:80,formatter:e=>""===e.gather_certificate_pic?"--":(0,l.h)("tg-button",{props:{type:"link"},on:{click:()=>{K.Z.showDetail((0,pe.W)(e.gather_certificate_pic,!1))}}},["查看"])},{label:"是否开票",property:"is_invoice",align:"center",width:94,formatter:L},{label:"关联单据",property:"contract_id",align:"left",headerAlign:"left",minWidth:238,formatter:e=>(0,l.h)("div",[(0,l.h)("div",{class:"account-info"},[(0,l.h)("label",["关联合同："]),e.contract_id?(0,l.h)("span",U()([{class:"hover-link"},{on:{click:()=>q(e.contract_id)}}]),[e.contract_uid]):(0,l.h)("span",["--"])]),(0,l.h)("div",{class:"account-info"},[(0,l.h)("label",["开票审批："]),(0,l.h)("span",U()([{class:"hover-link"},{on:{click:async()=>{o.value||await c("",e.approval_uid),e.invoice_apply_id&&z.value?.show(o.value)}}}]),[e.approval_uid??"--"])])])},{label:"财务确认信息",property:"is_gather",align:"left",headerAlign:"left",minWidth:150,formatter:e=>{const{is_gather:t,gather_way:a,gather_confirm_detail:r}=e;if(1===t){const e=[(0,l.h)("div",{class:"account-info"},[(0,l.h)("label",["状态："]),(0,l.h)("span",["已确认"])])];return null!==r&&(e.push((0,l.h)("div",{class:"account-info"},[(0,l.h)("label",["收款日期："]),(0,l.h)("span",[r.order_date])])),1!==a&&e.push((0,l.h)("div",{class:"account-info"},[(0,l.h)("label",["详情："]),(0,l.h)("el-popover",{attrs:{placement:"bottom-start",trigger:"hover","popper-class":"achievement-popover"}},[(0,l.h)("a",{slot:"reference"},["预览"]),(0,l.h)("div",{class:"achievement-popover-content"},[(0,l.h)("div",{class:"account-info-grid"},[(0,l.h)("label",["收款日期："]),(0,l.h)("span",[r.order_date]),(0,l.h)("label",["名称："]),(0,l.h)("span",[r.pay_company_name]),(0,l.h)("label",["账号："]),(0,l.h)("span",[r.account]),3===a?(0,l.h)("label",["开户行"]):"",3===a?(0,l.h)("span",[r.bank_of_deposit]):""])])])]))),(0,l.h)("div",[e])}return(0,l.h)("span",{style:"color: #ff7a36"},["待确认"])}},{label:"核销状态",property:"is_gather",align:"left",headerAlign:"left",width:120,formatter:e=>{let t=[];t=5===Number(e.gather_type)?(e.refund_write_off_info_items||[]).map((e=>[e.settlement_uid,e.payable_uid,-1*e.write_off_amount,e.write_off_user,e.write_off_time])):(e.write_off_infos||[]).map((e=>[e.settlement_uid,e.receivable_uid,e.write_off_amount,e.write_off_user,e.write_off_time]));const a=["结算单编号",5===Number(e.gather_type)?"应付编号":"应收编号","核销金额 (元)","核销人/日期"];return(0,l.h)(J.Z,{attrs:{write_off_header:a,write_off_infos:t,write_off_status:5===Number(e.gather_type)?e.refund_write_off_status:e.write_off_status,is_reverse:null!==e.reversed_id}})}},{label:"冲销状态",align:"center",minWidth:80,formatter:e=>{const{reverse_status:t}=e,a=ke.h0.wait_confirm===t?"fg-waiting":t===ke.h0.refused?"fg-failure":"";return(0,l.h)("span",{class:a},ke.LQ.get(t)??"--")}},{label:"录入人/日期",property:"gmt_create",align:"left",headerAlign:"left",width:102,formatter:(e,t,a)=>(0,l.h)("div",{class:"table_achievement"},[(0,l.h)("div",{class:"color-primary"},[e.add_by]),(0,l.h)("div",{class:"color-secordary"},[y()(a).format("YYYY.MM.DD")])])},{label:"操作",align:"left",headerAlign:"left",fixed:"right",minWidth:160,formatter:t=>{if(!a.value.canChange)return"";const i=1===t.is_gather&&(1===t.gather_type||2===t.gather_type||3===t.gather_type),o=0===t.invoice_info.length&&void 0===t.gather_confirm_detail?.order_date&&(s.value||n(t)),c=[];if(null===t.reversed_id){null!==t.reverse_id||1!==t.is_gather||5===t.gather_type||t.has_refund||c.push((0,l.h)("a",U()([{class:"reverse-red"},{on:{click:()=>{W.value?.open((e=>Y(t,e)))}}}]),["冲销"]));const a=V.marketing_project_write_off_save;null!==t.reverse_id||1!==t.write_off_status&&0!==t.write_off_status||!a||1===t.is_gather&&5!==Number(t.gather_type)&&c.push((0,l.h)("a",{on:{click:()=>{I.value?.show({type:"isActualIncome",id:t.achievement_id,amount:t.not_write_off_amount,leaf:"coop",busType:t.business_type,receivable_uid:t.achievement_uid})}}},["核销"])),t.is_gather||!s.value&&!n(t)||c.push((0,l.h)("tg-button",{attrs:{type:"link"},on:{click:()=>{const a={achievement_name:t.achievement_name,gather_type:t.gather_type,gather_amount:t.gather_amount,gather_way:t.gather_way,contract_id:t.contract_id,is_invoice:t.is_invoice,invoice_apply_id:t.invoice_apply_id,achievement_id:t.achievement_id,id:t.settlement_id,revenue_flow_id:t.revenue_flow_id},i=t.gather_way_detail;if(i&&(a.order_date=i.order_date,a.order_wangwang_id=i.order_wangwang_id,a.task_id=i.task_id,a.pay_company_name=i.pay_company_name),t.gather_certificate_pic){const e=new RegExp("\\/([^\\/]+)$"),r=e.exec(t.gather_certificate_pic);let i;r&&(i=r[1]),a.gather_certificate_pic={name:i,value:t.gather_certificate_pic}}t.contract_id&&(a.search_contract_list_value=[{label:t.contract_uid,value:t.contract_id}]),t.invoice_apply_id&&(a.search_invoice_apply_value=[{label:t.approval_uid,value:t.invoice_apply_id}]);const o="CommonBusinessProjectDetail"===e.root.$route.name,s="SSLiveProjectDetail"===e.root.$route.name,l="MarketingProjectDetail"===e.root.$route.name;r.value?.show(a,{isMcn:o,isBrand:s,isMarketing:l})}}},["编辑"])),o&&c.push((0,l.h)("a",{key:"b",on:{click:()=>A(t)}},["删除"]))}else ke.h0.wait_confirm===t.reverse_status||ke.h0.confirmed===t.reverse_status?c.push((0,l.h)("a",U()([{},{on:{click:()=>{ie(t)}}}]),["查看"])):(s.value&&(c.push((0,l.h)("a",{on:{click:()=>A(t,"是否删除该冲销单？")}},["删除"])),c.push((0,l.h)("a",U()([{},{on:{click:()=>{W.value?.open((e=>Q(t,e)),t.reverse_reason)}}}]),["重新提交"]))),c.push((0,l.h)("a",U()([{},{on:{click:()=>{re(t)}}}]),["退回原因"])));return i&&!t.reverse_id&&c.push((0,l.h)("a",U()([{},{on:{click:()=>{D(t)}}}]),["退款"])),!t.is_gather||5!==Number(t.gather_type)||t.reverse_id||t.reversed_id||2===t.refund_write_off_status||c.push((0,l.h)("tg-button",{attrs:{type:"link"},on:{click:()=>{_.value=new(be())(t.gather_amount?t.gather_amount:0).sub(new(be())(t.refund_write_off_amount?t.refund_write_off_amount:0)).toNumber(),v.value=t.refund_cost_id,f.value=t.achievement_id,g.value=!0}}},["核销"])),(0,l.h)("div",{class:"operation"},[c])}}])),se=async e=>{d.value=!0;const{data:t}=await(0,O.T)(e);d.value=!1,t.success?(u.value=t.data.data,m.value=t.data.total,p.value=t.data.stat_info):(u.value=[],m.value=0,p.value.confirmed_gather_amount=0,p.value.total_gather_amount=0,p.value.wait_gather_amount=0,p.value.write_off_amount=0,p.value.not_write_off_amount=0)},le=async(t=!0)=>{t&&(h.value.page_num=1);const a={cooperation_id:parseInt(e.root.$route.params.id,10)};await se(a)};(0,l.onMounted)((()=>{le()}));const ne=e=>{h.value.num=e,le()},ce=e=>{h.value.page_num=e,le(!1)},de=e=>{K.Z.showDetail(e)},ue=()=>{console.log("关闭")},ye=()=>{le()};return{hasPermission:s,project:t,triggerReload:ye,onInvoicingDetailClose:ue,loading:d,data:u,statInfo:p,total:m,columns:oe,reload:le,moneyFormat:Ce,deleteLoading:F,onPageSizeChange:ne,onPageChange:ce,queryForm:h,checkedRowIndex:E,clearCheckedRowIndex:N,invoiceDialogVisible:k,closeInvoiceDialog:M,invoices:$,showInvoicePic:de,dialogRef:z,firstStepRef:I,reverseOrderDialogRef:W,reverseLoading:Z,reverseAgainLoading:H,reasonDialogVisible:X,reason:ee,reasonDialogTitle:te,onReasonDialogClose:ae,refundDialogVisible:w,onRefundDialogClose:P,refundRow:x,refundWriteOffAmount:_,refundWriteOffId:v,refundWriteOffAchievementId:f,refundWriteOffVisible:g,achievementRef:r}};var je=Se,De=a(33018),Pe=a(10114),$e=a(6283),Ie=a(79546),Ve=a(98560),Re=(0,l.defineComponent)({name:"TgMarketingProjectTabAchievement",data(){return{gatherTypeOptions:T.qw,gatherWayOptions:T.Fj}},components:{Upp:q.Z,InvoiceDetail:re.Z,InvoicesDetail:De.Z,firstStep:ie.Z,reverseOrderDialog:Pe.Z,refundDialog:$e.Z,RefundWriteOff:Ie.Z,achievement:Ve.Z},setup(e,t){const{checkedRowIndex:a,clearCheckedRowIndex:r,...i}=je(t),{submitSuccess:o,...s}=Y(t);(0,l.watch)((()=>o.value),((e,t)=>{e!==t&&i.reload()})),(0,l.watch)((()=>a.value),(e=>{-1===e||(s.fillForm(i.data.value[e]),s.openDrawer())})),(0,l.watch)((()=>s.drawerVisible.value),(e=>{e||r()}));const n=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_achievement_view),t=(0,S.kG)(j.HN.marketing_project_achievement_change);return{canChange:t,canViewList:e}})),c=0,d=0,u=36,p=31,m=(0,l.ref)(251),_=(0,oe.Z)({compensation:(0,l.computed)((()=>c+d+u+p)),fixedBlockHeightRefs:[m],tableMinHeight:100}),v=()=>{i.refundWriteOffVisible.value=!1,i.reload()};return{Permission:n,...i,...s,..._,onRefundWriteOffSave:v}}}),Me=Re,Le=(0,V.Z)(Me,de,ue,!1,null,null,null),Fe=Le.exports,Ae=(0,l.defineComponent)({components:{SubTabs:A.Z,comp1:ce,comp2:Fe}}),Ee=Ae,Ne=(0,V.Z)(Ee,L,F,!1,null,null,null),Te=Ne.exports,qe=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-card",e._b({staticClass:"tg-marketing-project-tab-ae flex-none",on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("div",{staticStyle:{padding:"0"}},[e.aeList.length>0?a("tg-label-group",{attrs:{options:e.aeOptions,label:"指定AE"},model:{value:e.queryForm.ae_id,callback:function(t){e.$set(e.queryForm,"ae_id",t)},expression:"queryForm.ae_id"}}):a("div",{staticStyle:{"font-size":"14px",color:"#333",padding:"12px 0"}},[e._v("尚未添加AE")]),a("el-divider")],1),a("div",{staticClass:"btns-line"},[e.Permission.canChange&&e.isAE?a("tg-button",{staticClass:"mgr-24",attrs:{type:"primary",icon:"ico-btn-add"},on:{click:e.openDrawer}},[e._v("登记跟单")]):e._e(),a("label",[e._v("实际跟单金额：")]),a("span",[e._v(e._s(e.documentary_amount_format(e.statInfo.act_documentary_amount)))]),a("label",{staticClass:"mgl-24"},[e._v("预计跟单金额：")]),a("span",[e._v(e._s(e.documentary_amount_format(e.statInfo.exp_documentary_amount)))])],1),e.Permission.canViewList?a("el-table",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{"margin-bottom":"18px"},attrs:{stripe:"",border:"",data:e.data},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无跟单"}})]},proxy:!0}],null,!1,689132589)},"el-table",e.tableProps,!1),e._l(e.columns,(function(t,r){return a("el-table-column",e._b({key:r},"el-table-column",t,!1))})),1):e._e(),a("el-dialog",{staticClass:"tg-dialog-classic",attrs:{visible:e.itemsDialogVisible,width:"612px"},on:{close:e.closeItemsDialog},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("商品明细")]},proxy:!0}])},[a("div",{staticStyle:{padding:"24px","max-height":"620px","overflow-y":"auto"}},[a("el-table",{attrs:{stripe:"",data:e.items}},e._l(e.itemsTableColumns,(function(t,r){return a("el-table-column",e._b({key:r},"el-table-column",t,!1))})),1)],1)]),e.Permission.canChange?a("el-drawer",{attrs:{title:e.drawerTitle,height:"100vh",size:"520",visible:e.drawerVisible,wrapperClosable:!1},on:{close:e.closeDrawer}},[a("div",{staticClass:"ae-drawer-content",staticStyle:{"padding-top":"18px"}},[a("DrawerHeader",{attrs:{title:"客户信息"}}),a("DrawerCustomer",{attrs:{customerName:e.shop_name,customerManager:e.manager_name,companyName:e.company_name}}),a("DrawerHeader",{staticClass:"mgt-18",attrs:{title:e.checkedAE}}),a("div",{staticStyle:{padding:"0 30px"}},[a("div",{staticClass:"ae-order-list"},[e._l(e.aeForm,(function(t,r){return[a("el-form",{key:r,ref:"formRef",refInFor:!0,staticClass:"el-form-vertical",staticStyle:{padding:"0"},attrs:{model:t,rules:e.formRules}},[a("div",{staticClass:"ae-order"},[a("el-form-item",{staticClass:"col-1-2",attrs:{label:"KOL名称",prop:"kol_id"}},[a("el-select",{staticStyle:{width:"100%"},attrs:{size:"medium",placeholder:"请输入并选择KOL名称",filterable:"",remote:"",clearable:"","remote-method":e.onKolSearch},on:{change:function(t){return e.onKolChange(r,t)}},model:{value:t.kol_name,callback:function(a){e.$set(t,"kol_name","string"===typeof a?a.trim():a)},expression:"aeOrder.kol_name"}},e._l(e.kol_list,(function(e,t){return a("el-option",{key:t,attrs:{value:e.value,label:e.label}})})),1)],1),a("el-form-item",{staticClass:"col-2-3",attrs:{label:"报价金额",prop:"price_amount"}},[a("el-input",{attrs:{size:"medium",placeholder:"请输入报价金额"},on:{input:function(t){return e.onInputPriceAmount(r,t)}},scopedSlots:e._u([{key:"append",fn:function(){return[e._v("元")]},proxy:!0}],null,!0),model:{value:t.price_amount,callback:function(a){e.$set(t,"price_amount","string"===typeof a?a.trim():a)},expression:"aeOrder.price_amount"}})],1),a("el-form-item",{staticClass:"col-1-2",attrs:{label:"成本金额",prop:"cost_amount"}},[a("el-input",{attrs:{size:"medium",placeholder:"请输入成本金额"},on:{input:function(t){return e.onInputCostAmount(r,t)}},scopedSlots:e._u([{key:"append",fn:function(){return[e._v("元")]},proxy:!0}],null,!0),model:{value:t.cost_amount,callback:function(a){e.$set(t,"cost_amount","string"===typeof a?a.trim():a)},expression:"aeOrder.cost_amount"}})],1),a("el-form-item",{staticClass:"col-2-3",attrs:{label:"直播日期",prop:"live_date"}},[a("el-date-picker",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择直播日期",type:"date",size:"medium","value-format":"yyyy-MM-dd",format:"yyyy.MM.dd"},model:{value:t.live_date,callback:function(a){e.$set(t,"live_date",a)},expression:"aeOrder.live_date"}})],1),a("el-form-item",{staticClass:"col-1-3",attrs:{label:"成本是否安排",prop:"is_cost_arrange"}},[a("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:t.is_cost_arrange,callback:function(a){e.$set(t,"is_cost_arrange",a)},expression:"aeOrder.is_cost_arrange"}},[a("el-radio",{attrs:{label:1}},[e._v("是")]),a("el-radio",{attrs:{label:0}},[e._v("否")])],1)],1),a("div",{staticClass:"el-form-item is-required col-1-3",staticStyle:{"margin-bottom":"0"}},[a("label",{staticClass:"el-form-item__label"},[e._v("商品名称")]),a("div",{staticStyle:{width:"100%"}})]),a("div",{staticClass:"ae-order-product-list col-1-3"},[e._l(t.item_list,(function(i,o){return[a("div",{key:o,staticClass:"ae-order-product col-1-3"},[a("el-form-item",{staticClass:"col-1-2",attrs:{label:"商品名称",prop:"item_list["+o+"].item_name",rules:e.formRules.item_name}},[a("el-input",{attrs:{size:"medium",placeholder:"请输入商品名称"},model:{value:i.item_name,callback:function(t){e.$set(i,"item_name","string"===typeof t?t.trim():t)},expression:"item.item_name"}})],1),a("el-form-item",{staticClass:"col-2-3",attrs:{label:"商品链接",prop:"item_list["+o+"].item_url",rules:e.formRules.item_url}},[a("el-input",{attrs:{size:"medium",placeholder:"请输入商品链接"},model:{value:i.item_url,callback:function(t){e.$set(i,"item_url","string"===typeof t?t.trim():t)},expression:"item.item_url"}})],1),a("el-form-item",{attrs:{label:"样品是否安排",prop:"is_sample_arrange"}},[a("el-radio-group",{staticStyle:{width:"100%",height:"32px","line-height":"32px"},model:{value:i.is_sample_arrange,callback:function(t){e.$set(i,"is_sample_arrange",t)},expression:"item.is_sample_arrange"}},[a("el-radio",{attrs:{label:1}},[e._v("是")]),a("el-radio",{attrs:{label:0}},[e._v("否")])],1)],1),t.item_list.length>1?a("tg-icon",{attrs:{name:"ico-frm-delete","hover-name":"ico-frm-delete-active"},on:{click:function(t){return e.removeItem(r,o)}}}):e._e()],1)]}))],2),a("tg-ghost-button",{staticClass:"col-1-3 mgt-18",on:{click:function(t){return e.addItem(r)}}},[a("a",[e._v("点击添加")])]),a("el-form-item",{staticClass:"col-1-3 mgt-18",attrs:{label:"备注",prop:"note"}},[a("el-input",{attrs:{type:"textarea",placeholder:"请输入备注",maxlength:50,"show-word-limit":""},model:{value:t.note,callback:function(a){e.$set(t,"note",a)},expression:"aeOrder.note"}})],1),!e.editMode&&e.aeForm.length>1?a("tg-icon",{attrs:{name:"ico-frm-delete","hover-name":"ico-frm-delete-active"},on:{click:function(t){return e.removeOrder(r)}}}):e._e()],1)])]}))],2),e.editMode?e._e():a("tg-ghost-button",{staticClass:"mgt-18",on:{click:e.addOrder}},[a("a",[e._v("添加跟单表")])])],1)],1),a("div",{staticClass:"el-drawer-footer"},[a("tg-button",{on:{click:e.closeDrawer}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.onSubmit}},[e._v("保存")])],1)]):e._e(),a("TgMaskLoading",{attrs:{content:"正在保存跟单，请稍候...",visible:e.submitLoading}}),a("TgMaskLoading",{attrs:{content:"正在删除跟单，请稍候...",visible:e.deleteLoading}})],1)},ze=[],Oe=a(83468),We=a(76012);const Ze=async e=>(0,We.dX)("/api/coop/query_cooperation_ae",{params:{...(0,C.jG)(e)}}),Be=async e=>(0,We.dX)("/api/coop/get_ae_documentary_amount",{params:{...(0,C.jG)(e)}}),Ye=async e=>(0,We.dX)("/api/coop/query_documentary",{params:{...(0,C.jG)(e)}}),He=async e=>(0,We.SO)("/api/coop/add_documentary_list",e.map((e=>({...(0,C.jG)(e)})))),Ue=async e=>(0,We.SO)("/api/coop/del_documentary",e),Ge=async e=>(0,We.SO)("/api/coop/update_documentary",{...(0,C.jG)(e)}),Ke=e=>{const t=(0,l.inject)("MarketingProject"),a=(0,l.ref)(!1),r=(e=!1)=>{a.value=e},i=()=>r(!0),o=(0,l.ref)(!1),s=(0,l.computed)((()=>o.value?"编辑跟单":"新增跟单")),n=(0,l.ref)(null),c=()=>{r(),v(),o.value=!1},d=(0,l.ref)(""),u=(0,l.ref)([]),p=(e,t)=>{_.value[e].kol_id=t},m=async e=>{if(void 0===t?.value)return;const{data:a}=await(0,Oe.W7)({kol_name:e});a.success&&(u.value=a.data.data.map((e=>({label:e.kol_info.kol_name,value:e.kol_info.kol_id}))))},_=(0,l.ref)([{documentary_id:void 0,ae_id:void 0,kol_id:"",kol_name:"",price_amount:"",cost_amount:"",live_date:"",is_cost_arrange:0,is_sample_arrange:0,note:"",item_list:[]}]),v=()=>{_.value=[{documentary_id:void 0,ae_id:void 0,kol_id:"",kol_name:"",price_amount:"",cost_amount:"",live_date:"",is_cost_arrange:0,is_sample_arrange:0,note:"",item_list:[]}]},f=e=>{_.value=[{documentary_id:e.documentary_id,ae_id:e.ae_id,kol_id:e.kol_id,kol_name:e.kol_name,price_amount:`${e.price_amount}`,cost_amount:`${e.cost_amount}`,live_date:e.live_date,is_cost_arrange:e.is_cost_arrange,is_sample_arrange:e.is_sample_arrange,note:e.note,item_list:e.item_list.map((e=>({...e})))}],o.value=!0},g=()=>{_.value.push({ae_id:void 0,kol_id:"",kol_name:"",price_amount:"",cost_amount:"",live_date:"",is_cost_arrange:0,is_sample_arrange:0,note:"",item_list:[]}),y(_.value.length-1)},h=e=>{_.value=_.value.filter(((t,a)=>a!==e)),_.value.length<1&&g(),n.value?.forEach((e=>{e.clearValidate()}))},y=e=>{_.value[e].item_list.push({item_name:"",item_url:"",is_sample_arrange:0})},b=(e,t)=>{_.value[e].item_list=_.value[e].item_list.filter(((e,a)=>a!==t)),n.value?.[e]?.clearValidate(["item_list"]),_.value[e].item_list.length<1&&y(e),n.value?.forEach((e=>{e.clearValidate()}))};(0,l.watch)((()=>a.value),(e=>{e&&(_.value.forEach(((e,t)=>{e.item_list.length<1&&y(t)})),n.value?.forEach((e=>{e.clearValidate()})))}));const k=()=>{let a=!0;const r=[];return _.value.forEach((i=>{const{kol_id:o,item_list:s,...l}=i;if(""===o||void 0===t?.value)return void(a=!1);const n={kol_id:o,cooperation_id:t?.value?.cooperation_id,item_list:s.filter((e=>""!==e.item_name&&""!==e.item_url)),...l};if(0===n.item_list.length)return a=!1,void e.root.$message.warning("请填写完整至少一条商品信息");r.push(n)})),!0===a&&r},x=(0,l.ref)({kol_id:[{required:!0,message:"请输入并选择KOL名称",trigger:"change"}],price_amount:[{required:!0,message:"请输入报价金额",trigger:"blur"}],is_cost_arrange:[{required:!0,message:"请选择成本是否安排",trigger:"blur"}],item_name:[{required:!0,message:"请输入商品名称",trigger:"blur"}],item_url:[{required:!0,message:"请输入商品链接",trigger:"blur"},{validator:(e,t,a)=>{if(Z.IO.test(t))try{new URL(t),a()}catch{a(new Error("请输入合法的链接地址"))}else a(new Error("请输入合法的链接地址"))}}]}),S=(0,l.ref)(!1),j=(0,l.ref)(0),D=(e,t)=>{_.value[e].price_amount=(0,w.nA)(t)},P=(e,t)=>{_.value[e].cost_amount=(0,w.nA)(t)},$=async()=>{const t=[];n.value?.forEach((e=>{t.push(new Promise((t=>{e?.validate((e=>{t(e)}))})))}));const a=await Promise.all(t);if(a.includes(!1))return void console.warn("校验不通过");const r=k();if(!1===r)return void console.warn("参数不合格");S.value=!0;const[{data:i}]=await Promise.all([o.value?await Ge(r[0]):await He(r),await(0,C._v)(500)]);S.value=!1,i.success?(e.root.$message.success(i.message??"保存成功"),j.value++,c()):e.root.$message.error(i.message??"保存失败")},I=(0,l.computed)((()=>t?.value?.shop_name??"--")),V=(0,l.computed)((()=>t?.value?.manager_name??"--")),R=(0,l.computed)((()=>t?.value?.company_name??"--"));return{drawerVisible:a,openDrawer:i,closeDrawer:c,drawerTitle:s,kol_name:d,kol_list:u,onKolChange:p,onKolSearch:m,aeForm:_,fillForm:f,addOrder:g,removeOrder:h,formRef:n,formRules:x,addItem:y,removeItem:b,onSubmit:$,submitLoading:S,submitSuccess:j,resetForm:v,shop_name:I,manager_name:V,company_name:R,editMode:o,onInputPriceAmount:D,onInputCostAmount:P}};var Je=Ke,Qe=a(67910);const Xe=new G.ZP,et=e=>""===e||void 0===e?"--":`${Xe.format(e,G.WL.Yuan)}`,tt=e=>{const t=(0,l.inject)("MarketingProject"),a=(0,l.ref)(!1),r=(0,l.ref)([]),i=(0,l.ref)({act_documentary_amount:"",exp_documentary_amount:""}),o=(0,l.ref)(0),s=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_documentary_change);return{canChange:e}})),n=(0,l.computed)((()=>e.root.$store.getters["user/getUserInfo"])),c=(0,l.computed)((()=>e.root.$store.getters["marketing/aeList"])),d=(0,l.computed)((()=>c.value?.map((e=>e.ae_id)).includes(n.value.id)??!1)),u=(0,l.computed)((()=>c.value?.map((e=>({label:e.ae_name,value:e.ae_id})))??[])),p=(0,l.ref)({ae_id:""}),m=(0,l.computed)((()=>"跟单AE："+c.value.find((e=>e.ae_id===p.value.ae_id))?.ae_name??""));(0,l.watch)((()=>JSON.stringify(c.value)),((e,t)=>{e!==t&&""===p.value.ae_id&&(d.value?p.value.ae_id=n.value.id:p.value.ae_id=c.value[0].ae_id)}));const _=(0,l.ref)(!1),v=(0,l.computed)((()=>c.value.length>0)),f=(0,l.computed)((()=>n.value.id>0)),g=()=>{if(""===p.value.ae_id){const e=d.value?n.value.id:c.value.length>0?c.value[0].ae_id:"";p.value.ae_id=e}};(0,l.watch)((()=>!1===_.value&&v.value&&f.value),(e=>{e&&g()})),(0,l.onMounted)((()=>{g()}));const h=(0,l.ref)(!1),b=(0,l.ref)([{label:"商品名称",property:"item_name",formatter:(e,t,a)=>(0,l.h)("div",{class:"line-clamp-2"},[a])},{label:"商品名称",property:"item_url",formatter:(e,t,a)=>(0,l.h)("a",{attrs:{href:a,target:"_blank"},class:"line-clamp-1"},[a])},{label:"样品是否安排",property:"is_sample_arrange",align:"center",headerAlign:"center",width:108,formatter:(e,t,a)=>0===a?"否":"是"}]),k=(0,l.ref)([]),x=()=>{h.value=!1},D=(0,l.ref)(!1),P=async t=>{const a=await(0,_e.I)(e,"确认删除该跟单？");if(!a)return;const{documentary_id:r}=t;D.value=!0;const{data:i}=await Ue({documentary_id:r});D.value=!1,i.success?(e.root.$message.success(i.message??"删除成功"),O()):e.root.$message.error(i.message??"删除失败")},$=(0,l.ref)(-1),I=()=>{$.value=-1},V=e=>e.kol_name,R=(0,Qe.zY)(r,"KOL名称",V),M=e=>et(e.price_amount),L=e=>et(e.cost_amount),F=(e,t)=>{let a="--",r="";const{item_list:i}=e;if(0===i.length)return"--";{const{item_url:e,item_name:t}=i[0];a=t,r=e}const{folded_text:o}=(0,w.zb)(a,12);return t?o:(0,l.h)("el-popover",{props:{placement:"right",trigger:"hover",content:a,width:220,openDelay:300}},[(0,l.h)("div",{slot:"reference"},[(0,l.h)("span",{class:"hover-link line-clamp-1",on:{click:()=>{window.open(r)}}},[o]),i.length>1?(0,l.h)("a",{on:{click:()=>{k.value=i,h.value=!0}}},["更多商品"]):""])])},A=(e,t)=>{const a=e.note||"--",{is_folded:r,folded_text:i}=(0,w.zb)(a,17);return t||!r?i:(0,l.h)("el-popover",{props:{placement:"right",trigger:"hover",content:a,width:220,openDelay:300}},[(0,l.h)("span",{slot:"reference"},[i])])},E=(0,l.computed)((()=>[{label:"KOL名称",property:"kol_name",fixed:"left",minWidth:R.value,formatter:V},{label:"报价金额 (元)",property:"price_amount",align:"right",headerAlign:"right",minWidth:(0,Qe.zY)(r,"报价金额 (元)",M).value,formatter:M},{label:"成本金额 (元)",property:"cost_amount",align:"right",headerAlign:"right",formatter:L,minWidth:(0,Qe.zY)(r,"成本金额 (元)",L).value},{label:"成本是否安排",property:"is_cost_arrange",minWidth:90,align:"center",formatter:(e,t,a)=>0===a?"否":"是"},{label:"商品名称/链接",property:"item_list",minWidth:(0,Qe.zY)(r,"商品名称/链接",F).value,formatter:e=>F(e,!1)},{label:"直播日期",property:"live_date",minWidth:100,align:"center",formatter:(e,t,a)=>""===a?"--":y()(a).format("YYYY.MM.DD")},{label:"样品是否安排",property:"is_sample_arrange",align:"center",headerAlign:"center",minWidth:90,formatter:e=>0===e.item_list?.[0].is_sample_arrange?"否":"是"},{label:"备注",property:"note",minWidth:(0,Qe.zY)(r,"备注",A).value+30,formatter:e=>A(e,!1)}])),N=(0,l.computed)((()=>[{label:"操作",fixed:"right",minWidth:s.value.canChange?94:44,formatter:(e,t,a,r)=>s.value.canChange?(0,l.h)("div",{class:"operation"},[(0,l.h)("a",U()([{},{on:{click:()=>$.value=r}}]),["编辑"]),(0,l.h)("a",U()([{},{on:{click:()=>P(e)}}]),["删除"])]):"--"}])),T=(0,l.computed)((()=>[...E.value,...p.value.ae_id===n.value.id?N.value:[]])),q=async e=>{a.value=!0;const[{data:t}]=await Promise.all([await Ye(e),await(0,C._v)(500)]);a.value=!1,t.success?(r.value=t.data.data,o.value=t.data.total):(r.value=[],o.value=0)},z=()=>{const e={cooperation_id:t?.value?.cooperation_id};return""!==p.value.ae_id&&(e.ae_id=p.value.ae_id),e},O=async()=>{await q(z())},W=async()=>{const{data:e}=await Be(z());e.success?i.value=e.data:(i.value.act_documentary_amount=0,i.value.exp_documentary_amount=0)};(0,l.watch)((()=>""!==p.value.ae_id&&void 0!==t?.value?.cooperation_id),((e,t)=>{e!==t&&(O(),W())})),(0,l.watch)((()=>p.value.ae_id),((e,a)=>{e!==a&&""!==e&&void 0!==t?.value?.cooperation_id&&(O(),W())}));const Z=e=>""===e?"--":`￥${e}`;return{loading:a,data:r,total:o,statInfo:i,queryForm:p,aeList:c,checkedAE:m,aeOptions:u,columns:T,itemsTableColumns:b,items:k,itemsDialogVisible:h,closeItemsDialog:x,reload:O,getAmount:W,documentary_amount_format:Z,isAE:d,deleteLoading:D,checkedRowIndex:$,clearCheckedRowIndex:I}};var at=tt,rt=(0,l.defineComponent)({name:"TgMarketingProjectTabAE",setup(e,t){const{checkedRowIndex:a,clearCheckedRowIndex:r,...i}=at(t),{submitSuccess:o,...s}=Je(t);(0,l.watch)((()=>o.value),((e,t)=>{e!==t&&(i.reload(),i.getAmount())})),(0,l.watch)((()=>a.value),(e=>{-1===e||(s.fillForm(i.data.value[e]),s.openDrawer())})),(0,l.watch)((()=>s.drawerVisible.value),(e=>{e||r()}));const n=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_documentary_view),t=(0,S.kG)(j.HN.marketing_project_documentary_change);return{canChange:t,canViewList:e}})),c=32,d=34,u=36,p=31,m=(0,l.ref)(285),_=(0,oe.Z)({compensation:(0,l.computed)((()=>c+d+u+p)),fixedBlockHeightRefs:[m],tableMinHeight:100});return{Permission:n,...i,...s,..._}}}),it=rt,ot=(0,V.Z)(it,qe,ze,!1,null,null,null),st=ot.exports,lt=a(85457),nt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("sub-tabs",[a("comp1",{attrs:{name:"应付"}}),a("comp2",{attrs:{name:"实付"}})],1)},ct=[],dt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-card",e._b({staticClass:"marketing-project-cost-schedule-should flex-auto",on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("div",{staticClass:"cost-headers"},[a("div",{staticClass:"cost-headers-sumary"},[a("span",{staticClass:"cost-headers-sumary-label"},[e._v("应付金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.payable):"--"))]),a("span",{staticClass:"cost-headers-sumary-label"},[e._v("已核销金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.write_off):"--"))]),a("span",{staticClass:"cost-headers-sumary-label"},[e._v("未核销金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.not_write_off):"--"))])])]),e.Permission.canViewList?a("el-table",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{stripe:"",border:"",data:e.costDataList,"cell-style":{cursor:"pointer"}},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无数据"}})]},proxy:!0}],null,!1,2826547353)},"el-table",e.tableProps,!1),e._l(e.columns,(function(t,r){return a("el-table-column",e._b({key:r},"el-table-column",t,!1))})),1):e._e(),a("CostRegister",{style:e.costRegisterVisible?void 0:"display: none",attrs:{editCost:e.editCost,visible:e.costRegisterVisible},on:{"update:visible":function(t){e.costRegisterVisible=t},save:e.costListSaved}}),a("RebatesRegister",{style:e.rebatesRegisterVisible?void 0:"display: none",attrs:{editRebate:e.editRebate,visible:e.rebatesRegisterVisible},on:{"update:visible":function(t){e.rebatesRegisterVisible=t},save:e.costListSaved}}),a("CostInvoice",{style:e.costInvoiceVisible?void 0:"display: none",attrs:{visible:e.costInvoiceVisible,invoices:e.invoices},on:{"update:visible":function(t){e.costInvoiceVisible=t}}}),a("PayCertificate",{style:e.payCertificateVisible?void 0:"display: none",attrs:{visible:e.payCertificateVisible,pay_certificate_pic:e.payCertificatePic},on:{"update:visible":function(t){e.payCertificateVisible=t}}}),a("CostVTask",{style:e.costVTaskVisible?void 0:"display: none",attrs:{visible:e.costVTaskVisible,vtasks:e.vtasks},on:{"update:visible":function(t){e.costVTaskVisible=t}}}),e.customerVisible?a("apply-detail",{ref:"applyDetailRef",on:{close:e.applyDetailClose}}):e._e(),e.applicationDetailVisible?a("application-detail",{ref:"applicationDetailRef",on:{close:e.applicationDetailClose}}):e._e(),e.refundVisible?a("refund-detail",{attrs:{visible:e.refundVisible,approval:e.approval,commitAgainVisible:!1},on:{close:e.refundDetailClose}}):e._e(),a("tg-mask-loading",{attrs:{visible:e.deleteLoading,content:"  正在删除，请稍候..."}}),a("first-step",{ref:"firstStepRef",on:{submit:e.costListSaved}}),e.paymentDialogVisible?a("payment-dialog",{attrs:{visible:e.paymentDialogVisible,data:e.paymentData},on:{"update:visible":function(t){e.paymentDialogVisible=t},"dialog:close":function(t){e.paymentDialogVisible=!1}}}):e._e()],1)},ut=[],pt=a(58061),mt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-drawer",{staticClass:"cost-register-drawer",attrs:{title:"登记成本",visible:e.visible,wrapperClosable:!1},on:{close:e.close}},[a("div",{staticClass:"cost-register-drawer-body"},[a("div",{staticClass:"cost-register-drawer-content"},[a("DrawerHeader",{attrs:{title:"客户信息"}}),a("DrawerCustomer",{staticClass:"cost-register-customer-info",attrs:{customerName:e.project?e.project.shop_name:"--",customerManager:e.project?e.project.manager_name:"--",companyName:e.project?e.project.company_name:"--"}}),a("DrawerHeader",{staticStyle:{"margin-bottom":"6px"},attrs:{title:"成本信息"}}),a("el-form",{ref:"ruleForm",attrs:{model:e.form,size:"small","label-position":"top"}},e._l(e.form.data,(function(t,r){return a("div",{key:r,staticClass:"cost-register-info"},[a("div",{staticClass:"cost-register-info-header"},[a("span",[e._v("成本信息")]),a("tg-button",{attrs:{type:"link"},on:{click:function(a){return e.copyCost(t,r)}}},[e._v("复制")]),e.form.data.length>1?a("tg-button",{staticClass:"cost-register-close",attrs:{type:"link"},on:{click:function(t){return e.deleteCost(r)}}},[a("tg-icon",{attrs:{name:"ico-cross"}}),a("tg-icon",{attrs:{name:"ico-cross-red"}})],1):e._e()],1),a("el-form-item",{staticClass:"required",attrs:{label:"关联业绩"}},[a("div",{staticClass:"drawer-item-radio-container"},[a("el-radio-group",{model:{value:t.cost_type,callback:function(a){e.$set(t,"cost_type",a)},expression:"costInfo.cost_type"}},[a("el-radio",{attrs:{label:1}},[e._v("关联业绩")]),a("el-radio",{attrs:{label:2}},[e._v("借款")])],1)],1)]),1===t.cost_type?a("el-form-item",{staticClass:"drawer-item-bg",attrs:{label:"收款编号",prop:"data."+r+".achievement_uid",rules:{required:!0,message:"请选择关联业绩",trigger:["change"]}}},[a("el-select",{attrs:{clearable:"",filterable:"","reserve-keyword":"",placeholder:"请输入并选择收款编号"},model:{value:t.achievement_uid,callback:function(a){e.$set(t,"achievement_uid",a)},expression:"costInfo.achievement_uid"}},e._l(e.achievementList,(function(e,t){return a("el-option",{key:t,attrs:{value:e.achievement_uid,label:e.achievement_uid}})})),1)],1):e._e(),2===t.cost_type?a("el-form-item",{staticClass:"drawer-item-bg",attrs:{prop:"data."+r+".borrowing_uid",rules:{required:!0,message:"关联垫款审批编号",trigger:["change"]}},scopedSlots:e._u([{key:"label",fn:function(){return[e._v(" 关联垫款审批单号 "),2===t.cost_type?a("el-popover",{attrs:{placement:"top",trigger:"hover",effect:"light",content:"借款要先提交借款审批，审批通过后再关联成本安排"}},[a("template",{slot:"reference"},[a("tg-icon",{staticStyle:{cursor:"pointer",color:"#c4cbd2"},attrs:{name:"ico-question"}})],1)],2):e._e()]},proxy:!0}],null,!0)},[a("el-select",{attrs:{clearable:"",filterable:"","reserve-keyword":"",placeholder:"请输入并选择关联垫款审批编号"},model:{value:t.borrowing_uid,callback:function(a){e.$set(t,"borrowing_uid",a)},expression:"costInfo.borrowing_uid"}},e._l(e.borrowApprovalList,(function(e,t){return a("el-option",{key:t,attrs:{value:e.approval_uid,label:e.approval_uid}})})),1)],1):e._e(),a("el-form-item",{staticClass:"required",attrs:{label:"供应商合同"}},[a("div",{staticClass:"drawer-item-radio-container"},[a("el-radio-group",{model:{value:t.has_contract,callback:function(a){e.$set(t,"has_contract",a)},expression:"costInfo.has_contract"}},[a("el-radio",{attrs:{label:1}},[e._v("有合同")]),a("el-radio",{attrs:{label:2}},[e._v("无合同")])],1)],1)]),1===t.has_contract?a("el-form-item",{staticClass:"drawer-item-bg",attrs:{label:"合同编号",prop:"data."+r+".contract_id",rules:{required:!0,message:"请选择关联供应商合同",trigger:["change"]}},model:{value:t.contract_id,callback:function(a){e.$set(t,"contract_id",a)},expression:"costInfo.contract_id"}},[a("el-select",{attrs:{clearable:"",filterable:"","reserve-keyword":"",placeholder:"请输入并选择合同编号"},model:{value:t.contract_id,callback:function(a){e.$set(t,"contract_id",a)},expression:"costInfo.contract_id"}},e._l(e.contractList,(function(e,t){return a("el-option",{key:t,attrs:{value:e.contract_id,label:e.contract_uid}})})),1)],1):e._e(),a("el-form-item",{staticClass:"drawer-item-kol",attrs:{label:"KOL名称",prop:"data."+r+".kol_id",rules:{required:!0,message:"请选择KOL",trigger:["change"]}}},[a("el-select",{attrs:{clearable:"",filterable:"",placeholder:"请输入并选择KOL名称","popper-class":"tg-cost-register-popover-260"},on:{change:function(t){return e.kolChanged(t,r)}},model:{value:t.kol_id,callback:function(a){e.$set(t,"kol_id",a)},expression:"costInfo.kol_id"}},e._l(e.kolList,(function(e,t){return a("el-option",{key:t,attrs:{value:e.kol_id,label:e.kol_name}})})),1)],1),2===t.is_personal?a("el-form-item",{staticClass:"drawer-item-bg",attrs:{label:"机构名称",prop:"data."+r+".company_id",rules:{required:!0,message:"请选择机构名称",trigger:["change"]}}},[a("el-select",{attrs:{disabled:!t.kol_id,clearable:"",filterable:"","reserve-keyword":"",placeholder:"请输入并选择机构名称"},on:{change:function(t){return e.companyChanged(t,r)}},model:{value:t.company_name,callback:function(a){e.$set(t,"company_name",a)},expression:"costInfo.company_name"}},e._l(t.company_list,(function(e){return a("el-option",{key:e.company_id,attrs:{value:e.company_id,label:e.company_name,disabled:e.disabled}})})),1),a("div",{staticClass:"company-kol-desc"},[e._v(" 请先选择KOL再选择所属机构，需要先给KOL关联机构信息 "),a("tg-button",{attrs:{type:"link"},on:{click:function(t){return e.goToConbination(r)}}},[e._v("去关联")]),e._v("，关联后点击 "),a("tg-button",{attrs:{type:"link"},on:{click:function(t){return e.companyRefresh(r)}}},[e._v("刷新")])],1)],1):e._e(),a("el-form-item",{staticClass:"required",scopedSlots:e._u([{key:"label",fn:function(){return[e._v(" 业务执行日期 "),a("el-popover",{attrs:{placement:"top",trigger:"hover",effect:"light",content:"kol开播的时间段"}},[a("template",{slot:"reference"},[a("tg-icon",{staticStyle:{cursor:"pointer",color:"#c4cbd2"},attrs:{name:"ico-question"}})],1)],2)]},proxy:!0}],null,!0)},[a("el-date-picker",{attrs:{clearable:!1,type:"daterange",editable:!1,"range-separator":"~","start-placeholder":"开始日期","end-placeholder":"结束日期",format:"yyyy.MM.dd","value-format":"yyyy-MM-dd"},on:{change:function(t){return e.liveDateChanged(t,r)}},model:{value:t.live_dates,callback:function(a){e.$set(t,"live_dates",a)},expression:"costInfo.live_dates"}})],1),a("el-form-item",{attrs:{label:"打款日期"}},[a("el-date-picker",{attrs:{type:"date",editable:!1,placeholder:"请选择打款日期",format:"yyyy.MM.dd","value-format":"yyyy-MM-dd"},model:{value:t.transfer_date,callback:function(a){e.$set(t,"transfer_date",a)},expression:"costInfo.transfer_date"}})],1),a("el-form-item",{attrs:{label:"打款金额",prop:"data."+r+".pay_amount",rules:{required:!0,validator:function(t,a,r){""===a||void 0===a?r(new e.Error("请输入打款金额")):0===Number(a)?r(new e.Error("费用金额必须大于0")):r()},trigger:["blur"]}}},[a("el-input",{attrs:{clearable:!0,placeholder:"请输入打款金额"},on:{input:function(t){return e.moneyChange(t,r)}},model:{value:t.pay_amount,callback:function(a){e.$set(t,"pay_amount",a)},expression:"costInfo.pay_amount"}},[a("template",{slot:"append"},[e._v("元")])],2)],1),a("el-form-item",{staticClass:"required",attrs:{label:"打款方式"}},[a("div",{staticClass:"drawer-item-radio-container"},[a("el-radio-group",{on:{change:function(t){return e.payWayChanged(t,r)}},model:{value:t.pay_way,callback:function(a){e.$set(t,"pay_way",a)},expression:"costInfo.pay_way"}},[a("el-radio",{attrs:{label:1}},[e._v("银行卡")]),a("el-radio",{attrs:{label:2}},[e._v("V任务")]),a("el-radio",{attrs:{label:3}},[e._v("对公银行")]),a("el-radio",{attrs:{label:4}},[e._v("支付宝")])],1)],1)]),2===t.pay_way?a("div",{staticClass:"drawer-item-bg"},[e._l(t.v_task_list,(function(t,i){return a("div",{key:i,staticClass:"v-task-bg"},[a("el-form-item",{attrs:{label:"V任务链接",prop:"data."+r+".v_task_list."+i+".v_task_url",rules:{required:!0,message:"请输入V任务链接",trigger:["blur"]}}},[a("el-input",{attrs:{clearable:!0,placeholder:"请输入V任务链接"},model:{value:t.v_task_url,callback:function(a){e.$set(t,"v_task_url",a)},expression:"task.v_task_url"}})],1),a("el-form-item",{attrs:{label:"产品链接",prop:"data."+r+".v_task_list."+i+".item_url",rules:{required:!0,message:"请输入产品链接",trigger:["blur"]}}},[a("el-input",{attrs:{clearable:!0,placeholder:"请输入产品链接"},model:{value:t.item_url,callback:function(a){e.$set(t,"item_url",a)},expression:"task.item_url"}})],1),i>0?a("tg-button",{staticClass:"cost-register-close",attrs:{type:"link"},on:{click:function(t){return e.delVTask(r,i)}}},[a("tg-icon",{attrs:{name:"ico-cross"}}),a("tg-icon",{attrs:{name:"ico-cross-red"}})],1):e._e()],1)})),a("tg-button",{staticClass:"drawer-item-add",attrs:{type:"link"},on:{click:function(t){return e.addVTask(r)}}},[a("tg-icon",{attrs:{name:"ico-btn-add"}}),e._v(" 点击添加 ")],1)],2):e._e(),t.pay_way>2?a("el-form-item",{staticClass:"drawer-item-bg",attrs:{prop:"data."+r+".approval_id",rules:{required:!0,message:"请关联用款审批编号",trigger:["change"]}},scopedSlots:e._u([{key:"label",fn:function(){return[e._v(" 关联用款审批编号 "),a("el-popover",{attrs:{placement:"top",trigger:"hover",effect:"light",content:"对公银行或支付宝打款要先提交用款审批，审批通过后再在此关联"}},[a("template",{slot:"reference"},[a("tg-icon",{staticStyle:{cursor:"pointer",color:"#c4cbd2"},attrs:{name:"ico-question"}})],1)],2)]},proxy:!0}],null,!0)},[a("el-select",{attrs:{clearable:"",filterable:"","reserve-keyword":"",placeholder:"请输入并选择用款审批编号"},model:{value:t.approval_id,callback:function(a){e.$set(t,"approval_id",a)},expression:"costInfo.approval_id"}},[3===t.pay_way?a("div",e._l(e.dgyhApprovalList,(function(e,t){return a("el-option",{key:t,attrs:{value:e.id,label:e.approval_uid}})})),1):e._e(),4===t.pay_way?a("div",e._l(e.zfbApprovalList,(function(e,t){return a("el-option",{key:t,attrs:{value:e.id,label:e.approval_uid}})})),1):e._e()])],1):e._e(),a("el-form-item",{staticClass:"required",scopedSlots:e._u([{key:"label",fn:function(){return[a("span",[e._v(" 打款账户 "),a("el-popover",{attrs:{placement:"top-start",trigger:"hover"}},[a("div",[a("p",{staticStyle:{"font-size":"13px","font-weight":"600","line-height":"20px"}},[e._v("时光机：")]),a("p",{staticStyle:{"font-size":"12px","line-height":"20px"}},[e._v(" 支付宝名称：嘉兴市经开城南时光机营销策划工作室 ")]),a("p",{staticStyle:{"font-size":"12px","line-height":"20px"}},[e._v("账户：gmrenwupaifa@163.com")]),a("p",{staticStyle:{"font-size":"12px","line-height":"20px"}},[e._v("淘宝会员名：GM任务派发")]),a("p",{staticStyle:{"font-size":"13px","font-weight":"600","margin-top":"10px","line-height":"20px"}},[e._v(" 玥每映像： ")]),a("p",{staticStyle:{"font-size":"12px","line-height":"20px"}},[e._v(" 支付宝名称：嘉兴玥每映像文化传媒有限公司 ")]),a("p",{staticStyle:{"font-size":"12px","line-height":"20px"}},[e._v("账户： yuemeiyx@126.com")]),a("p",{staticStyle:{"font-size":"13px","font-weight":"600","margin-top":"10px","line-height":"20px"}},[e._v(" 构美子账户： ")]),a("p",{staticStyle:{"font-size":"12px","line-height":"20px"}},[e._v(" 支付宝名称：嘉兴构美信息技术有限公司-子公司 ")]),a("p",{staticStyle:{"font-size":"12px","line-height":"20px"}},[e._v("账户： gmcwzy@126.com")])]),a("template",{slot:"reference"},[a("tg-icon",{staticStyle:{cursor:"pointer",color:"#c4cbd2"},attrs:{name:"ico-question"}})],1)],2)],1)]},proxy:!0}],null,!0)},[a("div",{staticClass:"drawer-item-radio-container"},[a("el-radio-group",{model:{value:t.pay_account,callback:function(a){e.$set(t,"pay_account",a)},expression:"costInfo.pay_account"}},[a("el-radio",{attrs:{label:1}},[e._v("时光机")]),a("el-radio",{attrs:{label:2}},[e._v("玥美映像")]),a("el-radio",{attrs:{label:3}},[e._v("构美子账户")])],1)],1)]),a("el-form-item",{attrs:{label:"备注"}},[a("el-input",{attrs:{type:"textarea",placeholder:"请输入备注",maxlength:"100","show-word-limit":""},model:{value:t.note,callback:function(a){e.$set(t,"note",a)},expression:"costInfo.note"}})],1)],1)})),0),a("tg-button",{staticClass:"drawer-item-add",staticStyle:{margin:"0 30px 0 30px"},attrs:{type:"link"},on:{click:e.addCost}},[a("tg-icon",{attrs:{name:"ico-btn-add"}}),e._v(" 点击添加 ")],1)],1),a("div",{staticClass:"cost-register-drawer-footer"},[a("tg-button",{attrs:{size:"small"},on:{click:e.close}},[e._v("取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:e.save}},[e._v("保存")])],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在删除，请稍候..."}})],1)},_t=[],vt=a(3293),ft=a(8581),gt=a(57046);const ht=()=>{const e=new Date;return(0,ft.WU)(e,"YYYY-mm-dd")},yt=e=>{if(!e){const e=ht();return{cost_id:void 0,cost_type:1,cooperation_id:void 0,achievement_uid:void 0,kol_id:void 0,company_id:void 0,company_name:void 0,pay_way:1,pay_amount:void 0,pay_account:1,transfer_date:e,is_invoice:void 0,tax_point:void 0,note:void 0,is_personal:2,invoice_certificate_pic:void 0,has_contract:1,contract_id:void 0,live_start_date:e,live_end_date:e,borrowing_uid:void 0,approval_id:void 0,contract_str:void 0,v_task_list:[{v_task_url:void 0,item_url:void 0}],live_dates:[e,e],company_list:[]}}return(0,gt.I8)(e)};var bt=(0,l.defineComponent)({props:{visible:{type:Boolean},editCost:{type:Object}},setup(e,t){const a=(0,l.inject)("MarketingProject")??(0,l.ref)(),r=(0,l.ref)({data:[yt()]}),i=(0,l.ref)(void 0),o=(0,l.ref)([]),s=(0,l.ref)([]),n=(0,l.ref)([]),c=(0,l.ref)([]),d=(0,l.ref)([]),u=(0,l.ref)([]),p=(0,l.ref)(!1);(0,l.watch)([()=>e.visible,()=>e.editCost],(([e,i])=>{if(e){if(C(),x(),S(),j(1,void 0,3),j(1,void 0,4),a?.value&&j(3,a.value.customer_id),i){const e=i;let a;e.live_start_date&&e.live_end_date&&(a=[e.live_start_date,e.live_end_date]),r.value.data=[{...e,live_dates:a}],r.value.data.forEach((e=>{e.v_task_list&&0!==e.v_task_list.length||(e.v_task_list=[{v_task_url:void 0,item_url:void 0}]),t.root.$set(e,"company_list",[])})),e.kol_id&&P(e.kol_id,0)}}else L()}));const m=()=>{t.emit("update:visible",!1)},_=()=>{i.value?.validate((t=>{t&&(e.editCost?M():R())}))},v=(e,a)=>{r.value.data.splice(a+1,0,yt(e)),t.root.$message.success("表单复制成功")},f=e=>{r.value.data.splice(e,1)},g=()=>{r.value.data.push(yt())},h=e=>{r.value.data[e].v_task_list.push({v_task_url:void 0,item_url:void 0})},y=(e,t)=>{r.value.data[e].v_task_list.splice(t,1)},b=(e,t)=>{const a=r.value.data[t];a.company_list=[],a.company_id=void 0,a.company_name=void 0,P(e,t)},k=(e,t)=>{r.value.data[t].approval_id=void 0},w=(e,t)=>{const a=r.value.data[t];let i=`${e}`;i=i.replace(/[^\d.]/g,""),i=i.replace(/\.{2,}/g,"."),i=i.replace(/^\./g,"0."),i=i.replace(/^\d*\.\d*\./g,i.substring(0,i.length-1)),i=i.replace(/^0[^.]+/g,"0"),i=i.replace(/^(\d+)\.(\d\d).*$/,"$1.$2"),a.pay_amount=i},C=async()=>{const e=await(0,vt.Sx)();o.value=e.data.data},x=async()=>{const e=await(0,W.z0)({partner_type:2,contract_status:2,project_type:2});s.value=e.data.data.data},S=async()=>{if(a?.value){const e=await(0,pt.hU)(a.value.cooperation_id);n.value=e.data.data.data}},j=async(e,t,a)=>{const r=await(0,pt.Fh)(e,t,a);switch(e){case 1:3===a?c.value=r.data.data:d.value=r.data.data;break;case 3:u.value=r.data.data;break;default:break}},D=(e,t)=>{const a=r.value.data[t];if(""===e)a.company_id=void 0,a.company_name=void 0;else{const t=a.company_list?.filter((t=>t.company_id===e))??[];t.length>0&&(a.company_id=e,a.company_name=t[0].company_name)}},P=async(e,a,i)=>{const o=await(0,pt.zQ)(e),s=r.value.data[a];if(s.company_list=o.data.data??[],s.company_id&&s.company_name){const e=s.company_list?.filter((e=>e.company_id===s.company_id));0===(e?.length??0)&&s.company_list?.push({company_id:s.company_id,company_name:s.company_name,disabled:!0})}s.company_list&&s.company_list.length>0&&(s.company_id=s.company_list[0].company_id,s.company_name=s.company_list[0].company_name),i&&o.data.success&&t.root.$message.success("刷新成功")},$=(e,t)=>{e&&2===e.length?(r.value.data[t].live_start_date=e[0],r.value.data[t].live_end_date=e[1]):(r.value.data[t].live_start_date=void 0,r.value.data[t].live_end_date=void 0)},I=e=>{const a=r.value.data[e].kol_id;if(!a)return t.root.$message.warning("请先选择kol名称"),!1;let i;o.value.forEach((e=>{e.kol_id!==a||(i=e.kol_name)}));const{href:s}=t.root.$router.resolve({path:"/supplier/list",query:{kol_name:i,kol_id:`${a}`}});window.open(s,"_blank")},V=e=>{const a=r.value.data[e].kol_id;if(!a)return t.root.$message.warning("请先选择kol名称"),!1;P(a,e,!0)},R=async()=>{r.value.data.forEach((e=>{e.cooperation_id=a?.value?.cooperation_id})),p.value=!0;const e=await(0,pt.ey)(r.value.data);p.value=!1,e.data.success?(t.root.$message.success(e.data.message??"新增成本成功"),m(),t.emit("save")):t.root.$message.error(e.data.message??"新增成本失败")},M=async()=>{r.value.data.forEach((e=>{e.cooperation_id=a?.value?.cooperation_id})),p.value=!0;const e=await(0,pt.Pg)(r.value.data[0]);p.value=!1,e.data.success?(t.root.$message.success(e.data.message??"更新成本成功"),m(),t.emit("save")):t.root.$message.error(e.data.message??"更新成本失败")},L=()=>{r.value={data:[yt()]},o.value=[],s.value=[],n.value=[],c.value=[],d.value=[],u.value=[],setTimeout((()=>{i.value?.clearValidate()}),100)};return{saveLoading:p,project:a,kolList:o,contractList:s,achievementList:n,dgyhApprovalList:c,zfbApprovalList:d,borrowApprovalList:u,form:r,ruleForm:i,close:m,save:_,kolChanged:b,payWayChanged:k,liveDateChanged:$,companyChanged:D,moneyChange:w,goToConbination:I,companyRefresh:V,copyCost:v,deleteCost:f,addCost:g,addVTask:h,delVTask:y,Error:Error,Number:Number}}}),kt=bt,wt=(0,V.Z)(kt,mt,_t,!1,null,null,null),Ct=wt.exports,xt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-drawer",{staticClass:"rebates-register-drawer",attrs:{title:"登记返点",visible:e.visible,wrapperClosable:!1},on:{close:e.close}},[a("div",{staticClass:"rebates-register-drawer-body"},[a("div",{staticClass:"rebates-register-drawer-content"},[a("DrawerHeader",{attrs:{title:"客户信息"}}),a("DrawerCustomer",{staticClass:"rebates-register-customer-info",attrs:{customerName:e.project?e.project.shop_name:"--",customerManager:e.project?e.project.manager_name:"--",companyName:e.project?e.project.company_name:"--"}}),a("el-form",{ref:"ruleForm",attrs:{size:"small","label-position":"top",model:e.form,rules:e.formRules}},[a("DrawerHeader",{staticStyle:{"margin-bottom":"6px"},attrs:{title:"打款信息"}}),a("div",{staticClass:"form-section"},[a("el-form-item",{staticStyle:{"margin-top":"-18px"},attrs:{label:"关联业绩",prop:"achievement_uid"}},[a("div",{staticClass:"drawer-item-performance"},[a("el-select",{attrs:{clearable:"",placeholder:"请输入并选择收款编号"},on:{change:e.achievementChanged},model:{value:e.form.achievement_uid,callback:function(t){e.$set(e.form,"achievement_uid",t)},expression:"form.achievement_uid"}},e._l(e.achievementList,(function(e){return a("el-option",{key:e.achievement_uid,attrs:{label:e.achievement_uid,value:e.achievement_uid}})})),1),a("div",{staticClass:"drawer-item-performance-value"},[a("div",{staticClass:"line-clamp-1"},[e._v(" 业绩收款金额"),a("span",[e._v(e._s("￥"+(e.arch_amount?e.arch_amount:"--")))])])])],1)]),a("el-form-item",{attrs:{label:"打款日期"}},[a("el-date-picker",{attrs:{editable:!1,type:"date",format:"yyyy.MM.dd","value-format":"yyyy-MM-dd",placeholder:"请选择打款日期"},model:{value:e.form.transfer_date,callback:function(t){e.$set(e.form,"transfer_date",t)},expression:"form.transfer_date"}})],1),a("el-form-item",{attrs:{label:"返点金额",prop:"pay_amount"}},[a("el-input",{attrs:{placeholder:"请输入返点金额"},on:{input:function(t){return e.moneyChange(t,e.index)}},model:{value:e.form.pay_amount,callback:function(t){e.$set(e.form,"pay_amount",t)},expression:"form.pay_amount"}},[a("template",{slot:"append"},[e._v("元")])],2)],1)],1),a("DrawerHeader",{staticStyle:{"margin-bottom":"6px","margin-top":"18px"},attrs:{title:"银行卡信息"}}),a("div",{staticClass:"form-section"},[a("el-form-item",{staticStyle:{"margin-top":"-18px"},attrs:{label:"银行卡号",prop:"bank_card_num"}},[a("el-input",{attrs:{placeholder:"请输入银行卡号",maxlength:"40"},nativeOn:{keyup:function(e){return function(e){e.target.value=e.target.value.replace(/[^\d]/g,"")}.apply(null,arguments)}},model:{value:e.form.bank_card_num,callback:function(t){e.$set(e.form,"bank_card_num",t)},expression:"form.bank_card_num"}})],1),a("el-form-item",{attrs:{label:"身份证号",prop:"id_number"}},[a("el-input",{attrs:{placeholder:"请输入身份证号",maxlength:"20"},nativeOn:{keyup:function(e){return function(e){e.target.value=e.target.value.replace(/[\W]/g,"")}.apply(null,arguments)}},model:{value:e.form.id_number,callback:function(t){e.$set(e.form,"id_number",t)},expression:"form.id_number"}})],1),a("el-form-item",{attrs:{label:"开户行",prop:"bank_name"}},[a("el-input",{attrs:{placeholder:"请输入开户行",maxlength:"40"},model:{value:e.form.bank_name,callback:function(t){e.$set(e.form,"bank_name","string"===typeof t?t.trim():t)},expression:"form.bank_name"}})],1),a("el-form-item",{attrs:{label:"真实姓名",prop:"real_name"}},[a("el-input",{attrs:{placeholder:"请输入真实姓名",maxlength:"10"},model:{value:e.form.real_name,callback:function(t){e.$set(e.form,"real_name","string"===typeof t?t.trim():t)},expression:"form.real_name"}})],1),a("el-form-item",{attrs:{label:"手机号"}},[a("el-input",{attrs:{placeholder:"请输入手机号",maxlength:"11"},nativeOn:{keyup:function(e){return function(e){e.target.value=e.target.value.replace(/[^\d]/g,"")}.apply(null,arguments)}},model:{value:e.form.phone,callback:function(t){e.$set(e.form,"phone",t)},expression:"form.phone"}})],1),a("el-form-item",{attrs:{label:"身份证照片"}},[a("div",{staticClass:"pic-container"},[a("Upp",{attrs:{action:"",value:e.form.id_card_pic,"http-request":e.uploadIdCardFile},on:{remove:e.onIdCardPicRemove}}),a("span",{staticClass:"tips"},[e._v("上传的照片大小不能超过 2MB；支持格式.JPG .JPEG .PNG。")])],1)]),a("el-form-item",{attrs:{label:"银行卡照片"}},[a("div",{staticClass:"pic-container"},[a("Upp",{attrs:{action:"",value:e.form.bank_card_pic,"http-request":e.uploadBankFile},on:{remove:e.onBankPicRemove}}),a("span",{staticClass:"tips"},[e._v("上传的照片大小不能超过 2MB；支持格式.JPG .JPEG .PNG。")])],1)])],1)],1)],1),a("div",{staticClass:"rebates-register-drawer-footer"},[a("tg-button",{attrs:{size:"small"},on:{click:e.close}},[e._v("取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:e.save}},[e._v("保存")])],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在删除，请稍候..."}})],1)},St=[];const jt=()=>{const e=new Date;return(0,ft.WU)(e,"YYYY-mm-dd")},Dt=()=>({cost_id:void 0,cooperation_id:void 0,achievement_uid:void 0,pay_amount:void 0,bank_card_num:void 0,bank_name:void 0,real_name:void 0,id_number:void 0,transfer_date:jt(),id_card_pic:void 0,bank_card_pic:void 0,phone:void 0});var Pt=(0,l.defineComponent)({props:{visible:{type:Boolean},editRebate:{type:Object}},components:{Upp:q.Z},setup(e,t){const a=(0,l.inject)("MarketingProject")??(0,l.ref)(),r=(0,l.ref)([]),i=(0,l.ref)(Dt()),o=(0,l.ref)(void 0),s=(0,l.ref)(void 0),n=(0,l.ref)(void 0),c=(0,l.ref)(void 0),d=(0,l.ref)(!1),u=(0,l.ref)(!1),p=(0,l.ref)(!1),m=(0,l.ref)([]),_=(0,l.ref)([]),v=(0,l.ref)({achievement_uid:{required:!0,message:"请选择关联业绩",trigger:["change","blur"]},pay_amount:{required:!0,message:"请输入返点金额",trigger:"blur"},bank_card_num:{required:!0,message:"请输入银行卡号",trigger:"blur"},id_number:{required:!0,message:"请输入正确身份证号",trigger:"blur"},bank_name:{required:!0,message:"请输入开户行",trigger:"blur"},real_name:{required:!0,message:"请输入真实姓名",trigger:["blur"]}});(0,l.watch)([()=>e.visible,()=>e.editRebate],(([e,t])=>{e?(t&&(i.value=t),P(a.value?.cooperation_id,i.value.achievement_uid)):F()}));const f=e=>{const t=r.value.filter((t=>t.achievement_uid===e));t&&t.length>0?o.value=t[0]["gather_amount_str"]:o.value=void 0},g=()=>{t.emit("update:visible",!1)},h=()=>{s.value?.validate((e=>{e&&$()}))},y=()=>{i.value.id_card_pic=void 0,u.value=!1},b=e=>{i.value.id_card_pic=e.data.source},k=()=>{i.value.bank_card_pic=void 0,d.value=!1},w=e=>{i.value.bank_card_pic=e.data.source},C=e=>{const a=e.size/1024/1024<2;return a||t.root.$message.error("上传图片大小不能超过 2MB!"),"image/jpeg"!==e.type&&"image/jpg"!==e.type&&"image/png"!==e.type||e.name.endsWith(".jfif.jpg")||e.name.endsWith(".jfif")?(t.root.$message.error("文件格式不正确！"),!1):a},S=(e,t)=>{u.value=t.length>=1},j=(e,t)=>{d.value=t.length>=1},D=(e,t)=>{let a=`${e}`;a=a.replace(/[^\d.]/g,""),a=a.replace(/\.{2,}/g,"."),a=a.replace(/^\./g,"0."),a=a.replace(/^\d*\.\d*\./g,a.substring(0,a.length-1)),a=a.replace(/^0[^.]+/g,"0"),a=a.replace(/^(\d+)\.(\d\d).*$/,"$1.$2"),i.value.pay_amount=a},P=async(e,t)=>{if(e){const a=await(0,pt.hU)(e);r.value=a.data.data.data,t&&f(t)}},$=async()=>{i.value.cooperation_id=a.value?.cooperation_id,p.value=!0;const e=await(0,pt.MI)(i.value);p.value=!1,e.data.success?(t.root.$message.success(e.data.message??"保存返点成功"),t.emit("update:visible",!1),t.emit("save")):t.root.$message.error(e.data.message??"保存返点失败")},I=e=>{const t=R(e,"rebate/id_card_pic",0);return t},V=e=>{const t=R(e,"rebate/bank_card_pic",1);return t},R=async(e,a,r)=>{const o=new FormData;o.append("file",e.file,e.file.name),o.append("type",a);const s=await(0,pt.G1)(o),{data:l}=s;return l.success?r?i.value.bank_card_pic=l.data.source:i.value.id_card_pic=l.data.source:t.root.$message.error(l.message),s},M=()=>{i.value.id_card_pic=""},L=()=>{i.value.bank_card_pic=""},F=()=>{i.value=Dt(),o.value=void 0,r.value=[],c.value?.clearFiles(),n.value?.clearFiles(),d.value=!1,u.value=!1,m.value=[],_.value=[],setTimeout((()=>{s.value?.clearValidate()}),100)};return{saveLoading:p,close:g,save:h,getToken:x.LP,achievementList:r,achievementChanged:f,arch_amount:o,idCardPicRemoved:y,idCardPicUploaded:b,bankCardPicRemoved:k,bankCardPicUploaded:w,moneyChange:D,dealBankImgChange:j,dealIdImgChange:S,form:i,formRules:v,id_card_pic_upload:n,bank_card_pic_upload:c,ruleForm:s,project:a,hiddenBankUpload:d,hiddenIdUpload:u,idFileList:m,bankFileList:_,beforeUpload:C,uploadIdCardFile:I,uploadBankFile:V,onIdCardPicRemove:L,onBankPicRemove:M}}}),$t=Pt,It=(0,V.Z)($t,xt,St,!1,null,null,null),Vt=It.exports,Rt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-block",{staticClass:"dialog-build-in-cost-invoice"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter",attrs:{visible:e.visible,width:"440px",top:"600px","close-on-click-modal":!0},on:{close:e.close,closed:e.closed},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("发票详情")]},proxy:!0}])},[a("div",{staticStyle:{padding:"6px 24px 24px 24px"}},e._l(e.newInvoices,(function(t,r){return a("div",{key:r},[a("div",{staticClass:"title"},[e._v(e._s("凭证"+(r+1)))]),a("div",{staticClass:"container"},[a("el-image",{staticClass:"image",staticStyle:{cursor:"pointer"},attrs:{src:t.pic_url+"?"+e.tokenStr},on:{click:function(a){return e.showImage(t.pic_url+"?"+e.tokenStr)}}}),a("div",{staticClass:"invoice-content"},[a("div",{staticClass:"row line-clamp-1"},[a("span",{staticClass:"label"},[e._v("发票号码：")]),a("span",{staticClass:"value"},[e._v(e._s(t.invoice_num))])]),a("div",{staticClass:"row line-clamp-1"},[a("span",{staticClass:"label"},[e._v("开票日期：")]),a("span",{staticClass:"value"},[e._v(e._s(t.invoice_date))])]),a("div",{staticClass:"row line-clamp-1"},[a("span",{staticClass:"label"},[e._v("开票金额：")]),a("span",{staticClass:"value"},[e._v(e._s(t.amount_str))])]),a("div",{staticClass:"row line-clamp-1"},[a("span",{staticClass:"label"},[e._v("开票公司：")]),a("span",{staticClass:"value"},[e._v(e._s(t.institution))])])])],1)])})),0)])],1)},Mt=[],Lt=(0,l.defineComponent)({name:"CostInvoice",props:{visible:{type:Boolean},invoices:{type:Array}},setup(e,t){const a=`Authorization=${(0,x.LP)()}`,r=(0,l.ref)(!1),i=(0,l.computed)((()=>void 0===e.invoices||r.value?[]:[...e.invoices]));(0,l.watch)([()=>e.visible],(([e])=>{e&&(r.value=!1)}));const o=e=>{K.Z.showDetail(e)},s=()=>{t.emit("update:visible",!1)},n=()=>{r.value=!0};return{close:s,closed:n,tokenStr:a,newInvoices:i,showImage:o}}}),Ft=Lt,At=(0,V.Z)(Ft,Rt,Mt,!1,null,null,null),Et=At.exports,Nt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-block",{staticClass:"dialog-build-in-pay-certificate"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter",attrs:{visible:e.visible,width:"478px",top:"278px","close-on-click-modal":!0},on:{close:e.close,closed:e.closed},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("打款凭证详情")]},proxy:!0}])},[a("div",{staticStyle:{padding:"24px"}},e._l(e.picList,(function(t,r){return a("div",{key:r,style:r>0?"margin-top: 18px":""},[a("div",{staticClass:"title",staticStyle:{color:"#3c5269","font-weight":"600","margin-bottom":"12px","line-height":"18px"}},[e._v(" "+e._s("凭证"+(r+1))+" ")]),a("img",{staticClass:"image",staticStyle:{width:"100%",height:"100%","border-radius":"10px",border:"1px solid #e8ecee"},attrs:{src:t+"?"+e.tokenStr}})])})),0)])],1)},Tt=[],qt=(0,l.defineComponent)({name:"PayCertificate",props:{visible:{type:Boolean},pay_certificate_pic:{type:String}},setup(e,t){const a=`Authorization=${(0,x.LP)()}`,r=(0,l.ref)(!1),i=(0,l.computed)((()=>void 0===e.pay_certificate_pic||""===e.pay_certificate_pic||r.value?[]:e.pay_certificate_pic.split(",")));(0,l.watch)([()=>e.visible],(([e])=>{e&&(r.value=!1)}));const o=()=>{r.value=!0},s=()=>{t.emit("update:visible",!1)};return{picList:i,close:s,tokenStr:a,closed:o}}}),zt=qt,Ot=(0,V.Z)(zt,Nt,Tt,!1,null,null,null),Wt=Ot.exports,Zt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-block",{staticClass:"dialog-build-in-cost-vtask"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter",attrs:{visible:e.visible,width:"612px","close-on-click-modal":!0},on:{close:e.close},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("V任务链接")]},proxy:!0}])},[a("div",{staticStyle:{padding:"24px"}},[a("el-table",{staticStyle:{width:"100%"},attrs:{stripe:"",data:e.vtasks}},[a("el-table-column",{attrs:{prop:"v_task_url",label:"V任务链接",width:"282"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("tg-button",{staticClass:"line-clamp-1",attrs:{type:"link"},on:{click:function(a){return e.handleUrlClick(t.row.v_task_url)}}},[e._v(e._s(t.row.v_task_url))])]}}])}),a("el-table-column",{attrs:{prop:"item_url",label:"商品链接",width:"282"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("tg-button",{staticClass:"line-clamp-1",attrs:{type:"link"},on:{click:function(a){return e.handleUrlClick(t.row.item_url)}}},[e._v(e._s(t.row.item_url))])]}}])})],1)],1)])],1)},Bt=[],Yt=(0,l.defineComponent)({name:"CostVTask",props:{visible:{type:Boolean},vtasks:{type:Array}},setup(e,t){const a=()=>{t.emit("update:visible",!1)},r=e=>{window.open(e,"blank")};return{close:a,handleUrlClick:r}}}),Ht=Yt,Ut=(0,V.Z)(Ht,Zt,Bt,!1,null,null,null),Gt=Ut.exports,Kt=a(18728),Jt=a(86701),Qt=a(91660),Xt=a(17809),ea=a(10079),ta=a(35049);const aa=new G.ZP,ra=e=>""===e||void 0===e?"--":`￥${aa.format(e,G.WL.Yuan)}`,ia=e=>""===e||void 0===e?"--":`${aa.format(e,G.WL.Yuan)}`;var oa=(0,l.defineComponent)({name:"TgCostSchedule",components:{CostRegister:Ct,RebatesRegister:Vt,CostInvoice:Et,PayCertificate:Wt,CostVTask:Gt,ApplyDetail:Kt.Z,ApplicationDetail:Jt.Z,RefundDetail:Qt.Z,firstStep:ie.Z,PaymentDialog:ta.Z},setup(e,t){const a=(0,l.computed)((()=>t.root.$store.getters["marketing/aeList"]??[])),r=(0,S.gI)(),i=(0,l.ref)(!1),o=(0,l.inject)("MarketingProject")??(0,l.ref)(),s=t.root.$store.getters["user/getUserInfo"],n=(0,l.ref)({project_name:o?.value?o.value.cooperation_name:"",project_id:o?.value?o.value.cooperation_id:"",brand_name:o?.value?o.value.brand_name:"",brand_id:o?.value?o.value.brand_id:"",business_type:1});(0,l.watch)((()=>o?.value),(()=>{n.value={project_name:o?.value?o.value.cooperation_name:"",project_id:o?.value?o.value.cooperation_id:"",brand_name:o?.value?o.value.brand_name:"",brand_id:o?.value?o.value.brand_id:"",business_type:1}})),t.root.$store.hasModule("workbench")||t.root.$store.registerModule("workbench",Xt.T);const c=(0,l.computed)((()=>t.root.$store.state.workbench)),d=(0,l.computed)((()=>c.value.approval)),{id:u}=t.root.$route.params,p=(0,l.ref)(!1),m=(0,l.ref)(!1),_=(0,l.ref)(!1),v=(0,l.ref)(!1),f=(0,l.ref)(!1),g=(0,l.ref)(!1),h=(0,l.ref)(!1),b=(0,l.ref)(!1),k=(0,l.ref)(!1),C=(0,l.ref)(void 0),x=(0,l.ref)(void 0),D=(0,l.ref)(!1),P=(0,l.ref)(void 0),$=(0,l.ref)([]),I=(0,l.ref)(),V=(0,l.ref)(),R=(0,l.ref)(void 0),M=(0,l.ref)(void 0),L=(0,l.ref)(void 0),F=(0,l.computed)((()=>P.value?.data??[])),A=(0,l.ref)(void 0),E=e=>e.payable_uid,N=(0,l.computed)((()=>Math.max(...F.value.map((e=>(0,w.QN)(E(e)))),(0,w.QN)("应付编号")))),T=e=>ia(e.payable_amount),q=e=>e.settlement_uid,z=(0,l.computed)((()=>Math.max(...F.value.map((e=>(0,w.QN)(q(e)))),(0,w.QN)("结算清单")))),O=(0,l.computed)((()=>[{label:"应付编号",align:"left",minWidth:N.value,property:"payable_uid",formatter:e=>(0,l.h)("div",{class:"number-div"},[(0,l.h)("span",{class:"number-span "+(null!==e.reversed_id||null!==e.refunded_id?"reverse-red":"")},e.payable_uid)])},{label:"应付金额 (元)",align:"right",minWidth:120,formatter:e=>(0,l.h)("div",(0,ea.vs)(e)||(0,ea.Ep)(e)?{class:"reverse-red"}:{},T(e))},{label:"创建日期",align:"center",minWidth:120,property:"create_date",formatter:e=>y()(e.create_date).format("YYYY.MM.DD")},{label:"结算清单",align:"left",minWidth:z.value,property:"settlement_uid",formatter:e=>(0,l.h)("div",{class:"number-div"},[(0,l.h)("span",{class:"number-span text"},e.settlement_uid)])},{label:"核销状态",align:"center",minWidth:126,formatter:e=>{const t=(e.write_off_infos||[]).map((e=>[e.cost_id,e.write_off_amount,e.write_off_user,e.write_off_time]));(e.refund_write_off_info_items||[]).forEach((e=>{t.push([e.achievement_uid,-1*(e.write_off_amount??0),e.write_off_user,e.write_off_time])}));const a=["单据编号","核销金额 (元)","核销人/日期"];return(0,l.h)(J.Z,{attrs:{write_off_header:a,write_off_infos:t,write_off_status:e.write_off_status,is_reverse:null!==e.reversed_id}})}},{label:"操作",align:"center",fixed:"right",formatter:e=>{const t=[];return e.write_off_status!==ke.Bn.part&&e.write_off_status!==ke.Bn.none||null!==e.reverse_id||(0,ea.vs)(e)||!r.marketing_project_write_off_save||(0,ea.Ep)(e)||t.unshift((0,l.h)("a",{on:{click:()=>{A.value?.show({type:"isPayable",id:e.id,amount:e.not_write_off_amount,leaf:"coop",busType:e.payable_type,receivable_uid:e.payable_uid})}}},"核销")),(0,l.h)("div",{class:"operation"},t)}}])),W=(0,l.computed)((()=>{const e=a.value.filter((e=>e.ae_id===s.id));return s.id===o.value?.add_by_id||s.id===o.value?.manager_id||e.length>0})),Z=(0,l.computed)((()=>s.id===o.value?.add_by_id||s.id===o.value?.manager_id)),B=()=>{h.value=!1},Y=()=>{b.value=!1},H=()=>{k.value=!1},U=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_cost_view),t=(0,S.kG)(j.HN.marketing_project_cost_change);return{canChange:t,canViewList:e}})),G=async()=>{D.value=!0;const e=await(0,pt.Cl)(u,1);if(D.value=!1,e.data.success){const{payable:t,write_off:a,not_write_off:r}=e.data.data,i={...e.data.data,stat_info:{payable:t,write_off:a,not_write_off:r}};P.value=i}else t.root.$message.error(e.data.message??"获取成本安排表失败，请稍后重试")},K=e=>{v.value=!0,I.value=e.invoice_info},Q=()=>{G()};G();const X=32,ee=34,te=36,ae=31,re=(0,l.ref)(251),ie=(0,oe.Z)({compensation:(0,l.computed)((()=>X+ee+te+ae)),fixedBlockHeightRefs:[re],tableMinHeight:100}),se=()=>{i.value=!0};return{Permission:U,loading:D,applyDetailClose:B,applicationDetailClose:Y,refundDetailClose:H,deleteLoading:p,costInvoiceVisible:v,costRegisterVisible:m,rebatesRegisterVisible:_,payCertificateVisible:f,costVTaskVisible:g,customerVisible:h,applicationDetailVisible:b,refundVisible:k,costSchedule:P,costDataList:F,invoices:I,vtasks:$,payCertificatePic:V,columns:O,moneyFormat:ra,lookupInvoice:K,costListSaved:Q,editCost:x,editRebate:C,applyDetailRef:R,applicationDetailRef:M,refundDetailDialogRef:L,costRegisterPermission:W,costRebatePermission:Z,approval:d,firstStepRef:A,paymentDialogVisible:i,showPaymentDialog:se,paymentData:n,...ie}}}),sa=oa,la=(0,V.Z)(sa,dt,ut,!1,null,null,null),na=la.exports,ca=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-card",e._b({staticClass:"marketing-project-cost-schedule flex-none",on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("div",{staticClass:"cost-headers",staticStyle:{padding:"12px 0"}},[a("div",{staticClass:"cost-headers-sumary"},[a("span",{staticClass:"cost-headers-sumary-label"},[e._v("登记付款：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.total_pay_amount):"--"))]),a("span",{staticClass:"cost-headers-sumary-label"},[e._v("已付款：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.paid_amount):"--"))]),a("span",{staticClass:"cost-headers-sumary-label"},[e._v("待付款：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.wait_pay_amount):"--"))]),a("span",{staticClass:"cost-headers-sumary-label"},[e._v("已核销金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.write_off_amount):"--"))]),a("span",{staticClass:"cost-headers-sumary-label"},[e._v("未核销金额：")]),a("span",{staticClass:"cost-headers-sumary-value"},[e._v(e._s(e.costSchedule?e.moneyFormat(e.costSchedule.stat_info.not_write_off_amount):"--"))])])]),e.Permission.canViewList?a("el-table",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{stripe:"",border:"",data:e.costDataList,"cell-style":{cursor:"pointer"}},on:{"row-click":function(t){return t.target!==t.currentTarget?null:e.onRowClick.apply(null,arguments)}},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无数据"}})]},proxy:!0}],null,!1,2826547353)},"el-table",e.tableProps,!1),e._l(e.columns,(function(t,r){return a("el-table-column",e._b({key:r},"el-table-column",t,!1))})),1):e._e(),a("CostRegister",{style:e.costRegisterVisible?void 0:"display: none",attrs:{editCost:e.editCost,visible:e.costRegisterVisible},on:{"update:visible":function(t){e.costRegisterVisible=t},save:e.costListSaved}}),a("RebatesRegister",{style:e.rebatesRegisterVisible?void 0:"display: none",attrs:{editRebate:e.editRebate,visible:e.rebatesRegisterVisible},on:{"update:visible":function(t){e.rebatesRegisterVisible=t},save:e.costListSaved}}),a("CostInvoice",{style:e.costInvoiceVisible?void 0:"display: none",attrs:{visible:e.costInvoiceVisible,invoices:e.invoices},on:{"update:visible":function(t){e.costInvoiceVisible=t}}}),a("PayCertificate",{style:e.payCertificateVisible?void 0:"display: none",attrs:{visible:e.payCertificateVisible,pay_certificate_pic:e.payCertificatePic},on:{"update:visible":function(t){e.payCertificateVisible=t}}}),a("CostVTask",{style:e.costVTaskVisible?void 0:"display: none",attrs:{visible:e.costVTaskVisible,vtasks:e.vtasks},on:{"update:visible":function(t){e.costVTaskVisible=t}}}),e.customerVisible?a("PaymentDetailDialog",{attrs:{visible:e.customerVisible,info:e.approval},on:{"dialog:close":e.applyDetailClose}}):e._e(),e.applicationDetailVisible?a("AdvanceDetailDialog",{attrs:{visible:e.applicationDetailVisible,info:e.approval},on:{"dialog:close":e.applicationDetailClose}}):e._e(),e.refundVisible?a("refund-detail-dialog",{attrs:{visible:e.refundVisible,info:e.approval,isrealpay:!0},on:{"dialog:close":e.refundDetailClose}}):e._e(),a("tg-mask-loading",{attrs:{visible:e.deleteLoading,content:"正在删除，请稍候..."}}),a("first-step",{ref:"firstStepRef",on:{submit:e.costListSaved}}),a("reverseOrderDialog",{ref:"reverseOrderDialogRef"}),a("tg-mask-loading",{attrs:{visible:e.reverseLoading,content:"正在提交冲销，请稍候..."}}),a("tg-mask-loading",{attrs:{visible:e.reverseAgainLoading,content:"正在重新提交冲销，请稍候..."}}),a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",attrs:{visible:e.reasonDialogVisible,width:"440px"},on:{close:e.onReasonDialogClose},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(e._s(e.reasonDialogTitle))]},proxy:!0}])},[a("div",{staticClass:"reason-dialog-content"},[e._v(e._s(e.reason))])]),a("pay-refund",{attrs:{rawAmount:e.payRefundAmout,visible:e.payRefundVisible,costId:e.payRefundCostId},on:{"update:visible":function(t){e.payRefundVisible=t},save:e.onPayRefundSave}}),a("refund-write-off",{attrs:{type:"receive",projectType:2,visible:e.refundWriteOffVisible,notWriteOffAmount:e.notRefundWriteOffAmount,invoiceId:e.refundWriteoffId,costId:e.refundWriteoffCostId},on:{"update:visible":function(t){e.refundWriteOffVisible=t},save:e.onRefundWriteOffSave}}),e.loanDetailVisible?a("LoanfinanceDetailModal",{attrs:{visible:e.loanDetailVisible,detailroval:e.detailroval},on:{"dialog:closerow":e.onLoanDetailClose}}):e._e(),a("start-pay",{attrs:{visible:e.startPayVisible,cost:e.startPayCost},on:{"update:visible":function(t){e.startPayVisible=t},save:e.onStartPaySave}})],1)},da=[],ua=a(41532),pa=a(5968),ma=a(7629),_a=a(22895),va=a(70727),fa=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-cost-start-pay"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter-new",attrs:{visible:e.visible,width:"440px",title:"发起打款","close-on-click-modal":!1},on:{close:e.onClose},scopedSlots:e._u([{key:"footer",fn:function(){return[a("tg-button",{on:{click:e.onClose}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.onSave}},[e._v("保存")])]},proxy:!0}])},[a("div",{staticClass:"cost-start-pay-container"},[a("el-form",{ref:"elFormRef",attrs:{model:e.formData,rules:e.elFormRules,"label-width":"80px","label-position":"top",size:"small"}},[a("el-form-item",{attrs:{label:"KOL名称",prop:"kol"}},[a("el-select",{attrs:{filterable:"",remote:"","reserve-keyword":"",placeholder:"请输入并选择KOL名称","remote-method":e.queryKOL,loading:e.queryKOLloading,"value-key":"kol_name"},model:{value:e.formData.kol,callback:function(t){e.$set(e.formData,"kol",t)},expression:"formData.kol"}},e._l(e.kolList,(function(e){return a("el-option",{key:e.kol_id,attrs:{label:e.kol_name,value:e}})})),1)],1),a("el-form-item",{attrs:{label:"业务执行日期",prop:"start_end_date"}},[a("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"daterange","range-separator":"～",format:"yyyy.MM.dd","value-format":"yyyy-MM-dd","start-placeholder":"开始日期","end-placeholder":"结束日期",editable:!1,clearable:!1},model:{value:e.formData.start_end_date,callback:function(t){e.$set(e.formData,"start_end_date",t)},expression:"formData.start_end_date"}})],1),a("el-form-item",{attrs:{label:"打款日期",prop:"pay_date"}},[a("el-date-picker",{staticStyle:{width:"100%"},attrs:{type:"date",placeholder:"请选择打款日期",format:"yyyy.MM.dd","value-format":"yyyy-MM-dd",editable:!1,clearable:!1},model:{value:e.formData.pay_date,callback:function(t){e.$set(e.formData,"pay_date",t)},expression:"formData.pay_date"}})],1),2===e.cost.pay_way?a("el-form-item",{attrs:{label:"V任务链接",prop:"v_task_link"}},[a("el-input",{attrs:{placeholder:"请输入V任务链接"},model:{value:e.formData.v_task_link,callback:function(t){e.$set(e.formData,"v_task_link","string"===typeof t?t.trim():t)},expression:"formData.v_task_link"}})],1):e._e(),2===e.cost.pay_way?a("el-form-item",{attrs:{label:"产品链接",prop:"v_task_product_link"}},[a("el-input",{attrs:{placeholder:"请输入产品链接"},model:{value:e.formData.v_task_product_link,callback:function(t){e.$set(e.formData,"v_task_product_link","string"===typeof t?t.trim():t)},expression:"formData.v_task_product_link"}})],1):e._e()],1)],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在保存，请稍候..."}})],1)},ga=[];const ha=()=>({kol:void 0,start_end_date:[],pay_date:y()().format("yyyy-MM-DD"),v_task_link:void 0,v_task_product_link:void 0});var ya=(0,l.defineComponent)({props:{visible:{type:Boolean,default:!1},cost:{type:Object,require:!0,default:()=>({pay_way:1})}},emits:["close","save"],setup(e,t){const a=(0,l.ref)(!1),r=(0,l.ref)(!1),i=(0,l.ref)(void 0),o=(0,l.ref)(ha()),s=(0,l.ref)([]),n={kol:[{required:!0,message:"请输入并选择KOL名称",trigger:"change"}],start_end_date:[{required:!0,message:"请选择业务执行日期",trigger:"change"}],v_task_link:[{required:!0,message:"请输入V任务链接",trigger:"blur"}],v_task_product_link:[{required:!0,message:"请输入产品链接",trigger:"blur"}]},c={onClose:()=>{t.emit("update:visible",!1),t.emit("close")},onSave:()=>{let t=["kol","start_end_date"];2===e.cost.pay_way&&(t=["kol","start_end_date","v_task_link","v_task_product_link"]);let a=0;i.value?.validateField(t,(e=>{e||(a+=1,a===t.length&&c.savePayRequest())}))},queryKOL:async e=>{if(!e)return void(s.value=[]);r.value=!0;const t=await(0,vt.Sx)({kol_name:e});r.value=!1,t.data.success?s.value=t.data.data.filter((e=>e.kol_id>0))??[]:s.value=[]},savePayRequest:async()=>{const[r,i]=o.value.start_end_date;a.value=!0;const s={cost_id:e.cost?.cost_id,kol_id:o.value.kol?.kol_id??-1,pay_way:e.cost?.pay_way,live_start_date:r,live_end_date:i,transfer_date:o.value.pay_date,v_task_list:2===e.cost.pay_way?[{item_url:o.value.v_task_product_link,v_task_url:o.value.v_task_link}]:void 0},l=await(0,pt.Kh)(s);a.value=!1,l.data.success?(t.root.$message.success("发起打款成功"),t.emit("save")):t.root.$message.error(l.data.message??"发起打款失败")}};return(0,l.watch)([()=>e.visible],(([e])=>{e||(o.value=ha(),s.value=[],setTimeout((()=>{i.value?.clearValidate()}),300))})),{kolList:s,saveLoading:a,queryKOLloading:r,elFormRules:n,elFormRef:i,formData:o,...c}}}),ba=ya,ka=(0,V.Z)(ba,fa,ga,!1,null,null,null),wa=ka.exports,Ca=a(92656);const xa=new G.ZP,Sa=e=>""===e||void 0===e?"--":`￥${xa.format(e,G.WL.Yuan)}`;var ja=(0,l.defineComponent)({name:"TgCostSchedule",components:{CostRegister:Ct,RebatesRegister:Vt,CostInvoice:Et,PayCertificate:Wt,CostVTask:Gt,RefundDetailDialog:ua.Z,firstStep:ie.Z,reverseOrderDialog:Pe.Z,AdvanceDetailDialog:pa.Z,PaymentDetailDialog:ma.Z,PayRefund:va.Z,RefundWriteOff:Ie.Z,StartPay:wa,LoanfinanceDetailModal:Ca.Z},setup(e,t){const a=(0,l.computed)((()=>t.root.$store.getters["marketing/aeList"]??[])),r=(0,S.gI)(),i=(0,l.inject)("MarketingProject")??(0,l.ref)(),o=t.root.$store.getters["user/getUserInfo"],s=(0,l.ref)(!1),n=(0,l.ref)(!1),c=(0,l.ref)(void 0);t.root.$store.hasModule("workbench")||t.root.$store.registerModule("workbench",Xt.T);const d=(0,l.computed)((()=>t.root.$store.state.workbench)),u=(0,l.computed)((()=>d.value.approval)),{id:p}=t.root.$route.params,m=(0,l.ref)(void 0),_=(0,l.ref)(!1),v=(0,l.ref)(!1),f=(0,l.ref)(!1),g=(0,l.ref)(!1),h=(0,l.ref)(!1),y=(0,l.ref)(!1),b=(0,l.ref)(!1),k=(0,l.ref)(!1),x=(0,l.ref)(!1),D=(0,l.ref)(void 0),P=(0,l.ref)(void 0),$=(0,l.ref)(!1),I=(0,l.ref)(void 0),V=(0,l.ref)([]),R=(0,l.ref)(),M=(0,l.ref)(),L=(0,l.ref)(void 0),F=(0,l.ref)(void 0),A=(0,l.ref)(void 0),E=(0,l.ref)(void 0),N=(0,l.ref)(!1),T=(0,l.computed)((()=>I.value?.data??[])),q=(0,l.computed)((()=>{const e=a.value.filter((e=>e.ae_id===o.id));return o.id===i.value?.add_by_id||o.id===i.value?.manager_id||e.length>0})),z=(0,l.computed)((()=>o.id===i.value?.add_by_id||o.id===i.value?.manager_id)),O=e=>{switch(e){case 1:return"银行卡";case 2:return"V任务";case 3:return"对公银行";case 4:return"支付宝";default:return"--"}},W=e=>{switch(e){case 1:return"成本";case 2:return"退款";default:return"--"}},Z=e=>{switch(e){case 0:return"待打款";case 1:return"已打款";case-1:return"待发起打款";default:return"--"}},B=()=>{b.value=!1},Y=()=>{k.value=!1},H=()=>{x.value=!1},U=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_cost_view),t=(0,S.kG)(j.HN.marketing_project_cost_change);return{canChange:t,canViewList:e}})),G=(0,l.ref)(null),{visible:K,toggleVisible:Q}=(0,fe.Z)(),X=(0,l.ref)(void 0),ee=async(e,a)=>{Q();const[{data:r}]=await(0,C.Dc)(500,(0,ge.Tu)({id:e.cost_id,reverse_type:ke.Jd.payment,reverse_reason:a}));return Q(),r.success?(t.root.$message.success(r.message??"发起冲销成功"),ye()):t.root.$message.error(r.message??"发起冲销失败"),r.success},{visible:te,toggleVisible:ae}=(0,fe.Z)(),re=async(e,a)=>{ae();const[{data:r}]=await(0,C.Dc)(500,(0,ge.Xz)({id:e.cost_id,reverse_type:ke.Jd.payment,reverse_reason:a}));return ae(),r.success?(t.root.$message.success(r.message??"重新提交成功"),ye()):t.root.$message.error(r.message??"重新提交失败"),r.success},ie=(0,l.ref)(!1),se=(0,l.ref)(""),le=(0,l.ref)(""),ne=()=>{se.value="",ie.value=!1},ce=e=>{le.value="退回原因",se.value=e.reverse_back_reason,ie.value=!0},de=e=>{le.value="冲销原因",se.value=e.reverse_reason,ie.value=!0},ue=(e,t)=>t?e.uid:(0,l.h)("span",{class:null!==e.reversed_id?"reverse-red":""},[e.uid]),pe=e=>(0,w.dN)(e.pay_amount,""),me=(e,t)=>{const a=e.pay_reason||"--",{is_folded:r,folded_text:i}=(0,w.zb)(a,12);return t||!r?i:(0,l.h)("el-popover",{props:{placement:"right",trigger:"hover",content:a}},[(0,l.h)("span",{slot:"reference"},[i])])},ve=(e,t)=>{const a=e.company_name||"--",{is_folded:r,folded_text:i}=(0,w.zb)(a,12);return t||!r?i:(0,l.h)("el-popover",{props:{placement:"right",trigger:"hover",content:a}},[(0,l.h)("span",{slot:"reference"},[i])])},he=(0,l.computed)((()=>[{label:"付款编号",fixed:"left",align:"center",minWidth:(0,Qe.zY)(T,"付款编号",ue).value,formatter:e=>ue(e,!1)},{label:"付款金额 (元)",align:"right",minWidth:(0,Qe.zY)(T,"付款金额 (元)",pe).value,formatter:e=>pe(e)},{label:"付款类型",minWidth:80,align:"center",formatter:e=>(0,l.h)("div",W(e.pay_type))},{label:"付款方式",minWidth:80,align:"center",formatter:e=>(0,l.h)("div",O(e.pay_way))},{label:"付款事由",minWidth:(0,Qe.zY)(T,"付款事由",me).value,formatter:e=>me(e,!1)},{label:"供应商",minWidth:(0,Qe.zY)(T,"供应商",ve).value,formatter:e=>ve(e,!1)},{label:"是否开票",minWidth:80,align:"center",formatter:e=>{let t;return e.is_invoice&&(t={click:t=>{Ce(e),t.stopPropagation()}}),(0,l.h)("div",[(0,l.h)("tg-button",{props:{type:"link",disabled:0===e.is_invoice},on:t,class:"invoices-link",style:{color:e.is_invoice?"#2877FF":void 0}},e.is_invoice?"查看":"未开票")])}},{label:"付款时间",minWidth:100,align:"center",formatter:e=>e.pay_date?e.pay_date.replace(/-/g,"."):"--"},{label:"付款凭证",minWidth:80,align:"center",formatter:e=>1===e.is_pay?(0,l.h)("tg-button",{props:{type:"link"},on:{click:t=>{h.value=!0,M.value=e.pay_certificate_pic,t.stopPropagation()}}},"查看"):"--"},{label:"核销状态",width:143,formatter:e=>{if(7!==e.new_cost_type&&9!==e.new_cost_type&&2!==e.pay_type)return"--";let t=[];t=2===e.pay_type?(e.refund_write_off_infos||[]).map((e=>[e.settlement_uid,e.receivable_uid,-1*e.write_off_amount,e.write_off_user,e.write_off_time])):(e.write_off_infos||[]).map((e=>[e.settlement_uid,e.payable_uid,e.write_off_amount,e.write_off_user,e.write_off_time]));const a=["结算单编号",2===e.pay_type?"应收编号":"应付编号","核销金额 (元)","核销人/日期"];return(0,l.h)(J.Z,{attrs:{write_off_header:a,write_off_infos:t,write_off_status:e.write_off_status,is_reverse:null!==e.reversed_id}})}},{label:"单据状态",minWidth:100,align:"center",formatter:e=>(0,l.h)("div",{style:{color:0===e.is_pay?"#ff7a36":1===e.is_pay?void 0:"#ffac15"}},[Z(e.is_pay)])},{label:"操作",align:"left",minWidth:160,fixed:"right",formatter:e=>{const t=[],a=-1===e.is_pay;if(a){const a=(0,l.h)("tg-button",{props:{type:"link"},on:{click:t=>{X.value={cost_id:e.cost_id,pay_way:e.pay_way},N.value=!0,t.stopPropagation()}}},["发起打款"]);return t.push(a),(0,l.h)("div",{class:"operation"},t)}if(null===e.reversed_id?(null!==e.reverse_id||e.is_pay!==_a.w.YES||2===e.pay_type||e.has_refund||t.push((0,l.h)("a",{class:"reverse-red",on:{click:t=>{G.value?.open((t=>ee(e,t))),t.stopPropagation()}}},["冲销"])),(1===e.write_off_status||0===e.write_off_status)&&r.marketing_project_write_off_save&&7===e.new_cost_type&&e.is_pay&&null===e.reverse_id&&t.push((0,l.h)("a",{on:{click:t=>{m.value?.show({type:"isActual",id:e.cost_id,amount:e.not_write_off_amount,leaf:"coop",busType:e.business_type,receivable_uid:e.cost_id,cost_split_id:e.id}),t.stopPropagation()}}},"核销"))):ke.h0.wait_confirm===e.reverse_status||ke.h0.confirmed===e.reverse_status?t.push((0,l.h)("a",{on:{click:t=>{de(e),t.stopPropagation()}}},["查看"])):(r.marketing_project_settlement_delete&&t.push((0,l.h)("a",{on:{click:t=>{we(e.cost_id,"是否删除该冲销单"),t.stopPropagation()}}},["删除"])),t.push((0,l.h)("a",{on:{click:t=>{G.value?.open((t=>re(e,t)),e.reverse_reason),t.stopPropagation()}}},["重新提交"])),t.push((0,l.h)("a",{on:{click:t=>{ce(e),t.stopPropagation()}}},["退回原因"]))),e.is_pay&&2!==e.pay_type&&!e.reverse_id&&null===e.reverse_status){const a=(0,l.h)("tg-button",{props:{type:"link"},on:{click:t=>{E.value=new(be())(e.pay_amount??0).sub(new(be())(e.refunded_amount??0)).toNumber(),s.value=!0,c.value=e.raw_cost_id,t.stopPropagation()}}},["退款"]);t.push(a)}if(e.is_pay&&2===e.pay_type&&!e.reverse_id&&!e.reversed_id&&2!==e.write_off_status){const a=(0,l.h)("tg-button",{props:{type:"link"},on:{click:t=>{n.value=!0,L.value=e.not_write_off_amount,F.value=e.achievement_uid,A.value=e.cost_id,t.stopPropagation()}}},["核销"]);t.push(a)}return 0!==e.is_pay||1!==e.pay_type&&2!==e.pay_type||!r.marketing_project_settlement_delete||t.push((0,l.h)("a",{on:{click:t=>{we(e.cost_id,"确认删除"+(1===e.pay_type?"成本":"退款")),t.stopPropagation()}}},["删除"])),(0,l.h)("div",{class:"operation"},t)}}])),ye=async()=>{$.value=!0;const e=await(0,pt.G9)(p);$.value=!1,e.data.success?I.value=e.data.data:t.root.$message.error(e.data.message??"获取成本安排表失败，请稍后重试")},we=async(e,a="确认删除该成本？")=>{const r=await(0,_e.I)(t,a);if(!r)return;_.value=!0;const i=await(0,pt.Sg)(e);_.value=!1,i.data.success?(t.root.$message.success("删除成功"),ye()):t.root.$message.error(i.data.message??"删除失败，稍后重试")},Ce=e=>{g.value=!0,R.value=e.invoice_info},xe=()=>{ye()};ye();const Se=32,je=34,De=36,Pe=31,$e=(0,l.ref)(251),Ie=(0,oe.Z)({compensation:(0,l.computed)((()=>Se+je+De+Pe)),fixedBlockHeightRefs:[$e],tableMinHeight:100}),Ve=()=>{s.value=!1,ye()},Re=()=>{n.value=!1,ye()},Me=()=>{N.value=!1,ye()},Le=(0,l.ref)(!1),Fe=(0,l.ref)({name:"123"}),Ae=e=>{Fe.value=e,Le.value=!0},Ee=()=>{Le.value=!1};return{payRefundVisible:s,refundWriteOffVisible:n,Permission:U,loading:$,applyDetailClose:B,applicationDetailClose:Y,refundDetailClose:H,deleteLoading:_,costInvoiceVisible:g,costRegisterVisible:v,rebatesRegisterVisible:f,payCertificateVisible:h,costVTaskVisible:y,customerVisible:b,applicationDetailVisible:k,refundVisible:x,costSchedule:I,costDataList:T,invoices:R,vtasks:V,payCertificatePic:M,columns:he,moneyFormat:Sa,lookupInvoice:Ce,costListSaved:xe,editCost:P,editRebate:D,costRegisterPermission:q,costRebatePermission:z,approval:u,firstStepRef:m,reverseOrderDialogRef:G,reverseLoading:K,reverseAgainLoading:te,reasonDialogVisible:ie,reason:se,reasonDialogTitle:le,onReasonDialogClose:ne,...Ie,onPayRefundSave:Ve,payRefundCostId:c,onRefundWriteOffSave:Re,notRefundWriteOffAmount:L,refundWriteoffId:F,refundWriteoffCostId:A,payRefundAmout:E,startPayVisible:N,detailroval:Fe,loanDetailVisible:Le,onRowClick:Ae,onLoanDetailClose:Ee,startPayCost:X,onStartPaySave:Me}}}),Da=ja,Pa=(0,V.Z)(Da,ca,da,!1,null,null,null),$a=Pa.exports,Ia=(0,l.defineComponent)({components:{SubTabs:A.Z,comp1:na,comp2:$a}}),Va=Ia,Ra=(0,V.Z)(Va,nt,ct,!1,null,null,null),Ma=Ra.exports,La=a(52140),Fa=a(91354),Aa=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-marketing-project-ae-dialog tg-dialog-vcenter"},[a("el-dialog",{staticClass:"tg-dialog-classic tg-marketing-project-aeplus-form-dialog",attrs:{visible:e.visible,"close-on-click-modal":!1,"close-on-press-escape":!1,width:"440px"},on:{close:e.onCloseBtnClick},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("指定AE")]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{on:{click:e.onCloseBtnClick}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.onSaveBtnClick}},[e._v("保存")])]},proxy:!0}])},[a("div",{staticClass:"form-content"},[a("el-form",{attrs:{"label-position":"top",size:"small","label-width":"106px"}},e._l(e.ProjectAeForm.ae_infos,(function(t,r){return a("div",{key:r,staticClass:"form-item"},[e.ProjectAeForm.ae_infos.length>1?a("div",{staticClass:"form-item-remove-btn",on:{click:function(t){return e.removeItemHandler(r)}}},[a("tg-icon",{staticStyle:{"font-size":"16px",cursor:"pointer"},attrs:{slot:"icon",name:"ico-frm-delete","hover-name":"ico-frm-delete-active"},slot:"icon"})],1):e._e(),a("el-form-item",{staticClass:"two-item-left",attrs:{label:"AE名称"}},[a("el-select",{attrs:{filterable:"",placeholder:"请选择AE"},model:{value:t.ae_id,callback:function(a){e.$set(t,"ae_id",a)},expression:"item.ae_id"}},e._l(e.AeUserList,(function(r,i){return a("el-option",{key:i,attrs:{disabled:e.NotExistsAeIdList.includes(t.id),label:r.username,value:r.id}},[a("span",[e._v(e._s(r.username))])])})),1)],1),a("el-form-item",{staticClass:"two-item-right",attrs:{label:"预计跟单金额"}},[a("el-input",{attrs:{placeholder:"请输入跟单金额",maxlength:"20"},on:{input:function(t){return e.inputPositiveNumber(t,r)}},scopedSlots:e._u([{key:"append",fn:function(){return[e._v("元")]},proxy:!0}],null,!0),model:{value:t.expect_amount,callback:function(a){e.$set(t,"expect_amount",a)},expression:"item.expect_amount"}})],1)],1)})),0),a("div",{staticClass:"flex-none",staticStyle:{padding:"0 24px 24px 24px"}},[a("tg-ghost-button",{staticStyle:{width:"392px"},on:{click:e.addItemHandler}},[a("a",[e._v("点击添加")])])],1)],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})],1)},Ea=[],Na=a(53451),Ta=a.n(Na),qa=a(86863);const{debounce:za}=Ta();var Oa,Wa,Za=(0,l.defineComponent)({name:"TgMarketingAeDialog",props:{visible:{type:Boolean,default:!1},ProjectAeList:{type:Array}},setup(e,t){const a=(0,l.ref)(-1);try{a.value=parseInt(t.root.$route.params.id,10)}catch{a.value=-1}const r=(0,l.ref)({cooperation_id:a.value,ae_infos:[]}),i=e=>{r.value.ae_infos.length>1&&r.value.ae_infos.splice(e,1)},o=()=>{r.value.ae_infos.push({ae_id:"",ae_name:"",expect_amount:""})},s=()=>{r.value.ae_infos=[{ae_id:"",ae_name:"",expect_amount:""}],p.value=[]},n=(e,t)=>{const a=(0,w.nA)(e);r.value.ae_infos[t].expect_amount=a},c=()=>{s(),t.emit("dialog:close")},d=(0,l.ref)(!1),u=async()=>{if(d.value)return;if(-1===r.value.cooperation_id)return void t.root.$message.error("无效的项目ID");if(r.value.ae_infos.length<1)return void t.root.$message.error("请指定AE");const e=(0,l.ref)("");if(r.value.ae_infos.forEach(((t,a)=>{t.ae_id?t.expect_amount?"0"!==t.expect_amount||(e.value="跟单金额不能为0"):e.value="请输入跟单金额":e.value="请选择AE"})),e.value)return void t.root.$message.error(e.value);const a={cooperation_id:r.value.cooperation_id,ae_infos:r.value.ae_infos};d.value=!0;const[{data:i},o]=await Promise.all([await(0,pt.oN)(a),await(0,C._v)(200)]);d.value=!1,i.success?(t.root.$message.success(i.message),t.emit("dialog:close",!0),t.root.$store.dispatch("marketing/setProjectInfo",-1)):t.root.$message.error(i.message??"AE保存失败")},p=(0,l.ref)([]),m=(0,l.ref)([]),_=async()=>{const{data:t}=await(0,qa.pc)({roles:"1007",business_type:k.WD.marketing});m.value=t.success?t.data:[];const a=m.value.map((e=>e.id.toString()));e.ProjectAeList?.map((e=>{if(!a.includes(e.ae_id.toString())){const t=parseInt(e.ae_id.toString(),10);p.value.push(t),m.value.push({id:t,username:e.ae_name})}}))};(0,l.watch)((()=>e.visible),(t=>{t&&(_(),r.value.cooperation_id=a.value,r.value.ae_infos=e.ProjectAeList?.length?JSON.parse(JSON.stringify(e.ProjectAeList)):[{ae_id:"",ae_name:"",expect_amount:""}])}));const v=za(u,200);return{NotExistsAeIdList:p,inputPositiveNumber:n,AeUserList:m,ProjectAeForm:r,saveLoading:d,onCloseBtnClick:c,onSaveBtnClick:v,addItemHandler:o,removeItemHandler:i}}}),Ba=Za,Ya=(0,V.Z)(Ba,Aa,Ea,!1,null,null,null),Ha=Ya.exports,Ua=a(68762),Ga=a(78066),Ka=a(44928),Ja=(0,l.defineComponent)({props:{},components:{CalendarPage:Ua.Z},setup(e){const t=(0,Ka.t)(),a=t.currentRoute.params.id,r=(e,t,a)=>(0,Ga.A8)(e,t,a),i=e=>(0,Ga.w3)({...e,project_id:a}).then((e=>{if(!e.data.success)throw new Error(e.data.message);return e}));return{query:r,save:i}},render(){const e=arguments[0];return e("calendar-page",U()([{},{props:{query:this.query,save:this.save,type:"market"}}]))}}),Qa=Ja,Xa=(0,V.Z)(Qa,Oa,Wa,!1,null,null,null),er=Xa.exports,tr=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-marketing-project-finish-dialog tg-dialog-vcenter"},[a("el-dialog",{staticClass:"tg-dialog-classic",attrs:{visible:e.visible,"close-on-click-modal":!1,"close-on-press-escape":!1,width:"440px"},on:{close:e.onCloseBtnClick},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("执行结束")]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{on:{click:e.onCloseBtnClick}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.onSaveBtnClick}},[e._v("保存")])]},proxy:!0}])},[a("div",{staticClass:"form-content"},[a("el-form",{ref:"formRef",attrs:{model:e.ProjectConfirmForm,rules:e.formRules,"label-position":"top",size:"small","label-width":"106px"}},[a("el-form-item",{attrs:{label:"执行结果",prop:"end_type"}},[a("el-select",{staticClass:"info-name-select",attrs:{size:"medium",placeholder:"请选择执行结果"},model:{value:e.ProjectConfirmForm.end_type,callback:function(t){e.$set(e.ProjectConfirmForm,"end_type",t)},expression:"ProjectConfirmForm.end_type"}},[a("el-option",{attrs:{value:1,label:"正常结束"}}),a("el-option",{attrs:{value:2,label:"意外终止"}})],1)],1),2===e.ProjectConfirmForm.end_type?a("div",[a("el-form-item",{attrs:{label:"终止处理",prop:"unexpected_terminate_type"}},[a("el-radio-group",{staticClass:"radioGroup",model:{value:e.ProjectConfirmForm.unexpected_terminate_type,callback:function(t){e.$set(e.ProjectConfirmForm,"unexpected_terminate_type",t)},expression:"ProjectConfirmForm.unexpected_terminate_type"}},[a("el-radio",{attrs:{label:1}},[e._v("补播")]),a("el-radio",{attrs:{label:2}},[e._v("退款")]),a("el-radio",{attrs:{label:3}},[e._v("其他")])],1)],1),3===e.ProjectConfirmForm.unexpected_terminate_type?a("el-form-item",{staticClass:"caseTextarea",attrs:{label:"",prop:"unexpected_terminate_detail"}},[a("el-input",{attrs:{maxlength:"20",placeholder:"请输入处理方案",type:"textarea","show-word-limit":!0},model:{value:e.ProjectConfirmForm.unexpected_terminate_detail,callback:function(t){e.$set(e.ProjectConfirmForm,"unexpected_terminate_detail",t)},expression:"ProjectConfirmForm.unexpected_terminate_detail"}})],1):e._e()],1):e._e()],1),a("div",{staticStyle:{color:"#6a7b92"}},[e._v("执行结束后，不允许进行成本和收入结算")])],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在保存，请稍候..."}})],1)},ar=[];const{debounce:rr}=Ta();var ir=(0,l.defineComponent)({name:"TgMarketingProjectExecuteFinishDialog",props:{visible:{type:Boolean,default:!1}},setup(e,t){const a=(0,l.ref)(null),r=(0,l.ref)({end_type:[{required:!0,message:"请选择执行结果",trigger:"blur"}],unexpected_terminate_type:[{required:!0,message:"请选择终止处理类型",trigger:"blur"}],unexpected_terminate_detail:[{required:!0,message:"请输入处理方案",trigger:"blur"}]}),i=(0,l.inject)("MarketingProject")??(0,l.ref)(),o=(0,l.computed)((()=>i.value)),s=(0,l.ref)({cooperation_id:o.value?.cooperation_id??-1,end_type:1,unexpected_terminate_type:1,unexpected_terminate_detail:"",is_update:0});(0,l.watch)((()=>e.visible),(e=>{e&&(n(),a.value?.resetFields(),s.value.cooperation_id=o.value?.cooperation_id??-1)}));const n=()=>{s.value.end_type=1,s.value.unexpected_terminate_type=1,s.value.unexpected_terminate_detail="",s.value.is_update=0},c=()=>{t.emit("dialog:close")},d=(0,l.ref)(!1),u=async()=>{if(d.value)return;const e=await new Promise((e=>a.value?.validate((t=>e(t)))));if(!e)return;const r={cooperation_id:s.value.cooperation_id,end_type:s.value.end_type,unexpected_terminate_type:s.value.unexpected_terminate_type,is_update:s.value.is_update};s.value.unexpected_terminate_type===v.other&&(r.unexpected_terminate_detail=s.value.unexpected_terminate_detail),d.value=!0;const[{data:i},o]=await Promise.all([await(0,pt._3)(r),await(0,C._v)(200)]);d.value=!1,i.success?(t.root.$message.success(i.message),t.emit("dialog:close",!0),t.root.$store.dispatch("marketing/setProjectInfo",-1)):t.root.$message.error(i.message??"保存失败")},p=rr(u,200);return{formRef:a,formRules:r,saveLoading:d,onSaveBtnClick:p,ProjectInfo:o,ProjectConfirmForm:s,onCloseBtnClick:c}}}),or=ir,sr=(0,V.Z)(or,tr,ar,!1,null,null,null),lr=sr.exports,nr=a(85688),cr=a(36165),dr=a(72713);const ur=[{name:ve.Z8.project.list,title:"项目管理"},{path:"",title:"项目详情"}],pr=(e,t)=>{const a=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_step_edit),t=(0,S.kG)(j.HN.marketing_project_status_finish_edit),a=(0,S.kG)(j.HN.marketing_project_save);return{canEditProjectStep:e,canEditProject:a,canEndEditProjectStep:t}})),r=(0,l.computed)((()=>(e.value?.cooperation_status??-1)<=b.Ny.ExecuteProject)),i=(0,l.computed)((()=>(e.value?.cooperation_status??-1)===b.Ny.ExecuteProject)),o=(0,l.ref)(!1),s=()=>{o.value=!0},n=()=>{o.value=!1},c=(0,l.computed)((()=>{const t=e.value?.end_type,a=e.value?.end_time??0,r=y()(1e3*a).format("yyyy.MM.DD");if(t===g.normal)return`正常结束 ${r}`;if(t===g.unexpected){let t;if(e.value?.end_detail){const a=parseInt((e.value?.end_detail.unexpected_terminate_type??-1).toString(),10),r=e.value?.end_detail.unexpected_terminate_detail??"",i=f.get(a)??"";t=a===v.refund?"退款 "+(""!==e.value.refund_total_amount_str?(0,w.dN)(e.value.refund_total_amount):"--"):i+" "+r}else t="";return`意外终止：${t} ${r}`}return"执行结果"})),d=(0,l.ref)(!1),u=()=>{d.value=!0},p=()=>{d.value=!1},m=(0,l.ref)(!1),_=()=>{m.value=!1,t(!0)},h=(0,l.computed)((()=>[{title:"确定合作",description:e.value?.gmt_create?y()(1e3*e.value?.gmt_create).format("YYYY.MM.DD"):"--"},{title:"执行项目",description:()=>(0,l.h)("div",[(0,l.h)("div",["指定AE"]),a.value.canEditProjectStep&&r.value?(0,l.h)("a",{on:{click:()=>{s()}}},["指定AE"]):""])},{title:()=>(0,l.h)("div",[(0,l.h)("span",["执行结束"]),a.value.canEndEditProjectStep&&e.value?.end_type?(0,l.h)("tg-button",{props:{type:"link"},style:{marginLeft:"22px",fontSize:"12px"},on:{click:()=>{m.value=!0}}},["修改"]):""]),description:()=>(0,l.h)("div",[(0,l.h)("div",[c.value]),a.value.canEditProjectStep&&i.value?(0,l.h)("a",{on:{click:()=>{u()}}},["执行结束"]):""])}])),C=(0,l.computed)((()=>{const t=e.value?.cooperation_status;switch(t){case b.Ny.ImportData:case b.Ny.ExecuteEnd:return 3;case b.Ny.ExecuteProject:return 2;case b.Ny.DetermineCooperation:return 1;case b.Ny.InterestedCustomer:case void 0:default:return 0}})),x=(0,l.computed)((()=>({projectId:e.value?.cooperation_id,projectType:k.kA.marketing})));return{steps:h,stepActiveNumber:C,AeDialogVisible:o,changeAeBtnClick:s,onAeDialogModalClose:n,ProjectExecuteFinishVisible:d,changeProjectExecuteBtnClick:u,onProjectExecuteDialogModalClose:p,rollBackProjectVisible:m,onProjectRollBackSave:_,rollBackProjectInfo:x}};var mr=(0,l.defineComponent)({name:"TgMarketingProjectDetail",props:{id:{type:Number},tab:{type:String}},components:{AeDialogModal:Ha,ProjectExecuteFinishModal:lr,info:M,achievement:Te,cost:Ma,ae:st,contract:Fa.Z,dailydata:er,settlement_income:nr.Z,settlement_cost:cr.Z,RollBackProject:dr.Z},setup(e,t){const a=(0,l.computed)((()=>{const e=(0,S.kG)(j.HN.marketing_project_step_edit),t=(0,S.kG)(j.HN.marketing_project_achievement_view),a=(0,S.kG)(j.HN.marketing_project_cost_view),r=(0,S.kG)(j.HN.marketing_project_documentary_view),i=(0,S.kG)(j.HN.marketing_project_contract_view),o=(0,S.kG)(j.HN.view_or_save_coop_daily_report),s=(0,S.kG)(j.HN.marketing_project_settlement_view);return{canEditProjectStep:e,canViewAchievementTab:t,canViewCostTab:a,canViewAeTab:r,canViewContractTab:i,view_or_save_coop_daily_report:o,canViewSettlementTab:s}})),r=(0,n.pK)((0,l.computed)((()=>{const e=[{label:"项目信息",value:"info"}];return a.value.canViewSettlementTab&&(e.push({label:"收入结算",value:"settlement_income"}),e.push({label:"成本结算",value:"settlement_cost"})),a.value.canViewAchievementTab&&e.push({label:"项目收款",value:"achievement"}),a.value.canViewCostTab&&e.push({label:"项目付款",value:"cost"}),a.value.canViewAeTab&&e.push({label:"跟单表",value:"ae"}),a.value.canViewContractTab&&e.push({label:"合同协议",value:"contract"}),a.value.view_or_save_coop_daily_report&&e.push({label:"日报数据",value:"dailydata"}),e})),e.tab??"info");(0,l.watch)((()=>r.checkedTab.value),((a,r)=>{r!==a&&t.root.$router.replace({params:(0,lt.P)({...e,tab:a})})})),(0,l.onMounted)((()=>{(0,La.S)()}));const i=()=>{},o=(0,l.ref)(void 0),s=async(a=!1)=>{const r=async e=>{const{data:t}=await(0,pt.ow)(e);o.value=t.data};e.id?await r(e.id.toString()):a&&await r(t.root.$route.params.id.toString())};(0,l.onBeforeMount)((()=>{s()}));const c=(0,l.computed)((()=>o.value?.ae));(0,l.provide)("MarketingProject",o),(0,l.provide)("project",o),(0,l.watch)((()=>t.root.$store.getters["marketing/getProjectStateInfo"]),(e=>{e&&(s(!0),o.value?.cooperation_id&&d(o.value?.cooperation_id.toString()))}));const d=async e=>{const{data:a}=await Ze({cooperation_id:parseInt(e,10)});a.success?t.root.$store.dispatch("marketing/setAEList",a.data):(t.root.$message.warning("获取AE信息失败，稍后自动重试"),await(0,C._v)(5e3),d(e))};return(0,l.onMounted)((()=>{d(t.root.$route.params.id)})),(0,l.watch)((()=>t.root.$route.params.id),((e,t)=>{e!==t&&d(e)})),{Permission:a,routes:ur,ProjectAeList:c,MarketingProject:o,...r,onTabChange:i,...pr(o,s)}}}),_r=mr,vr=(0,V.Z)(_r,o,s,!1,null,null,null),fr=vr.exports},19397:function(e,t,a){a.d(t,{Z:function(){return j}});var r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-marketing-project-form-dialog tg-dialog-vcenter"},[a("el-drawer",{staticClass:"tg-dialog-classic",attrs:{title:e.title,"close-on-click-modal":!1,"close-on-press-escape":!1,visible:e.visible,wrapperClosable:!1},on:{close:e.onCloseBtnClick}},[a("div",{staticClass:"tg-drawer-form-content"},[e.isEditForm?e._e():a("el-alert",{staticStyle:{color:"#ff7a36",height:"40px"},attrs:{closable:!1,title:"注意：已确认合作的在此创建项目，意向客户请由客户经理在销售管理板块创建跟进任务",type:"warning","show-icon":""}}),a("el-form",{ref:"formRef",attrs:{model:e.ProjectForm,rules:e.formRules,"label-position":"top",size:"small","label-width":"106px"}},[a("head-lines",{staticStyle:{margin:"10px 0px"},attrs:{title:"项目信息"}}),a("el-form-item",{staticClass:"one-item mgb-18",attrs:{label:"项目名称",prop:"cooperation_name"}},[a("el-input",{ref:"autoFocuseRef",attrs:{maxlength:"20",placeholder:"请输入项目名称"},model:{value:e.ProjectForm.cooperation_name,callback:function(t){e.$set(e.ProjectForm,"cooperation_name","string"===typeof t?t.trim():t)},expression:"ProjectForm.cooperation_name"}})],1),e.isEditForm?a("el-form-item",{staticClass:"two-item-left",attrs:{label:"公司名称",prop:"company_id"}},[a("el-select",{attrs:{disabled:e.isEditForm,placeholder:e.ProjectForm.company_name?e.ProjectForm.company_name:"--",size:"small"}})],1):a("el-form-item",{staticClass:"two-item-left mgb-18",attrs:{label:"公司名称",prop:"company_id"}},[a("el-select",{attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入并选择公司名称","remote-method":e.getAllCompanyName},on:{change:e.onCompanyIdChange},model:{value:e.ProjectForm.company_id,callback:function(t){e.$set(e.ProjectForm,"company_id",t)},expression:"ProjectForm.company_id"}},e._l(e.allCompanyName,(function(t,r){return a("el-option",{key:r,attrs:{label:t.company_name,value:t.id}},[a("span",[e._v(e._s(t.company_name))])])})),1)],1),e.isEditForm?a("el-form-item",{staticClass:"two-item-right",attrs:{label:"店铺名称",prop:"company_shop_id"}},[a("el-select",{attrs:{disabled:e.isEditForm,placeholder:e.ProjectForm.shop_name?e.ProjectForm.shop_name:"--",size:"small"}})],1):a("el-form-item",{staticClass:"two-item-right mgb-18",attrs:{label:"店铺名称",prop:"company_shop_id"}},[a("el-select",{attrs:{placeholder:"请选择店铺",size:"small"},on:{change:e.onShopIdChange},model:{value:e.ProjectForm.company_shop_id,callback:function(t){e.$set(e.ProjectForm,"company_shop_id",t)},expression:"ProjectForm.company_shop_id"}},e._l(e.allStoreName,(function(t,r){return a("el-option",{key:r,attrs:{label:t.shop_name,value:t.shop_id}},[a("span",[e._v(e._s(t.shop_name))])])})),1)],1),e.isEditForm?a("el-form-item",{staticClass:"two-item-left",attrs:{label:"品牌"}},[a("el-input",{attrs:{disabled:"",size:"small"},model:{value:e.new_brand_name,callback:function(t){e.new_brand_name=t},expression:"new_brand_name"}})],1):a("el-form-item",{staticClass:"two-item-left mgb-18",attrs:{label:"品牌"}},[a("el-input",{attrs:{disabled:""},model:{value:e.brand_name,callback:function(t){e.brand_name=t},expression:"brand_name"}})],1),e.isEditForm?a("el-form-item",{staticClass:"two-item-right",attrs:{label:"店铺类目"}},[a("el-input",{attrs:{disabled:"",size:"small"},model:{value:e.new_shop_cateogry_name,callback:function(t){e.new_shop_cateogry_name=t},expression:"new_shop_cateogry_name"}})],1):a("el-form-item",{staticClass:"two-item-right mgb-18",attrs:{label:"店铺类目"}},[a("el-input",{attrs:{disabled:""},model:{value:e.shop_category_name,callback:function(t){e.shop_category_name=t},expression:"shop_category_name"}})],1),a("el-form-item",{staticClass:"two-item-left mgb-18",attrs:{prop:"manager_id",label:"客户经理"}},[a("el-select",{attrs:{filterable:"",placeholder:"请输入并选择客户经理"},model:{value:e.ProjectForm.manager_id,callback:function(t){e.$set(e.ProjectForm,"manager_id",t)},expression:"ProjectForm.manager_id"}},e._l(e.CustomerManagerList,(function(t,r){return a("el-option",{key:r,attrs:{disabled:t.id===e.disabledManagerId,label:t.username,value:t.id}},[a("span",[e._v(e._s(t.username))])])})),1)],1),a("el-form-item",{staticClass:"two-item-right mgb-18",attrs:{label:"项目所属部门",prop:"feishu_department_id"}},[a("el-popover",{attrs:{placement:"bottom-start",trigger:"click",width:"267","popper-class":"marketing-department-tree-popper-class"}},[a("div",{staticClass:"repain-select",staticStyle:{display:"block"},attrs:{slot:"reference"},slot:"reference"},[a("el-input",{staticStyle:{color:"#999"},attrs:{value:e.ProjectForm.feishu_department_name,placeholder:"请选择项目所属部门",readonly:""},scopedSlots:e._u([{key:"suffix",fn:function(){return[a("i",{staticClass:"select-icon select-icon-user-add el-icon-arrow-down"})]},proxy:!0}])})],1),a("div",{staticClass:"department-tree"},[a("el-tree",{ref:"maketing_department_tree",attrs:{props:e.treeProps,"check-strictly":!0,"node-key":"id",data:e.feishuDepartmentList,"show-checkbox":"","default-checked-keys":e.default_checked_department_ids,"default-expanded-keys":e.default_checked_department_ids},on:{check:e.handleCheckChange}})],1)])],1),a("el-form-item",{staticClass:"two-item-left mgb-18",attrs:{label:"销售金额",prop:"sale_amount"}},[a("el-input",{attrs:{placeholder:"请输入销售金额"},on:{input:function(t){return e.inputPositiveNumber(t,"sale_amount")}},model:{value:e.ProjectForm.sale_amount,callback:function(t){e.$set(e.ProjectForm,"sale_amount",t)},expression:"ProjectForm.sale_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1),a("el-form-item",{staticClass:"two-item-right mgb-18",attrs:{label:"合作类型",prop:"cooperation_type"}},[a("el-checkbox-group",{staticClass:"CooperationType-checkbox-group",model:{value:e.ProjectForm.cooperation_type,callback:function(t){e.$set(e.ProjectForm,"cooperation_type",t)},expression:"ProjectForm.cooperation_type"}},[a("el-checkbox",{staticClass:"CooperationType-checkbox",attrs:{label:1}},[e._v("直播")]),a("el-checkbox",{staticClass:"CooperationType-checkbox",attrs:{label:2}},[e._v("视频")]),a("el-checkbox",{staticClass:"CooperationType-checkbox",attrs:{label:3}},[e._v("图文")])],1)],1),a("el-form-item",{staticClass:"two-item-right mgb-18",attrs:{label:"是否收款",prop:"is_gather"}},[a("div",{staticStyle:{width:"246px"}},[a("el-radio-group",{staticStyle:{display:"inline-flex",height:"32px"},model:{value:e.ProjectForm.is_gather,callback:function(t){e.$set(e.ProjectForm,"is_gather",t)},expression:"ProjectForm.is_gather"}},[a("el-radio",{attrs:{label:1}},[e._v("是")]),a("el-radio",{attrs:{label:0}},[e._v("否")])],1)],1)]),e.ProjectForm.is_gather?e._e():a("div",{staticClass:"one-item",staticStyle:{"margin-bottom":"18px",height:"90px",background:"#f7f8f9","border-radius":"2px",padding:"18px"}},[a("el-form-item",{attrs:{label:"回款日期",prop:"gather_date"}},[a("el-date-picker",{staticStyle:{width:"249px"},attrs:{type:"date",editable:!1,placeholder:"回款日期",format:"yyyy.MM.dd","value-format":"yyyy-MM-dd"},model:{value:e.ProjectForm.gather_date,callback:function(t){e.$set(e.ProjectForm,"gather_date",t)},expression:"ProjectForm.gather_date"}})],1)],1)],1),a("div",{staticClass:"tg-drawer-footer"},[a("tg-button",{attrs:{size:"small"},on:{click:e.onCloseBtnClick}},[e._v("取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:e.onSaveBtnClick}},[e._v("保存")])],1)],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在保存，请稍候..."}})],1)},i=[],o=(a(21703),a(26699),a(53451)),s=a.n(o),l=a(97434),n=a(64236),c=a(58061),d=a(3346),u=a(86863),p=a(29625),m=a(80391),_=a(6933),v=a.n(_),f=a(61282),g=a(41572),h=a(3293),y=a(26895);const{debounce:b}=s(),k=e=>{const t=(0,l.ref)(null),a=(0,l.ref)([]),r=(0,l.ref)([]),i=(0,l.ref)([]),o=(0,l.ref)({cooperation_name:"",company_id:"",company_shop_id:"",company_name:"",shop_name:"",customer_id:"",manager_id:"",cooperation_type:[],sale_amount:"",uv:"",pv:"",gmv:"",budget:"",note:"",remark:"",is_gather:1,gather_date:"",plan:[],feishu_department_id:void 0,feishu_department_name:void 0}),s=(0,l.ref)({cooperation_name:[{required:!0,message:"请输入项目名称",trigger:"blur"}],company_id:[{required:!0,message:"请选择客户名称",trigger:"change"}],company_shop_id:[{required:!0,message:"请选择店铺",trigger:"change"}],sale_amount:[{required:!0,message:"请输入销售金额",trigger:"blur"},{validator:(e,t,a)=>{t<=0?a(new Error("请输入正数")):a()},trigger:"blur"}],cooperation_type:[{required:!0,message:"请选择合作类型",trigger:"change"}],is_gather:[{required:!0,message:"请选择是否回款",trigger:"blur"}],gather_date:[{required:!0,message:"请选择回款日期",trigger:"blur"}],manager_id:[{required:!0,message:"请输入客户经理",trigger:"change"}],customer_id:[{required:!0,message:"请输入客户名称",trigger:"change"}],feishu_department_id:[{required:!0,message:"请选择项目所属部门",trigger:"change"}]});(0,l.watch)((()=>e.visible),(e=>{e&&(c(),t.value?.resetFields())}));const n=(0,l.ref)([]),c=()=>{o.value.company_id="",o.value.cooperation_name="",o.value.customer_id="",o.value.company_shop_id="",o.value.manager_id="",o.value.plan=[],o.value.cooperation_type=[],o.value.sale_amount="",o.value.uv="",o.value.pv="",o.value.gmv="",o.value.budget="",o.value.note="",o.value.remark="",o.value.is_gather=1,o.value.gather_date="",n.value=[],a.value=[],r.value=[],i.value=[],o.value.feishu_department_id=void 0,o.value.feishu_department_name=void 0},u=async e=>{const{data:t}=await(0,d.Ln)({company_name:e,verify_status:1});r.value=t.success?t.data.data:[]},p=e=>{o.value.company_id=e,o.value.company_shop_id="";for(let t=0;t<r.value.length;t++)r.value[t].id===e&&(i.value=r.value[t].shops_info??[])},m=e=>{o.value.company_shop_id=e};return{CustomerManagerList:a,uploadedFileList:n,formRef:t,formRules:s,ProjectForm:o,resetProjectForm:c,getAllCompanyName:u,allCompanyName:r,onCompanyIdChange:p,allStoreName:i,onShopIdChange:m}};var w=(0,l.defineComponent)({name:"TgMarketingProjectDialog",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"新增场次"},project:{type:Object,required:!1},isEditForm:{type:Boolean,default:!1,required:!1}},setup(e,t){const a=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]),r=(0,l.ref)(""),i=(0,l.ref)(""),o=(0,l.ref)(void 0),s=(0,l.ref)(!1),d=(0,l.ref)([]),_=(0,l.ref)(void 0),w=(0,l.computed)((()=>P.value.feishu_department_id?[P.value.feishu_department_id]:[])),C={label:"name",children:"sons"},{CustomerManagerList:x,uploadedFileList:S,formRef:j,formRules:D,ProjectForm:P,resetProjectForm:$,getAllCompanyName:I,onCompanyIdChange:V,allCompanyName:R,allStoreName:M,onShopIdChange:L}=k(e),F=()=>{$(),t.emit("dialog:close")},A=async()=>{if(s.value)return;const e=await new Promise((e=>j.value?.validate((t=>e(t)))));if(!e)return;if(P.value.uv&&parseInt(P.value.uv,10)<=0)return void t.root.$message.error("UV必需为正整数");if(P.value.pv&&parseInt(P.value.pv,10)<=0)return void t.root.$message.error("PV必需为正整数");const a={cooperation_name:P.value.cooperation_name,company_id:P.value.company_id,company_shop_id:P.value.company_shop_id,company_name:"",customer_id:P.value.customer_id,manager_id:P.value.manager_id,cooperation_type:P.value.cooperation_type,sale_amount:P.value.sale_amount,uv:P.value.uv,pv:P.value.pv,gmv:P.value.gmv,budget:P.value.budget,note:P.value.note,remark:P.value.remark,is_gather:P.value.is_gather,gather_date:P.value.gather_date,plan:P.value.plan,feishu_department_id:P.value.feishu_department_id,feishu_department_name:void 0};P.value.cooperation_id&&(a.cooperation_id=P.value.cooperation_id),s.value=!0;const[{data:r},i]=await Promise.all([await(0,c.QC)(a),await(0,n._v)(200)]);s.value=!1,r.success?(t.root.$message.success(r.message),t.emit("dialog:close",!0),t.root.$store.dispatch("marketing/setProjectInfo",-1)):t.root.$message.error(r.message??"项目保存失败")},E=b(A,200),N=(0,l.ref)([]),T=(0,l.computed)((()=>M.value.find((e=>{if(P.value.company_shop_id)return e.shop_id===P.value.company_shop_id})))),q=(0,l.computed)((()=>{const e=T.value?.brand_name;return e||"--"})),z=(0,l.computed)((()=>{const e=p.Bs.get(T.value?.category??-1);return e||"--"})),O=(0,l.ref)(-1),W=async()=>{const{data:t}=await(0,u.pc)({roles:"1008",business_type:p.WD.marketing});x.value=t.success?t.data:[];const a=e.project?.manager_id;a&&(x.value.map((e=>e.id.toString())).includes(a.toString())||(O.value=a,x.value.push({id:a,username:e.project?.manager_name??"--"})))},Z=async e=>{const r=new FormData,i=e.file.name;r.append("file",e.file,i),r.append("type","plan");const o=await(0,m.$)(r);if(o.data.success){const t=i.split(".")[i.split(".").length-1],r=""!==e.file.type?e.file.type:t;S.value.push({name:e.file.name,type:e.file.type,icon:a.get(r)??"picture",size:e.file.size,path:o.data.data.source});const s=S.value.map((e=>e.path));P.value.plan=s}else t.root.$message({type:"warning",message:o.data.message??"上传失败，稍后重试",showClose:!0,duration:3e3})},B=e=>{S.value.splice(e,1);const t=S.value.map((e=>e.path));P.value.plan=t};(0,l.watch)((()=>e.visible),(t=>{if(t)if(_.value?.setCheckedKeys([]),j.value?.resetFields(),W(),void 0!==e.project){const t=(0,l.computed)((()=>{const t=p.Bs.get(e.project?.category??-1);return t||"--"}));if(i.value=t.value,r.value=e.project.brand_name?e.project.brand_name:"--",P.value.cooperation_id=e.project.cooperation_id,P.value.company_name=e.project.company_name,P.value.company_id=e.project.company_id,P.value.company_shop_id=e.project.customer_id,P.value.shop_name=e.project.shop_name,P.value.cooperation_name=e.project.cooperation_name,P.value.cooperation_type=e.project.cooperation_type,P.value.is_gather=e.project.is_gather,P.value.sale_amount=e.project.sale_amount?.toString(),P.value.feishu_department_id=e.project.feishu_department_id,P.value.feishu_department_name=e.project.feishu_department_name,"0"===P.value.sale_amount&&(P.value.sale_amount=""),P.value.budget=e.project.budget?.toString(),"0"===P.value.budget&&(P.value.budget=""),P.value.uv=e.project.uv?.toString(),"0"===P.value.uv&&(P.value.uv=""),P.value.pv=e.project.pv?.toString(),"0"===P.value.pv&&(P.value.pv=""),P.value.gmv=e.project.gmv?.toString(),"0"===P.value.gmv&&(P.value.gmv=""),P.value.note=e.project.note,P.value.remark=e.project.remark,P.value.manager_id=e.project.manager_id,P.value.plan=e.project.plan,P.value.plan?.map((e=>{const t=e.split("/")[e.split("/").length-1],r=t.split(".")[t.split(".").length-1],i=r;S.value.push({name:t,type:i,icon:a.get(i)??"picture",path:e})})),e.project.gather_date)P.value.gather_date=v()(1e3*e.project.gather_date).format("YYYY-MM-DD");else{const e=new Date,t=e.setDate(e.getDate()+45);P.value.gather_date=v()(t).format("YYYY-MM-DD")}}else{const e=new Date,t=e.setDate(e.getDate()+45);P.value.gather_date=v()(t).format("YYYY-MM-DD"),(0,l.nextTick)((()=>{o.value?.focus()}))}}));const Y=(e,t)=>{const a=(0,f.nA)(e);"gmv"===t?P.value.gmv=a:"budget"===t?P.value.budget=a:"sale_amount"===t&&(P.value.sale_amount=a)},H=e=>e.replace(/\D/g,"").replace(g.Pj,""),U=(e,t)=>{const a=H(e);"uv"===t?P.value.uv=a:"pv"===t&&(P.value.pv=a)},G=async()=>{const e=await(0,h.o1)(),t=e.data.data.data;(0,y.$S)(t),d.value=e.data.data.data};G();const K=e=>{_.value?.setCheckedKeys([]),e.id===P.value.feishu_department_id?(P.value.feishu_department_id=void 0,P.value.feishu_department_name=void 0):(P.value.feishu_department_id=e.id,P.value.feishu_department_name=e.name,_.value?.setCheckedKeys([e.id]))};return{autoFocuseRef:o,disabledManagerId:O,inputPositiveNumber:Y,inputPositiveInteger:U,handleRemoveFileClick:B,uploadedFileList:S,uploadFileHandler:Z,brand_name:q,shop_category_name:z,CustomerList:N,CustomerManagerList:x,saveLoading:s,formRef:j,formRules:D,ProjectForm:P,onCloseBtnClick:F,onSaveBtnClick:E,getAllCompanyName:I,onCompanyIdChange:V,allCompanyName:R,allStoreName:M,onShopIdChange:L,new_brand_name:r,new_shop_cateogry_name:i,feishuDepartmentList:d,maketing_department_tree:_,handleCheckChange:K,treeProps:C,default_checked_department_ids:w}}}),C=w,x=a(1001),S=(0,x.Z)(C,r,i,!1,null,null,null),j=S.exports},18728:function(e,t,a){a.d(t,{Z:function(){return b}});var r=function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("el-dialog",{staticStyle:{"border-radius":"10px"},attrs:{"append-to-body":!0,visible:e.customerVisible,width:"800px",top:"70px","close-on-click-modal":!1},on:{"update:visible":function(t){e.customerVisible=t},close:e.close},scopedSlots:e._u([{key:"title",fn:function(){return[r("div",[r("span",{staticStyle:{"font-size":"18px","font-weight":"600",color:"#333"}},[e._v("用款申请详情")])])]},proxy:!0},{key:"footer",fn:function(){return[e.cost_show?r("span",{staticClass:"dialog-footer"},[r("div"),e.revocationVisiable()&&1===e.detail_data.approval_status?r("el-button",{staticClass:"big-button color-9",attrs:{size:"small"},on:{click:e.revocation}},[e._v("撤销")]):e._e(),e.btnVisiable()&&1===e.detail_data.approval_status?r("el-button",{staticClass:"big-button btn-red",attrs:{type:"primary",size:"small"},on:{click:e.refuse}},[e._v("拒绝")]):e._e(),e.btnVisiable()&&1===e.detail_data.approval_status?r("el-button",{staticClass:"big-button btn-blue",attrs:{type:"primary",size:"small"},on:{click:e.agree}},[e._v("同意")]):e._e(),r("el-dialog",{staticClass:"userinfo-customer-dialog",attrs:{visible:e.approvalDialogVisible,width:"460px","close-on-click-modal":!1,"close-on-press-escape":!1,modal:!1},on:{close:function(t){e.approvalDialogVisible=!1}},scopedSlots:e._u([{key:"title",fn:function(){return[r("div",{staticClass:"userinfo-customer-dialog-header"},[e._v("拒绝理由")])]},proxy:!0},{key:"footer",fn:function(){return[r("div",{staticClass:"userinfo-customer-dialog-footer"},[r("el-button",{staticClass:"big-button",attrs:{size:"small",plain:""},on:{click:function(t){e.approvalDialogVisible=!1}}},[e._v("取消")]),r("el-button",{staticClass:"btn-blue big-button",attrs:{size:"small",type:"primary"},on:{click:e.handleApprovalSubmitClick}},[e._v("确定")])],1)]},proxy:!0}],null,!1,3210623043)},[r("div",{staticClass:"approval-content"},[r("p",{staticStyle:{"text-align":"left",color:"#333","margin-bottom":"10px"}},[e._v("填写理由:")]),r("el-input",{staticStyle:{width:"100%"},attrs:{type:"textarea",rows:3,maxlength:30,placeholder:"请输入不超过30个字符"},model:{value:e.remark,callback:function(t){e.remark=t},expression:"remark"}})],1)]),r("show-apply-dialog",{ref:"showApplyDialog",on:{"update-info":e.updateInfo}})],1):e._e()]},proxy:!0}])},[r("div",{staticClass:"main"},[r("div",{staticClass:"main-header"},[r("div",{staticClass:"from-header-box"},[r("div",{staticClass:"from-header"},[r("span",[e._v("申请人:")]),r("span",[e._v(e._s(e.detail_data.username))])]),r("div",{staticClass:"from-header"},[r("span",[e._v("申请部门:")]),r("span",[e._v(e._s(e.detail_data.create_department))])]),r("div",{staticClass:"from-header"},[r("span",[e._v("发起时间:")]),r("span",[e._v(e._s(e.detail_data.gmt_create))])]),r("span",{staticClass:"left_icon"},[e._e(),r("div",{staticClass:"apply-click",on:{click:e.exportPdf}},[r("span",[r("img",{attrs:{src:a(97830)}})]),r("span",[e._v("下载PDF")])])])]),r("div",{staticClass:"title-right"},[r("span",{staticStyle:{"font-size":"16px",color:"#333"}},[e._v("审批编号:")]),r("span",{staticStyle:{color:"#333","font-weight":"600","font-size":"16px"}},[e._v(e._s(e.detail_data.approval_uid))]),r("span",{class:"status-color status-color-"+e.detail_data.approval_status},[1===e.detail_data.approval_status?r("span",{staticClass:"approver-state"},[e._v("审批中")]):e._e(),2===e.detail_data.approval_status?r("span",{staticClass:"approver-state"},[e._v("审批通过")]):e._e(),3===e.detail_data.approval_status?r("span",{staticClass:"approver-state"},[e._v("审批失败")]):e._e(),4===e.detail_data.approval_status?r("span",{staticClass:"approver-state"},[e._v("已撤销")]):e._e()])])]),r("div",{staticClass:"main-middle"},[r("el-row",{staticStyle:{"margin-right":"0"},attrs:{gutter:20}},[r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle-first"},[r("span",{staticClass:"color-9"},[e._v("用款类型:")]),1===e.detail_data.level_two_types?r("span",[e._v("成本安排")]):e._e()])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle-first"},[r("span",{staticClass:"color-9"},[e._v("用款金额（元）:")]),r("span",{staticClass:"color-red",staticStyle:{"font-weight":"600"}},[e._v(e._s("￥"+e.detail_data.transfer_amount_str))])])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle-first"},[r("span",{staticClass:"color-9"},[e._v("用款日期:")]),r("span",[e._v(e._s(e.detail_data.transfer_date))])])])],1),3===e.detail_data.level_three_types?[r("el-row",{staticStyle:{"margin-right":"0"},attrs:{gutter:20}},[r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle"},[r("span",{staticClass:"color-9"},[e._v("收款方式：")]),r("span",[e._v("对公银行")])])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle"},[r("span",{staticClass:"color-9"},[e._v("银行卡号：")]),r("span",[e._v(e._s(e.detail_data.bank_card_number))])])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle"},[r("span",{staticClass:"color-9"},[e._v("开户行：")]),r("span",[e._v(e._s(e.detail_data.bank_of_deposit))])])])],1),r("el-row",{staticStyle:{"margin-right":"0"},attrs:{gutter:20}},[r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle from-middle-company"},[r("span",{staticClass:"color-9"},[e._v("公司名称：")]),r("span",[e._v(e._s(e.detail_data.collecting_company))])])])],1)]:e._e(),4===e.detail_data.level_three_types?[r("el-row",{staticStyle:{"margin-right":"0"},attrs:{gutter:20}},[r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle"},[r("span",{staticClass:"color-9"},[e._v("收款方式：")]),r("span",[e._v("对公支付宝")])])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle"},[r("span",{staticClass:"color-9"},[e._v("收款人：")]),r("span",[e._v(e._s(e.detail_data.collecting_person))])])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle"},[r("span",{staticClass:"color-9"},[e._v("支付宝账号：")]),r("span",[e._v(e._s(e.detail_data.alipay_account))])])])],1)]:e._e(),r("el-row",{staticStyle:{"margin-right":"0"},attrs:{gutter:20}},[r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle"},[r("span",{staticClass:"color-9"},[e._v("店铺名称:")]),r("span",[e._v(e._s(e.detail_data.collecting_shop_name))])])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle remark-text-remark"},[r("span",{staticClass:"color-9"},[e._v("备注:")]),r("span",[e._v(e._s(e.detail_data.remark?e.detail_data.remark:"--"))])])]),r("el-col",{attrs:{span:8}},[r("div",{staticClass:"from-middle remark-text-reason"},[r("span",{staticClass:"color-9"},[e._v("付款事由:")]),r("span",[e._v(e._s(e.detail_data.pay_reason?e.detail_data.pay_reason:"--"))])])])],1)],2)]),r("div",{staticClass:"flow",staticStyle:{"padding-left":"18px"}},[r("div",{staticClass:"invoice-info-title"},[e._v("审批流程")]),e.steps.length>0?r("tg-steps",{attrs:{direction:"vertical",steps:e.steps,active:e.activeNumber}}):r("span",[e._v("--")])],1)])},i=[],o=a(97434),s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("common-dialog",{ref:"ApplyDialog",attrs:{isAppendToBody:!0,title:"用款申请单",width:800,top:70,isfooter:!0},on:{"dialog-cancel":e.handledialogCancel,"dialog-submit":e.handledialogSubmit}},[a("div",{staticClass:"warp"},[a("el-form",{ref:"transfer_list",attrs:{rules:e.transfer_list_rules,model:e.transfer_list}},[a("el-form-item",{attrs:{"label-width":"90px",prop:"radio"},scopedSlots:e._u([{key:"label",fn:function(){return[a("span",[a("span",{staticStyle:{color:"#f56c6c","margin-right":"3px"}},[e._v("*")]),e._v("用款类型: ")])]},proxy:!0}])},[a("el-radio",{attrs:{label:"1"},model:{value:e.radio,callback:function(t){e.radio=t},expression:"radio"}},[e._v("成本安排")])],1),a("el-form-item",{attrs:{label:"用款金额：","label-width":"90px",prop:"transfer_amount"}},[a("el-input",{attrs:{oninput:"value=value.replace(/[^\\d.]/g,'')",maxlength:e.inputMaxL,placeholder:"请输入开票金额"},on:{input:function(t){e.inputMaxL=/^\d+\.?\d{0,1}$/.test(e.transfer_list.transfer_amount)?null:e.transfer_list.transfer_amount.length-1}},nativeOn:{mousewheel:function(e){e.preventDefault()}},scopedSlots:e._u([{key:"append",fn:function(){return[e._v("元")]},proxy:!0}]),model:{value:e.transfer_list.transfer_amount,callback:function(t){e.$set(e.transfer_list,"transfer_amount",t)},expression:"transfer_list.transfer_amount"}})],1),a("el-form-item",{attrs:{label:"用款日期：","label-width":"90px",prop:"transfer_date"}},[a("el-date-picker",{staticStyle:{width:"100%"},attrs:{clearable:!1,size:"small",placeholder:"请选择收款时间","value-format":"yyyy-MM-dd"},model:{value:e.transfer_list.transfer_date,callback:function(t){e.$set(e.transfer_list,"transfer_date",t)},expression:"transfer_list.transfer_date"}})],1),a("el-form-item",{attrs:{"label-width":"90px"},scopedSlots:e._u([{key:"label",fn:function(){return[a("p",{staticClass:"font-b"},[e._v("收款方式:")])]},proxy:!0}])},[a("p",{staticClass:"font-b"},[e._v("对公银行")]),a("div",{staticClass:"v-bgc"},[a("div",{staticStyle:{display:"flex"}},[a("el-form-item",{attrs:{label:"银行卡号：","label-width":"90px",prop:"bank_card_number"}},[a("el-input",{attrs:{maxlength:"40",oninput:"value=value.replace(/[^\\d]/g,'')",placeholder:"请输入银行卡号"},nativeOn:{mousewheel:function(e){e.preventDefault()}},model:{value:e.transfer_list.bank_card_number,callback:function(t){e.$set(e.transfer_list,"bank_card_number",t)},expression:"transfer_list.bank_card_number"}})],1),a("el-form-item",{attrs:{label:"公司名称：","label-width":"110px",prop:"collecting_company"}},[a("el-input",{attrs:{maxlength:"40",placeholder:"请输入公司名称"},nativeOn:{mousewheel:function(e){e.preventDefault()}},model:{value:e.transfer_list.collecting_company,callback:function(t){e.$set(e.transfer_list,"collecting_company","string"===typeof t?t.trim():t)},expression:"transfer_list.collecting_company"}})],1)],1),a("div",{staticStyle:{display:"flex"}},[a("el-form-item",{staticClass:"bank-deposit",attrs:{label:"开户行：","label-width":"90px",prop:"bank_of_deposit"}},[a("el-input",{staticStyle:{width:"78%"},attrs:{maxlength:"40",placeholder:"请输入开户行"},nativeOn:{mousewheel:function(e){e.preventDefault()}},model:{value:e.transfer_list.bank_of_deposit,callback:function(t){e.$set(e.transfer_list,"bank_of_deposit","string"===typeof t?t.trim():t)},expression:"transfer_list.bank_of_deposit"}})],1)],1)])]),a("el-form-item",{attrs:{label:"店铺名称：","label-width":"90px",prop:"collecting_shop_name"}},[a("el-input",{attrs:{maxlength:"40",placeholder:"请输入店铺名称"},nativeOn:{mousewheel:function(e){e.preventDefault()}},model:{value:e.transfer_list.collecting_shop_name,callback:function(t){e.$set(e.transfer_list,"collecting_shop_name","string"===typeof t?t.trim():t)},expression:"transfer_list.collecting_shop_name"}})],1),a("el-form-item",{attrs:{label:"备注：","label-width":"90px"}},[a("el-input",{attrs:{maxlength:"100",placeholder:"请输入备注"},nativeOn:{mousewheel:function(e){e.preventDefault()}},model:{value:e.transfer_list.remark,callback:function(t){e.$set(e.transfer_list,"remark","string"===typeof t?t.trim():t)},expression:"transfer_list.remark"}})],1)],1)],1),a("div",{staticClass:"flow"},[a("el-form",[a("el-form-item",{attrs:{label:"审批流程：","label-width":"90px"}},[e.error_text?a("p",{staticStyle:{color:"#f43846"}},[e._v(e._s(e.error_text))]):e._e(),a("el-steps",{staticClass:"steps-line",attrs:{direction:"vertical"}},e._l(e.select_data,(function(t,r){return a("div",{key:r,class:[{"line-show-1":e.transfer_list.transfer_amount<1e5},{"line-show-2":e.transfer_list.transfer_amount>=1e5&&e.transfer_list.transfer_amount<5e5},{"line-show-3":e.transfer_list.transfer_amount>=5e5}]},[!e.select_data[r].limit_amount||e.transfer_list.transfer_amount>=e.select_data[r].limit_amount?a("el-step",{staticStyle:{height:"82px"},scopedSlots:e._u([{key:"title",fn:function(){return[804!==t.role_code&&802!==t.role_code?a("span",[e._v(e._s(t.role_name))]):e._e(),804===t.role_code?a("span",[e._v(e._s(t.role_name+"（用款金额大于10万元）"))]):e._e(),802===t.role_code?a("span",[e._v(e._s(t.role_name+"（用款金额大于50万元）"))]):e._e()]},proxy:!0},{key:"description",fn:function(){return[a("div",[a("span",{staticStyle:{color:"#f56c6c","margin-right":"3px"}},[e._v("*")]),a("span",{staticClass:"flow-select"},[e._v("审批人:")]),a("el-select",{attrs:{clearable:!1,filterable:"",placeholder:"请选择"},on:{change:function(t){return e.selectUserId(t,e.select_data[r].approval_user,r)}},model:{value:e.approver_name[r],callback:function(t){e.$set(e.approver_name,r,t)},expression:"approver_name[index]"}},e._l(e.select_data[r].approval_user?e.select_data[r].approval_user:"",(function(e){return a("el-option",{key:e.user_id,attrs:{value:e.username}})})),1)],1)]},proxy:!0}],null,!0)}):e._e()],1)})),0)],1)],1)],1)])},l=[],n=a(66117),c={name:"ApplyDialog",data(){return{error_text:"",checkedIndex:"",inputMaxL:null,approver_name:[],select_data:"",radio:"1",transfer_list:{approval_type:1,level_two_types:1,level_three_types:3,transfer_amount:"",transfer_date:(new Date).toLocaleDateString().replace("/","-").replace("/","-"),bank_card_number:"",bank_of_deposit:"",collecting_company:"",remark:"",collecting_shop_name:"",approval_stream:[]},transfer_list_rules:{transfer_amount:[{required:!0,message:"请输入用款金额",trigger:"blur"}],transfer_date:[{required:!0,message:"请输入用款日期",trigger:"blur"}],bank_card_number:[{required:!0,message:"请输入银行卡号",trigger:"blur"}],bank_of_deposit:[{required:!0,message:"请输入开户行",trigger:"blur"}],collecting_company:[{required:!0,message:"请输入公司名称",trigger:"blur"}],collecting_shop_name:[{required:!0,message:"请输入店铺名称",trigger:"blur"}]}}},activated(){this.getApprovalStreamSelect()},methods:{getApprovalStreamSelect(){(0,n.SW)({approval_type:1}).then((e=>{e&&e.data&&e.data.success?(this.select_data=e.data.data,this.list=e.data.data):this.error_text=e.data.message}))},show(e){if(this.getApprovalStreamSelect(),this.$refs.ApplyDialog.dialogOpen(),e){this.transfer_list.transfer_amount=e.transfer_amount_str,this.transfer_list.transfer_date=e.transfer_date,this.transfer_list.bank_card_number=e.bank_card_number,this.transfer_list.bank_of_deposit=e.bank_of_deposit,this.transfer_list.collecting_company=e.collecting_company,this.transfer_list.collecting_shop_name=e.collecting_shop_name,this.transfer_list.remark=e.remark;const t=[];for(let a=0;a<e.approval_stream.length;a++)this.approver_name.push(e.approval_stream[a].username),t.push({index:e.approval_stream[a].index,user_id:e.approval_stream[a].user_id,role_code:e.approval_stream[a].role_code});this.transfer_list.approval_stream.splice(this.checkedIndex,1,...t)}},handledialogSubmit(){this.transfer_list.transfer_amount<1e5&&(6===this.transfer_list.approval_stream.length&&this.transfer_list.approval_stream.splice(4,2),5===this.transfer_list.approval_stream.length&&this.transfer_list.approval_stream.splice(4,1)),this.transfer_list.transfer_amount>=1e5&&this.transfer_list.transfer_amount<5e5&&6===this.transfer_list.approval_stream.length&&this.transfer_list.approval_stream.splice(5,1),this.$refs.transfer_list.validate((e=>{e&&(this.transfer_list.transfer_amount<1e5&&(4!==this.transfer_list.approval_stream.length?this.$message.error("请选择审批流程"):(0,n.jw)(this.transfer_list).then((e=>{e.data.success?(this.$message.success("保存成功"),this.$refs.ApplyDialog.dialogClose()):this.$message.error(e.data.message)}))),this.transfer_list.transfer_amount>=1e5&&this.transfer_list.transfer_amount<5e5&&(5!==this.transfer_list.approval_stream.length?this.$message.error("请选择审批流程"):(0,n.jw)(this.transfer_list).then((e=>{e.data.success?(this.$message.success("保存成功"),this.$refs.ApplyDialog.dialogClose()):this.$message.error(e.data.message)}))),this.transfer_list.transfer_amount>=1e5&&this.transfer_list.transfer_amount>=5e5&&(6!==this.transfer_list.approval_stream.length?this.$message.error("请选择审批流程"):(0,n.jw)(this.transfer_list).then((e=>{e.data.success?(this.$message.success("保存成功"),this.$refs.ApplyDialog.dialogClose()):this.$message.error(e.data.message)}))))})),this.$emit("update-info","update")},selectUserId(e,t,a){this.checkedIndex=a;let r=[];for(let s=0;s<t.length;s++)e===t[s].username&&(r={index:a,user_id:t[s].user_id,role_code:t[s].role_code});this.transfer_list.approval_stream.length<this.approver_name.length?this.transfer_list.approval_stream.push(r):this.transfer_list.approval_stream.splice(a,1,r);let i=this.transfer_list.approval_stream;function o(e){return function(t,a){return t[e]-a[e]}}i=i.sort(o("index"))},handledialogCancel(){this.$refs.transfer_list.resetFields(),this.transfer_list.remark="",this.transfer_list.approval_stream=[],this.approver_name=[]}}},d=c,u=a(1001),p=(0,u.Z)(d,s,l,!1,null,"2f9aea11",null),m=p.exports,_=a(64479),v=a(32622),f=a(51351),g=(0,o.defineComponent)({components:{ShowApplyDialog:m},name:"ApplyDetail",data(){return{cost_show:!0,step_status:0,customerVisible:!0,approvalDialogVisible:!1,remark:""}},setup(e,t){const a=(0,o.ref)({});console.log({approval_flow_detail:a.value.approval_flow_detail});const r=(0,o.ref)([]);return(0,o.provide)("flows",r),{detail_data:a,approval_flow_detail:r,...(0,v.o)(t)}},async mounted(){this.currentUserInfo=this.$store.getters["user/getUserInfo"]},methods:{async getFlowStepData(e){const{data:t}=await(0,f.OC)({approval_id:e});t.success?this.$store.dispatch("workbench/setApproval",{...t.data}):this.$message.error(t.message??"获取审批详情失败")},updateInfo(e){e&&this.$parent.handleSearch()},show(e,t=0){e&&void 0===e.pay_way_detail&&1!==t?(0,n.Ec)({approval_id:e.approval_id}).then((e=>{e&&e.data&&e.data.success&&(this.detail_data=e.data.data,this.step_status=this.detail_data.steps),2!==this.detail_data.approval_status&&3!==this.detail_data.approval_status||(this.step_status=this.step_status+1)})):(0,n.Ec)({approval_id:1===t?e.approval_id:e.pay_way_detail[0].approval_id}).then((e=>{e&&e.data&&e.data.success&&(this.detail_data=e.data.data,this.step_status=this.detail_data.steps,this.approval_flow_detail=this.detail_data.approval_flow_detail),2!==this.detail_data.approval_status&&3!==this.detail_data.approval_status||(this.step_status=this.step_status+1)})),this.getFlowStepData(e.approval_id)},revocationVisiable(){const e=this.currentUserInfo&&this.currentUserInfo.id===this.detail_data.add_by;return e},btnVisiable(){const e=this.currentUserInfo&&this.currentUserInfo.id===this.detail_data.now_id;return e},close(){this.$emit("close")},again(){const e=this.detail_data;this.$refs.showApplyDialog.show(e)},exportPdf(){(0,_.m)(this.detail_data.approval_id)},revocation(){this.$confirm("你确定撤销吗","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",iconClass:"warning-icon"}).then((()=>{const e={approval_id:this.detail_data.approval_id,update_code:4};(0,n.bM)(e).then((e=>{e&&e.data&&e.data.success?(this.close(),this.$message.success("保存成功"),this.$parent.handleSearch()):this.$message.error("保存失败")}))})).catch((()=>!1))},agree(){this.$confirm("你确定同意该申请吗","提示",{confirmButtonText:"同意",cancelButtonText:"取消",type:"warning",iconClass:"success-icon"}).then((()=>{const e={approval_id:this.detail_data.approval_id,update_code:2};(0,n.bM)(e).then((e=>{e&&e.data&&e.data.success?(this.close(),this.$message.success("保存成功"),this.$parent.handleSearch()):this.$message.error("保存失败")}))})).catch((()=>!1))},refuse(){this.approvalDialogVisible=!0},handleApprovalSubmitClick(){const e={approval_id:this.detail_data.approval_id,update_code:3,remark:this.remark};(0,n.bM)(e).then((e=>{e&&e.data&&e.data.success?(this.approvalDialogVisible=!1,this.close(),this.$message.success("保存成功"),this.this.remark="",this.$parent.handleSearch()):this.$message.error("保存失败")})).catch((()=>!1))}}}),h=g,y=(0,u.Z)(h,r,i,!1,null,"36037be4",null),b=y.exports},50585:function(e,t,a){a.d(t,{PH:function(){return r},rN:function(){return o}});const r=[{type:1,value:"意向客户",subtitle:"客户需求"},{type:2,value:"确定合作",subtitle:"业绩登记/成本安排/返点安排"},{type:3,value:"执行项目",subtitle:"指定AE/AE跟单"},{type:4,value:"执行结束",subtitle:"执行结果"},{type:5,value:"数据入库",subtitle:"导入场次/商品数据"}],i=[{label:"V任务",value:1},{label:"支付宝",value:2},{label:"对公银行",value:3}],o=e=>i.find((t=>t.value===e))?.label??""},83468:function(e,t,a){a.d(t,{W7:function(){return o},m1:function(){return s},vg:function(){return l}});var r=a(76012),i=a(64236);const o=async e=>(0,r.dX)("/api/kol/query_kol",{params:{...(0,i.jG)(e)}}),s=async()=>(0,r.dX)("/api/anchor/good_at_categories"),l=async e=>(0,r.SO)("/api/kol/update_kol_platform",e)},76455:function(e,t,a){var r;a.d(t,{Ny:function(){return r},lk:function(){return s},tn:function(){return i}}),function(e){e[e["InterestedCustomer"]=1]="InterestedCustomer",e[e["DetermineCooperation"]=2]="DetermineCooperation",e[e["ExecuteProject"]=3]="ExecuteProject",e[e["ExecuteEnd"]=4]="ExecuteEnd",e[e["ImportData"]=5]="ImportData"}(r||(r={}));const i=new Map([[r.InterestedCustomer,"意向客户"],[r.DetermineCooperation,"确定合作"],[r.ExecuteProject,"执行项目"],[r.ExecuteEnd,"执行结束"],[r.ImportData,"数据入库"]]);var o;(function(e){e[e["live"]=1]="live",e[e["video"]=2]="video",e[e["graphic"]=3]="graphic"})(o||(o={}));const s=new Map([[o.live,"直播"],[o.video,"视频"],[o.graphic,"图文"]])}}]);
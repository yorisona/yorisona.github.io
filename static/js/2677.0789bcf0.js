"use strict";(self["webpackChunkgoumee_star_temp"]=self["webpackChunkgoumee_star_temp"]||[]).push([[2677],{35049:function(e,t,a){a.d(t,{Z:function(){return I}});var i=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"payment-dialog-wrapper"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter-new payment-dialog",attrs:{"close-on-press-escape":!1,"close-on-click-modal":!1,visible:e.visible,isAppendToBody:!0,isfooter:!0,width:"1184px"},on:{close:e.emitClose},scopedSlots:e._u([{key:"title",fn:function(){return[a("span",[e._v("对外付款申请")])]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{attrs:{type:"default"},on:{click:e.emitClose}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.handleDialogSubmit}},[e._v("保存")])]},proxy:!0}])},[a("div",{staticClass:"form-wrapper"},[a("el-form",{ref:"paymentFormRef",attrs:{rules:e.paymentFormRules,model:e.paymentForm,inline:"","label-width":"140px",size:"small"}},[a("div",{staticClass:"base-title"},[e._v("基本信息")]),a("el-form-item",{key:"project_feishu_department_id",attrs:{label:"承担部门：",prop:"project_feishu_department_id",rules:{required:!0,message:"请选择承担部门",trigger:["change"]}}},[a("el-popover",{attrs:{placement:"bottom-start",trigger:"click",width:"370","popper-class":"payment-dialog-tree-popper-class"}},[a("div",{staticClass:"repain-select",staticStyle:{display:"block"},attrs:{slot:"reference"},slot:"reference"},[e.paymentForm.project_feishu_department_name?a("div",{staticClass:"depart-select-box"},[a("span",[e._v(e._s(e.paymentForm.project_feishu_department_name))]),a("i",{staticClass:"el-icon-circle-close",staticStyle:{"margin-top":"8px",color:"white"},on:{click:function(t){return t.stopPropagation(),function(){e.paymentForm.project_feishu_department_id=void 0,e.paymentForm.project_feishu_department_name=void 0,e.cb_department_tree.setCheckedKeys([])}.apply(null,arguments)}}})]):a("div",{staticClass:"depart-select-box",staticStyle:{color:"rgba(164, 178, 194, 1)"}},[a("span",[e._v("请选择承担部门")]),a("i",{staticClass:"el-icon-arrow-down",staticStyle:{"margin-top":"8px",color:"#c0c4cc"}})])]),a("div",{staticClass:"department-tree"},[a("el-tree",{ref:"cb_department_tree",attrs:{props:e.treeProps,"check-strictly":!0,"node-key":"id",data:e.feishuDepartmentList,"show-checkbox":"","check-on-click-node":"","default-checked-keys":e.default_checked_department_ids,"default-expanded-keys":e.default_checked_department_ids},on:{check:e.handleCheckChange}})],1)])],1),a("el-form-item",{key:"business_type",attrs:{label:"业务类型：",prop:"business_type"}},[a("el-select",{staticStyle:{width:"220px"},attrs:{disabled:"",size:"small",placeholder:"请选择活动区域"},model:{value:e.business_type_new,callback:function(t){e.business_type_new=t},expression:"business_type_new"}},[a("el-option",{attrs:{label:"营销业务",value:1}}),a("el-option",{attrs:{label:"抖音店播",value:3}}),a("el-option",{attrs:{label:"淘宝店播",value:2}}),a("el-option",{attrs:{label:"S2B2C",value:5}}),a("el-option",{attrs:{label:"区域店播",value:6}}),a("el-option",{attrs:{label:"抖音店播(上海)",value:7}})],1)],1),a("el-form-item",{key:"project_name",attrs:{label:"项目：",prop:"project_name"}},[a("el-input",{staticStyle:{width:"220px"},attrs:{disabled:"",size:"small",placeholder:"请输入项目名称"},model:{value:e.paymentForm.project_name,callback:function(t){e.$set(e.paymentForm,"project_name","string"===typeof t?t.trim():t)},expression:"paymentForm.project_name"}})],1),3!==e.projectType?a("el-form-item",{key:"brand_name",attrs:{label:"品牌：",prop:"brand_name"}},[a("el-input",{staticStyle:{width:"220px"},attrs:{disabled:"",size:"small",placeholder:"请输入品牌名称"},model:{value:e.paymentForm.brand_name,callback:function(t){e.$set(e.paymentForm,"brand_name","string"===typeof t?t.trim():t)},expression:"paymentForm.brand_name"}})],1):e._e(),a("el-form-item",{key:"fare_way",attrs:{label:"票款方式：",prop:"fare_way"}},[a("el-select",{staticStyle:{width:"220px"},attrs:{size:"small",placeholder:"请选择票款方式"},model:{value:e.paymentForm.fare_way,callback:function(t){e.$set(e.paymentForm,"fare_way",t)},expression:"paymentForm.fare_way"}},[a("el-option",{attrs:{label:"先票后款",value:1}}),a("el-option",{attrs:{label:"先款后票",value:2}})],1)],1),a("el-form-item",{key:"transfer_amount",attrs:{label:"付款总额：",prop:"transfer_amount"}},[a("el-input",{staticStyle:{width:"220px"},attrs:{size:"small",placeholder:"根据结算单明细自动计算",disabled:1===e.paymentForm.fare_way},on:{input:function(t){return e.inputInvoiceNum(t,"transfer_amount")}},model:{value:e.paymentForm.transfer_amount,callback:function(t){e.$set(e.paymentForm,"transfer_amount","string"===typeof t?t.trim():t)},expression:"paymentForm.transfer_amount"}})],1),a("el-form-item",{key:"supplier_id",attrs:{label:"供应商：",prop:"supplier_id"}},[a("el-select",{staticStyle:{width:"220px"},attrs:{size:"small",filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入并选择供应商","remote-method":e.getAllSupplierName},on:{change:e.onSupplierIdChange},model:{value:e.paymentForm.supplier_id,callback:function(t){e.$set(e.paymentForm,"supplier_id",t)},expression:"paymentForm.supplier_id"}},e._l(e.allSupplierName,(function(t,i){return a("el-option",{key:i,attrs:{label:t.name,value:t.id}},[a("span",[e._v(e._s(t.name))])])})),1)],1),a("el-form-item",{key:"is_back",attrs:{label:"是否已回款：",prop:"is_back"}},[a("el-select",{staticStyle:{width:"220px"},attrs:{size:"small",placeholder:"请选择是否已回款"},model:{value:e.paymentForm.is_back,callback:function(t){e.$set(e.paymentForm,"is_back",t)},expression:"paymentForm.is_back"}},[a("el-option",{attrs:{label:"是",value:1}}),a("el-option",{attrs:{label:"否",value:0}})],1)],1),a("el-form-item",{key:"achievement_uid",attrs:{label:"收款编号：",prop:"achievement_uid",rules:{required:e.paymentForm.is_back,message:"请输入并选择收款编号",trigger:["change","blur"]}}},[a("el-select",{staticStyle:{width:"220px"},attrs:{disabled:!e.paymentForm.is_back,size:"small",filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入并选择收款编号","remote-method":e.getAchievementList},model:{value:e.paymentForm.achievement_uid,callback:function(t){e.$set(e.paymentForm,"achievement_uid",t)},expression:"paymentForm.achievement_uid"}},e._l(e.achievementList,(function(t,i){return a("el-option",{key:i,attrs:{label:t.achievement_uid,value:t.achievement_uid}},[a("span",[e._v(e._s(t.achievement_uid))])])})),1)],1),a("el-form-item",{attrs:{label:"客户经理："}},[a("el-input",{staticStyle:{width:"220px"},attrs:{size:"small",disabled:"",placeholder:"客户经理",value:e.customerManager}})],1),a("div",{staticClass:"settlementList-title"},[e._v("结算单明细")]),a("div",{staticClass:"invoice-list-wrapper"},[a("div",{staticClass:"header-box"},[a("div",{staticClass:"header-item settlement-uid"},[a("span",{staticClass:"star"},[e._v("*")]),e._v("结算单编号")]),a("div",{staticClass:"header-item settlement-amount"},[e._v("结算金额")]),a("div",{staticClass:"header-item paid-amount"},[e._v("已付金额")]),a("div",{staticClass:"header-item pending_amount"},[e._v("待付金额")]),a("div",{staticClass:"header-item pay_amount"},[a("span",{staticClass:"star"},[e._v("*")]),e._v("本次支付金额")]),a("div",{staticClass:"header-item upload-invoice"},[a("span",{staticClass:"star"},[e._v("*")]),e._v("上传发票")]),a("div",{staticClass:"header-item settlement-delete"},[e._v("操作")])]),e._l(e.paymentForm.settlements,(function(t,i){return a("div",{key:i,staticClass:"body-box"},[a("div",{staticClass:"body-item settlement-uid"},[a("el-form-item",{key:i,attrs:{label:"",prop:"settlements."+i+".settlement_uid",rules:{required:!0,message:"请选择",trigger:"change"}}},[a("el-select",{staticClass:"settlement-uid-select",staticStyle:{width:"168px"},attrs:{filterable:"",size:"small",placeholder:"请选择"},on:{change:function(t){return e.onSettlementUidChanged(t,i)}},model:{value:t.settlement_uid,callback:function(a){e.$set(t,"settlement_uid",a)},expression:"item.settlement_uid"}},e._l(e.settlementList,(function(t){return a("el-option",{key:t.settlement_uid,attrs:{label:t.settlement_uid+"（"+t.project_name+"）",value:t.settlement_uid,disabled:e.settlementUidOptionDisabled(t.settlement_uid,i)}})})),1)],1)],1),a("div",{staticClass:"body-item settlement-amount"},[a("el-form-item",{attrs:{label:""}},[a("el-input",{staticStyle:{width:"168px"},attrs:{size:"small",placeholder:"",disabled:!0},model:{value:t.settlement_amount,callback:function(a){e.$set(t,"settlement_amount","string"===typeof a?a.trim():a)},expression:"item.settlement_amount"}})],1)],1),a("div",{staticClass:"body-item paid-amount"},[a("el-form-item",{attrs:{label:""}},[a("el-input",{staticStyle:{width:"168px"},attrs:{disabled:"",size:"small"},model:{value:t.paid_amount,callback:function(a){e.$set(t,"paid_amount","string"===typeof a?a.trim():a)},expression:"item.paid_amount"}})],1)],1),a("div",{staticClass:"body-item pending_amount"},[a("el-form-item",{attrs:{label:""}},[a("el-input",{staticStyle:{width:"168px"},attrs:{disabled:"",placeholder:"",size:"small"},model:{value:t.pending_amount,callback:function(a){e.$set(t,"pending_amount","string"===typeof a?a.trim():a)},expression:"item.pending_amount"}})],1)],1),a("div",{staticClass:"body-item pay_amount"},[a("el-form-item",{attrs:{label:"",prop:"settlements."+i+".pay_amount",rules:{required:!0,validator:function(t,a,n){return e.pay_amount_check(t,a,n,i)},trigger:"change"}}},[a("el-input",{staticStyle:{width:"168px"},attrs:{placeholder:"请输入支付金额",size:"small",value:t.pay_amount},on:{input:function(t){return e.payAmountChanged(t,i)}}})],1)],1),a("div",{staticClass:"body-item upload-invoice",staticStyle:{display:"flex","justify-content":"center"}},[a("div",{staticClass:"upload-box",staticStyle:{"align-items":"center"}},[a("tg-button",{attrs:{type:"link"},on:{click:function(a){return e.onInvoiceUpload(t)}}},[a("tg-icon",{staticClass:"ico-upload-btn",style:1===e.paymentForm.fare_way&&e.canIUse.uploadInvoiceBtn&&t.write_off_status===e.InoviceWriteOffStatusEnums.write_off_none&&0===t.invoice_info_list.length?"color: #ec1e1e":"",attrs:{name:"ico-upload-lite",disabled:1!==e.paymentForm.fare_way||!e.canIUse.uploadInvoiceBtn||t.write_off_status!==e.InoviceWriteOffStatusEnums.write_off_none&&t.write_off_status!==e.InoviceWriteOffStatusEnums.write_off_part}})],1)],1)]),a("div",{staticClass:"body-item settlement-delete"},[a("tg-icon",{staticClass:"ico-btn",attrs:{disabled:e.paymentForm.settlements.length<=1||0===i,name:"ico-btn-delete"},on:{click:function(t){return e.onDeleteSettlement(i)}}})],1)])}))],2),a("div",{staticClass:"invoice-add-box"},[a("tg-button",{attrs:{icon:"ico-btn-add",size:"mini",disabled:e.paymentForm.settlements.length>=5},on:{click:e.onAddSettlement}},[e._v("结算编号")])],1),1===e.paymentForm.fare_way&&e.associateInvoices.length>0?a("div",{staticClass:"base-title mgt-24"},[e._v(" 发票明细 ")]):e._e(),1===e.paymentForm.fare_way&&e.associateInvoices.length>0?a("div",{staticClass:"invoice-list-wrapper"},[a("div",{staticClass:"header-box"},[a("div",{staticClass:"header-item invoice-settlement-uid"},[e._v("关联结算单号")]),a("div",{staticClass:"header-item invoice-purchaser"},[e._v("购买方")]),a("div",{staticClass:"header-item invoice-seller"},[e._v("销售方")]),a("div",{staticClass:"header-item invoice-no"},[e._v("发票号码")]),a("div",{staticClass:"header-item invoice-date"},[e._v("发票日期")]),a("div",{staticClass:"header-item invoice-amount"},[e._v("发票金额")]),a("div",{staticClass:"header-item invoice-write-off-amount"},[e._v("发票核销金额")]),a("div",{staticClass:"header-item tax-rate"},[e._v("税率")]),a("div",{staticClass:"header-item tax"},[e._v("税额")]),a("div",{staticClass:"header-item no-tax"},[e._v("不含税金额")]),a("div",{staticClass:"header-item invoice-type"},[e._v("发票类型")])]),e._l(e.associateInvoices,(function(t,i){return a("div",{key:i,staticClass:"body-box"},[a("div",{staticClass:"body-item invoice-settlement-uid"},[e._v(" "+e._s(t.settlement_uid)+" ")]),a("div",{staticClass:"body-item invoice-purchaser line-clamp-1"},[a("el-popover",{attrs:{"open-delay":300,trigger:"hover",content:t.buyer_name}},[a("div",{staticClass:"line-clamp-1",attrs:{slot:"reference"},slot:"reference"},[e._v(" "+e._s(t.buyer_name)+" ")])])],1),a("div",{staticClass:"body-item invoice-seller"},[a("el-popover",{attrs:{"open-delay":300,trigger:"hover",content:t.seller_name}},[a("div",{staticClass:"line-clamp-1",attrs:{slot:"reference"},slot:"reference"},[e._v(" "+e._s(t.seller_name)+" ")])])],1),a("div",{staticClass:"body-item invoice-no"},[e._v(" "+e._s(t.invoice_number)+" ")]),a("div",{staticClass:"body-item invoice-date"},[e._v(" "+e._s(e.invoice_date(t.invoice_date))+" ")]),a("div",{staticClass:"body-item invoice-amount"},[e._v(" "+e._s(t.total_amount)+" ")]),a("div",{staticClass:"body-item invoice-write-off-amount"},[e._v(" "+e._s(t.write_amount_by_this_settlement)+" ")]),a("div",{staticClass:"body-item tax-rate"},[e._v(" "+e._s(t.tax_rate)+" ")]),a("div",{staticClass:"body-item tax"},[e._v(" "+e._s(t.tax_amount)+" ")]),a("div",{staticClass:"body-item no-tax"},[e._v(" "+e._s(t.tax_excluded_amount)+" ")]),a("div",{staticClass:"body-item invoice-type"},[e._v(" "+e._s(1===t.invoice_type?"销售发票":"采购发票")+" ")])])}))],2):e._e(),a("el-form-item",{key:"receive_way",class:1!==e.paymentForm.fare_way||0===e.associateInvoices.length?"mgt-12":"",attrs:{label:"收款方式：",prop:"receive_way"}},[a("el-radio-group",{staticStyle:{width:"800px","margin-top":"9px"},model:{value:e.paymentForm.receive_way,callback:function(t){e.$set(e.paymentForm,"receive_way",t)},expression:"paymentForm.receive_way"}},[a("el-radio",{attrs:{label:3}},[e._v("对公账户")]),a("el-radio",{attrs:{label:4}},[e._v("对公支付宝")]),a("el-radio",{attrs:{label:2}},[e._v("V任务")])],1)],1),3===e.paymentForm.receive_way?a("el-form-item",{key:"bank_account",attrs:{label:"银行账号：",prop:"bank_account"}},[a("el-select",{staticStyle:{width:"220px"},attrs:{size:"small",placeholder:"请选择银行账号"},on:{change:e.chooseBankAccount},model:{value:e.paymentForm.bank_account,callback:function(t){e.$set(e.paymentForm,"bank_account",t)},expression:"paymentForm.bank_account"}},e._l(e.bankAccount,(function(e,t){return a("el-option",{key:t,attrs:{label:e.bank_card_number,value:e.bank_card_number}})})),1)],1):e._e(),3===e.paymentForm.receive_way?a("el-form-item",{key:"bank",attrs:{label:"开户行：",prop:"bank"}},[a("el-input",{staticStyle:{width:"220px"},attrs:{disabled:"",size:"small",placeholder:"请输入开户行"},model:{value:e.paymentForm.bank,callback:function(t){e.$set(e.paymentForm,"bank","string"===typeof t?t.trim():t)},expression:"paymentForm.bank"}})],1):e._e(),4===e.paymentForm.receive_way?a("el-form-item",{key:"name",attrs:{label:"收款人：",prop:"name"}},[a("el-input",{staticStyle:{width:"220px"},attrs:{disabled:"",size:"small",placeholder:"请输入收款人"},model:{value:e.paymentForm.name,callback:function(t){e.$set(e.paymentForm,"name","string"===typeof t?t.trim():t)},expression:"paymentForm.name"}})],1):e._e(),4===e.paymentForm.receive_way?a("el-form-item",{key:"alipay_account",attrs:{label:"支付宝账号：",prop:"alipay_account",rules:{required:!0,message:"请至供应商管理功能完善信息",trigger:"change"}}},[a("el-select",{staticStyle:{width:"220px"},attrs:{size:"small",placeholder:"请选择支付宝账号"},model:{value:e.paymentForm.alipay_account,callback:function(t){e.$set(e.paymentForm,"alipay_account",t)},expression:"paymentForm.alipay_account"}},e._l(e.alipay,(function(e){return a("el-option",{key:e.alipay_account,attrs:{label:e.alipay_account,value:e.alipay_account}})})),1)],1):e._e(),a("el-form-item",{key:"pay_reason",staticClass:"textarea-form-item",attrs:{label:"付款事由：",prop:"pay_reason"}},[a("el-input",{staticStyle:{width:"590px","margin-top":"5px"},attrs:{type:"textarea",rows:3,size:"small",placeholder:"请输入付款事由",maxlength:"100","show-word-limit":""},model:{value:e.paymentForm.pay_reason,callback:function(t){e.$set(e.paymentForm,"pay_reason","string"===typeof t?t.trim():t)},expression:"paymentForm.pay_reason"}})],1),0===e.paymentForm.is_back?a("el-form-item",{key:"borrowing_id",staticStyle:{"margin-top":"6px"},attrs:{label:"关联审批单："}},[a("el-select",{staticStyle:{width:"590px"},attrs:{size:"small",clearable:"",placeholder:"请选择关联审批单"},model:{value:e.paymentForm.borrowing_id,callback:function(t){e.$set(e.paymentForm,"borrowing_id",t)},expression:"paymentForm.borrowing_id"}},e._l(e.borrowList,(function(t,i){return a("el-option",{key:i,attrs:{label:t.name,value:t.id}},[a("span",[e._v(e._s(t.name))])])})),1)],1):e._e(),a("div",{staticClass:"base-title",staticStyle:{"margin-top":"24px"}},[e._v("其他信息")]),a("el-form-item",{attrs:{label:"备注："}},[a("el-input",{staticStyle:{width:"590px","margin-top":"5px"},attrs:{type:"textarea",rows:2,size:"small",placeholder:"请输入备注",maxlength:"50","show-word-limit":""},model:{value:e.paymentForm.remark,callback:function(t){e.$set(e.paymentForm,"remark","string"===typeof t?t.trim():t)},expression:"paymentForm.remark"}})],1),a("el-form-item",{attrs:{label:"附件："}},[a("div",{staticClass:"upload-box"},[a("tg-upload",{attrs:{disabled:e.paymentForm.fileList.length>=5,action:"/api/approval/upload_approval_attachment","show-file-list":!1,beforeUpload:e.beforeUpload,success:e.successHandle}},[a("tg-button",{attrs:{disabled:e.paymentForm.fileList.length>=5,icon:"ico-upload-lite"}},[e._v("上传附件")])],1),a("span",{staticClass:"file-tips"},[e._v(" 支持扩展名：.xlsx .xls .docx .doc .pdf .jpg .png；最多上传5个文件（单个文件大小不超过30M） ")])],1),a("div",{staticClass:"file-list-box"},[a("upload-file-list",{model:{value:e.paymentForm.fileList,callback:function(t){e.$set(e.paymentForm,"fileList",t)},expression:"paymentForm.fileList"}})],1)])],1)],1)]),a("invoice-upload",{ref:"InvoiceUploadRef",on:{success:e.onInvoiceUploadSuccess}}),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在提交，请稍候..."}})],1)},n=[],s=(a(21703),a(97434)),l=a(11676),o=a(74750),r=a(3346),c=a(79433),m=a(58061),u=a(83005),p=a(64236),d=a(69706),_=a(41572),v=a(28645),y=a(57046),f=a(6933),b=a.n(f),g=a(87843),h=a(29625),k=a(21757),w=a(84731),x=a(3293);const C=e=>`company${e}`;var F=(0,s.defineComponent)({name:"paymentDialog",props:{visible:{type:Boolean,required:!0,default:!0},data:{type:Object,default:()=>({})},projectType:{type:Number,required:!1},edit:{type:Boolean,required:!1,default:!1},info:{type:Object,required:!1,default:()=>({})},settlement:{type:Object,required:!1},customerManager:{type:String,required:!1}},components:{InvoiceUpload:v.Z},setup(e,t){const a=(0,s.ref)(!1),i=(0,s.ref)(!1),n=(0,s.computed)((()=>(0,o.LP)())),v=(0,s.ref)([]),f=(0,s.ref)(void 0),F=(0,s.ref)(null),S=(0,k.gI)(),j=(0,s.computed)((()=>{let t=!1;switch(e.projectType){case h.kA.live:t=S.shop_live_upload_invoice;break;case h.kA.marketing:t=S.coop_upload_invoice;break;case h.kA.common_business:t=S.common_upload_invoice;break}return{uploadInvoiceBtn:t}})),q=(t=!1)=>t?{settlement_id:e.settlement?.id,settlement_uid:e.settlement?.settlement_uid??"",settlement_amount:e.settlement?.tax_included_amount??void 0,paid_amount:e.settlement?.paid_amount??void 0,pending_amount:e.settlement?.pending_amount??void 0,project_name:e.settlement?.project_name??"",write_off_amount:e.settlement?.write_off_amount??0,pay_amount:void 0,company_name:e.settlement?.company_name??"",invoice_info_list:[]}:{settlement_id:void 0,settlement_uid:"",settlement_amount:void 0,paid_amount:void 0,pending_amount:void 0,project_name:"",company_name:"",pay_amount:void 0,write_off_amount:0,invoice_info_list:[]},I=()=>({business_type:"",region:0,transfer_amount:"",fare_way:"",is_back:"",achievement_uid:"",supplier_id:e.settlement?.company_id?C(e.settlement.company_id):"",collecting_company:"",receive_way:3,bank_account:null,bank:null,name:null,alipay_account:null,pay_reason:"",borrowing_id:"",is_contract_signed:"",remark:"",fileList:[],invoice_list:[{invoice_image:"",invoice_type:"",invoice_no:"",invoice_date:"",invoice_amount_detail:"",tax_amount:"",tax_point:"",no_tax:"",tax:"",is_upload:!0}],contract_uid:"",project_feishu_department_id:e.settlement?.project_feishu_department_id,project_feishu_department_name:e.settlement?.project_feishu_department_name,settlements:[q(!0)],...(0,s.toRefs)(e.data)}),$=(0,s.ref)(I()),z=(0,s.ref)([]),L=(0,s.ref)([]),D=(0,s.ref)([]),O=(0,s.ref)([]),U=(0,s.computed)((()=>{let e=[];return $.value.settlements?.forEach((t=>{const a=v.value.find((e=>e.settlement_id===t.settlement_id));a?.invoice_info_list?.length&&(e=e.concat(a.invoice_info_list))})),e})),A=e=>{$.value.invoice_num=e.target.value},E=async()=>{const{data:e}=await(0,c.$3)();e&&e.success?O.value=e.data:t.root.$message.error(e.message??"请求失败")},B=()=>{$.value=I(),L.value=[],v.value=[],z.value=[],D.value=[],O.value=[]},T=(0,s.ref)({business_type:[{required:!0,message:"请选择业务类型",trigger:["blur","change"]}],project_name:[{required:!0,message:"请输入项目名称",trigger:["blur","change"]}],brand_name:[{required:!0,message:"请选择品牌",trigger:["blur","change"]}],is_contract_signed:[{required:!0,message:"请选择是否已签合同",trigger:["blur","change"]}],transfer_amount:[{required:!0,message:"请输入付款金额",trigger:["blur","change"]},{validator:(e,t,a)=>{"0"===t?a(new Error("付款金额必须大于0")):a()},trigger:["blur","change"]}],fare_way:[{required:!0,message:"请选择票款方式",trigger:["blur","change"]}],is_back:[{required:!0,message:"请选择是否已回款",trigger:["blur","change"]}],receive_way:[{required:!0,message:"请选择收款方式",trigger:["blur","change"]}],supplier_id:[{required:!0,message:"请输入并选择供应商",trigger:["blur","change"]}],bank_account:[{required:!0,message:"请至选择银行账号",trigger:["blur","change"]}],bank:[{required:!0,message:"请至供应商管理功能完善信息",trigger:["blur","change"]}],name:[{required:!0,message:"请至供应商管理功能完善信息",trigger:["blur","change"]}],alipay_account:[{required:!0,message:"请至选择支付宝账号",trigger:["blur","change"]}],pay_reason:[{required:!0,message:"请输入付款事由",trigger:["blur","change"]}]}),X=async e=>{const t={project_id:$.value.project_id,business_type:$.value.business_type,achievement_uid:e},{data:a}=await(0,c.Vn)(t);L.value=a.success?a.data:[]},G=async e=>{const{data:t}=await(0,r.qC)({keyword:e,verify_status:1});D.value=t.success?t.data:[]},N=(0,s.ref)([]),R=(0,s.ref)([]),M=e=>{if(!e)return;$.value.supplier_id=e;const t=D.value.filter((t=>{if(t.id===e)return t}));if($.value.bank="",$.value.bank_account="",$.value.alipay_account="",$.value.name="",$.value.name=t[0]?t[0].name:"",t[0]&&t[0].gather_account_list&&t[0].gather_account_list.length>0){const e=t[0].gather_account_list;e[0].bank_card_number&&($.value.bank_account=e[0].bank_card_number,$.value.bank=e[0].bank_of_deposit);const a=[],i=[];for(let t=0;t<e.length;t++)1===e[t].account_type?a.push(e[t]):i.push(e[t]);N.value=a,R.value=i}else N.value=[],R.value=[]},P=e=>{const t=N.value.filter((t=>{if(t.bank_card_number===e)return t}));$.value.bank=t[0].bank_of_deposit},K=e=>(0,l.K)({image:!0,fileSize:5})(e),V=()=>{let e=new d.Decimal(0);for(let t=0;t<$.value.settlements.length;t++)""!==$.value.settlements[t].pay_amount&&(e=e.add(new d.Decimal($.value.settlements[t].pay_amount?$.value.settlements[t].pay_amount:0)));$.value.transfer_amount=e.toFixed(2)},W=(e,t,a)=>{const i=e.replace(/[^\d.]+/gu,"").replace(/^0+(?=\d)/gu,"")??"",n=/\d+(?:\.\d{0,2})?/gu.exec(i)??[""];"tax_amount"!==t||!a&&0!==a?"transfer_amount"===t&&($.value.transfer_amount=n[0]):$.value.invoice_list[a].tax_amount=n[0]},Z=(0,s.computed)((()=>{let e=0;for(let t=0;t<$.value.invoice_list.length;t++)""!==$.value.invoice_list[t].tax_amount&&(e+=Number($.value.invoice_list[t].tax_amount));return e})),H=(e,t)=>{if(""===e.tax_point)return!1;if(""===e.tax_amount)return $.value.invoice_list[t].no_tax="",$.value.invoice_list[t].tax="",!1;const a=new d.Decimal(e.tax_point).dividedBy(100),i=a.plus(1),n=new d.Decimal(e.tax_amount),s=n.dividedBy(i),l=s.times(a);$.value.invoice_list[t].no_tax=s.toFixed(2),$.value.invoice_list[t].tax=l.toFixed(2)},Q=e=>(0,l.K)({excel:!0,file:!0,image:!0,fileSize:30})(e),J=e=>{$.value.fileList.push(e.data.source)},Y=(e=!1)=>{t.emit("update:visible",!1),t.emit("dialog:close",e)},ee=async()=>{const a=await new Promise((e=>t.refs.paymentFormRef.validate((t=>e(t)))));if(!a)return;let n=!1;if($.value.settlements.forEach((e=>{const t=new d.Decimal(0),a=new d.Decimal(e.pay_amount?e.pay_amount:0),i=new d.Decimal(e.pending_amount?e.pending_amount:0);(a.lessThanOrEqualTo(t)||a.greaterThan(i))&&(n=!0)})),n)return void t.root.$message.warning("本次支付金额需大于0，小于待支付金额");const s={transfer_amount:$.value.transfer_amount+"",company_id:$.value.supplier_id,collecting_company:$.value.name,bank_of_deposit:3===$.value.receive_way?$.value.bank:"",bank_card_number:3===$.value.receive_way?$.value.bank_account:"",remark:$.value.remark,level_three_types:$.value.receive_way,level_two_types:1,collecting_person:4===$.value.receive_way?$.value.name:"",alipay_account:4===$.value.receive_way?$.value.alipay_account:"",pay_reason:$.value.pay_reason,approval_type:1,business_type:$.value.business_type,project_id:$.value.project_id,brand_id:$.value.brand_id,pay_invoice_type:$.value.fare_way,is_contract_signed:$.value.is_contract_signed,borrowing_id:$.value.is_back?"":$.value.borrowing_id,is_back:$.value.is_back,achievement_uid:$.value.is_back?$.value.achievement_uid:"",pay_invoices:void 0,attachment:$.value.fileList,contract_uid:$.value.contract_uid,allocated_department_id:$.value.project_feishu_department_id,settlements:$.value.settlements.map((e=>({settlement_uid:e.settlement_uid,pay_amount:e.pay_amount})))};i.value=!0;const[{data:l},o]=await Promise.all([await(0,m.lV)(s),await(0,p._v)(200)]);i.value=!1,l.success?(t.root.$message.success(l.message),t.emit("save"),Y(),e.edit&&t.emit("dialog:reClose")):t.root.$message.error(l.message??"保存失败")},te=(0,w.f)(),ae=async e=>{a.value=!0;let t=1;te.isLiveDetail||te.isCommonBusinessDetail?t=1:te.isCoopDetail&&(t=2);const i=await(0,u.z0)({search:e,only_main:0,project_id:e||2===t?void 0:$.value.project_id,cooperation_id:e||1===t?void 0:$.value.project_id,business_type:e?void 0:$.value.business_type,partner_type:2,contract_status:2});a.value=!1,i.data.success?z.value=i.data.data.data:z.value=[]},ie=()=>{const e=[];$.value.settlements.forEach((t=>{const a=v.value.find((e=>e.settlement_id===t.settlement_id));a&&e.push({...(0,y.I8)(a),pay_amount:t.pay_amount})})),$.value.settlements=e},ne=async()=>{const e=await(0,m.pX)();e.data.success&&(v.value=e.data.data,ie())},se=e=>{$.value.settlements.splice(e,1),V()},le=()=>{$.value.settlements.push(q())},oe=(e,t)=>{const a=v.value.find((t=>t.settlement_uid===e));$.value.settlements.splice(t,1,{...(0,y.I8)(a),pay_amount:void 0}),V()},re=(e,t)=>{let a=!1;return $.value.settlements.forEach(((i,n)=>{i.settlement_uid!==e||t===n||(a=!0)})),a},ce=(e,t)=>{const a=$.value.settlements[t],i=(/(?:0|[1-9]\d{0,20})(?:\.\d{0,2})?/u.exec(e.replace(_.Pj,""))??[""])[0];a.pay_amount=i,V()};(0,s.onBeforeMount)((()=>{e.edit&&(E(),ae(),ne(),G(e.info.collecting_company),$.value.transfer_amount=e.info.transfer_amount,$.value.is_contract_signed=e.info.is_contract_signed,$.value.fare_way=e.info.pay_invoice_type,$.value.is_back=e.info.is_back,$.value.achievement_uid=e.info.achievement_uid,$.value.supplier_id=e.info.company_id,$.value.receive_way=e.info.level_three_types,$.value.bank_account=e.info.bank_card_number,$.value.bank=e.info.bank_of_deposit,$.value.name=e.info.collecting_person,$.value.alipay_account=e.info.alipay_account,$.value.pay_reason=e.info.pay_reason,$.value.borrowing_id=e.info.borrowing_id,$.value.invoice_list=e.info.invoices,$.value.remark=e.info.remark,$.value.fileList=e.info.attachment,$.value.contract_uid=e.info.contract_uid,$.value.settlements=e.info.settlements??[],$.value.project_id=e.info.project_id,$.value.invoice_list.forEach(((e,t)=>{H(e,t)})),V())})),(0,s.watch)([()=>e.visible,()=>e.settlement],(([e,t])=>{if(e){E(),ae(),ne(),B();const e=t;G(e.company_name).then((()=>{const e=D.value.some((e=>e.id===$.value.supplier_id));e?M($.value.supplier_id):$.value.supplier_id=""}))}else B(),setTimeout((()=>{f.value?.clearValidate()}),300);V()})),(0,s.watch)((()=>$.value.invoice_list),(()=>{1===$.value.fare_way&&($.value.transfer_amount=Z.value.toFixed(2))}),{deep:!0}),(0,s.watch)((()=>$.value.is_back),(e=>{0===e&&($.value.achievement_uid="")})),(0,s.watch)((()=>$.value.is_contract_signed),(e=>{0===e&&($.value.contract_uid="")}));const me=t=>{1!==$.value.fare_way||!j.value.uploadInvoiceBtn||t.write_off_status!==g.iO.write_off_none&&t.write_off_status!==g.iO.write_off_part||F.value.show({id:t.settlement_id,company:t.company_name},2,e.projectType)},ue=e=>b()(1e3*e).format("yyyy.MM.DD"),pe=(e,t,a,i)=>{const n=$.value.settlements[i],s=new d.Decimal(n.pending_amount?n.pending_amount:0),l=new d.Decimal(n.write_off_amount?n.write_off_amount:0);let o;o=1===$.value.fare_way&&s.greaterThan(l)?l:s;const r=new d.Decimal(t||0);return""===t||void 0===t||null===t?a(new Error("请输入本次支付金额")):"0"===t?a(new Error("本次支付金额需大于0")):r.greaterThan(o)?a(new Error(`本次最多支付${o.toString()}元`)):a()},de=()=>{ne()},_e=(0,s.computed)((()=>{let e=$.value.business_type||0;return e=3===e&&1===$.value.region?7:e,e})),ve=(0,s.ref)(void 0),ye=(0,s.ref)([]),fe=async()=>{const e=await(0,x.o1)({num:1e3,page_num:1}),t=e.data.data.data;ye.value=t},be=t=>{ve.value?.setCheckedKeys([]),e.settlement?.project_feishu_department_id===t.id?($.value.project_feishu_department_id=void 0,$.value.project_feishu_department_name=""):($.value.project_feishu_department_id=t.id,$.value.project_feishu_department_name=t.name,ve.value?.setCheckedKeys([t.id]))},ge=(0,s.computed)((()=>$.value.project_feishu_department_id?[$.value.project_feishu_department_id]:[])),he={label:"name",children:"sons"};return(0,s.onMounted)((()=>{fe()})),{treeProps:he,business_type_new:_e,saveLoading:i,emitClose:Y,handleDialogSubmit:ee,paymentForm:$,paymentFormRules:T,resetForm:B,achievementList:L,getAchievementList:X,borrowList:O,allSupplierName:D,getAllSupplierName:G,onSupplierIdChange:M,beforeUpload:Q,successHandle:J,beforeInvoiceUpload:K,Auth:n,blur:A,computedTax:H,inputInvoiceNum:W,queryContractLoading:a,contractList:z,queryContractRequest:ae,settlementList:v,onDeleteSettlement:se,onAddSettlement:le,onSettlementUidChanged:oe,payAmountChanged:ce,paymentFormRef:f,settlementUidOptionDisabled:re,bankAccount:N,chooseBankAccount:P,alipay:R,onInvoiceUpload:me,InvoiceUploadRef:F,associateInvoices:U,invoice_date:ue,pay_amount_check:pe,onInvoiceUploadSuccess:de,InoviceWriteOffStatusEnums:g.iO,canIUse:j,feishuDepartmentList:ye,cb_department_tree:ve,handleCheckChange:be,default_checked_department_ids:ge}}}),S=F,j=a(1001),q=(0,j.Z)(S,i,n,!1,null,"257d203e",null),I=q.exports},58061:function(e,t,a){a.d(t,{Kh:function(){return G},LK:function(){return D},ow:function(){return U},pX:function(){return X},QC:function(){return O},oN:function(){return A},_3:function(){return E},lV:function(){return B},AU:function(){return T},G1:function(){return L},ey:function(){return S},Sg:function(){return F},Fh:function(){return $},hU:function(){return I},G9:function(){return x},zQ:function(){return z},Cl:function(){return C},MI:function(){return j},Pg:function(){return q}});const i="/api/coop/query_cooperation_cost",n="/api/payable/query_marketing_payables",s="/api/coop/del_cost",l="/api/coop/query_achievement",o="/api/kol/get_kol_company",r="/api/coop/add_cost_list",c="/api/coop/update_cost",m="/api/coop/save_rebate_cost",u="/api/coop/v2/query_cooperation",p="/api/coop/get_cooperation/:id/",d="/api/coop/v2/save_cooperation",_="/api/coop/save_cooperation_ae",v="/api/coop/confirm_end_cooperation",y="/api/approval/save_transfer_apply",f="/api/approval/save_refund_apply",b="/api/approval/query_settlements_for_payment_approval",g="/api/coop/create_cost_payment";var h=a(76012),k=a(64236),w=a(25702);const x=async e=>(0,h.dX)(i,{params:{cooperation_id:e,num:1e3,page_num:1}}),C=async(e,t)=>(0,h.dX)(n,{params:{project_id:e,payable_type:t}}),F=async e=>(0,h.SO)(s,{cost_id:e}),S=async e=>(0,h.SO)(r,e),j=async e=>(0,h.SO)(m,e),q=async e=>(0,h.SO)(c,e),I=async e=>(0,h.dX)(l,{params:{cooperation_id:e,num:1e3,page_num:1,is_reverse:!0}}),$=async(e,t,a)=>(0,h.dX)(w.cW,{params:{approval_type:e,customer_id:t,level_three_types:a}}),z=async e=>(0,h.dX)(o,{params:{kol_id:e}}),L=async e=>(0,h.SO)("/api/resources/upload_file",e),D=async e=>(0,h.dX)(u,{params:{...(0,k.jG)(e)}}),O=async e=>(0,h.SO)(d,{...(0,k.jG)(e)}),U=async e=>(0,h.dX)(p.replace(":id",e)),A=async e=>(0,h.SO)(_,{...(0,k.jG)(e)}),E=async e=>(0,h.SO)(v,{...(0,k.jG)(e)}),B=async e=>(0,h.SO)(y,{...(0,k.jG)(e)}),T=async e=>(0,h.SO)(f,{...(0,k.jG)(e)}),X=async()=>(0,h.dX)(b),G=async e=>(0,h.SO)(g,{...(0,k.jG)(e)})}}]);
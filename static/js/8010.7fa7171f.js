"use strict";(self["webpackChunkgoumee_star_temp"]=self["webpackChunkgoumee_star_temp"]||[]).push([[8010],{58008:function(e,t,a){a.d(t,{Z:function(){return u}});var n,o,i=a(97434),s=(0,i.defineComponent)({name:"SubTabs",props:{},setup(){const e=(0,i.ref)(0);return{index:e}},render(e){const t=this.$slots.default||[],a=t[this.index];return e("div",{class:"tgb-subtabs"},[e("div",{class:"tgb-subtabs-header"},[t.map(((t,a)=>e("div",{class:a===this.index?"active":"",key:a,on:{click:()=>this.index=a}},[t?.data?.attrs?.name])))]),a])}}),l=s,r=a(1001),c=(0,r.Z)(l,n,o,!1,null,"2148bfe6",null),u=c.exports},2698:function(e,t,a){a.d(t,{Z:function(){return v}});var n=a(97434),o=a(49187),i=a(85937),s=a.n(i);const l=new o.ZP,r=e=>""===e||void 0===e?"--":`${l.format(e,o.WL.Yuan)}`;var c,u,d=(0,n.defineComponent)({props:{write_off_infos:Array,write_off_header:{type:Array,default:()=>[]},write_off_status:{type:Number},is_reverse:{type:Boolean,default:!1}},name:"WriteOff",render(){const e=arguments[0],t=[];let a=0;return 3===(this.write_off_header?.length??0)&&(a=-1),2===this.write_off_status?t.push(e("div",{class:"status",key:"key1"},[e("label",["状态："]),e("span",["已核销"])])):1===this.write_off_status?t.push(e("div",{class:"status",key:"key2"},[e("label",["状态："]),e("span",{class:"yellow"},["部分核销"])])):0===this.write_off_status&&t.push(e("div",{class:"status",key:"key3"},[e("label",["状态："]),e("span",{class:"yellow"},["未核销"])])),(this.write_off_infos?.length??0)>0&&t.push(e("div",{class:"status",key:"key4"},[e("label",["详情："]),e("el-popover",{attrs:{placement:"bottom-end",trigger:"hover","popper-class":"achievement-popover"}},[e("a",{slot:"reference"},["预览"]),e("div",{style:0===a?"width: 604px":"width: 444px",class:"writeoff-popover-content"},[e("div",{class:"table-header"},[e("table",[e("colgroup",[0===a?e("col",{style:"width:170px"}):"",e("col"),e("col",{style:"width:128px"}),e("col",{style:"width:102px"})]),e("thead",[e("tr",[0===a?e("th",[this.write_off_header[a]]):"",e("th",[this.write_off_header[a+1]]),e("th",{attrs:{align:"right"}},[this.write_off_header[a+2]]),e("th",[this.write_off_header[a+3]])])])])]),e("div",{class:"table-body"},[e("table",[e("colgroup",[0===a?e("col",{style:"width:170px"}):"",e("col"),e("col",{style:"width:128px"}),e("col",{style:"width:102px"})]),e("tbody",[this.write_off_infos?.map((t=>{const n=/-/u.test(t[a+2]);return e("tr",[0===a?e("td",[t[a]]):"",e("td",{class:n?"reverse-red":""},[t[a+1]]),e("td",{class:n||new(s())(t[a+2]).lessThan(new(s())(0))?"reverse-red":"",attrs:{align:"right"}},[r(t[a+2])]),e("td",[e("div",[t[a+3]]),e("div",{class:"label"},[t[a+4]])])])}))])])])])])])),e("div",[t])}}),m=d,p=a(1001),_=(0,p.Z)(m,c,u,!1,null,"76e5bcce",null),v=_.exports},68762:function(e,t,a){a.d(t,{Z:function(){return k}});a(21703);var n=a(36568),o=a.n(n),i=a(97434),s=a(21757),l=a(44928),r=a(42993),c=a(6933),u=a.n(c),d=a(96732),m=a(48606);const p=(e,t)=>{const a=(0,i.ref)([]),n=(0,i.ref)(),o=(0,i.ref)([]),s=e=>a.value.find((t=>t.date+""===e.format("YYYYMMDD"))),l=(i,s,l,r=!0)=>{e.query(i,s,l).then((e=>{e.data.success?(a.value=e.data.data.data,n.value=a.value.pop(),o.value=e.data.data.rest_days??[]):(r&&m.Message.error(e.data.message),200===e.data.error_code&&t?.emit("withoutPermission"))}))},r=t=>e.save(t);return(0,i.reactive)({save:r,query:l,list:a,total:n,find:s,restDate:o})};var _=a(78066),v=a(88721),f=a(29625);const g=v.Z;var y,h,x=(0,i.defineComponent)({props:{query:{type:Function},save:{type:Function},type:{type:String},business_type:{type:Number},cooperation_type:{type:Number},end_date:{type:String},near_seven_data:{type:Boolean,default:!1},itemHeight:{type:String,default:"32px"},showRest:{type:Boolean,default:!0},showQueryError:{type:Boolean,default:!0}},components:{CalendarCustom:r.ZP,MarketDialog:d.Z},setup(e,t){const a=(0,s.gI)(),n=p({save:e.save,query:e.query},t),o=(0,r.vu)(r.i4.Week,{integerMonth:!0},e.near_seven_data,e.itemHeight,e.showRest),c=(0,l.t)(),u=c.currentRoute.params.id,d=(0,i.reactive)({visible:!1,title:"预设净销比例",data:{},project_id:u}),m=(0,i.ref)(),_=()=>{const t=Number(o.startTime.format("YYYYMMDD")),a=Number(o.endTime.format("YYYYMMDD"));n.query(t,a,u,e.showQueryError)},g=e=>{o.add(e),_()},y=e=>{o.changeCalendarType(e),_()},h=(0,i.ref)({});(0,i.watch)((()=>[e.business_type,o.type,e.cooperation_type]),(()=>{3===e.business_type&&e.cooperation_type===f.x3.selfSupport?x["gmv"]={field:"gmv",label:"直播间GMV (元)",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]}:x["gmv"]={field:"gmv",label:"GMV（元）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},w()}));const x={};x["直播时长"]={field:"live_duration",label:"直播时长(时)",limit:[v.Z.NineIntergerAndDecimals],maxLength:16},x["直播增粉"]={field:"new_fans_count",label:"直播增粉（人）",maxLength:9,limit:[v.Z.Interger]},x["uv"]={field:"uv",label:"UV",maxLength:9,limit:[v.Z.Interger]},x["最高在线"]={field:"max_uv",label:"最高在线（人）",maxLength:9,limit:[v.Z.Interger]},x["停留时长"]={field:"avg_stay",label:"停留时长（秒）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},3===e.business_type&&e.cooperation_type===f.x3.selfSupport?x["gmv"]={field:"gmv",label:"直播间GMV (元)",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]}:x["gmv"]={field:"gmv",label:"GMV（元）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},x["shop_gmv"]={field:"shop_gmv",label:"小店GMV（元）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},x["goal_gmv"]={field:"goal_gmv",label:"目标GMV",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},x["gmv_percent"]={field:"gmv_percent",label:"目标完成度",edit:!1},x["净销比例"]={field:"net_sales_rate",label:"净销比例（%）",maxLength:6,limit:[v.Z.NumberRange(0,100)],format:e=>null===e||void 0===e||""===e?e:`${e}%`},x["预估净销额"]={field:"net_sales_amount",label:"预估净销额（元）",edit:!1},x["投放金额"]={field:"promote_amount",label:"投放金额（元）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},x["定向投放"]={field:"roi",label:"定向投放（倍）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]};const b=e=>e.filter(Boolean).map((e=>{if(void 0===x[e])throw new Error(`${e}找不到`);return x[e]})),w=()=>{"base"===e.type?h.value=b([3===e.business_type&&e.cooperation_type===f.x3.selfSupport&&"shop_gmv","goal_gmv","gmv_percent","gmv",(2===e.business_type||3===e.business_type)&&"uv","直播增粉","最高在线","停留时长","直播时长",3===e.business_type&&"投放金额",3===e.business_type&&"定向投放","净销比例","预估净销额"]):"market"===e.type?h.value=[{field:"income_amount",label:"到账金额（元）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]}]:"mcn"===e.type&&(h.value=[{field:"gmv",label:"GMV（元）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},{field:"operating_amount",label:"运营费用（元）",maxLength:16,limit:[v.Z.NineIntergerAndDecimals]},{field:"live_count",label:"直播场次(场)",maxLength:9,limit:[v.Z.Interger]},{field:"live_duration",label:"开播时长（小时）",limit:[v.Z.NineIntergerAndDecimals],maxLength:16},{field:"anchor_count",label:"开播主播数（人）",limit:[v.Z.Interger],maxLength:9}])};return w(),_(),{project_id:u,queryAuto:_,add:g,changeCalendarType:y,permission:a,config:o,dailydata:n,dialogConfig:d,fields:h,active:m}},render(){const e=arguments[0],t=this.config,a={props:this.dialogConfig,on:{"dialog:close":()=>{this.dialogConfig.visible=!1},saveCommissinRate:e=>{(0,_.HR)({...e,project_id:this.project_id}).then((e=>{if(!0!==e.data.success)throw new Error(e.data.message)})).then((()=>{this.dialogConfig.visible=!1,m.Message.success("保存成功")})).then((()=>{this.queryAuto()})).catch((e=>{m.Message.error(e.message)}))},saveSubmit:e=>this.dailydata.save(e).then((e=>(this.queryAuto(),e))).then((e=>{1001!==e.data.error_code&&m.Message.success("保存成功")})).catch((e=>{m.Message.error(e.message)}))}},n=t.currentDate.format("YYYY年M月"),s=`${t.startTime.format("YYYY.MM.DD")} ～ ${t.endTime.format("MM.DD")}`,l=this.dailydata.total||{};return e("div",{class:"dailydata page-calendar"},[e("div",{class:"operation"},[e("div",{class:"left"},[e("div",{class:"btn-circle",on:{click:()=>this.add(-1)}},[e("tg-icon",{attrs:{name:"ico-arrow-left"}})]),e("div",{class:"btn-circle",on:{click:()=>this.add(1)}},[e("tg-icon",{attrs:{name:"ico-arrow-right"}})]),e("div",{class:"calendar-date-range"},[t.type===r.i4.Month?n:s]),e("div",{class:"tips"},["日报数据将在每日凌晨通过系统自动填写部分数据 （",e("span",{style:{color:"#FF7A36"}},["注：双击单元格编辑日报数据"]),"）"])]),e("div",{class:"right"},["base"===this.type&&e("div",{class:"pre-supposition",on:{click:()=>{a.props.visible=!0}}},["预设净销比例"]),e("div",{class:"calendar-type-group"},[e("span",{on:{click:()=>this.changeCalendarType(r.i4.Week)},class:r.i4.Week===this.config.type&&"active"},["周"]),e("span",{on:{click:()=>this.changeCalendarType(r.i4.Month)},class:r.i4.Month===this.config.type&&"active"},["月"])])])]),3===this.business_type&&e("div",{style:"padding: 0 0 8px 0; color: #5392FF;"},["小店GMV包含直播GMV和橱窗GMV"]),e("div",{class:"calendar-body"},[e("calendar-custom",{attrs:{config:this.config,fields:this.fields,restDates:this.dailydata.restDate,columsLabel:"指标"},scopedSlots:{rednerTotal:t=>e("div",[g.Thousands(l[t.field])]),render:(t,{field:n,edit:o,maxLength:s,limit:l,format:r=(e=>e)})=>{t.format("YYYY.MM.DD");const c=this.dailydata.find(t);let d=(u()().format("YYYY.MM.DD"),"calendar-day"),m=!1;if(u()().isBefore(t)&&(m=!0),2!==this.business_type&&3!==this.business_type||u()(this.$props.end_date).isBefore(t)&&(m=!0),m)return e("div",{class:`${d} empty`});if(!1===o&&(d=`${d} disable`),void 0!==c){const t=!!c[`edit_${n}`];return`${n}_${c.date}`!==this.active||t||(d=`${d} active`),e("div",{on:{click:()=>{this.active=`${n}_${c.date}`},dblclick:e=>{!1!==o&&((0,i.set)(c,`edit_${n}`,!0),this.$nextTick((()=>{e.target.querySelector("input")?.focus()})))}},class:d},[e("span",{class:"show-txt",directives:[{name:"show",value:!c[`edit_${n}`]}]},[r(g.Thousands(c[n]))]),e("el-input",{attrs:{maxLength:s,value:c[n]},on:{blur:()=>{this.active="",(0,i.set)(c,`edit_${n}`,!1),a.on.saveSubmit({...c,[n]:c[n]})},input:e=>{let t=e;l&&l.forEach((e=>{t=e(t)})),(0,i.set)(c,n,t)}},directives:[{name:"show",value:c[`edit_${n}`]}]})])}return e("div",{class:d},[e("span",{class:"show-txt"})])}}})]),e("market-dialog",o()([{},a]))])}}),b=x,w=a(1001),C=(0,w.Z)(b,y,h,!1,null,"34747270",null),k=C.exports},96732:function(e,t,a){a.d(t,{Z:function(){return f}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-common-business-market-form-dialog tg-dialog-vcenter"},[a("el-dialog",{staticClass:"tg-dialog-classic",attrs:{width:"440px",visible:e.visible,"close-on-click-modal":!1,"close-on-press-escape":!1,wrapperClosable:!1},on:{close:e.onCloseBtnClick},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(e._s(e.title))]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{attrs:{size:"small"},on:{click:e.onCloseBtnClick}},[e._v("取消")]),a("tg-button",{attrs:{size:"small",type:"primary"},on:{click:e.onSaveBtnClick}},[e._v("保存")])]},proxy:!0}])},[a("div",{staticClass:"dialog-content"},[a("el-form",{ref:"formRef",attrs:{model:e.marketForm,rules:e.rules,"label-position":"top",size:"small","label-width":"106px"}},[a("div",{staticClass:"line-box"},[a("el-form-item",{staticClass:"mgb-18",attrs:{label:"选择月份",prop:"month"}},[a("el-select",{model:{value:e.marketForm.month,callback:function(t){e.$set(e.marketForm,"month",t)},expression:"marketForm.month"}},e._l(e.months,(function(e,t){return a("el-option",{key:t,attrs:{label:e.label,value:e.value}})})),1)],1)],1),a("div",{staticClass:"line-box"},[a("el-form-item",{staticClass:"mgb-18",attrs:{label:"净销比例",prop:"net_sales_rate"}},[a("el-input",{attrs:{maxlength:"6",placeholder:""},on:{input:function(t){return e.inputAmount("net_sales_rate",t)}},model:{value:e.marketForm.net_sales_rate,callback:function(t){e.$set(e.marketForm,"net_sales_rate","string"===typeof t?t.trim():t)},expression:"marketForm.net_sales_rate"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("%")])])],1)],1)]),a("div",{staticClass:"tips"},[e._v(" 注意：预设的净销比例将作为默认数据自动填写到指定月份的日报中， 如果预设值不符合实际情况可以在日报中直接修改。 ")])],1)])],1)},o=[],i=a(97434),s=a(53451),l=a.n(s),r=a(6933),c=a.n(r),u=a(88721);const{debounce:d}=l();var m=(0,i.defineComponent)({props:{visible:{type:Boolean,default:!1},title:{type:String,default:"日报详情"},data:{type:Object}},setup(e,t){const a=(0,i.ref)(null),n=(0,i.ref)({month:"",net_sales_rate:""}),o=(0,i.ref)([]),s={month:[{required:!0,message:"请选择月份"}],net_sales_rate:[{required:!0,message:"请填写净销比例"}]},l=c()();l.add(-1,"M"),o.value.push({label:l.format("YYYY年MM月"),value:l.format("YYYYMM")}),l.add(1,"M"),o.value.push({label:l.format("YYYY年MM月"),value:l.format("YYYYMM")}),l.add(1,"M"),o.value.push({label:l.format("YYYY年MM月"),value:l.format("YYYYMM")});const r=()=>{t.emit("dialog:close"),t.root.$nextTick(m)},m=()=>{n.value.month="",n.value.net_sales_rate=""},p=()=>{a.value?.validate((e=>{if(!e)return!1;{const e={...n.value};t.emit("saveCommissinRate",e)}}))},_=(e,t)=>{n.value[e]=u.Z.NumberRange(0,100)(t)},v=d(p,200);return{months:o,onCloseBtnClick:r,onSaveBtnClick:v,marketForm:n,formRef:a,inputAmount:_,rules:s}}}),p=m,_=a(1001),v=(0,_.Z)(p,n,o,!1,null,null,null),f=v.exports},91354:function(e,t,a){a.d(t,{Z:function(){return W}});a(26699);var n=a(36568),o=a.n(n),i=a(97434),s=a(98560),l=a(91538),r=a(32039),c=a(22910),u=a(69540),d=a(79058),m=a(63787),p=a(46673),_=a(66626),v=a(65475),f=a(35750),g=a(44928),y=a(93889),h=a(49998),x=a(17099),b=a(17890),w=a(65122),C=a(62083),k=a(21757),S=a(1763),D=a(78902),j=a(58302),F=a(61282),$=a(67910),A=a(43773),T=a(7185),N=a(37315),L=a(47143),I=a(89852);const M=e=>{const t=e?.split("+")??[],a=t.filter((e=>{if(e.indexOf("%(主播)")>=0){const t=+e.split("%(")[0];return t>0}return!0})).join("+");return a.replace(/\+$|^\+/g,"")},R=e=>e.split("/").pop(),Y=e=>void 0===e?[]:[...e.contract_detail.attachment_url_list.map((t=>({...t,status:e.contract_info.contract_status,status_str:e.contract_info.contract_status_str,type:"合同附件"}))),...e.contract_annex_info.map((e=>e.attachment_url_list.map((t=>({file_name:R(t),url:t,status:e.contract_annex_status,status_str:e.contract_annex_status_str,type:"补充协议"}))))).flat(),...e.contract_detail.contract_scan_urls.map((t=>({...t,status:e.contract_info.contract_status,status_str:e.contract_info.contract_status_str,type:"合同扫描件"}))),...e.contract_statements_list.map((e=>e.attachment_url_list.map((t=>({file_name:R(t),url:t,status:e.contract_statements_status,status_str:e.contract_statements_status_str,type:"结算单"}))))).flat()];var Z,O,P=(0,i.defineComponent)({components:{AddAttachmentDialog:m.Z,AddAttachmentDialogSupplier:p.Z,AddSettlementDialog:v.Z,AddStatement:_.Z,achievement:s.Z,invoicelist:l.Z,dialogContact:r.Z,addContract:c.Z,addSupplierContract:u.Z,AnnexDialog:h.Z,templateDownContractDialog:d.Z,supplierAgreementDialog:N.Z,clientAgreementDialog:L.Z},setup(e,t){const a=(0,i.computed)((()=>{const e=(0,k.kG)(D.HN.marketing_project_contract_view),t=(0,k.kG)(D.HN.marketing_project_documentary_create),a=(0,k.kG)(D.HN.marketing_project_contract_annex_create),n=(0,k.kG)(D.HN.marketing_project_contract_statement_create),o=(0,k.kG)(D.HN.live_project_contract_view),i=(0,k.kG)(D.HN.live_project_contract_create),s=(0,k.kG)(D.HN.live_project_annex_create),l=(0,k.kG)(D.HN.live_project_statements_create),r=(0,k.kG)(D.HN.common_business_project_contract_view),c=(0,k.kG)(D.HN.common_business_project_contract_create),u=(0,k.kG)(D.HN.common_business_project_contract_annex_create),d=(0,k.kG)(D.HN.common_business_project_contract_statement_create);return{canViewList:e,canCreateContract:t,canCreateAnnex:a,canCreateStatement:n,canLiveViewList:o,canLiveCreateContract:i,canLiveCreateAnnex:s,canLiveCreateStatement:l,canCommonViewList:r,canCommonCreateContract:c,canCommonCreateAnnex:u,canCommonCreateStatement:d}})),{isFromMarketing:n,isFromLive:o,isFromCommon:s}=(0,I.L)(t),l=(0,i.computed)((()=>n.value?a.value.canViewList:o.value?a.value.canLiveViewList:a.value.canCommonViewList)),r=(0,i.computed)((()=>n.value?a.value.canCreateContract:o.value?a.value.canLiveCreateContract:a.value.canCommonCreateContract)),c=(0,i.computed)((()=>n.value?a.value.canCreateAnnex:o.value?a.value.canLiveCreateAnnex:a.value.canCommonCreateAnnex)),u=(0,i.computed)((()=>n.value?a.value.canCreateStatement:o.value?a.value.canLiveCreateStatement:a.value.canCommonCreateStatement)),d=(0,i.ref)(!1),m=(0,i.ref)(!1),p=(0,i.ref)(null),_=(0,i.ref)(null),v=(0,i.ref)(null),h=(0,i.ref)(null),S=(0,i.ref)(null),N=(0,i.ref)(null),L=(0,i.ref)(!1),R=(0,i.ref)(null),Z=(0,i.ref)(null),O=(0,i.ref)(null),P=(0,k.gI)(),q=(0,i.computed)((()=>n.value?"1":o.value?"2":"3")),z=f.Z.useContract(q.value),B=(0,g.t)(),W=(0,i.ref)(!1),E=(0,i.ref)(void 0),H=(0,i.computed)((()=>Y(E.value)));(0,i.provide)("annex-data",H),(0,i.provide)("annex-dialog-visible",W),(0,i.provide)("project_add_id",B.currentRoute.params.id),(0,i.provide)("contract",(0,i.ref)(void 0));const G=(0,i.reactive)((0,C.q)()),J=(0,i.computed)((()=>n.value?{cooperation_id:B.currentRoute.params.id}:(o.value,{project_id:B.currentRoute.params.id})));z.query(J.value);const V=32,U=0,X=0,Q=31,K=(0,i.ref)(251),ee=(0,j.Z)({compensation:(0,i.computed)((()=>V+U+X+Q)),fixedBlockHeightRefs:[K],tableMinHeight:100}),te=(e,t)=>{const a=e.contract_info.company_name||e.contract_info.customer_name||"--",{is_folded:n,folded_text:o}=(0,F.zb)(a,12);return t||!n?o:(0,i.h)("el-popover",{props:{placement:"right",trigger:"hover",content:a}},[(0,i.h)("div",{slot:"reference"},[o])])},ae=(0,$.zY)(z.data,"公司名称",te),ne=(0,i.computed)((()=>[{label:"合同类别",align:"center",minWidth:94,formatter:e=>1===e.contract_info.contract_type||2===e.contract_info.contract_type||5===e.contract_info.contract_type?"客户合同":"供应商合同"},{label:"签约类型",minWidth:94,align:"center",formatter:e=>y.kV.get(e?.contract_info?.sign_type)||"--"},{label:"合同编号",minWidth:190,formatter:e=>{const{contract_info:{contract_uid:t}}=e,a=(0,i.h)("div",{},[(0,i.h)("span",{class:"hover-link"},[t])]);return a}},{label:"公司名称",minWidth:ae.value,formatter:e=>te(e,!1)},{label:"费用类型",width:130,align:"center",formatter:e=>e.getMoneytype??(0,x.l)()},{label:"合同金额",align:"left",minWidth:200,formatter:e=>{const t=[];return e.contractMoney&&t.push((0,i.h)("div",[(0,i.h)("span",{style:{color:"#a4b2c2"}},[e.contractCommission?"服务费：":"固定服务费："]),(0,i.h)("span",{style:{color:"#19232D"}},[e.contractMoney??"--"])])),e.contractCommission&&t.push((0,i.h)("div",[(0,i.h)("span",{style:{color:"#a4b2c2"}},["佣金："]),(0,i.h)("span",{style:{color:"#19232D"}},[M(e.contractCommission)||"--"])])),e.contractOtherMoney&&t.push((0,i.h)("div",[(0,i.h)("span",{style:{color:"#19232D"}},[e.contractOtherMoney??"--"])])),t.length>0?t:"--"}},{label:"合作期限",minWidth:166,align:"center",formatter:({contract_info:{coop_start_date:e,coop_end_date:t}})=>{null!==e&&null===t&&(t="长期有效");const a=[e,t],n=a.filter((e=>null!==e)).join("～").replace(/-/g,".")||(0,x.l)();return n}},{label:"关联合同数",minWidth:100,align:"center",formatter:e=>{const t=e.associate_contract_count??(0,x.l)(),a=[];let n;return n=(0,i.h)("p",{class:"hover-link empty-data-line"},[t]),a.push((0,i.h)("div",{class:"line-info",on:{click:t=>{if(e.associate_contracts&&e.associate_contracts.length>0){const t=e.associate_contracts.join("|"),a={contract_uid:t};z.query(a)}t.stopPropagation()}}},[n])),a}},{label:"创建人/日期",minWidth:118,formatter:e=>[(0,i.h)("div",{style:{paddingLeft:"15px"}},[e.contract_info.add_by_name]),(0,i.h)("div",{style:{paddingLeft:"15px",color:"#a4b2c2"}},[e.contract_info.create_time_str?.split(" ")?.[0].replace(/-/g,".")??(0,x.l)()])]},{label:"合同状态",align:"center",minWidth:90,formatter:e=>{const t=e.contract_info.contract_status===b.Kb.Normal?1===e.contract_info.is_recycled?(0,i.h)("div",{style:{marginTop:"2px"}},[(0,i.h)("span",{class:["contract-recycled-tag","contract-recycled-tag-yes"]},["已收回"])]):(0,i.h)("div",{style:{marginTop:"2px"}},[(0,i.h)("span",{class:["contract-recycled-tag","contract-recycled-tag-no"]},["未收回"])]):"",a=b.yR.get(e.contract_info.contract_status)||(0,x.l)(),n=(t=!1)=>(0,i.h)("span",{class:`fg-${b.Kb[e.contract_info.contract_status]}`.toLowerCase(),...t?{slot:"reference"}:{}},[a]);if(![b.Kb.Failure,b.Kb.Processing].includes(e.contract_info.contract_status))return(0,i.h)("div",[n(!1)," ",t]);if(e.contract_info.feishu_request_id||e.contract_info.oa_request_id)return(0,i.h)("div",{on:{click:e=>{e.stopPropagation()}}},[(0,i.h)("el-popover",{props:{placement:"left-end",width:234,trigger:"hover",popperClass:"oa-approve-progress-popper",popperOptions:{boundariesElement:"body",gpuAcceleration:!1}},on:{show:()=>{G.onFlowsShow(e.contract_info.id)},hide:()=>{G.onFlowsHide()}}},[n(!0),(0,i.h)("div",{style:{"min-height":"160px"}},[...G.flowsLoading?[(0,i.h)("div",{style:{padding:"10px 20px"}},["正在查询进度..."])]:""!==G.flowsError?[G.flowsError]:[G.oaflowsRender(e.contract_info.contract_status)]])])]);const o=e.contract_work_infos.length>0&&[b.Kb.Processing,b.Kb.Failure].includes(e.contract_info.contract_status);return(0,i.h)("div",o?[(0,i.h)("el-popover",{props:{placement:"left-end",width:"246",trigger:"hover",popperClass:"approve-progress-popper"}},[n(!0),(0,i.h)(w.Z,{props:{workInfos:e.contract_work_infos,contractInfo:e}})])]:[n()])}},{label:"合同附件",minWidth:88,align:"center",formatter:e=>Y(e).length>0?(0,i.h)("span",{style:{color:"rgb(40, 119, 255)"},on:{click:t=>{t.stopPropagation(),E.value=e,W.value=!0}}},["查看"]):(0,x.l)()}])),oe=(0,A.R)({component:T.Z,title:"新增合同",width:"460px",footer:!1,on:{close:e=>{if(void 0!==e)switch(e){case 1:h.value?.show();break;case 2:v.value?.show();break}}}});return{canViewList:l,canCreateContract:r,canCreateAnnex:c,canCreateStatement:u,isFromMarketing:n,isFromLive:o,isFromCommon:s,dialogContactHook:oe,Permission:a,permission:P,router:B,addSettlementDialog:Z,addAttachmentDialog:O,AddStatementVisible:L,addAttachmentDialogRef:R,checkedRow:E,...z,visibleAchievement:d,visibleInvoiceList:m,addCustomerContractRef:S,addSupplierContractRef:N,addContractRef:p,addTemplateContractRef:_,addsupplierTemplateContractRef:v,addclientTemplateContractRef:h,annexDialogVisible:W,oaFlows:G,...ee,columns:ne}},render(){const e=arguments[0],t={style:{width:"100%",marginTop:"12px"}};return e("tg-card",o()([{class:"project-collection flex-auto tg-marketing-contract",attrs:{loading:this.loading}},{directives:[{name:"loading",value:this.loading}]}]),[this.canCreateContract||this.canCreateStatement||this.canCreateAnnex?e("div",{class:"btns-line"},[this.canCreateContract?e("tg-button",{attrs:{type:"primary",icon:"ico-btn-add"},on:{click:()=>{this.addContractRef?.show({title:"新增合同协议",items:[{name:"客户合同",id:1},{name:"供应商合同",id:2}]})}}},["新增合同协议"]):"",this.canCreateStatement&&this.isFromMarketing?e("tg-button",{attrs:{icon:"ico-btn-add"},on:{click:()=>{this.addContractRef?.show({title:"新增结算单",items:[{name:"客户结算单",id:3},{name:"供应商结算单",id:4}]})}}},["新增结算单"]):"",this.canCreateContract?e("tg-button",{on:{click:()=>{this.addTemplateContractRef?.show({title:"新增补充协议",items:[{name:"客户补充协议",id:5},{name:"供应商补充协议",id:6}]})}}},["合同模板下载"]):""]):"",this.canViewList?e("el-table",o()([{attrs:{stripe:!0,border:!0,height:"calc(100% - 70px - 6px)"}},t,{attrs:{data:this.data,"cell-style":{cursor:"pointer"}},on:{"row-click":e=>{if(1===e.contract_info.contract_type||2===e.contract_info.contract_type||5===e.contract_info.contract_type){const t=this.isFromMarketing?S.Z8.contract.customer.detailTemplate:this.isFromLive?S.FB.contract.customer.detailTemplate:S.u3.contract.customer.detailTemplate,a=this.isFromMarketing?S.Z8.contract.customer.detail:this.isFromLive?S.FB.contract.customer.detail:S.u3.contract.customer.detail;this.router.push({name:e.template_info?t:a,params:{id:`${e.contract_info.id}`},query:{parent_id:this.router?.currentRoute.params.id,parent_tab:this.router?.currentRoute.params.tab}})}else if(3===e.contract_info.contract_type||4===e.contract_info.contract_type||6===e.contract_info.contract_type){const t=this.isFromMarketing?S.Z8.contract.supplier.detailTemplate:this.isFromLive?S.FB.contract.supplier.detailTemplate:S.u3.contract.supplier.detailTemplate,a=this.isFromMarketing?S.Z8.contract.supplier.detail:this.isFromLive?S.FB.contract.supplier.detail:S.u3.contract.supplier.detail;this.router.push({name:e.template_info?t:a,params:{id:`${e.contract_info.id}`},query:{contract_type:e.contract_info.contract_type,parent_id:this.router?.currentRoute.params.id,parent_tab:this.router?.currentRoute.params.tab}})}else{const t=this.isFromMarketing?S.Z8.contract.anchor.detailTemplate:this.isFromLive?S.FB.contract.anchor.detailTemplate:S.u3.contract.anchor.detailTemplate;this.router.push({name:t,params:{id:`${e.contract_info.id}`},query:{contract_type:e.contract_info.contract_type,parent_id:this.router?.currentRoute.params.id,parent_tab:this.router?.currentRoute.params.tab}})}}},scopedSlots:{empty:()=>e("div",{class:"tg-page-empty"},[e("empty-common",{attrs:{"detial-text":"暂未添加合同协议"}})])}}]),[this.columns.map(((t,a)=>e("el-table-column",o()([{},{props:{...t}},{key:a}]))))]):"",e(s.Z,{attrs:{visible:this.visibleAchievement},on:{close:()=>{this.visibleAchievement=!1}}}),e(l.Z,{attrs:{visible:this.visibleInvoiceList},on:{close:()=>{this.visibleInvoiceList=!1},added:()=>{}}}),e(r.Z,{ref:"addContractRef",on:{close:e=>{if(void 0!==e)switch(e.id){case 1:this.addclientTemplateContractRef?.show();break;case 2:this.addsupplierTemplateContractRef?.show();break;case 3:this.AddStatementVisible=!0;break;case 4:this.addSettlementDialog?.show();break;case 5:this.addAttachmentDialogRef?.show();break;case 6:this.addAttachmentDialog?.show();break}}}}),e(c.Z,{ref:"addCustomerContractRef",on:{added:()=>this.reload()}}),e(u.Z,{ref:"addSupplierContractRef",on:{added:()=>this.reload()}}),e("annexDialog",o()([{},{on:{"dialog:close":()=>this.annexDialogVisible=!1}}])),e("addStatement",o()([{attrs:{visible:this.AddStatementVisible}},{on:{"dialog:close":()=>{this.reload(),this.AddStatementVisible=!1}}}])),e("addAttachmentDialog",{ref:"addAttachmentDialogRef",on:{added:()=>this.reload()},attrs:{editData:{}}}),e("addAttachmentDialogSupplier",{ref:"addAttachmentDialog",on:{added:()=>this.reload()}}),e("addSettlementDialog",{ref:"addSettlementDialog",on:{added:()=>this.reload()},attrs:{editData:{}}}),e(d.Z,{attrs:{type:"marketing"},ref:"addTemplateContractRef"}),e(N.Z,{ref:"addsupplierTemplateContractRef",on:{added:()=>this.reload()}}),e(L.Z,{ref:"addclientTemplateContractRef",on:{added:()=>this.reload()}})])}}),q=P,z=a(1001),B=(0,z.Z)(q,Z,O,!1,null,"f40f7782",null),W=B.exports},70727:function(e,t,a){a.d(t,{Z:function(){return g}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-live-project-dialog-pay-refund"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter-new",attrs:{visible:e.visible,width:"628px","close-on-click-modal":!1},on:{close:e.handleCloseAction},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(e._s("付款退款"))]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{on:{click:e.handleCloseAction}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.handleSaveAction}},[e._v("保存")])]},proxy:!0}])},[a("div",{staticStyle:{height:"462px",overflow:"overlay"}},[a("el-form",{ref:"formRef",attrs:{rules:e.rules,model:e.dataForm,"label-width":"82px",size:"small","label-position":"left"}},[a("div",{staticClass:"form-row-two-column"},[a("el-form-item",{attrs:{label:"退款金额：",prop:"refund_amount"}},[a("el-input",{attrs:{clearable:"",placeholder:"请输入退款金额",value:e.dataForm.refund_amount},on:{input:e.refundAmountChange}})],1),a("el-form-item",{attrs:{label:"收款日期：",prop:"gather_date"}},[a("el-date-picker",{attrs:{format:"yyyy.MM.dd","value-format":"yyyy-MM-dd",editable:!1,type:"date",placeholder:"请选择退款日期"},model:{value:e.dataForm.gather_date,callback:function(t){e.$set(e.dataForm,"gather_date",t)},expression:"dataForm.gather_date"}})],1)],1),a("div",{staticClass:"row-pay mgt-24"},[a("el-form-item",{attrs:{label:"退款方式：",prop:"gather_way"}},[a("el-radio-group",{on:{change:e.gatherWayChange},model:{value:e.dataForm.gather_way,callback:function(t){e.$set(e.dataForm,"gather_way",t)},expression:"dataForm.gather_way"}},[a("el-radio",{attrs:{label:3}},[e._v("对公银行")]),a("el-radio",{attrs:{label:2}},[e._v("对公支付宝")])],1)],1)],1),a("div",{staticClass:"row-way-detail"},[3===e.dataForm.gather_way?a("div",{staticClass:"form-row-two-column"},[a("el-form-item",{attrs:{label:"银行卡号：",prop:"bank_card_number"}},[a("el-input",{attrs:{clearable:"",placeholder:"请输入银行卡号"},model:{value:e.dataForm.bank_card_number,callback:function(t){e.$set(e.dataForm,"bank_card_number",t)},expression:"dataForm.bank_card_number"}})],1),a("el-form-item",{attrs:{label:"公司名称：",prop:"company_name"}},[a("el-input",{attrs:{clearable:"",placeholder:"请输入公司名称"},model:{value:e.dataForm.company_name,callback:function(t){e.$set(e.dataForm,"company_name",t)},expression:"dataForm.company_name"}})],1),a("el-form-item",{attrs:{label:"开户行：",prop:"bank_of_deposit"}},[a("el-input",{attrs:{clearable:"",placeholder:"请输入开户行"},model:{value:e.dataForm.bank_of_deposit,callback:function(t){e.$set(e.dataForm,"bank_of_deposit",t)},expression:"dataForm.bank_of_deposit"}})],1)],1):e._e(),2===e.dataForm.gather_way?a("div",{staticClass:"form-row-two-column"},[a("el-form-item",{attrs:{label:"付款人：",prop:"name"}},[a("el-input",{attrs:{clearable:"",placeholder:"请输入付款人姓名"},model:{value:e.dataForm.name,callback:function(t){e.$set(e.dataForm,"name",t)},expression:"dataForm.name"}})],1),a("el-form-item",{attrs:{label:"支付宝账号：","label-width":"100px",prop:"account"}},[a("el-input",{attrs:{clearable:"",placeholder:"请输入支付宝账号"},model:{value:e.dataForm.account,callback:function(t){e.$set(e.dataForm,"account",t)},expression:"dataForm.account"}})],1)],1):e._e()]),a("div",{staticClass:"mgt-24"},[a("el-form-item",{attrs:{label:"退款原因：",prop:"refund_reason"}},[a("el-input",{attrs:{type:"textarea",maxlength:100,"show-word-limit":!0,placeholder:"请填写退款原因"},model:{value:e.dataForm.refund_reason,callback:function(t){e.$set(e.dataForm,"refund_reason",t)},expression:"dataForm.refund_reason"}})],1)],1),a("div",{staticClass:"mgt-24"},[a("el-form-item",{staticClass:"upload-certificate",attrs:{label:"上传凭证：",prop:"certificate_file"}},[a("div",[a("div",{staticStyle:{height:"32px"}},[a("el-upload",{attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler,accept:".jpg,.jpeg,.png",disabled:e.dataForm.certificate_file.length>=1},model:{value:e.dataForm.certificate_file,callback:function(t){e.$set(e.dataForm,"certificate_file",t)},expression:"dataForm.certificate_file"}},[a("tg-button",{staticClass:"upload-btn",attrs:{icon:"ico-btn-upload",disabled:e.dataForm.certificate_file.length>=1}},[e._v("上传文件")])],1)],1),a("div",{staticStyle:{height:"16px","line-height":"16px","font-size":"12px","margin-left":"6px",color:"#a4b2c2","margin-top":"6px"}},[e._v(" 支持扩展名：JPG，JPGE，PNG，最多上传一个文件 ")])]),e.dataForm.certificate_file.length?a("div",{staticClass:"fileList"},[a("div",{staticStyle:{height:"20px","line-height":"20px","margin-top":"12px"}},[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{display:"inline-flex"}},[a("tg-button",{staticClass:"uploaded-file-btn",attrs:{type:"link"}},[a("tg-icon",{staticClass:"uploaded-file-btn-icon",attrs:{name:e.getFileIcon(e.dataForm.certificate_file)}}),a("span",{staticClass:"line-clamp-1",staticStyle:{"max-width":"300px"}},[e._v(e._s(decodeURI(e.getFileName(e.dataForm.certificate_file))))])],1),a("tg-button",{staticClass:"mgl-12 uploaded-file-del",attrs:{type:"link"},on:{click:function(t){return e.handleRemoveFileClick()}}},[a("tg-icon",{staticStyle:{width:"16px",height:"16px"},attrs:{name:"ico-frm-delete",hoverName:"ico-frm-delete-active"}})],1)],1)])]):e._e()])],1)])],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在保存，请稍候..."}})],1)},o=[],i=(a(21703),a(41572)),s=a(88355),l=a(3293),r=a(97434),c=a(85937),u=a.n(c);const d=new Map([["image/jpeg","picture"],["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","excel"],["application/vnd.openxmlformats-officedocument.wordprocessingml.document","word"],["application/msword","word"],["application/pdf","pdf"],["xlsx","excel"],["docx","word"],["doc","word"],["pdf","pdf"],["jpeg","picture"]]),m=()=>({refund_amount:void 0,gather_date:"",gather_way:3,bank_card_number:"",bank_of_deposit:"",company_name:"",name:"",account:"",refund_reason:"",certificate_file:""});var p=(0,r.defineComponent)({name:"PayRefund",props:{visible:{type:Boolean},costId:{type:Number},rawAmount:{type:Number,default:0}},setup(e,t){const a=(0,r.ref)(m()),n=(0,r.ref)(void 0),o=(0,r.ref)(!1),c=(0,r.computed)((()=>{const e={refund_amount:[{required:!0,message:"请输入退款金额",trigger:["blur","change"]},{required:!0,validator:p.amountValidator,trigger:["blur","change"]}],gather_date:[{required:!0,message:"请选择收款日期",trigger:"change"}],gather_way:[{required:!0,message:"",trigger:"change"}],refund_reason:[{required:!0,message:"请填写退款原因",trigger:"blur"}],certificate_file:[{required:!0,message:"请上传凭证",trigger:"change"}],name:[{required:!0,message:"请输入收款人姓名",trigger:"blur"}],account:[{required:!0,message:"请输入支付宝账号",trigger:"blur"}],bank_card_number:[{required:!0,message:"请输入银行卡号",trigger:"blur"}],bank_of_deposit:[{required:!0,message:"请输入开户行",trigger:"blur"}],company_name:[{required:!0,message:"请输入公司名称",trigger:"blur"}]};return e})),p={handleCloseAction:()=>{t.emit("cancel"),t.emit("update:visible",!1)},handleSaveAction:()=>{n.value?.validate((e=>{e&&p.createPayRefundRequest()}))},uploadFileHandler:async e=>{const o=e.file;if(o.size>5242880)return void t.root.$message.error("上传文件大小不能超过 5MB!");const i=new FormData,l=e.file.name;i.append("file",e.file,l),i.append("type","certificate/achievement_gather_certificate");const r=await(0,s.e)(i);r.data.success?(t.root.$message.success("上传成功"),a.value.certificate_file=r.data.data.source,n.value?.clearValidate("certificate_file")):t.root.$message.error(r.data.message??"上传失败，稍后重试")},getFileName:e=>{if(e&&e.length){const t=e.split("/");return t[t.length-1]??"--"}return"--"},getPositivePriceNumber:(e,t=8)=>{const a=new RegExp(`(?:0|[1-9]\\d{0,${t-1}})(?:\\.\\d{0,2})?`,"u"),n=(a.exec(e.replace(/[^.\d]+/gu,"").replace(i.Pj,""))??[""])[0];return n},refundAmountChange:e=>{const t=p.getPositivePriceNumber(e);a.value.refund_amount=t},getFileIcon:e=>{const t=e.split("."),a=t[t.length-1],n=d.get(a)??"picture";return`ico-${n}`},gatherWayChange:e=>{2===e?n.value?.clearValidate(["name","account"]):3===e&&n.value?.clearValidate(["bank_card_number","bank_of_deposit","company_name"])},handleRemoveFileClick:()=>{a.value.certificate_file=""},amountValidator:(t,a,n)=>{""===a||void 0===a?n(new Error("请输入退款金额")):new(u())(a||0).lessThanOrEqualTo(new(u())(e.rawAmount))?n():n(new Error("不可以超过原付款金额-已退款金额"))},createPayRefundRequest:async()=>{const n={raw_cost_id:e.costId,...a.value};o.value=!0;const i=await(0,l.z5)(n);o.value=!1,i.data.success?(t.emit("save"),t.root.$message.success(i.data.message??"保存成功"),i.data?.data.write_off_result||t.root.$alert("因该退款对应多张结算单，系统无法自动进行拆分，若原结算单因该退款无法最终完成全部核销，请冲销原结算单，并建立新结算单与原收款和该退款进行手动核销。")):t.root.$message.error(i.data.message??"保存失败")}};return(0,r.watch)((()=>e.visible),(e=>{e||(a.value=m(),setTimeout((()=>{n.value?.clearValidate()}),300))})),{saveLoading:o,dataForm:a,...p,rules:c,formRef:n}}}),_=p,v=a(1001),f=(0,v.Z)(_,n,o,!1,null,null,null),g=f.exports},79546:function(e,t,a){a.d(t,{Z:function(){return f}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-live-project-dialog-collection-refund-write-off"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter-new",attrs:{visible:e.visible,width:"920px",top:"278px","close-on-click-modal":!1},on:{close:e.handleCloseAction},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(e._s("pay"===e.type?"付款退款核销":"收款退款核销"))]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button",{on:{click:e.handleCloseAction}},[e._v("取消")]),a("tg-button",{attrs:{disabled:e.saveDisabled,type:"primary"},on:{click:e.handleSaveAction}},[e._v("保存")])]},proxy:!0}])},[a("div",{staticStyle:{height:"570px"}},[a("div",{staticClass:"write-off-amount"},[a("span",[e._v(e._s("退款可核销金额："))]),a("span",[e._v(e._s(e.formatAmount(e.notWriteOffAmount)))])]),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.listLoading,expression:"listLoading"}],attrs:{height:510,stripe:"",data:e.data},on:{"selection-change":e.handleSelectionChange},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无项目"}})]},proxy:!0}])},[e._l(e.columns,(function(t,n){return a("el-table-column",e._b({key:n},"el-table-column",t,!1))})),a("el-table-column",{attrs:{label:"本次核销金额",align:"right",width:178},scopedSlots:e._u([{key:"default",fn:function(t){return[a("div",[a("el-input",{attrs:{value:t.row.type_in_write_off_amount,size:"small",disabled:e.typeInInputDisabled(t.row)},on:{input:function(a){return e.typeInAmountChanged(a,t.$index)}}},[a("span",{attrs:{slot:"prefix"},slot:"prefix"},[e._v("￥")])])],1)]}}])})],2)],1)]),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在保存，请稍候..."}})],1)},o=[],i=a(97434),s=a(61282),l=a(29625),r=a(3293),c=a(41572),u=a(85937),d=a.n(u),m=(0,i.defineComponent)({name:"RefundWriteOff",props:{visible:{type:Boolean,default:!1},invoiceId:{type:String},costId:{type:Number},costSplitId:{type:Number},type:{type:String,default:"receive"},projectType:{type:Number,default:l.kA.live},notWriteOffAmount:{type:Number},refund_cost_id:{type:String},achievement_id:{type:Number}},setup(e,t){const a=(0,i.computed)((()=>e.invoiceId??"")),n=(0,i.computed)((()=>e.projectType)),o=(0,i.ref)(!1),l=(0,i.ref)(!1),u=(0,i.ref)([]),m=(0,i.ref)([]),p=(0,i.computed)((()=>!u.value.length)),_=(0,i.computed)((()=>[{type:"selection",width:40},{label:"pay"===e.type?"应付编号":"应收编号",width:174,property:"receivable_uid",formatter:e=>e.receivable_uid},{label:"pay"===e.type?"原付款编号":"原收款编号",width:188,property:"receipt_uid",formatter:e=>e.receipt_uid},{label:"原单核销金额",width:152,align:"right",property:"write_off_amount",formatter:e=>(0,s.dN)(e.write_off_amount)},{label:"退款已核销金额",width:140,align:"right",property:"refund_write_off_amount",formatter:e=>(0,s.dN)(e.refund_write_off_amount)}])),v={handleCloseAction:()=>{t.emit("cancel"),t.emit("update:visible",!1)},handleSaveAction:()=>{const a=u.value.reduce(((e,t)=>new(d())(t.type_in_write_off_amount?t.type_in_write_off_amount:0).add(e)),new(d())(0));if(!a.lessThanOrEqualTo(new(d())(e.notWriteOffAmount??0)))return void t.root.$message.warning("所有记录的核销金额总和不能大于退款可核销金额");const n=u.value.find((e=>!e.type_in_write_off_amount||""===e.type_in_write_off_amount||0===Number(e.type_in_write_off_amount)));n?t.root.$message.warning("核销金额不能为0"):"pay"===e.type?v.savePayRefundWriteOffRequest():v.saveReceiveRefundWriteOffRequest()},formatAmount:s.dN,handleSelectionChange:e=>{u.value=e},typeInInputDisabled:e=>-1===u.value.indexOf(e),getPositivePriceNumber:(e,t=8)=>{const a=new RegExp(`(?:0|[1-9]\\d{0,${t-1}})(?:\\.\\d{0,2})?`,"u"),n=(a.exec(e.replace(/[^.\d]+/gu,"").replace(c.Pj,""))??[""])[0];return n},typeInAmountChanged:(e,t)=>{const a=m.value[t],n=a.write_off_amount?a.write_off_amount:0,o=a.refund_write_off_amount?a.refund_write_off_amount:0,i=new(d())(n).sub(new(d())(o)),s=v.getPositivePriceNumber(e);new(d())(s||0).lessThanOrEqualTo(i)&&(a.type_in_write_off_amount=s)},getReceivablesRefundForWriteOffList:async()=>{o.value=!0;const e=await(0,r.rX)(a.value,n.value);o.value=!1,e.data.success?m.value=e.data.data.map((e=>({...e,type_in_write_off_amount:void 0}))):m.value=[]},getPayRefundForWriteOffList:async()=>{o.value=!0;const t=await(0,r.$4)(e.refund_cost_id??"");o.value=!1,t.data.success?m.value=t.data.data.map((e=>({id:e.id,receipt_uid:e.cost_uid,receivable_uid:e.payable_uid,write_off_amount:e.write_off_amount,refund_write_off_amount:e.refund_write_off_amount,type_in_write_off_amount:void 0}))):m.value=[]},savePayRefundWriteOffRequest:async()=>{const a={achievement_id:e.achievement_id,write_off_list:u.value.map((e=>({pay_write_off_id:e.id,write_off_amount:e.type_in_write_off_amount??""})))};l.value=!0;const n=await(0,r.oj)(a);l.value=!1,n.data.success?(t.emit("save"),t.root.$message.success(n.data.message??"保存成功")):t.root.$message.error(n.data.message??"保存失败")},saveReceiveRefundWriteOffRequest:async()=>{const n={achievement_uid:a.value,cost_id:void 0,cost_split_id:void 0,write_off_list:u.value.map((e=>({id:e.id,write_off_amount:e.type_in_write_off_amount??""})))};e.costId?n["cost_id"]=e.costId:e.costSplitId&&(n["cost_split_id"]=e.costSplitId),l.value=!0;const o=await(0,r.Iu)(n);l.value=!1,o.data.success?(t.emit("save"),t.root.$message.success(o.data.message??"保存成功")):t.root.$message.error(o.data.message??"保存失败")}};return(0,i.watch)([()=>e.invoiceId,()=>e.type,()=>e.projectType,()=>e.visible,()=>e.refund_cost_id,()=>e.costSplitId],(([e,t,a,n,o])=>{e||o?"receive"===t?v.getReceivablesRefundForWriteOffList():"pay"===t&&v.getPayRefundForWriteOffList():m.value=[],n||(u.value=[],m.value=[])})),{data:m,saveLoading:l,listLoading:o,columns:_,...v,selectedList:u,saveDisabled:p}}}),p=m,_=a(1001),v=(0,_.Z)(p,n,o,!1,null,null,null),f=v.exports},72713:function(e,t,a){a.d(t,{Z:function(){return m}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-project-dialog-roll-back"},[a("el-dialog",{staticClass:"customer-dialog tg-dialog-vcenter-new",attrs:{title:"项目变更",visible:e.visible,width:"428px","close-on-click-modal":!1},on:{close:e.handleCloseAction},scopedSlots:e._u([{key:"footer",fn:function(){return[a("tg-button",{on:{click:e.handleCloseAction}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.handleSaveAction}},[e._v("确定")])]},proxy:!0}])},[a("el-form",{ref:"formRef",staticClass:"roll-back-form",attrs:{rules:e.rules,size:"small",model:e.formData,"label-width":"112px"}},[a("el-form-item",{attrs:{label:"变更项目状态为：",prop:"status"}},[a("el-select",{staticStyle:{width:"270px"},attrs:{placeholder:"请选择项目状态"},model:{value:e.formData.status,callback:function(t){e.$set(e.formData,"status",t)},expression:"formData.status"}},e._l(e.projectStatusOptions,(function(e){return a("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})})),1)],1)],1)],1),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"  正在保存，请稍候..."}})],1)},o=[],i=a(3293),s=a(29625),l=a(97434),r=(0,l.defineComponent)({props:{visible:{type:Boolean},projectInfo:{type:Object}},setup(e,t){const a=(0,l.ref)({status:void 0}),n=(0,l.ref)(void 0),o=(0,l.ref)({status:[{required:!0,message:"请选择项目状态",trigger:"change"}]}),r=(0,l.ref)(!1),c={handleCloseAction:()=>{t.emit("update:visible",!1)},handleSaveAction:async()=>{const o=async()=>{r.value=!0;const n=await(0,i.Cv)({id:e.projectInfo?.projectId,status:a.value.status,project_type:e.projectInfo?.projectType});r.value=!1,n.data.success?(t.root.$message.success(n.data.message),t.emit("save")):t.root.$message.error(n.data.message)};n.value?.validate((async e=>{e&&await o()}))}},u=(0,l.computed)((()=>{const t=[];switch(e.projectInfo?.projectType){case s.kA.live:t.push({label:s.Wj.get(s.C_.tryLive),value:s.C_.tryLive}),e.projectInfo?.cooperationType===s.x3.selfSupport?t.push({label:s.Wj.get(s.C_.execution),value:s.C_.execution}):e.projectInfo?.cooperationType===s.x3.region&&t.push({label:s.Wj.get(s.C_.regionExecution),value:s.C_.regionExecution}),t.push({label:"执行结束",value:s.C_.executionEnd});break;case s.kA.common_business:t.push({label:"执行中",value:s.C_.execution}),t.push({label:"执行结束",value:s.C_.executionEnd});break;case s.kA.marketing:t.push({label:"确定合作",value:s.C_.tryLive}),t.push({label:"执行项目",value:s.C_.execution});break;default:break}return t}));return(0,l.watch)((()=>e.visible),(e=>{e||(a.value.status=void 0,setTimeout((()=>{n.value?.clearValidate()}),300))})),{formRef:n,rules:o,formData:a,projectStatusOptions:u,saveLoading:r,...c}}}),c=r,u=a(1001),d=(0,u.Z)(c,n,o,!1,null,null,null),m=d.exports},31279:function(e,t,a){a.d(t,{Z:function(){return C}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new write-off-first",attrs:{visible:e.writeOffVisible,width:"868px","close-on-click-modal":!1,"destroy-on-close":!0},on:{close:e.closeHandler},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(e._s(e.pageConst.dialogTitle))]},proxy:!0},{key:"footer",fn:function(){return[a("tg-button-line",{attrs:{"justify-content":"center"}},[a("tg-button",{on:{click:e.closeHandler}},[e._v("取消")]),e.nextFlag?a("tg-button",{attrs:{disabled:0===e.selectedYxywIsActualIncome.length,type:"primary"},on:{click:e.submitHandler}},[e._v(" 提交 ")]):a("tg-button",{attrs:{type:"primary"},on:{click:e.nextStep}},[e._v("下一步")])],1)]},proxy:!0}])},[a("div",{staticClass:"write-off-main"},[e.nextFlag?e._e():a("el-alert",{staticStyle:{color:"#ff7a36",height:"40px"},attrs:{closable:!1,title:e.pageConst.alert,type:"warning","show-icon":""}}),a("div",{staticClass:"write-amount"},[a("span",[e._v(e._s(e.pageConst.amountText))]),a("span",{staticClass:"amount"},[e._v(e._s(e.notAmount))])]),e.nextFlag?[a("div",{staticClass:"write-off-query write-off-next"},[a("div",{staticClass:"next-head"},[a("span",{staticClass:"label"},[e._v(e._s(e.pageConst.queryText))]),a("div",{staticStyle:{"margin-left":"auto",color:"#a4b2c2","margin-right":"5px"}},[a("el-popover",{attrs:{placement:"top",trigger:"hover",content:e.pageConst.searchTip}},[a("div",{staticClass:"tip",attrs:{slot:"reference"},slot:"reference"},[a("tg-icon",{attrs:{name:"ico-question"}})],1)])],1),a("el-input",{staticClass:"next-input",attrs:{size:"mini",placeholder:e.pageConst.queryPlaceholder},nativeOn:{keypress:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.searchHandler.apply(null,arguments)}},model:{value:e.achievementId,callback:function(t){e.achievementId=t},expression:"achievementId"}},[a("span",{staticClass:"el-icon-search suffix-search",attrs:{slot:"suffix"},on:{click:e.searchHandler},slot:"suffix"})])],1),a("div",{staticClass:"query-table"},[a("el-table",{attrs:{stripe:"",data:e.queryData,height:"88px"},scopedSlots:e._u([{key:"empty",fn:function(){return[a("div",[a("div",{staticStyle:{"margin-top":"-45px"}},[a("span",{staticStyle:{"font-size":"14px",color:"#a4b2c2"}},[e._v("暂无数据")])])])]},proxy:!0}],null,!1,105308473)},e._l(e.pageConst.secondColumn,(function(t,n){return a("el-table-column",e._b({key:n},"el-table-column",t,!1))})),1)],1)]),a("div",{staticClass:"write-off-selected write-off-next"},[a("div",{staticClass:"next-head"},[a("span",{staticClass:"label"},[e._v(e._s(e.pageConst.writeOffText))])]),a("div",{staticClass:"selected-table"},[a("el-table",{attrs:{stripe:"",data:e.selectedYxywIsActualIncome,height:"260px"},scopedSlots:e._u([{key:"empty",fn:function(){return[a("div",{staticClass:"selected-table-empty"},[a("empty-common")],1)]},proxy:!0}],null,!1,742276989)},e._l(e.thirdColumn,(function(t,n){return a("el-table-column",e._b({key:n},"el-table-column",t,!1))})),1)],1)])]:a("div",{staticClass:"write-off-table"},[a("div",{staticClass:"table-title"},[e._v(e._s(e.pageConst.projectText))]),a("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],attrs:{stripe:"",data:e.data,height:"426px"},on:{"selection-change":e.handleSelectionChange},scopedSlots:e._u([{key:"empty",fn:function(){return[a("div",{staticClass:"pdt-20"},[a("empty-common")],1)]},proxy:!0}])},e._l(e.pageConst.firstColumn,(function(t,n){return a("el-table-column",e._b({key:n},"el-table-column",t,!1))})),1)],1)],2)])},o=[],i=(a(26699),a(97434)),s=a(61282),l=a(17352);const r={type:"isReceivable",queryText:"业绩查询",searchTip:"付款编号仅支持实收发生的退款付款编号搜索",queryPlaceholder:"请输入收款或付款编号",dialogTitle:"应收核销",alert:"注意：如果需要核销到其他项目的实收，请点击下一步后添加。",queryAjax:l.Nm,yxSameProjectAjax:l.gg,yxSubmitAjax:l.l5,dbSameProjectAjax:l.Nq,dbSubmitAjax:l.BH,amountText:"应收单可核销金额",projectText:"同项目实收单",writeOffText:"实收核销列表",firstColumn:[{type:"selection",align:"center",headerAlign:"center",width:60},{label:"收款编号",property:"uid"},{label:"实收金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.gather_amount,"")},{label:"",width:110},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.not_write_off_amount,"")},{label:"",width:110}],secondColumn:[{label:"收/付款编号",property:"uid",width:168},{label:"实收/实付金额 (元)",align:"right",headerAlign:"right",width:120,formatter:e=>{let t=e.gather_amount;return 2===e.search_type&&(t=-1*e.gather_amount),(0,s.dN)(t,"")}},{label:"项目名称",formatter:e=>e.project_name||"--",minWidth:300},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:110,formatter:e=>{let t=e.not_write_off_amount;return 2===e.search_type&&(t=-1*e.not_write_off_amount),(0,s.dN)(t,"")}}]},c={type:"isActualIncome",queryText:"应收查询",queryPlaceholder:"请输入应收编号",dialogTitle:"实收核销",alert:"注意：如果需要核销到其他项目的应收，请点击下一步后添加。",queryAjax:l.vJ,yxSameProjectAjax:l.nE,yxSubmitAjax:l.l5,dbSameProjectAjax:l.gi,dbSubmitAjax:l.BH,amountText:"实收可核销金额",projectText:"同项目应收单",writeOffText:"应收核销列表",firstColumn:[{type:"selection",align:"center",headerAlign:"center",width:60},{label:"应收编号",property:"uid"},{label:"应收金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.receivable_amount,"")},{label:"",width:110},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.not_write_off_amount,"")},{label:"",width:110}],secondColumn:[{label:"应收编号",property:"uid",width:168},{label:"应收金额 (元)",align:"right",headerAlign:"right",width:120,formatter:e=>(0,s.dN)(e.receivable_amount,"")},{label:"项目名称",minWidth:300,showOverflowTooltip:!0,formatter:e=>e.project_name||"--"},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:110,formatter:e=>(0,s.dN)(e.not_write_off_amount,"")}]},u={type:"isPayable",queryText:"收/付款查询",searchTip:"收款编号仅支持实付发生的退款收款编号搜索",queryPlaceholder:"请输入收款或付款编号",dialogTitle:"应付核销",alert:"注意：如果需要核销到其他项目的实付，请点击下一步后添加。",queryAjax:l.AX,yxSameProjectAjax:l.AX,yxSubmitAjax:l.Xc,dbSameProjectAjax:l.AX,dbSubmitAjax:l.Xc,amountText:"应付单可核销金额",projectText:"同项目实收单",writeOffText:"实付核销列表",firstColumn:[{type:"selection",align:"center",headerAlign:"center",width:60},{label:"付款编号",property:"id"},{label:"实付金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.cost_amount,"")},{label:"",width:110},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.not_write_off_amount,"")},{label:"",width:110}],secondColumn:[{label:"收/付款编号",width:168,formatter:e=>4===e.search_type?e.uid:e.id},{label:"实收/实付金额 (元)",align:"right",headerAlign:"right",width:120,formatter:e=>{let t=e.cost_amount;return 4===e.search_type&&(t=-1*e.cost_amount),(0,s.dN)(t,"")}},{label:"项目名称",minWidth:300,showOverflowTooltip:!0,formatter:e=>e.project_name||"--"},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:110,formatter:e=>{let t=e.not_write_off_amount;return 4===e.search_type&&(t=-1*e.not_write_off_amount),(0,s.dN)(t,"")}}]},d={type:"isActual",queryText:"应付查询",queryPlaceholder:"请输入应付编号",dialogTitle:"实付核销",alert:"注意：如果需要核销到其他项目的应付，请点击下一步后添加。",queryAjax:l.t6,yxSameProjectAjax:l.eD,yxSubmitAjax:l.Xc,dbSameProjectAjax:l.eD,dbSubmitAjax:l.Xc,amountText:"实付单可核销金额",projectText:"同项目应付单",writeOffText:"应付核销列表",firstColumn:[{type:"selection",align:"center",headerAlign:"center",width:60},{label:"应付编号",property:"uid"},{label:"应付金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.payable_amount,"")},{label:"",width:110},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:126,formatter:e=>(0,s.dN)(e.not_write_off_amount,"")},{label:"",width:110}],secondColumn:[{label:"应付编号",property:"uid",width:168},{label:"应付金额 (元)",align:"right",headerAlign:"right",width:120,formatter:e=>(0,s.dN)(e.payable_amount,"")},{label:"项目名称",minWidth:300,showOverflowTooltip:!0,formatter:e=>e.project_name||"--"},{label:"未核销金额 (元)",align:"right",headerAlign:"right",width:110,formatter:e=>(0,s.dN)(e.not_write_off_amount,"")}]};var m=a(64236),p=a(82741),_=a(85937),v=a.n(_),f=a(67910);const g=e=>(0,s.SJ)(new(v())(e)),y=e=>{const t=(0,i.ref)([]),a=(0,i.ref)([]),n=(0,i.ref)(!1),o=(0,i.ref)(!1),s=(0,i.ref)(!1),l=async(a,o)=>{n.value=!0;const[{data:i}]=await Promise.all([await o(a),await(0,m._v)(500)]);n.value=!1,i.success?(i.data.forEach((e=>e.write_off_amount=void 0)),t.value=i.data):e.root.$message({type:"warning",message:i.message??"查询失败，稍后重试",duration:2e3,showClose:!0})},r=async(t,n)=>{o.value=!0;const[{data:i}]=await Promise.all([await n(t),await(0,m._v)(500)]);o.value=!1,i.success?(i.data.write_off_amount=void 0,a.value=[i.data]):e.root.$message({type:"warning",message:i.message??"查询失败，稍后重试",duration:2e3,showClose:!0})},c=async(t,a)=>{s.value=!0;const[{data:n}]=await Promise.all([await a(t),await(0,m._v)(500)]);return s.value=!1,n.success?Promise.resolve(!0):(e.root.$message({type:"warning",message:n.message??"查询失败，稍后重试",duration:2e3,showClose:!0}),Promise.reject())};return{loading:n,data:t,queryData:a,loadDataList:l,loadAchievement:r,submitAjax:c,submitLoading:s}};var h=(0,i.defineComponent)({setup(e,t){const a=(0,i.ref)(c),n=(0,i.ref)(1),o=(0,i.ref)(""),l=y(t),m=(0,i.ref)(!1),_=(0,i.ref)(""),v=(0,i.ref)(!1),h=(0,i.ref)([]),x=({gather_amount:e})=>void 0===e?"--":`￥${g(e)}`,b=(0,i.computed)((()=>Math.max(...h.value.map((e=>(0,s.QN)(x(e)))),(0,s.QN)("实收金额")))),w=({payable_amount:e})=>void 0===e?"--":`￥${g(e)}`,C=(0,i.computed)((()=>Math.max(...h.value.map((e=>(0,s.QN)(w(e)))),(0,s.QN)("应收金额")))),k=({receivable_amount:e})=>void 0===e?"--":`￥${g(e)}`,S=(0,i.computed)((()=>Math.max(...h.value.map((e=>(0,s.QN)(k(e)))),(0,s.QN)("应付金额")))),D=({cost_amount:e,search_type:t})=>void 0===e?"--":`￥${g(4===t?-1*Number(e):e)}`,j=(0,i.computed)((()=>Math.max(...h.value.map((e=>(0,s.QN)(D(e)))),(0,s.QN)("实付金额")))),F=e=>`￥${g(e.not_write_off_amount)}`,$=(0,i.computed)((()=>Math.max(...h.value.map((e=>(0,s.QN)(F(e)))),(0,s.QN)("未核销金额")))),A=e=>`${e.uid}`,T=(0,i.computed)((()=>Math.max(...h.value.map((e=>(0,s.QN)(A(e)))),(0,s.QN)("收款编号")))),N=e=>`${e.id}`,L=e=>e.project_name?e.project_name.length<=13?e.project_name:e.project_name.substr(0,13)+"...":"--",I=({project_name:e})=>e?e.length<=13?e:(0,i.h)("el-tooltip",{props:{effect:"light",placement:"top-start",content:e}},[(0,i.h)("span",void 0,e.substr(0,13)+"...")]):"--",M=(0,i.computed)((()=>Math.max(...h.value.map((e=>(0,s.QN)(L(e)))),(0,s.QN)("项目名称")))),R=(0,i.computed)((()=>[{label:"核销金额 (元)",width:122,formatter:e=>(0,i.h)("el-input",{on:{input:t=>{X(t,e)},blur:()=>{U(e)}},attrs:{size:"mini",placeholder:"0.00"},props:{value:e.write_off_amount}})},{label:"操作",width:70,formatter:(e,t,a,n)=>(0,i.h)("a",{on:{click:()=>{V(n)}}},["移除"])}])),Y=(0,i.computed)((()=>[{label:"应收编号",property:"uid",minWidth:T.value,formatter:A},{label:"应收金额",align:"right",minWidth:S.value+20,formatter:e=>k(e)},{label:"项目名称",minWidth:M.value,formatter:I},{label:"未核销金额",align:"right",headerAlign:"right",minWidth:$.value+20,formatter:F},...R.value])),Z=(0,i.computed)((()=>[{label:"收/付款编号",property:"uid",minWidth:T.value,formatter:A},{label:"实收/实付金额",align:"right",headerAlign:"right",minWidth:b.value+40,formatter:x},{label:"项目名称",minWidth:M.value,formatter:I},{label:"未核销金额",align:"right",headerAlign:"right",minWidth:$.value+20,formatter:F},...R.value])),O=(0,i.computed)((()=>[{label:"应付编号",property:"uid",minWidth:T.value,formatter:A},{label:"应付金额",align:"right",headerAlign:"right",minWidth:C.value+20,formatter:e=>w(e)},{label:"项目名称",minWidth:220,formatter:I},{label:"未核销金额",align:"right",headerAlign:"right",minWidth:$.value+20,formatter:F},...R.value])),P=(0,i.computed)((()=>[{label:"收/付款编号",property:"id",minWidth:(0,f.zY)(h,"收/付款编号",A).value,formatter:e=>4===e.search_type?A(e):N(e)},{label:"实付金额",align:"right",headerAlign:"right",minWidth:j.value+20,formatter:e=>D(e)},{label:"项目名称",minWidth:220,formatter:I},{label:"未核销金额",align:"right",headerAlign:"right",minWidth:$.value+20,formatter:F},...R.value])),q=(0,i.computed)((()=>"isActualIncome"===a.value.type?Y.value:"isReceivable"===a.value.type?Z.value:"isActual"===a.value.type?O.value:"isPayable"===a.value.type?P.value:[]));let z=0,B="",W="live";const E=()=>{v.value=!1,m.value=!1,h.value=[],o.value="",_.value="",l.queryData.value=[]},H=()=>{let e=l.queryData.value[0];2!==e?.search_type&&4!==e?.search_type||(e={...e},e.gather_amount=Number("-"+e.gather_amount),e.not_write_off_amount=Number("-"+e.not_write_off_amount)),h.value.unshift(e),l.queryData.value=[]},G=e=>{h.value=e},J={label:" ",align:"right",formatter:e=>{const t=h.value.map((e=>e.id));return(0,i.h)("el-button",{on:{click:()=>{H()}},attrs:{size:"mini",type:"primary",disabled:t.includes(e.id)}},["添加"])}},V=e=>{h.value.splice(e,1)},U=e=>{if(2===e?.search_type||4===e?.search_type){const t=e.write_off_amount;if(t){const t=Number("-"+e.write_off_amount);isNaN(t)?e.write_off_amount=e.write_off_amount?.includes("-")?e.write_off_amount:"-"+e.write_off_amount:t>=e.not_write_off_amount?e.write_off_amount=t+"":e.write_off_amount=e.not_write_off_amount+""}}},X=(e,t)=>{t.search_type&&1!==t.search_type?t.write_off_amount=(0,s.nA)(e):Number(e)>t.not_write_off_amount?t.write_off_amount=t.not_write_off_amount+"":t.write_off_amount=(0,s.nA)(e)},Q=()=>{if(!_.value.trim())return;const e={},t=location.pathname.split("/"),o=t.find((e=>/\d/.test(e)));"isReceivable"===a.value.type?(e.achievement_uid=_.value,e.receivable_type=n.value,e.project_id=o):"isActualIncome"===a.value.type?(e.receivable_uid=_.value,e.receivable_type=n.value):"isPayable"===a.value.type?(e.cost_id=_.value,e.payable_type=n.value,e.project_type=W,e.project_id=o):"isActual"===a.value.type&&(e.payable_uid=_.value,e.payable_type=n.value),l.loadAchievement(e,a.value.queryAjax),_.value=""},K=({type:e="isActualIncome",id:t,leaf:i,amount:s,busType:m,receivable_uid:p,cost_split_id:_})=>{v.value=!0;const f={};"isActualIncome"===e?(a.value=c,f.achievement_id=t):"isReceivable"===e?(a.value=r,f.receivable_id=t):"isActual"===e?(a.value=d,f.cost_id=t,f.project_type=i,"live"===i&&(f.cost_split_id=_)):"isPayable"===e&&(a.value=u,f.project_type=i,f.payable_id=t),a.value.secondColumn[4]=J,n.value=m,z=s,B=p,W=i,o.value=g(s),l.loadDataList(f,"coop"===i?a.value.yxSameProjectAjax:a.value.dbSameProjectAjax)},ee=()=>{m.value=!0},te=async()=>{const e=h.value.find((e=>"0"===e.write_off_amount));if(e)return void t.root.$message({type:"warning",message:"核销金额不能小于等于0",duration:2e3,showClose:!0});const n=h.value.filter((e=>e.write_off_amount)).map((e=>e.write_off_amount)),o=n.reduce(((e,t)=>1*e+1*t),0),i=h.value.map((e=>"isReceivable"===a.value.type?{receivable_uid:B,receipt_uid:e.uid,write_off_amount:e.write_off_amount}:"isActualIncome"===a.value.type?{receivable_uid:e.uid,receipt_uid:B,write_off_amount:e.write_off_amount}:"isActual"===a.value.type?{paid_uid:B,payable_uid:e.uid,write_off_amount:e.write_off_amount}:"isPayable"===a.value.type?{paid_uid:4===e.search_type?e.uid:e.id,payable_uid:B,write_off_amount:e.write_off_amount}:void 0));if(o>z)return void t.root.$message({type:"warning",message:"输入核销金额不能超过可核销金额",duration:2e3,showClose:!0});if(!o||o<=0)return void t.root.$message({type:"warning",message:"核销金额不能小于等于0",duration:2e3,showClose:!0});const s=await(0,p.I)(t,{title:"确认进行核销？操作成功后不可撤销"});if(s){const e={list:i,confirm:!0,project_type:W},n="live"===W?a.value.dbSubmitAjax:a.value.yxSubmitAjax;l.submitAjax(e,n).then((()=>{E(),t.root.$message({type:"success",message:"核销成功",duration:2e3,showClose:!0}),t.emit("submit")}))}};return{writeOffVisible:v,closeHandler:E,nextFlag:m,show:K,nextStep:ee,submitHandler:te,...l,notAmount:o,pageConst:a,handleSelectionChange:G,achievementId:_,searchHandler:Q,selectedYxywIsActualIncome:h,thirdColumn:q}}}),x=h,b=a(1001),w=(0,b.Z)(x,n,o,!1,null,null,null),C=w.exports},36165:function(e,t,a){a.d(t,{Z:function(){return u}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-card",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"settlement-tab flex-auto",on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("tg-button-line",{staticStyle:{"min-height":"12px"}},[e.CanIUse.createBtn?a("tg-button",{staticClass:"mgb-12 mgt-12",attrs:{type:"primary",icon:"ico-btn-add",disabled:void 0===e.project},on:{click:e.onCreateBtnClick}},[e._v(e._s(e.buttonContent))]):e._e(),e.CanIUse.createBtn?a("tg-button",{staticClass:"mgb-12 mgt-12",attrs:{type:"primary",icon:"ico-btn-add",disabled:void 0===e.project},on:{click:function(t){return e.onCreateBtnClick(1)}}},[e._v("暂估结算")]):e._e(),(e.isFromLive||e.isFromCommon)&&e.CanIUse.auditBtn?a("tg-button",{staticClass:"mgb-12 mgt-12",on:{click:function(t){return e.onApproveBtnClick()}}},[e._v("结算单审批")]):e._e(),e.isDev&&e.CanIUse.createBtn?a("tg-button",{on:{click:function(t){return e.reload()}}},[e._v("刷新列表")]):e._e()],1),a("el-table",e._b({attrs:{stripe:"",border:"",data:e.data,"row-style":function(t){var a=t.row;return e.rowStyle(a)}},on:{"cell-click":function(t){return e.onViewBtnClick(t)}},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无成本结算"}})]},proxy:!0}])},"el-table",e.tableProps,!1),e._l(e.columns,(function(t,n){return a("el-table-column",e._b({key:n},"el-table-column",t,!1))})),1),e.total>0?a("el-pagination",{staticStyle:{margin:"8px 0"},attrs:{"current-page":e.filterForm.page_num,"page-sizes":[10,20,50,100,200],"page-size":e.filterForm.num,layout:"total, prev, pager, next, sizes, jumper",total:e.total},on:{"update:currentPage":function(t){return e.$set(e.filterForm,"page_num",t)},"update:current-page":function(t){return e.$set(e.filterForm,"page_num",t)},"current-change":e.onCurrentChange,"size-change":e.onSizeChange}}):e._e(),a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",attrs:{visible:e.reasonDialogVisible,width:"440px"},on:{close:e.onReasonDialogClose},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(e._s(e.reasonDialogTitle))]},proxy:!0}])},[a("div",{staticClass:"reason-dialog-content"},[e._v(e._s(e.reason))])]),a("TgSettlementDialog",{ref:"dialogRef",on:{close:e.onDialogClose,update:e.onCacheShouldUpdate,outdated:e.onCacheOutdated}}),a("settlement-detail-dialog",{ref:"settlementDetailDialogRef",attrs:{readonly:!0}}),a("tg-mask-loading",{attrs:{visible:e.deleteLoading,content:"正在删除，请稍候..."}}),a("reverseOrderDialog",{ref:"reverseOrderDialogRef"}),a("addSettlementDialog",{ref:"addSettlementDialog",attrs:{editData:{}},on:{added:e.onSettlementAdded}}),a("payment-dialog",{attrs:{visible:e.paymentDialogVisible,data:e.paymentData,settlement:e.paySettlement,projectType:e.projectType,customerManager:e.customerManager},on:{"update:visible":function(t){e.paymentDialogVisible=t},save:e.onPaymentSave}}),a("invoice-upload",{ref:"InvoiceUploadRef",on:{success:e.onInvoiceUploadSuccess}}),a("tg-mask-loading",{attrs:{visible:e.reverseLoading,content:"正在提交冲销，请稍候..."}}),a("tg-mask-loading",{attrs:{visible:e.reverseAgainLoading,content:"正在提交冲销，请稍候..."}}),a("tg-mask-loading",{attrs:{visible:e.isFetchingDetail,content:"正在获取详情，请稍候..."}})],1)},o=[],i=a(64951),s=(0,i.Z)(),l=s,r=a(1001),c=(0,r.Z)(l,n,o,!1,null,null,null),u=c.exports},85688:function(e,t,a){a.d(t,{Z:function(){return va}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("tg-card",e._b({directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"settlement-tab flex-auto",on:{"rect:update":e.onRectUpdate}},"tg-card",e.cardProps,!1),[a("tg-button-line",{staticStyle:{"min-height":"12px"}},[e.CanIUse.createBtn?a("tg-button",{staticClass:"mgb-12 mgt-12",attrs:{type:"primary",icon:"ico-btn-add",disabled:void 0===e.project},on:{click:e.onCreateBtnClick}},[e._v(e._s(e.buttonContent))]):e._e(),e.CanIUse.createBtn?a("tg-button",{staticClass:"mgb-12 mgt-12",attrs:{type:"primary",icon:"ico-btn-add",disabled:void 0===e.project},on:{click:function(t){return e.onCreateBtnClick(1)}}},[e._v("暂估结算")]):e._e(),(e.isFromLive||e.isFromCommon)&&e.CanIUse.auditBtn?a("tg-button",{staticClass:"mgb-12 mgt-12",on:{click:function(t){return e.onApproveBtnClick()}}},[e._v("结算单审批")]):e._e()],1),a("el-table",e._b({attrs:{stripe:"",border:"",data:e.data,"row-style":function(t){var a=t.row;return e.rowStyle(a)}},on:{"cell-click":function(t){return e.onViewBtnClick(t)}},scopedSlots:e._u([{key:"empty",fn:function(){return[a("empty-common",{attrs:{"detial-text":"暂无收入结算"}})]},proxy:!0}])},"el-table",e.tableProps,!1),e._l(e.columns,(function(t,n){return a("el-table-column",e._b({key:n},"el-table-column",t,!1))})),1),e.total>0?a("el-pagination",{staticStyle:{margin:"8px 0"},attrs:{"current-page":e.filterForm.page_num,"page-sizes":[10,20,50,100,200],"page-size":e.filterForm.num,layout:"total, prev, pager, next, sizes, jumper",total:e.total},on:{"update:currentPage":function(t){return e.$set(e.filterForm,"page_num",t)},"update:current-page":function(t){return e.$set(e.filterForm,"page_num",t)},"current-change":e.onCurrentChange,"size-change":e.onSizeChange}}):e._e(),a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter",attrs:{visible:e.reasonDialogVisible,width:"440px"},on:{close:e.onReasonDialogClose},scopedSlots:e._u([{key:"title",fn:function(){return[e._v(e._s(e.reasonDialogTitle))]},proxy:!0}])},[a("div",{staticClass:"reason-dialog-content"},[e._v(e._s(e.reason))])]),a("TgSettlementDialog",{ref:"dialogRef",on:{close:function(t){return e.reload()}}}),a("buessiness-settlement",{ref:"BuessinessSettlement",attrs:{readonly:!0}}),a("project-confirm-dialog",{ref:"projectConfirmDialogRef",on:{"success:confirm":e.reload,"success:refuse":e.reload}}),a("tg-mask-loading",{attrs:{visible:e.deleteLoading,content:"正在删除，请稍候..."}}),a("reverseOrderDialog",{ref:"reverseOrderDialogRef"}),a("settlementApprove",{attrs:{visible:e.approveVisible},on:{"update:visible":function(t){e.approveVisible=t},"dialog:close":e.onApproveClose}}),a("tg-mask-loading",{attrs:{visible:e.writeOffLoading,content:"正在提交冲销，请稍候..."}}),a("tg-mask-loading",{attrs:{visible:e.settleemntDetailLoading,content:"正在获取结算单详情，请稍候..."}}),a("achievement",{ref:"achievementRef",on:{ok:e.reload}}),a("make-invoice-dialog",{ref:"MakeInvoiceDialogRef",attrs:{reload:!0},on:{success:e.reload}})],1)},o=[],i=(a(26699),a(97434)),s=a(28348),l=a(98560),r=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-dialog",{staticClass:"tg-dialog-classic settlement-dialog tg-dialog-vcenter-new",attrs:{visible:e.dialogVisible,width:e.dialogWidth,"before-close":e.beforeClose,"lock-scroll":"","close-on-click-modal":!1,"close-on-press-escape":!1,"destroy-on-close":""},on:{close:e.close},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("收入结算")]},proxy:!0}])},[a("div",{staticClass:"settlement-dialog-content",style:{width:e.dialogWidth}},[a("div",{staticClass:"steps-line",style:{width:e.dialogWidth}},[a("div",{staticClass:"steps",class:e.is_virtual_receipt?"plus":"normal"},[e._l(e.steps,(function(t,n){return[a("div",{key:n,staticClass:"step",class:{finish:n<e.activeNumber,process:n===e.activeNumber,wait:n>e.activeNumber}},[n<e.activeNumber?a("div",{staticClass:"step-icon"},[a("tg-icon",{attrs:{name:"ico-right"}})],1):a("div",{staticClass:"step-icon"},[e._v(e._s(n+1))]),a("div",{staticClass:"step-title"},[e._v(e._s(t.title))])]),n<2?[a("div",{key:"line-"+n,staticClass:"step-line"})]:e._e()]}))],2)]),a(e.formComponent,{ref:"stepCompRef",tag:"component",staticClass:"settlement-dialog-content-main",on:{cancel:e.close,prev:e.prev,next:e.next,"submit:success":e.onSubmitSuccess}})],1)])},c=[],u=a(89852),d=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"settlement-basic-info"},[a("el-form",{ref:"step1FrmRef",staticClass:"step1-frm",attrs:{model:e.step1Frm,size:"small",rules:e.step1FrmRules,"label-width":"90px"}},[e.settlement||0!==e.step1Frm.is_estimate?e._e():a("el-form-item",{attrs:{label:"结算方式",prop:"settlement_way"}},[a("el-select",{staticStyle:{width:"276px"},model:{value:e.step1Frm.settlement_way,callback:function(t){e.$set(e.step1Frm,"settlement_way",t)},expression:"step1Frm.settlement_way"}},[a("el-option",{attrs:{value:"1",label:"普通结算"}}),a("el-option",{attrs:{value:"2",label:"替换暂估结算"}})],1),"2"===e.step1Frm.settlement_way?a("div",{staticStyle:{width:"420px",height:"16px","line-height":"24px","font-size":"12px",color:"#a4b2c2"}},[a("tg-icon",{staticStyle:{"font-size":"14px"},attrs:{name:"ico-warn"}}),e._v(" 被替换的周期内的暂估结算如未确认,会被删除;如已确认,会被冲销 ")],1):e._e()],1),"2"===e.step1Frm.settlement_way?a("div",[a("el-form-item",{attrs:{label:"替换方式",prop:"settlement_replace_way"}},[a("el-radio-group",{staticStyle:{"line-height":"38px",height:"38px"},model:{value:e.settlement_replace_way,callback:function(t){e.settlement_replace_way=t},expression:"settlement_replace_way"}},[a("el-radio",{attrs:{label:0}},[e._v("替换结算周期")]),a("el-radio",{attrs:{label:1}},[e._v("替换结算单")])],1)],1),a("el-form-item",{attrs:{label:1===e.settlement_replace_way?"暂估结算单":"结算周期",prop:"settlement_replace_id"}},[a("el-select",{staticStyle:{width:"276px"},model:{value:e.settlement_replace_id,callback:function(t){e.settlement_replace_id=t},expression:"settlement_replace_id"}},[e._l(1===e.settlement_replace_way?e.SettlementIdsReplaceDateOptions:e.SettlementReplaceDateOptions,(function(t,n){return[t.settlement_type!==e.SettlementType.s2b2c_douyin_cps?a("el-option",{key:n,attrs:{value:t.value,label:t.label}}):e._e()]}))],2)],1)],1):e._e(),"1"===e.step1Frm.settlement_way?a("div",[a("el-form-item",{attrs:{label:"项目名称"}},[a("div",{staticClass:"static-content"},[e._v(e._s(e.project_name))])]),1!==e.mcn_platform_type?a("el-form-item",{attrs:{label:"公司"}},[a("div",{staticClass:"static-content"},[e._v(" "+e._s(e.isFromCommon?"阿里巴巴网络科技有限公司":e.project.company_name||"--")+" ")])]):e._e(),1!==e.mcn_platform_type?a("el-form-item",{attrs:{label:"店铺"}},[a("div",{staticClass:"static-content"},[e._v(" "+e._s(e.isFromCommon?"阿里巴巴网络有限公司":e.project.shop_name||"--")+" ")])]):e._e(),a("el-form-item",{attrs:{label:"结算类型",prop:"settlement_type"}},[a("el-select",{staticStyle:{width:"276px"},attrs:{disabled:e.isFromLive||1===e.mcn_platform_type},model:{value:e.step1Frm.settlement_type,callback:function(t){e.$set(e.step1Frm,"settlement_type",t)},expression:"step1Frm.settlement_type"}},e._l(e.typeOptions,(function(e,t){return a("el-option",{key:t,attrs:{value:e.value,label:e.label}})})),1)],1),e.isFromLive&&2===e.step1Frm.settlement_type&&!e.isareacost?a("el-form-item",{attrs:{label:"结算周期",prop:"dateMonth"}},[a("el-date-picker",{staticStyle:{width:"276px"},attrs:{editable:!1,disabled:1===e.mcn_platform_type&&!!e.settlement&&!e.settlement.is_tmp,type:"month","value-format":"yyyy-MM",placeholder:"选择结算周期","picker-options":e.pickerOptions},model:{value:e.step1Frm.dateMonth,callback:function(t){e.$set(e.step1Frm,"dateMonth",t)},expression:"step1Frm.dateMonth"}})],1):a("el-form-item",{attrs:{label:"结算周期",prop:"date"}},[a("el-date-picker",{staticStyle:{width:"276px"},attrs:{type:"daterange","range-separator":"~","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"yyyy-MM-dd",format:"yyyy.MM.dd",editable:!1,disabled:1===e.mcn_platform_type&&!!e.settlement&&!e.settlement.is_tmp,"picker-options":e.pickerOptions},model:{value:e.step1Frm.date,callback:function(t){e.$set(e.step1Frm,"date",t)},expression:"step1Frm.date"}})],1)],1):e._e()],1),a("div",{staticClass:"bottom-button-line"},[a("tg-button",{on:{click:e.prev}},[e._v("取消")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("下一步")])],1),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})],1)},m=[],p=(a(21703),a(29625)),_=a(64236),v=a(79443),f=a(44542),g=a(6933),y=a.n(g),h=a(8136),x=a(57046);const b=(e,t)=>y()(e).format("YYYY-MM-DD")===y()(t).format("YYYY-MM-DD");var w=(0,i.defineComponent)({setup(e,t){const{project_id:a,isFromMarketing:n,isFromLive:o,isFromCommon:l}=(0,u.L)(t),r=(0,i.inject)("project_type")??(0,i.ref)("live"),c=(0,i.inject)("settlement")??(0,i.ref)(void 0),d=(0,i.inject)("project3in1")??(0,i.ref)(void 0),m=JSON.stringify(d||{cooperation_type:0}),g=JSON.parse(m);let w=2===g.value?.cooperation_type;if((!g.value||!g.value?.cooperation_type||0===g.value?.cooperation_type)&&!1===w&&o.value&&localStorage.getItem("project3inone")){const e=JSON.parse(localStorage.getItem("project3inone")||"{}");w=2===e.value?.cooperation_type}const C=(0,i.computed)((()=>{if("common"===d.value?.project__type)return d.value?.platform_type})),k=(0,i.ref)(null),S=(0,i.ref)({id:void 0,settlement_type:"",business_type:p.WD.marketing,date:[],dateMonth:"",is_estimate:0,settlement_way:"1"}),D=(0,i.ref)(!1),j=(0,i.ref)([]),F=(0,i.ref)({settlement_type:[{required:!0,message:"请选择业务类型",trigger:"blur"}],settlement_way:[{required:!0,message:"请选择结算方式",trigger:"change"}],settlement_replace_id:[{required:!0,message:"请选择结算周期",trigger:"blur"}],settlement_replace_way:[{required:!0,message:"请选择替换方式",trigger:"change"}],dateMonth:[{required:!0,message:"请选择结算周期",trigger:"change"},{validator:(e,t,a)=>{S.value.dateMonth?a():a(new Error("请选择结算周期"))}}],date:[{required:!0,message:"请选择结算周期",trigger:"blur"},{validator:(e,t,a)=>{const n=t.map((e=>new Date(e).getTime())),o=[];j.value.forEach((e=>{const t=new Date(e).getTime();n[0]<=t&&t<=n[1]&&o.push(e)})),o.length>0?a(new Error(o.map((e=>y()(e).format("YYYY.MM.DD "))).join("、")+"已被结算")):a()},trigger:"blur"}]}),$={disabledDate(e){if(l.value)return!1;const t=Date.now(),a=e.getTime();return a>t&&!b(e,t)||j.value.some((t=>b(t,e)))}},A=(0,i.ref)({id:void 0,settlement_type:"",business_type:p.WD.marketing,date:[],dateMonth:"",is_estimate:0,settlement_way:"1"}),T=()=>{S.value.id=void 0,S.value.settlement_type="",S.value.business_type=p.WD.marketing,S.value.date=[],S.value.dateMonth=""},N=(e="")=>{A.value.id=void 0,A.value.settlement_type=e,A.value.business_type=p.WD.marketing,A.value.date=[]},L=(0,i.computed)((()=>void 0!==A.value.id)),I=(0,i.computed)((()=>L.value&&JSON.stringify(A.value)!==JSON.stringify(S.value))),M=(e,t)=>{if(T(),N(),void 0===e)"live"===d.value?.project__type?d.value.business_type===p.WD.douyin?(S.value.settlement_type=s.kX.live_douyin,S.value.business_type=p.WD.douyin):d.value.business_type===p.WD.taobao?(S.value.settlement_type=s.kX.live_taobao,S.value.business_type=p.WD.taobao):d.value.business_type===p.WD.douyinsh&&(S.value.settlement_type=s.kX.live_douyin,S.value.business_type=p.WD.douyin):"marketing"===d.value?.project__type?S.value.business_type=p.WD.marketing:"common"===d.value?.project__type&&(S.value.business_type=p.WD.mcn,1===d.value.platform_type&&(S.value.settlement_type=s.kX.common_mcn_douyin_cps)),1===t&&(S.value.is_estimate=1),N(S.value.settlement_type);else{const{id:t,settlement_type:a,start_date:n,end_date:i,business_type:s}=e;if(S.value.id=t,S.value.settlement_type=a,S.value.date=[n,i].map((e=>y()(1e3*e).format("YYYY-MM-DD"))),S.value.business_type=s,S.value.is_estimate=e.is_estimate,A.value.is_estimate=e.is_estimate,A.value.id=t,A.value.settlement_type=a,A.value.date=[n,i].map((e=>y()(1e3*e).format("YYYY-MM-DD"))),A.value.business_type=s,o.value&&2===S.value.settlement_type&&!w){const e=y()(S.value.date[0]),t="yyyy-MM";S.value.dateMonth=e.clone().startOf("month").format(t),console.log(S)}}D.value=!0};(0,i.onBeforeUnmount)((()=>{D.value=!1,j.value=[]}));const R=(0,i.computed)((()=>{switch(d.value?.project__type){case"marketing":return d.value.cooperation_name||"--";case"live":case"common":return d.value.project_name||"--";default:return"--"}})),Y=(0,i.computed)((()=>{switch(d.value?.project__type){case"live":return d.value.business_type===p.WD.douyin?[{label:"抖音店播",value:s.kX.live_douyin}]:d.value.business_type===p.WD.taobao?[{label:"淘宝店播",value:s.kX.live_taobao}]:d.value.business_type===p.WD.douyinsh?[{label:"抖音店播",value:s.kX.live_douyin}]:[];case"common":return 1===d.value?.platform_type?[{label:"S2B2C抖音",value:s.kX.common_mcn_douyin_cps}]:[{label:"S2B2C-淘宝CPS",value:s.kX.common_mcn_taobao_cps},{label:"S2B2C-V任务",value:s.kX.common_mcn_vtask}];case"marketing":return[{label:"营销",value:s.kX.marketing_marketing},{label:"V任务",value:s.kX.marketing_vtask}];default:return[]}})),Z=()=>{t.emit("cancel")},O=(0,i.ref)(!1),P=async()=>{const e=await(0,f.G)(k);if(!e)return;const{id:t,settlement_type:n,business_type:i,is_estimate:l}=S.value;let c="",u="";if(o.value&&2===S.value.settlement_type&&!w){const e="yyyy-MM-DD",t=y()(S.value.dateMonth);c=t.clone().startOf("M").format(e),u=t.clone().endOf("M").format(e);const a=new Date(u).getTime(),n=Date.now();a>n&&(u=(0,x.mr)(n))}else c=S.value.date[0],u=S.value.date[1];if(""===n)return;const d={id:t,project_id:a.value,business_type:7===i?3:i,settlement_type:n,start_date:c,end_date:u,step:s.br.step_two};1===l&&(d.is_estimate=l),O.value=!0;const[{data:m}]=await Promise.all([await(0,v.MM)(r.value,d),await(0,_._v)(500)]);return O.value=!1,m},q=e=>e?.success?(t.root.$message.success("保存成功"),t.emit("next",e.data),!0):!1===e?.success&&(t.root.$message.error(e.message??"保存失败"),!1),z=async()=>{if(""===G.value)return void t.root.$message.warning(1===J.value?"请选择暂估结算单":"请选择暂估结算周期");const e={settlement_id:G.value,is_single:J.value},a=S.value.business_type===p.WD.marketing?v.sZ:[p.WD.taobao,p.WD.douyin].includes(S.value.business_type)?v.FR:v.Se;O.value=!0;const[{data:n}]=await Promise.all([await a(e),await(0,_._v)(500)]);return O.value=!1,n},B=async()=>{if("1"===S.value.settlement_way){const e=await P();return q(e)}{const e=await z();return q(e)}},W=async()=>{!L.value||I.value?await B():t.emit("next")},E=async()=>await B(),H=async()=>I.value,G=(0,i.ref)(""),J=(0,i.ref)(0),V=(0,i.ref)([]),U=(0,i.ref)([]),X=()=>{const e={project_id:a.value,settlement_kind:s.Qn.income,no_reverse:1,is_estimate:1,is_tmp:0,business_type:S.value.business_type};return e},Q=async e=>{const[{data:a}]=await(0,_.Dc)(200,(0,v.fO)(r.value,e));a.success?(V.value=[],U.value=[],a.data.data.forEach((e=>{const t=(0,h.xF)(1e3*e.start_date,"YYYY.MM.DD")+" ~"+(0,h.xF)(1e3*e.end_date,"YYYY.MM.DD");V.value.push({label:`${t} ${e.company_name}`,value:e.id.toString(),settlement_type:e.settlement_type}),U.value.push({label:`${e.settlement_uid} ${e.company_name} ${t} ${"￥"+(e.tax_included_amount||"0")} `,value:e.id.toString(),settlement_type:e.settlement_type})}))):t.root.$message.warning(a.message)};return(0,i.watch)((()=>S.value.settlement_way),(e=>{e&&"2"===S.value.settlement_way&&Q(X())})),(0,i.watch)((()=>J.value),(()=>{G.value=""})),{isareacost:w,settlement_replace_id:G,settlement_replace_way:J,SettlementReplaceDateOptions:V,SettlementIdsReplaceDateOptions:U,settlement:c,step1FrmRef:k,originalFrmData:A,step1Frm:S,step1FrmRules:F,typeOptions:Y,settledDates:j,pickerOptions:$,project_id:a,isFromMarketing:n,isFromLive:o,isFromCommon:l,project:d,project_name:R,prev:Z,next:W,saveBeforeClose:E,confirmBeforeClose:H,saveLoading:O,fillForm:M,mcn_platform_type:C,SettlementType:s.kX}}}),C=w,k=a(1001),S=(0,k.Z)(C,d,m,!1,null,"40c8b0a6",null),D=S.exports,j=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("SettlementStep2Layout",{staticClass:"settlement-step2-marketing",attrs:{amount:e.total_settle_amount},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:e.total_settle_amount,taxed:e.TaxDataForm.is_include_tax,type:"value1",tax_rate:e.TaxDataForm.tax_rate,tax_rate_disabled:!1},on:{taxRateChanged:e.taxRateChanged,taxedChanged:e.taxedChanged,valueChange:e.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{scopedSlots:e._u([{key:"title",fn:function(){return[e._v("收入信息")]},proxy:!0}])},[a("div",[a("el-form",{ref:"step2FrmRef",attrs:{model:e.step2Frm,rules:e.step2FrmRules,size:"small","label-width":"56px"}},[a("el-form-item",{attrs:{label:"服务费",prop:"income_amount"}},[a("el-input",{attrs:{size:"small",placeholder:"0.00"},on:{input:e.inputIncomeAmount},scopedSlots:e._u([{key:"append",fn:function(){return[e._v("元")]},proxy:!0}]),model:{value:e.step2Frm.income_amount,callback:function(t){e.$set(e.step2Frm,"income_amount",t)},expression:"step2Frm.income_amount"}})],1)],1)],1)])]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"}},[e.ShowAdjustInfo?a("AdjustAccount",{attrs:{height:350,adjust_info:e.step2Frm.adjust_info},on:{DataChange:e.onAdjustAccountDataChange}}):e._e()],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},F=[],$=a(32851),A=a(99048),T=a(97457),N=a(85937),L=a.n(N),I=a(41572),M=a(94559);const R=e=>["","-","-."].includes(e)?"0.00":e;var Y=(0,i.defineComponent)({components:{SettlementStep2Layout:$.Z,CardLayout:A.Z,TopCard:M.Z,AdjustAccount:T.Z},setup(e,t){const a=(0,i.inject)("settlement")??(0,i.ref)(void 0),n=(0,i.ref)(null),o=(0,i.ref)({income_amount:"",adjust_info:[]}),l=(0,i.ref)({is_include_tax:1,tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",tax_amount:""}),r=(0,i.computed)((()=>o.value.adjust_info.filter((e=>""!==e.adjust_reason&&""!==e.adjust_amount)).reduce(((e,t)=>e.add(new N.Decimal(t.adjust_amount))),new N.Decimal(0)))),c=(0,i.ref)({income_amount:[{validator:(e,t,a)=>{""===t?a():/^\d+(?:\.\d{0,2})?$/u.test(t)?new N.Decimal(t).eq(0)&&r.value.eq(0)?a(new Error("请填写收入或者手工调账")):a():a(new Error("请输入正确的数字"))},trigger:"blur"}]}),u=(0,i.ref)({income_amount:"",adjust_info:[]}),d=()=>{o.value.income_amount="",o.value.adjust_info=[]},m=()=>{u.value.income_amount="",u.value.adjust_info=[]},p=(0,i.computed)((()=>JSON.stringify(u.value)!==JSON.stringify(o.value))),g=(0,i.ref)({is_include_tax:1,tax_rate:"6",tax_included_amount:"",tax_excluded_amount:"",tax_amount:""}),y=(0,i.ref)(!1),h=e=>{d(),m(),y.value=!0;const t=e.tax_rate?.toString()?e.tax_rate?.toString():"6",{income_amount:a,total_settle_amount:n,adjust_info:i,...s}=e;l.value.is_include_tax=0===e.is_include_tax?0:1,l.value.tax_rate=t,l.value.tax_included_amount=e.tax_included_amount?.toString(),l.value.tax_excluded_amount=e.tax_excluded_amount?.toString(),l.value.tax_amount=e.tax_amount?.toString(),g.value.is_include_tax=0===e.is_include_tax?0:1,g.value.tax_rate=t,g.value.tax_included_amount=e.tax_included_amount?.toString(),g.value.tax_excluded_amount=e.tax_excluded_amount?.toString(),g.value.tax_amount=e.tax_amount?.toString(),o.value.income_amount=`${a}`,o.value.adjust_info=i.map((e=>({...e}))),u.value.income_amount=`${a}`,u.value.adjust_info=i.map((e=>({...e})))},x=(0,i.computed)((()=>N.Decimal.add(new N.Decimal(R(o.value.income_amount)),o.value.adjust_info.map((e=>new N.Decimal(R(e.adjust_amount)))).reduce(((e,t)=>e.add(t)),new N.Decimal(0))))),b=(0,i.computed)((()=>x.value.toString())),w=e=>{const t=/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(e.replace(I.Pj,""))??[""];o.value.income_amount=t[0]},C=e=>{o.value.adjust_info=e.map((e=>({...e})))},k=(0,i.ref)(!1),S=(0,i.computed)((()=>""!==o.value.income_amount||o.value.adjust_info.filter((e=>""!==e.adjust_amount&&""!==e.adjust_reason)).length>0)),D=(0,i.computed)((()=>JSON.stringify({tax_amount:l.value.tax_amount,tax_rate:l.value.tax_rate,is_include_tax:l.value.is_include_tax})!==JSON.stringify({tax_amount:g.value.tax_amount,tax_rate:g.value.tax_rate,is_include_tax:g.value.is_include_tax}))),j=async e=>{if(void 0===a.value)return void console.warn("不存在结算数据");if(!S.value)return void t.root.$message.warning("请填写至少一项结算项");const i=await(0,f.G)(n);if(!i)return;const{adjust_info:r,income_amount:c}=o.value,u=r.filter((e=>!(""===e.adjust_amount&&""===e.adjust_reason)));if(void 0!==u.find((e=>""!==e.adjust_reason&&""===e.adjust_amount)))return void t.root.$message.warning("请输入调整金额");if(void 0!==u.find((e=>""!==e.adjust_reason&&new N.Decimal(e.adjust_amount).eq(0))))return void t.root.$message.warning("调整金额不能为0");if(void 0!==u.find((e=>""!==e.adjust_amount&&""===e.adjust_reason)))return void t.root.$message.warning("请输入调整原因");if(x.value.lessThanOrEqualTo(new N.Decimal(0)))return void t.root.$message.warning("总结算金额不能小于等于0");const d=x.value.toString(),m={id:a.value.id,income_amount:""===c?"0":c,total_settle_amount:d,adjust_info:u,step:e?s.br.step_three:a.value.step,is_include_tax:l.value.is_include_tax,tax_rate:""===l.value.tax_rate?"0":l.value.tax_rate??"0",tax_included_amount:l.value.tax_included_amount,tax_excluded_amount:l.value.tax_excluded_amount,tax_amount:l.value.tax_amount};k.value=!0;const[{data:p}]=await(0,_.Dc)(500,(0,v.KP)(m));return k.value=!1,p},F=async()=>{if(!D.value&&!p.value&&S.value)return void t.emit("prev");const e=await j(!1);return!!e?.success&&(t.root.$message.success("保存成功"),t.emit("prev",e.data),!0)},$=async()=>{if(!D.value&&!p.value&&S.value)return void t.emit("next");const e=await j(!0);e?.success?(t.root.$message.success("保存成功"),t.emit("next",e.data)):!1===e?.success&&t.root.$message.error(e.message??"保存失败")},A=async()=>{const e=await j(!1);return!!e?.success&&(t.root.$message.success("保存成功"),t.emit("next",e.data),!0)},T=async()=>D.value||p.value,L=e=>{l.value.is_include_tax=e},M=e=>{l.value.tax_rate=e},Y=e=>{l.value.is_include_tax=e.is_include_tax,l.value.tax_rate=e.tax_rate,l.value.tax_included_amount=e.tax_included_amount,l.value.tax_excluded_amount=e.tax_excluded_amount,l.value.tax_amount=e.tax_amount};return{taxValueChangeHandler:Y,taxedChanged:L,taxRateChanged:M,ShowAdjustInfo:y,amount:x,total_settle_amount:b,step2FrmRef:n,step2Frm:o,step2FrmRules:c,originalFrmData:u,inputIncomeAmount:w,onAdjustAccountDataChange:C,prev:F,next:$,confirmBeforeClose:T,saveBeforeClose:A,saveLoading:k,fillForm:h,TaxDataForm:l}}}),Z=Y,O=(0,k.Z)(Z,j,F,!1,null,"16839398",null),P=O.exports,q=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("SettlementStep3Layout",{staticClass:"settlement-step3-marketing settlement-income-limit",class:1===e.settlement.is_estimate?"is_estimate":"",attrs:{amount:e.total_settle_amount},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:e.total_settle_amount,taxed:e.DataForm.is_include_tax,tax_rate:e.DataForm.tax_rate,name:e.DataForm.company_name,type:"value2"}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{scopedSlots:e._u([{key:"title",fn:function(){return[e._v("收入信息")]},proxy:!0}])},[a("div",{staticClass:"income-amount"},[a("span",[e._v("服务费")]),a("span",{staticStyle:{"font-weight":"600"}},[e._v(" "+e._s(e.income_amount)+" 元")])])])]},proxy:!0},{key:"right",fn:function(){return[a("CardLayout",{scopedSlots:e._u([{key:"title",fn:function(){return[e._v("手工调账")]},proxy:!0}])},[a("div",{staticClass:"adjust-info-content"},[a("div",{staticClass:"adjust-info-total"},[a("div",{staticClass:"adjust-info-total-lbl"},[e._v("调账 "+e._s(e.adjust_info.length)+" 笔")]),a("div",{staticClass:"adjust-info-total-amount"},[e._v(" 共 "+e._s(e.adjust_info_amount_total)+" 元 ")])]),a("div",{staticClass:"adjust-info-line"}),a("div",{staticClass:"adjust-info-list"},[e._l(e.adjust_info,(function(t,n){return[a("div",{key:n,staticClass:"adjust-info-item"},[a("span",[e._v(e._s(n+1)+". ")]),a("span",[e._v("调整金额：")]),a("span",[e._v(e._s(t.adjust_amount)+" 元")]),a("span",[e._v("；调整原因：")]),a("span",[e._v(e._s(t.adjust_reason))])])]}))],2)])])]},proxy:!0},1!==e.settlement.is_estimate?{key:"files",fn:function(){return[a("el-form",{ref:"step3FrmRef",attrs:{model:e.step3Frm,rules:e.step3FrmRules}},[a("el-form-item",{attrs:{label:"结算单：",prop:"settlement_files","label-width":"70px"}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-upload",{staticStyle:{width:"120px"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"before-upload":e.beforeUpload,"http-request":e.uploadFileHandler,accept:".docx,.pdf,.jpg,.jpeg,.png,.xlsx,.xls",disabled:e.isFileUploaderDisabled},model:{value:e.step3Frm.settlement_files,callback:function(t){e.$set(e.step3Frm,"settlement_files",t)},expression:"step3Frm.settlement_files"}},[a("tg-button",{staticClass:"upload-btn",attrs:{size:"medium",icon:"ico-btn-upload",disabled:e.isFileUploaderDisabled}},[e._v("上传文件")])],1),a("div",{staticStyle:{display:"inline-block",height:"16px","line-height":"16px","font-size":"12px","margin-left":"6px",color:"#a4b2c2"}},[e._v(" 支持 .docx .pdf .jpg .png .xlsx .xls,最多上传5个文件(单个文件大小不超过30M) ")])],1)])],1),a("div",{staticClass:"settlement-uploaded-files",staticStyle:{"margin-top":"-5px","margin-bottom":"15px"}},[e._l(e.step3Frm.settlement_files,(function(t,n){return[a("FileItem",{key:n,attrs:{showPreview:0!==e.settlement.status,filepath:t},on:{remove:function(t){return e.onRemoveFile(n)}}})]}))],2),a("el-form",[a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"关联合同："}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入合同编码","remote-method":e.getContract,size:"medium"},on:{change:function(t){return e.selectContractUidChange(t)}},model:{value:e.step3Frm.contract_id,callback:function(t){e.$set(e.step3Frm,"contract_id",t)},expression:"step3Frm.contract_id"}},e._l(e.contract_uids,(function(e){return a("el-option",{key:e.contract_id,attrs:{label:e.sign_type_name+":  "+e.contract_uid+"  ("+e.coop_start_date+"-"+e.coop_end_date+")",value:e.contract_id}})})),1)],1)])],1)]},proxy:!0}:null,{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.submit}},[e._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},z=[],B=a(28966),W=a(61282),E=a(80391),H=a(82741),G=a(25300),J=a(48606),V=a(83005),U=(0,i.defineComponent)({components:{SettlementStep3Layout:B.Z,CardLayout:A.Z,TopCard:M.Z},setup(e,t){const a=(0,i.inject)("settlement")??(0,i.ref)(void 0),n=(0,i.ref)(null),o=(0,i.ref)({settlement_files:[],contract_id:void 0});let l;const r=()=>{l=J.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},c=(0,i.ref)({settlement_files:[{required:!0,message:"请上传结算单",trigger:"blur"}]}),d=(0,i.ref)({settlement_files:[],contract_id:void 0}),m=()=>{o.value.settlement_files=[],o.value.contract_id=void 0},p=()=>{d.value.settlement_files=[],d.value.contract_id=void 0},g=(0,i.computed)((()=>JSON.stringify((0,G.get)(d))!==JSON.stringify((0,G.get)(o)))),y=(0,i.ref)({company_name:"",is_include_tax:1,tax_rate:""}),h=e=>{m(),p();const{...t}=e;y.value.company_name=t.company_name,y.value.is_include_tax=0===e.is_include_tax?0:1,y.value.tax_rate=e.tax_rate?.toString()??"",o.value.settlement_files=t.settlement_files.map((e=>e)),o.value.contract_id=e.contract_id||void 0,d.value.settlement_files=t.settlement_files.map((e=>e)),d.value.contract_id=e.contract_id||void 0},x=(0,i.computed)((()=>new(L())(a.value?.total_settle_amount??"0"))),b=(0,i.computed)((()=>(0,G.get)(x).toString())),w=(0,i.ref)(!1),C=async e=>{if(void 0===a.value)return void console.warn("不存在结算数据");const t=await(0,f.G)(n);if(!t)return;const{settlement_files:i}=(0,G.get)(o),l={id:a.value.id,settlement_files:i,contract_id:o.value.contract_id||0,step:e?s.br.step_three:a.value.step};(0,G.set)(w,!0);const[{data:r}]=await(0,_.Dc)(500,(0,v.gO)(l));return(0,G.set)(w,!1),r},k=async()=>{if(!(0,G.get)(g))return void t.emit("prev");const e=await C(!1);return!!e?.success&&(t.root.$message.success("保存成功"),t.emit("prev",e.data),!0)},S=async()=>{if(void 0===a.value)return;if(0===a.value.is_estimate&&0===o.value.settlement_files.length)return void t.root.$message.warning("请上传结算单");const e=await(0,H.I)(t,{title:"确定提交结算单吗?",content:()=>(0,i.h)("div",[(0,i.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,i.h)("div","提交给财务确认吗?")])});if(!e)return;const n={id:a.value.id,contract_id:o.value.contract_id||0};0===a.value.is_estimate&&(n.settlement_files=o.value.settlement_files),(0,G.set)(w,!0);const[{data:s}]=await(0,_.Dc)(500,(0,v.X2)(n));(0,G.set)(w,!1),s?.success?(t.root.$message.success("提交成功"),t.emit("submit:success")):!1===s?.success&&t.root.$message.error(s.message??"提交失败")},D=async()=>{const e=await C(!1);return!!e?.success&&(t.root.$message.success("保存成功"),t.emit("next",e.data),!0)},j=async()=>(0,G.get)(g),F=(0,i.computed)((()=>(0,W.SJ)(new(L())(a.value?.income_amount??0)))),$=(0,i.computed)((()=>(a.value?.adjust_info??[]).map((e=>({adjust_amount:(0,W.SJ)(new(L())(e.adjust_amount)),adjust_reason:e.adjust_reason}))))),A=(0,i.computed)((()=>{const e=(a.value?.adjust_info??[]).reduce(((e,t)=>L().add(e,new(L())(t.adjust_amount))),new(L())(0));return(0,W.SJ)(e)})),T=(0,i.computed)((()=>o.value.settlement_files.length>=5)),N=31457280,I=async e=>{if(e.size>N)return t.root.$message.error(`${e.name} ${(e.size/N).toFixed(2)}MB 请限制在30MB以内`),Promise.reject()},M=async e=>{const a=e.file;if(a.size>31457280)return void t.root.$message.error("上传文件大小不能超过 30MB!");r();const i=new FormData,s=e.file.name;i.append("file",e.file,s),i.append("type","settlement");const c=await(0,E.$)(i);l.close(),c.data.success?(o.value.settlement_files.push(c.data.data.source),t.root.$message.success("上传成功"),n.value?.clearValidate()):t.root.$message.error(c.data.message??"上传失败，稍后重试")},R=e=>{o.value.settlement_files.splice(e,1)},Y=(0,i.ref)([]),{project_id:Z}=(0,u.L)(t),O=async e=>{const t=await(0,V.z0)({search:e,only_main:0,cooperation_id:Z.value,contract_status:2,partner_type:1});t.data.success?Y.value=t.data.data.data:Y.value=[]};O("");const P=e=>{o.value.contract_id=e};return{contract_uids:Y,getContract:O,selectContractUidChange:P,settlement:a,total_settle_amount:b,amount:x,step3Frm:o,step3FrmRef:n,step3FrmRules:c,resetFrm:m,prev:k,submit:S,confirmBeforeClose:j,saveBeforeClose:D,saveLoading:w,fillForm:h,income_amount:F,adjust_info:$,adjust_info_amount_total:A,DataForm:y,beforeUpload:I,isFileUploaderDisabled:T,uploadFileHandler:M,onRemoveFile:R}}}),X=U,Q=(0,k.Z)(X,q,z,!1,null,"1e27963a",null),K=Q.exports,ee=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("SettlementStep2Layout",{staticClass:"tg-mcn-settlement-form",attrs:{incomeType:1,amount:e.formatAmount(e.total_settle_amount,"None")},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+e.total_settle_amount.toString(),taxed:e.dataForm.is_include_tax,type:"value1",tax_rate:e.dataForm.tax_rate,tax_rate_disabled:!1},on:{taxRateChanged:e.taxRateChanged,taxedChanged:e.taxedChangedHandler,valueChange:e.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{attrs:{padding:[18,0,12]},scopedSlots:e._u([{key:"title",fn:function(){return[a("span",[e._v("收入信息")])]},proxy:!0}])},[[a("div",{staticClass:"mcn-settlement-form-income-content"},[a("div",{staticClass:"mcn-settlement-form-income-content-info"},[a("div",{staticClass:"income-content-info-summary"},[a("span",[e._v("收入")]),a("span",[e._v(" "+e._s(e.formatAmount(e.dataForm.income_amount,"None"))+" 元")])]),e.excelData.length?a("div",{staticStyle:{"border-bottom":"1px dashed rgba(164, 178, 194, 0.3)",margin:"12px 18px 0"}}):e._e(),a("div",{staticClass:"income-content-info-list"},e._l(e.excelData,(function(t,n){return a("div",{key:n,staticClass:"income-content-info-list-row",style:e.isLastSpecialIncomeData(t,n)?"margin-bottom: 18px":""},[a("el-tooltip",{attrs:{disabled:e.isSpecialIncomeData(t),"open-delay":300,content:t.name,placement:"top",effect:"light"}},[a("span",{staticClass:"line-clamp-1",style:e.isSpecialIncomeData(t)?"max-width: 140px; color: #6A7B92;":"max-width: 140px"},[e._v(e._s(t.name))])]),a("span",{style:-1!==t.value.indexOf("-")?"color: #EC1E1E;":""},[e._v(e._s(e.formatAmount(t.value,"None")))])],1)})),0)]),a("div",{staticClass:"mcn-settlement-form-income-content-operator"},[a("el-tooltip",{attrs:{disabled:!!e.dataForm.income_file,content:"上传数据后支持下载",placement:"top",effect:"light"}},[a("tg-button",{attrs:{disabled:!e.dataForm.income_file,type:"link"},on:{click:function(t){return e.downloadFile(e.dataForm.income_file)}}},[e._v("下载原始数据")])],1),a("el-upload",{attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler},model:{value:e.dataForm.income_file,callback:function(t){e.$set(e.dataForm,"income_file",t)},expression:"dataForm.income_file"}},[a("tg-button",{attrs:{type:"link"}},[e._v("上传")])],1),a("tg-button",{attrs:{href:e.incomeTemplateFile,download:"",type:"link"}},[e._v("下载模板")])],1)])]],2)]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(e){e.preventDefault()}}},[e.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{adjust_info:e.dataForm.adjust_info},on:{DataChange:e.onAdjustAccountDataChange}}):e._e()],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("下一步")])]},proxy:!0}])}),a("tg-mask-loading",{attrs:{visible:e.saveLoading||e.uploadLoading,content:e.uploadLoading?"正在上传/解析文件，请稍候...":"正在保存，请稍候..."}})],1)},te=[],ae=a(74750),ne=(0,i.defineComponent)({name:"Step2MCN",components:{TgAdjustAccountForm:T.Z,SettlementStep2Layout:$.Z,CardLayout:A.Z,TopCard:M.Z},setup(e,t){const a=(0,i.ref)(!1),n=(0,i.ref)(!1),o=["技术服务费","专项服务费","服务费","其他费用"],l=(0,i.inject)("settlement")??(0,i.ref)(void 0),r=(0,i.ref)(l.value?.excel_data??[]),c=(0,i.ref)({id:l.value?.id??-1,settlement_type:l.value?.settlement_type??s.kX.common_mcn_taobao_cps,income_amount:l.value?.income_amount??0,income_file:l.value?.income_file??"",adjust_info:l.value?.adjust_info??[],is_include_tax:1,tax_amount:"",tax_rate:"6",tax_included_amount:"",tax_excluded_amount:""}),u=(0,i.ref)((0,x.I8)(c.value)),d=(0,i.computed)((()=>{let e=new(L())(c.value.income_amount?c.value.income_amount:0);return c.value.adjust_info?.forEach((t=>{let a=t.adjust_amount?t.adjust_amount:0;a=isNaN(Number(a))?0:a,e=new(L())(a).add(e)})),e.toString()})),m=(0,i.computed)((()=>{let e;try{e=new URL("https://data.goumee.com")}catch{console.log(`current url = ${e}`)}const t=e?.protocol,a=e?.hostname;return`${t}//${a}`})),f=(0,i.computed)((()=>`${c.value.income_file}?Authorization=${(0,ae.LP)()}`)),g=(0,i.computed)((()=>{switch(c.value.settlement_type){case s.kX.common_mcn_douyin_cps:return`${m.value}/template/settlement/douyin_cps_template.xlsx`;case s.kX.common_mcn_taobao_cps:return`${m.value}/template/settlement/taobao_cps_template.xlsx`;case s.kX.common_mcn_vtask:return`${m.value}/template/settlement/v_task_template.xlsx`;default:return""}})),y=(0,i.ref)(!1),h={prev:()=>{h.isModified()?h.saveSettlementDataRequest(s.GG.prev):t.emit("prev")},next:()=>{h.saveSettlementDataRequest()},checkDataForSave:()=>h.isTypeIn()?c.value.adjust_info?.find((e=>isNaN(Number(e.adjust_amount))))?(t.root.$message.warning("请输入正确的调整金额"),!1):c.value.adjust_info?.find((e=>0===Number(e.adjust_amount)&&e.adjust_amount))?(t.root.$message.warning("调整金额不能为0"),!1):c.value.adjust_info?.find((e=>!e.adjust_amount&&e.adjust_reason||e.adjust_amount&&!e.adjust_reason))?(t.root.$message.warning("请完善手工调账信息"),!1):!(Number(d.value)<=0)||(t.root.$message.warning("总结算金额不能小于等于0"),!1):(t.root.$message.warning("至少填写一个结算项"),!1),formatAmount:W.dN,isTypeIn:()=>!!c.value.income_file||!!c.value.adjust_info?.find((e=>e.adjust_amount||e.adjust_reason)),isModified:()=>{const e=JSON.stringify(u.value),t=JSON.stringify(c.value);return e!==t},isSpecialIncomeData:e=>{const t=o.find((t=>t===e.name));return!!t},isLastSpecialIncomeData:(e,t)=>{const a=o.find((t=>t===e.name)),n=r.value[t+1],i=o.find((e=>e===n?.name));return!(!a||i)},onAdjustAccountDataChange:e=>{c.value.adjust_info=e},uploadFileHandler:async e=>{const a=e.file;if(a.size>31457280)return void t.root.$message.error("上传文件大小不能超过 30MB!");const o=new FormData,i=e.file.name;let l;o.append("file",e.file,i),o.append("id",String(c.value.id)),n.value=!0;try{switch(c.value.settlement_type){case s.kX.common_mcn_taobao_cps:l=await(0,v.KZ)(o);break;case s.kX.common_mcn_douyin_cps:l=await(0,v.yJ)(o);break;case s.kX.common_mcn_vtask:l=await(0,v.Ss)(o);break;default:break}}catch(u){return void(n.value=!1)}n.value=!1,l?.data.success?(c.value.income_amount=l?.data.data.income_amount,c.value.income_file=l.data.data.income_file,r.value=l.data.data.excel_data??[],t.root.$message.success("上传成功")):t.root.$message.error(l?.data.message??"上传/解析失败，稍后重试")},downloadFile:e=>{if(!e)return;const a={headers:{Authorization:(0,ae.LP)()??""}};fetch(e,a).then((async a=>{const n=a.clone();try{const e=await n.json();t.root.$message.error(e.message)}catch{if(200===a.status){const t=await a.blob(),n=decodeURIComponent(e.split("/")[e.split("/").length-1]);(0,_.uA)(t,n)}else t.root.$message.error("下载失败")}}))},confirmBeforeClose:async()=>h.isModified(),saveBeforeClose:()=>h.saveSettlementDataRequest(s.GG.close),fillForm:e=>{if(y.value=!0,e){const t=e.tax_rate?.toString()?e.tax_rate?.toString():"6";c.value.id=e?.id??-1,c.value.settlement_type=e?.settlement_type??s.kX.common_mcn_taobao_cps,c.value.income_amount=e?.income_amount??0,c.value.income_file=e?.income_file??"",c.value.adjust_info=e?.adjust_info??[],r.value=e.excel_data??[],c.value.is_include_tax=0===e.is_include_tax?0:1,c.value.tax_amount=e.tax_amount?.toString(),c.value.tax_rate=t,c.value.tax_included_amount=e.tax_included_amount?.toString(),c.value.tax_excluded_amount=e.tax_excluded_amount?.toString(),u.value.is_include_tax=0===e.is_include_tax?0:1}},saveSettlementDataRequest:async(e=s.GG.next)=>{if(e===s.GG.next){if(!h.checkDataForSave())return;if(!h.isModified()&&(0===l.value?.is_include_tax||1===l.value?.is_include_tax))return void t.emit("next")}const n={id:c.value.id,step:e===s.GG.next?s.br.step_three:s.br.step_two,total_settle_amount:d.value,income_amount:c.value.income_amount,income_file:c.value.income_file,adjust_info:c.value.adjust_info?.filter((e=>e.adjust_amount||e.adjust_reason)),is_include_tax:c.value.is_include_tax,tax_amount:c.value.tax_amount,tax_rate:""===c.value.tax_rate?"0":c.value.tax_rate??"0",tax_included_amount:c.value.tax_included_amount,tax_excluded_amount:c.value.tax_excluded_amount};a.value=!0;const o=await(0,v.Ys)(n,p.WD.mcn);if(a.value=!1,o.data.success){switch(e){case s.GG.next:t.emit("next",o.data.data),t.root.$message.success("保存成功");break;case s.GG.prev:t.emit("prev",o.data.data);break;default:t.root.$message.success("保存成功");break}return!0}return t.root.$message.error(o.data.message??"保存失败"),!1}};(0,i.onMounted)((()=>{u.value=(0,x.I8)(c.value)}));const b=e=>{c.value.is_include_tax=e},w=e=>{c.value.tax_rate=e},C=e=>{c.value.is_include_tax=e.is_include_tax,c.value.tax_rate=e.tax_rate?.toString()??"",c.value.tax_included_amount=e.tax_included_amount?.toString()??"",c.value.tax_excluded_amount=e.tax_excluded_amount?.toString()??"",c.value.tax_amount=e.tax_amount?.toString()??""};return{taxedChangedHandler:b,taxRateChanged:w,taxValueChangeHandler:C,ShowAdjustInfo:y,total_settle_amount:d,excelData:r,saveLoading:a,uploadLoading:n,dataForm:c,incomeFileDownload:f,incomeTemplateFile:g,...h}}}),oe=ne,ie=(0,k.Z)(oe,ee,te,!1,null,"32743546",null),se=ie.exports,le=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("SettlementStep3Layout",{staticClass:"tg-settlement-submit-form",class:1===e.injectSettlement.is_estimate?"is_estimate":"",attrs:{amount:e.formatAmount(e.settlementDetail.total_settle_amount,"None")},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+e.settlementDetail.total_settle_amount.toString(),taxed:e.DataForm.is_include_tax,tax_rate:e.DataForm.tax_rate,name:e.DataForm.company_name,type:"value2"}})]},proxy:!0},{key:"left",fn:function(){return[a("card-layout",{staticStyle:{height:"100%"},attrs:{padding:[18,0,0]},scopedSlots:e._u([{key:"title",fn:function(){return[a("span",[e._v("收入信息")])]},proxy:!0}])},[[a("div",{staticStyle:{display:"flex","justify-content":"space-between",padding:"0 18px",height:"18px","line-height":"18px"}},[a("span",{staticStyle:{color:"#6a7b92"}},[e._v("收入")]),a("span",{staticClass:"form-content-income"},[e._v(" "+e._s(e.formatAmount(e.settlementDetail.income_amount,"None"))+" 元 ")])]),e.settlementDetail.excel_data.length?a("div",{staticStyle:{"border-bottom":"1px dashed rgba(164, 178, 194, 0.3)",margin:"12px 18px 0"}}):e._e(),a("div",{staticClass:"form-content-income-list"},e._l(e.settlementDetail.excel_data,(function(t,n){return a("div",{key:n,staticClass:"form-content-income-list-row",style:e.isLastSpecialIncomeData(t,n)?"margin-bottom: 18px":""},[a("el-tooltip",{attrs:{disabled:e.isSpecialIncomeData(t),"open-delay":300,content:t.name,placement:"top",effect:"light"}},[a("span",{staticClass:"line-clamp-1",style:e.isSpecialIncomeData(t)?"max-width: 140px; color: #6A7B92;":"max-width: 140px"},[e._v(e._s(t.name))])]),a("span",{style:-1!==t.value.indexOf("-")?"color: #EC1E1E;":""},[e._v(e._s(e.formatAmount(t.value,"None")))])],1)})),0)]],2)]},proxy:!0},{key:"right",fn:function(){return[a("card-layout",{staticStyle:{height:"100%"},scopedSlots:e._u([{key:"title",fn:function(){return[a("span",[e._v("手工调账")])]},proxy:!0}])},[[a("div",{staticClass:"adjust-account-amount"},[e._v(" 调账 "+e._s(e.settlementDetail.adjust_info.length)+" 笔 ")]),a("div",{staticClass:"adjust-account-money mgt-6"},[a("span",[e._v("共")]),e._v(" "+e._s(e.adjustTotalAmount())+" 元 ")]),e.settlementDetail.adjust_info.length?a("div",{staticClass:"content-dash-line"}):e._e(),e._l(e.settlementDetail.adjust_info,(function(t,n){return a("div",{key:n,staticClass:"mgt-12 content-adjust-account-item"},[a("div",{staticStyle:{display:"flex"}},[a("span",{staticStyle:{"flex-shrink":"1","white-space":"pre"}},[e._v(e._s(n+1+". "))]),e._v(" "+e._s("调整金额："+(t.adjust_amount?e.formatAmount(t.adjust_amount,"None"):"--")+" 元；调整原因："+(t.adjust_reason?t.adjust_reason:"--"))+" ")])])}))]],2)]},proxy:!0},1!==e.injectSettlement.is_estimate?{key:"files",fn:function(){return[a("div",{staticClass:"form-uploaded-file"},[a("el-form",{attrs:{size:"small"}},[e.settlementDetail.income_file?a("el-form-item",{staticClass:"income-form-item",attrs:{label:"收入文件："}},[a("div",[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{"flex-shrink":"0"}},[a("FileItem",{key:1e3,attrs:{showPreview:!1,filepath:e.settlementDetail.income_file,readonly:!0}})],1)])]):e._e(),e.settlementDetail.detail_file?a("el-form-item",{staticClass:"income-form-item mgt-12",attrs:{label:"结算明细："}},[a("div",[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{"flex-shrink":"0"}},[a("FileItem",{key:1001,attrs:{showPreview:!1,filepath:e.settlementDetail.detail_file,readonly:!0}})],1)])]):e._e(),e.settlementDetail.income_file?a("div",{staticStyle:{"border-bottom":"1px solid rgba(164, 178, 194, 0.3)",margin:"18px 0"}}):e._e(),a("el-form-item",{staticClass:"settlement-form-item",attrs:{align:"right","label-width":"70px",prop:"settlement_files"},scopedSlots:e._u([{key:"label",fn:function(){return[a("span",{staticClass:"star"},[e._v("*")]),e._v("结算单：")]},proxy:!0}],null,!1,3202344567)},[a("div",{staticStyle:{display:"flex",height:"32px","align-items":"center"}},[a("div",{staticStyle:{"text-align":"left"}},[a("el-upload",{staticStyle:{width:"120px"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler,accept:".docx,.pdf,.jpg,.jpeg,.png,.xlsx,.xls",disabled:e.settlementDetail.settlement_files.length>=5},model:{value:e.settlementDetail.settlement_files,callback:function(t){e.$set(e.settlementDetail,"settlement_files",t)},expression:"settlementDetail.settlement_files"}},[a("tg-button",{staticClass:"upload-btn",attrs:{icon:"ico-btn-upload",disabled:e.settlementDetail.settlement_files.length>=5}},[e._v("上传文件")])],1)],1),a("div",{staticStyle:{width:"500px",height:"32px","line-height":"32px","font-size":"12px","margin-left":"6px",color:"#a4b2c2","margin-top":"0px","text-align":"left"}},[e._v(" 支持 .docx .pdf .jpg .png .xlsx .xls, 最多上传5个文件(单个文件大小不超过30M) ")])]),a("div",{directives:[{name:"show",rawName:"v-show",value:e.settlementDetail.settlement_files.length,expression:"settlementDetail.settlement_files.length"}],staticClass:"fileList"},e._l(e.settlementDetail.settlement_files,(function(t,n){return a("div",{key:n,staticStyle:{height:"20px","line-height":"20px","margin-top":"12px","margin-bottom":"5px"}},[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{display:"inline-flex",width:"100%"}},[a("FileItem",{key:n,attrs:{showPreview:!1,filepath:t,readonly:!1},on:{remove:function(t){return e.handleRemoveFileClick(n)}}})],1)])})),0)]),a("el-form-item",{staticClass:"settlement-form-item",staticStyle:{"margin-top":"15px","margin-bottom":"30px"},attrs:{label:"关联合同："}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入合同编码","remote-method":e.getContract,size:"medium"},on:{change:function(t){return e.selectContractUidChange(t)}},model:{value:e.cooperation_link_contract_ID,callback:function(t){e.cooperation_link_contract_ID=t},expression:"cooperation_link_contract_ID"}},e._l(e.contract_uids,(function(e){return a("el-option",{key:e.contract_id,attrs:{label:e.sign_type_name+":  "+e.contract_uid+"  ("+e.coop_start_date+"-"+e.coop_end_date+")",value:e.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:null,{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("提交")])]},proxy:!0}],null,!0)}),a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})],1)},re=[],ce=a(12641),ue=a(57412),de=(0,i.defineComponent)({name:"Step3MCN",components:{drawerHeader:ce.Z,SettlementStep3Layout:B.Z,CardLayout:A.Z,TopCard:M.Z},setup(e,t){const a=["技术服务费","专项服务费","服务费","其他费用"];let n;const o=()=>{n=J.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},l=(0,i.inject)("settlement")??(0,i.ref)(void 0),r=()=>({contract_id:l.value?.contract_id??void 0,id:l.value?.id??-1,total_settle_amount:l.value?.total_settle_amount??0,income_amount:l.value?.income_amount??0,income_file:l.value?.income_file??"",settlement_files:l.value?.settlement_files?[...l.value?.settlement_files]:[],adjust_info:l.value?.adjust_info?[...l.value?.adjust_info]:[],detail_file:l.value?.detail_file??"",excel_data:l.value?.excel_data?[...l.value?.excel_data]:[]}),c=(0,i.ref)(r()),d=(0,i.ref)(r()),m=(0,i.ref)(!1),_=(0,i.ref)({company_name:"",tax_rate:"",is_include_tax:1}),f={prev:()=>{f.isModified()?f.saveSettlementDataRequest(!1):t.emit("prev")},next:async()=>{if(0===l.value?.is_estimate&&!c.value.settlement_files.length)return void t.root.$message.warning("请上传结算单扫描件");const e=await(0,H.I)(t,{title:"确定提交结算单吗?",content:()=>(0,i.h)("div",[(0,i.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,i.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});e&&f.submitSettlementDataRequest()},isModified:()=>{const e=JSON.stringify(d.value.settlement_files),t=JSON.stringify(c.value.settlement_files),a=JSON.stringify(d.value.contract_id);return a!==b.value||e!==t},isSpecialIncomeData:e=>{const t=a.find((t=>t===e.name));return!!t},isLastSpecialIncomeData:(e,t)=>{const n=a.find((t=>t===e.name)),o=c.value.excel_data[t+1],i=a.find((e=>e===o?.name));return!(!n||i)},adjustTotalAmount:()=>{let e=new(L())(0);return c.value.adjust_info.forEach((t=>{e=new(L())(t.adjust_amount).add(e)})),(0,W.dN)(e.toString(),"None")},uploadFileHandler:async e=>{const a=e.file;if(a.size>31457280)return void t.root.$message.error("上传文件大小不能超过 30MB!");o();const i=new FormData,s=e.file.name;i.append("file",e.file,s),i.append("type","settlement");const l=await(0,E.$)(i);n.close(),l.data.success?(c.value.settlement_files.push(l.data.data.source),t.root.$message.success("上传成功")):t.root.$message.error(l.data.message??"上传失败，稍后重试")},handleRemoveFileClick:e=>{c.value.settlement_files.splice(e,1)},confirmBeforeClose:async()=>f.isModified(),saveBeforeClose:()=>f.saveSettlementDataRequest(!0),fillForm:e=>{-1!==c.value.id&&(c.value.id=e?.id??-1,c.value.total_settle_amount=e?.total_settle_amount??0,c.value.income_amount=e?.income_amount??0,c.value.income_file=e?.income_file??"",c.value.settlement_files=e?.settlement_files?[...e?.settlement_files]:[],c.value.adjust_info=e?.adjust_info?[...e?.adjust_info]:[],c.value.detail_file=e?.detail_file??"",c.value.excel_data=e?.excel_data?[...e?.excel_data]:[],b.value=e?.contract_id||void 0,_.value.tax_rate=e?.tax_rate?.toString()??"",_.value.is_include_tax=0===e?.is_include_tax?0:1,_.value.company_name=e?.company_name??"")},saveSettlementDataRequest:async e=>{const a={id:c.value.id,step:s.br.step_three,contract_id:b.value||0,settlement_files:c.value.settlement_files};m.value=!0;const n=await(0,v.Ys)(a,p.WD.mcn);return m.value=!1,n.data.success?(e?t.root.$message.success(n.data.message??"保存成功"):t.emit("prev",n.data.data),!0):(t.root.$message.error(n.data.message??"保存失败"),!1)},submitSettlementDataRequest:async()=>{if(0===l.value?.is_estimate&&!c.value.settlement_files.length)return void t.root.$message.warning("请上传结算单扫描件");const e={id:c.value.id,contract_id:b.value||0};0===l.value?.is_estimate&&(e.settlement_files=c.value.settlement_files),m.value=!0;const a=await(0,v.FX)(e);m.value=!1,a.data.success?(t.root.$message.success(a.data.message??"提交结算成功"),t.emit("submit:success")):t.root.$message.error(a.data.message??"提交失败")}};(0,i.onMounted)((()=>{d.value=(0,x.I8)(c.value)}));const g=(0,i.ref)([]),{project_id:y}=(0,u.L)(t),h=async e=>{const t=await(0,V.z0)({search:e,only_main:0,project_id:y.value,contract_status:2,partner_type:1});t.data.success?g.value=t.data.data.data:g.value=[]};h("");const b=(0,i.ref)(void 0),w=e=>{b.value=e},C=e=>ue.Z.basename(e);return{basename:C,contract_uids:g,getContract:h,cooperation_link_contract_ID:b,selectContractUidChange:w,injectSettlement:l,settlementDetail:c,saveLoading:m,formatAmount:W.dN,...f,DataForm:_}}}),me=de,pe=(0,k.Z)(me,le,re,!1,null,"eeb8d1f4",null),_e=pe.exports,ve=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("SettlementStep2Layout",{staticClass:"tg-income-mcn-douyin-step2-before-container",attrs:{topHeightType:"default",leftItemExpand:!0},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+e.total_settlement_amount.toString(),type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("div",{staticClass:"left-content"},[a("div",[a("div",{staticClass:"add-settlement-detail-container"},[a("tg-button",{attrs:{icon:"ico-btn-add",type:"primary",size:"mini",disabled:e.dataForm.company_info_list.length>=6},on:{click:e.addSettlementDetail}},[e._v("新增结算明细")])],1),a("div",{staticStyle:{"margin-top":"2px"}},e._l(e.dataForm.company_info_list,(function(t,n){return a("IncomeDetail",{key:n,staticStyle:{"margin-bottom":"16px"},attrs:{incomeDetail:t,disabledTypeList:e.selectedIncomeTypeList},on:{delSettlementDetail:function(t){return e.delSettlementDetail(n)}}})})),1)])])]},proxy:!0},{key:"right",fn:function(){return[a("el-form",{attrs:{size:"small"},nativeOn:{submit:function(e){e.preventDefault()}}},[a("TgAdjustAccountForm",{attrs:{height:445,ExtendItem:"customer",ExtendItemSelectOptions:e.selectedCompanyList,adjust_info:e.dataForm.adjustInfo},on:{DataChange:e.onAdjustAccountDataChange}})],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.loading,content:e.loadingText}})]},proxy:!0}])})},fe=[],ge=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-component-income-detail"},[a("div",{staticClass:"tg-component-income-detail-header"},[a("el-select",{staticStyle:{width:"146px"},attrs:{value:e.dataForm.type,clearable:"",placeholder:"选择结算方式",size:"mini"},on:{change:e.incomeTypeChanged}},e._l(e.incomeOptions,(function(t){return a("el-option",{key:t.value,attrs:{label:t.label,value:t.value,disabled:e.itemDisabled(t.value)}})})),1),a("div",{staticClass:"desc"},[e._v(e._s(e.desc))])],1),e.current?a("div",{staticClass:"tg-component-income-detail-content"},[a(e.current,{ref:"currentRef",tag:"component",attrs:{feeDetail:e.dataForm}})],1):e._e(),a("tg-icon",{staticClass:"del-button",attrs:{name:"ico-frm-delete",hoverName:"ico-frm-delete-active"},on:{click:e.delSettlementDetail}})],1)},ye=[],he=a(34418),xe=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"tg-income-settlement-component-settlement-detail-douyin-cps"},[a("div",{staticClass:"douyin-cps-content"},[a("div",{staticClass:"customer"},[e._v(e._s(e.company_name)+"：")]),a("div",{staticClass:"income"},[a("span",{staticClass:"label"},[e._v("收入：")]),a("span",{staticClass:"value"},[e._v(e._s(e.formatAmountWithoutPrefix(e.dataForm.income_amount)+" 元"))])])]),a("div",{staticClass:"douyin-cps-bottom"},[a("el-tooltip",{attrs:{disabled:!!e.dataForm.file,content:"上传数据后支持下载",placement:"top",effect:"light"}},[a("tg-button",{staticStyle:{"font-size":"14px"},attrs:{disabled:!e.dataForm.file,type:"link"},on:{click:function(t){return e.downloadDataFile(e.dataForm.file)}}},[e._v("下载原始数据")])],1),a("span",{staticClass:"hor-line"}),a("el-upload",{attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler},model:{value:e.dataForm.file,callback:function(t){e.$set(e.dataForm,"file",t)},expression:"dataForm.file"}},[a("tg-button",{staticStyle:{"font-size":"14px"},attrs:{type:"link"}},[e._v("上传")])],1),a("span",{staticClass:"hor-line"}),a("tg-button",{staticStyle:{"font-size":"14px"},attrs:{type:"link"},on:{click:e.downTempFile}},[e._v("下载模板")])],1),a("tg-mask-loading",{attrs:{visible:e.uploadLoading,content:"正在上传，请稍候..."}})],1)},be=[],we=a(42413),Ce=(0,i.defineComponent)({props:{feeDetail:{type:Object}},setup(e,t){const a=(0,i.computed)((()=>e.feeDetail)),n=(0,i.computed)((()=>{let t=a.value?.company_name;if(!t)switch(e.feeDetail?.type){case s.eY.head_service_fee:t="北京巨量引擎网络技术有限公司";break;case s.eY.douyin_cps:t="北京巨量引擎网络技术有限公司";break;case s.eY.xingtu:t="武汉巨量星图科技有限公司";break}return t})),o=(0,i.ref)(!1),{downloadFileHandler:l}=(0,we.r7)(t),r=(0,i.computed)((()=>{let e;try{e=new URL("https://data.goumee.com")}catch{console.log(`current url = ${e}`)}const t=e?.protocol,a=e?.hostname;return`${t}//${a}`})),c={downTempFile:()=>{let e="";switch(a.value?.type){case s.eY.head_service_fee:e="https://tiange-oss.oss-cn-hangzhou.aliyuncs.com/upload_template/group_template.xlsx";break;case s.eY.xingtu:e="https://tiange-oss.oss-cn-hangzhou.aliyuncs.com/upload_template/xingtu_template.xlsx";break;case s.eY.douyin_cps:e=`${r.value}/template/settlement/douyin_cps_template.xlsx`;break}window.open(e)},downloadDataFile:()=>{a.value?.file&&l(a.value?.file??"")},uploadFileHandler:async e=>{const i=e.file;if(i.size>31457280)return void t.root.$message.error("上传文件大小不能超过 30MB!");const l=new FormData,r=e.file.name;let c;l.append("file",e.file,r);let u="douyin";o.value=!0;try{switch(a.value?.type){case s.eY.xingtu:u="xingtu";break;case s.eY.douyin_cps:u="douyin";break;case s.eY.head_service_fee:u="head_fee";break;default:break}c=await(0,v.YB)(l,u)}catch(d){return void(o.value=!1)}o.value=!1,c?.data.success?(a.value&&(a.value.income_amount=`${c?.data.data.income_amount??0}`,a.value.file=c.data.data.income_file,a.value.company_name=n.value??""),t.root.$message.success("上传成功")):t.root.$message.error(c?.data.message??"上传/解析失败，稍后重试")},formatAmountWithoutPrefix:W.FU,reset:()=>{a.value&&(a.value.company_id="",a.value.company_name="",a.value.income_amount=void 0,a.value.file=void 0)}};return{company_name:n,uploadLoading:o,dataForm:a,...c}}}),ke=Ce,Se=(0,k.Z)(ke,xe,be,!1,null,null,null),De=Se.exports,je=a(26037),Fe=(0,i.defineComponent)({emits:["delSettlementDetail"],props:{disabledTypeList:{type:Array},incomeDetail:{type:Object}},components:{PitFee:he.Z,DouyinCPS:De,OtherIncome:je.Z},setup(e,t){const a=(0,i.computed)((()=>{const e=[];return s.Ti.forEach(((t,a)=>{e.push({label:t,value:a})})),e})),n=(0,i.ref)(void 0),o=(0,i.computed)((()=>e.incomeDetail)),l=(0,i.computed)((()=>{if(o.value)switch(o.value.type){case s.eY.pit_fee:return he.Z;case s.eY.head_service_fee:case s.eY.douyin_cps:case s.eY.xingtu:return De;case s.eY.shangguang:case s.eY.other:return je.Z}})),r=(0,i.computed)((()=>{if(o.value)switch(o.value.type){case s.eY.pit_fee:return"坑位费 = 结算周期内全部场次商品收入坑位费总和";case s.eY.head_service_fee:return"团长服务费 = 周期内达人通过团长活动产生的服务费";case s.eY.douyin_cps:return"CPS收入 = 上传文件中所有收入金额合计";case s.eY.xingtu:return"星图收入 = 上传文件中所有收入金额合计";case s.eY.shangguang:return"商广收入 = 填写的所有收入金额合计";case s.eY.other:return"其他收入 = 填写的所有收入金额合计"}})),c={incomeTypeChanged:e=>{if(n.value?.reset(),o.value){o.value.type=e;let t="";switch(o.value.type){case s.eY.head_service_fee:t="北京巨量引擎网络技术有限公司";break;case s.eY.douyin_cps:t="北京巨量引擎网络技术有限公司";break;case s.eY.xingtu:t="武汉巨量星图科技有限公司";break}o.value.company_name=t}t.emit("incomeTypeChanged",e)},delSettlementDetail:()=>{t.emit("delSettlementDetail")},itemDisabled:t=>(e.disabledTypeList??[]).includes(t)};return{currentRef:n,desc:r,incomeOptions:a,current:l,dataForm:o,...c}}}),$e=Fe,Ae=(0,k.Z)($e,ge,ye,!1,null,null,null),Te=Ae.exports;const Ne=()=>({company_id:"",company_name:"",file:void 0,income_amount:"",type:void 0,company_list:[]});var Le=(0,i.defineComponent)({props:{},components:{TopCard:M.Z,TgAdjustAccountForm:T.Z,CardLayout:A.Z,SettlementStep2Layout:$.Z,IncomeDetail:Te},setup(e,t){const a=(0,i.ref)(!1),n=(0,i.ref)(""),o=(0,i.inject)("settlement")??(0,i.ref)(void 0),l=(0,i.computed)((()=>{const e=(0,x.I8)(o.value);return e})),r=(0,i.ref)({adjustInfo:l.value?.adjust_info??[],company_info_list:l.value.json_data?.company_info_list??[Ne()]}),c=(0,i.computed)((()=>r.value.company_info_list?.map((e=>e.type))??[])),u=(0,i.computed)((()=>{const e=[],t=t=>!!e.find((e=>e.name===t));return r.value.company_info_list?.forEach((a=>{a.company_name&&!t(a.company_name)&&e.push({id:a.company_id,name:a.company_name}),a.company_list?.forEach((a=>{a.company_name&&!t(a.company_name)&&e.push({id:a.company_id,name:a.company_name})}))})),e})),d=(0,i.ref)((0,x.I8)(r.value)),m=(0,i.computed)((()=>{let e=new(L())(0);return r.value.adjustInfo?.forEach((t=>{let a=t.adjust_amount?t.adjust_amount:0;a=isNaN(Number(a))?0:a,e=new(L())(a).add(e)})),r.value.company_info_list?.forEach((t=>{let a=t.income_amount?t.income_amount:"0";a=isNaN(Number(a))?"0":a,e=new(L())(a).add(e),t.company_list?.forEach((t=>{let a=t.income_amount?t.income_amount:"0";a=isNaN(Number(a))?"0":a,e=new(L())(a).add(e)}))})),e.toFixed(2)})),f={prev:()=>{f.isModified()?f.saveSettlementRequest(s.GG.prev):t.emit("prev")},next:()=>{f.saveSettlementRequest(s.GG.next)},setLoadingAndText:e=>{switch(e){case"save":a.value=!0,n.value="正在保存，请稍候...";break;case"upload":a.value=!0,n.value="正在上传，请稍候...";break;case"detail":a.value=!0,n.value="正在获取详情，请稍候...";break;case"reload":a.value=!0,n.value="正在刷新，请稍候...";break;case"none":a.value=!1,n.value="";break}},checkDataForSave:()=>{if(!l.value?.id)return!1;let e=!0,a="";return r.value.company_info_list?.forEach((t=>{switch(t.type){case s.eY.head_service_fee:t.income_amount||(a="团长服务费不能为0，请重新上传文件",e=!1);break;case s.eY.douyin_cps:t.income_amount||(a="抖音CPS收入不能为0，请重新上传文件",e=!1);break;case s.eY.xingtu:t.income_amount||(a="星图收入不能为0，请重新上传文件",e=!1);break;case s.eY.pit_fee:case s.eY.shangguang:case s.eY.other:{const n=t.company_list?.find((e=>!e.company_name&&e.income_amount||e.company_name&&!e.income_amount||!e.company_name&&!e.income_amount));(n||t.type===s.eY.pit_fee&&0===(t.company_list??[]).length)&&(e=!1,t.type===s.eY.pit_fee?a="请完善坑位费数据信息":t.type===s.eY.shangguang?a="请完善商广收入数据信息":t.type===s.eY.other&&(a="请完善其他收入数据信息"));break}default:break}})),e?r.value.adjustInfo?.find((e=>isNaN(Number(e.adjust_amount))))?(t.root.$message.warning("请输入正确的调整金额"),!1):r.value.adjustInfo?.find((e=>0===Number(e.adjust_amount)&&e.adjust_amount))?(t.root.$message.warning("调整金额不能为0"),!1):r.value.adjustInfo?.find((e=>(e.adjust_amount||e.adjust_reason||e.company_name)&&(!e.adjust_amount||!e.adjust_reason||!e.company_name)))?(t.root.$message.warning("请完善手工调账信息"),!1):!!f.settlementDetailToAdjustCompanyValidate()&&(Number(m.value)<=0?(t.root.$message.warning("总结算金额不能小于等于0"),!1):!!f.isModified()||(t.emit("next"),!1)):(t.root.$message.warning(a),!1)},isModified:()=>{const e=JSON.stringify(d.value),t=JSON.stringify(r.value);return e!==t},confirmBeforeClose:async()=>f.isModified(),saveBeforeClose:()=>f.saveSettlementRequest(s.GG.close),onAdjustAccountDataChange:e=>{r.value.adjustInfo=e},getPositiveRateNumber:e=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],formatAmount:e=>(0,W.dN)(e,"None"),uploadFileHandler:async e=>{const a=new FormData,n=e.file.name;a.append("file",e.file,n),a.append("settlement_id",String(l.value?.id)),f.setLoadingAndText("upload");const o=await(0,v._9)(a);f.setLoadingAndText("none"),o?.data.success?t.root.$message.success("上传成功"):t.root.$message.error(o?.data.message??"上传失败，稍后重试")},downloadAPIFileHandler:(e,a)=>{fetch(e).then((async e=>{const n=e.clone();try{const e=await n.json();t.root.$message.error(e.message)}catch{if(200===e.status){const t=await e.blob();(0,_.uA)(t,a)}else t.root.$message.error("下载失败")}}))},saveSettlementRequest:async e=>{if(e===s.GG.next&&!f.checkDataForSave())return;const a={id:l.value.id,step:e===s.GG.next?s.br.step_three:s.br.step_two,total_settle_amount:m.value,adjust_info:r.value.adjustInfo.filter((e=>e.adjust_amount||e.adjust_reason)),json_data:{company_info_list:(r.value.company_info_list??[]).filter((e=>e.type&&(e.type!==s.eY.pit_fee||e.type===s.eY.pit_fee&&(e.company_list??[]).length>0))),nofind:[]}};f.setLoadingAndText("save");const n=await(0,v.Ys)(a,p.WD.mcn);if(f.setLoadingAndText("none"),n.data.success)switch(e){case s.GG.prev:t.emit("prev",n.data.data);break;case s.GG.next:t.emit("next",n.data.data),t.root.$message.success(n.data.message??"保存成功");break;case s.GG.close:return t.root.$message.success("保存成功"),!0;default:break}else t.root.$message.error(n.data.message??"保存失败");return!1},addSettlementDetail:()=>{r.value.company_info_list?.unshift(Ne())},delSettlementDetail:e=>{r.value.company_info_list?.splice(e,1)},settlementDetailToAdjustCompanyValidate:()=>{let e=r.value.adjustInfo.map((e=>e.company_name)).filter((e=>void 0!==e&&""!==e));if(e.length){e=Array.from(new Set(e));let a=0;return e.forEach(((e,t)=>{r.value.company_info_list?.forEach((n=>{if(a===t)if(n.company_name)e===n.company_name&&(a+=1);else{const t=n.company_list?.find((t=>t.company_name===e));t&&(a+=1)}}))})),a===e.length||(t.root.$message.warning("手工调账中部分公司在左边没有对应结算数据，请删除后再进行下一步操作"),!1)}return!0}};return(0,i.onMounted)((()=>{d.value=(0,x.I8)(r.value)})),{selectedCompanyList:u,total_settlement_amount:m,loading:a,loadingText:n,dataForm:r,selectedIncomeTypeList:c,...f}}}),Ie=Le,Me=(0,k.Z)(Ie,ve,fe,!1,null,null,null),Re=Me.exports,Ye=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("SettlementStep3Layout",{staticClass:"settlement-step3-mcn-douyin-before",attrs:{topHeightType:"default",leftItemWidth:600},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+e.settlement.total_settle_amount,type:"default"}})]},proxy:!0},{key:"left",fn:function(){return[a("div",{staticClass:"before-customer-list"},e._l(e.company_info,(function(t,n){return a("div",{key:n,staticClass:"before-customer"},[n>0?a("div",{staticClass:"hr"}):e._e(),a("div",{staticClass:"before-customer-name",staticStyle:{"margin-bottom":"4px"}},[e._v(" "+e._s(t.company_name)+" ")]),e._l(e.incomeNameTypes,(function(n,o){return a("div",{directives:[{name:"show",rawName:"v-show",value:e.amountDetail(n.type,t.amount_info_list),expression:"amountDetail(item.type, company.amount_info_list)"}],key:o,staticClass:"before-income-row mgt-12"},[a("div",{staticClass:"before-income-row-detail"},[a("span",{staticClass:"label"},[e._v(e._s(n.name)+"：")]),a("span",{staticClass:"value"},[e._v(e._s(e.income_amount(n.type,t.amount_info_list))+" 元")]),0===o?a("tg-button",{staticClass:"downerload",attrs:{type:"link"},on:{click:function(){return e.onDownloadPitFeeDetail(t)}}},[e._v("下载明细")]):e._e(),o<=3&&o>0?a("tg-button",{staticClass:"downerload",attrs:{type:"link"},on:{click:function(){return e.onDownloadDetail(n.type,t.amount_info_list)}}},[e._v("下载明细")]):e._e()],1),5===o&&e.remark(n.type,t.amount_info_list)?a("div",{staticClass:"other-desc"},[e._v(" "+e._s(e.remark(n.type,t.amount_info_list))+" ")]):e._e()])})),t.adjust_info&&t.adjust_info.length?a("div",{staticClass:"before-adjust-info mgt-12"},e._l(t.adjust_info,(function(t,n){return a("div",{key:n},[a("div",{staticClass:"mgt-12"},[a("span",{staticClass:"label"},[e._v("手工调账：")]),a("span",{staticClass:"value"},[e._v(e._s(e.formatAmountWithoutPrefix(t.adjust_amount))+" 元")])]),a("div",{staticClass:"other-desc"},[e._v(e._s(t.adjust_reason))])])})),0):e._e()],2)})),0)]},proxy:!0},e.readonly?null:{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("生成结算单")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在生成结算单，请稍候..."}})]},proxy:!0}],null,!0)})},Ze=[],Oe=a(67957),Pe=(0,i.defineComponent)({props:{readonly:{type:Boolean,default:!1}},components:{TopCard:M.Z,CardLayout:A.Z,SettlementStep3Layout:$.Z},setup(e,t){const{downloadFileHandler:a}=(0,we.r7)(t),n=(0,i.computed)((()=>{const e=[];return s.Ti.forEach(((t,a)=>{e.push({type:a,name:t})})),e})),o=(0,i.ref)(!1),l=(0,i.inject)("settlement")??(0,i.ref)(void 0),r=(0,i.computed)((()=>l.value?.company_info_json??[])),c={prev:async()=>{t.emit("prev")},next:async()=>{const e=await(0,H.I)(t,{title:"确定生成结算单吗?",content:()=>(0,i.h)("div",[(0,i.h)("div","将对本次结算生成对应的结算单"),(0,i.h)("div","是否需要生成？")]),confirmText:"确定",cancelText:"取消"});e&&c.getSubCostSettlement()},saveBeforeClose:async()=>!1,confirmBeforeClose:async()=>!1,getSubCostSettlement:async()=>{if(!l.value?.id)return;o.value=!0;const e=await(0,v.b7)({settlement_id:l.value?.id});o.value=!1,e.data.success?(t.root.$message.success(e.data.message??"生成结算单成功"),t.emit("submit:success")):t.root.$message.error(e.data.message??"生成结算单失败")},amountDetail:(e,t)=>t.find((t=>t.type===e)),income_amount:(e,t)=>(0,W.FU)(c.amountDetail(e,t)?.amount??0),remark:(e,t)=>c.amountDetail(e,t)?.remark,onDownloadDetail:(e,t)=>{const n=c.amountDetail(e,t)?.file;n&&a(n)},onDownloadPitFeeDetail:e=>{window.open((0,Oe.e2)(l.value?.id,e.company_id))},formatAmountWithoutPrefix:W.FU};return{company_info:r,incomeNameTypes:n,saveLoading:o,settlement:l,...c}}}),qe=Pe,ze=(0,k.Z)(qe,Ye,Ze,!1,null,null,null),Be=ze.exports,We=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("Step2Layout",{staticClass:"settlement-step2-mcn-after-douyin-cps",attrs:{amount:e.total_amount_str,leftItemExpand:!0},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:e.total_amount,taxed:e.DataForm.is_include_tax,type:"value1",tax_rate_disabled:!1,tax_rate:e.DataForm.tax_rate},on:{taxRateChanged:e.taxRateChanged,taxedChanged:e.taxedChangedHandler,valueChange:e.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("CardLayout",{staticClass:"settlement-left-block",attrs:{"element-loading-background":"rgba(0, 0, 0, 0.25)"},scopedSlots:e._u([{key:"title",fn:function(){return[a("div",[a("span",[e._v(e._s(e.settlement.company_name||e.unityData&&e.unityData.company_name))])])]},proxy:!0}])},[a("div",{staticClass:"amount-info-list"},[e._l(e.incomeNameTypes,(function(t,n){return a("div",{key:n},[1!==t.type&&5!==t.type&&6!==t.type||!e.amountDetail(t.type)?e._e():a("div",[a("div",{staticClass:"input-row mgb-12"},[a("span",{staticClass:"label label-42"},[e._v(e._s(t.name))]),a("el-input",{staticStyle:{width:"240px",margin:"0 32px 0 12px"},attrs:{placeholder:"填写收入",value:e.income_amount(t.type),size:"small"},on:{input:function(a){return e.onIncomeAmountChanged(a,t.type)}}},[a("template",{slot:"append"},[e._v("元")])],2),1===t.type?a("tg-button",{attrs:{type:"link"},on:{click:e.downPitFeeDetail}},[e._v("下载明细")]):e._e()],1),a("div",[6===t.type?a("el-input",{staticStyle:{width:"360px",height:"80px","margin-left":"54px"},attrs:{value:e.remark(t.type),type:"textarea",placeholder:"请输入其他收入说明",maxlength:50,resize:"none"},on:{input:function(a){return e.remarkChanged(a,t.type)}}}):e._e()],1)]),!e.amountDetail(t.type)||2!==t.type&&3!==t.type&&4!==t.type?e._e():a("div",[a("div",[a("span",{staticClass:"label",class:4===t.type?"label-42":""},[e._v(e._s(t.name)+"：")]),a("span",{staticClass:"value"},[e._v(e._s(e.formatAmountWithoutPrefix(e.income_amount(t.type)))+" 元")])]),a("div",{staticClass:"douyin-cps-bottom",class:5!==n?"bottom-line":""},[a("el-tooltip",{attrs:{disabled:!!e.file(t.type),content:"上传数据后支持下载",placement:"top",effect:"light"}},[a("tg-button",{attrs:{disabled:!e.file(t.type),type:"link"},on:{click:function(a){return e.downloadDataFile(t.type)}}},[e._v("下载原始数据")])],1),a("span",{staticClass:"hor-line"}),a("el-upload",{attrs:{vlue:e.file(t.type),action:"/",multiple:!1,"show-file-list":!1,"http-request":function(a){return e.uploadFileHandler(a,t.type)}}},[a("tg-button",{attrs:{type:"link"}},[e._v("上传")])],1),a("span",{staticClass:"hor-line"}),a("tg-button",{attrs:{type:"link"},on:{click:function(a){return e.downTempFile(t.type)}}},[e._v("下载模板")])],1)])])})),e.unityData&&10===e.unityData.type?a("div",[a("div",[a("el-form",{attrs:{size:"mini","label-position":"left","label-width":"120px"}},[a("el-form-item",{attrs:{label:"总GMV："}},[a("el-input",{staticStyle:{width:"250px"},attrs:{disabled:""},model:{value:e.unityData.total_gmv,callback:function(t){e.$set(e.unityData,"total_gmv",t)},expression:"unityData.total_gmv"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1),2===e.unityData.version?[a("el-form-item",{attrs:{label:"总佣金："}},[a("el-input",{staticStyle:{width:"250px"},attrs:{disabled:""},model:{value:e.unityData.shop_commission_amount,callback:function(t){e.$set(e.unityData,"shop_commission_amount",t)},expression:"unityData.shop_commission_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1),a("el-form-item",{attrs:{label:"机构佣金："}},[a("el-input",{staticStyle:{width:"250px"},attrs:{disabled:""},model:{value:e.unityData.commission_amount,callback:function(t){e.$set(e.unityData,"commission_amount",t)},expression:"unityData.commission_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1),a("el-form-item",{attrs:{label:"达人佣金："}},[a("el-input",{staticStyle:{width:"250px"},attrs:{disabled:""},model:{value:e.unityData.kol_commission_amount,callback:function(t){e.$set(e.unityData,"kol_commission_amount",t)},expression:"unityData.kol_commission_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1),a("el-form-item",{attrs:{label:"技术服务费："}},[a("el-input",{staticStyle:{width:"250px"},attrs:{disabled:""},model:{value:e.unityData.tech_service_fee_amount,callback:function(t){e.$set(e.unityData,"tech_service_fee_amount",t)},expression:"unityData.tech_service_fee_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1)]:e._e(),a("el-form-item",{attrs:{label:"退货率："}},[a("el-input",{staticStyle:{width:"250px"},on:{input:e.refundRateHandler},model:{value:e.unityData.refund_rate,callback:function(t){e.$set(e.unityData,"refund_rate",t)},expression:"unityData.refund_rate"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("%")])])],1),a("el-form-item",{attrs:{label:"平均佣金比例："}},[a("el-input",{staticStyle:{width:"250px"},attrs:{disabled:""},model:{value:e.unityData.commission_rate,callback:function(t){e.$set(e.unityData,"commission_rate",t)},expression:"unityData.commission_rate"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("%")])])],1),a("el-form-item",{attrs:{label:"收入："}},[a("el-input",{staticStyle:{width:"250px"},attrs:{disabled:"",value:e.unityData.amount}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1),a("el-form-item",{attrs:{label:"订单明细："}},e._l(e.unityData.file.split(","),(function(t){return a("div",{key:t},[a("span",[e._v(e._s(t.split("/")[t.split("/").length-1]))]),a("tg-button",{attrs:{disabled:!e.file(10),type:"link"},on:{click:function(a){return e.downloadUnityDataFile(t)}}},[e._v("下载")])],1)})),0)],2)],1)]):e._e()],2)])]},proxy:!0},{key:"right",fn:function(){return[a("div",[a("el-form",{attrs:{size:"small","label-width":"68px"},nativeOn:{submit:function(e){e.preventDefault()}}},[a("TgAdjustAccountForm",{attrs:{adjust_info:e.DataForm.adjust_info},on:{DataChange:e.onAdjustAccountDataChange}})],1)],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}])})},Ee=[],He=(0,i.defineComponent)({components:{TopCard:M.Z,CardLayout:A.Z,Step2Layout:$.Z,TgAdjustAccountForm:T.Z},setup(e,t){const a=(0,i.ref)(!1),{downloadFileHandler:n}=(0,we.r7)(t),o=(0,i.computed)((()=>{const e=[];return s.Ti.forEach(((t,a)=>{e.push({type:a,name:t})})),e})),l=(0,i.ref)(!1),r=(0,i.inject)("settlement")??(0,i.ref)(void 0),c=(0,i.ref)({}),u=(0,i.ref)({adjust_info:r.value?.adjust_info??[],is_include_tax:void 0!==r.value?.is_include_tax&&null!==r.value?.is_include_tax?r.value.is_include_tax:1,tax_amount:r.value?.tax_amount?`${r.value.tax_amount}`:"",tax_rate:void 0===r.value?.tax_rate||null===r.value?.tax_rate?"6":`${r.value.tax_rate}`,tax_included_amount:r.value?.tax_included_amount?`${r.value.tax_included_amount}`:"",tax_excluded_amount:r.value?.tax_excluded_amount?`${r.value.tax_excluded_amount}`:"",amount_info_list:r.value?.json_data?.amount_info_list??[]}),d=(0,i.ref)((0,x.I8)(u.value)),m=(0,i.computed)((()=>{let e=new(L())(0);return u.value.adjust_info?.forEach((t=>{let a=t.adjust_amount?t.adjust_amount:0;a=isNaN(Number(a))?0:a,e=new(L())(a).add(e)})),u.value.amount_info_list?.forEach((t=>{let a=t.amount?t.amount:0;a=isNaN(Number(a))?0:a,e=new(L())(a).add(e)})),e.toFixed(2)})),_=(0,i.computed)((()=>(0,W.SJ)(new(L())(m.value)))),f=(0,i.computed)((()=>{let e;try{e=new URL("https://data.goumee.com")}catch{console.log(`current url = ${e}`)}const t=e?.protocol,a=e?.hostname;return`${t}//${a}`})),g={prev:()=>{g.isModified()?g.saveSettlementDataRequest(s.GG.prev):t.emit("prev")},next:()=>{g.saveSettlementDataRequest()},isTypeIn:()=>!!u.value.adjust_info?.find((e=>e.adjust_amount||e.adjust_reason)),checkDataForSave:()=>{let e=!0,a="";return u.value.amount_info_list?.forEach((t=>{switch(t.type){case s.eY.head_service_fee:t.amount||(a="团长服务费不能为0，请重新上传文件",e=!1);break;case s.eY.douyin_cps:t.amount||(a="抖音CPS收入不能为0，请重新上传文件",e=!1);break;case s.eY.xingtu:t.amount||(a="星图收入不能为0，请重新上传文件",e=!1);break;case s.eY.pit_fee:case s.eY.shangguang:case s.eY.other:{const n=void 0===t.amount||null===t.amount||""===t.amount;n&&(e=!1,t.type===s.eY.pit_fee?a="请完善坑位费数据信息":t.type===s.eY.shangguang?a="请完善商广收入数据信息":t.type===s.eY.other&&(a="请完善其他收入数据信息"));break}default:break}})),e?u.value.adjust_info?.find((e=>isNaN(Number(e.adjust_amount))))?(t.root.$message.warning("请输入正确的调整金额"),!1):u.value.adjust_info?.find((e=>0===Number(e.adjust_amount)&&e.adjust_amount))?(t.root.$message.warning("调整金额不能为0"),!1):u.value.adjust_info?.find((e=>!e.adjust_amount&&e.adjust_reason||e.adjust_amount&&!e.adjust_reason))?(t.root.$message.warning("请完善手工调账信息"),!1):!(Number(m.value)<0)||(t.root.$message.warning("总结算金额不能小于0"),!1):(t.root.$message.warning(a),!1)},taxRateChanged:e=>{u.value.tax_rate=e},taxedChangedHandler:e=>{u.value.is_include_tax=e?1:0},taxValueChangeHandler:e=>{u.value.is_include_tax=0===e.is_include_tax?0:1,u.value.tax_included_amount=e.tax_included_amount?.toString()??"",u.value.tax_excluded_amount=e.tax_excluded_amount?.toString()??"",u.value.tax_amount=e.tax_amount?.toString()??""},onAdjustAccountDataChange:e=>{u.value.adjust_info=e},isModified:()=>{const e=JSON.stringify(d.value),t=JSON.stringify(u.value);return e!==t},confirmBeforeClose:async()=>g.isModified(),saveBeforeClose:()=>g.saveSettlementDataRequest(s.GG.close),saveSettlementDataRequest:async(e=s.GG.next)=>{if(e===s.GG.next){if(!g.checkDataForSave())return;if(!g.isModified()&&(0===r.value?.is_include_tax||1===r.value?.is_include_tax))return void t.emit("next")}const n={id:r.value?.id,step:e===s.GG.next?s.br.step_three:s.br.step_two,total_settle_amount:m.value,adjust_info:u.value.adjust_info?.filter((e=>e.adjust_amount||e.adjust_reason)),is_include_tax:u.value.is_include_tax,tax_amount:u.value.tax_amount,tax_rate:""===u.value.tax_rate?"0":u.value.tax_rate??"0",tax_included_amount:u.value.tax_included_amount,tax_excluded_amount:u.value.tax_excluded_amount,json_data:{amount_info_list:u.value.amount_info_list}};a.value=!0;const o=await(0,v.Ys)(n,p.WD.mcn);if(a.value=!1,o.data.success){switch(e){case s.GG.next:t.emit("next",o.data.data),t.root.$message.success("保存成功");break;case s.GG.prev:t.emit("prev",o.data.data);break;default:t.root.$message.success("保存成功");break}return!0}return t.root.$message.error(o.data.message??"保存失败"),!1},amountDetail:e=>u.value.amount_info_list.find((t=>t.type===e)),downPitFeeDetail:()=>{window.open((0,Oe.e2)(r.value?.id,r.value?.company_id))},income_amount:e=>g.amountDetail(e)?.amount,remark:e=>g.amountDetail(e)?.remark,file:e=>g.amountDetail(e)?.file,onIncomeAmountChanged:(e,t)=>{const a=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],n=g.amountDetail(t);n&&(n.amount=a)},remarkChanged:(e,t)=>{const a=g.amountDetail(t);a&&(a.remark=e)},downloadDataFile:e=>{const t=g.file(e);t&&n(t)},downTempFile:e=>{let t="";switch(e){case s.eY.head_service_fee:t="https://tiange-oss.oss-cn-hangzhou.aliyuncs.com/upload_template/group_template.xlsx";break;case s.eY.xingtu:t="https://tiange-oss.oss-cn-hangzhou.aliyuncs.com/upload_template/xingtu_template.xlsx";break;case s.eY.douyin_cps:t=`${f.value}/template/settlement/douyin_cps_template.xlsx`;break}decodeURI,window.open(t)},uploadFileHandler:async(e,a)=>{const n=e.file;if(n.size>31457280)return void t.root.$message.error("上传文件大小不能超过 30MB!");const o=new FormData,i=e.file.name;let r;o.append("file",e.file,i);let c="douyin";l.value=!0;try{switch(a){case s.eY.xingtu:c="xingtu";break;case s.eY.douyin_cps:c="douyin";break;case s.eY.head_service_fee:c="head_fee";break;default:break}r=await(0,v.YB)(o,c)}catch(u){return void(l.value=!1)}if(l.value=!1,r?.data.success){const e=g.amountDetail(a);e&&(e.amount=`${r?.data.data.income_amount??0}`,e.file=r.data.data.income_file),t.root.$message.success("上传成功")}else t.root.$message.error(r?.data.message??"上传/解析失败，稍后重试")},formatAmountWithoutPrefix:W.FU},y=e=>{window.open(e+`?Authorization=${(0,ae.LP)()}`)},h=e=>{(isNaN(e)||1*e<=0)&&(c.value.refund_rate="0",e=0),2===c.value.version?c.value.amount=(c.value.commission_amount*(1-e/100)).toFixed(2):c.value.amount=(c.value.total_gmv*(1-e/100)*c.value.commission_rate/100).toFixed(2)},b=(0,i.ref)([]);return(0,i.onMounted)((()=>{d.value=(0,x.I8)(u.value),r.value&&(c.value=r.value.json_data?.amount_info_list?.find((e=>10===e.type)),b.value=c.value?.file?.split(","))})),{pit_fee_url:(0,Oe.e2)(r.value?.id,r.value?.company_id),incomeNameTypes:o,DataForm:u,total_amount:m,refundRateHandler:h,downloadUnityDataFile:y,settlement:r,unityData:c,fileLists:b,total_amount_str:_,saveLoading:a,...g}}}),Ge=He,Je=(0,k.Z)(Ge,We,Ee,!1,null,"2633c49e",null),Ve=Je.exports,Ue=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("SettlementStep3Layout",{staticClass:"tg-settlement-submit-form col-2-mcn",class:1===e.injectSettlement.is_estimate?"is_estimate":"",attrs:{leftItemExpand:!0,amount:e.formatAmount(e.settlementDetail.total_settle_amount,"None")},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:""+e.settlementDetail.total_settle_amount.toString(),taxed:e.DataForm.is_include_tax,tax_rate:e.DataForm.tax_rate,name:e.DataForm.company_name,type:"value2"}})]},proxy:!0},{key:"left",fn:function(){return[a("card-layout",{staticStyle:{height:"100%"},attrs:{padding:[18,0,0]},scopedSlots:e._u([{key:"title",fn:function(){return[a("span",[e._v("收入信息")])]},proxy:!0}])},[[a("div",{staticClass:"settlement-step3-detail"},[e.settlementDetail.amount_info_list&&e.settlementDetail.amount_info_list.length>0?e._l(e.settlementDetail.amount_info_list,(function(t,n){return a("div",{key:n},[10===t.type?[a("div",{staticClass:"item"},[a("p",{staticClass:"label"},[e._v("总GMV：")]),a("div",{staticClass:"detail"},[a("div",{staticClass:"amount"},[a("p",{staticClass:"fee"},[e._v(" "+e._s(t.total_gmv?e.formatAmount(t.total_gmv,"None")+" 元":"--")+" ")])])])]),a("div",{staticClass:"item"},[a("p",{staticClass:"label"},[e._v("退货率：")]),a("div",{staticClass:"detail"},[a("div",{staticClass:"amount"},[a("p",{staticClass:"fee"},[e._v(" "+e._s(t.refund_rate?t.refund_rate+"%":"--")+" ")])])])]),2===t.version?a("div",{staticClass:"item"},[a("p",{staticClass:"label"},[e._v("预估机构佣金：")]),a("div",{staticClass:"detail"},[a("div",{staticClass:"amount"},[a("p",{staticClass:"fee"},[e._v(" "+e._s(t.commission_amount?e.formatAmount(t.commission_amount,"None")+" 元":"--")+" ")])])])]):a("div",{staticClass:"item"},[a("p",{staticClass:"label"},[e._v("平均佣金比例：")]),a("div",{staticClass:"detail"},[a("div",{staticClass:"amount"},[a("p",{staticClass:"fee"},[e._v(" "+e._s(t.commission_rate?t.commission_rate+" %":"--")+" ")])])])])]:e._e(),a("div",{staticClass:"item"},[a("p",{staticClass:"label"},[e._v(" "+e._s(10===t.type?"CPS收入":11===t.type?"佣金":12===t.type?"佣金(服务费)":13===t.type?"技术服务费":e.settlementTypeFun(t.type))+"： ")]),a("div",{staticClass:"detail"},[a("div",{staticClass:"amount"},[a("p",{staticClass:"fee"},[e._v(" "+e._s(t.amount?e.formatAmount(t.amount,"None")+" 元":"--")+" ")]),t.file?a("a",{staticClass:"download",attrs:{href:t.file+"?Authorization="+e.getToken()}},[e._v("下载明细")]):e._e()]),t.remark?a("p",{staticClass:"text"},[e._v(e._s(t.remark))]):e._e()])])],2)})):a("div",{staticClass:"empty"},[a("empty-common")],1)],2)]],2)]},proxy:!0},{key:"right",fn:function(){return[a("card-layout",{staticStyle:{height:"100%"},scopedSlots:e._u([{key:"title",fn:function(){return[a("span",[e._v("手工调账")])]},proxy:!0}])},[[a("div",{staticClass:"adjust-account-amount"},[e._v(" 调账 "+e._s(e.settlementDetail.adjust_info.length)+" 笔 ")]),a("div",{staticClass:"adjust-account-money mgt-6"},[a("span",[e._v("共")]),e._v(" "+e._s(e.adjustTotalAmount())+" 元 ")]),e.settlementDetail.adjust_info.length?a("div",{staticClass:"content-dash-line"}):e._e(),e._l(e.settlementDetail.adjust_info,(function(t,n){return a("div",{key:n,staticClass:"mgt-12 content-adjust-account-item"},[a("div",{staticStyle:{display:"flex"}},[a("span",{staticStyle:{"flex-shrink":"1","white-space":"pre"}},[e._v(e._s(n+1+". "))]),e._v(" "+e._s("调整金额 "+(t.adjust_amount?e.formatAmount(t.adjust_amount,"None"):"--")+" 元；调整原因："+(t.adjust_reason?t.adjust_reason:"--"))+" ")])])}))]],2)]},proxy:!0},1!==e.injectSettlement.is_estimate?{key:"files",fn:function(){return[a("div",{staticClass:"form-uploaded-file"},[a("el-form",{attrs:{size:"small"}},[a("el-form-item",{staticClass:"settlement-form-item",attrs:{"label-width":"70px"},scopedSlots:e._u([{key:"label",fn:function(){return[a("span",{staticClass:"star"},[e._v("*")]),e._v("结算单：")]},proxy:!0}],null,!1,3202344567)},[a("div",{staticStyle:{display:"flex",height:"32px","align-items":"center"}},[a("div",[a("el-upload",{staticStyle:{width:"120px"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler,accept:".docx,.pdf,.jpg,.jpeg,.png,.xlsx,.xls",disabled:e.settlementDetail.settlement_files.length>=5},model:{value:e.settlementDetail.settlement_files,callback:function(t){e.$set(e.settlementDetail,"settlement_files",t)},expression:"settlementDetail.settlement_files"}},[a("tg-button",{staticClass:"upload-btn",attrs:{icon:"ico-btn-upload",disabled:e.settlementDetail.settlement_files.length>=5}},[e._v("上传文件")])],1)],1),a("div",{staticStyle:{width:"500px",height:"32px","line-height":"32px","font-size":"12px","margin-left":"6px",color:"#a4b2c2","margin-top":"0px"}},[e._v(" 支持 .docx .pdf .jpg .png .xlsx .xls, 最多上传5个文件(单个文件大小不超过30M) ")])])])],1),a("div",{directives:[{name:"show",rawName:"v-show",value:e.settlementDetail.settlement_files.length,expression:"settlementDetail.settlement_files.length"}],staticClass:"fileList",staticStyle:{"padding-left":"70px","margin-bottom":"15px","margin-top":"-5px"}},e._l(e.settlementDetail.settlement_files,(function(t,n){return a("div",{key:n,staticStyle:{height:"20px","line-height":"20px","margin-top":"12px"}},[a("div",{staticClass:"line-clamp-1 uploaded-file",staticStyle:{display:"inline-flex"}},[a("FileItem",{key:n,attrs:{showPreview:!1,filepath:t},on:{remove:function(t){return e.handleRemoveFileClick(n)}}})],1)])})),0),a("el-form",{attrs:{size:"mini"}},[a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"关联合同："}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入合同编码","remote-method":e.getContract,size:"medium"},on:{change:function(t){return e.selectContractUidChange(t)}},model:{value:e.cooperation_link_contract_ID,callback:function(t){e.cooperation_link_contract_ID=t},expression:"cooperation_link_contract_ID"}},e._l(e.contract_uids,(function(e){return a("el-option",{key:e.contract_id,attrs:{label:e.sign_type_name+":  "+e.contract_uid+"  ("+e.coop_start_date+"-"+e.coop_end_date+")",value:e.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:null,{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("提交")])]},proxy:!0}],null,!0)}),a("tg-mask-loading",{attrs:{visible:e.loading,content:e.loadingText}})],1)},Xe=[],Qe=a(24643),Ke=(0,i.defineComponent)({components:{SettlementStep3Layout:B.Z,CardLayout:A.Z,TopCard:M.Z},setup(e,t){const a=(0,i.inject)("settlement")??(0,i.ref)(void 0),n=()=>({id:a.value?.id??-1,total_settle_amount:a.value?.total_settle_amount??0,income_amount:a.value?.income_amount??0,income_file:a.value?.income_file??"",settlement_files:a.value?.settlement_files?[...a.value?.settlement_files]:[],adjust_info:a.value?.adjust_info?[...a.value?.adjust_info]:[],amount_info_list:a.value?.json_data?.amount_info_list,detail_file:a.value?.detail_file??"",excel_data:a.value?.excel_data?[...a.value?.excel_data]:[],contract_id:a.value?.contract_id||void 0}),o=(0,i.ref)(n()),l=(0,i.ref)(n()),r=(0,i.ref)(!1),c=(0,i.ref)(void 0),d=(0,i.ref)({company_name:"",tax_rate:"",is_include_tax:1}),m={prev:()=>{m.isModified()?m.saveSettlementDataRequest(!1):t.emit("prev")},next:async()=>{if(0===a.value?.is_estimate&&!o.value.settlement_files.length)return void t.root.$message.warning("请上传结算单扫描件");const e=await(0,H.I)(t,{title:"确定提交结算单吗?",content:()=>(0,i.h)("div",[(0,i.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,i.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});e&&m.submitSettlementDataRequest()},startLoading:e=>{"save"===e?c.value="正在保存，请稍候...":"upload"===e?c.value="正在上传，请稍候...":"submit"===e&&(c.value="正在提交，请稍候..."),r.value=!0},stopLoading:()=>{r.value=!1,c.value=void 0},isModified:()=>{const e=JSON.stringify(l.value.settlement_files),t=JSON.stringify(o.value.settlement_files),a=JSON.stringify(l.value.contract_id);return h.value!==a||e!==t},adjustTotalAmount:()=>{let e=new(L())(0);return o.value.adjust_info.forEach((t=>{e=new(L())(t.adjust_amount).add(e)})),(0,W.dN)(e.toString(),"None")},uploadFileHandler:async e=>{const a=e.file;if(a.size>31457280)return void t.root.$message.error("上传文件大小不能超过 30MB!");const n=new FormData,i=e.file.name;n.append("file",e.file,i),n.append("type","settlement"),m.startLoading("upload");const s=await(0,E.$)(n);m.stopLoading(),s.data.success?(o.value.settlement_files.push(s.data.data.source),t.root.$message.success("上传成功")):t.root.$message.error(s.data.message??"上传失败，稍后重试")},handleRemoveFileClick:e=>{o.value.settlement_files.splice(e,1)},confirmBeforeClose:async()=>m.isModified(),saveBeforeClose:()=>m.saveSettlementDataRequest(!0),fillForm:e=>{-1!==o.value.id&&(o.value.id=e?.id??-1,o.value.total_settle_amount=e?.total_settle_amount??0,o.value.income_amount=e?.income_amount??0,o.value.income_file=e?.income_file??"",o.value.settlement_files=e?.settlement_files?[...e?.settlement_files]:[],o.value.adjust_info=e?.adjust_info?[...e?.adjust_info]:[],o.value.detail_file=e?.detail_file??"",o.value.excel_data=e?.excel_data?[...e?.excel_data]:[],d.value.tax_rate=e?.tax_rate?.toString()??"",d.value.is_include_tax=0===e?.is_include_tax?0:1,d.value.company_name=e?.company_name??"",h.value=e?.contract_id||void 0)},saveSettlementDataRequest:async e=>{const a={id:o.value.id,step:s.br.step_three,settlement_files:o.value.settlement_files,contract_id:h.value||0};m.startLoading("save");const n=await(0,v.Ys)(a,p.WD.mcn);return m.stopLoading(),n.data.success?(e?t.root.$message.success(n.data.message??"保存成功"):t.emit("prev",n.data.data),!0):(t.root.$message.error(n.data.message??"保存失败"),!1)},submitSettlementDataRequest:async()=>{if(0===a.value?.is_estimate&&!o.value.settlement_files.length)return void t.root.$message.warning("请上传结算单扫描件");const e={id:o.value.id,contract_id:h.value||0};0===a.value?.is_estimate&&(e.settlement_files=o.value.settlement_files),m.startLoading("submit");const n=await(0,v.FX)(e);m.stopLoading(),n.data.success?(t.root.$message.success(n.data.message??"提交结算成功"),t.emit("submit:success")):t.root.$message.error(n.data.message??"提交失败")},formatAmount:W.dN};(0,i.onMounted)((()=>{l.value=(0,x.I8)(o.value)}));const _=e=>{switch(e){case 1:return"坑位费";case 2:return"团长服务费";case 3:return"抖音cps";case 4:return"星图";case 5:return"商广";case 6:return"其他";case 10:return"CPS收入";default:return""}},f=(0,i.ref)([]),{project_id:g}=(0,u.L)(t),y=async e=>{const t=await(0,V.z0)({search:e,only_main:0,project_id:g.value,contract_status:2,partner_type:1});t.data.success?f.value=t.data.data.data:f.value=[]};y("");const h=(0,i.ref)(void 0),b=e=>{h.value=e};return{getToken:ae.LP,contract_uids:f,getContract:y,cooperation_link_contract_ID:h,selectContractUidChange:b,loading:r,loadingText:c,DataForm:d,settlementDetail:o,settlementTypeFun:_,numberMoneyFormat:Qe.rH,injectSettlement:a,...m}}}),et=Ke,tt=(0,k.Z)(et,Ue,Xe,!1,null,"dc7708e2",null),at=tt.exports,nt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("SettlementStep2Layout",{directives:[{name:"loading",rawName:"v-loading",value:e.uploadLoading,expression:"uploadLoading"}],staticClass:"settlement-step2-shoplive",attrs:{amount:e.formatted_total_amount,incomeType:2===e.cooperationType?2:3},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:e.total_amount.toString(),taxed:e.DataForm.is_include_tax,type:"value1",tax_rate:e.DataForm.tax_rate,tax_rate_disabled:!1},on:{taxRateChanged:e.taxRateChanged,taxedChanged:e.taxedChanged,valueChange:e.taxValueChangeHandler}})]},proxy:!0},{key:"left",fn:function(){return[a("div",[a("el-form",{attrs:{model:e.DataForm,size:"small","label-width":"54px"},nativeOn:{submit:function(e){e.preventDefault()}}},[a("div",{staticClass:"service-fee-block"},[a("div",{staticClass:"header"},[a("span",{staticClass:"label"},[e._v("服务费")]),a("span",{staticClass:"desc"},[e._v("服务费 = 单价 * 时长")])]),a("div",{staticStyle:{padding:"0 18px"}},[a("el-form-item",{staticClass:"mgt-18",attrs:{label:"服务费"}},[a("span",{staticStyle:{color:"#3c5269","font-weight":"600"}},[e._v(e._s(e.service_amount_str))])]),a("el-form-item",{staticClass:"mgt-18",attrs:{label:"单价"}},[a("el-input",{attrs:{placeholder:"0.00",maxlength:"12"},on:{input:e.UnitPriceInput},model:{value:e.DataForm.unit_price,callback:function(t){e.$set(e.DataForm,"unit_price","string"===typeof t?t.trim():t)},expression:"DataForm.unit_price"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元/时")])])],1),a("el-form-item",{staticClass:"mgt-18",attrs:{label:"总时长"}},[a("span",[e._v(e._s(e.DisplayForm.total_live_num)+"场 "+e._s(e.DisplayForm.total_duration)+"小时")])])],1),2!==e.cooperationType?a("div",{staticClass:"footer"},[a("tg-button",{attrs:{type:"link"},on:{click:e.downloadShopLiveTimeFile}},[e._v("下载原始数据")])],1):e._e()])])],1)]},proxy:!0},{key:"center",fn:function(){return[a("div",[a("el-form",{attrs:{model:e.DataForm,size:"small","label-width":"68px"},nativeOn:{submit:function(e){e.preventDefault()}}},[a("div",{staticClass:"commission-block"},[a("div",{staticClass:"header"},[a("span",{staticClass:"label"},[e._v("佣金")]),a("span",{staticClass:"desc"},[e._v("佣金 = 种草金额 * (1-退货率) * 佣金比例")])]),a("div",{staticStyle:{padding:"0 18px"}},[a("el-form-item",{staticClass:"mgt-18",attrs:{label:"佣金"}},[a("span",{staticStyle:{color:"#3c5269","font-weight":"600"}},[e._v(e._s(e.commission_str))])]),a("el-form-item",{staticClass:"mgt-18",attrs:{label:"佣金比例"}},[a("el-input",{attrs:{maxlength:"6",placeholder:"0.00"},on:{input:e.CommissionRateInput},model:{value:e.DataForm.commission_rate,callback:function(t){e.$set(e.DataForm,"commission_rate","string"===typeof t?t.trim():t)},expression:"DataForm.commission_rate"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("%")])])],1),a("el-form-item",{staticClass:"mgt-18",attrs:{label:"退货率"}},[a("el-input",{attrs:{maxlength:"6",placeholder:"0.00"},on:{input:e.RefundRateInput},model:{value:e.DataForm.refund_rate,callback:function(t){e.$set(e.DataForm,"refund_rate","string"===typeof t?t.trim():t)},expression:"DataForm.refund_rate"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("%")])])],1),a("el-form-item",{staticClass:"mgt-18",attrs:{label:"种草金额"}},[a("span",[e._v(e._s(e.recommend_amount_str))])])],1),2!==e.cooperationType?a("div",{staticClass:"footer"},[e.DataForm.recommend_file?a("tg-button",{attrs:{type:"link"},on:{click:function(t){return e.downloadFileHandler(e.DataForm.recommend_file)}}},[e._v("下载原始数据")]):a("el-tooltip",{staticStyle:{display:"inline-block"},attrs:{content:"上传数据后支持下载",placement:"top",effect:"light"}},[a("tg-button",{attrs:{disabled:!0,type:"link"}},[e._v("下载原始数据")])],1),a("el-upload",{staticStyle:{margin:"0 18px",display:"inline-block"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler}},[a("tg-button",{attrs:{type:"link"}},[e._v("上传数据")])],1),a("tg-button",{attrs:{type:"link"},on:{click:e.downloadTemplateHandler}},[e._v("下载模版")])],1):e._e()])])],1)]},proxy:!0},{key:"right",fn:function(){return[a("div",[a("el-form",{attrs:{size:"small","label-width":"68px"},nativeOn:{submit:function(e){e.preventDefault()}}},[e.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{adjust_info:e.DataForm.adjust_info},on:{DataChange:e.onAdjustAccountDataChange}}):e._e()],1)],1)]},proxy:!0},2===e.cooperationType?{key:"bottom",fn:function(){return[a("div",{staticClass:"newtbfooter"},[a("el-upload",{staticStyle:{margin:"0 9px 0 0",display:"inline-block"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler}},[a("tg-button",{attrs:{type:"link"}},[e._v("上传数据")])],1),a("tg-button",{staticStyle:{"border-left":"1px solid rgba(164, 178, 194, 0.3)","padding-left":"9px",display:"inline-block"},attrs:{type:"link"},on:{click:e.downloadTemplateHandler}},[e._v("下载模版")]),e.DataForm.recommend_file?a("tg-button",{staticStyle:{margin:"0 9px",display:"inline-block","border-left":"1px solid rgba(164, 178, 194, 0.3)","padding-left":"9px"},attrs:{type:"link"},on:{click:function(t){return e.downloadFileHandler(e.DataForm.recommend_file)}}},[e._v("下载原始数据")]):a("el-tooltip",{attrs:{content:"上传数据后支持下载",placement:"top",effect:"light"}},[a("tg-button",{staticStyle:{margin:"0 9px",display:"inline-block","border-left":"1px solid rgba(164, 178, 194, 0.3)","padding-left":"9px"},attrs:{disabled:!0,type:"link"}},[e._v("下载原始数据")])],1)],1)]},proxy:!0}:null,{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},ot=[],it=a(53451),st=a.n(it);const lt=e=>{const t=e||[],a=(t.length>0?t.reduce(((e,t)=>new(L())(t.adjust_amount&&!["","-",".","-."].includes(t.adjust_amount)?t.adjust_amount:"0").add(e)),new(L())("0")):new(L())("0")).toString();return a},rt=(e,t,a)=>{const n=new(L())(e&&""!==e?e:"0.00"),o=new(L())(t&&""!==t?t:"0.00"),i=new(L())(a&&""!==a?a:"0.00"),s=n.mul(new(L())(100).sub(o).div(100)).mul(i).div(100).toFixed(2);return s.toString()},ct=(e,t,a)=>{const n=lt(e);return new(L())(t&&""!==t?t:"0.00").add(a&&""!==a?a:"0.00").add(n&&""!==n?n:"0")},ut=(e,t,a=0)=>{const n=lt(e),o=Number(t||0)+a;return new(L())(o).add(n&&""!==n?n:"0")},dt=(e,t)=>{const a=e&&""!==e?e:"0.00",n=t&&""!==t?t:"0.00";return new(L())(a).mul(new(L())(n).div(100)).toFixed(2).toString()},mt={headers:{Authorization:(0,ae.LP)()??""}},pt=e=>{const t=t=>{fetch(t,mt).then((async a=>{const n=a.clone();try{const t=await n.json();e.root.$message.error(t.message)}catch{if(200===a.status){const e=await a.blob(),n=decodeURIComponent(t.split("/")[t.split("/").length-1]);(0,_.uA)(e,n)}else e.root.$message.error("下载失败")}}))};return{downloadFileHandler:t}},{debounce:_t}=st(),vt=(0,ae.LP)(),ft=e=>{const t=()=>{const e="taobao_live_template.xlsx",t=window.location.origin+"/template/settlement/"+e+"?Authorization="+vt;(0,_.qz)(t)},a=(e,t)=>{const a=new N.Decimal(e&&""!==e?e:"0.00"),n=new N.Decimal(t&&""!==t?t:"0.00"),o=a.mul(n).toFixed(2);return o.toString()},n=(0,i.ref)({id:-1,commission:"",service_amount:"",recommend_amount:"",total_duration:"",total_live_num:""}),o=(0,i.ref)({adjust_info:[],commission_rate:"",recommend_file:"",refund_rate:"",unit_price:"",tax_amount:"0",tax_rate:"6",is_include_tax:1,tax_included_amount:"0",tax_excluded_amount:"0",recommend_live_time:"0",record_count:"0"});return{DisplayForm:n,DataForm:o,downloadTemplateHandler:t,calcServiceFee:a}};var gt=(0,i.defineComponent)({name:"TgSettmentDataForm",components:{SettlementStep2Layout:$.Z,TgAdjustAccountForm:T.Z,TopCard:M.Z},props:{},setup(e,t){const a=(0,i.ref)(!1),n=JSON.stringify((0,i.inject)("project3in1",{cooperation_type:0})),o=JSON.parse(n),l=(0,i.ref)(Number((0,i.inject)("cooperationType")||1)),r=(0,i.ref)(!1);if(2!==l.value&&o.value)if(o.value.cooperation_type===p.x3.region)l.value=2;else if(o.value.cooperation_type===p.x3.selfSupport)l.value=1;else{const e=JSON.parse(localStorage.getItem("project3inone")||"{}");l.value=2===e.value?.cooperation_type?e.value?.cooperation_type:1}const{downloadFileHandler:c}=pt(t),{DisplayForm:u,DataForm:d,downloadTemplateHandler:m,calcServiceFee:f}=ft(t),g=(0,i.computed)((()=>(0,W.FU)(u.value.service_amount&&""!==u.value.service_amount?u.value.service_amount:"0.00")+" 元")),y=(0,i.computed)((()=>(0,W.FU)(u.value.commission&&""!==u.value.commission?u.value.commission:"0.00")+" 元")),h=(0,i.computed)((()=>(0,W.FU)(u.value.recommend_amount&&""!==u.value.recommend_amount?u.value.recommend_amount:"0.00"))),x=(0,i.computed)((()=>rt(u.value.recommend_amount,d.value.refund_rate,d.value.commission_rate))),b=(0,i.computed)((()=>ct(d.value.adjust_info,u.value.service_amount,u.value.commission))),w=(0,i.computed)((()=>b.value.toString()));(0,i.watch)((()=>[x.value]),(e=>{e&&(u.value.commission=x.value)}));const C=async e=>{const{data:a}=await(0,v.Zv)(e);if(a.success){const e=a.data;u.value.recommend_amount=F(e.recommend_amount.toString()),d.value.recommend_file=e.recommend_file,1!==l.value&&(u.value.total_live_num=e.recommend_live_count?e.recommend_live_count.toString():"0",u.value.total_duration=e.recommend_live_time?e.recommend_live_time:"0"),t.root.$message.success("上传成功")}else t.root.$message.error(a.message??"上传失败，稍后重试")},k=async e=>{const a=e.file;if(a.size>52428800)return void t.root.$message.error("上传文件大小不能超过 50MB!");const n=new FormData,o=e.file.name;return n.append("file",e.file,o),n.append("id",u.value.id.toString()),r.value=!0,C(n).then((e=>(r.value=!1,e))).catch((e=>(r.value=!1,Promise.reject(e))))},S=e=>{d.value.adjust_info=e},D=async()=>{if(X.value||U.value){const e=!1,a=await R(e);a&&(a.success?t.emit("prev",a.data):t.root.$message.warning(a.message))}else t.emit("prev")},j=(e,t="0")=>e&&""!==e?`${e}`:t,F=e=>new N.Decimal(e).toFixed(2).toString(),$=e=>{const t={id:u.value.id,commission:F(u.value.commission),service_amount:F(u.value.service_amount),recommend_amount:F(u.value.recommend_amount),commission_rate:e.commission_rate,total_settle_amount:b.value.toFixed(2).toString(),adjust_info:[],total_live_num:u.value.total_live_num,total_duration:"0"!==e.recommend_live_time?e.recommend_live_time:u.value.total_duration,unit_price:e.unit_price,refund_rate:e.refund_rate,tax_amount:`${e.tax_amount??0}`,is_include_tax:e.is_include_tax,tax_rate:`${e.tax_rate??6}`,tax_excluded_amount:`${e.tax_excluded_amount}`,tax_included_amount:`${e.tax_included_amount}`};return e.recommend_file&&(t.recommend_file=e.recommend_file),t},A=async e=>{a.value=!0;const[{data:t},n]=await Promise.all([await(0,v.Ys)(e,p.WD.taobao),await(0,_._v)(200)]);return a.value=!1,t},T=(0,i.ref)(void 0),L=()=>{if(d.value.adjust_info&&d.value.adjust_info?.length>=1){const e=d.value.adjust_info.filter((e=>e.adjust_reason||e.adjust_amount));if(e.length>0)return e}return[]},M=(e=!0)=>{if(d.value.commission_rate&&new N.Decimal(d.value.commission_rate).gt("100"))return"佣金比例填写错误";if(d.value.refund_rate&&new N.Decimal(d.value.refund_rate).gt("100"))return void t.root.$message.error("退货率填写错误");const a=(0,i.ref)([]);if(d.value.adjust_info&&d.value.adjust_info?.length>=1){const e=d.value.adjust_info.filter((e=>e.adjust_reason||e.adjust_amount));if(e.some((e=>/^(?:\+|-)?0?(?:\.0{0,2})?$/u.test(e.adjust_amount))))return"请输入正确的调整金额";if(e.some((e=>"0"===e.adjust_amount)))return t.root.$message.error("调整金额不能为0"),"调整金额不能为0";if(!e.every((e=>e.adjust_amount&&""!==e.adjust_amount&&"-"!==e.adjust_amount&&e.adjust_reason)))return"请完善手工调账信息";e.length>0&&(a.value=e)}const n=b.value.toFixed(2).toString();return e&&a.value&&0===a.value.length&&["0","0.0","0.00"].includes(n??"0")?"至少填写一项结算项":b.value.lessThanOrEqualTo(new N.Decimal(0))?"总结算金额不能小于等于0":void 0},R=async(e=!0)=>{if(a.value)return;const n=M(e);if(n)return void t.root.$message.error(n);const o=$(d.value);o.step=e?s.br.step_three:s.br.step_two,o.adjust_info=L(),o.commission=j(o.commission),o.service_amount=j(o.service_amount),o.recommend_amount=j(o.recommend_amount),o.commission_rate=j(o.commission_rate),o.refund_rate=j(o.refund_rate),o.unit_price=j(o.unit_price),o.unit_price=j(o.unit_price),o.tax_rate=j(o.tax_rate);const i=await A(o);return i.success?e&&t.emit("next",i.data):t.root.$message.error(i.message??"保存失败"),i},Y=_t(R,200),Z=()=>{if(X.value||U.value)Y();else{const e=!0,a=M(e);if(a)return void t.root.$message.error(a);t.emit("next",T.value)}};(0,i.watch)((()=>[d.value.unit_price,u.value.total_duration]),(e=>{e&&(u.value.service_amount=f(d.value.unit_price,u.value.total_duration))}));const O=(0,i.ref)({adjust_info:[],commission_rate:"",recommend_file:"",refund_rate:"",unit_price:"",tax_amount:"0",tax_rate:"6",is_include_tax:1,tax_included_amount:"0",tax_excluded_amount:"0"}),P=e=>"0"===e||0===e?"0.00":e&&""!==e?new N.Decimal(e?.toString()).toFixed(2).toString():"",q=e=>e&&""!==e?"0"===e?"0.00":new N.Decimal(e?.toString()).toFixed(2).toString():"0.00",z=(0,i.ref)(!1),B=e=>{T.value=e;const t=e.tax_rate?.toString()?e.tax_rate?.toString():"6";u.value.id=e.id,u.value.commission=q(e.commission.toString()),u.value.recommend_amount=e.recommend_amount.toString(),u.value.service_amount=e.service_amount.toString(),u.value.total_live_num=e.record_count.toString(),u.value.total_duration=e.total_duration.toString(),d.value.adjust_info=e.adjust_info,d.value.commission_rate=e.commission_rate.toString(),d.value.unit_price=e.unit_price.toString(),d.value.recommend_file=e.recommend_file,d.value.refund_rate=e.refund_rate.toString(),d.value.tax_amount=e.tax_amount?.toString(),d.value.is_include_tax=0===e.is_include_tax?0:1,d.value.tax_rate=t,d.value.tax_excluded_amount=P(e.tax_excluded_amount??""),d.value.tax_included_amount=P(e.tax_included_amount??""),O.value.tax_amount=e.tax_amount?.toString(),O.value.is_include_tax=0===e.is_include_tax?0:1,O.value.tax_rate=t,O.value.tax_excluded_amount=P(e.tax_excluded_amount??""),O.value.tax_included_amount=P(e.tax_included_amount??""),O.value.adjust_info=e.adjust_info,O.value.commission_rate=e.commission_rate.toString(),O.value.unit_price=e.unit_price.toString(),O.value.recommend_file=e.recommend_file,O.value.refund_rate=e.refund_rate.toString(),z.value=!0,e.live_file&&(d.value.live_file=e.live_file,O.value.live_file=e.live_file),E(u.value.id.toString())},E=async e=>{if(1===l.value){const a={settlement_id:e},{data:n}=await(0,v.VG)(a);n.success?(u.value.total_duration=n.data.live_hours.toString(),u.value.total_live_num=n.data.live_count.toString()):(t.root.$message.error(n.message),u.value.total_duration="0",u.value.total_live_num="0")}},H=async(e,a)=>{const n={settlement_id:e,unit_price:a},o=await(0,v.Jw)(n);return o.data.success?o.data.data:(t.root.$message.error(o.data.message),"")},G=async(e,t)=>{const a=await H(e.toString(),t);d.value.live_file=a},J=async()=>{await G(u.value.id,d.value.unit_price??""),d.value.live_file&&c(d.value.live_file)},V=async()=>{const e=!1,t=await R(e);return!!t&&t.success},U=(0,i.computed)((()=>JSON.stringify(O.value)!==JSON.stringify(d.value)||JSON.stringify({service_amount:q(u.value.service_amount),commission:q(u.value.commission),total_amount:q(b.value.toString())})!==JSON.stringify({service_amount:q(T.value?.service_amount??"0"),commission:q(T.value?.commission??"0"),total_amount:q(T.value?.total_settle_amount??"0")}))),X=(0,i.computed)((()=>JSON.stringify({tax_amount:d.value.tax_amount,tax_rate:d.value.tax_rate,is_include_tax:d.value.is_include_tax})!==JSON.stringify({tax_amount:O.value.tax_amount,tax_rate:O.value.tax_rate,is_include_tax:O.value.is_include_tax}))),Q=async()=>X.value||U.value,K=e=>{const t=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];d.value.unit_price=t},ee=e=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],te=e=>{const t=ee(e);d.value.commission_rate=t},ae=e=>{const t=ee(e);d.value.refund_rate=t},ne=e=>{d.value.is_include_tax=e.is_include_tax,d.value.tax_rate=e.tax_rate,d.value.tax_included_amount=e.tax_included_amount,d.value.tax_excluded_amount=e.tax_excluded_amount,d.value.tax_amount=e.tax_amount},oe=e=>{d.value.is_include_tax=e},ie=e=>{d.value.tax_rate=e};return{ShowAdjustInfo:z,commission_amount:x,RefundRateInput:ae,CommissionRateInput:te,UnitPriceInput:K,saveBeforeClose:V,confirmBeforeClose:Q,downloadShopLiveTimeFile:J,fillForm:B,uploadFileHandler:k,downloadFileHandler:c,downloadTemplateHandler:m,saveLoading:a,total_amount:b,formatted_total_amount:w,prev:D,next:Z,DisplayForm:u,DataForm:d,recommend_amount_str:h,commission_str:y,service_amount_str:g,onAdjustAccountDataChange:S,taxValueChangeHandler:ne,taxedChanged:oe,taxRateChanged:ie,cooperationType:l,uploadLoading:r}}}),yt=gt,ht=(0,k.Z)(yt,nt,ot,!1,null,null,null),xt=ht.exports,bt=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("SettlementStep2Layout",{directives:[{name:"loading",rawName:"v-loading",value:e.uploadLoading,expression:"uploadLoading"}],staticClass:"settlement-step2-shoplive",attrs:{amount:e.formatted_total_amount,incomeType:2===e.cooperationType?2:3},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:e.total_amount.toString(),taxed:e.DataForm.is_include_tax,type:"value1",tax_rate:e.DataForm.tax_rate,tax_rate_disabled:!1},on:{taxRateChanged:e.taxRateChanged,taxedChanged:e.taxedChanged,valueChange:e.valueChange}})]},proxy:!0},{key:"left",fn:function(){return[a("div",[a("el-form",{attrs:{model:e.DataForm,size:"small","label-width":"68px"},nativeOn:{submit:function(e){e.preventDefault()}}},[a("div",{staticClass:"commission-block"},[a("div",{staticClass:"header"},[2!==e.cooperationType?a("span",{staticClass:"label"},[e._v("收入信息")]):a("div",{staticClass:"label"},[a("span",{staticClass:"part"},[e._v("收入信息")])])]),a("div",{staticStyle:{padding:"0 18px"}},[2!==e.cooperationType?a("el-form-item",{staticClass:"mgt-18",attrs:{label:"服务费"}},[a("el-input",{attrs:{maxlength:"12",placeholder:"请输入"},on:{input:e.ServiceAmountInput},model:{value:e.DataForm.service_amount,callback:function(t){e.$set(e.DataForm,"service_amount",t)},expression:"DataForm.service_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1):e._e(),a("el-form-item",{staticClass:"mgt-18",attrs:{label:2!==e.cooperationType?"净销额":"销售金额"}},[a("el-input",{attrs:{disabled:2===e.cooperationType,maxlength:"12",placeholder:"0.00"},on:{input:e.SaleAmountInput},model:{value:e.DataForm.sale_amount,callback:function(t){e.$set(e.DataForm,"sale_amount",t)},expression:"DataForm.sale_amount"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("元")])])],1),a("el-form-item",{staticClass:"mgt-18",attrs:{label:"佣金比例"}},[a("el-input",{attrs:{maxlength:"6",placeholder:"请输入"},on:{input:e.CommissionRateInput},model:{value:e.DataForm.commission_rate,callback:function(t){e.$set(e.DataForm,"commission_rate","string"===typeof t?t.trim():t)},expression:"DataForm.commission_rate"}},[a("span",{attrs:{slot:"append"},slot:"append"},[e._v("%")])])],1),a("el-form-item",{staticClass:"mgt-18",attrs:{label:"佣金"}},[a("span",{staticStyle:{color:"#3c5269","font-weight":"600"}},[e._v(e._s(e.commission_str))])])],1),2!==e.cooperationType?a("div",{staticClass:"footer"},[e.DataForm.order_file?a("tg-button",{attrs:{type:"link"},on:{click:function(t){return e.downloadFileHandler(e.DataForm.order_file)}}},[e._v("下载原始数据")]):a("el-tooltip",{staticStyle:{display:"inline-block"},attrs:{content:"上传数据后支持下载",placement:"top",effect:"light"}},[a("tg-button",{attrs:{type:"link",disabled:!0}},[e._v("下载原始数据")])],1),a("el-upload",{staticStyle:{margin:"0 18px",display:"inline-block"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler}},[a("tg-button",{attrs:{type:"link"}},[e._v("上传")])],1),a("tg-button",{attrs:{type:"link"},on:{click:e.downloadTemplateHandler}},[e._v("下载模版")])],1):e._e()])])],1)]},proxy:!0},{key:"right",fn:function(){return[a("div",[a("el-form",{attrs:{size:"small","label-width":"68px"},nativeOn:{submit:function(e){e.preventDefault()}}},[e.ShowAdjustInfo?a("TgAdjustAccountForm",{attrs:{adjust_info:e.DataForm.adjust_info},on:{DataChange:e.onAdjustAccountDataChange}}):e._e()],1)],1)]},proxy:!0},2===e.cooperationType?{key:"bottom",fn:function(){return[a("div",{staticClass:"newfooter"},[a("el-upload",{staticStyle:{margin:"0 9px 0 0",display:"inline-block"},attrs:{action:"/",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler}},[a("tg-button",{attrs:{type:"link"}},[e._v("上传数据")])],1),a("tg-button",{staticStyle:{"border-left":"1px solid rgba(164, 178, 194, 0.3)","padding-left":"9px",display:"inline-block"},attrs:{type:"link"},on:{click:e.downloadTemplateHandler}},[e._v("下载模版")]),e.DataForm.order_file?a("tg-button",{staticStyle:{margin:"0 9px",display:"inline-block","border-left":"1px solid rgba(164, 178, 194, 0.3)","padding-left":"9px"},attrs:{type:"link"},on:{click:function(t){return e.downloadFileHandler(e.DataForm.order_file)}}},[e._v("下载原始数据")]):a("el-tooltip",{staticStyle:{margin:"0 9px",display:"inline-block","border-left":"1px solid rgba(164, 178, 194, 0.3)","padding-left":"9px"},attrs:{content:"上传数据后支持下载",placement:"top",effect:"light"}},[a("tg-button",{attrs:{type:"link",disabled:!0}},[e._v("下载原始数据")])],1)],1)]},proxy:!0}:null,{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("下一步")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},wt=[];const{debounce:Ct}=st(),kt=(0,ae.LP)(),St=e=>{const t=()=>{const e="douyin_live_template.xlsx",t=window.location.origin+"/template/settlement/"+e+"?Authorization="+kt;(0,_.qz)(t)},a=(0,i.ref)({id:-1,commission:""}),n=(0,i.ref)({adjust_info:[],commission_rate:"",sale_amount:"",service_amount:"",order_file:"",tax_rate:"6",tax_amount:"0",tax_excluded_amount:"0",tax_included_amount:"0",is_include_tax:1});return{DataForm:n,DisplayForm:a,downloadTemplateHandler:t}};var Dt=(0,i.defineComponent)({name:"TgSettmentDataForm",components:{SettlementStep2Layout:$.Z,TgAdjustAccountForm:T.Z,TopCard:M.Z},props:{},setup(e,t){const a=(0,i.ref)(!1),n=JSON.stringify((0,i.inject)("project3in1",{cooperation_type:0})),o=JSON.parse(n),l=(0,i.ref)(Number((0,i.inject)("cooperationType")||1)),r=(0,i.ref)(!1);if(2!==l.value&&o.value)if(o.value.cooperation_type===p.x3.region)l.value=2;else if(o.value.cooperation_type===p.x3.selfSupport)l.value=1;else{const e=JSON.parse(localStorage.getItem("project3inone")||"{}");l.value=2===e.value?.cooperation_type?e.value?.cooperation_type:1}const{downloadFileHandler:c}=pt(t),{DisplayForm:u,DataForm:d,downloadTemplateHandler:m}=St(t),f=(0,i.computed)((()=>(0,W.FU)(u.value.commission&&""!==u.value.commission?u.value.commission:"0.00")+" 元")),g=(0,i.computed)((()=>dt(d.value.sale_amount,d.value.commission_rate))),y=(0,i.computed)((()=>ut(d.value.adjust_info,u.value.commission,Number(d.value.service_amount||0)))),h=(0,i.computed)((()=>(0,W.SJ)(y.value)));(0,i.watch)((()=>[g.value]),(e=>{e&&(u.value.commission=g.value)}));const x=e=>new N.Decimal(e).toFixed(2).toString(),b=async e=>{const{data:a}=await(0,v.YJ)(e);if(a.success){const e=a.data;d.value.order_file=e.order_file,d.value.sale_amount=x(e.order_amount.toString()),t.root.$message.success("上传成功")}else t.root.$message.error(a.message??"上传失败，稍后重试")},w=async e=>{const a=e.file;if(a.size>52428800)return void t.root.$message.error("上传文件大小不能超过 50MB!");const n=new FormData,o=e.file.name;return n.append("file",e.file,o),n.append("id",u.value.id.toString()),r.value=!0,b(n).then((e=>(r.value=!1,e))).catch((e=>(r.value=!1,Promise.reject(e))))},C=e=>{d.value.adjust_info=e},k=async()=>{if(M.value||B.value){const e=!1,a=await T(e);a&&a.success&&t.emit("prev",a.data)}else t.emit("prev")},S=(e,t="0")=>e&&""!==e?`${e}`:t,D=e=>{const t={id:u.value.id,commission:x(u.value.commission),adjust_info:[],commission_rate:e.commission_rate,total_settle_amount:y.value.toFixed(2).toString(),service_amount:e.service_amount,sale_amount:e.sale_amount,tax_rate:e.tax_rate,tax_amount:e.tax_amount,is_include_tax:e.is_include_tax,tax_included_amount:e.tax_included_amount,tax_excluded_amount:e.tax_excluded_amount};return e.order_file&&(t.order_file=e.order_file),t},j=async e=>{a.value=!0;const[{data:t},n]=await Promise.all([await(0,v.Ys)(e,p.WD.douyin),await(0,_._v)(200)]);return a.value=!1,t},F=(0,i.ref)(void 0),$=(e=!0)=>{if(!d.value.commission_rate)return"请填写佣金比例";if(1===l.value&&!d.value.service_amount)return"请填写服务费";const a=(0,i.ref)([]);if(d.value.adjust_info&&d.value.adjust_info?.length>=1){const e=d.value.adjust_info.filter((e=>e.adjust_reason||e.adjust_amount));if(e.some((e=>/^(?:\+|-)?0?(?:\.0{0,2})?$/u.test(e.adjust_amount))))return"请输入正确的调整金额";if(e.some((e=>"0"===e.adjust_amount)))return t.root.$message.error("调整金额不能为0"),"调整金额不能为0";if(!e.every((e=>e.adjust_amount&&""!==e.adjust_amount&&"-"!==e.adjust_amount&&e.adjust_reason)))return"请完善手工调账信息";e.length>0&&(a.value=e)}const n=y.value.toFixed(2).toString();return e&&a.value&&0===a.value.length&&["0","0.0","0.00"].includes(n??"0")?"至少填写一项结算项":y.value.lessThanOrEqualTo(new N.Decimal(0))?"总结算金额不能小于等于0":void 0},A=()=>{if(d.value.adjust_info&&d.value.adjust_info?.length>=1){const e=d.value.adjust_info.filter((e=>e.adjust_reason||e.adjust_amount));if(e.length>0)return e}return[]},T=async(e=!0)=>{if(a.value)return;const n=$(e);if(n)return void t.root.$message.error(n);const o=D(d.value);o.step=e?s.br.step_three:s.br.step_two,o.adjust_info=A(),o.commission_rate=S(o.commission_rate),o.commission=S(o.commission),o.sale_amount=S(o.sale_amount),o.tax_rate=S(o.tax_rate),o.service_amount=S(o.service_amount);const i=await j(o);return i.success?e&&t.emit("next",i.data):t.root.$message.error(i.message??"保存失败"),i},L=Ct(T,200),M=(0,i.computed)((()=>JSON.stringify({tax_amount:d.value.tax_amount,tax_rate:d.value.tax_rate,is_include_tax:d.value.is_include_tax,service_amount:d.value.service_amount})!==JSON.stringify({tax_amount:Y.value.tax_amount,tax_rate:Y.value.tax_rate,is_include_tax:Y.value.is_include_tax,service_amount:Y.value.service_amount}))),R=()=>{if(M.value||B.value)L();else{const e=!0,a=$(e);if(a)return void t.root.$message.error(a);t.emit("next",F.value)}},Y=(0,i.ref)({adjust_info:[],commission_rate:"",sale_amount:"",order_file:"",tax_rate:"6",tax_amount:"0",tax_excluded_amount:"0",tax_included_amount:"0",is_include_tax:1,service_amount:""}),Z=e=>e&&""!==e?"0"===e?"0.00":new N.Decimal(e.toString()).toFixed(2).toString():"0.00",O=e=>"0"===e||0===e?"0.00":e&&""!==e?new N.Decimal(e?.toString()).toFixed(2).toString():"",P=(0,i.ref)(!1),q=e=>{F.value=e;const t=e.tax_rate?.toString()?e.tax_rate?.toString():"6";u.value.id=e.id,u.value.commission=Z(e.commission.toString()),d.value.adjust_info=e.adjust_info,d.value.commission_rate=e.commission_rate.toString(),d.value.sale_amount=e.sale_amount.toString(),d.value.order_file=e.order_file,d.value.is_include_tax=0===e.is_include_tax?0:1,d.value.tax_amount=e.tax_amount?.toString(),d.value.tax_excluded_amount=O(e.tax_excluded_amount??""),d.value.tax_included_amount=O(e.tax_included_amount??""),d.value.service_amount=O(e.service_amount??""),d.value.tax_rate=t,Y.value.adjust_info=e.adjust_info,Y.value.commission_rate=e.commission_rate.toString(),Y.value.sale_amount=e.sale_amount.toString(),Y.value.order_file=e.order_file,Y.value.is_include_tax=0===e.is_include_tax?0:1,Y.value.tax_amount=e.tax_amount?.toString(),Y.value.tax_excluded_amount=O(e.tax_excluded_amount??""),Y.value.tax_included_amount=O(e.tax_included_amount??""),Y.value.service_amount=O(e.service_amount??""),Y.value.tax_rate=t,P.value=!0},z=async()=>{const e=!1,t=await T(e);return!!t&&t.success},B=(0,i.computed)((()=>JSON.stringify(Y.value)!==JSON.stringify(d.value)||JSON.stringify({commission:Z(u.value.commission),total_amount:Z(y.value.toString())})!==JSON.stringify({commission:Z(F.value?.commission??"0"),total_amount:Z(F.value?.total_settle_amount??"0")}))),E=async()=>M.value||B.value,H=e=>{const t=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];d.value.sale_amount=t},G=e=>{const t=(/(?:0|[1-9]\d{0,7})(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0];d.value.service_amount=t},J=e=>(/100(?:\.0{0,2})?|(?:[1-9]?\d)(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(I.Pj,""))??[""])[0],V=e=>{const t=J(e);d.value.commission_rate=t},U=e=>{d.value.is_include_tax=e.is_include_tax,d.value.tax_rate=e.tax_rate,d.value.tax_included_amount=e.tax_included_amount,d.value.tax_excluded_amount=e.tax_excluded_amount,d.value.tax_amount=e.tax_amount},X=e=>{d.value.is_include_tax=e},Q=e=>{d.value.tax_rate=e};return{Decimal2String:W.SJ,ShowAdjustInfo:P,commission_amount:g,CommissionRateInput:V,SaleAmountInput:H,ServiceAmountInput:G,saveBeforeClose:z,confirmBeforeClose:E,fillForm:q,uploadFileHandler:w,downloadFileHandler:c,downloadTemplateHandler:m,saveLoading:a,total_amount:y,formatted_total_amount:h,prev:k,next:R,DisplayForm:u,DataForm:d,commission_str:f,onAdjustAccountDataChange:C,valueChange:U,taxedChanged:X,taxRateChanged:Q,cooperationType:l,uploadLoading:r}}}),jt=Dt,Ft=(0,k.Z)(jt,bt,wt,!1,null,null,null),$t=Ft.exports,At=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("SettlementStep3Layout",{staticClass:"settlement-step3-shoplive",class:[!1===e.isTaobaoShopLiveType&&1===e.cooperationType?"settlement-douyin-live":"",1===e.injectSettlement.is_estimate&&e.isTaobaoShopLiveType?"is_estimate":""],attrs:{amount:e.format_total_amout},scopedSlots:e._u([{key:"top",fn:function(){return[a("top-card",{attrs:{amount:e.total_amount,name:e.DisplayForm.company_name,taxed:e.DataForm.is_include_tax,tax_rate:e.DataForm.tax_rate,type:"value2"}})]},proxy:!0},e.isTaobaoShopLiveType?{key:"left",fn:function(){return[a("div",[a("div",{staticClass:"service-fee-block"},[a("div",{staticClass:"header"},[a("span",{staticClass:"label"},[e._v("服务费")]),a("span",{staticClass:"desc"},[e._v("服务费 = 单价 * 时长")])]),a("div",{staticStyle:{margin:"18px",padding:"0","line-height":"18px",height:"18px",color:"#3c5269","font-size":"14px","font-weight":"600"}},[e._v(" "+e._s(e.service_amount_str)+" ")])])])]},proxy:!0}:{key:"left",fn:function(){return[a("div",[a("div",{staticClass:"commission-block",style:{height:1===e.injectSettlement.is_estimate&&e.isTaobaoShopLiveType?"350px":!1===e.isTaobaoShopLiveType&&1===e.cooperationType?"250px":"220px"}},[a("div",{staticClass:"header"},[2!==e.cooperationType?a("span",{staticClass:"label"},[e._v("收入信息")]):a("div",{staticClass:"label"},[a("span",{staticClass:"part"},[e._v("收入信息")])])]),a("div",{staticStyle:{padding:"18px"}},[a("div",{staticStyle:{"font-size":"12px",height:"16px","line-height":"16px",color:"#a4b2c2"}},[e._v(" 共 "+e._s(e.DisplayForm.record_count)+" 条记录 ")]),a("div",{staticStyle:{"margin-top":"6px",color:"#3c5269",height:"18px","line-height":"18px","font-size":"14px","font-weight":"400"}},[2!==e.cooperationType?[e._v("合计净销额")]:[e._v("合计销售金额")],a("span",{staticStyle:{"margin-left":"4px",color:"#3c5269","font-style":"normal","font-weight":"600"}},[e._v(e._s(e.DataForm.sale_amount)+" 元")])],2),a("div",{staticStyle:{"margin-top":"18px","font-size":"14px",color:"#3c5269","line-height":"18px",height:"18px"}},[e._v(" 佣金 ")]),a("div",{staticStyle:{"margin-top":"6px","font-size":"14px",color:"#3c5269","line-height":"22px",height:"44px"}},[e._v(" = "+e._s(e.commission_formula_str)+" "),a("br"),e._v("= "),a("span",{staticStyle:{"font-weight":"600"}},[e._v(e._s(e.commission_str))])]),2!==e.cooperationType?a("div",{staticStyle:{"margin-top":"18px","font-size":"14px",color:"#3c5269","line-height":"18px",height:"18px",display:"inline-block"}},[e._v(" 服务费 ")]):e._e(),2!==e.cooperationType?a("div",{staticStyle:{"margin-top":"6px","font-size":"14px",color:"rgb(60, 82, 105)","font-weight":"600","line-height":"22px",height:"44px",display:"inline-block"}},[e._v("  "+e._s(e.Decimal2String(e.DataForm.service_amount))+" 元 ")]):e._e()])])])]},proxy:!0},e.isTaobaoShopLiveType?{key:"center",fn:function(){return[a("div",[a("div",{staticClass:"commission-block"},[a("div",{staticClass:"header"},[a("span",{staticClass:"label"},[e._v("佣金")]),a("span",{staticClass:"desc"},[e._v("佣金 = 种草金额*(1-退货率)*佣金比例")])]),a("div",{staticStyle:{padding:"18px"}},[a("div",{staticStyle:{"font-size":"12px",height:"16px","line-height":"16px",color:"#a4b2c2"}},[e._v(" 共 "+e._s(e.DisplayForm.record_count)+" 条记录 ")]),a("div",{staticStyle:{"margin-top":"6px",color:"#3c5269",height:"18px","line-height":"18px","font-size":"14px","font-weight":"400"}},[e._v(" 合计种草成交金额 "),a("span",{staticStyle:{color:"#3c5269","font-style":"normal","font-weight":"600"}},[e._v(" "+e._s(e.recommend_amount_str))])]),a("div",{staticStyle:{"margin-top":"18px","font-size":"14px",color:"#3c5269","line-height":"18px",height:"18px"}},[e._v(" 佣金 ")]),a("div",{staticStyle:{"margin-top":"6px","font-size":"14px",color:"#3c5269","line-height":"22px",height:"44px"}},[e._v(" = "+e._s(e.commission_formula_str)+" "),a("br"),e._v("= "),a("span",{staticStyle:{"font-weight":"600"}},[e._v(e._s(e.commission_str))])])])])])]},proxy:!0}:null,{key:"right",fn:function(){return[a("div",[a("div",{staticClass:"adjust-info-block",style:{height:1===e.injectSettlement.is_estimate&&e.isTaobaoShopLiveType?"350px":!1===e.isTaobaoShopLiveType&&1===e.cooperationType?"250px":"220px"}},[a("div",{staticClass:"header"},[a("span",{staticClass:"label"},[e._v("手工调账")])]),a("div",{staticStyle:{overflow:"auto",height:"178px"}},[a("div",{staticStyle:{padding:"0 18px","margin-top":"18px","font-size":"12px",height:"16px","line-height":"16px",color:"#a4b2c2"}},[e._v(" 调账 "+e._s(e.DataForm.adjust_info.length)+" 笔 ")]),a("div",{staticStyle:{padding:"0 18px","margin-top":"6px",color:"#3c5269","font-size":"14px","line-height":"18px",height:"18px","font-weight":"600"}},[e._v(" 共 "+e._s(e.total_adjust_amount)+" 元 ")]),a("div",{staticStyle:{"margin-top":"11px","font-size":"12px"}},[a("div",{staticStyle:{padding:"0 18px"}},[a("div",{staticStyle:{"border-top":"1px dashed rgba(164, 178, 194, 0.3)"}})]),a("div",{staticStyle:{padding:"0 18px 18px 18px"}},e._l(e.DataForm.adjust_info,(function(t,n){return a("div",{key:n,staticStyle:{display:"flex","margin-top":"12px",color:"#6a7b92","line-height":"16px"}},[a("div",{staticStyle:{"text-align":"center","flex-shrink":"0"}},[e._v(e._s(n+1)+". ")]),a("div",[e._v(" 调整金额："+e._s(e.formatAmountWithoutPrefix(t.adjust_amount))+" 元；调整原因："+e._s(t.adjust_reason)+" ")])])})),0)])])])])]},proxy:!0},1!==e.injectSettlement.is_estimate?{key:"files",fn:function(){return[a("div",{staticClass:"file-info-block"},[e.isTaobaoShopLiveType?a("div",{staticStyle:{display:"flex"}},[e.live_file_str?a("div",{staticClass:"file-item"},[a("div",{staticClass:"label"},[e._v("时长文件：")]),a("div",{staticClass:"fileItem"},[a("FileItem",{key:1e4,attrs:{showPreview:!1,filepath:e.live_file_str,readonly:!0}})],1)]):e._e(),e.recommend_file_str?a("div",{staticClass:"file-item"},[a("div",{staticClass:"label"},[e._v("种草文件：")]),a("div",{staticClass:"fileItem"},[a("FileItem",{key:10001,attrs:{showPreview:!1,filepath:e.recommend_file_str,readonly:!0}})],1)]):e._e()]):e._e(),!e.isTaobaoShopLiveType&&e.order_file_str?a("div",{staticClass:"file-item"},[a("div",{staticClass:"label"},[e._v("订单文件：")]),e.order_file_str?a("div",{staticClass:"fileItem"},[a("FileItem",{key:10002,attrs:{showPreview:!1,filepath:e.order_file_str,readonly:!0}})],1):e._e()]):e._e(),e.order_file_str||e.live_file_str||e.recommend_file_str?a("div",{staticStyle:{"border-top":"1px solid rgba(164, 178, 194, 0.3)"}}):e._e(),a("div",{staticClass:"statements-file-block mgt-18"},[a("div",{staticClass:"label",staticStyle:{color:"#6a7b92"},attrs:{prop:"settlement_files"}},[a("span",{staticStyle:{color:"red"}},[e._v("*")]),e._v("结算单： ")]),a("div",{staticClass:"statements-file"},[a("div",[a("div",{staticStyle:{display:"flex","line-height":"32px",height:"32px",width:"100%","font-size":"14px"}},[e.uploadedFileList.length<5?a("el-upload",{staticStyle:{"flex-shrink":"0"},attrs:{action:"/",accept:".docx,.pdf,.jpg,.jpeg,.xlsx,.png,.xls",multiple:!1,"show-file-list":!1,"http-request":e.uploadFileHandler}},[a("tg-button",{attrs:{size:"small",icon:"ico-btn-upload"}},[e._v("上传文件")])],1):a("tg-button",{attrs:{size:"small",disabled:!0,icon:"ico-btn-upload"}},[e._v("上传文件")]),a("div",{staticStyle:{display:"inline-block","margin-left":"6px","font-size":"12px",color:"#a4b2c2","line-height":"32px",height:"32px","font-weight":"400","margin-right":"-30px"}},[e._v(" 支持 .docx .pdf .jpg .png .xlsx .xls, 最多上传5个文件(单个文件大小不超过30M) ")])],1)]),a("div",{staticClass:"fileList"},e._l(e.uploadedFileList,(function(t,n){return a("div",{key:n,staticClass:"fileItem",staticStyle:{"margin-bottom":"5px"}},[a("FileItem",{key:n,attrs:{showPreview:!1,filepath:t,readonly:!1},on:{remove:function(t){return e.handleRemoveFileClick(n)}}})],1)})),0)])]),a("el-form",{ref:"elFormRef",staticStyle:{"margin-top":"10px"},attrs:{model:e.DataForm,size:"mini"}},[e.isTaobaoShopLiveType?a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"关联合同："}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入合同编码","remote-method":e.getContract,size:"medium"},on:{change:function(t){return e.selectContractUidChange(t)}},model:{value:e.DataForm.cooperation_link_contract_ID,callback:function(t){e.$set(e.DataForm,"cooperation_link_contract_ID",t)},expression:"DataForm.cooperation_link_contract_ID"}},e._l(e.contract_uids,(function(e){return a("el-option",{key:e.contract_id,attrs:{label:e.sign_type_name+":  "+e.contract_uid+"  ("+e.coop_start_date+"-"+e.coop_end_date+")",value:e.contract_id}})})),1)],1)]):a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{prop:"cooperation_link_contract_ID",label:"关联合同：",rules:[{required:!0,message:"请选择供应商合同",trigger:"change"}]}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",placeholder:"请选择供应商合同",size:"medium"},on:{change:function(t){return e.selectContractUidChange(t)}},model:{value:e.DataForm.cooperation_link_contract_ID,callback:function(t){e.$set(e.DataForm,"cooperation_link_contract_ID",t)},expression:"DataForm.cooperation_link_contract_ID"}},e._l(e.contract_uids,(function(e){return a("el-option",{key:e.contract_id,attrs:{label:e.sign_type_name+":  "+e.contract_uid+"  ("+e.coop_start_date+"-"+e.coop_end_date+")",value:e.contract_id}})})),1)],1)])],1)],1)]},proxy:!0}:1!==e.injectSettlement.is_estimate||e.isTaobaoShopLiveType?null:{key:"files",fn:function(){return[a("div",{staticClass:"file-info-block"},[a("el-form",{ref:"elFormRef",staticStyle:{"margin-top":"10px"},attrs:{model:e.DataForm,size:"mini"}},[e.isTaobaoShopLiveType?a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{label:"关联合同："}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",remote:"","reserve-keyword":"",clearable:"",placeholder:"请输入合同编码","remote-method":e.getContract,size:"medium"},on:{change:function(t){return e.selectContractUidChange(t)}},model:{value:e.DataForm.cooperation_link_contract_ID,callback:function(t){e.$set(e.DataForm,"cooperation_link_contract_ID",t)},expression:"DataForm.cooperation_link_contract_ID"}},e._l(e.contract_uids,(function(e){return a("el-option",{key:e.contract_id,attrs:{label:e.sign_type_name+":  "+e.contract_uid+"  ("+e.coop_start_date+"-"+e.coop_end_date+")",value:e.contract_id}})})),1)],1)]):a("el-form-item",{staticStyle:{"margin-bottom":"30px"},attrs:{prop:"cooperation_link_contract_ID",label:"关联合同：",rules:[{required:!0,message:"请选择供应商合同",trigger:"change"}]}},[a("div",{staticStyle:{display:"flex","align-items":"center"}},[a("el-select",{staticStyle:{width:"432px"},attrs:{filterable:"",placeholder:"请选择供应商合同",size:"medium"},on:{change:function(t){return e.selectContractUidChange(t)}},model:{value:e.DataForm.cooperation_link_contract_ID,callback:function(t){e.$set(e.DataForm,"cooperation_link_contract_ID",t)},expression:"DataForm.cooperation_link_contract_ID"}},e._l(e.contract_uids,(function(e){return a("el-option",{key:e.contract_id,attrs:{label:e.sign_type_name+":  "+e.contract_uid+"  ("+e.coop_start_date+"-"+e.coop_end_date+")",value:e.contract_id}})})),1)],1)])],1)],1)]},proxy:!0},{key:"button",fn:function(){return[a("tg-button",{on:{click:e.prev}},[e._v("上一步")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.next}},[e._v("提交")])]},proxy:!0},{key:"mask",fn:function(){return[a("tg-mask-loading",{attrs:{visible:e.saveLoading,content:"正在保存，请稍候..."}})]},proxy:!0}],null,!0)})},Tt=[];const{debounce:Nt}=st();var Lt=(0,i.defineComponent)({name:"TgSettmentDataForm",components:{SettlementStep3Layout:B.Z,TopCard:M.Z},props:{},setup(e,t){const a=(0,i.ref)("0.00"),n=(0,i.ref)(!1),o=(0,i.computed)((()=>(0,W.SJ)(new(L())(a.value)))),l=(0,i.inject)("settlement")??(0,i.ref)(void 0),r=(0,i.computed)((()=>l.value?.business_type===p.WD.taobao)),c=JSON.stringify((0,i.inject)("project3in1",{cooperation_type:0})),d=JSON.parse(c),m=(0,i.ref)(Number((0,i.inject)("cooperationType")||1));if(2!==m.value&&d.value)if(d.value.cooperation_type===p.x3.region)m.value=2;else if(d.value.cooperation_type===p.x3.selfSupport)m.value=1;else{const e=JSON.parse(localStorage.getItem("project3inone")||"{}");m.value=2===e.value?.cooperation_type?e.value?.cooperation_type:1}console.log(l,"injectSettlement");const f=(0,i.ref)(void 0);let g;const h=()=>{g=J.Loading.service({lock:!0,text:"加载中……",background:"rgba(0, 0, 0, 0.7)"})},x=(0,i.ref)({id:-1,service_amount:"",commission:"",recommend_amount:"",total_duration:"",total_live_num:"",record_count:0,company_name:"--"}),b=(0,i.ref)({adjust_info:[],refund_rate:"",commission_rate:"",unit_price:"",recommend_file:"",settlement_files:[],tax_amount:"0",tax_rate:"6",is_include_tax:1,tax_included_amount:"0",tax_excluded_amount:"0",service_amount:"",cooperation_link_contract_ID:void 0}),w=(0,i.ref)([]),C=async()=>{if(B.value){const e={id:x.value.id,step:s.br.step_three,contract_id:b.value.cooperation_link_contract_ID||0},a=b.value.settlement_files?b.value.settlement_files:[];e.settlement_files=a,n.value=!0;const[{data:o},i]=await Promise.all([await(0,v.Ys)(e,r.value?p.WD.taobao:p.WD.douyin),await(0,_._v)(200)]);n.value=!1,o.success?t.emit("prev",o.data):t.root.$message.error(o.message)}else t.emit("prev")},k=async()=>{r.value?F():f.value?.validate((e=>{e&&F()}))},S=e=>{w.value.splice(e,1)},D=async e=>{const a=e.file;if(a.size>31457280)return void t.root.$message.error("上传文件大小不能超过 30MB!");h();const n=new FormData,o=e.file.name;n.append("file",e.file,o),n.append("type","settlement");const i=await(0,E.$)(n),s=i.data;if(g.close(),s.success){const e=s.data.source||"";t.root.$message.success("上传成功"),w.value.push(e)}else t.root.$message.error(s.message??"上传失败，稍后重试")};(0,i.watch)((()=>w.value),(()=>{b.value.settlement_files=w.value}),{deep:!0});const j=async(e=!0)=>{if(n.value)return;if(void 0===l.value)return;const a=b.value.settlement_files?b.value.settlement_files:[];if(0===l.value.is_estimate&&0===a.length)return void t.root.$message.warning("请上传结算单扫描件");const o=await(0,H.I)(t,{title:"确定提交结算单吗？",content:()=>(0,i.h)("div",[(0,i.h)("div","提交后将无法修改结算信息，确定要将结算单"),(0,i.h)("div","提交给财务确认吗?")]),confirmText:"确定",cancelText:"取消"});if(!o)return;const s={id:x.value.id,contract_id:b.value.cooperation_link_contract_ID||0};0===l.value.is_estimate&&(s.settlement_files=a),n.value=!0;const[{data:r},c]=await Promise.all([await(0,v.FX)(s),await(0,_._v)(200)]);return n.value=!1,r.success?e&&(t.root.$message.success("提交成功"),t.emit("submit:success")):t.root.$message.error(r.message??"提交失败"),r},F=Nt(j,200),$=(0,i.ref)(""),A=(0,i.ref)(""),T=(0,i.ref)(""),N=(0,i.ref)(""),I=(0,i.computed)((()=>(0,W.FU)(x.value.recommend_amount&&""!==x.value.recommend_amount?x.value.recommend_amount:"0.00")+" 元")),M=(0,i.ref)("0"),R=(0,i.ref)(""),Y=(0,i.computed)((()=>(0,W.FU)(x.value.service_amount&&""!==x.value.service_amount?x.value.service_amount:"0.00")+" 元")),Z=(0,i.ref)([]),O=(0,i.ref)(void 0),P=e=>{if(e){if(b.value.adjust_info=e.adjust_info,b.value.adjust_info){const e=b.value.adjust_info.reduce(((e,t)=>new(L())(t.adjust_amount&&""!==t.adjust_amount?t.adjust_amount:"0").add(e)),new(L())("0")).toFixed(2).toString();M.value=(0,W.FU)(e)}r.value?R.value=`${(0,W.FU)(e.recommend_amount??"0")} * (1 - ${e.refund_rate}%) * ${e.commission_rate}%`:R.value=`${(0,W.FU)(e.sale_amount??"0.00")} * ${e.commission_rate}%`,N.value=(0,W.FU)(e.commission??"0")+" 元",x.value.id=e.id,x.value.recommend_amount=e.recommend_amount.toString(),x.value.service_amount=e.service_amount.toString(),x.value.commission=e.commission.toString(),x.value.record_count=e.record_count,x.value.company_name=e.company_name?e.company_name:"--",b.value.sale_amount=e.sale_amount.toString(),b.value.tax_amount=`${e.tax_amount??0}`,b.value.tax_rate=String(`${e.tax_rate??6}`),b.value.is_include_tax=0===e.is_include_tax?0:1,b.value.tax_excluded_amount=`${e.tax_excluded_amount??0}`,b.value.tax_included_amount=`${e.tax_included_amount??0}`,b.value.service_amount=e.service_amount.toString(),e.live_file&&($.value=e.live_file),e.recommend_file&&(A.value=e.recommend_file),e.order_file&&(T.value=e.order_file),e.settlement_files&&(Z.value=JSON.parse(JSON.stringify(e.settlement_files))||[],b.value.settlement_files=JSON.parse(JSON.stringify(e.settlement_files))||[],w.value=JSON.parse(JSON.stringify(e.settlement_files))||[]),b.value.cooperation_link_contract_ID=e.contract_id||void 0,O.value=e.contract_id||void 0,a.value=`${e.total_settle_amount}`}return!0},q=async()=>{const e={id:x.value.id,contract_id:b.value.cooperation_link_contract_ID||0,step:s.br.step_three},a=b.value.settlement_files?b.value.settlement_files:[];e.settlement_files=a,n.value=!0;const[{data:o},i]=await Promise.all([await(0,v.Ys)(e,r.value?p.WD.taobao:p.WD.douyin),await(0,_._v)(200)]);return n.value=!1,!!o.success||(t.root.$message.error(o.message),!1)},z=async()=>await q(),B=(0,i.computed)((()=>O.value!==b.value.cooperation_link_contract_ID||JSON.stringify(Z.value)!==JSON.stringify(b.value.settlement_files))),G=async()=>B.value,U=(0,i.ref)([]),{project_id:X}=(0,u.L)(t),Q=async e=>{const t=await(0,V.z0)({search:e,only_main:0,project_id:X.value,contract_status:2,partner_type:1,settlement_start_date:l.value?y()(1e3*l?.value.start_date).format("YYYY-MM-DD"):void 0,settlement_end_date:l.value?y()(1e3*l?.value.end_date).format("YYYY-MM-DD"):void 0});t.data.success?U.value=t.data.data.data:U.value=[]};Q("");const K=e=>{b.value.cooperation_link_contract_ID=e};return{Decimal2String:W.SJ,cooperationType:m,contract_uids:U,getContract:Q,selectContractUidChange:K,confirmBeforeClose:G,isTaobaoShopLiveType:r,saveBeforeClose:z,commission_formula_str:R,total_adjust_amount:M,formatAmountWithoutPrefix:W.FU,commission_str:N,DisplayForm:x,DataForm:b,live_file_str:$,order_file_str:T,recommend_file_str:A,service_amount_str:Y,recommend_amount_str:I,fillForm:P,uploadFileHandler:D,total_amount:a,format_total_amout:o,saveLoading:n,handleRemoveFileClick:S,prev:C,next:k,uploadedFileList:w,injectSettlement:l,elFormRef:f}}}),It=Lt,Mt=(0,k.Z)(It,At,Tt,!1,null,"e3784b42",null),Rt=Mt.exports,Yt=a(46024),Zt=a(22895),Ot=(0,i.defineComponent)({name:"TgSettlementDialog",components:{Step1:D,Step2Marketing:P,Step3Marketing:K,Step2MCN:se,Step3MCN:_e,Step2ShopLiveTaobao:xt,Step2ShopLiveDouyin:$t,Step3ShopLive:Rt,Step2MCNDouyinBefore:Re,Step3MCNDouyinBefore:Be,Step2MCNDouyinAfter:Ve,Step3MCNDouyinAfter:at},setup(e,t){const a=(0,i.inject)("project3in1")??(0,i.ref)(void 0),{project_id:n,isFromMarketing:o,isFromLive:s,isFromCommon:l}=(0,u.L)(t),r=(0,i.computed)((()=>{if("common"===a.value?.project__type)return a.value?.platform_type})),c=(0,i.ref)(!1),d=(e=!1)=>{c.value=e},m=()=>{d(!c.value)},_=(0,i.ref)(void 0);(0,i.provide)("settlement",_);const v=()=>{w()},f=(0,i.ref)(0),g=(0,i.ref)(0),y=(0,i.ref)(0),h=(e,a)=>{w(e),d(!0),y.value=1===a?1:0,t.root.$nextTick((()=>{void 0===e?(D.value=0,f.value++):(D.value=e.step,g.value++)}))},x=()=>{void 0!==_.value&&t.emit("close"),v(),d()},b=(0,i.ref)(null),w=e=>{D.value=0,_.value=void 0===e?void 0:{...e}};(0,i.watch)((()=>f.value),((e,a)=>{e!==a&&t.root.$nextTick((()=>{b.value?.fillForm?.(_.value,y.value)}))})),(0,i.watch)((()=>g.value),((e,a)=>{e!==a&&t.root.$nextTick((()=>{b.value?.fillForm?.(_.value)}))}));const C=async e=>{if(void 0===_.value)return void e();const a=await(b.value?.confirmBeforeClose());if(!1===a)return void e();const n=await(0,H.I)(t,{title:"退出前需要保存吗？",content:"选择不保存将丢失当前的改动",confirmText:"保存并退出",cancelText:"不保存，直接退出"});if(n){const e=await(b.value?.saveBeforeClose());if(!e)return}e()},k=(0,Yt.or)((0,Yt.xD)(l,(0,Yt.or)((0,i.computed)((()=>void 0===_.value)),(0,i.computed)((()=>_.value?.is_tmp===Zt.w.YES)))),(0,Yt.xD)(s,(0,Yt.or)((0,i.computed)((()=>void 0===_.value)),(0,i.computed)((()=>_.value?.is_tmp===Zt.w.YES))))),S=(0,i.computed)((()=>[{title:"基本信息"},{title:"结算数据"},k.value?{title:"生成结算单"}:{title:"提交"}])),D=(0,i.ref)(0),j=async e=>{void 0!==e&&(_.value={...e}),D.value=Math.max(D.value-1,0),t.root.$nextTick((()=>{b.value?.fillForm?.(_.value)}))},F=async e=>{void 0!==e&&(_.value={...e}),D.value=Math.min(D.value+1,2),t.root.$nextTick((()=>{b.value?.fillForm?.(_.value)}))},$=()=>{x()},A=(0,i.computed)((()=>"964px")),T=(0,i.computed)((()=>0===D.value?"Step1":1===D.value?o.value?"Step2Marketing":s.value?_.value?.business_type===p.WD.taobao?"Step2ShopLiveTaobao":"Step2ShopLiveDouyin":l.value?1===r.value?_.value?.is_tmp?"Step2MCNDouyinBefore":"Step2MCNDouyinAfter":"Step2MCN":"":2===D.value?o.value?"Step3Marketing":s.value?"Step3ShopLive":l.value?1===r.value?_.value?.is_tmp?"Step3MCNDouyinBefore":"Step3MCNDouyinAfter":"Step3MCN":"":""));return{is_virtual_receipt:k,dialogWidth:A,dialogVisible:c,toggleDialogVisible:m,open:h,close:x,beforeClose:C,stepCompRef:b,project_id:n,settlement:_,steps:S,activeNumber:D,formComponent:T,project:a,prev:j,next:F,onSubmitSuccess:$}}}),Pt=Ot,qt=(0,k.Z)(Pt,r,c,!1,null,null,null),zt=qt.exports,Bt=a(77944),Wt=a(21757),Et=a(32662),Ht=a(99166),Gt=a(87903),Jt=a(10114),Vt=a(58861),Ut=a(42386),Xt=a(67578),Qt=a(58302),Kt=a(66626),ea=a(44928),ta=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("el-dialog",{staticClass:"tg-dialog-classic tg-dialog-vcenter-new",class:[e.dialogClass],attrs:{visible:e.dialogVisible,width:e.dialogWidth,height:"660px","lock-scroll":"","close-on-click-modal":!1,"close-on-press-escape":!1},on:{close:e.close},scopedSlots:e._u([{key:"title",fn:function(){return[e._v("收入结算")]},proxy:!0},!e.CanIEdit||e.is_confirmed||e.readonly||e.is_unity_settlement?null:{key:"footer",fn:function(){return[a("tg-button",{on:{click:e.confirmRefuseReason}},[e._v("不通过")]),a("tg-button",{attrs:{type:"primary"},on:{click:e.confirm}},[e._v(e._s(e.settlement&&8===e.settlement.settlement_type?"确认结算":"确认并提交"))])]},proxy:!0}],null,!0)},[a("div",{staticClass:"settlement-detail-content"},[a(e.data_component,{ref:"stepCompRef",tag:"component",attrs:{readonly:!0}})],1)]),a("tg-mask-loading",{attrs:{visible:e.confirmLoading,content:"正在提交确认，请稍候..."}}),a("tg-mask-loading",{attrs:{visible:e.refuseLoading,content:"正在提交，请稍候..."}}),a("RefuseDialog",{ref:"refustDialogRef",on:{refuse:e.refuse}})],1)},aa=[],na=a(87425),oa=a(9397),ia=a(71963);const sa=(0,i.defineComponent)({props:{readonly:{type:Boolean,default:!1}},components:{RefuseDialog:oa.Z,MerchantSettlement:na.Z},setup(e,t){const a=(0,i.ref)(!1),n=(e=!1)=>{a.value=e},o=()=>{n(!a.value)},l=(0,i.ref)(void 0),r=(0,i.computed)((()=>l.value?.status===s.ne.confirmed)),c=(0,i.computed)((()=>5===l.value?.settlement_type&&l.value?.unity_settlement_id));(0,i.provide)("settlement",l);const u=(0,i.ref)(""),d=(0,i.ref)(null),m=(0,i.ref)(!1),v=(0,i.ref)(!1),f=e=>{l.value=e,(0,G.set)(u,"MerchantSettlement"),(0,G.set)(m,!0),n(!0)};(0,G.whenever)((0,G.and)(m,void 0!==d.value),(()=>{(0,i.nextTick)((()=>{l.value}))}));const g=()=>{(0,G.set)(m,!1),t.emit("close"),n(),setTimeout((()=>{(0,G.set)(u,void 0)}),300)},y=(0,i.computed)((()=>l.value?.business_type===p.WD.marketing)),h=(0,i.computed)((()=>y.value?"settlement-dialog":"settlement-cost-dialog")),x=(0,i.computed)((()=>y.value||v.value?"942px":"1100px")),b=(0,i.computed)((()=>s.v$.get(l.value?.settlement_type??s.kX.live_taobao)??"--")),w=(0,i.ref)(null),C=()=>{w.value?.open()},k=(0,i.ref)(!1),S=async e=>{if(void 0===l.value)return;(0,G.set)(k,!0);const[{data:a}]=await(0,_.Dc)(500,(0,ia.bs)(l.value.id,e));(0,G.set)(k,!1),a.data?(t.root.$message.success(a.message??"提交成功"),t.emit("success:refuse"),g()):t.root.$message.error(a.message??"提交失败")},D=(0,i.ref)(!1),j=async()=>{if(void 0===l.value)return;const e=await(0,H.I)(t,"确定通过这条结算吗？");if(!e)return;let a=ia.FZ;8===l.value?.settlement_type&&(a=ia.GZ),D.value=!0;const[{data:n}]=await(0,_.Dc)(500,a(l.value.id));D.value=!1,n.data?(t.root.$message.success(n.message??"确认结算成功"),t.emit("success:confirm",l.value.id),g()):t.root.$message.error(n.message??"确认结算失败")},F=(0,i.computed)((()=>(0,Wt.gI)().s2b2c_settlement));return{dialogVisible:a,toggleDialogVisible:o,open:f,close:g,stepCompRef:d,data_component:u,dialogClass:h,dialogWidth:x,settlement:l,"结算类型":b,refustDialogRef:w,confirmRefuseReason:C,refuseLoading:k,refuse:S,confirm:j,confirmLoading:D,CanIEdit:F,is_confirmed:r,is_unity_settlement:c}}});var la=sa,ra=la,ca=(0,k.Z)(ra,ta,aa,!1,null,null,null),ua=ca.exports,da=a(80972),ma=(0,i.defineComponent)({name:"TgSettlementIncomeTab",props:{cooperationType:{type:Number,defalut:1,required:!1}},components:{TgSettlementDialog:zt,BuessinessSettlement:Gt.Z,achievement:l.Z,reverseOrderDialog:Jt.Z,settlementApprove:Kt.Z,ProjectConfirmDialog:ua,MakeInvoiceDialog:da.Z},setup(e,t){const a=(0,i.ref)(!1),{project_id:n,isFromMarketing:o,isFromLive:l,isFromCommon:r,project_type:c,business_type:d}=(0,u.L)(t),m=JSON.stringify((0,i.inject)("project3in1",{cooperation_type:0})),f=JSON.parse(m),g=(0,i.ref)(Number(e.cooperationType||1));if(2!==g.value&&f.value)if(f.value.cooperation_type===p.x3.region)g.value=2;else if(f.value.cooperation_type===p.x3.selfSupport)g.value=1;else if(l.value){const e=JSON.parse(localStorage.getItem("project3inone")||"{}");g.value=2===e.value?.cooperation_type?e.value?.cooperation_type:1}(0,i.provide)("cooperationType",g);const y=(0,i.ref)(null),h=(0,i.computed)((()=>{if(o.value){const e=(0,i.inject)("MarketingProject")??(0,i.ref)(void 0);return{...e.value,project__type:"marketing"}}if(l.value){const e=(0,i.inject)("live_project")??(0,i.ref)(void 0);return{...e.value,project__type:"live"}}if(r.value){const e=(0,i.inject)("common_project")??(0,i.ref)(void 0);return{...e.value,project__type:"common"}}})),b=(0,i.computed)((()=>Bt.Z.getters["user/getUserInfo"])),w=(0,i.computed)((()=>b.value.role_info.map((e=>e.role_code)).includes(1003))),C=(0,Wt.gI)(),k=(0,i.computed)((()=>w.value?o.value?{createBtn:C.marketing_project_settlement_save,deleteBtn:C.marketing_project_settlement_delete}:l.value?{createBtn:C.live_project_settlement_save,deleteBtn:C.live_project_settlement_delete,auditBtn:C.live_project_statements_create}:r.value?{createBtn:C.common_business_project_settlement_save,deleteBtn:C.common_business_project_settlement_delete,auditBtn:C.common_business_project_contract_statement_create}:{createBtn:!1,deleteBtn:!1}:{createBtn:!1,deleteBtn:!1}));(0,i.provide)("project_type",c),(0,i.provide)("project_id",n),(0,i.provide)("project3in1",h);const S=(0,i.ref)(null),D=(0,i.ref)(null),j=(0,i.ref)(null),F=(0,i.computed)((()=>"发起结算")),$=()=>{if(l.value){const e=h.value;if(e.project_status===p.C_.finish)return t.root.$message.warning("项目已完结，不允许进行结算"),!0}else if(o.value){const e=h.value;if(4===e.cooperation_status)return t.root.$message.warning("项目已执行结束，不允许进行结算"),!0}return!1},A=e=>{Te(e)&&!e.refunded_id&&(e.status===s.ne.wait_project_confirm&&C.s2b2c_settlement&&r&&195!==n.value?y.value?.open(e):(e.cooperation_type=e.cooperation_type?e.cooperation_type:g.value,t.refs.BuessinessSettlement.show(e)))},T=(e=0)=>{$()||S.value?.open(void 0,e)},N=e=>{S.value?.open(e)},L=async e=>{const n=l.value?"live":r.value?"common":"marketing";a.value=!0;const o=await(0,v.S_)(n,{id:e.id});a.value=!1,o.data.success?j.value?.show(o.data.data??e,0!==e.unity_settlement_id?1:0):t.root.$message.error(o.data.message)},I=(0,i.ref)(!1),M=async(e,a)=>{const n=await(0,H.I)(t,{title:a,content:void 0});if(!n)return;I.value=!0;const[{data:o}]=await(0,_.Dc)(500,(0,v.f_)(c.value,e.id));I.value=!1,o.success?(t.root.$message.success("删除成功"),await ge()):t.root.$message.error(o.message??"删除失败")},R=(0,i.ref)(!1),Y=(0,i.ref)(""),Z=(0,i.ref)(""),O=e=>{Y.value="退回原因",Z.value=e.refuse_reason,R.value=!0},P=e=>{Y.value="冲销退回原因",Z.value=e.reverse_back_reason,R.value=!0},q=e=>{Y.value="冲销原因",Z.value=e.reverse_reason,R.value=!0},z=e=>{Y.value="冲销原因",Z.value=e.refund_reason||"",R.value=!0},B=e=>{Y.value="退回原因",Z.value=e.refund_back_reason||"",R.value=!0},W=()=>{Z.value="",R.value=!1},{loading:E,data:G,total:J,loadData:V}=(0,Et.W)(c),{settlement_number_column:U,settlement_company_column:X,settlement_cycle_column:Q,settlement_money_column:K,settlement_tax_amount_column:ee,settlement_tax_rate_column:te,settlement_no_tax_amount_column:ae,settlement_status_column:ne,write_off_status_column:oe,settlement_person_column:ie,submit_date_column:se,confirm_person_column:le,confirm_date_column:re}=(0,Ht.S)(G),ce=(0,i.ref)(null),{visible:ue,toggleVisible:de}=(0,Vt.Z)(),me=async(e,a,n)=>{de();const o={id:e.id,reverse_reason:a,reverse_type:s.Jd.settlement_income};let i;return i=n?await(0,Ut.Xz)(o):await(0,Ut.Tu)(o),de(),i.data.success?(t.root.$message.success(i.data.message??"冲销成功"),ge()):t.root.$message.error(i.data.message??"冲销失败"),i.data.success},pe=(e,a)=>{const n=[],o=8===e.settlement_type&&e.unity_settlement_id&&e.related_income_settlement_id;if(e.refunded_id||o){const{refund_status:t=1}=e,o=a?"查看":(0,i.h)("a",{on:{click:t=>{z(e),t.stopPropagation()}}},["查看"]),l=a?"查看原因":(0,i.h)("a",{on:{click:t=>{B(e),t.stopPropagation()}}},["查看原因"]),r=a?"删除":(0,i.h)("a",{on:{click:t=>{M(e,"是否删除该退款单"),t.stopPropagation()}}},["删除"]);return t===s.ne.confirmed?n.push(o):t===s.ne.refused&&(n.push(l),n.push(r)),(0,i.h)("div",{class:"operation"},n)}if(e.shop_live_live_goods_id)return a?"":(0,i.h)("div",{class:"operation"},[]);if(e.reversed_id){const t=a?"删除":(0,i.h)("a",{on:{click:t=>{M(e,"是否删除该冲销单"),t.stopPropagation()}}},["删除"]),o=a?"重新提交":(0,i.h)("a",{on:{click:t=>{ce.value?.open((t=>me(e,t,!0)),e.reverse_reason),t.stopPropagation()}}},["重新提交"]),s=a?"退回原因":(0,i.h)("a",{on:{click:t=>{P(e),t.stopPropagation()}}},["退回原因"]);if(e.reverse_status===Xt.h0.refused)n.push(t),n.push(o),n.push(s);else{const t=a?"查看":(0,i.h)("a",{on:{click:t=>{q(e),t.stopPropagation()}}},["查看"]);n.push(t)}}else{if(k.value.createBtn&&[s.ne.unsubmit,s.ne.refused].includes(e.status)){const t=a?"编辑":(0,i.h)("a",{on:{click:t=>{N(e),t.stopPropagation()}}},["编辑"]);n.push(t)}if(e.status===s.ne.refused){const t=a?"查看原因":(0,i.h)("a",{on:{click:t=>{O(e),t.stopPropagation()}}},["查看原因"]);n.push(t)}if(s.ne.confirmed===e.status&&!e.reverse_id){const t=e.write_off_amount?`${e.write_off_amount}`:"0",o=e.tax_included_amount?`${e.tax_included_amount}`:"0";if(!e.is_estimate&&t!==o){const t=a?"开票申请":(0,i.h)("a",{on:{click:t=>{t.stopPropagation(),L(e)}},class:"line-clamp-1"},["开票申请"]);n.push(t)}const s=a?"冲销":(0,i.h)("a",{style:{color:"#e91313"},on:{click:t=>{ce.value?.open((t=>me(e,t,!1))),t.stopPropagation()}}},["冲销"]);1!==e.has_refund_settlement&&n.push(s)}if(k.value.deleteBtn&&(e.status===s.ne.unsubmit||e.status===s.ne.refused)){const t=a?"删除":(0,i.h)("a",{on:{click:t=>{M(e,"确认要删除这条结算吗？"),t.stopPropagation()}}},["删除"]);n.push(t)}}if(e.status===s.ne.confirmed&&!e.reversed_id&&!e.reverse_id&&e.settlement_no_write_off_amount){const a="CommonBusinessProjectDetail"===t.root.$route.name,o="SSLiveProjectDetail"===t.root.$route.name,l="MarketingProjectDetail"===t.root.$route.name,r=(0,i.h)("tg-button",{props:{type:"link",disabled:(e.settlement_no_register_amount??0)<=0},on:{click:t=>{if(e.settlement_no_register_amount&&e.settlement_no_register_amount>0){let t=(0,x.I8)(e);t={...t,gather_amount:t.settlement_no_register_amount},D.value?.show(t,{isMcn:a,isBrand:o,isMarketing:l},e.business_type===p.WD.douyin||e.business_type===p.WD.douyinsh)}t.stopPropagation()}}},["收款"]);(a&&C.common_live_project_achievement||o&&C.live_project_achievement||l&&C.marketing_project_achievement_change)&&(e.status===s.ne.confirmed&&e.unity_settlement_id||n.unshift(r))}return a?n.join("  "):(0,i.h)("div",{class:"operation"},n)},_e=(0,i.computed)((()=>[U.value,X.value,Q.value,K.value,te.value,ee.value,ae.value,ne.value,oe.value,ie.value,se.value,le.value,re.value,{label:"操作",align:"left",headerAlign:"left",fixed:"right",minWidth:160,formatter:e=>pe(e,!1)}])),ve=(0,i.ref)({page_num:1,num:20}),fe=()=>{const e={project_id:n.value,business_type:d.value,...ve.value};return e},ge=async(e=!0)=>{e&&(ve.value.page_num=1),await V(fe())},ye=async e=>{ve.value.page_num=e,await ge(!1)},he=async e=>{ve.value.num=e,await ge()},xe=(0,ea.t)();(0,i.provide)("contract",(0,i.ref)(void 0)),(0,i.provide)("project_add_id",xe.currentRoute.params.id);const be=(0,i.ref)(!1),we=()=>{be.value=!0},Ce=()=>{be.value=!1,ge()};(0,i.onMounted)((()=>{ge()}));const ke=32,Se=34,De=36,je=31,Fe=(0,i.ref)(0),$e=e=>{Fe.value=e.height},Ae=(0,Qt.Z)({compensation:(0,i.computed)((()=>ke+Se+De+je)),fixedBlockHeightRefs:[0===Fe.value?6:Fe,120],tableMinHeight:100}),Te=e=>{if(!e.reversed_id&&(e.status===s.ne.confirmed||e.status===s.ne.wait_confirm||e.status===s.ne.wait_project_confirm||e.status===s.ne.nopass_project_confirm))return{cursor:"pointer"}};return{isFromMarketing:o,isFromLive:l,isFromCommon:r,CanIUse:k,dialogRef:S,buttonContent:F,onCreateBtnClick:T,onEditBtnClick:N,achievementRef:D,columns:_e,project:h,loading:E,data:G,total:J,loadData:V,reload:ge,filterForm:ve,onCurrentChange:ye,onSizeChange:he,deleteLoading:I,reasonDialogVisible:R,reasonDialogTitle:Y,reason:Z,onViewBtnClick:A,onReasonViewBtnClick:O,onRefundedReason:z,onRefundedBackReason:B,onReasonDialogClose:W,reverseOrderDialogRef:ce,onWriteOffConfirmResolve:me,writeOffLoading:ue,onTopCardRectUpdate:$e,...Ae,onApproveBtnClick:we,approveVisible:be,onApproveClose:Ce,rowStyle:Te,projectConfirmDialogRef:y,MakeInvoiceDialogRef:j,settleemntDetailLoading:a}}}),pa=ma,_a=(0,k.Z)(pa,n,o,!1,null,null,null),va=_a.exports},39716:function(e,t,a){a.d(t,{Z:function(){return F}});var n=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-drawer",{attrs:{title:"开票申请详情",visible:e.visible,height:"100vh",size:"612",wrapperClosable:!1},on:{close:e.close}},[e.loading?a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticStyle:{height:"420px"}}):e._e(),e.detail?a("div",{staticClass:"invoice-dialog-content"},[a("div",{staticClass:"main"},[a("div",{staticClass:"invoice-info-header"},[a("div",{staticClass:"invoice-info-header-list"},[a("div",{staticClass:"invoice-info-header-item"},[a("span",[e._v("申请人:")]),a("span",[e._v(e._s(e.detail.username))])]),a("div",{staticClass:"invoice-info-header-item"},[a("span",[e._v("申请部门:")]),a("span",[e._v(e._s(e.detail.create_department))])]),a("div",{staticClass:"invoice-info-header-item"},[a("span",[e._v("发起时间:")]),a("span",[e._v(e._s(e.detail.gmt_create))])])]),a("a",{on:{click:function(t){return e.exportPdf(e.detail.approval_id)}}},[e._v("下载PDF")])]),a("div",{staticClass:"invoice-info-body"},[a("div",{staticClass:"invoice-info-uid"},[a("span",{staticClass:"uid"},[e._v("审批编号："+e._s(e.detail.approval_uid))]),a("div",{staticClass:"invoice-tag",attrs:{"data-text":e.ApprovalStatusText}},[e._v(e._s(e.ApprovalStatusText))])]),a("div",{staticClass:"invoice-info-base base-grid"},[a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("开票类型：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.发票类型))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("关联客户合同：")]),a("div",{staticClass:"base-grid-item-content"},[a("a",{on:{click:e.jumpContract}},[e._v(e._s(e.detail.contract_uid))])])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("开票金额：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.开票金额))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("关联业绩：")]),a("div",{staticClass:"base-grid-item-content"},[a("a",{on:{click:e.jumpAchievement}},[e._v(e._s(e.detail.achievement_uid))])])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("款项是否收到：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.款项是否收到))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v(e._s(e.收款时间标签))]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.收款时间))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("发票寄送方式：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.发票寄送方式))])])]),a("el-divider",{staticStyle:{margin:"17px 0"}}),a("div",{staticClass:"invoice-info-title"},[e._v("开票信息")]),a("div",{staticClass:"invoice-info-base base-grid",staticStyle:{"margin-top":"12px"}},[a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("公司名称：")]),a("div",{staticClass:"base-grid-item-content line-clamp-1"},[e._v(" "+e._s(e.detail.collecting_company||"--")+" ")])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("纳税人识别号：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.detail.tax_number||"--"))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("地址：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.detail.address||"--"))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("电话：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.detail.phone||"--"))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("开户行：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.detail.bank_of_deposit||"--"))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("账号：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.detail.bank_card_number||"--"))])]),a("div",{staticClass:"base-grid-item"},[a("div",{staticClass:"base-grid-item-lbl"},[e._v("备注：")]),a("div",{staticClass:"base-grid-item-content"},[e._v(e._s(e.detail.remark||"--"))])])])],1)]),a("el-divider",{staticStyle:{margin:"17px 0"}}),a("div",{staticClass:"flow",staticStyle:{"padding-top":"12px"}},[a("div",{staticClass:"invoice-info-title"},[e._v("审批流程")]),a("tg-steps",{attrs:{direction:"vertical",steps:e.steps,active:e.activeNumber}})],1)],1):e._e()])},o=[],i=a(97434),s=a(56082),l=a(64479),r=a(64236),c=a(57325),u=a(17890),d=a(1763),m=a(49187),p=a(6933),_=a.n(p),v=a(4249),f=a(51351),g=a(17809),y=a(32622);const h=new m.ZP,x=e=>""===e||void 0===e?"--":`￥${h.format(e,m.WL.Yuan)}`,b=()=>{const e=e=>{(0,l.m)(e)};return{exportPdf:e}},w=(e,t)=>{const a=(0,i.computed)((()=>u.yR.get(t.value?.approval_status??u.Kb.Processing))),n=(0,i.computed)((()=>t.value?.level_two_types?s.IK.get(t.value?.level_two_types)??"--":"--")),o=()=>{if(!t.value?.contract_id)return;const{href:a}=e.root.$router.resolve({name:d.l6.contracts.customer.detail,params:{id:`${t.value?.contract_id??""}`},query:{partner_type:"2"}});window.open(a,"_blank")},l=(0,i.computed)((()=>x(t.value?.invoice_amount))),r=()=>{if(!t.value?.achievement_id)return;const a=t.value?.achievement_uid?.substring(0,2)??"",n="DY"===a||"TD"===a||"TB"===a||"YX"===a?d.B_.receive:d.Z8.achievement,{href:o}=e.root.$router.resolve({name:n,query:{source:"dialog",achievement:t.value?.achievement_uid}});window.open(o,"_blank")},c=(0,i.computed)((()=>(t.value?.is_received?"预计":"")+"收款时间：")),m=(0,i.computed)((()=>_()(t.value?.received_date).format("YYYY.MM.DD"))),p=(0,i.computed)((()=>1===t.value?.is_received?"是":"否")),v=(0,i.computed)((()=>1===t.value?.invoice_send_type?"快递寄送":"自行送达"));return{ApprovalStatusText:a,"发票类型":n,jumpContract:o,"开票金额":l,jumpAchievement:r,"收款时间标签":c,"收款时间":m,"款项是否收到":p,"发票寄送方式":v}},C=new Map;var k=(0,i.defineComponent)({name:"TgInvoiceDetail",components:{ApprovalFlow:v.Z},props:{},setup(e,t){const a=(0,i.ref)(!1),n=(0,i.ref)(!1),o=(0,i.ref)(void 0),s=()=>{a.value=!0},u=()=>{a.value=!1};t.root.$store.hasModule("workbench")||t.root.$store.registerModule("workbench",g.T);const d=async e=>{n.value=!0;const a=C.get(e);if(s(),void 0!==a)await(0,r._v)(500),o.value=a;else{const[{data:a}]=await Promise.all([await(0,l.Z)({approval_id:e}),await(0,r._v)(500)]);a.success?(o.value=a.data,C.set(e,a.data)):(t.root.$message.error(a.message??"获取审批单详情失败"),u())}const{data:i}=await(0,f.OC)({approval_id:e});i.success?t.root.$store.dispatch("workbench/setApproval",{...i.data}):t.root.$message.error(i.message??"获取审批详情失败"),n.value=!1},m=()=>{u(),o.value=void 0};return{visible:a,loading:n,open:d,close:m,detail:o,fixFileToken:c.W,...b(),...w(t,o),...(0,y.o)(t)}}}),S=k,D=a(1001),j=(0,D.Z)(S,n,o,!1,null,null,null),F=j.exports},88355:function(e,t,a){a.d(t,{e:function(){return o}});var n=a(76012);const o=async e=>(0,n.SO)("/api/resources/upload_certificate",e)},17352:function(e,t,a){a.d(t,{AX:function(){return h},BH:function(){return f},Nm:function(){return _},Nq:function(){return u},T:function(){return i},UM:function(){return s},Xc:function(){return b},eD:function(){return y},eV:function(){return r},gg:function(){return m},gi:function(){return d},iY:function(){return c},l5:function(){return g},nE:function(){return p},pF:function(){return l},t6:function(){return x},vJ:function(){return v}});var n=a(76012),o=a(64236);const i=async e=>(0,n.dX)("/api/coop/query_cooperation_achievement",{params:{...(0,o.jG)(e)}}),s=async e=>(0,n.dX)("/api/receivable/query_marketing_receivables",{params:{...(0,o.jG)(e)}}),l=async e=>(0,n.dX)("/api/receivable/query_shop_live_receivables",{params:{...(0,o.jG)(e)}}),r=async e=>(0,n.SO)("/api/coop/del_achievement",{...(0,o.jG)(e)}),c=async e=>(0,n.SO)("/api/coop/save_achievement",{...(0,o.jG)(e)}),u=async e=>(0,n.dX)("/api/receivable/query_shop_live_achievements_for_write_off",{params:{...(0,o.jG)(e)}}),d=async e=>(0,n.dX)("/api/receivable/query_shop_live_receivables_for_write_off",{params:{...(0,o.jG)(e)}}),m=async e=>(0,n.dX)("/api/receivable/query_marketing_achievements_for_write_off",{params:{...(0,o.jG)(e)}}),p=async e=>(0,n.dX)("/api/receivable/query_marketing_receivables_for_write_off",{params:{...(0,o.jG)(e)}}),_=async e=>(0,n.dX)("/api/receivable/search_achievement_for_write_off",{params:{...(0,o.jG)(e)}}),v=async e=>(0,n.dX)("/api/receivable/search_receivable_for_write_off",{params:{...(0,o.jG)(e)}}),f=async e=>(0,n.SO)("/api/receivable/shop_live/write_off",{...(0,o.jG)(e)}),g=async e=>(0,n.SO)("/api/receivable/marketing/write_off",{...(0,o.jG)(e)}),y=async e=>(0,n.dX)("/api/payable/query_payables_for_write_off/"+e.project_type,{params:{...(0,o.jG)(e)}}),h=async e=>(0,n.dX)("/api/payable/query_costs_for_write_off/"+e.project_type,{params:{...(0,o.jG)(e)}}),x=async e=>(0,n.dX)("/api/payable/search_payable_for_write_off",{params:{...(0,o.jG)(e)}}),b=async e=>(0,n.SO)("/api/payable/write_off/"+e.project_type,{...(0,o.jG)(e)})},64479:function(e,t,a){a.d(t,{Z:function(){return c},m:function(){return u}});var n=a(76012),o=a(25702),i=a(64236),s=a(74750);const l=(0,s.LP)(),r=!1,c=async e=>(0,n.dX)(o.MI,{params:e});function u(e){const t=`/api/approval/export_approval_info_pdf?approval_id=${e}&Authorization=${l}`,a=r?`${window.location.protocol}${window.location.host}${t}`:`https://data.goumee.com${t}`;(0,i.qz)(a)}},56082:function(e,t,a){a.d(t,{IK:function(){return n},LD:function(){return i},TZ:function(){return s},dU:function(){return l},zi:function(){return r}});const n=new Map([[1,"普通发票"],[2,"专用发票"],[3,"电子发票"],[4,"收据"]]);var o;(function(e){e[e["Marketing"]=1]="Marketing",e[e["shop_live_taobao"]=2]="shop_live_taobao",e[e["shop_live_douuyin"]=3]="shop_live_douuyin",e[e["area"]=4]="area",e[e["mcn"]=5]="mcn",e[e["yufeng_put"]=6]="yufeng_put",e[e["shop_live_douuyin_shanghai"]=7]="shop_live_douuyin_shanghai",e[e["other"]=8]="other"})(o||(o={}));const i=new Map([[1,"构美（浙江）信息科技有限公司"],[2,"杭州煜丰电子商务有限公司"],[3,"构美（浙江）信息科技有限公司上海分公司"]]),s=new Map([[1,"公章"],[2,"法人章"],[3,"财务专用章"],[4,"合同章"]]),l=new Map([[1,"个人类型"],[2,"公司类型"]]),r=new Map([[o.Marketing,"营销业务"],[o.shop_live_taobao,"淘宝店播"],[o.shop_live_douuyin,"抖音店播"],[o.area,"区域业务"],[o.mcn,"MCN业务"],[o.yufeng_put,"煜丰投放"],[o.shop_live_douuyin_shanghai,"抖音店播(上海)"],[o.other,"其他"]])},32622:function(e,t,a){a.d(t,{o:function(){return o}});var n=a(97434);const o=e=>{const t=(0,n.computed)((()=>e.root.$store.state.workbench)),a=(0,n.computed)((()=>t.value.approval)),o=(0,n.computed)((()=>{const e=a.value?.approval_flow_detail.map((e=>({...e}))).reverse()??[],t=e.map((e=>{const t=e.approval_result?1===e.approval_result?"（已同意）":"（已拒绝）":"";return{title:e.role_name,description:()=>(0,n.h)("div",[(0,n.h)("div",[`审批人：${e.operatorName}${t}`]),(0,n.h)("div",[e.operateDate])])}}));if(1===a.value?.approval_status){const a=e[e.length-1];t.push({title:a.receivedPersons,description:""})}else 4===a.value?.approval_status&&t.push({title:"申请人",description:()=>(0,n.h)("div",[(0,n.h)("div",[a.value?.username+"（已撤销）"]),(0,n.h)("div",[a.value?.gmt_modified])])});return t})),i=(0,n.computed)((()=>void 0===a.value?0:1===a.value?.approval_status?o.value.length-1:o.value.length));return{steps:o,activeNumber:i}}},88721:function(e,t,a){var n=a(41572);a(97434);const o={IntergerAndDecimals(e){const t=/(\d+)$|\d+\.?\d{0,2}/.exec(e);return t?t[0]:""},Interger(e){return e.replace(/[^\d]/g,"")},NumberRange(e,t){return a=>{const n=this.IntergerAndDecimals(a);if(""===n)return n;const o=Number(n);return o<e?e+"":o>t?t+"":n}},Thousands(e){if(null===e||void 0===e||""===e)return e;e+="";const t=/^(\d+)(\.\d+$)?$/.exec(e+"");if(!t)return e;const a=t[1],n=t[2];let o=a.replace(/(\d{1,3})(?=(\d{3})+$)/g,(e=>`${e},`));return void 0!==n&&(o=`${o}${n}`),o},NineIntergerAndDecimals(e){const t=(/(?:0|[1-9]\d{0,8})(?:\.\d{0,2})?/u.exec(e.replace(/[^.\d]+/gu,"").replace(n.Pj,""))??[""])[0];return t}};t["Z"]=o},42993:function(e,t,a){a.d(t,{i4:function(){return n},ZP:function(){return u},vu:function(){return r}});var n,o=a(97434),i=a(6933),s=a.n(i);(function(e){e[e["Week"]=0]="Week",e[e["Month"]=1]="Month",e[e["Year"]=2]="Year"})(n||(n={}));const l=[7,1,2,3,4,5,6],r=(e=n.Week,t={},a=!1,i="32px",r=!1)=>{const c=(0,o.ref)(s()()),u=(0,o.ref)(e),d=(0,o.ref)(c.value.clone()),m=(0,o.ref)(c.value.clone()),p=t.integerMonth,_=(0,o.computed)((()=>[d.value,m.value])),v=()=>{if(u.value===n.Month)if(!0===p){const e=c.value.clone().startOf("month"),t=c.value.clone().endOf("month");d.value=e,m.value=t}else{const e=c.value.clone().startOf("month"),t=c.value.clone().endOf("month"),a=l[e.day()],n=l[t.day()];1!==a&&e.add(1-a,"days"),7!==n&&t.add(7-n,"days"),d.value=e,m.value=t}else if(u.value===n.Week){let e=c.value.clone().startOf("week"),t=c.value.clone().endOf("week");a&&(e=c.value.clone().subtract(7,"d").startOf("day"),t=c.value.clone().subtract(1,"d").startOf("day")),d.value=e,m.value=t}},f=e=>{u.value=e,v()},g=(e=1)=>{u.value===n.Month?c.value.add(e,"months"):c.value.add(e,"weeks"),v()};return v(),(0,o.reactive)({add:g,currentDate:c,startTime:d,endTime:m,changeCalendarType:f,range:_,type:u,itemHeight:i,showRest:r})},c=["日","一","二","三","四","五","六"];var u=(0,o.defineComponent)({name:"CalendarCustom",props:{config:{type:Object,default:()=>({itemHeight:"32px"})},fields:{type:Array,default:()=>[]},columsLabel:{type:String},restDates:{type:Array},selectedAbled:{type:Boolean,default:!1},selectedMonth:{type:Number,default:void 0}},setup(e,t){const a=s()(),n=a=>{e.selectedAbled&&t.emit("columnClick",a)};return{onCellClick:n,today:a}},methods:{renderCalendarTd(e,t){const a=this.$scopedSlots;return a?.render(e,t)},renderCalendarYearTd(e,t){const a=this.$scopedSlots;return a?.render(e,t)},renderCalendarTotal(e){const t=this.$scopedSlots;return t?.rednerTotal(e)}},render(){const e=arguments[0],{range:t,currentDate:a,type:i,showRest:s}=this.config,l=(0,o.computed)((()=>this.restDates??[])),r=[];let u=[];if(2===i)u=[1,2,3,4,5,6,7,8,9,10,11,12];else{if(t.length<2)return e("div");const a=t[0].clone(),n=t[1].clone();while(a.isSameOrBefore(n))r.push(a.clone()),a.add(1,"days")}const d=a.month(),m={gridTemplateRows:2===this.config.type?`32px repeat(${this.fields.length}, 32px)`:`36px repeat(${this.fields.length}, 32px)`,padding:2===this.config.type?"0 149px 0 99px":"0 150px 0 134px"},p={gridTemplateRows:2===this.config.type?"32px repeat(auto-fit, 32px)":"36px repeat(auto-fit, 32px)",width:2===this.config.type?"100px":"135px",color:"#19232D"};return e("div",{class:"tg-calendar-custom-side"},[e("div",{class:"calendar-header calendar-header-left",style:p},[2===this.config.type?e("div",{class:"tg-calendar-custom-th",style:"width:100px;height:32px;line-height:32px;text-align:center;font-weight: 600;font-size:12px;background:#F6F6F6;border-right:1px solid #EAEEF0"},["月份"]):e("div",{class:"tg-calendar-custom-th calendar-header-side calendar-header-angle",style:"color:#19232D;height:36px;line-height:36px;background:#F6F6F6;border-right:1px solid #EAEEF0"},[e("span",{class:"calendar-header-angle-columns"},[this.columsLabel]),e("span",{class:"calendar-header-angle-row"},["日期"])]),this.fields.map(((t,a)=>e("div",{class:"tg-calendar-custom-td calendar-header-side",style:2===this.config.type?"width:100px;padding-left:0px;min-width: 100px;":"width:134px;padding-left:18px",key:a},[e("div",{class:"tg-calendar-custom-day",style:2===this.config.type?"width:100%;text-align: center;font-weight: 600;":""},[t.label])])))]),e("div",{class:"calendar-body",style:m},[(n.Week===i||n.Month===i)&&r.map(((t,a)=>{const o="tg-calendar-custom-td "+(n.Month===i&&t.month()!==d?"other-month":"");return e("fragments",{key:`range${a}`},[e("div",{class:"tg-calendar-custom-th calendar-header-top",style:"background:#F6F6F6"},[e("span",{class:"day"},[t.date()]),n.Week===i&&e("span",{class:"week"},["周",c[t.day()]])]),this.fields.map(((n,i)=>{let r;return s&&(r=l.value.find((e=>t.format("MM-DD")===e))),r?0===i?e("div",{style:`grid-row: 2/${this.fields.length+2};`,class:`${o} rest`,key:`${a}field${i}`},[e("div",["休"])]):void 0:e("div",{class:o,key:`${a}field${i}`},[this.renderCalendarTd(t,n)])}))])})),n.Year===i&&u.map(((t,a)=>{const n="tg-calendar-custom-td";let o="min-width:115px; background: #F6F6F6;",i="min-width:115px;";return this.selectedAbled?this.selectedMonth+1===t?(o="min-width:115px; background: #E3F7FF; cursor: pointer;",i="min-width:115px; background: #E3F7FF; cursor: pointer;"):(o="min-width:115px; background: #F6F6F6; cursor: pointer;",i="min-width:115px; cursor: pointer;"):(o="min-width:115px; background: #F6F6F6;",i="min-width:115px;"),e("fragments",{key:`range${a}`},[e("div",{class:"tg-calendar-custom-th calendar-header-top",style:o,on:{click:()=>this.onCellClick(t-1)}},[e("span",{style:"font-size: 12px; color: #19232D;font-weight:600;background: transparent;"},[t,"月"])]),this.fields.map(((o,s)=>e("div",{class:n,style:i,key:`${a}field${s}`,on:{click:()=>this.onCellClick(t-1)}},[this.renderCalendarYearTd(t,o)])))])}))]),e("div",{class:"calendar-header calendar-header-right",style:2===this.config.type?"width:151px;  box-shadow: -1px 0 5px 0 rgba(0, 0, 0, 0.1);grid-template-rows: 32px repeat(auto-fit, 32px);":"grid-template-rows: 36px repeat(auto-fit, 32px)"},[e("div",{class:"tg-calendar-custom-th calendar-header-side ",style:2===this.config.type?"padding-right: 0px; text-align: center;display: inline-block;line-height: 32px;height: 32px;padding-left: 0px;  width: 150px;font-size:12px;background:#F6F6F6;width: 100%;text-align: center; justify-content: center;":"line-height: 36px;height: 36px;padding-right: 24px;font-size:12px;background:#F6F6F6;width: 100%;text-align: center; justify-content: center;"},["合计"]),this.fields.map(((t,a)=>e("div",{class:"tg-calendar-custom-td calendar-header-side",style:2===this.config.type?"padding-right: 15px":"padding-right: 24px",key:a},[this.renderCalendarTotal(t)])))])])}})},4249:function(e,t,a){a(26699);var n=a(97434);t["Z"]=(0,n.defineComponent)({name:"ApprovalFlow",setup(e,t){const a=(0,n.computed)((()=>t.root.$store.state.workbench)),o=(0,n.computed)((()=>a.value.approval)),i=(0,n.computed)((()=>(o.value?.approval_flow_detail??[]).length>=0&&0===o.value?.approval_stream.length)),s=(0,n.computed)((()=>{if(void 0===o.value)return 0;const e=[2,3].includes(o.value.approval_status??-1);return i.value?o.value.approval_flow_detail.length:o.value.steps+(e?1:0)})),l=(0,n.computed)((()=>void 0===o.value?[]:o.value.approval_flow_detail.length>0?o.value.approval_flow_detail.map((e=>({...e,username:e.receivedPersons}))):o.value.approval_stream));return{approval:o,step_status:s,flowDetail:l,isFromOA:i}},render(){const e=arguments[0],t=this.approval,a=this.isFromOA,n=this.step_status,o=this.flowDetail;if(void 0===t)return e("div");const i=e("el-steps",{class:"steps-line",props:{active:n,direction:"vertical"}},[...o.map(((n,o)=>{const i=804===n.role_code?[e("span",{class:"size-medium",slot:"title"},[n.role_name+"（用款金额大于10万元）"])]:802===n.role_code?[e("span",{class:"size-medium",slot:"title"},[n.role_name+"（用款金额大于50万元）"])]:[e("span",{class:"size-medium",slot:"title"},[n.role_name])],s=2===t.approval_status?"last-color":"",l=1===n.approval_result?"color-3":2===n.approval_result?"refuse":"",r=["flow-select",l,s];return e("el-step",{key:o,class:"step-children"},[e("tg-icon",{attrs:{name:"ico-step-finish"},slot:"icon"}),i,e("div",{slot:"description"},[e("span",{class:r},["审批人："]),n.approval_result?e("span",[1===n.approval_result?e("span",{class:[l,s]},[a?n.operatorName:n.username,"（已同意）"]):"",2===n.approval_result?e("span",{class:["flow-select","refuse"]},[a?n.operatorName:n.username,"（已拒绝）"]):""]):e("span",{class:"flow-select"},[a?n.operatorName:n.username]),""!==n.remark||""!==n.oa_review_result?e("p",{class:"refuse"},[n.remark?"理由:"+(n.oa_review_result||n.remark):""]):"",n.approval_date?e("p",{class:["flow-select",2===n.approval_result?"refuse":"",s]},[a?`${n.operateDate} ${n.operateTime}`:`${n.approval_date}`]):""])])})),...a&&![2,3,4].includes(t.approval_status)?[e("el-step",{style:"height: 82px !important",class:"step-children"},[e("tg-icon",{attrs:{name:"ico-waiting"},slot:"icon"}),e("span",{class:"size-medium",slot:"title"},[o[o.length-1].receivedPersons])])]:[]]);return e("div",{class:"steps-exted",attrs:{id:"steps-exted"}},[a?"":e("el-steps",{attrs:{direction:"vertical",active:1},class:"step-username"},[e("el-step",{style:"height: 82px"},[e("div",{style:"font-size: 14px",slot:"title"},["申请人"]),e("div",{slot:"description"},[e("span",{class:"color-3"},[t.username]),e("p",{class:"flow-select"},[t.gmt_create_datetime])])])]),i,4===t.approval_status?e("el-steps",{attrs:{direction:"vertical",active:1},class:"step-username revocation"},[e("el-step",{style:"height: 82px"},[e("div",{style:"font-size: 14px",slot:"title"},["申请人"]),e("div",{slot:"description"},[e("span",{class:"flow-select revocation-color"},[t.username,"（已撤销）"]),e("p",{class:"flow-select revocation-color"},[t.gmt_modified])])])]):""])}})}}]);